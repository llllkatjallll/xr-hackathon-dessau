var fP=Object.defineProperty;var pP=(s,t,e)=>t in s?fP(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e;var a=(s,t,e)=>(pP(s,typeof t!="symbol"?t+"":t,e),e),Nm=(s,t,e)=>{if(!t.has(s))throw TypeError("Cannot "+e)};var _e=(s,t,e)=>(Nm(s,t,"read from private field"),e?e.call(s):t.get(s)),Yi=(s,t,e)=>{if(t.has(s))throw TypeError("Cannot add the same private member more than once");t instanceof WeakSet?t.add(s):t.set(s,e)},Un=(s,t,e,i)=>(Nm(s,t,"write to private field"),i?i.call(s,e):t.set(s,e),e);var aa=(s,t,e)=>(Nm(s,t,"access private method"),e);import{l as ce,V as x,u as xe,aQ as H,bo as Ys,P as Re,e as In,i as os,U as Er,M as Z,bF as Qa,T as Je,d as En,c as Vi,v as ue,bi as di,d2 as ow,d3 as rw,d4 as w_,h as De,bx as aw,b as le,cP as Nr,ay as F,bA as $r,aK as To,d5 as ln,ad as Ue,r as hn,B as ko,aJ as Mr,ac as wp,bk as gd,d6 as mP,d7 as gP,d8 as yP,be as _P,d9 as lw,au as sy,at as cw,aG as yd,a2 as $i,bj as bP,da as vP,aF as hw,aC as dw,bg as Sp,S as Cp,db as xP,bB as $a,aE as Eo,aW as uw,aL as wP,aN as SP,bG as CP,dc as PP,dd as RP,aM as Ar,a as ec,aD as mc,p as Wa,an as Ei,ak as OP,a0 as fw,x as S_,z as Pp,bu as Mo,k as rs,C as TP,de as gc,df as kP,dg as EP,W as No,D as MP,A as gf,dh as AP,di as oy,cT as C_,b1 as IP,F as Wr,dj as s0,aa as P_,dk as DP,dl as LP,dm as ry,E as R_,q as O_,Q as jP,cW as BP,dn as FP,bv as zP,dp as UP,dq as NP,dr as $P,ds as WP,dt as VP,du as HP,dv as GP,dw as qP,dx as XP,dy as QP,dz as YP,dA as KP,dB as JP,dC as ZP,dD as eR,dE as tR,dF as o0,dG as pw,dH as iR,a6 as nR,a4 as sR,a3 as oR,a5 as rR,G as aR,Y as lR,X as cR,dI as r0,av as ay,dJ as mw,j as hR,L as a0,dK as dR,bK as uR,cQ as gw,dL as fR,as as pR,dM as mR,dN as gR,dO as yR,cR as _R,d1 as bR,dP as _d,cU as Rp,dQ as T_,dR as k_,dS as Op,I as vR,dT as xR,dU as wR,a$ as SR,dV as CR,aX as PR,aZ as RR,dW as OR,aU as l0,aj as yw,ag as yf,a1 as TR,dX as kR,dY as ER}from"./three@0.169.5.js";import{_ as Be,a as _w,b as bw,c as MR,S as AR,d as $m,e as c0,T as h0}from"./three-mesh-ui.33bae730.js";import{c as yc,F as IR,T as DR,d as LR,G as Va,e as vw,E as _f,R as ly,S as jR,n as BR,O as xw,f as FR,H as zR,V as UR,g as ww,s as Sw,z as NR,X as $R,h as WR,L as VR,i as HR,j as GR,K as qR,k as XR,I as QR,l as YR,m as KR,o as E_,p as Cw,q as JR}from"./three-examples.d909655c.js";import{_ as ts}from"./index-588cbad4.js";import{c as M_,g as Pw,L as _l,N as mt,s as ZR,a as eO,b as tO,d as iO}from"./gltf-progressive.ff3ffb65.js";import{M as Wm,B as nO,P as sO,R as co,T as d0,C as oO,V as rO,a as aO}from"./three-quarks.ed2a961a.js";let Rw,u0=null;function qs(){return Rw}function Ow(s){if(s==null){console.warn("Oh no: someone tried registering a non-existend gltf-loader. When you see this log it might mean that needle-engine is being imported multiple times. Please check your project setup.");return}u0!==s&&(u0=s,Rw=new s)}const Vm=new Map;function qi(s=(t=>(t=globalThis.location)==null?void 0:t.hostname)()){if(Vm.has(s))return Vm.get(s);const e=/(\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3})|localhost/.test(s);return Vm.set(s,e),e===!0}function lO(){return window.location.hostname.includes("glitch.me")}const f0=typeof window!==void 0?window.location.search.includes("debugcontext"):!1;var me;(function(s){s.ContextRegistered="ContextRegistered",s.ContextCreationStart="ContextCreationStart",s.ContextCreated="ContextCreated",s.ContextFirstFrameRendered="ContextFirstFrameRendered",s.ContextDestroying="ContextDestroying",s.ContextDestroyed="ContextDestroyed",s.MissingCamera="MissingCamera",s.ContextClearing="ContextClearing",s.ContextCleared="ContextCleared"})(me||(me={}));class be{static get Current(){return globalThis["NeedleEngine.Context.Current"]}static set Current(t){globalThis["NeedleEngine.Context.Current"]=t}static get All(){return this.Registered}static register(t){this.Registered.indexOf(t)===-1&&(f0&&console.warn("Registering context"),this.Registered.push(t),this.dispatchCallback(me.ContextRegistered,t))}static unregister(t){const e=this.Registered.indexOf(t);e!==-1&&(f0&&console.warn("Unregistering context"),this.Registered.splice(e,1))}static registerCallback(t,e){this._callbacks[t]||(this._callbacks[t]=[]),this._callbacks[t].push(e)}static unregisterCallback(t,e){if(!this._callbacks[t])return;const i=this._callbacks[t].indexOf(e);i!==-1&&this._callbacks[t].splice(i,1)}static dispatchCallback(t,e,i){if(!this._callbacks[t])return!0;const n={event:t,context:e};if(i)for(const r in i)n[r]=i[r];const o=new Array;return this._callbacks[t].forEach(r=>{const l=r(n);l instanceof Promise&&o.push(l)}),Promise.all(o)}static addContextCreatedCallback(t){this.registerCallback(me.ContextCreated,t)}static addContextDestroyedCallback(t){this.registerCallback(me.ContextDestroyed,t)}}a(be,"Registered",[]),a(be,"_callbacks",{});const cO=()=>s=>s;function jD(s){return cO()(s)}function BD(){return!!C("debug")}class Dn{constructor(t,e){a(this,"_factory");a(this,"_cache",[]);a(this,"_maxSize");a(this,"_index",0);this._factory=t,this._maxSize=e}get(){const t=this._index%this._maxSize;return this._index++,this._cache.length<=t&&(this._cache[t]=this._factory()),this._cache[t]}}let ga=!1;const cy=new Array;typeof window<"u"&&setTimeout(()=>{if(ga){const s={},t=new URL(window.location.href),e=new URL(t);e.searchParams.append("console","");const i=e.toString().replace(/=$|=(?=&)/g,"");for(const o of cy){const r=new URL(t);r.searchParams.append(o,""),s[o]=r.toString().replace(/=$|=(?=&)/g,"")}console.log(`üåµ ?help: Debug Options for Needle Engine.
Append any of these parameters to the URL to enable specific debug options.
Example: ${i} will show an onscreen console window.`);const n=ga===!0?"":` (containing "${ga}")`;console.group("Available URL parameters:"+n);for(const o of Object.keys(s).sort())typeof ga=="string"&&!o.toLowerCase().includes(ga.toLowerCase())||(console.groupCollapsed(o),console.log("Reload with this flag enabled:"),console.log(s[o]),console.groupEnd());console.groupEnd()}},100);function Tp(){var s;return new URLSearchParams((s=globalThis.location)==null?void 0:s.search)}function C(s){ga&&!cy.includes(s)&&cy.push(s);const t=Tp();if(t.has(s)){const e=t.get(s);if(e){const i=Number(e);return isNaN(i)?e:i}else return!0}return!1}ga=C("help");function FD(s,t){const e=Tp();e.has(s)?e.set(s,t):e.append(s,t),document.location.search=e.toString()}function bf(s,t,e=!0){const i=Tp();i.has(s)?t===null?i.delete(s):i.set(s,t):t!==null&&i.append(s,t),e?hO(s,i):Tw(s,i)}function p0(s,t,e){s.has(t)?s.set(t,e.toString()):s.append(t,e.toString())}function hO(s,t,e){window.history.pushState(e,s,"?"+t.toString())}function Tw(s,t,e){window.history.replaceState(e,s,"?"+t.toString())}function zD(s){for(var t="",e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",i=e.length,n=0;n<s;n++)t+=e.charAt(Math.floor(Math.random()*i));return t}function UD(s,t){return Math.floor(Math.random()*(t-s+1))+s}const m0=["smol","tiny","giant","interesting","smart","bright","dull","extreme","beautiful","pretty","dark","epic","salty","silly","funny","lame","lazy","loud","lucky","mad","mean","mighty","mysterious","nasty","odd","old","powerful","quiet","rapid","scary","shiny","shy","silly","smooth","sour","spicy","stupid","sweet","tasty","terrible","ugly","unusual","vast","wet","wild","witty","wrong","zany","zealous","zippy","zombie","zorro"],g0=["cat","dog","mouse","pig","cow","horse","sheep","chicken","duck","goat","panda","tiger","lion","elephant","monkey","bird","fish","snake","frog","turtle","hamster","penguin","kangaroo","whale","dolphin","crocodile","snail","ant","bee","beetle","butterfly","dragon","eagle","fish","giraffe","lizard","panda","penguin","rabbit","snake","spider","tiger","zebra"];function dO(){const s=m0[Math.floor(Math.random()*m0.length)],t=g0[Math.floor(Math.random()*g0.length)];return s+"_"+t}function uO(s){return s=s.replace(/[^a-z0-9√°√©√≠√≥√∫√±√º \.,_-]/gim,""),s.trim()}function bd(s,t,e=!0,i=!1){var n;if(t==null)return null;if(t.userData&&t.userData.guid===s)return t;if(t.guid==s)return t;if(i&&(n=t.userData)!=null&&n.components){for(const o of t.userData.components)if(o.guid===s)return o}if(e){if(t.scenes)for(const o in t.scenes){const r=t.scenes[o],l=bd(s,r,e,i);if(l)return l}if(t.children)for(const o in t.children){const r=t.children[o],l=bd(s,r,e,i);if(l)return l}}}function kp(s,t){if(s!=null&&typeof s=="object"){let e;Array.isArray(s)?e=[]:(e=Object.create(s),Object.assign(e,s));for(const i of Object.keys(s)){const n=s[i];t&&!t(s,i,n)?e[i]=n:(n==null?void 0:n.clone)!==void 0&&typeof n.clone=="function"?e[i]=n.clone():e[i]=kp(n,t)}return e}return s}function Xs(s){return new Promise((t,e)=>{setTimeout(t,s)})}function Ep(s,t){if(s<=0)return Promise.resolve();if(t||(t=be.Current),!t)return Promise.reject("No context");const e=t.time.frameCount+s;return new Promise((i,n)=>{if(!t)return n("No context");const o=()=>{t.time.frameCount>=e&&(t.pre_update_callbacks.splice(t.pre_update_callbacks.indexOf(o),1),i())};t.pre_update_callbacks.push(o)})}const cu=C("debugresolveurl"),fO="rel:";function ND(s,t){return Ya(s,t)}function Ya(s,t){if(t===void 0)return cu&&console.warn("getPath: uri is undefined, returning uri",t),t;if(t.startsWith("./"))return t;if(t.startsWith("http"))return cu&&console.warn("getPath: uri is absolute, returning uri",t),t;if(s===void 0)return cu&&console.warn("getPath: source is undefined, returning uri",t),t;t.startsWith(fO)&&(t=t.substring(4));const e=s.lastIndexOf("/");if(e>=0){const i=s.substring(0,e+1);for(;i.endsWith("/")&&t.startsWith("/");)t=t.substring(1);const n=i+t;return cu&&console.log("source:",s,`changed uri 
from`,t,`
to `,n,`
basePath: `+i),n}return t}class pO{constructor(t,e){a(this,"writeCallbacks",[]);a(this,"_applied",!1);a(this,"_object");a(this,"_prop");a(this,"_wrapperProp");this._object=t,this._prop=e,this._wrapperProp=Symbol("$"+e),this.apply()}subscribeWrite(t){this.writeCallbacks.push(t)}unsubscribeWrite(t){const e=this.writeCallbacks.indexOf(t);e!==-1&&this.writeCallbacks.splice(e,1)}apply(){if(this._applied||!this._object)return;const t=this._object,e=this._prop;if(t[e]===void 0)return;this._applied=!0,t[this._wrapperProp]!==void 0&&console.warn("Watcher is being applied to an object that already has a wrapper property. This is not (yet) supported");const i=t[e];t[this._wrapperProp]=i,Object.defineProperty(t,e,{get:()=>t[this._wrapperProp],set:r=>{t[this._wrapperProp]=r;for(const l of this.writeCallbacks)l(r,this._prop)}})}revoke(){if(!this._applied||!this._object)return;this._applied=!1;const t=this._object,e=this._prop;Reflect.deleteProperty(t,e);const i=t[this._wrapperProp];t[e]=i,Reflect.deleteProperty(t,this._wrapperProp)}dispose(){this.revoke(),this.writeCallbacks.length=0,this._object=null}}class Ir{constructor(t,e){a(this,"_watches",[]);if(Array.isArray(e))for(const i of e)this._watches.push(new Ir(t,i));else this._watches.push(new pO(t,e))}subscribeWrite(t){for(const e of this._watches)e.subscribeWrite(t)}unsubscribeWrite(t){for(const e of this._watches)e.unsubscribeWrite(t)}apply(){for(const t of this._watches)t.apply()}revoke(){for(const t of this._watches)t.revoke()}dispose(){for(const t of this._watches)t.dispose();this._watches.length=0}}const Tl=Symbol("needle:watches");function A_(s,t){if(!s[Tl])if(s instanceof ce)s[Tl]=new Ir(s,["x","y"]);else if(s instanceof x)s[Tl]=new Ir(s,["x","y","z"]);else if(s instanceof xe||s instanceof H)s[Tl]=new Ir(s,["x","y","z","w"]);else return!1;return s[Tl].subscribeWrite(t),!0}function kw(s,t){if(!s)return;const e=s[Tl];e&&e.unsubscribeWrite(t)}var J;(function(s){let t;function e(){if(t!==void 0)return t;const D=window.navigator.userAgent,N=/Windows|MacOS|Mac OS/.test(D),q=/Windows NT/.test(D)&&/Edg/.test(D)&&!/Win64/.test(D);return t=N&&!q&&!v()}s.isDesktop=e;let i;function n(){return i!==void 0?i:typeof window.orientation<"u"||navigator.userAgent.indexOf("IEMobile")!==-1?i=!0:i=/iPhone|iPad|iPod|Android|IEMobile/i.test(navigator.userAgent)}s.isMobileDevice=n;function o(){return l()}s.isIPad=o;let r;function l(){return r!==void 0?r:r=/iPad/.test(navigator.userAgent)}s.isiPad=l;let c;function h(){return c!==void 0?c:c=/Android/.test(navigator.userAgent)}s.isAndroidDevice=h;let d;function u(){return d!==void 0?d:d=/WebXRViewer\//i.test(navigator.userAgent)}s.isMozillaXR=u;let f;function p(){if(f!==void 0)return f;if(navigator.userAgentData)return f=navigator.userAgentData.platform==="macOS";{const D=navigator.userAgent.toLowerCase();return f=D.includes("mac os x")||D.includes("macintosh")}}s.isMacOS=p;let g;function y(){return g!==void 0?g:g=p()&&"xr"in navigator}s.isVisionOS=y;let b;const _=["iPad Simulator","iPhone Simulator","iPod Simulator","iPad","iPhone","iPod"];function v(){return b!==void 0?b:b=_.includes(navigator.platform)||navigator.userAgent.includes("Mac")&&"ontouchend"in document}s.isiOS=v;let S;function T(){return S!==void 0||(S=/^((?!chrome|android).)*safari/i.test(navigator.userAgent)),S}s.isSafari=T;let O;function M(){return O!==void 0?O:O=navigator.userAgent.includes("OculusBrowser")}s.isQuest=M;let k;function B(){return k!==void 0||(k=document.createElement("a").relList.supports("ar")),k}s.supportsQuickLookAR=B;async function I(){try{return(await navigator.permissions.query({name:"microphone"})).state!=="denied"}catch(D){return console.error("Error querying `microphone` permissions.",D),!1}}s.microphonePermissionsGranted=I;let E;function L(){if(E!==void 0)return E;const D=navigator.userAgent.match(/iPhone OS (\d+_\d+)/);if(D&&(E=D[1].replace("_",".")),!E){const N=navigator.userAgent.match(/(?:\(Macintosh;|iPhone;|iPad;).*Version\/(\d+\.\d+)/);N&&(E=N[1])}return E||(E=null),E}s.getiOSVersion=L;let V;function A(){if(V!==void 0)return V;const D=navigator.userAgent.match(/(?:CriOS|Chrome)\/(\d+\.\d+\.\d+\.\d+)/);return D?V=D[1].replace("_","."):V=null,V}s.getChromeVersion=A})(J||(J={}));function $D(){return J.isDesktop()}function WD(){return J.isMobileDevice()}function VD(){return J.isiPad()}function HD(){return J.isiPad()}function GD(){return J.isAndroidDevice()}function qD(){return J.isMozillaXR()}function XD(){return J.isMacOS()}function QD(){return J.isiOS()}function YD(){return J.isSafari()}function KD(){return J.isQuest()}async function JD(){return J.microphonePermissionsGranted()}const mO=/ip=(?<ip>.+?)\n/s;async function ZD(){const t=await(await fetch("https://www.cloudflare.com/cdn-cgi/trace")).text(),e=mO.exec(t);return e?e[1]:null}async function eL(){const s=await fetch("https://api.db-ip.com/v2/free/self").catch(()=>null);return s?(await s.json()).ipAddress:void 0}async function tL(){const s=await fetch("https://api.db-ip.com/v2/free/self").catch(()=>null);return s?await s.json():void 0}const wr=new WeakMap;function gO(s,t,e){if(!wr.get(s)){const n=new MutationObserver(o=>{_O(s,o)});wr.set(s,{observer:n,attributeChangedListeners:new Map}),n.observe(s,{attributes:!0})}const i=wr.get(s).attributeChangedListeners;i.has(t)||i.set(t,[]),i.get(t).push(e)}function yO(s,t,e){if(!wr.get(s))return;const i=wr.get(s).attributeChangedListeners;if(!i.has(t))return;const n=i.get(t),o=n.indexOf(e);if(o!==-1&&(n.splice(o,1),n.length<=0)){i.delete(t);const r=wr.get(s);r==null||r.observer.disconnect(),wr.delete(s)}}function _O(s,t){const e=wr.get(s).attributeChangedListeners;for(const i of t)if(i.type==="attributes"){const n=i.attributeName,o=s.getAttribute(n);if(e.has(n))for(const r of e.get(n))r(o)}}class y0{constructor(t){a(this,"reason");this.reason=t}}async function Ew(s){const t=await Promise.allSettled(s).catch(n=>[new y0(n.message)]);let e=!1;const i=t.map(n=>"value"in n?n.value:(e=!0,new y0(n.reason)));return{anyFailed:e,results:i}}async function bO(s){if(!globalThis.QRCode){const i="https://cdn.rawgit.com/davidshimjs/qrcodejs/gh-pages/qrcode.min.js";let n=document.head.querySelector(`script[src="${i}"]`);n||(n=document.createElement("script"),n.src=i,document.head.appendChild(n)),await new Promise((o,r)=>{n.addEventListener("load",()=>{o(!0)})})}const t=globalThis.QRCode,e=s.domElement??document.createElement("div");return new t(e,{width:s.width??256,height:s.height??256,colorDark:"#000000",colorLight:"#ffffff",correctLevel:t.CorrectLevel.M,...s}),e}const Mw=C("debugdebug");let vd=!1;(C("noerrors")||C("nooverlaymessages"))&&(vd=!0);const Hm="needle_engine_global_error_container";var _t;(function(s){s[s.Log=0]="Log",s[s.Warn=1]="Warn",s[s.Error=2]="Error"})(_t||(_t={}));function I_(){return Dw}const hy=new Array;function vO(s){hy.push(s)}let Gm=!1;function xO(...s){if(!Gm){Gm=!0;try{for(let t=0;t<hy.length;t++)hy[t](...s)}catch(t){console.error(t)}Gm=!1}}const Aw=console.error,Iw=function(...s){Aw.apply(console,s),CO(s),js(_t.Error,s),dy(...s)};function wO(s){vd=!s,s?console.error=Iw:console.error=Aw}function iL(s){return wO(s)}function SO(){vd||(Mw&&console.warn("Patch console",window.location.hostname),console.error=Iw,window.addEventListener("error",s=>{if(!s)return;const t=s.error;if(t===void 0){qi()&&console.warn("Received unknown error",s,s.target);return}js(_t.Error,t,s.filename,s.lineno),dy(s)},!0),window.addEventListener("unhandledrejection",s=>{vd||s&&(s.reason?js(_t.Error,s.reason.message,s.reason.stack):js(_t.Error,"unhandled rejection"),dy(s))}))}let Dw=0;function dy(...s){Dw+=1,xO(...s)}function CO(s){if(Array.isArray(s))for(let t=0;t<s.length;t++){const e=s[t];typeof e=="string"&&e.startsWith("THREE.PropertyBinding: Trying to update node for track:")&&(s[t]="Some animated objects couldn't be found: see console for details")}}function js(s,t,e,i){if(vd)return;const n=be.Current,o=(n==null?void 0:n.domElement)??document.querySelector("needle-engine");if(o){if(Array.isArray(t)){let r="";for(let l=0;l<t.length;l++){let c=t[l];c instanceof Error&&(c=c.message),typeof c!="object"&&(l>0&&(r+=" "),r+=c)}t=r}!t||t.length<=0||PO(s,o,t)}}const Ih=new Map;function PO(s,t,e){if(e==null)return;const i=OO(t);if(i.childElementCount>=20){const l=i.lastElementChild;_0(l)}e.length>400&&(e=e.substring(0,400)+"...");const n=e;if(Ih.has(n))return;const o=TO(s,e);i.prepend(o);const r=()=>{Ih.delete(n),_0(o)};Ih.set(n,r),setTimeout(r,1e4)}function nL(){Mw&&console.log("Clearing messages");for(const s of Ih.values())s==null||s.call(s);Ih.clear()}const RO=`

@import url('https://fonts.googleapis.com/css2?family=Roboto+Flex:opsz,wght@8..144,100..1000&display=swap');

div[data-needle_engine_debug_overlay] {
    font-family: 'Roboto Flex', sans-serif;
    font-weight: 400;
    font-size: 16px;
}

div[data-needle_engine_debug_overlay] strong {
    font-weight: 700;
}

div[data-needle_engine_debug_overlay] a {
    color: white;
    text-decoration: none;
    border-bottom: 1px solid rgba(255, 255, 255, 0.3);
}

div[data-needle_engine_debug_overlay] a:hover {
    text-decoration: none;
    border: none;
}

div[data-needle_engine_debug_overlay] .log strong {
    color: rgba(200,200,200,.9);
}

div[data-needle_engine_debug_overlay] .warn strong {
    color: rgba(255,255,230, 1);
}

div[data-needle_engine_debug_overlay] .error strong {
    color: rgba(255,100,120, 1);
}
`;function OO(s){globalThis[Hm]||(globalThis[Hm]=new Map);const t=globalThis[Hm];if(t.has(s))return t.get(s);{const e=document.createElement("div");t.set(s,e),e.setAttribute("data-needle_engine_debug_overlay",""),e.classList.add("debug-container"),e.style.cssText=`
            position: absolute;
            top: 0;
            right: 5px;
            padding-top: 0px;
            max-width: 70%;
            max-height: calc(100% - 5px);
            z-index: 9999999999;
            pointer-events: scroll;
            display: flex;
            align-items: end;
            flex-direction: column;
            color: white;
            overflow: auto;
            word-break: break-word;
        `,s.shadowRoot?s.shadowRoot.appendChild(e):s.appendChild(e);const i=document.createElement("style");return i.innerHTML=RO,e.appendChild(i),e}}const Lw=Symbol("logtype"),vf=new Map;function _0(s){s.remove();const t=s[Lw],e=vf.get(t)??[];e.push(s),vf.set(t,e)}function TO(s,t){if(vf.has(s)){const i=vf.get(s);if(i.length>0){const n=i.pop();return n.innerHTML=t,n}}const e=document.createElement("div");switch(e.setAttribute("data-id","__needle_engine_debug_overlay"),e.style.marginRight="5px",e.style.padding=".5em",e.style.backgroundColor="rgba(0,0,0,.9)",e.style.marginTop="5px",e.style.marginBottom="3px",e.style.borderRadius="8px",e.style.pointerEvents="all",e.style.userSelect="text",e.style.maxWidth="250px",e.style.whiteSpace="pre-wrap",e.style["backdrop-filter"]="blur(10px)",e.style["-webkit-backdrop-filter"]="blur(10px)",e.style.backgroundColor="rgba(20,20,20,.8)",e.style.boxShadow="inset 0 0 80px rgba(0,0,0,.2), 0 0 5px rgba(0,0,0,.2)",e.style.border="1px solid rgba(160,160,160,.2)",e[Lw]=s,s){case _t.Log:e.classList.add("log"),e.style.color="rgba(200,200,200,.7)",e.style.backgroundColor="rgba(40,40,40,.7)";break;case _t.Warn:e.classList.add("warn"),e.style.color="rgb(255, 255, 150)",e.style.backgroundColor="rgba(50,50,20,.8)";break;case _t.Error:e.classList.add("error"),e.style.color="rgb(255, 50, 50",e.style.backgroundColor="rgba(50,20,20,.8)";break}return e.title="Open the browser console (F12) for more information",e.innerHTML=t,e}class kO{constructor(){a(this,"Rad2Deg",180/Math.PI);a(this,"Deg2Rad",Math.PI/180);a(this,"Epsilon",1e-5)}random(t,e){return Array.isArray(t)?t.length<=0?null:t[Math.floor(Math.random()*t.length)]:t!==void 0&&e!==void 0?Math.random()*(e-t)+t:Math.random()}randomVector3(t,e=0,i=1){t.x=this.random(e,i),t.y=this.random(e,i),t.z=this.random(e,i)}clamp(t,e,i){return t<e?e:t>i?i:t}clamp01(t){return this.clamp(t,0,1)}lerp(t,e,i){return i=i<0?0:i,i=i>1?1:i,t+(e-t)*i}inverseLerp(t,e,i){return(i-t)/(e-t)}remap(t,e,i,n,o){return n+(o-n)*(t-e)/(i-e)}moveTowards(t,e,i){return t+=i,(i<0&&t<e||i>0&&t>e)&&(t=e),t}toDegrees(t){return t*180/Math.PI}toRadians(t){return t*Math.PI/180}tan(t){return Math.tan(t)}gammaToLinear(t){return Math.pow(t,2.2)}linearToGamma(t){return Math.pow(t,1/2.2)}approximately(t,e,i=Number.EPSILON){for(const n of EO){const o=t[n],r=e[n];if(o===void 0||r===void 0)break;if(Math.abs(o-r)>i)return!1}return!0}easeInOutCubic(t){return t<.5?4*t*t*t:1-Math.pow(-2*t+2,3)/2}}const EO=["x","y","z","w"],W=new kO;class b0{constructor(t){a(this,"y");a(this,"s");a(this,"alpha",0);this.setAlpha(t),this.y=null,this.s=null}setAlpha(t){if(t<=0||t>1)throw new Error;this.alpha=t}filter(t,e){e&&this.setAlpha(e);let i;return this.y?i=this.alpha*t+(1-this.alpha)*this.s:i=t,this.y=t,this.s=i,i}lastValue(){return this.y}reset(t){this.y=t,this.s=t}}class qm{constructor(t,e=1,i=0,n=1){a(this,"freq");a(this,"minCutOff");a(this,"beta");a(this,"dCutOff");a(this,"x");a(this,"dx");a(this,"lasttime");if(t<=0||e<=0||n<=0)throw new Error;this.freq=t,this.minCutOff=e,this.beta=i,this.dCutOff=n,this.x=new b0(this.alpha(this.minCutOff)),this.dx=new b0(this.alpha(this.dCutOff)),this.lasttime=null}alpha(t){const e=1/this.freq;return 1/(1+1/(2*Math.PI*t)/e)}filter(t,e=null){this.lasttime&&e&&(this.freq=1/(e-this.lasttime)),this.lasttime=e;const i=this.x.lastValue(),n=i?(t-i)*this.freq:0,o=this.dx.filter(n,this.alpha(this.dCutOff)),r=this.minCutOff+this.beta*Math.abs(o);return this.x.filter(t,this.alpha(r))}reset(t){t!=null&&this.x.reset(t),this.x.alpha=this.alpha(this.minCutOff),this.dx.alpha=this.alpha(this.dCutOff),this.lasttime=null}}class jw{constructor(t,e=1,i=0,n=1){a(this,"x");a(this,"y");a(this,"z");this.x=new qm(t,e,i,n),this.y=new qm(t,e,i,n),this.z=new qm(t,e,i,n)}filter(t,e,i=null){e.x=this.x.filter(t.x,i),e.y=this.y.filter(t.y,i),e.z=this.z.filter(t.z,i)}reset(t){this.x.reset(t==null?void 0:t.x),this.y.reset(t==null?void 0:t.y),this.z.reset(t==null?void 0:t.z)}}const Xu="needle:cameraController";function MO(s){return s[Xu]}function v0(s,t,e){e?s[Xu]=t:s[Xu]===t&&(s[Xu]=null)}const uy="needle:autofit";function AO(s){return s[uy]===void 0?!0:s[uy]!==!1}function fy(s,t){s[uy]=t}function sL(s,t,e){const i=s.length(),n=t.length(),o=W.lerp(i,n,e);return s.lerp(t,e).normalize().multiplyScalar(o)}const Xm=new H,Bw=new H().setFromAxisAngle(new x(0,1,0),Math.PI);function oL(s,t){s.lookAt(t),s.quaternion.multiply(Bw)}function Mp(s,t,e=!0,i=!1){if(s===t)return;Xm.copy(s.quaternion);const n=ae(t),o=ae(s);if(i){if(as(s,Le(t)),e){const r=o.y,l=o.sub(NO(s));l.y=r,s.lookAt(l),s.quaternion.multiply(Bw)}Number.isNaN(s.quaternion.x)&&s.quaternion.copy(Xm);return}e&&(n.y=o.y),s.lookAt(n),Number.isNaN(s.quaternion.x)&&s.quaternion.copy(Xm)}const IO=new Dn(()=>new x,100);function Q(s,t,e){const i=IO.get();return i.set(0,0,0),s instanceof x?i.copy(s):Array.isArray(s)?i.set(s[0],s[1],s[2]):s instanceof DOMPointReadOnly?i.set(s.x,s.y,s.z):typeof s=="number"?(i.x=s,i.y=t!==void 0?t:i.x,i.z=e!==void 0?e:i.x):typeof s=="object"&&(i.x=s.x,i.y=s.y,i.z=s.z),i}const DO=new Dn(()=>new ue,30);function LO(s){const t=DO.get();return s?t.copy(s):t.set(0,0,0),t}const jO=new Dn(()=>new H,100);function Os(s){const t=jO.get();return t.identity(),s instanceof H?t.copy(s):s instanceof DOMPointReadOnly&&t.set(s.x,s.y,s.z,s.w),t}const D_=new Dn(()=>new x,100),x0=Symbol("lastMatrixWorldUpdateKey");function ae(s,t=null,e=!0){const i=t??D_.get();return s?s.parent?(e&&s.updateWorldMatrix(!0,!1),s.matrixWorldNeedsUpdate&&s[x0]!==Date.now()&&(s[x0]=Date.now(),s.updateMatrixWorld()),i.setFromMatrixPosition(s.matrixWorld),i):i.copy(s.position):i.set(0,0,0)}function jt(s,t){if(!s)return s;const e=D_.get();return t!==e&&e.copy(t),((s==null?void 0:s.parent)??s).worldToLocal(e),s.position.set(e.x,e.y,e.z),s}function _c(s,t,e,i){const n=D_.get();return n.set(t,e,i),jt(s,n),s}const xf=new Dn(()=>new H,100),Aa=new H,Qm=new H;function Le(s,t=null){if(!s)return xf.get().identity();const e=t??xf.get();return s.parent?(s.getWorldQuaternion(e),e):e.copy(s.quaternion)}function as(s,t){if(!s)return;t!==Aa&&Aa.copy(t);const e=Aa,i=s==null?void 0:s.parent;i==null||i.getWorldQuaternion(Qm),Qm.invert();const n=Qm.multiply(e);s.quaternion.set(n.x,n.y,n.z,n.w)}function Fw(s,t,e,i,n){Aa.set(t,e,i,n),as(s,Aa)}const BO=new Dn(()=>new x,100),FO=new x;function pt(s,t=null){return t||(t=BO.get()),s?s.parent?(s.getWorldScale(t),t):t.copy(s.scale):t.set(0,0,0)}function xd(s,t){if(!s)return;if(!s.parent){s.scale.copy(t);return}const e=FO;s.parent.getWorldScale(e),s.scale.copy(t),s.scale.divide(e)}const zO=new x,w0=new H;function rL(s){return Le(s,w0),zO.set(0,0,1).applyQuaternion(w0)}const UO=new Dn(()=>new x,100),S0=new H;function NO(s,t){return t||(t=UO.get().set(0,0,1)),Le(s,S0),t.applyQuaternion(S0)}const C0=new di,P0=new di,$O=new x;function zw(s){const t=xf.get();return s.getWorldQuaternion(t),P0.setFromQuaternion(t),P0}function Uw(s,t){const e=xf.get();as(s,e.setFromEuler(t))}function Ap(s){const t=zw(s),e=$O;return e.set(t.x,t.y,t.z),e.x=W.toDegrees(e.x),e.y=W.toDegrees(e.y),e.z=W.toDegrees(e.z),e}function Nw(s,t){Ip(s,t.x,t.y,t.z,!0)}function Ip(s,t,e,i,n=!0){n&&(t=W.toRadians(t),e=W.toRadians(e),i=W.toRadians(i)),C0.set(t,e,i),Aa.setFromEuler(C0),as(s,Aa)}function py(s,t=!0){s&&(t?function e(i){console.groupCollapsed((i.name?i.name:"(no name : "+i.type+")")+" %o",i),i.children.forEach(e),console.groupEnd()}(s):s.traverse(function(e){for(var i="|___",n=e;n.parent!==null;)i="	"+i,n=n.parent;console.log(i+e.name+" <"+e.type+">")}))}function aL(s){let t=(s==null?void 0:s.name)||"";if(!s)return t;let e=s.parent;for(;e;)t=e.name+"/"+t,e=e.parent;return t}function WO(s){if(s){const t=s;return t.blendMode!==void 0&&t.clampWhenFinished!==void 0&&t.enabled!==void 0&&t.fadeIn!==void 0&&t.getClip!==void 0}return!1}class qn{static createBlitMaterial(t){return new os({uniforms:{map:new Er(null)},vertexShader:this.vertex,fragmentShader:t})}static copyTexture(t,e){this.blitMaterial||(this.blitMaterial=new os({uniforms:{map:new Er(null)},vertexShader:this.vertex,fragmentShader:this.fragment}));const i=e||this.blitMaterial;i.uniforms.map.value=t,i.needsUpdate=!0,i.uniformsNeedUpdate=!0;const n=i.vertexShader;i.vertexShader=this.vertex,this.mesh||(this.mesh=new Z(this.planeGeometry,this.blitMaterial));const o=this.mesh;o.material=i,o.frustumCulled=!1,this.scene.children.length=0,this.scene.add(o),this.renderer||(this.renderer=new Qa({antialias:!1})),this.renderer.setSize(t.image.width,t.image.height),this.renderer.clear(),this.renderer.render(this.scene,this.perspectiveCam);const r=new Je(this.renderer.domElement);return r.name="Copy",r.needsUpdate=!0,i.vertexShader=n,r}static textureToCanvas(t,e=!1){if(!t)return null;(e===!0||t.isCompressedTexture===!0)&&(t=VO(t));const i=t.image;if(HO(i)){const n=document.createElement("canvas");n.width=i.width,n.height=i.height;const o=n.getContext("2d");return o?(o.drawImage(i,0,0,i.width,i.height,0,0,n.width,n.height),n):(console.error("Failed getting canvas 2d context"),null)}return null}}a(qn,"planeGeometry",new Ys(2,2,1,1)),a(qn,"renderer"),a(qn,"perspectiveCam",new Re),a(qn,"scene",new In),a(qn,"vertex",`
    varying vec2 vUv;
    void main(){
        vUv = uv;
        gl_Position = vec4(position.xy * 1.0,0.,.999999);
    }`),a(qn,"fragment",`
    uniform sampler2D map; 
    varying vec2 vUv;
    void main(){ 
        vec2 uv = vUv;
        uv.y = 1.0 - uv.y;
        gl_FragColor = texture2D( map, uv);
        // gl_FragColor = vec4(uv.xy, 0, 1);
    }`),a(qn,"blitMaterial"),a(qn,"mesh");function VO(s){return qn.copyTexture(s)}function lL(s,t=!1){return qn.textureToCanvas(s,t)}function HO(s){return typeof HTMLImageElement<"u"&&s instanceof HTMLImageElement||typeof HTMLCanvasElement<"u"&&s instanceof HTMLCanvasElement||typeof OffscreenCanvas<"u"&&s instanceof OffscreenCanvas||typeof ImageBitmap<"u"&&s instanceof ImageBitmap}function GO(s){const t=s.type;return t==="Mesh"||t==="SkinnedMesh"}function $w(s,t){t?s["needle:rendercustomshadow"]=!0:s["needle:rendercustomshadow"]=!1}function qO(s){if(s){if(s["needle:rendercustomshadow"]===!0)return!0;if(s["needle:rendercustomshadow"]==null)return!0}return!1}function dn(s,t=void 0,e=void 0,i=void 0){const n=i||new En;n.makeEmpty();const o=[];function r(c){let h=!0;if(c.visible&&AO(c)!==!1&&!(c.type==="TransformControlsGizmo"||c.type==="TransformControlsPlane")){if(c instanceof rw&&(h=!1),c instanceof w_&&(h=!1),c instanceof yc&&(h=!1),c.isGizmo===!0&&(h=!1),c.material instanceof ow&&(h=!1),GO(c)||(h=!1),e&&c.layers.test(e)===!1&&(h=!1),h){if(t&&Array.isArray(t)&&(t!=null&&t.includes(c)))return;if(typeof t=="function"&&t(c)===!0)return}if(c.isUI!==!0){if(h){const d=c.children;c.children=o;const u=c.position,f=c.scale;if(Number.isNaN(u.x)||Number.isNaN(u.y)||Number.isNaN(u.z)){console.warn(`Object "${c.name}" has NaN values in position or scale.... will ignore it`,u,f);return}n.expandByObject(c,!0),c.children=d}for(const d of c.children)r(d)}}}let l=!1;Array.isArray(s)||(s=[s]);for(const c of s)c&&(l=!0,c.updateMatrixWorld(),r(c));return l||console.warn("No objects to fit camera to..."),n}function XO(s,t,e){const i=dn([s],e==null?void 0:e.ignore),n=new x;i.getSize(n);const o=new x;i.getCenter(o);const r=new x;t.getSize(r);const l=new x;t.getCenter(l);const c=new x;c.set(r.x/n.x,r.y/n.y,r.z/n.z);const h=Math.min(c.x,c.y,c.z),d=(e==null?void 0:e.scale)!==!1;if(d&&xd(s,pt(s).multiplyScalar(h)),(e==null?void 0:e.position)!==!1){const u=new x;i.getCenter(u),u.y=i.min.y;const f=new x;t.getCenter(f),f.y=t.min.y;const p=f.clone().sub(u);d&&p.multiplyScalar(h),jt(s,ae(s).add(p))}return{boundsBefore:i,scale:c}}function QO(s,t){const e=dn([s]),i=new x;e.getCenter(i),i.y=e.min.y;const n=t.clone().sub(i),o=ae(s);return jt(s,o.add(n)),{offset:n,bounds:e}}function Ww(s,t,e,i){if(Array.isArray(t)){let r=!0;for(let l=0;l<t.length;l++)Ww(s,t[l],l,t)||(r=!1);return r}if(t.type==="MeshStandardMaterial"||t.type==="MeshBasicMaterial")return!1;if(t["material:fbx"]!=null)return!0;const n=new Vi;n["material:fbx"]=t;const o=t;return o&&(o.map?n.color.set(1,1,1):n.color.copyLinearToSRGB(o.color),n.emissive.copyLinearToSRGB(o.emissive),n.emissiveIntensity=o.emissiveIntensity,n.opacity=o.opacity,n.displacementScale=o.displacementScale,n.transparent=o.transparent,n.bumpMap=o.bumpMap,n.aoMap=o.aoMap,n.map=o.map,n.displacementMap=o.displacementMap,n.emissiveMap=o.emissiveMap,n.normalMap=o.normalMap,n.envMap=o.envMap,n.alphaMap=o.alphaMap,n.metalness=o.reflectivity,n.vertexColors=o.vertexColors,o.shininess&&(n.roughness=1-Math.sqrt(o.shininess)/10),n.needsUpdate=!0),e===void 0?s.material=n:i[e]=n,!0}let hu=!1;vO((...s)=>{var t;U()&&((t=be.Current)!=null&&t.isInXR)&&(tc(!0),Vw("error",...s))});function tc(s){if(s){if(hu)return;hu=!0,KO()}else{if(!hu)return;hu=!1,JO()}}const Dh={log:void 0,warn:void 0,error:void 0};class YO{constructor(){a(this,"familyName","needle-xr");a(this,"root",null);a(this,"context",null);a(this,"defaultFontSize",.06);a(this,"targetObject",new F);a(this,"userForwardViewPoint",new x);a(this,"oneEuroFilter",new jw(90,.8));a(this,"_lastElementRemoveTime",0);a(this,"onBeforeRender",()=>{var e,i;const t=(e=this.context)==null?void 0:e.mainCamera;if(this.context&&t instanceof Re){const n=this.getRoot();Number.isNaN(n.position.x)&&n.position.set(0,0,0),Number.isNaN(n.quaternion.x)&&n.quaternion.set(0,0,0,1),this.context.scene.add(this.targetObject);const o=((i=this.context.xr)==null?void 0:i.rigScale)??1,r=3.5*o,l=t.worldForward;l.y=0,l.normalize().multiplyScalar(r),this.userForwardViewPoint.copy(t.worldPosition).sub(l),this.targetObject.position.distanceTo(this.userForwardViewPoint)>2*o&&(this.targetObject.position.copy(this.userForwardViewPoint),Mp(this.targetObject,t,!0,!0),this.targetObject.rotateY(Math.PI)),this.oneEuroFilter.filter(this.targetObject.position,n.position,this.context.time.time);const h=this.context.time.deltaTime;if(n.quaternion.slerp(this.targetObject.quaternion,h*5),n.scale.setScalar(o),this.targetObject.removeFromParent(),this.context.scene.add(n),this.context.time.time-this._lastElementRemoveTime>.1){this._lastElementRemoveTime=this.context.time.time;const d=Date.now();for(let u=0;u<this._activeTexts.length;u++){const f=this._activeTexts[u];if(f instanceof Be.Text&&d-f._activatedTime>2e4){f.removeFromParent(),this._textBuffer.push(f),this._activeTexts.splice(u,1);break}}}}});a(this,"textOptions",{fontSize:this.defaultFontSize,fontFamily:this.familyName,padding:.03,margin:.005,color:0,backgroundColor:16777215,backgroundOpacity:.4,borderRadius:.03,offset:.025});a(this,"_textBuffer",[]);a(this,"_activeTexts",[]);this.ensureFont()}onEnable(){this.context=be.Current||be.All[0],this.context.pre_render_callbacks.push(this.onBeforeRender)}onDisable(){var t,e,i;(e=this.context)==null||e.pre_render_callbacks.splice((t=this.context)==null?void 0:t.pre_render_callbacks.indexOf(this.onBeforeRender),1),(i=this.root)==null||i.removeFromParent()}addLog(t,e){const i=this.getRoot(),n=this.getText();let o=16777215,r=0;switch(t){case"log":o=16777215,r=0;break;case"warn":o=16772761,r=4465152;break;case"error":o=16755370,r=7798784;break}e.length>1e3&&(e=e.substring(0,1e3)+"...");const l=new Date().toISOString().split("T")[1].split(".")[0];n.textContent="["+l+"] "+e,n.visible=!0,n._activatedTime=Date.now(),i.add(n),this._activeTexts.push(n),this.context&&this.context.scene.add(i),n.set({backgroundColor:o,color:r}),Be.update()}ensureFont(){let t=Be.FontLibrary.getFontFamily(this.familyName);if(!t){t=Be.FontLibrary.addFontFamily(this.familyName);const e=t.addVariant("normal","normal","./include/needle/arial-msdf.json","./include/needle/arial.png");e==null||e.addEventListener("ready",()=>{Be.update()})}}getText(){const t=this.getRoot();if(this._textBuffer.length>0){const i=this._textBuffer.pop();return i.visible=!0,setTimeout(()=>this.disableDepthTestRecursive(i),100),i}if(t.children.length>20&&this._activeTexts.length>0)return this._activeTexts.shift();const e=new Be.Text(this.textOptions);return setTimeout(()=>this.disableDepthTestRecursive(e),500),setTimeout(()=>this.disableDepthTestRecursive(e),1500),e}disableDepthTestRecursive(t,e=0){for(let n=0;n<t.children.length;n++){const o=t.children[n];o instanceof F&&this.disableDepthTestRecursive(o,e+1)}t.renderOrder=10*e,t.layers.set(2);const i=t.material;i&&(i.depthWrite=!1,i.depthTest=!1,i.transparent=!0),e===0&&Be.update()}getRoot(){if(this.root)return this.root;const t=this.defaultFontSize,e={boxSizing:"border-box",fontFamily:this.familyName,width:"2.6",fontSize:t,color:0,lineHeight:1,backgroundColor:16777215,backgroundOpacity:0,whiteSpace:"pre-wrap",flexDirection:"column-reverse"};return this.root=new Be.Block(e),this.root}}let Ti=null;function KO(){Ti||(Ti=new YO),Ti.onEnable();for(const s in Dh){Dh[s]=console[s];let t=!1;console[s]=function(){var e;if((e=Dh[s])==null||e.apply(console,arguments),!t)try{t=!0,Vw(s,...arguments)}finally{t=!1}}}}function JO(){Ti==null||Ti.onDisable();for(const s in Dh)console[s]=Dh[s]}const rh=new Map;function Vw(s,...t){try{switch(rh.clear(),s){case"log":Ti==null||Ti.addLog("log",e());break;case"warn":Ti==null||Ti.addLog("warn",e());break;case"error":Ti==null||Ti.addLog("error",e());break}}catch(o){console.error("Error in spatial console",o)}finally{rh.clear()}function e(){let o="";for(let r=0;r<t.length;r++){const l=t[r];o+=i(l),r<t.length-1&&(o+=", ")}return o}function i(o,r=0){if(typeof o=="string")return'"'+o+'"';if(typeof o=="number"){if(o%1!==0){const c=o.toFixed(5),h=c.indexOf(".");let d=c.length-1;for(;d>h&&c[d]==="0";)d--;return c.substring(0,d+1)}return o.toString()}else if(Array.isArray(o)){let l="[";for(let c=0;c<o.length;c++){const h=o[c];l+=i(h,r+1),c<o.length-1&&(l+=", ")}return l+="]",l}else{if(o===null)return"null";if(o===void 0)return"undefined";if(typeof o=="function")return o.name+"()"}if(o instanceof ce)return`(${i(o.x)}, ${i(o.y)})`;if(o instanceof x)return`(${i(o.x)}, ${i(o.y)}, ${i(o.z)})`;if(o instanceof xe)return`(${i(o.x)}, ${i(o.y)}, ${i(o.z)}, ${i(o.w)})`;if(o instanceof H)return`(${i(o.x)}, ${i(o.y)}, ${i(o.z)}, ${i(o.w)})`;if(o instanceof De||o instanceof Je)return o.name;if(o instanceof aw)return`[${o.elements.join(", ")}]`;if(o instanceof le)return`[${o.elements.join(", ")}]`;if(o instanceof Nr)return o.mask.toString();if(typeof o=="object"){if(rh.has(o))return"*";let l=`{
`;l+=n(r);const c=Object.keys(o);let h="";for(let d=0;d<c.length;d++){const u=c[d],f=o[u];if(rh.has(f)){h+="";continue}rh.set(f,!0),h+=u+":"+i(f,r+1),d<c.length-1&&(h+=", "),h.length>=60&&(h+=`
`,h+=n(r),l+=h,h="")}return l+=h,l+=`
}`,l}return o}function n(o){let r="";for(let l=0;l<o;l++)r+=" ";return r}}const ZO=C("nodevlogs");function tt(s,t=_t.Log){js(t,s)}function Me(s){tt(s,_t.Warn)}function Dp(s){tt(s,_t.Error)}let my,Ym;function U(){if(ZO)return!1;if(my!==void 0)return my;if(Ym!==void 0)return Ym;let s=qi();return s||(s=window.location.hostname.endsWith(".local-credentialless.webcontainer.io")),Ym=s,s}function cL(s){my=s}let ki,sn=null,Bs=null,ah=!1,R0=null;const Hw="terminal",Ch=C("console"),eT=C("noerrors")||C("noconsole")||window.crossOriginIsolated;Ch&&Gw();if(!eT&&(Ch||qi())){if(qi()&&!Ch){const t=new URL(window.location.href);t.searchParams.set("console","1"),console.log('üåµ Tip: You can add the "?console" query parameter to the url to show the debug console (on mobile it will automatically open in the bottom right corner when your get errors during development. In VR a spatial console will appear.)',`
Open this page to get the console: `+t.toString())}const s=J.isMobileDevice()||J.isQuest()&&U();if((s||Ch)&&(SO(),qw(),Xw(!0),s)){const t=document.querySelector("needle-engine");t==null||t.addEventListener("enter-ar",()=>{(Ch||ki||I_()>0)&&C("noerrors")}),t==null||t.addEventListener("exit-ar",()=>{oT()})}}const gy=Symbol("consoleParent");function Gw(){if(ki){ki.showSwitch();return}Xw()}function tT(){ki&&(ki.hide(),ki.hideSwitch())}function qw(){R0||(R0=setInterval(iT,500))}let O0=0;function iT(){const s=I_(),t=s!==O0;O0=s,t&&nT()}function nT(){Gw(),Bs&&(Bs.setAttribute("error","true"),Bs.innerText="ü§¨")}function sT(){Bs&&(Bs.removeAttribute("error"),Bs.innerText=Hw)}function oT(){sn&&sn[gy]&&sn[gy].appendChild(sn)}function Xw(s=!1){if(ki!==void 0||ah)return;ah=!0;const t=document.createElement("script");t.onload=()=>{if(!globalThis.VConsole){console.warn("üåµ Debug console failed to load."),ah=!1,ki=null;return}ah=!1,qw(),ki=new VConsole({pluginOrder:["default","needle-console"]});const e=globalThis["needle:codegen_files"];if(e&&e.length>0&&ki.addPlugin(rT()),sn=lT(),sn&&(sn[gy]=sn.parentElement,sn.style.position="absolute",sn.style.zIndex=Number.MAX_SAFE_INTEGER.toString()),ki.setSwitchPosition(20,30),Bs=aT(),Bs){Bs.innerText=Hw,Bs.addEventListener("click",sT);const i=document.createElement("style"),n=40;i.innerHTML=`
                #__vconsole .vc-switch {
                    border: 1px solid rgba(255, 255, 255, .1);
                    border-radius: 50%;
                    width: ${n}px;
                    height: ${n}px;
                    padding: 0;
                    line-height: ${n}px;
                    font-size: ${n*.4}px;
                    text-align: center;
                    background: #ffffff5c;
                    backdrop-filter: blur(16px);
                    -webkit-backdrop-filter: blur(16px);
                    user-select: none;
                    pointer-events: auto;
                    transition: transform .2s ease-in-out;
                    box-shadow: 0px 7px 0.5rem 0px rgb(0 0 0 / 6%), inset 0px 0px 1.3rem rgba(0,0,0,.05);

                    font-family: 'Material Symbols Outlined';
                    color: black;
                    font-size: 2.3em;
                    font-weight: 100;
                }
                #__vconsole .vc-switch:hover {
                    cursor: pointer;
                    transform: scale(1.1);
                    transition: transform .1s ease-in-out, background .1s linear;
                    background: rgba(245, 245, 245, .8);
                    outline: rgba(0, 0, 0, .05) 1px solid;
                }
                #__vconsole .vc-switch[error] {
                    background: rgba(255,0,0,.2);
                    animation: vconsole-notify 1s ease-in-out;
                    line-height: 35px;
                }
                @keyframes vconsole-notify {
                    from {
                        transform: scale(1, 1);
                    }
                    10% {
                        transform: scale(1.3, 1.3);
                    }
                    70% {
                        transform: scale(1.4, 1.4);
                    }
                    to {
                        transform: scale(1, 1);
                    }
                }
                #__vconsole .vc-panel {
                    font-family: monospace;
                    font-size: 11px;
                }
                #__vconsole .vc-plugin-box.vc-actived {
                    height: 100%;
                }
                #__vconsole .vc-mask {
                    overflow: hidden;
                }
            `,sn==null||sn.prepend(i),s===!0&&I_()<=0&&tT(),console.log("üåµ Debug console has loaded")}},t.onerror=()=>{console.warn("üåµ Debug console failed to load."+(window.crossOriginIsolated?"This page is using cross-origin isolation, so external scripts can't be loaded.":"")),ah=!1,ki=null},t.src="https://unpkg.com/vconsole@latest/dist/vconsole.min.js",document.body.appendChild(t)}function rT(){if(!globalThis.VConsole)return;const s=new VConsole.VConsolePlugin("needle-console","üåµ Inspect glTF"),t=()=>document.querySelector("#__vc_plug_"+s._id+" iframe");return s.on("renderTab",function(e){const i=globalThis["needle:codegen_files"];if(!i||i.length===0)return;let n=globalThis["needle:codegen_files"][0];const o=n.indexOf("?");o>-1&&(n=n.substring(0,o));const l=location.protocol+"//"+location.host+location.pathname+"/"+n,c=encodeURIComponent(l);s.fullUrl="https://viewer.needle.tools?inspect&file="+c;var h='<iframe src="" style="width: 100%; height: 99%; border: none;"></iframe>';e(h)}),s.on("show",function(){const e=t();e&&e.src!==s.fullUrl&&(e.src=s.fullUrl)}),s.on("hide",function(){const e=t();e&&(e.src="")}),s.on("addTopBar",function(e){var i=new Array;i.push({name:"Open in new window ‚Üó",onClick:function(n){window.open(s.fullUrl,"_blank"),ki==null||ki.hide()}}),i.push({name:"Reload",onClick:function(n){const o=t();o&&(o.src=s.fullUrl)}}),i.push({name:"Fullscreen",onClick:function(n){const o=t();o.requestFullscreen?o.requestFullscreen():o.webkitRequestFullscreen instanceof Function&&o.webkitRequestFullscreen()}}),e(i)}),s}function aT(){const s=document.querySelector("#__vconsole .vc-switch");return s||null}function lT(){const s=document.querySelector("#__vconsole");return s||null}const Qw=C("debugdefines");Gr('if(!globalThis[""4.3.2""]) globalThis[""4.3.2""] = "0.0.0";');Gr('if(!globalThis[""Unity 6000.0.41f1, Needle Engine Integration @4.3.0-alpha.3""]) globalThis[""Unity 6000.0.41f1, Needle Engine Integration @4.3.0-alpha.3""] = "unknown";');Gr('if(!globalThis[""Thu Apr 10 2025 14:21:13 GMT+0200 (Mitteleurop√§ische Sommerzeit)""]) globalThis[""Thu Apr 10 2025 14:21:13 GMT+0200 (Mitteleurop√§ische Sommerzeit)""] = "unknown";');Gr('if(!globalThis[""npk_7b38a780c72bfd09b067bac31063942f452868085b0f187ea809d1b849d8ce0f""]) globalThis[""npk_7b38a780c72bfd09b067bac31063942f452868085b0f187ea809d1b849d8ce0f""] = "unknown";');Gr('globalThis["__NEEDLE_ENGINE_VERSION__"] = "4.3.2";');Gr('globalThis["__NEEDLE_ENGINE_GENERATOR__"] = "Unity 6000.0.41f1, Needle Engine Integration @4.3.0-alpha.3";');Gr('globalThis["__NEEDLE_PROJECT_BUILD_TIME__"] = "Thu Apr 10 2025 14:21:13 GMT+0200 (Mitteleurop√§ische Sommerzeit)";');Gr('globalThis["__NEEDLE_PUBLIC_KEY__"] = "npk_7b38a780c72bfd09b067bac31063942f452868085b0f187ea809d1b849d8ce0f";');const $s="4.3.2",Yw="Unity 6000.0.41f1, Needle Engine Integration @4.3.0-alpha.3",Kw="Thu Apr 10 2025 14:21:13 GMT+0200 (Mitteleurop√§ische Sommerzeit)";Qw&&console.log(`Engine version: ${$s} (generator: ${Yw})
Project built at ${Kw}`);const Qu="npk_7b38a780c72bfd09b067bac31063942f452868085b0f187ea809d1b849d8ce0f",Dr="needle_isActiveInHierarchy",kl="builtin_components",Yu="needle_editor_guid";function Gr(s){try{(0,eval)(s)}catch(t){Qw&&console.error(t)}}const cT='<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 160 187.74"><defs><linearGradient id="a" x1="89.64" y1="184.81" x2="90.48" y2="21.85" gradientUnits="userSpaceOnUse"><stop offset="0" stop-color="#62d399"/><stop offset=".51" stop-color="#acd842"/><stop offset=".9" stop-color="#d7db0a"/></linearGradient><linearGradient id="b" x1="69.68" y1="178.9" x2="68.08" y2="16.77" gradientUnits="userSpaceOnUse"><stop offset="0" stop-color="#0ba398"/><stop offset=".5" stop-color="#4ca352"/><stop offset="1" stop-color="#76a30a"/></linearGradient><linearGradient id="c" x1="36.6" y1="152.17" x2="34.7" y2="84.19" gradientUnits="userSpaceOnUse"><stop offset=".19" stop-color="#36a382"/><stop offset=".54" stop-color="#49a459"/><stop offset="1" stop-color="#76a30b"/></linearGradient><linearGradient id="d" x1="15.82" y1="153.24" x2="18" y2="90.86" gradientUnits="userSpaceOnUse"><stop offset="0" stop-color="#267880"/><stop offset=".51" stop-color="#457a5c"/><stop offset="1" stop-color="#717516"/></linearGradient><linearGradient id="e" x1="135.08" y1="135.43" x2="148.93" y2="63.47" gradientUnits="userSpaceOnUse"><stop offset="0" stop-color="#b0d939"/><stop offset="1" stop-color="#eadb04"/></linearGradient><linearGradient id="f" x1="-4163.25" y1="2285.12" x2="-4160.81" y2="2215.34" gradientTransform="rotate(20 4088.49 13316.712)" gradientUnits="userSpaceOnUse"><stop offset=".17" stop-color="#74af52"/><stop offset=".48" stop-color="#99be32"/><stop offset="1" stop-color="#c0c40a"/></linearGradient><symbol id="g" viewBox="0 0 160 187.74"><path style="fill:url(#a)" d="M79.32 36.98v150.76L95 174.54l6.59-156.31-22.27 18.75z"/><path style="fill:url(#b)" d="M79.32 36.98 57.05 18.23l6.59 156.31 15.68 13.2V36.98z"/><path style="fill:url(#c)" d="m25.19 104.83 8.63 49.04 12.5-14.95-2.46-56.42-18.67 22.33z"/><path style="fill:url(#d)" d="M25.19 104.83 0 90.24l16.97 53.86 16.85 9.77-8.63-49.04z"/><path style="fill:#9c3" d="M43.86 82.5 18.69 67.98 0 90.24l25.18 14.59L43.86 82.5z"/><path style="fill:url(#e)" d="m134.82 78.69-9.97 56.5 15.58-9.04L160 64.1l-25.18 14.59z"/><path style="fill:url(#f)" d="m134.82 78.69-18.68-22.33-2.86 65 11.57 13.83 9.97-56.5z"/><path style="fill:#ffe113" d="m160 64.1-18.69-22.26-25.17 14.52 18.67 22.33L160 64.1z"/><path style="fill:#f3e600" d="M101.59 18.23 79.32 0 57.05 18.23l22.27 18.75 22.27-18.75z"/></symbol></defs><use width="160" height="187.74" xlink:href="#g"/></svg>',hT=btoa(cT),dT="data:image/svg+xml;base64,"+hT,uT=dT,fT=`<?xml version="1.0" encoding="UTF-8"?> <!DOCTYPE svg PUBLIC '-//W3C//DTD SVG 1.1//EN' 'http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd'> <svg clip-rule="evenodd" fill-rule="evenodd" stroke-linejoin="round" stroke-miterlimit="2" version="1.1" viewBox="0 0 1014 282" xml:space="preserve" xmlns="http://www.w3.org/2000/svg"> <g transform="matrix(1.008 0 0 1.008 -2.239 .61874)"> <path d="m665.95 132.73v44.88l-10.56-8.4c-0.8-0.64-1.2-1.44-1.2-2.4v-32.4c0-6.48-4.12-9.72-12.36-9.72-2.16 0-4.18 0.4-6.06 1.2s-3.54 1.8-4.98 3-2.56 2.5-3.36 3.9-1.2 2.7-1.2 3.9v40.92l-10.68-8.4c-0.72-0.64-1.08-1.44-1.08-2.4v-53.76l10.92 8.52c0.32 0.24 0.56 0.44 0.72 0.6s0.36 0.32 0.6 0.48c0.96-1.2 2.14-2.28 3.54-3.24s2.92-1.76 4.56-2.4 3.34-1.14 5.1-1.5 3.44-0.54 5.04-0.54c1.44 0 2.92 0.04 4.44 0.12s2.84 0.28 3.96 0.6c4.56 1.12 7.8 3.12 9.72 6s2.88 6.56 2.88 11.04z" fill-rule="nonzero"/> </g> <g transform="matrix(1.008 0 0 1.008 -2.239 .61874)"> <path d="m732.38 146.05c0 0.88 0.02 1.5 0.06 1.86s-0.02 0.98-0.18 1.86h-7.08c-2.08 0-4.44-0.02-7.08-0.06s-5.36-0.06-8.16-0.06h-22.08c0 2.88 0.56 5.36 1.68 7.44s2.6 3.8 4.44 5.16 3.94 2.36 6.3 3 4.74 0.96 7.14 0.96c3.04 0 5.9-0.76 8.58-2.28s4.94-3.52 6.78-6c0.64 0.56 1.54 1.48 2.7 2.76s2.94 3.2 5.34 5.76c-2.8 3.36-6.22 6.02-10.26 7.98s-8.42 2.94-13.14 2.94-8.92-0.64-12.84-1.92-7.32-3.24-10.2-5.88-5.12-5.98-6.72-10.02-2.4-8.82-2.4-14.34c0-4.96 0.66-9.42 1.98-13.38s3.22-7.32 5.7-10.08 5.44-4.9 8.88-6.42 7.32-2.28 11.64-2.28c5.76 0 10.52 0.88 14.28 2.64s6.72 4.16 8.88 7.2 3.66 6.54 4.5 10.5 1.26 8.18 1.26 12.66zm-29.4-22.8c-2.16 0.16-4.16 0.72-6 1.68s-3.42 2.2-4.74 3.72-2.36 3.28-3.12 5.28-1.14 4.12-1.14 6.36h33.12c0-2-0.22-4.06-0.66-6.18s-1.3-4.02-2.58-5.7-3.1-3.02-5.46-4.02-5.5-1.38-9.42-1.14z" fill-rule="nonzero"/> </g> <g transform="matrix(1.008 0 0 1.008 -2.239 .61874)"> <path d="m795.93 146.05c0 0.88 0.02 1.5 0.06 1.86s-0.02 0.98-0.18 1.86h-7.08c-2.08 0-4.44-0.02-7.08-0.06s-5.36-0.06-8.16-0.06h-22.08c0 2.88 0.56 5.36 1.68 7.44s2.6 3.8 4.44 5.16 3.94 2.36 6.3 3 4.74 0.96 7.14 0.96c3.04 0 5.9-0.76 8.58-2.28s4.94-3.52 6.78-6c0.64 0.56 1.54 1.48 2.7 2.76s2.94 3.2 5.34 5.76c-2.8 3.36-6.22 6.02-10.26 7.98s-8.42 2.94-13.14 2.94-8.92-0.64-12.84-1.92-7.32-3.24-10.2-5.88-5.12-5.98-6.72-10.02-2.4-8.82-2.4-14.34c0-4.96 0.66-9.42 1.98-13.38s3.22-7.32 5.7-10.08 5.44-4.9 8.88-6.42 7.32-2.28 11.64-2.28c5.76 0 10.52 0.88 14.28 2.64s6.72 4.16 8.88 7.2 3.66 6.54 4.5 10.5 1.26 8.18 1.26 12.66zm-29.4-22.8c-2.16 0.16-4.16 0.72-6 1.68s-3.42 2.2-4.74 3.72-2.36 3.28-3.12 5.28-1.14 4.12-1.14 6.36h33.12c0-2-0.22-4.06-0.66-6.18s-1.3-4.02-2.58-5.7-3.1-3.02-5.46-4.02-5.5-1.38-9.42-1.14z" fill-rule="nonzero"/> </g> <g transform="matrix(1.008 0 0 1.008 -2.239 .61874)"> <path d="m858.57 97.21c0.64 0.48 0.96 1.16 0.96 2.04v74.88c-0.08 1.04-0.12 2.12-0.12 3.24-1.84-1.52-3.56-2.92-5.16-4.2-1.36-1.12-2.66-2.18-3.9-3.18s-2.06-1.66-2.46-1.98c-1.76 2.48-4.26 4.44-7.5 5.88s-7.02 2.16-11.34 2.16c-3.84 0-7.4-0.7-10.68-2.1s-6.14-3.44-8.58-6.12-4.34-5.94-5.7-9.78-2.04-8.16-2.04-12.96c0-4.32 0.78-8.34 2.34-12.06s3.6-6.92 6.12-9.6 5.38-4.78 8.58-6.3 6.48-2.28 9.84-2.28c2.56 0 4.82 0.22 6.78 0.66s3.68 1.06 5.16 1.86 2.78 1.74 3.9 2.82 2.16 2.22 3.12 3.42v-35.04l10.68 8.64zm-27.96 67.92c3.6 0 6.52-0.68 8.76-2.04s3.98-3.06 5.22-5.1 2.1-4.22 2.58-6.54 0.72-4.44 0.72-6.36v-1.2c0-1.12-0.22-2.7-0.66-4.74s-1.28-4.06-2.52-6.06-3-3.7-5.28-5.1-5.22-2.02-8.82-1.86c-3.44 0-6.26 0.74-8.46 2.22s-3.96 3.26-5.28 5.34-2.24 4.2-2.76 6.36-0.78 3.92-0.78 5.28c0 1.84 0.24 3.92 0.72 6.24s1.36 4.48 2.64 6.48 3.04 3.68 5.28 5.04 5.12 2.04 8.64 2.04z" fill-rule="nonzero"/> </g> <g transform="matrix(1.008 0 0 1.008 -2.239 .61874)"> <path d="m882.81 97.09c0.64 0.48 0.96 1.12 0.96 1.92l-0.12 41.04v37.08l-10.56-8.4c-0.72-0.64-1.08-1.44-1.08-2.4v-77.88l10.8 8.64z" fill-rule="nonzero"/> </g> <g transform="matrix(1.008 0 0 1.008 -2.239 .61874)"> <path d="m950.36 146.05c0 0.88 0.02 1.5 0.06 1.86s-0.02 0.98-0.18 1.86h-7.08c-2.08 0-4.44-0.02-7.08-0.06s-5.36-0.06-8.16-0.06h-22.08c0 2.88 0.56 5.36 1.68 7.44s2.6 3.8 4.44 5.16 3.94 2.36 6.3 3 4.74 0.96 7.14 0.96c3.04 0 5.9-0.76 8.58-2.28s4.94-3.52 6.78-6c0.64 0.56 1.54 1.48 2.7 2.76s2.94 3.2 5.34 5.76c-2.8 3.36-6.22 6.02-10.26 7.98s-8.42 2.94-13.14 2.94-8.92-0.64-12.84-1.92-7.32-3.24-10.2-5.88-5.12-5.98-6.72-10.02-2.4-8.82-2.4-14.34c0-4.96 0.66-9.42 1.98-13.38s3.22-7.32 5.7-10.08 5.44-4.9 8.88-6.42 7.32-2.28 11.64-2.28c5.76 0 10.52 0.88 14.28 2.64s6.72 4.16 8.88 7.2 3.66 6.54 4.5 10.5 1.26 8.18 1.26 12.66zm-29.4-22.8c-2.16 0.16-4.16 0.72-6 1.68s-3.42 2.2-4.74 3.72-2.36 3.28-3.12 5.28-1.14 4.12-1.14 6.36h33.12c0-2-0.22-4.06-0.66-6.18s-1.3-4.02-2.58-5.7-3.1-3.02-5.46-4.02-5.5-1.38-9.42-1.14z" fill-rule="nonzero"/> </g> <g transform="matrix(1.8559 0 0 .7642 45.348 36.475)"> <g transform="translate(2.7114)"> <path d="m3.935 173.02c-0.331 0-0.497-0.402-0.497-1.207v-51.002c0-0.738 0.138-1.107 0.414-1.107h1.781c0.277 0 0.415 0.335 0.415 1.006v5.935c0 0.336 0.027 0.553 0.083 0.654 0.055 0.101 0.151-0.017 0.289-0.352 0.912-1.744 1.754-3.236 2.527-4.477 0.773-1.24 1.554-2.179 2.341-2.816s1.65-0.956 2.588-0.956c1.685 0 3.011 0.922 3.977 2.766 0.967 1.845 1.602 3.84 1.905 5.986 0.056 0.268 0.139 0.369 0.249 0.302s0.221-0.235 0.331-0.503c0.939-1.811 1.802-3.353 2.589-4.628 0.787-1.274 1.581-2.246 2.382-2.917s1.671-1.006 2.61-1.006c2.016 0 3.569 1.392 4.66 4.175 1.09 2.783 1.636 6.421 1.636 10.915v37.925c0 0.871-0.18 1.307-0.539 1.307h-1.739c-0.138 0-0.249-0.1-0.332-0.301-0.083-0.202-0.124-0.503-0.124-0.906v-36.315c0-3.555-0.338-6.321-1.015-8.3-0.676-1.978-1.76-2.967-3.251-2.967-0.884 0-1.726 0.386-2.527 1.157s-1.519 1.727-2.154 2.867-1.201 2.213-1.699 3.219c-0.248 0.469-0.421 0.905-0.517 1.308-0.097 0.402-0.145 0.972-0.145 1.71v37.221c0 0.871-0.166 1.307-0.497 1.307h-1.74c-0.166 0-0.29-0.1-0.373-0.301-0.083-0.202-0.124-0.503-0.124-0.906v-36.315c0-3.555-0.332-6.321-0.994-8.3-0.663-1.978-1.754-2.967-3.273-2.967-1.242 0-2.375 0.704-3.396 2.112-1.022 1.409-2.223 3.555-3.604 6.439v39.031c0 0.805-0.18 1.207-0.539 1.207h-1.698z" fill-rule="nonzero" stroke="#000" stroke-width=".7px"/> </g> <g transform="translate(2.7114)"> <path d="m53.642 166.28c-1.077 2.549-2.237 4.477-3.479 5.785-1.243 1.307-2.61 1.961-4.101 1.961-2.154 0-3.853-1.324-5.095-3.973-1.243-2.649-1.864-6.187-1.864-10.613 0-3.488 0.4-6.489 1.201-9.004s1.988-4.51 3.562-5.985c1.574-1.476 3.521-2.414 5.841-2.817l3.686-0.704c0.221-0.067 0.394-0.218 0.518-0.453 0.124-0.234 0.187-0.587 0.187-1.056v-2.917c0-3.89-0.504-6.975-1.512-9.255s-2.354-3.42-4.039-3.42c-1.298 0-2.472 0.72-3.521 2.162s-2.002 3.572-2.858 6.388c-0.083 0.268-0.159 0.453-0.228 0.554-0.069 0.1-0.172 0.083-0.311-0.051l-1.698-1.71c-0.083-0.134-0.138-0.285-0.166-0.453-0.027-0.167 0.014-0.452 0.125-0.855 0.856-3.353 2.009-6.052 3.459-8.098 1.449-2.045 3.224-3.068 5.322-3.068 1.74 0 3.211 0.687 4.412 2.062s2.112 3.37 2.734 5.986c0.621 2.615 0.932 5.7 0.932 9.255v35.712c0 0.536-0.035 0.888-0.104 1.056s-0.2 0.251-0.393 0.251h-1.533c-0.166 0-0.29-0.117-0.373-0.352-0.083-0.234-0.124-0.553-0.124-0.955l-0.083-5.231c-0.055-0.939-0.221-1.006-0.497-0.202zm0.456-19.314c0-1.14-0.194-1.643-0.58-1.509l-3.107 0.603c-1.436 0.202-2.686 0.638-3.749 1.308-1.063 0.671-1.953 1.543-2.671 2.616s-1.257 2.33-1.616 3.772-0.538 3.102-0.538 4.98c0 3.152 0.455 5.616 1.367 7.393 0.911 1.778 2.14 2.666 3.686 2.666 0.939 0 1.85-0.419 2.734-1.257s1.671-1.895 2.361-3.169c0.663-1.408 1.181-2.85 1.553-4.326 0.373-1.475 0.56-2.883 0.56-4.225v-8.852z" fill-rule="nonzero" stroke="#000" stroke-width=".7px"/> </g> <g transform="translate(2.7114)"> <path d="m79.034 173.02c-0.166 0-0.297-0.117-0.394-0.352-0.096-0.234-0.145-0.553-0.145-0.955v-4.628c0-0.536-0.041-0.838-0.124-0.905s-0.207 0.1-0.373 0.503c-0.276 0.67-0.69 1.593-1.242 2.766-0.553 1.174-1.271 2.23-2.154 3.169-0.884 0.939-1.961 1.408-3.231 1.408-1.74 0-3.314-0.989-4.722-2.967-1.409-1.979-2.534-4.963-3.376-8.953-0.843-3.991-1.264-8.937-1.264-14.838 0-5.701 0.415-10.68 1.243-14.939s1.988-7.595 3.479-10.009c1.492-2.415 3.204-3.622 5.137-3.622 1.436 0 2.616 0.57 3.541 1.71 0.926 1.14 1.719 2.381 2.382 3.722 0.249 0.47 0.414 0.637 0.497 0.503s0.125-0.536 0.125-1.207v-23.841c0-0.805 0.151-1.208 0.455-1.208h1.864c0.276 0 0.414 0.369 0.414 1.107v72.128c0 0.537-0.041 0.905-0.124 1.107-0.083 0.201-0.235 0.301-0.455 0.301h-1.533zm-0.621-42.049c-0.939-2.213-1.885-3.94-2.838-5.181s-2.009-1.861-3.169-1.861c-1.463 0-2.768 0.889-3.914 2.666s-2.044 4.376-2.693 7.796-0.973 7.578-0.973 12.474c0 5.097 0.338 9.272 1.015 12.524 0.676 3.253 1.567 5.651 2.672 7.193 1.104 1.543 2.305 2.314 3.603 2.314 1.188 0 2.258-0.704 3.211-2.113 0.952-1.408 1.705-3.118 2.257-5.13s0.829-3.957 0.829-5.835v-24.847z" fill-rule="nonzero" stroke="#000" stroke-width=".7px"/> </g> <g transform="translate(2.7114)"> <path d="m89.514 149.38c0 3.42 0.345 6.606 1.035 9.557 0.691 2.951 1.609 5.315 2.755 7.092s2.437 2.666 3.873 2.666c1.519 0 2.837-0.738 3.956-2.213 1.118-1.476 2.064-3.655 2.837-6.539 0.083-0.336 0.166-0.52 0.249-0.554 0.083-0.033 0.179 0.017 0.29 0.151l1.408 1.912c0.221 0.268 0.235 0.67 0.041 1.207-0.69 2.548-1.47 4.661-2.34 6.337-0.87 1.677-1.857 2.935-2.962 3.773-1.104 0.838-2.319 1.257-3.645 1.257-2.043 0-3.838-1.14-5.385-3.42-1.546-2.28-2.761-5.482-3.645-9.607-0.884-4.124-1.325-8.836-1.325-14.134 0-5.901 0.455-10.931 1.367-15.089 0.911-4.158 2.14-7.377 3.686-9.658 1.547-2.28 3.3-3.42 5.261-3.42 1.988 0 3.714 1.073 5.178 3.219 1.463 2.146 2.595 5.231 3.396 9.255s1.201 8.886 1.201 14.587c0 0.469-0.02 0.939-0.062 1.408-0.041 0.469-0.214 0.704-0.517 0.704h-16.362c-0.083 0-0.152 0.151-0.207 0.453-0.056 0.302-0.083 0.654-0.083 1.056zm13.752-6.237c0.304 0 0.497-0.1 0.58-0.302 0.083-0.201 0.124-0.57 0.124-1.106 0-3.219-0.283-6.187-0.849-8.903s-1.367-4.896-2.402-6.539c-1.036-1.643-2.272-2.464-3.708-2.464-1.629 0-2.996 0.955-4.101 2.867-1.104 1.911-1.94 4.342-2.506 7.293s-0.849 6.002-0.849 9.154h13.711z" fill-rule="nonzero" stroke="#000" stroke-width=".7px"/> </g> <g transform="translate(2.7114)"> <path d="m148.54 119.7c0.165 0 0.283 0.117 0.352 0.352s0.076 0.52 0.02 0.855l-6.254 50.902c-0.028 0.47-0.104 0.788-0.228 0.956s-0.297 0.251-0.518 0.251h-1.615c-0.442 0-0.718-0.402-0.829-1.207l-5.26-40.138c-0.111-0.604-0.201-0.905-0.27-0.905s-0.131 0.301-0.186 0.905l-5.012 40.138c-0.028 0.47-0.097 0.788-0.207 0.956-0.111 0.168-0.277 0.251-0.497 0.251h-1.74c-0.442 0-0.718-0.402-0.829-1.207l-6.503-50.801c-0.055-0.403-0.048-0.721 0.021-0.956s0.2-0.352 0.393-0.352h1.823c0.166 0 0.297 0.067 0.393 0.201 0.097 0.134 0.159 0.403 0.187 0.805l5.302 41.848c0.083 0.671 0.179 0.989 0.29 0.956 0.11-0.034 0.207-0.386 0.29-1.056l5.219-41.949c0.055-0.268 0.124-0.47 0.207-0.604s0.193-0.201 0.331-0.201h1.533c0.138 0 0.262 0.067 0.373 0.201 0.11 0.134 0.179 0.403 0.207 0.805l5.468 41.848c0.083 0.671 0.179 0.989 0.29 0.956 0.11-0.034 0.207-0.386 0.29-1.056l5.053-41.849c0.055-0.335 0.138-0.57 0.249-0.704 0.11-0.134 0.234-0.201 0.373-0.201h1.284z" fill-rule="nonzero" stroke="#000" stroke-width=".7px"/> </g> <g transform="translate(2.7114)"> <path d="m156.49 171.51c0 0.604-0.042 1.006-0.125 1.208-0.082 0.201-0.262 0.301-0.538 0.301h-1.533c-0.221 0-0.366-0.083-0.435-0.251s-0.103-0.486-0.103-0.956v-50.902c0-0.805 0.152-1.207 0.456-1.207h1.822c0.304 0 0.456 0.402 0.456 1.207v50.6zm0.165-63.979c0 1.207-0.207 1.811-0.621 1.811h-1.905c-0.221 0-0.366-0.135-0.435-0.403s-0.104-0.67-0.104-1.207v-7.847c0-1.006 0.18-1.509 0.539-1.509h1.988c0.359 0 0.538 0.47 0.538 1.409v7.746z" fill-rule="nonzero" stroke="#000" stroke-width=".7px"/> </g> <g transform="translate(2.7114)"> <path d="m168.3 124.83c-0.221 0-0.331 0.269-0.331 0.805v33.801c0 3.42 0.221 5.667 0.663 6.74 0.441 1.073 1.09 1.609 1.946 1.609h3.024c0.138 0 0.242 0.084 0.311 0.252 0.069 0.167 0.103 0.419 0.103 0.754v2.716c0 0.537-0.138 0.906-0.414 1.107-0.248 0.067-0.614 0.134-1.098 0.201-0.483 0.067-0.959 0.118-1.429 0.151-0.469 0.034-0.828 0.05-1.077 0.05-1.712 0-2.934-0.955-3.665-2.867-0.732-1.911-1.098-5.013-1.098-9.305v-35.108c0-0.604-0.124-0.906-0.373-0.906h-3.521c-0.248 0-0.373-0.268-0.373-0.804v-3.521c0-0.537 0.111-0.805 0.332-0.805h3.686c0.166 0 0.263-0.268 0.29-0.805l0.415-16.095c0-0.805 0.124-1.207 0.372-1.207h1.492c0.303 0 0.455 0.436 0.455 1.307v15.995c0 0.537 0.097 0.805 0.29 0.805h5.468c0.221 0 0.331 0.268 0.331 0.805v3.521c0 0.536-0.124 0.804-0.373 0.804h-5.426z" fill-rule="nonzero" stroke="#000" stroke-width=".7px"/> </g> <g transform="translate(2.7114)"> <path d="m179.4 173.02c-0.331 0-0.497-0.402-0.497-1.207v-72.329c0-0.738 0.138-1.107 0.414-1.107h1.782c0.276 0 0.414 0.336 0.414 1.006v27.162c0 0.335 0.034 0.536 0.103 0.603s0.159-0.033 0.27-0.302c0.994-1.81 1.898-3.319 2.713-4.526 0.814-1.208 1.629-2.113 2.444-2.717 0.814-0.603 1.691-0.905 2.63-0.905 2.182 0 3.839 1.375 4.971 4.125 1.132 2.749 1.698 6.404 1.698 10.965v37.925c0 0.871-0.166 1.307-0.497 1.307h-1.74c-0.165 0-0.29-0.1-0.373-0.301-0.082-0.202-0.124-0.503-0.124-0.906v-36.315c0-3.555-0.366-6.321-1.097-8.3-0.732-1.978-1.899-2.967-3.501-2.967-0.883 0-1.705 0.318-2.464 0.956-0.76 0.637-1.526 1.576-2.299 2.816-0.773 1.241-1.643 2.834-2.61 4.779v39.031c0 0.805-0.179 1.207-0.538 1.207h-1.699z" fill-rule="nonzero" stroke="#000" stroke-width=".7px"/> </g> </g> <g transform="matrix(.80638 0 0 .80638 452.53 65.421)" fill-rule="nonzero"> <path d="m79.32 36.98v150.76l15.68-13.2 6.59-156.31-22.27 18.75z" fill="url(#f)"/> <path d="m79.32 36.98-22.27-18.75 6.59 156.31 15.68 13.2v-150.76z" fill="url(#e)"/> <path d="m25.19 104.83 8.63 49.04 12.5-14.95-2.46-56.42-18.67 22.33z" fill="url(#d)"/> <path d="m25.19 104.83-25.19-14.59 16.97 53.86 16.85 9.77-8.63-49.04z" fill="url(#c)"/> <path d="M43.86,82.5L18.69,67.98L0,90.24L25.18,104.83L43.86,82.5Z" fill="#9c3"/> <path d="m134.82 78.69-9.97 56.5 15.58-9.04 19.57-62.05-25.18 14.59z" fill="url(#b)"/> <path d="m134.82 78.69-18.68-22.33-2.86 65 11.57 13.83 9.97-56.5z" fill="url(#a)"/> <path d="m160 64.1-18.69-22.26-25.17 14.52 18.67 22.33 25.19-14.59z" fill="#ffe113"/> <path d="M101.59,18.23L79.32,0L57.05,18.23L79.32,36.98L101.59,18.23Z" fill="#f3e600"/> </g> <defs> <linearGradient id="f" x2="1" gradientTransform="matrix(.84 -162.96 162.96 .84 89.64 184.81)" gradientUnits="userSpaceOnUse"><stop stop-color="#62d399" offset="0"/><stop stop-color="#acd842" offset=".51"/><stop stop-color="#d7db0a" offset=".9"/><stop stop-color="#d7db0a" offset="1"/></linearGradient> <linearGradient id="e" x2="1" gradientTransform="matrix(-1.6,-162.13,162.13,-1.6,69.68,178.9)" gradientUnits="userSpaceOnUse"><stop stop-color="#0ba398" offset="0"/><stop stop-color="#4ca352" offset=".5"/><stop stop-color="#76a30a" offset="1"/></linearGradient> <linearGradient id="d" x2="1" gradientTransform="matrix(-1.9,-67.98,67.98,-1.9,36.6,152.17)" gradientUnits="userSpaceOnUse"><stop stop-color="#36a382" offset="0"/><stop stop-color="#36a382" offset=".19"/><stop stop-color="#49a459" offset=".54"/><stop stop-color="#76a30b" offset="1"/></linearGradient> <linearGradient id="c" x2="1" gradientTransform="matrix(2.18,-62.38,62.38,2.18,15.82,153.24)" gradientUnits="userSpaceOnUse"><stop stop-color="#267880" offset="0"/><stop stop-color="#457a5c" offset=".51"/><stop stop-color="#717516" offset="1"/></linearGradient> <linearGradient id="b" x2="1" gradientTransform="matrix(13.85,-71.96,71.96,13.85,135.08,135.43)" gradientUnits="userSpaceOnUse"><stop stop-color="#b0d939" offset="0"/><stop stop-color="#eadb04" offset="1"/></linearGradient> <linearGradient id="a" x2="1" gradientTransform="matrix(26.159 -64.737 64.737 26.159 107.42 128.14)" gradientUnits="userSpaceOnUse"><stop stop-color="#74af52" offset="0"/><stop stop-color="#74af52" offset=".17"/><stop stop-color="#99be32" offset=".48"/><stop stop-color="#c0c40a" offset="1"/></linearGradient> </defs> </svg>`;btoa(fT);const pT='<svg viewBox="0 0 509 154" xmlns="http://www.w3.org/2000/svg" xml:space="preserve" style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:2"><path d="M665.95 132.73v44.88l-10.56-8.4c-.8-.64-1.2-1.44-1.2-2.4v-32.4c0-6.48-4.12-9.72-12.36-9.72-2.16 0-4.18.4-6.06 1.2-1.88.8-3.54 1.8-4.98 3-1.44 1.2-2.56 2.5-3.36 3.9-.8 1.4-1.2 2.7-1.2 3.9v40.92l-10.68-8.4c-.72-.64-1.08-1.44-1.08-2.4v-53.76l10.92 8.52c.32.24.56.44.72.6.16.16.36.32.6.48.96-1.2 2.14-2.28 3.54-3.24 1.4-.96 2.92-1.76 4.56-2.4 1.64-.64 3.34-1.14 5.1-1.5 1.76-.36 3.44-.54 5.04-.54 1.44 0 2.92.04 4.44.12 1.52.08 2.84.28 3.96.6 4.56 1.12 7.8 3.12 9.72 6 1.92 2.88 2.88 6.56 2.88 11.04ZM732.38 146.05c0 .88.02 1.5.06 1.86.04.36-.02.98-.18 1.86h-7.08c-2.08 0-4.44-.02-7.08-.06-2.64-.04-5.36-.06-8.16-.06h-22.08c0 2.88.56 5.36 1.68 7.44 1.12 2.08 2.6 3.8 4.44 5.16 1.84 1.36 3.94 2.36 6.3 3 2.36.64 4.74.96 7.14.96 3.04 0 5.9-.76 8.58-2.28 2.68-1.52 4.94-3.52 6.78-6 .64.56 1.54 1.48 2.7 2.76 1.16 1.28 2.94 3.2 5.34 5.76-2.8 3.36-6.22 6.02-10.26 7.98-4.04 1.96-8.42 2.94-13.14 2.94-4.72 0-8.92-.64-12.84-1.92-3.92-1.28-7.32-3.24-10.2-5.88-2.88-2.64-5.12-5.98-6.72-10.02-1.6-4.04-2.4-8.82-2.4-14.34 0-4.96.66-9.42 1.98-13.38 1.32-3.96 3.22-7.32 5.7-10.08s5.44-4.9 8.88-6.42c3.44-1.52 7.32-2.28 11.64-2.28 5.76 0 10.52.88 14.28 2.64 3.76 1.76 6.72 4.16 8.88 7.2 2.16 3.04 3.66 6.54 4.5 10.5.84 3.96 1.26 8.18 1.26 12.66Zm-29.4-22.8c-2.16.16-4.16.72-6 1.68-1.84.96-3.42 2.2-4.74 3.72-1.32 1.52-2.36 3.28-3.12 5.28-.76 2-1.14 4.12-1.14 6.36h33.12c0-2-.22-4.06-.66-6.18-.44-2.12-1.3-4.02-2.58-5.7-1.28-1.68-3.1-3.02-5.46-4.02-2.36-1-5.5-1.38-9.42-1.14ZM795.93 146.05c0 .88.02 1.5.06 1.86.04.36-.02.98-.18 1.86h-7.08c-2.08 0-4.44-.02-7.08-.06-2.64-.04-5.36-.06-8.16-.06h-22.08c0 2.88.56 5.36 1.68 7.44 1.12 2.08 2.6 3.8 4.44 5.16 1.84 1.36 3.94 2.36 6.3 3 2.36.64 4.74.96 7.14.96 3.04 0 5.9-.76 8.58-2.28 2.68-1.52 4.94-3.52 6.78-6 .64.56 1.54 1.48 2.7 2.76 1.16 1.28 2.94 3.2 5.34 5.76-2.8 3.36-6.22 6.02-10.26 7.98-4.04 1.96-8.42 2.94-13.14 2.94-4.72 0-8.92-.64-12.84-1.92-3.92-1.28-7.32-3.24-10.2-5.88-2.88-2.64-5.12-5.98-6.72-10.02-1.6-4.04-2.4-8.82-2.4-14.34 0-4.96.66-9.42 1.98-13.38 1.32-3.96 3.22-7.32 5.7-10.08s5.44-4.9 8.88-6.42c3.44-1.52 7.32-2.28 11.64-2.28 5.76 0 10.52.88 14.28 2.64 3.76 1.76 6.72 4.16 8.88 7.2 2.16 3.04 3.66 6.54 4.5 10.5.84 3.96 1.26 8.18 1.26 12.66Zm-29.4-22.8c-2.16.16-4.16.72-6 1.68-1.84.96-3.42 2.2-4.74 3.72-1.32 1.52-2.36 3.28-3.12 5.28-.76 2-1.14 4.12-1.14 6.36h33.12c0-2-.22-4.06-.66-6.18-.44-2.12-1.3-4.02-2.58-5.7-1.28-1.68-3.1-3.02-5.46-4.02-2.36-1-5.5-1.38-9.42-1.14ZM858.57 97.21c.64.48.96 1.16.96 2.04v74.88c-.08 1.04-.12 2.12-.12 3.24-1.84-1.52-3.56-2.92-5.16-4.2-1.36-1.12-2.66-2.18-3.9-3.18-1.24-1-2.06-1.66-2.46-1.98-1.76 2.48-4.26 4.44-7.5 5.88-3.24 1.44-7.02 2.16-11.34 2.16-3.84 0-7.4-.7-10.68-2.1-3.28-1.4-6.14-3.44-8.58-6.12-2.44-2.68-4.34-5.94-5.7-9.78-1.36-3.84-2.04-8.16-2.04-12.96 0-4.32.78-8.34 2.34-12.06 1.56-3.72 3.6-6.92 6.12-9.6 2.52-2.68 5.38-4.78 8.58-6.3 3.2-1.52 6.48-2.28 9.84-2.28 2.56 0 4.82.22 6.78.66 1.96.44 3.68 1.06 5.16 1.86s2.78 1.74 3.9 2.82a35.92 35.92 0 0 1 3.12 3.42V88.57l10.68 8.64Zm-27.96 67.92c3.6 0 6.52-.68 8.76-2.04 2.24-1.36 3.98-3.06 5.22-5.1a20.5 20.5 0 0 0 2.58-6.54c.48-2.32.72-4.44.72-6.36v-1.2c0-1.12-.22-2.7-.66-4.74-.44-2.04-1.28-4.06-2.52-6.06s-3-3.7-5.28-5.1c-2.28-1.4-5.22-2.02-8.82-1.86-3.44 0-6.26.74-8.46 2.22-2.2 1.48-3.96 3.26-5.28 5.34-1.32 2.08-2.24 4.2-2.76 6.36-.52 2.16-.78 3.92-.78 5.28 0 1.84.24 3.92.72 6.24.48 2.32 1.36 4.48 2.64 6.48s3.04 3.68 5.28 5.04c2.24 1.36 5.12 2.04 8.64 2.04ZM882.81 97.09c.64.48.96 1.12.96 1.92l-.12 41.04v37.08l-10.56-8.4c-.72-.64-1.08-1.44-1.08-2.4V88.45l10.8 8.64ZM950.36 146.05c0 .88.02 1.5.06 1.86.04.36-.02.98-.18 1.86h-7.08c-2.08 0-4.44-.02-7.08-.06-2.64-.04-5.36-.06-8.16-.06h-22.08c0 2.88.56 5.36 1.68 7.44 1.12 2.08 2.6 3.8 4.44 5.16 1.84 1.36 3.94 2.36 6.3 3 2.36.64 4.74.96 7.14.96 3.04 0 5.9-.76 8.58-2.28 2.68-1.52 4.94-3.52 6.78-6 .64.56 1.54 1.48 2.7 2.76 1.16 1.28 2.94 3.2 5.34 5.76-2.8 3.36-6.22 6.02-10.26 7.98-4.04 1.96-8.42 2.94-13.14 2.94-4.72 0-8.92-.64-12.84-1.92-3.92-1.28-7.32-3.24-10.2-5.88-2.88-2.64-5.12-5.98-6.72-10.02-1.6-4.04-2.4-8.82-2.4-14.34 0-4.96.66-9.42 1.98-13.38 1.32-3.96 3.22-7.32 5.7-10.08s5.44-4.9 8.88-6.42c3.44-1.52 7.32-2.28 11.64-2.28 5.76 0 10.52.88 14.28 2.64 3.76 1.76 6.72 4.16 8.88 7.2 2.16 3.04 3.66 6.54 4.5 10.5.84 3.96 1.26 8.18 1.26 12.66Zm-29.4-22.8c-2.16.16-4.16.72-6 1.68-1.84.96-3.42 2.2-4.74 3.72-1.32 1.52-2.36 3.28-3.12 5.28-.76 2-1.14 4.12-1.14 6.36h33.12c0-2-.22-4.06-.66-6.18-.44-2.12-1.3-4.02-2.58-5.7-1.28-1.68-3.1-3.02-5.46-4.02-2.36-1-5.5-1.38-9.42-1.14Z" style="fill-rule:nonzero" transform="translate(-452.406 -63.709) scale(1.00797)"/><path d="M79.32 36.98v150.76L95 174.54l6.59-156.31-22.27 18.75Z" style="fill:url(#a);fill-rule:nonzero" transform="matrix(.80638 0 0 .80638 2.361 1.094)"/><path d="M79.32 36.98 57.05 18.23l6.59 156.31 15.68 13.2V36.98Z" style="fill:url(#b);fill-rule:nonzero" transform="matrix(.80638 0 0 .80638 2.361 1.094)"/><path d="m25.19 104.83 8.63 49.04 12.5-14.95-2.46-56.42-18.67 22.33Z" style="fill:url(#c);fill-rule:nonzero" transform="matrix(.80638 0 0 .80638 2.361 1.094)"/><path d="M25.19 104.83 0 90.24l16.97 53.86 16.85 9.77-8.63-49.04Z" style="fill:url(#d);fill-rule:nonzero" transform="matrix(.80638 0 0 .80638 2.361 1.094)"/><path d="M43.86 82.5 18.69 67.98 0 90.24l25.18 14.59L43.86 82.5Z" style="fill:#9c3;fill-rule:nonzero" transform="matrix(.80638 0 0 .80638 2.361 1.094)"/><path d="m134.82 78.69-9.97 56.5 15.58-9.04L160 64.1l-25.18 14.59Z" style="fill:url(#e);fill-rule:nonzero" transform="matrix(.80638 0 0 .80638 2.361 1.094)"/><path d="m134.82 78.69-18.68-22.33-2.86 65 11.57 13.83 9.97-56.5Z" style="fill:url(#f);fill-rule:nonzero" transform="matrix(.80638 0 0 .80638 2.361 1.094)"/><path d="m160 64.1-18.69-22.26-25.17 14.52 18.67 22.33L160 64.1Z" style="fill:#ffe113;fill-rule:nonzero" transform="matrix(.80638 0 0 .80638 2.361 1.094)"/><path d="M101.59 18.23 79.32 0 57.05 18.23l22.27 18.75 22.27-18.75Z" style="fill:#f3e600;fill-rule:nonzero" transform="matrix(.80638 0 0 .80638 2.361 1.094)"/><defs><linearGradient id="a" x1="0" y1="0" x2="1" y2="0" gradientUnits="userSpaceOnUse" gradientTransform="matrix(.84 -162.96 162.96 .84 89.64 184.81)"><stop offset="0" style="stop-color:#62d399;stop-opacity:1"/><stop offset=".51" style="stop-color:#acd842;stop-opacity:1"/><stop offset=".9" style="stop-color:#d7db0a;stop-opacity:1"/><stop offset="1" style="stop-color:#d7db0a;stop-opacity:1"/></linearGradient><linearGradient id="b" x1="0" y1="0" x2="1" y2="0" gradientUnits="userSpaceOnUse" gradientTransform="rotate(-90.565 123.412 54.953) scale(162.14)"><stop offset="0" style="stop-color:#0ba398;stop-opacity:1"/><stop offset=".5" style="stop-color:#4ca352;stop-opacity:1"/><stop offset="1" style="stop-color:#76a30a;stop-opacity:1"/></linearGradient><linearGradient id="c" x1="0" y1="0" x2="1" y2="0" gradientUnits="userSpaceOnUse" gradientTransform="scale(-68) rotate(88.4 .881 -1.396)"><stop offset="0" style="stop-color:#36a382;stop-opacity:1"/><stop offset=".19" style="stop-color:#36a382;stop-opacity:1"/><stop offset=".54" style="stop-color:#49a459;stop-opacity:1"/><stop offset="1" style="stop-color:#76a30b;stop-opacity:1"/></linearGradient><linearGradient id="d" x1="0" y1="0" x2="1" y2="0" gradientUnits="userSpaceOnUse" gradientTransform="rotate(-88 87.255 68.431) scale(62.42)"><stop offset="0" style="stop-color:#267880;stop-opacity:1"/><stop offset=".51" style="stop-color:#457a5c;stop-opacity:1"/><stop offset="1" style="stop-color:#717516;stop-opacity:1"/></linearGradient><linearGradient id="e" x1="0" y1="0" x2="1" y2="0" gradientUnits="userSpaceOnUse" gradientTransform="rotate(-79.1 149.53 -14.065) scale(73.28)"><stop offset="0" style="stop-color:#b0d939;stop-opacity:1"/><stop offset="1" style="stop-color:#eadb04;stop-opacity:1"/></linearGradient><linearGradient id="f" x1="0" y1="0" x2="1" y2="0" gradientUnits="userSpaceOnUse" gradientTransform="rotate(-67.997 148.705 -15.558) scale(69.8226)"><stop offset="0" style="stop-color:#74af52;stop-opacity:1"/><stop offset=".17" style="stop-color:#74af52;stop-opacity:1"/><stop offset=".48" style="stop-color:#99be32;stop-opacity:1"/><stop offset="1" style="stop-color:#c0c40a;stop-opacity:1"/></linearGradient></defs></svg>',mT=btoa(pT),gT="data:image/svg+xml;charset=utf-8;base64,"+mT,yT=gT,_T=C("debugpatch");function L_(s,t,e,i){const n=_T===t;if(!e&&!i)return;const o=t+"___needle";bT(s,t,e,i);const r=Object.getOwnPropertyDescriptor(s,t),l=s[t];n&&console.log("Patch",s.constructor.name,t,r,l),r?(n&&console.log("Apply patch with existing descriptor",s.constructor.name,t,r),typeof r.value=="function"&&(s[t]=k0(r.value,s,t))):(n&&console.log("Create patch with new property",s.constructor.name,t,r),Object.defineProperty(s,t,{set:function(c){if(typeof c=="function")this[o]=k0(c,s,t);else{const h=this[o];Jw(s,t,this,h,c),this[o]=c,Zw(s,t,this,h,c)}},get:function(){const c=this[o];return typeof c=="function"&&c[o]?c[o]:c}}))}function hL(s,t,e){const i=j_(s,t);if(i)for(let n=i.length-1;n>=0;n--){const o=i[n];o.prefix===e&&(o.prefix=null),o.postfix===e&&(o.postfix=null),!o.prefix&&!o.postfix&&i.splice(n,1)}}const T0=Symbol("Needle:Patches:WrappedFunction");function k0(s,t,e){if(s[T0])return s;const i=function(...n){Jw(t,e,this,...n);const o=s.apply(this,n);return Zw(t,e,this,o,...n),o};return i[T0]=!0,i}const Km="Needle:Patches";function yy(){return globalThis[Km]||(globalThis[Km]=new WeakMap),globalThis[Km]}function j_(s,t){const e=yy().get(s);return e?e.get(t):null}function bT(s,t,e,i){let n=yy().get(s);n||(n=new Map,yy().set(s,n));let o=n.get(t);o||(o=[],n.set(t,o)),o.push({prefix:e,postfix:i})}function Jw(s,t,e,...i){var o;if(!e)return;const n=j_(s,t);if(n)for(const r of n)(o=r.prefix)==null||o.call(e,...i)}function Zw(s,t,e,i,...n){var r;if(!e)return;const o=j_(s,t);if(o)for(const l of o)(r=l.postfix)==null||r.call(e,i,...n)}const bc=[];function B_(s){bc.indexOf(s)===-1&&bc.push(s)}function dL(s){const t=bc.indexOf(s);t!==-1&&bc.splice(t,1)}const vc=[];function eS(s){vc.indexOf(s)===-1&&vc.push(s)}function uL(s){const t=vc.indexOf(s);t!==-1&&vc.splice(t,1)}function vT(s){globalThis.dispatchEvent(new CustomEvent("needle-xrsession-start",{detail:s}));for(let t=0;t<bc.length;t++)bc[t](s)}function xT(s){globalThis.dispatchEvent(new CustomEvent("needle-xrsession-end",{detail:s}));for(let t=0;t<vc.length;t++)vc[t](s)}const Mt={Handedness:Object.freeze({NONE:"none",LEFT:"left",RIGHT:"right"}),ComponentState:Object.freeze({DEFAULT:"default",TOUCHED:"touched",PRESSED:"pressed"}),ComponentProperty:Object.freeze({BUTTON:"button",X_AXIS:"xAxis",Y_AXIS:"yAxis",STATE:"state"}),ComponentType:Object.freeze({TRIGGER:"trigger",SQUEEZE:"squeeze",TOUCHPAD:"touchpad",THUMBSTICK:"thumbstick",BUTTON:"button"}),ButtonTouchThreshold:.05,AxisTouchThreshold:.1,VisualResponseProperty:Object.freeze({TRANSFORM:"transform",VISIBILITY:"visibility"})};async function tS(s){const t=await fetch(s);if(t.ok)return t.json();throw new Error(t.statusText)}async function wT(s){if(!s)throw new Error("No basePath supplied");return await tS(`${s}/profilesList.json`)}async function ST(s,t,e=null,i=!0){if(!s)throw new Error("No xrInputSource supplied");if(!t)throw new Error("No basePath supplied");const n=await wT(t);let o;if(s.profiles.some(c=>{const h=n[c];return h&&(o={profileId:c,profilePath:`${t}/${h.path}`,deprecated:!!h.deprecated}),!!o}),!o){if(!e)throw new Error("No matching profile name found");const c=n[e];if(!c)throw new Error(`No matching profile name found and default profile "${e}" missing.`);o={profileId:e,profilePath:`${t}/${c.path}`,deprecated:!!c.deprecated}}const r=await tS(o.profilePath);let l;if(i){let c;if(s.handedness==="any"?c=r.layouts[Object.keys(r.layouts)[0]]:c=r.layouts[s.handedness],!c)throw new Error(`No matching handedness, ${s.handedness}, in profile ${o.profileId}`);c.assetPath&&(l=o.profilePath.replace("profile.json",c.assetPath))}return{profile:r,assetPath:l}}const CT={xAxis:0,yAxis:0,button:0,state:Mt.ComponentState.DEFAULT};function PT(s=0,t=0){let e=s,i=t;if(Math.sqrt(s*s+t*t)>1){const r=Math.atan2(t,s);e=Math.cos(r),i=Math.sin(r)}return{normalizedXAxis:e*.5+.5,normalizedYAxis:i*.5+.5}}class RT{constructor(t){this.componentProperty=t.componentProperty,this.states=t.states,this.valueNodeName=t.valueNodeName,this.valueNodeProperty=t.valueNodeProperty,this.valueNodeProperty===Mt.VisualResponseProperty.TRANSFORM&&(this.minNodeName=t.minNodeName,this.maxNodeName=t.maxNodeName),this.value=0,this.updateFromComponent(CT)}updateFromComponent({xAxis:t,yAxis:e,button:i,state:n}){const{normalizedXAxis:o,normalizedYAxis:r}=PT(t,e);switch(this.componentProperty){case Mt.ComponentProperty.X_AXIS:this.value=this.states.includes(n)?o:.5;break;case Mt.ComponentProperty.Y_AXIS:this.value=this.states.includes(n)?r:.5;break;case Mt.ComponentProperty.BUTTON:this.value=this.states.includes(n)?i:0;break;case Mt.ComponentProperty.STATE:this.valueNodeProperty===Mt.VisualResponseProperty.VISIBILITY?this.value=this.states.includes(n):this.value=this.states.includes(n)?1:0;break;default:throw new Error(`Unexpected visualResponse componentProperty ${this.componentProperty}`)}}}let OT=class{constructor(t,e){if(!t||!e||!e.visualResponses||!e.gamepadIndices||Object.keys(e.gamepadIndices).length===0)throw new Error("Invalid arguments supplied");this.id=t,this.type=e.type,this.rootNodeName=e.rootNodeName,this.touchPointNodeName=e.touchPointNodeName,this.visualResponses={},Object.keys(e.visualResponses).forEach(i=>{const n=new RT(e.visualResponses[i]);this.visualResponses[i]=n}),this.gamepadIndices=Object.assign({},e.gamepadIndices),this.values={state:Mt.ComponentState.DEFAULT,button:this.gamepadIndices.button!==void 0?0:void 0,xAxis:this.gamepadIndices.xAxis!==void 0?0:void 0,yAxis:this.gamepadIndices.yAxis!==void 0?0:void 0}}get data(){return{id:this.id,...this.values}}updateFromGamepad(t){if(this.values.state=Mt.ComponentState.DEFAULT,this.gamepadIndices.button!==void 0&&t.buttons.length>this.gamepadIndices.button){const e=t.buttons[this.gamepadIndices.button];this.values.button=e.value,this.values.button=this.values.button<0?0:this.values.button,this.values.button=this.values.button>1?1:this.values.button,e.pressed||this.values.button===1?this.values.state=Mt.ComponentState.PRESSED:(e.touched||this.values.button>Mt.ButtonTouchThreshold)&&(this.values.state=Mt.ComponentState.TOUCHED)}this.gamepadIndices.xAxis!==void 0&&t.axes.length>this.gamepadIndices.xAxis&&(this.values.xAxis=t.axes[this.gamepadIndices.xAxis],this.values.xAxis=this.values.xAxis<-1?-1:this.values.xAxis,this.values.xAxis=this.values.xAxis>1?1:this.values.xAxis,this.values.state===Mt.ComponentState.DEFAULT&&Math.abs(this.values.xAxis)>Mt.AxisTouchThreshold&&(this.values.state=Mt.ComponentState.TOUCHED)),this.gamepadIndices.yAxis!==void 0&&t.axes.length>this.gamepadIndices.yAxis&&(this.values.yAxis=t.axes[this.gamepadIndices.yAxis],this.values.yAxis=this.values.yAxis<-1?-1:this.values.yAxis,this.values.yAxis=this.values.yAxis>1?1:this.values.yAxis,this.values.state===Mt.ComponentState.DEFAULT&&Math.abs(this.values.yAxis)>Mt.AxisTouchThreshold&&(this.values.state=Mt.ComponentState.TOUCHED)),Object.values(this.visualResponses).forEach(e=>{e.updateFromComponent(this.values)})}};class TT{constructor(t,e,i){if(!t)throw new Error("No xrInputSource supplied");if(!e)throw new Error("No profile supplied");this.xrInputSource=t,this.assetUrl=i,this.id=e.profileId,this.layoutDescription=e.layouts[t.handedness],this.components={},Object.keys(this.layoutDescription.components).forEach(n=>{const o=this.layoutDescription.components[n];this.components[n]=new OT(n,o)}),this.updateFromGamepad()}get gripSpace(){return this.xrInputSource.gripSpace}get targetRaySpace(){return this.xrInputSource.targetRaySpace}get data(){const t=[];return Object.values(this.components).forEach(e=>{t.push(e.data)}),t}updateFromGamepad(){Object.values(this.components).forEach(t=>{t.updateFromGamepad(this.xrInputSource.gamepad)})}}const wt=C("debuginput");var Sr;(function(s){s.Mouse="mouse",s.Touch="touch",s.Controller="controller",s.Hand="hand"})(Sr||(Sr={}));var E0;(function(s){s.PointerDown="pointerdown",s.PointerUp="pointerup",s.PointerMove="pointermove"})(E0||(E0={}));var M0;(function(s){s.KeyDown="keydown",s.KeyUp="keyup",s.KeyPressed="keypress"})(M0||(M0={}));var ye;(function(s){s.PointerDown="pointerdown",s.PointerUp="pointerup",s.PointerMove="pointermove",s.KeyDown="keydown",s.KeyUp="keyup",s.KeyPressed="keypress"})(ye||(ye={}));class dr extends PointerEvent{constructor(e,i,n){super(e,n);a(this,"clientZ");a(this,"deviceIndex");a(this,"origin");a(this,"source");a(this,"mode");a(this,"_ray");a(this,"space");a(this,"isClick",!1);a(this,"isDoubleClick",!1);a(this,"_used",!1);a(this,"_pointerid");a(this,"_pointerType");a(this,"_type");a(this,"metadata",{});a(this,"intersections",new Array);a(this,"_immediatePropagationStopped",!1);a(this,"_propagationStopped",!1);this.clientZ=n.clientZ,this._pointerid=n.pointerId,this._pointerType=n.pointerType,this._type=e,this.deviceIndex=n.deviceIndex,this.origin=n.origin,this.source=i,this.mode=n.mode,this._ray=n.ray,this.space=n.device}get isSpatial(){return this.mode!="screen"}get ray(){return this._ray||(this._ray=new $r(this.space.worldPosition.clone(),this.space.worldForward.clone())),this._ray}set ray(e){this._ray=e}get hasRay(){return this._ray!==void 0}get used(){return this._used}use(){this._used=!0}get pointerId(){return this._pointerid}get pointerType(){return this._pointerType}get type(){return this._type}get immediatePropagationStopped(){return this._immediatePropagationStopped}get propagationStopped(){return this._immediatePropagationStopped||this._propagationStopped}stopImmediatePropagation(){var e;this._immediatePropagationStopped=!0,super.stopImmediatePropagation(),(e=this.source)==null||e.stopImmediatePropagation()}stopPropagation(){var e;this._propagationStopped=!0,super.stopPropagation(),(e=this.source)==null||e.stopPropagation(),wt&&console.warn("Stop propagation...",this.pointerId,this.pointerType)}}class du extends KeyboardEvent{constructor(e,i,n){super(e,n);a(this,"source");this.source=i}stopImmediatePropagation(){var e;super.stopImmediatePropagation(),(e=this.source)==null||e.stopImmediatePropagation()}}class pL{constructor(t){a(this,"key");a(this,"keyType");a(this,"source");this.key=t.key,this.keyType=t.type,this.source=t}}var Wi;(function(s){s[s.Early=-100]="Early",s[s.Default=0]="Default",s[s.Late=100]="Late"})(Wi||(Wi={}));class kT{constructor(t){a(this,"_eventListeners",{});a(this,"_doubleClickTimeThreshold",.2);a(this,"_longPressTimeThreshold",1);a(this,"_setCursorTypes",[]);a(this,"context");a(this,"_pointerDown",[!1]);a(this,"_pointerUp",[!1]);a(this,"_pointerClick",[!1]);a(this,"_pointerDoubleClick",[!1]);a(this,"_pointerPressed",[!1]);a(this,"_pointerPositions",[new ce]);a(this,"_pointerPositionsLastFrame",[new ce]);a(this,"_pointerPositionsDelta",[new ce]);a(this,"_pointerPositionsRC",[new ce]);a(this,"_pointerPositionDown",[new x]);a(this,"_pointerDownTime",[]);a(this,"_pointerUpTime",[]);a(this,"_pointerUpTimestamp",[]);a(this,"_pointerIds",[]);a(this,"_pointerTypes",[""]);a(this,"_mouseWheelChanged",[!1]);a(this,"_mouseWheelDeltaY",[0]);a(this,"_pointerEvent",[]);a(this,"_pointerEventsPressed",[]);a(this,"_pointerSpace",[]);a(this,"_pressedStack",new Map);a(this,"_htmlEventSource");a(this,"onLostFocus",()=>{for(const t in this.keysPressed)this.keysPressed[t].pressed=!1});a(this,"_receivedPointerMoveEventsThisFrame",new Array);a(this,"onEndOfFrame",()=>{this._receivedPointerMoveEventsThisFrame.length=0;for(let t=0;t<this._pointerUp.length;t++)this._pointerUp[t]=!1;for(let t=0;t<this._pointerDown.length;t++)this._pointerDown[t]=!1;for(let t=0;t<this._pointerClick.length;t++)this._pointerClick[t]=!1;for(let t=0;t<this._pointerDoubleClick.length;t++)this._pointerDoubleClick[t]=!1;for(const t of this._pointerPositionsDelta)t.set(0,0);for(let t=0;t<this._mouseWheelChanged.length;t++)this._mouseWheelChanged[t]=!1;for(let t=0;t<this._mouseWheelDeltaY.length;t++)this._mouseWheelDeltaY[t]=0});a(this,"onContextMenu",t=>{this.canReceiveInput(t)!==!1&&t instanceof PointerEvent&&t.pointerType});a(this,"keysPressed",{});a(this,"onKeyDown",t=>{if(wt&&console.log(`key down ${t.code}, ${this.context.application.hasFocus}`,t),!this.context.application.hasFocus)return;const e=this.keysPressed[t.code];if(e&&e.pressed)return;this.keysPressed[t.code]={pressed:!0,frame:this.context.time.frameCount+1,startFrame:this.context.time.frameCount+1,key:t.key,code:t.code};const i=new du(ye.KeyDown,t,t);this.onDispatchEvent(i)});a(this,"onKeyPressed",t=>{if(!this.context.application.hasFocus)return;const e=this.keysPressed[t.code];if(!e)return;e.pressed=!0,e.frame=this.context.time.frameCount+1;const i=new du(ye.KeyPressed,t,t);this.onDispatchEvent(i)});a(this,"onKeyUp",t=>{if(!this.context.application.hasFocus)return;const e=this.keysPressed[t.code];if(!e)return;e.pressed=!1,e.frame=this.context.time.frameCount+1;const i=new du(ye.KeyUp,t,t);this.onDispatchEvent(i)});a(this,"onWheelWindow",t=>{document.pointerLockElement&&this.onMouseWheel(t)});a(this,"onMouseWheel",t=>{if(this.canReceiveInput(t)===!1)return;this._mouseWheelDeltaY.length<=0&&this._mouseWheelDeltaY.push(0),this._mouseWheelChanged.length<=0&&this._mouseWheelChanged.push(!1),this._mouseWheelChanged[0]=!0;const e=this._mouseWheelDeltaY[0];this._mouseWheelDeltaY[0]=e+t.deltaY});a(this,"onPointerDown",t=>{if(this.context.isInAR||this.canReceiveInput(t)===!1)return;t.target instanceof HTMLElement&&t.target.setPointerCapture(t.pointerId);const e=this.getPointerId(t);wt&&tt(`pointer down #${e}, identifier:${t.pointerId}`);const i=this.getAndUpdateSpatialObjectForScreenPosition(e,t.clientX,t.clientY),n=new dr(ye.PointerDown,t,{origin:this,mode:"screen",deviceIndex:0,pointerId:e,button:t.button,clientX:t.clientX,clientY:t.clientY,pointerType:t.pointerType,buttonName:this.getButtonName(t),device:i,pressure:t.pressure});this.onDown(n)});a(this,"onPointerMove",t=>{if(this.context.isInAR||this._receivedPointerMoveEventsThisFrame.includes(t.pointerId))return;this._receivedPointerMoveEventsThisFrame.push(t.pointerId);let e=t.button;t.pointerType==="mouse"&&(e=this.getFirstPressedButtonForPointer(0)??0);const i=this.getPointerId(t,e);e===-1&&(e=i);const n=this.getAndUpdateSpatialObjectForScreenPosition(i,t.clientX,t.clientY),o=new dr(ye.PointerMove,t,{origin:this,mode:"screen",deviceIndex:0,pointerId:i,button:e,clientX:t.clientX,clientY:t.clientY,pointerType:t.pointerType,buttonName:this.getButtonName(t),device:n,pressure:t.pressure});this.onMove(o)});a(this,"onPointerCancel",t=>{this.context.isInAR||(wt&&console.log("Pointer cancel",t),this.onPointerUp(t))});a(this,"onPointerUp",t=>{if(this.context.isInAR)return;t.target instanceof HTMLElement&&t.target.releasePointerCapture(t.pointerId);const e=this.getPointerId(t),i=new dr(ye.PointerUp,t,{origin:this,mode:"screen",deviceIndex:0,pointerId:e,button:t.button,clientX:t.clientX,clientY:t.clientY,pointerType:t.pointerType,buttonName:this.getButtonName(t),device:this.getAndUpdateSpatialObjectForScreenPosition(e,t.clientX,t.clientY),pressure:t.pressure});this.onUp(i),this._pointerIds[e]=-1,wt&&console.log("ID="+e,"PointerId="+t.pointerId,"ALL:",[...this._pointerIds])});a(this,"onTouchStart",t=>{if(this.context.isInAR)for(let e=0;e<t.changedTouches.length;e++){const i=t.changedTouches[e],n=this.getPointerIndex(i.identifier),o=this.getAndUpdateSpatialObjectForScreenPosition(n,i.clientX,i.clientY),r=new dr(ye.PointerDown,t,{origin:this,mode:"screen",deviceIndex:0,pointerId:n,button:0,clientX:i.clientX,clientY:i.clientY,pointerType:"touch",buttonName:"unknown",device:o,pressure:i.force});this.onDown(r)}});a(this,"onTouchMove",t=>{if(this.context.isInAR)for(let e=0;e<t.changedTouches.length;e++){const i=t.changedTouches[e],n=this.getPointerIndex(i.identifier),o=this.getAndUpdateSpatialObjectForScreenPosition(n,i.clientX,i.clientY),r=new dr(ye.PointerMove,t,{origin:this,mode:"screen",deviceIndex:0,pointerId:n,button:0,clientX:i.clientX,clientY:i.clientY,pointerType:"touch",buttonName:"unknown",device:o,pressure:i.force});this.onMove(r)}});a(this,"onTouchEnd",t=>{if(this.context.isInAR)for(let e=0;e<t.changedTouches.length;e++){const i=t.changedTouches[e],n=this.getPointerIndex(i.identifier),o=new dr(ye.PointerUp,t,{origin:this,mode:"screen",deviceIndex:0,pointerId:n,button:0,clientX:i.clientX,clientY:i.clientY,pointerType:"touch",buttonName:"unknown",device:this.getAndUpdateSpatialObjectForScreenPosition(n,i.clientX,i.clientY),pressure:i.force});this.onUp(o),this._pointerIds[n]=-1}});a(this,"tempNearPlaneVector",new x);a(this,"tempFarPlaneVector",new x);a(this,"tempLookMatrix",new le);this.context=t,this.context.post_render_callbacks.push(this.onEndOfFrame)}addEventListener(t,e,i){if(this._eventListeners[t]||(this._eventListeners[t]=[]),!e||typeof e!="function"){console.error("Invalid call to addEventListener: callback is required and must be a function!");return}i?i={...i}:i={};let n=0;(i==null?void 0:i.queue)!=null&&(n=i.queue);const o=this._eventListeners[t],r=o.find(l=>l.priority===n);r?r.listeners.push({callback:e,options:i}):(o.push({priority:n,listeners:[{callback:e,options:i}]}),o.sort((l,c)=>l.priority-c.priority))}removeEventListener(t,e,i){if(!this._eventListeners[t]||!e)return;const n=this._eventListeners[t];if((i==null?void 0:i.queue)!=null){const o=n.find(l=>l.priority===i.queue);if(!o)return;const r=o.listeners.findIndex(l=>l.callback===e);r>=0&&o.listeners.splice(r,1)}else for(const o of n){const r=o.listeners.findIndex(l=>l.callback===e);r>=0&&o.listeners.splice(r,1)}}dispatchEvent(t){var i,n,o,r;let e=!1;if(t instanceof du){const l=this._eventListeners[t.type];if(l)for(const c of l)for(let h=0;h<c.listeners.length;h++){const d=c.listeners[h];if((n=(i=d.options)==null?void 0:i.signal)!=null&&n.aborted){c.listeners.splice(h,1),h--;continue}d.options.once&&(c.listeners.splice(h,1),h--),d.callback(t)}}if(t instanceof dr){const l=this._eventListeners[t.type];if(l)for(const c of l){if(e)break;for(let h=0;h<c.listeners.length;h++){const d=c.listeners[h];if((r=(o=d.options)==null?void 0:o.signal)!=null&&r.aborted){c.listeners.splice(h,1),h--;continue}if(t.immediatePropagationStopped){e=!0,wt&&console.log("immediatePropagationStopped",t.type);break}else t.propagationStopped&&(e=!0,wt&&console.log("propagationStopped",t.type));d.options.once&&(c.listeners.splice(h,1),h--),d.callback(t)}}}}get mousePosition(){return this._pointerPositions[0]}get mousePositionRC(){return this._pointerPositionsRC[0]}get mouseDown(){return this._pointerDown[0]}get mouseUp(){return this._pointerUp[0]}get mouseClick(){return this._pointerClick[0]}get mouseDoubleClick(){return this._pointerDoubleClick[0]}get mousePressed(){return this._pointerPressed[0]}get mouseWheelChanged(){return this.getMouseWheelChanged(0)}get click(){return this._pointerClick[0]}get doubleClick(){return this._pointerDoubleClick[0]}setCursorPointer(){this.setCursor("pointer")}setCursorNormal(){this.unsetCursor("pointer")}setCursor(t){this._setCursorTypes.push(t),this._setCursorTypes.length>10&&this._setCursorTypes.shift(),this.updateCursor()}unsetCursor(t){for(let e=this._setCursorTypes.length-1;e>=0;e--)if(this._setCursorTypes[e]===t){this._setCursorTypes.splice(e,1),this.updateCursor();break}}updateCursor(){var t;((t=this._setCursorTypes)==null?void 0:t.length)==0?this.context.domElement.style.cursor="default":this.context.domElement.style.cursor=this._setCursorTypes[this._setCursorTypes.length-1]}getIsPointerIdInUse(t){for(const e of this._pointerEventsPressed)if(e.pointerId===t&&e.used)return!0;return!1}getPointerPressedCount(){let t=0;for(let e=0;e<this._pointerPressed.length;e++)this._pointerPressed[e]&&t++;return t}getPointerPosition(t){return t>=this._pointerPositions.length?null:this._pointerPositions[t]}getPointerPositionLastFrame(t){return t>=this._pointerPositionsLastFrame.length?null:this._pointerPositionsLastFrame[t]}getPointerPositionDelta(t){return t>=this._pointerPositionsDelta.length?null:this._pointerPositionsDelta[t]}getPointerPositionRC(t){return t>=this._pointerPositionsRC.length?null:this._pointerPositionsRC[t]}getPointerDown(t){return t>=this._pointerDown.length?!1:this._pointerDown[t]}getPointerUp(t){return t>=this._pointerUp.length?!1:this._pointerUp[t]}getPointerPressed(t){return t>=this._pointerPressed.length?!1:this._pointerPressed[t]}getPointerClicked(t){return t>=this._pointerClick.length?!1:this._pointerClick[t]}getPointerDoubleClicked(t){return t>=this._pointerDoubleClick.length?!1:this._pointerDoubleClick[t]}getPointerDownTime(t){return t>=this._pointerDownTime.length?-1:this._pointerDownTime[t]}getPointerUpTime(t){return t>=this._pointerUpTime.length?-1:this._pointerUpTime[t]}getPointerLongPress(t){return t>=this._pointerDownTime.length?!1:this.getPointerPressed(t)&&this.context.time.time-this._pointerDownTime[t]>this._longPressTimeThreshold}getIsMouse(t){return t<0||t>=this._pointerTypes.length?!1:this._pointerTypes[t]===Sr.Mouse}getIsTouch(t){return t<0||t>=this._pointerTypes.length?!1:this._pointerTypes[t]===Sr.Touch}getTouchesPressedCount(){let t=0;for(let e=0;e<this._pointerPressed.length;e++)this._pointerPressed[e]&&this.getIsTouch(e)&&t++;return t}getMouseWheelChanged(t=0){return t>=this._mouseWheelChanged.length?!1:this._mouseWheelChanged[t]}getMouseWheelDeltaY(t=0){return t>=this._mouseWheelDeltaY.length?0:this._mouseWheelDeltaY[t]}getPointerEvent(t){if(!(t>=this._pointerEvent.length))return this._pointerEvent[t]??void 0}*foreachPointerId(t){for(let e=0;e<this._pointerTypes.length;e++)if(this._pointerIsActive(e)){if(t!==void 0){const i=this._pointerTypes[e];if(Array.isArray(t)){let n=!1;for(const o of t)if(i===o){n=!0;break}if(!n)continue}else if(t!==i)continue}yield e}}*foreachTouchId(){for(let t=0;t<this._pointerTypes.length;t++)this._pointerTypes[t]===Sr.Touch&&this._pointerIsActive[t]&&(yield t)}_pointerIsActive(t){return t<0?!1:this._pointerPressed[t]||this._pointerDown[t]||this._pointerUp[t]}onDownButton(t,e){let i=this._pressedStack.get(t);i||(i=[],this._pressedStack.set(t,i)),i.push(e)}onReleaseButton(t,e){const i=this._pressedStack.get(t);if(!i)return;const n=i.indexOf(e);n>=0&&i.splice(n,1)}getFirstPressedButtonForPointer(t){const e=this._pressedStack.get(t);if(e)return e[0]}getLatestPressedButtonForPointer(t){const e=this._pressedStack.get(t);if(e)return e[e.length-1]}getKeyDown(){for(const t in this.keysPressed){const e=this.keysPressed[t];if(e.startFrame===this.context.time.frameCount)return e.key}return null}getKeyPressed(){for(const t in this.keysPressed){const e=this.keysPressed[t];if(e.pressed)return e.key}return null}isKeyDown(t){var i;if(!this.context.application.isVisible||!this.context.application.hasFocus)return!1;const e=this.getCodeForCommonKeyName(t);if(e!==null){for(const n of e)if(this.isKeyDown(n))return!0;return!1}return((i=this.keysPressed[t])==null?void 0:i.startFrame)===this.context.time.frameCount&&this.keysPressed[t].pressed}isKeyUp(t){var i;if(!this.context.application.isVisible||!this.context.application.hasFocus)return!1;const e=this.getCodeForCommonKeyName(t);if(e!==null){for(const n of e)if(this.isKeyUp(n))return!0;return!1}return((i=this.keysPressed[t])==null?void 0:i.frame)===this.context.time.frameCount&&!this.keysPressed[t].pressed}isKeyPressed(t){var i;if(!this.context.application.isVisible||!this.context.application.hasFocus)return!1;const e=this.getCodeForCommonKeyName(t);if(e!==null){for(const n of e)if(this.isKeyPressed(n))return!0;return!1}return(i=this.keysPressed[t])==null?void 0:i.pressed}getCodeForCommonKeyName(t){if(t.length===1){if(t>="0"&&t<="9")return["Digit"+t];if(t>="a"&&t<="z")return["Key"+t.toUpperCase()];if(t==" ")return["Space"]}switch(t){case"shift":case"Shift":return["ShiftLeft","ShiftRight"];case"control":case"Control":return["ControlLeft","ControlRight"];case"alt":case"Alt":return["AltLeft","AltRight"]}return null}createInputEvent(t){switch(t.type){case ye.PointerDown:wt&&tt("Create Pointer down"),this.onDownButton(t.deviceIndex,t.button),this.onDown(t);break;case ye.PointerMove:wt&&tt("Create Pointer move"),this.onMove(t);break;case ye.PointerUp:wt&&tt("Create Pointer up"),this.onUp(t),this.onReleaseButton(t.deviceIndex,t.button);break}}convertScreenspaceToRaycastSpace(t){return t.x=(t.x-this.context.domX)/this.context.domWidth*2-1,t.y=-((t.y-this.context.domY)/this.context.domHeight)*2+1,t}bindEvents(){this.unbindEvents(),this._htmlEventSource=this.context.renderer.domElement,window.addEventListener("contextmenu",this.onContextMenu),this._htmlEventSource.addEventListener("pointerdown",this.onPointerDown,{passive:!0}),window.addEventListener("pointermove",this.onPointerMove,{passive:!0,capture:!0}),window.addEventListener("pointerup",this.onPointerUp,{passive:!0}),window.addEventListener("pointercancel",this.onPointerCancel,{passive:!0}),window.addEventListener("touchstart",this.onTouchStart,{passive:!0}),window.addEventListener("touchmove",this.onTouchMove,{passive:!0}),window.addEventListener("touchend",this.onTouchEnd,{passive:!0}),this._htmlEventSource.addEventListener("wheel",this.onMouseWheel,{passive:!0}),window.addEventListener("wheel",this.onWheelWindow,{passive:!0}),window.addEventListener("keydown",this.onKeyDown,!1),window.addEventListener("keypress",this.onKeyPressed,!1),window.addEventListener("keyup",this.onKeyUp,!1),window.addEventListener("blur",this.onLostFocus)}unbindEvents(){var t,e;window.removeEventListener("contextmenu",this.onContextMenu),(t=this._htmlEventSource)==null||t.removeEventListener("pointerdown",this.onPointerDown),window.removeEventListener("pointermove",this.onPointerMove),window.removeEventListener("pointerup",this.onPointerUp),window.removeEventListener("pointercancel",this.onPointerCancel),window.removeEventListener("touchstart",this.onTouchStart),window.removeEventListener("touchmove",this.onTouchMove),window.removeEventListener("touchend",this.onTouchEnd),(e=this._htmlEventSource)==null||e.removeEventListener("wheel",this.onMouseWheel,!1),window.removeEventListener("wheel",this.onWheelWindow,!1),window.removeEventListener("keydown",this.onKeyDown,!1),window.removeEventListener("keypress",this.onKeyPressed,!1),window.removeEventListener("keyup",this.onKeyUp,!1),window.removeEventListener("blur",this.onLostFocus)}dispose(){const t=this.context.post_render_callbacks.indexOf(this.onEndOfFrame);t>=0&&this.context.post_render_callbacks.splice(t,1),this.unbindEvents()}canReceiveInput(t){var e;return t.target===((e=this.context.renderer)==null?void 0:e.domElement)||t.target===this.context.domElement||this.context.isInAR||this.context.isInAR&&t.target===document.body&&J.isMozillaXR()?!0:(wt&&console.warn("CanReceiveInput:False for",t.target),!1)}getPointerId(t,e){return t.pointerType==="mouse"?0+(e??t.button):this.getPointerIndex(t.pointerId)}getButtonName(t){const e=t.button;if(t.pointerType==="mouse")switch(e){case 0:return"left";case 1:return"middle";case 2:return"right"}return"unknown"}getAndUpdateSpatialObjectForScreenPosition(t,e,i){let n=this._pointerSpace[t];n||(n=new F,this._pointerSpace[t]=n),this._pointerSpace[t]=n;const o=this.context.mainCamera;if(o){const r=this.tempNearPlaneVector.set(e,i,-1);this.convertScreenspaceToRaycastSpace(r);const l=this.tempFarPlaneVector.set(r.x,r.y,1);r.unproject(o),l.unproject(o);const c=o.worldUp||Q(0,1,0).applyQuaternion(Le(o));this.tempLookMatrix.lookAt(l,r,c),n.position.set(r.x,r.y,r.z),n.quaternion.setFromRotationMatrix(this.tempLookMatrix)}return n}isInRect(t){if(this.context.isInXR)return!0;const e=this.context.domElement.getBoundingClientRect(),i=t.clientX,n=t.clientY,o=i>=e.x&&i<=e.right&&n>=e.y&&n<=e.bottom;return wt&&!o&&console.log("Not in rect",e,i,n),o}onDown(t){const e=t.pointerId;if(this.getPointerPressed(e)&&console.warn(`Received pointerDown for pointerId that is already pressed: ${e}`,wt?t:""),wt&&console.log(t.pointerType,"DOWN",e),!!this.isInRect(t)){for(this.setPointerState(e,this._pointerPressed,!0),this.setPointerState(e,this._pointerDown,!0),this.setPointerStateT(e,this._pointerEvent,t.source);e>=this._pointerTypes.length;)this._pointerTypes.push(t.pointerType);for(this._pointerTypes[e]=t.pointerType;e>=this._pointerPositionDown.length;)this._pointerPositionDown.push(new x);for(this._pointerPositionDown[e].set(t.clientX,t.clientY,t.clientZ??0);e>=this._pointerPositions.length;)this._pointerPositions.push(new ce);this._pointerPositions[e].set(t.clientX,t.clientY),e>=this._pointerDownTime.length&&this._pointerDownTime.push(0),this._pointerDownTime[e]=this.context.time.realtimeSinceStartup,this.updatePointerPosition(t),this._pointerEventsPressed.push(t),this.onDispatchEvent(t)}}onMove(t){const e=t.pointerId,i=this.getPointerPressed(e);i===!1&&!this.isInRect(t)||t.pointerType===Sr.Touch&&!i||(this.updatePointerPosition(t),this.setPointerStateT(e,this._pointerEvent,t.source),this.onDispatchEvent(t))}onUp(t){const e=t.pointerId;if(!this.getPointerPressed(e)){wt&&console.log(t.pointerType,"UP",e,"was not down");return}wt&&console.log(t.pointerType,"UP",e),this.setPointerState(e,this._pointerPressed,!1),this.setPointerStateT(e,this._pointerEvent,t.source),this.setPointerState(e,this._pointerUp,!0),this.updatePointerPosition(t);for(let c=this._pointerEventsPressed.length-1;c>=0;c--)if(this._pointerEventsPressed[c].pointerId===e){this._pointerEventsPressed.splice(c,1);break}if(!this._pointerPositionDown[e]){wt&&Me("Received pointer up event without matching down event for button: "+e),console.warn("Received pointer up event without matching down event for button: "+e);return}const n=this._pointerUpTime[e],o=this._pointerDownTime[e],r=this.context.time.realtimeSinceStartup,l=r-o;if(e>=this._pointerUpTime.length&&this._pointerUpTime.push(-99),this._pointerUpTime[e]=r,l<1){let c=t.clientX-this._pointerPositionDown[e].x,h=t.clientY-this._pointerPositionDown[e].y,d=0;if(t.isSpatial&&t.clientZ!=null&&(d=t.clientZ-this._pointerPositionDown[e].z,c*=200,h*=200,d*=200),Math.abs(c)<5&&Math.abs(h)<5&&Math.abs(d)<5){this.setPointerState(e,this._pointerClick,!0),t.isClick=!0;const u=r-n;wt&&console.log("CLICK",e,c,h,d,u),u<this._doubleClickTimeThreshold&&u>0&&(this.setPointerState(e,this._pointerDoubleClick,!0),t.isDoubleClick=!0)}}this.onDispatchEvent(t)}updatePointerPosition(t){const e=t.pointerId;for(;e>=this._pointerPositions.length;)this._pointerPositions.push(new ce);for(;e>=this._pointerPositionsLastFrame.length;)this._pointerPositionsLastFrame.push(new ce);for(;e>=this._pointerPositionsDelta.length;)this._pointerPositionsDelta.push(new ce);const i=this._pointerPositionsLastFrame[e];i.copy(this._pointerPositions[e]);const n=this._pointerPositionsDelta[e];let o=t.clientX-i.x,r=t.clientY-i.y;if(t.source instanceof MouseEvent||t.source instanceof TouchEvent){const d=t.source;o===0&&d.movementX!==0&&(o=d.movementX||0),r===0&&d.movementY!==0&&(r=d.movementY||0)}n.x+=o,n.y+=r,this._pointerPositions[e].x=t.clientX,this._pointerPositions[e].y=t.clientY;const l=t.clientX,c=t.clientY;for(;e>=this._pointerPositionsRC.length;)this._pointerPositionsRC.push(new ce);const h=this._pointerPositionsRC[e];h.set(l,c),this.convertScreenspaceToRaycastSpace(h)}getPointerIndex(t){let e=-1;for(let i=0;i<this._pointerIds.length;i++){if(this._pointerIds[i]===t)return i;e===-1&&this._pointerIds[i]===-1&&(e=i)}return e!==-1?(this._pointerIds[e]=t,e):(wt&&console.log("PUSH pointerId:",t),this._pointerIds.push(t),this._pointerIds.length-1)}setPointerState(t,e,i){e[t]=i}setPointerStateT(t,e,i){return e[t]=i,i}onDispatchEvent(t){const e=ne.Current;try{ne.Current=this.context,this.dispatchEvent(t)}finally{ne.Current=e}}}const ic=new le().makeRotationY(Math.PI),Sn=new H().setFromAxisAngle(new x(0,1,0),Math.PI),ET=C("debugwebxr");class MT{constructor(){a(this,"priority",-1e5);a(this,"gameObject");if(this.gameObject=new F,this.gameObject.name="Implicit XR Rig",ET){const t=H_(16733661);t.position.y+=.5,this.gameObject.add(t)}}isXRRig(){return!0}get isActive(){return this.gameObject.visible}}const so=C("debugwebxr"),uu=C("debugcustomgesture"),AT="https://cdn.jsdelivr.net/npm/@webxr-input-profiles/assets@1.0/dist/profiles",IT="generic-trigger",DT=new H().setFromEuler(new di(To.degToRad(0),To.degToRad(-90),To.degToRad(-90))),LT=new x(.04,-.04,0);class iS{constructor(t,e,i){a(this,"xr");a(this,"inputSource");a(this,"index",0);a(this,"emitEvents",!0);a(this,"_connected",!0);a(this,"_isTracking",!1);a(this,"__gamepad");a(this,"__hand");a(this,"__side");a(this,"_hitTestSource");a(this,"_hasSelectEvent",!1);a(this,"_isMxInk",!1);a(this,"_isMetaQuestTouchController",!1);a(this,"_handJointPoses",new Map);a(this,"_gripMatrix",new le);a(this,"_gripPosition",new x);a(this,"_gripQuaternion",new H);a(this,"_linearVelocity",new x);a(this,"_rayPositionRaw",new x);a(this,"_rayRotationRaw",new H);a(this,"_rayMatrix",new le);a(this,"_rayPosition",new x);a(this,"_rayQuaternion",new H);a(this,"_gripWorldPosition",new x);a(this,"_gripWorldQuaternion",new H);a(this,"_rayWorldPosition",new x);a(this,"_rayWorldQuaternion",new H);a(this,"_pinchPosition",new x);a(this,"_ray");a(this,"_hand_wristDotUp");a(this,"_object");a(this,"_gripSpaceObject");a(this,"_raySpaceObject");a(this,"model",null);a(this,"_debugAxesHelper",new ln(.15));a(this,"_debugGripAxesHelper",new ln(.07));a(this,"_debugRayAxesHelper",new ln(.07));a(this,"_hitTestSourcePromise",null);a(this,"onPointerHits",t=>{});a(this,"_needleGamepadButtons",{});a(this,"_buttonMap",new Map);a(this,"_motioncontroller");a(this,"_layout");a(this,"getMotionController");a(this,"emitPointerDownEvent",!0);a(this,"emitPointerUpEvent",!0);a(this,"emitPointerMoveEvent",!0);a(this,"pointerMoveDistanceThreshold",.03);a(this,"pointerMoveAngleThreshold",.05);a(this,"_selectButtonIndex");a(this,"_squeezeButtonIndex");a(this,"onSelectStart",t=>{var n,o,r,l;if(!this.emitPointerDownEvent||this.inputSource!==t.inputSource)return;this.onUpdateFrame(t.frame),this._hasSelectEvent=!0;const e=(n=this._layout)==null?void 0:n.selectComponentId,i=(l=(r=(o=this._layout)==null?void 0:o.components[e])==null?void 0:r.gamepadIndices)==null?void 0:l.button;i!==void 0&&(this._selectButtonIndex=i),!uu&&(so&&G.DrawDirection(this.rayWorldPosition,Q(0,.01,1).applyQuaternion(this.rayWorldQuaternion),16711680,10),this.emitPointerEvent(ye.PointerDown,this._selectButtonIndex||0,"xr-standard-trigger",!0,t))});a(this,"onSelectEnd",t=>{this.emitPointerUpEvent&&(uu||this.inputSource===t.inputSource&&this.emitPointerEvent(ye.PointerUp,this._selectButtonIndex||0,"xr-standard-trigger",!0,t))});a(this,"onSequeezeStart",t=>{var e,i,n;this.emitPointerDownEvent&&this.inputSource===t.inputSource&&(this._squeezeButtonIndex=(n=(i=(e=this._layout)==null?void 0:e.components["xr-standard-squeeze"])==null?void 0:i.gamepadIndices)==null?void 0:n.button,this._squeezeButtonIndex!==void 0&&(so&&G.DrawDirection(this.rayWorldPosition,Q(0,.01,1).applyQuaternion(this.rayWorldQuaternion),255,10),this.emitPointerEvent(ye.PointerDown,this._squeezeButtonIndex||0,"xr-standard-squeeze",!0,t)))});a(this,"onSequeezeEnd",t=>{this.emitPointerUpEvent&&this.inputSource===t.inputSource&&this._squeezeButtonIndex!==void 0&&this.emitPointerEvent(ye.PointerUp,this._squeezeButtonIndex||0,"xr-standard-squeeze",!0,t)});a(this,"states",{});a(this,"_didMoveLastFrame",!1);a(this,"_lastPointerMovePosition",new x);a(this,"_lastPointerMoveQuaternion",new H);a(this,"pointerInit");this.xr=t,this.inputSource=e,this.index=i,this._object=new F,this._object.name=`NeedleXRController_${i}`,so&&(this._object.add(this._debugAxesHelper),this._gripSpaceObject=new F,this._raySpaceObject=new F,this._gripSpaceObject.name=`NeedleXRController_${i}_gripSpace`,this._raySpaceObject.name=`NeedleXRController_${i}_raySpace`,this._gripSpaceObject.add(this._debugGripAxesHelper),this._raySpaceObject.add(this._debugRayAxesHelper),this.xr.context.scene.add(this._gripSpaceObject),this.xr.context.scene.add(this._raySpaceObject)),this.xr.context.scene.add(this._object),this._ray=new $r,this.pointerInit={origin:this,pointerType:this.hand?"hand":"controller",deviceIndex:this.index,pointerId:-1,mode:this.inputSource.targetRayMode,ray:this._ray,device:this._object,buttonName:"none"},this.initialize(),this.subscribeEvents()}get context(){return this.xr.context}get connected(){return this._connected}get isTracking(){return this._isTracking}get gamepad(){return this.__gamepad??(this.__gamepad=this.inputSource.gamepad)}get isHand(){return this.hand!=null}get hand(){return this.__hand??(this.__hand=this.inputSource.hand)}get handObject(){return this.context.renderer.xr.getHand(this.index)}get profiles(){return this.inputSource.profiles}get layout(){return this._layout}get targetRayMode(){return this.inputSource.targetRayMode}get targetRaySpace(){return this.inputSource.targetRaySpace}get gripSpace(){return this.inputSource.gripSpace}get side(){return this.__side??(this.__side=this.inputSource.handedness)}get isRight(){return this.side==="right"}get isLeft(){return this.side==="left"}get isStylus(){return this._isMxInk}getHitTestSource(){return this._hitTestSource||this._requestHitTestSource(),this._hitTestSource}get hasHitTestSource(){return this._hitTestSource}cancelHitTestSource(){this._hitTestSource&&(this._hitTestSource.cancel(),this._hitTestSource=void 0)}get hasSelectEvent(){return this._hasSelectEvent}getHitTest(){return this.xr.getHitTest(this)}getHandJointPose(t,e){var n;if(e=e||this.xr.frame,!this.hand||!(e!=null&&e.getJointPose)||!this.xr.referenceSpace)return null;let i=(n=this._handJointPoses)==null?void 0:n.get(t);return i||(i=e.getJointPose(t,this.xr.referenceSpace),i&&this._handJointPoses.set(t,i),i)}get gripPosition(){return Q(this._gripPosition)}get gripQuaternion(){return Os(this._gripQuaternion)}get gripMatrix(){return this._gripMatrix}get gripLinearVelocity(){return Q(this._linearVelocity).applyQuaternion(Sn)}get rayPosition(){return Q(this._rayPosition)}get rayQuaternion(){return Os(this._rayQuaternion)}get gripWorldPosition(){return Q(this._gripWorldPosition)}get gripWorldQuaternion(){return Os(this._gripWorldQuaternion)}get rayWorldPosition(){return Q(this._rayWorldPosition)}updateRayWorldPosition(){var e;const t=(e=this.xr.context.mainCamera)==null?void 0:e.parent;this._rayWorldPosition.copy(this._rayPositionRaw),t&&this._rayWorldPosition.applyMatrix4(t.matrixWorld)}get rayWorldQuaternion(){return Os(this._rayWorldQuaternion)}get pinchPosition(){return Q(this._pinchPosition)}updateRayWorldQuaternion(){var i;const t=(i=this.xr.context.mainCamera)==null?void 0:i.parent,e=t?Le(t):void 0;this._rayWorldQuaternion.copy(this._rayRotationRaw).multiply(Sn),e&&this._rayWorldQuaternion.premultiply(e)}get ray(){return this._ray.origin.copy(this.rayWorldPosition),this._ray.direction.copy(Q(0,0,1).applyQuaternion(this.rayWorldQuaternion)),this._ray}get handWristDotUp(){var e;if(this._hand_wristDotUp!==void 0)return this._hand_wristDotUp;const t=(e=this.handObject)==null?void 0:e.joints.wrist;if(t){const i=Q(0,1,0).applyQuaternion(t.quaternion),n=Q(0,1,0).dot(i);return this._hand_wristDotUp=n}}get isHandUpsideDown(){return this.handWristDotUp!==void 0?this.handWristDotUp<-.7:!1}get isTeleportGesture(){var t;return this.isHandUpsideDown&&((t=this.getGesture("pinch"))==null?void 0:t.isDown)}get object(){return this._object}async getModelUrl(){var t;return(t=this.getMotionController)==null?void 0:t.then(e=>(e==null?void 0:e.assetUrl)||null)}_requestHitTestSource(){var t;return this._hitTestSourcePromise?this._hitTestSourcePromise:this.xr.mode==="immersive-ar"&&this.inputSource.targetRayMode==="tracked-pointer"&&this.xr.session.requestHitTestSourceForTransientInput?this._hitTestSourcePromise=((t=this.xr.session.requestHitTestSourceForTransientInput({profile:this.inputSource.profiles[0],offsetRay:new XRRay}))==null?void 0:t.then(e=>(this._hitTestSourcePromise=null,this.connected?this._hitTestSource=e:(e.cancel(),null))))??null:null}onUpdate(t){performance.mark("NeedleXRController onUpdate start"),this.onUpdateFrame(t),this.updateInputEvents(),this.onUpdateMove(),performance.mark("NeedleXRController onUpdate end"),performance.measure("NeedleXRController onUpdate","NeedleXRController onUpdate start","NeedleXRController onUpdate end")}onRenderDebug(){var o;G.DrawSphere(this.rayWorldPosition,.003),G.DrawDirection(this.rayWorldPosition,Q(0,0,10).applyQuaternion(this.rayWorldQuaternion));const e=(this.inputSource.gripSpace?this.gripWorldPosition:this.object.worldPosition).sub(this.object.worldForward.multiplyScalar(.1)),i=this.inputSource.profiles.join(`
`);let n=`Controller[${this.index}] (${this.inputSource.targetRayMode}, ${this.side})
C:${this.connected?"x":"-"} T:${this.isTracking?"x":"-"} Hand:${this.inputSource.hand?"x":"-"} Pen: ${this._isMxInk?"x":"-"}`;if(this.inputSource.hand&&(n+=`
Pinch: ${(o=this.getGesture("pinch"))==null?void 0:o.value.toFixed(3)}`),n+=`
`+i,n+=`
`+(this.inputSource.targetRaySpace?"Ray: x":"Ray: -")+(this.inputSource.gripSpace?" Grip: x":" Grip: -")+(this.inputSource.gamepad?` Gamepad: ${this.inputSource.gamepad.mapping}`:" Gamepad: -"),this.inputSource.gamepad){const r=this.inputSource.gamepad;let l="[btns "+r.buttons.length+"]: "+r.buttons.map(c=>c.value.toPrecision(1)).join(",");l+=`
[axes `+r.axes.length+"]: "+r.axes.map(c=>c.toPrecision(1)).join(","),n+=`
`+l}G.DrawLabel(e,n,.006)}onUpdateFrame(t){var d,u,f,p,g,y,b,_,v,S,T;if(this._handJointPoses.clear(),this._hand_wristDotUp=void 0,!this.xr.referenceSpace){this._isTracking=!1;return}const e=t.getPose(this.inputSource.targetRaySpace,this.xr.referenceSpace);this._isTracking=e!=null;let i=null,n=null,o=null,r=null;if(e){const O=e.transform;this._rayMatrix.fromArray(O.matrix).premultiply(ic),this._rayMatrix.decompose(this._rayPosition,this._rayQuaternion,Q(1,1,1)),o=Q(O.position),r=Os(O.orientation),this._rayPositionRaw.copy(o),this._rayRotationRaw.copy(r)}if(this.inputSource.gripSpace){const O=t.getPose(this.inputSource.gripSpace,this.xr.referenceSpace);if(O){const M=O.transform;if(i=Q(M.position),n=Os(M.orientation),this._gripMatrix.fromArray(M.matrix).premultiply(ic),this._gripMatrix.decompose(this._gripPosition,this._gripQuaternion,Q(1,1,1)),"linearVelocity"in O&&O.linearVelocity){const k=O.linearVelocity;this._linearVelocity.set(k.x,k.y,k.z)}}}(d=this.xr.context.mainCamera)!=null&&d.parent&&(this._object.parent!==((u=this.xr.context.mainCamera)==null?void 0:u.parent)&&this.xr.context.mainCamera.parent.add(this._object),this._gripSpaceObject!==void 0&&((f=this._gripSpaceObject)==null?void 0:f.parent)!==((p=this.xr.context.mainCamera)==null?void 0:p.parent)&&this.xr.context.mainCamera.parent.add(this._gripSpaceObject),this._raySpaceObject!==void 0&&((g=this._raySpaceObject)==null?void 0:g.parent)!==((y=this.xr.context.mainCamera)==null?void 0:y.parent)&&this.xr.context.mainCamera.parent.add(this._raySpaceObject));const l=this.hand;if(l){let O=!1;const M=l.get("wrist"),k=M&&this.getHandJointPose(M,t);if(k){O=!0;const E=k.transform.position,L=k.transform.orientation;this._object.position.set(E.x,E.y,E.z),this._object.quaternion.set(L.x,L.y,L.z,L.w).multiply(Sn)}O||(this._object.position.copy(this._rayPosition),this._object.quaternion.copy(this._rayQuaternion).multiply(Sn));const B=l.get("middle-finger-metacarpal"),I=B&&this.getHandJointPose(B,t);I&&(this._gripMatrix.fromArray(I.transform.matrix).premultiply(ic),this._gripMatrix.decompose(this._gripPosition,this._gripQuaternion,Q(1,1,1)),i=Q().copy(I.transform.position),n=Os().copy(I.transform.orientation),n.multiply(DT),i.add(Q(LT).applyQuaternion(n)))}else this.inputSource.gripSpace&&this.targetRayMode==="transient-pointer"&&i&&n?(this._object.position.copy(i),this._object.quaternion.copy(n).multiply(Sn)):o&&r&&(this._object.position.copy(o),this._object.quaternion.copy(r).multiply(Sn));so&&(o&&r&&((b=this._raySpaceObject)==null||b.position.copy(o),(_=this._raySpaceObject)==null||_.quaternion.copy(r).multiply(Sn)),i&&n&&((v=this._gripSpaceObject)==null||v.position.copy(i),(S=this._gripSpaceObject)==null||S.quaternion.copy(n).multiply(Sn)));const c=(T=this.xr.context.mainCamera)==null?void 0:T.parent,h=c?Le(c):void 0;i&&n&&(this._gripWorldPosition.copy(i),c&&this._gripWorldPosition.applyMatrix4(c.matrixWorld),this._gripWorldQuaternion.copy(n),this._gripWorldQuaternion.multiply(Sn),h&&this._gripWorldQuaternion.premultiply(h)),this.updateRayWorldPosition(),this.updateRayWorldQuaternion()}onDisconnected(){var t,e,i,n,o,r;this._connected=!1,so&&console.warn("Controller disconnected",this.index);for(const l of this._object.children)this.xr.context.scene.attach(l);(t=this._object)==null||t.removeFromParent(),(e=this._debugAxesHelper)==null||e.removeFromParent(),(i=this._debugGripAxesHelper)==null||i.removeFromParent(),(n=this._debugRayAxesHelper)==null||n.removeFromParent(),(o=this._gripSpaceObject)==null||o.removeFromParent(),(r=this._raySpaceObject)==null||r.removeFromParent(),this.unsubscribeEvents(),this._hitTestSource&&(this._hitTestSource.cancel(),this._hitTestSource=void 0)}getButton(t){var i;if(!this._layout)return;switch(t){case"primary-button":if(this.isLeft)t="x-button";else if(this.isRight)t="a-button";else return;break;case"primary":return this.hand?this.getGesture("pinch"):this.toNeedleGamepadButton(0,t)}if(this._buttonMap.has(t))return this.toNeedleGamepadButton(this._buttonMap.get(t),t);const e=(i=this._layout)==null?void 0:i.components[t];if(e!=null&&e.gamepadIndices)switch(e.type){case"button":case"squeeze":if(this.inputSource.gamepad){const n=e.gamepadIndices.button;return this._buttonMap.set(t,n),this.toNeedleGamepadButton(n,t)}break;default:console.warn("Unsupported component type",e.type);break}this._buttonMap.set(t,void 0)}getGesture(t){const e=this.states[t];if(!e)return null;this.states[t]=e;const i=this._needleGamepadButtons[t]||new I0(void 0,t);return i.pressed=e.pressed,i.value=e.value,i.isDown=e.isDown,i.isUp=e.isUp,this._needleGamepadButtons[t]=i,i}getPointerId(t){if((t==="primary"||t==="pinch")&&(t=0),typeof t!="number"){const e=this._buttonMap.get(t);if(e===void 0)return;t=e}return this.index*10+t}toNeedleGamepadButton(t,e){var r,l;if(!((r=this.inputSource.gamepad)!=null&&r.buttons))return;const i=(l=this.inputSource.gamepad)==null?void 0:l.buttons[t],n=this.states[t],o=this._needleGamepadButtons[t]||new I0(t,e);return i&&(o.pressed=i.pressed,o.value=i.value,o.touched=i.touched),n&&(o.isDown=n.isDown,o.isUp=n.isUp),this._needleGamepadButtons[t]=o,o}getStick(t){var i,n,o,r,l,c,h,d,u;if(!this._layout)return{x:0,y:0,z:0};if(t==="primary"){const f=((i=this.inputSource.gamepad)==null?void 0:i.axes[0])||0,p=((n=this.inputSource.gamepad)==null?void 0:n.axes[1])||0,g=((r=(o=this.inputSource.gamepad)==null?void 0:o.buttons[3])==null?void 0:r.value)||0;return{x:f,y:p,z:g}}const e=(l=this._layout)==null?void 0:l.components[t];if(e!=null&&e.gamepadIndices)switch(e.type){case"thumbstick":if(this.inputSource.gamepad){const f=e.gamepadIndices.xAxis,p=e.gamepadIndices.yAxis;let g=(c=this.inputSource.gamepad)==null?void 0:c.axes[f],y=(h=this.inputSource.gamepad)==null?void 0:h.axes[p];g*=-1,y*=-1;const b=e.gamepadIndices.button,_=(u=(d=this.inputSource.gamepad)==null?void 0:d.buttons[b])==null?void 0:u.value;return{x:g,y,z:_}}}return{x:0,y:0,z:0}}initialize(){if(this._hasSelectEvent=this.profiles.includes("generic-hand-select")||this.profiles.some(t=>t.startsWith("generic-trigger")),this._isMetaQuestTouchController=this.profiles.includes("meta-quest-touch-plus")||this.profiles.includes("oculus-touch-v3"),this._isMxInk=this.profiles.includes("logitech-mx-ink"),!this._layout){if(this.inputSource.targetRayMode==="transient-pointer")return;const t=ST(this.inputSource,AT,IT);this.getMotionController=t.then(e=>{var o;if(!this.connected)return null;this._motioncontroller=new TT(this.inputSource,e.profile,e.assetPath||"");const n=e.profile.layouts[this.inputSource.handedness];if(this._layout=n,this._layout&&!((o=this._layout.gamepad)!=null&&o.length)){this._layout.gamepad=[];for(const r in this._layout.components){const l=this._layout.components[r];this._layout.gamepad[l.gamepadIndices.button]=r}}return this._motioncontroller}).catch(e=>(this.inputSource&&console.warn("Couldn't initialize motion controller profile for ",this.inputSource,e),null))}}subscribeEvents(){this.xr.session.addEventListener("selectstart",this.onSelectStart),this.xr.session.addEventListener("selectend",this.onSelectEnd),this.xr.session.addEventListener("squeezestart",this.onSequeezeStart),this.xr.session.addEventListener("squeezeend",this.onSequeezeEnd)}unsubscribeEvents(){this.xr.session.removeEventListener("selectstart",this.onSelectStart),this.xr.session.removeEventListener("selectend",this.onSelectEnd),this.xr.session.removeEventListener("squeezestart",this.onSequeezeStart),this.xr.session.removeEventListener("squeezeend",this.onSequeezeEnd)}updateInputEvents(){var t,e,i;if((t=this.gamepad)!=null&&t.buttons){for(let n=0;n<this.gamepad.buttons.length;n++){const o=this.gamepad.buttons[n],r=this.states[n]||new A0;let l=null;this._isMxInk&&(n===4||n===5)?(o.value>0&&!r.pressed?(l="pointerdown",r.isDown=!0,r.isUp=!1):o.value===0&&r.pressed?(l="pointerup",r.isDown=!1,r.isUp=!0):r.pressed&&(l="pointermove",r.isDown=!1,r.isUp=!1),r.pressed=o.value>0,r.value=o.value):(o.pressed&&!r.pressed?(l="pointerdown",r.isDown=!0,r.isUp=!1):!o.pressed&&r.pressed?(l="pointerup",r.isDown=!1,r.isUp=!0):(r.isDown=!1,r.isUp=!1),r.pressed=o.pressed,r.value=o.value),this.states[n]=r;const c=n!==this._selectButtonIndex&&n!==this._squeezeButtonIndex;if(l!=null&&c){let h=(e=this._layout)==null?void 0:e.gamepad[n];this._isMxInk&&n===4&&(h="stylus-touch"),this._isMxInk&&n===5&&(h="stylus-tip"),(so||uu)&&console.log("Emitting pointer event",l,n,h,o.value,this.gamepad,this._layout),this.emitPointerEvent(l,n,h??"none",!1,null,o.value)}}if(this._isMetaQuestTouchController){const n=this.gamepad.buttons.length-1,o=this.states[n];if(o&&o.isDown){const r=this.context.menu;r.spatialMenuIsVisible?r.setSpatialMenuVisible(!1):this.context.menu.setSpatialMenuVisible(!0)}}}if(this.hand){const n=this.handObject;if(n){const o=n.joints["index-finger-tip"],r=n.joints["thumb-tip"];if(o&&r){const l=o.position.distanceTo(r.position);this._pinchPosition.lerpVectors(o.position,r.position,.5);const c=(i=this.xr.context.mainCamera)==null?void 0:i.parent;if(c&&this._pinchPosition.applyMatrix4(c.matrixWorld),l!==0){const u=this.states.pinch||new A0,f=(.02+.01)*1.5;u.value=1-(l-.02)/f;const p=l<.02-.01,g=l>.02+.01;p&&!u.pressed?(uu&&console.log("pinch start",l),u.isDown=!0,u.isUp=!1,u.pressed=!0):g&&u.pressed?(u.isDown=!1,u.isUp=!0,u.pressed=!1):(u.isDown=!1,u.isUp=!1),this.states.pinch=u}}}}}onUpdateMove(){var i,n;if(!this.emitPointerMoveEvent)return;let t=!1;if(this._lastPointerMovePosition.distanceTo(this.gripWorldPosition)>this.pointerMoveDistanceThreshold*this.xr.rigScale&&(t=!0),t||this._lastPointerMoveQuaternion.angleTo(this.gripWorldQuaternion)>this.pointerMoveAngleThreshold&&(t=!0),t){this._didMoveLastFrame=!0,this._lastPointerMovePosition.copy(this.gripWorldPosition),this._lastPointerMoveQuaternion.copy(this.gripWorldQuaternion),so&&G.DrawLabel(this.rayWorldPosition.add(this.object.worldForward.multiplyScalar(.1)),"move",.01);let o=this.xr.context.input.getFirstPressedButtonForPointer(this.index);o===void 0&&(o=0);const r=(n=(i=this.gamepad)==null?void 0:i.buttons[o])==null?void 0:n.value;this.emitPointerEvent("pointermove",o,"none",!1,null,r)}else this._didMoveLastFrame=!1}emitPointerEvent(t,e,i,n,o=null,r){if(!this.emitEvents){so&&t!==ye.PointerMove&&console.warn("Pointer events are disabled for this controller",this.index,t,e);return}if(this.xr.mode==="immersive-vr"||this.xr.isPassThrough){this.pointerInit.origin=this,this.pointerInit.pointerId=this.getPointerId(e),this.pointerInit.pointerType=this.hand?"hand":"controller",this.pointerInit.button=e,this.pointerInit.buttonName=i,this.pointerInit.isPrimary=n,this.pointerInit.mode=this.inputSource.targetRayMode,this.pointerInit.ray=this.ray,this.pointerInit.device=this.object,this.pointerInit.pressure=r,this.pointerInit.clientX=this._rayPosition.x/this.xr.rigScale,this.pointerInit.clientY=this._rayPosition.y/this.xr.rigScale,this.pointerInit.clientZ=this._rayPosition.z/this.xr.rigScale;const l=ne.Current;ne.Current=this.xr.context,so&&t!=="pointermove"&&console.warn("Pointer event",t,e,i,{...this.pointerInit}),this.xr.context.input.createInputEvent(new dr(t,o,this.pointerInit)),ne.Current=l}}}class A0{constructor(){a(this,"isDown",!1);a(this,"isUp",!1);a(this,"pressed",!1);a(this,"value",0)}}class I0{constructor(t,e){a(this,"index");a(this,"name");a(this,"touched",!1);a(this,"pressed",!1);a(this,"value",0);a(this,"isDown",!1);a(this,"isUp",!1);this.index=t,this.name=e}}const nc=new Map,Ll=new Map;let D0=0;function qo(s,t,e){if(nc.has(t)||nc.set(t,new Array),nc.get(t).push({method:s,options:{once:!1,...e}}),D0<30){const i=Ll.get(t);i&&(i==null?void 0:i.length)>100&&(D0+=1,console.warn(`You have ${i.length} methods registered for Event ${t}.

This might be a performance issue!
Consider unregistering the methods when they are not needed anymore!

To unregister you can call the function returned by your event hook (e.g.const unregister = onStart(...)) 

or by using the once option like onStart(()=>{}, { once:true }).

See https://engine.needle.tools/docs/scripting.html#special-lifecycle-hooks for more information.`))}}function qr(s,t){const e=Ll.get(t);if(e){for(let n=0;n<e.length;n++)if(e[n].method===s){e.splice(n,1);return}}const i=nc.get(t);if(i){for(let n=0;n<i.length;n++)if(i[n].method===s){i.splice(n,1);return}}}function ps(s,t){t===me.ContextCreated&&_y.delete(s),nS(s,t)}function nS(s,t){t===oe.Start&&nc.get(me.ContextCreated)&&nS(s,me.ContextCreated);const e=t===oe.Start||t===me.ContextCreated,i=Ll.get(t);i&&i.length>0&&j0(s,i,e);const n=nc.get(t);if(n&&n.length>0){const o=[...n];n.length=0,j0(s,o,e),o.length>0&&(Ll.has(t)||Ll.set(t,new Array),Ll.get(t).push(...o))}}const fu=new Array,L0={context:null};function j0(s,t,e){var n,o;fu.length=0;for(let r=0;r<t.length;r++)fu.push(t[r]);let i=_y.get(s);for(let r=0;r<fu.length;r++){const l=fu[r];let c=!0;if(i&&i.has(l)&&(c=!1),c)try{L0.context=s,(n=l.method)==null||n.call(L0,s)}catch(h){console.error("Error in lifecycle method",h)}if((o=l.options)!=null&&o.once){for(let h=0;h<t.length;h++)if(t[h]===l){t.splice(h,1);break}}else e&&(i||(i=new Set,_y.set(s,i)),i.add(l))}}const _y=new WeakMap,Jm=2,Is=4,_o=4,F_=4,mr=new Int32Array(2),B0=new Float32Array(mr.buffer),F0=new Float64Array(mr.buffer),pu=new Uint16Array(new Uint8Array([1,0]).buffer)[0]===1;class Ao{constructor(t,e){this.low=t|0,this.high=e|0}static create(t,e){return t==0&&e==0?Ao.ZERO:new Ao(t,e)}toFloat64(){return(this.low>>>0)+this.high*4294967296}equals(t){return this.low==t.low&&this.high==t.high}}Ao.ZERO=new Ao(0,0);var by;(function(s){s[s.UTF8_BYTES=1]="UTF8_BYTES",s[s.UTF16_STRING=2]="UTF16_STRING"})(by||(by={}));class wd{constructor(t){this.bytes_=t,this.position_=0}static allocate(t){return new wd(new Uint8Array(t))}clear(){this.position_=0}bytes(){return this.bytes_}position(){return this.position_}setPosition(t){this.position_=t}capacity(){return this.bytes_.length}readInt8(t){return this.readUint8(t)<<24>>24}readUint8(t){return this.bytes_[t]}readInt16(t){return this.readUint16(t)<<16>>16}readUint16(t){return this.bytes_[t]|this.bytes_[t+1]<<8}readInt32(t){return this.bytes_[t]|this.bytes_[t+1]<<8|this.bytes_[t+2]<<16|this.bytes_[t+3]<<24}readUint32(t){return this.readInt32(t)>>>0}readInt64(t){return new Ao(this.readInt32(t),this.readInt32(t+4))}readUint64(t){return new Ao(this.readUint32(t),this.readUint32(t+4))}readFloat32(t){return mr[0]=this.readInt32(t),B0[0]}readFloat64(t){return mr[pu?0:1]=this.readInt32(t),mr[pu?1:0]=this.readInt32(t+4),F0[0]}writeInt8(t,e){this.bytes_[t]=e}writeUint8(t,e){this.bytes_[t]=e}writeInt16(t,e){this.bytes_[t]=e,this.bytes_[t+1]=e>>8}writeUint16(t,e){this.bytes_[t]=e,this.bytes_[t+1]=e>>8}writeInt32(t,e){this.bytes_[t]=e,this.bytes_[t+1]=e>>8,this.bytes_[t+2]=e>>16,this.bytes_[t+3]=e>>24}writeUint32(t,e){this.bytes_[t]=e,this.bytes_[t+1]=e>>8,this.bytes_[t+2]=e>>16,this.bytes_[t+3]=e>>24}writeInt64(t,e){this.writeInt32(t,e.low),this.writeInt32(t+4,e.high)}writeUint64(t,e){this.writeUint32(t,e.low),this.writeUint32(t+4,e.high)}writeFloat32(t,e){B0[0]=e,this.writeInt32(t,mr[0])}writeFloat64(t,e){F0[0]=e,this.writeInt32(t,mr[pu?0:1]),this.writeInt32(t+4,mr[pu?1:0])}getBufferIdentifier(){if(this.bytes_.length<this.position_+Is+_o)throw new Error("FlatBuffers: ByteBuffer is too short to contain an identifier.");let t="";for(let e=0;e<_o;e++)t+=String.fromCharCode(this.readInt8(this.position_+Is+e));return t}__offset(t,e){const i=t-this.readInt32(t);return e<this.readInt16(i)?this.readInt16(i+e):0}__union(t,e){return t.bb_pos=e+this.readInt32(e),t.bb=this,t}__string(t,e){t+=this.readInt32(t);const i=this.readInt32(t);let n="",o=0;if(t+=Is,e===by.UTF8_BYTES)return this.bytes_.subarray(t,t+i);for(;o<i;){let r;const l=this.readUint8(t+o++);if(l<192)r=l;else{const c=this.readUint8(t+o++);if(l<224)r=(l&31)<<6|c&63;else{const h=this.readUint8(t+o++);if(l<240)r=(l&15)<<12|(c&63)<<6|h&63;else{const d=this.readUint8(t+o++);r=(l&7)<<18|(c&63)<<12|(h&63)<<6|d&63}}}r<65536?n+=String.fromCharCode(r):(r-=65536,n+=String.fromCharCode((r>>10)+55296,(r&1024-1)+56320))}return n}__union_with_string(t,e){return typeof t=="string"?this.__string(e):this.__union(t,e)}__indirect(t){return t+this.readInt32(t)}__vector(t){return t+this.readInt32(t)+Is}__vector_len(t){return this.readInt32(t+this.readInt32(t))}__has_identifier(t){if(t.length!=_o)throw new Error("FlatBuffers: file identifier must be length "+_o);for(let e=0;e<_o;e++)if(t.charCodeAt(e)!=this.readInt8(this.position()+Is+e))return!1;return!0}createLong(t,e){return Ao.create(t,e)}createScalarList(t,e){const i=[];for(let n=0;n<e;++n)t(n)!==null&&i.push(t(n));return i}createObjList(t,e){const i=[];for(let n=0;n<e;++n){const o=t(n);o!==null&&i.push(o.unpack())}return i}}class jd{constructor(t){this.minalign=1,this.vtable=null,this.vtable_in_use=0,this.isNested=!1,this.object_start=0,this.vtables=[],this.vector_num_elems=0,this.force_defaults=!1,this.string_maps=null;let e;t?e=t:e=1024,this.bb=wd.allocate(e),this.space=e}clear(){this.bb.clear(),this.space=this.bb.capacity(),this.minalign=1,this.vtable=null,this.vtable_in_use=0,this.isNested=!1,this.object_start=0,this.vtables=[],this.vector_num_elems=0,this.force_defaults=!1,this.string_maps=null}forceDefaults(t){this.force_defaults=t}dataBuffer(){return this.bb}asUint8Array(){return this.bb.bytes().subarray(this.bb.position(),this.bb.position()+this.offset())}prep(t,e){t>this.minalign&&(this.minalign=t);const i=~(this.bb.capacity()-this.space+e)+1&t-1;for(;this.space<i+t+e;){const n=this.bb.capacity();this.bb=jd.growByteBuffer(this.bb),this.space+=this.bb.capacity()-n}this.pad(i)}pad(t){for(let e=0;e<t;e++)this.bb.writeInt8(--this.space,0)}writeInt8(t){this.bb.writeInt8(this.space-=1,t)}writeInt16(t){this.bb.writeInt16(this.space-=2,t)}writeInt32(t){this.bb.writeInt32(this.space-=4,t)}writeInt64(t){this.bb.writeInt64(this.space-=8,t)}writeFloat32(t){this.bb.writeFloat32(this.space-=4,t)}writeFloat64(t){this.bb.writeFloat64(this.space-=8,t)}addInt8(t){this.prep(1,0),this.writeInt8(t)}addInt16(t){this.prep(2,0),this.writeInt16(t)}addInt32(t){this.prep(4,0),this.writeInt32(t)}addInt64(t){this.prep(8,0),this.writeInt64(t)}addFloat32(t){this.prep(4,0),this.writeFloat32(t)}addFloat64(t){this.prep(8,0),this.writeFloat64(t)}addFieldInt8(t,e,i){(this.force_defaults||e!=i)&&(this.addInt8(e),this.slot(t))}addFieldInt16(t,e,i){(this.force_defaults||e!=i)&&(this.addInt16(e),this.slot(t))}addFieldInt32(t,e,i){(this.force_defaults||e!=i)&&(this.addInt32(e),this.slot(t))}addFieldInt64(t,e,i){(this.force_defaults||!e.equals(i))&&(this.addInt64(e),this.slot(t))}addFieldFloat32(t,e,i){(this.force_defaults||e!=i)&&(this.addFloat32(e),this.slot(t))}addFieldFloat64(t,e,i){(this.force_defaults||e!=i)&&(this.addFloat64(e),this.slot(t))}addFieldOffset(t,e,i){(this.force_defaults||e!=i)&&(this.addOffset(e),this.slot(t))}addFieldStruct(t,e,i){e!=i&&(this.nested(e),this.slot(t))}nested(t){if(t!=this.offset())throw new Error("FlatBuffers: struct must be serialized inline.")}notNested(){if(this.isNested)throw new Error("FlatBuffers: object serialization must not be nested.")}slot(t){this.vtable!==null&&(this.vtable[t]=this.offset())}offset(){return this.bb.capacity()-this.space}static growByteBuffer(t){const e=t.capacity();if(e&3221225472)throw new Error("FlatBuffers: cannot grow buffer beyond 2 gigabytes.");const i=e<<1,n=wd.allocate(i);return n.setPosition(i-e),n.bytes().set(t.bytes(),i-e),n}addOffset(t){this.prep(Is,0),this.writeInt32(this.offset()-t+Is)}startObject(t){this.notNested(),this.vtable==null&&(this.vtable=[]),this.vtable_in_use=t;for(let e=0;e<t;e++)this.vtable[e]=0;this.isNested=!0,this.object_start=this.offset()}endObject(){if(this.vtable==null||!this.isNested)throw new Error("FlatBuffers: endObject called without startObject");this.addInt32(0);const t=this.offset();let e=this.vtable_in_use-1;for(;e>=0&&this.vtable[e]==0;e--);const i=e+1;for(;e>=0;e--)this.addInt16(this.vtable[e]!=0?t-this.vtable[e]:0);const n=2;this.addInt16(t-this.object_start);const o=(i+n)*Jm;this.addInt16(o);let r=0;const l=this.space;e:for(e=0;e<this.vtables.length;e++){const c=this.bb.capacity()-this.vtables[e];if(o==this.bb.readInt16(c)){for(let h=Jm;h<o;h+=Jm)if(this.bb.readInt16(l+h)!=this.bb.readInt16(c+h))continue e;r=this.vtables[e];break}}return r?(this.space=this.bb.capacity()-t,this.bb.writeInt32(this.space,r-t)):(this.vtables.push(this.offset()),this.bb.writeInt32(this.bb.capacity()-t,this.offset()-t)),this.isNested=!1,t}finish(t,e,i){const n=i?F_:0;if(e){const o=e;if(this.prep(this.minalign,Is+_o+n),o.length!=_o)throw new Error("FlatBuffers: file identifier must be length "+_o);for(let r=_o-1;r>=0;r--)this.writeInt8(o.charCodeAt(r))}this.prep(this.minalign,Is+n),this.addOffset(t),n&&this.addInt32(this.bb.capacity()-this.space),this.bb.setPosition(this.space)}finishSizePrefixed(t,e){this.finish(t,e,!0)}requiredField(t,e){const i=this.bb.capacity()-t,n=i-this.bb.readInt32(i);if(!(this.bb.readInt16(n+e)!=0))throw new Error("FlatBuffers: field "+e+" must be set")}startVector(t,e,i){this.notNested(),this.vector_num_elems=e,this.prep(Is,t*e),this.prep(i,t*e)}endVector(){return this.writeInt32(this.vector_num_elems),this.offset()}createSharedString(t){if(!t)return 0;if(this.string_maps||(this.string_maps=new Map),this.string_maps.has(t))return this.string_maps.get(t);const e=this.createString(t);return this.string_maps.set(t,e),e}createString(t){if(!t)return 0;let e;if(t instanceof Uint8Array)e=t;else{e=[];let i=0;for(;i<t.length;){let n;const o=t.charCodeAt(i++);if(o<55296||o>=56320)n=o;else{const r=t.charCodeAt(i++);n=(o<<10)+r+(65536-56623104-56320)}n<128?e.push(n):(n<2048?e.push(n>>6&31|192):(n<65536?e.push(n>>12&15|224):e.push(n>>18&7|240,n>>12&63|128),e.push(n>>6&63|128)),e.push(n&63|128))}}this.addInt8(0),this.startVector(1,e.length,1),this.bb.setPosition(this.space-=e.length);for(let i=0,n=this.space,o=this.bb.bytes();i<e.length;i++)o[n++]=e[i];return this.endVector()}createLong(t,e){return Ao.create(t,e)}createObjectOffset(t){return t===null?0:typeof t=="string"?this.createString(t):t.pack(this)}createObjectOffsetList(t){const e=[];for(let i=0;i<t.length;++i){const n=t[i];if(n!==null)e.push(this.createObjectOffset(n));else throw new Error("FlatBuffers: Argument for createObjectOffsetList cannot contain null.")}return e}createStructOffsetList(t,e){return e(this,t.length),this.createObjectOffsetList(t),this.endVector()}}const sS={};function oS(s,t){sS[s]=t}function jT(s){const t=s.getBufferIdentifier(),e=sS[t];return e(s)}function BT(s){return typeof s.guid=="function"?s.guid():null}function Lp(s){return s&&s.__esModule&&Object.prototype.hasOwnProperty.call(s,"default")?s.default:s}var rS={exports:{}};(function(s){var t={};t.useBlobBuilder=function(){try{return new Blob([]),!1}catch{return!0}}(),t.useArrayBufferView=!t.useBlobBuilder&&function(){try{return new Blob([new Uint8Array([])]).size===0}catch{return!0}}(),s.exports.binaryFeatures=t;var e=s.exports.BlobBuilder;typeof window<"u"&&(e=s.exports.BlobBuilder=window.WebKitBlobBuilder||window.MozBlobBuilder||window.MSBlobBuilder||window.BlobBuilder);function i(){this._pieces=[],this._parts=[]}i.prototype.append=function(n){typeof n=="number"?this._pieces.push(n):(this.flush(),this._parts.push(n))},i.prototype.flush=function(){if(this._pieces.length>0){var n=new Uint8Array(this._pieces);t.useArrayBufferView||(n=n.buffer),this._parts.push(n),this._pieces=[]}},i.prototype.getBuffer=function(){if(this.flush(),t.useBlobBuilder){for(var n=new e,o=0,r=this._parts.length;o<r;o++)n.append(this._parts[o]);return n.getBlob()}else return new Blob(this._parts)},s.exports.BufferBuilder=i})(rS);var aS=rS.exports,FT=aS.BufferBuilder,z0=aS.binaryFeatures,zT={unpack:function(s){var t=new Kt(s);return t.unpack()},pack:function(s){var t=new Jt;t.pack(s);var e=t.getBuffer();return e}},UT=zT;function Kt(s){this.index=0,this.dataBuffer=s,this.dataView=new Uint8Array(this.dataBuffer),this.length=this.dataBuffer.byteLength}Kt.prototype.unpack=function(){var s=this.unpack_uint8();if(s<128)return s;if((s^224)<32)return(s^224)-32;var t;if((t=s^160)<=15)return this.unpack_raw(t);if((t=s^176)<=15)return this.unpack_string(t);if((t=s^144)<=15)return this.unpack_array(t);if((t=s^128)<=15)return this.unpack_map(t);switch(s){case 192:return null;case 193:return;case 194:return!1;case 195:return!0;case 202:return this.unpack_float();case 203:return this.unpack_double();case 204:return this.unpack_uint8();case 205:return this.unpack_uint16();case 206:return this.unpack_uint32();case 207:return this.unpack_uint64();case 208:return this.unpack_int8();case 209:return this.unpack_int16();case 210:return this.unpack_int32();case 211:return this.unpack_int64();case 212:return;case 213:return;case 214:return;case 215:return;case 216:return t=this.unpack_uint16(),this.unpack_string(t);case 217:return t=this.unpack_uint32(),this.unpack_string(t);case 218:return t=this.unpack_uint16(),this.unpack_raw(t);case 219:return t=this.unpack_uint32(),this.unpack_raw(t);case 220:return t=this.unpack_uint16(),this.unpack_array(t);case 221:return t=this.unpack_uint32(),this.unpack_array(t);case 222:return t=this.unpack_uint16(),this.unpack_map(t);case 223:return t=this.unpack_uint32(),this.unpack_map(t)}};Kt.prototype.unpack_uint8=function(){var s=this.dataView[this.index]&255;return this.index++,s};Kt.prototype.unpack_uint16=function(){var s=this.read(2),t=(s[0]&255)*256+(s[1]&255);return this.index+=2,t};Kt.prototype.unpack_uint32=function(){var s=this.read(4),t=((s[0]*256+s[1])*256+s[2])*256+s[3];return this.index+=4,t};Kt.prototype.unpack_uint64=function(){var s=this.read(8),t=((((((s[0]*256+s[1])*256+s[2])*256+s[3])*256+s[4])*256+s[5])*256+s[6])*256+s[7];return this.index+=8,t};Kt.prototype.unpack_int8=function(){var s=this.unpack_uint8();return s<128?s:s-256};Kt.prototype.unpack_int16=function(){var s=this.unpack_uint16();return s<32768?s:s-65536};Kt.prototype.unpack_int32=function(){var s=this.unpack_uint32();return s<Math.pow(2,31)?s:s-Math.pow(2,32)};Kt.prototype.unpack_int64=function(){var s=this.unpack_uint64();return s<Math.pow(2,63)?s:s-Math.pow(2,64)};Kt.prototype.unpack_raw=function(s){if(this.length<this.index+s)throw new Error("BinaryPackFailure: index is out of range "+this.index+" "+s+" "+this.length);var t=this.dataBuffer.slice(this.index,this.index+s);return this.index+=s,t};Kt.prototype.unpack_string=function(s){for(var t=this.read(s),e=0,i="",n,o;e<s;)n=t[e],n<128?(i+=String.fromCharCode(n),e++):(n^192)<32?(o=(n^192)<<6|t[e+1]&63,i+=String.fromCharCode(o),e+=2):(o=(n&15)<<12|(t[e+1]&63)<<6|t[e+2]&63,i+=String.fromCharCode(o),e+=3);return this.index+=s,i};Kt.prototype.unpack_array=function(s){for(var t=new Array(s),e=0;e<s;e++)t[e]=this.unpack();return t};Kt.prototype.unpack_map=function(s){for(var t={},e=0;e<s;e++){var i=this.unpack(),n=this.unpack();t[i]=n}return t};Kt.prototype.unpack_float=function(){var s=this.unpack_uint32(),t=s>>31,e=(s>>23&255)-127,i=s&8388607|8388608;return(t===0?1:-1)*i*Math.pow(2,e-23)};Kt.prototype.unpack_double=function(){var s=this.unpack_uint32(),t=this.unpack_uint32(),e=s>>31,i=(s>>20&2047)-1023,n=s&1048575|1048576,o=n*Math.pow(2,i-20)+t*Math.pow(2,i-52);return(e===0?1:-1)*o};Kt.prototype.read=function(s){var t=this.index;if(t+s<=this.length)return this.dataView.subarray(t,t+s);throw new Error("BinaryPackFailure: read index out of range")};function Jt(){this.bufferBuilder=new FT}Jt.prototype.getBuffer=function(){return this.bufferBuilder.getBuffer()};Jt.prototype.pack=function(s){var t=typeof s;if(t==="string")this.pack_string(s);else if(t==="number")Math.floor(s)===s?this.pack_integer(s):this.pack_double(s);else if(t==="boolean")s===!0?this.bufferBuilder.append(195):s===!1&&this.bufferBuilder.append(194);else if(t==="undefined")this.bufferBuilder.append(192);else if(t==="object")if(s===null)this.bufferBuilder.append(192);else{var e=s.constructor;if(e==Array)this.pack_array(s);else if(e==Blob||e==File||s instanceof Blob||s instanceof File)this.pack_bin(s);else if(e==ArrayBuffer)z0.useArrayBufferView?this.pack_bin(new Uint8Array(s)):this.pack_bin(s);else if("BYTES_PER_ELEMENT"in s)z0.useArrayBufferView?this.pack_bin(new Uint8Array(s.buffer)):this.pack_bin(s.buffer);else if(e==Object||e.toString().startsWith("class"))this.pack_object(s);else if(e==Date)this.pack_string(s.toString());else if(typeof s.toBinaryPack=="function")this.bufferBuilder.append(s.toBinaryPack());else throw new Error('Type "'+e.toString()+'" not yet supported')}else throw new Error('Type "'+t+'" not yet supported');this.bufferBuilder.flush()};Jt.prototype.pack_bin=function(s){var t=s.length||s.byteLength||s.size;if(t<=15)this.pack_uint8(160+t);else if(t<=65535)this.bufferBuilder.append(218),this.pack_uint16(t);else if(t<=4294967295)this.bufferBuilder.append(219),this.pack_uint32(t);else throw new Error("Invalid length");this.bufferBuilder.append(s)};Jt.prototype.pack_string=function(s){var t=$T(s);if(t<=15)this.pack_uint8(176+t);else if(t<=65535)this.bufferBuilder.append(216),this.pack_uint16(t);else if(t<=4294967295)this.bufferBuilder.append(217),this.pack_uint32(t);else throw new Error("Invalid length");this.bufferBuilder.append(s)};Jt.prototype.pack_array=function(s){var t=s.length;if(t<=15)this.pack_uint8(144+t);else if(t<=65535)this.bufferBuilder.append(220),this.pack_uint16(t);else if(t<=4294967295)this.bufferBuilder.append(221),this.pack_uint32(t);else throw new Error("Invalid length");for(var e=0;e<t;e++)this.pack(s[e])};Jt.prototype.pack_integer=function(s){if(s>=-32&&s<=127)this.bufferBuilder.append(s&255);else if(s>=0&&s<=255)this.bufferBuilder.append(204),this.pack_uint8(s);else if(s>=-128&&s<=127)this.bufferBuilder.append(208),this.pack_int8(s);else if(s>=0&&s<=65535)this.bufferBuilder.append(205),this.pack_uint16(s);else if(s>=-32768&&s<=32767)this.bufferBuilder.append(209),this.pack_int16(s);else if(s>=0&&s<=4294967295)this.bufferBuilder.append(206),this.pack_uint32(s);else if(s>=-2147483648&&s<=2147483647)this.bufferBuilder.append(210),this.pack_int32(s);else if(s>=-9223372036854776e3&&s<=9223372036854776e3)this.bufferBuilder.append(211),this.pack_int64(s);else if(s>=0&&s<=18446744073709552e3)this.bufferBuilder.append(207),this.pack_uint64(s);else throw new Error("Invalid integer")};Jt.prototype.pack_double=function(s){var t=0;s<0&&(t=1,s=-s);var e=Math.floor(Math.log(s)/Math.LN2),i=s/Math.pow(2,e)-1,n=Math.floor(i*Math.pow(2,52)),o=Math.pow(2,32),r=t<<31|e+1023<<20|n/o&1048575,l=n%o;this.bufferBuilder.append(203),this.pack_int32(r),this.pack_int32(l)};Jt.prototype.pack_object=function(s){var t=Object.keys(s),e=t.length;if(e<=15)this.pack_uint8(128+e);else if(e<=65535)this.bufferBuilder.append(222),this.pack_uint16(e);else if(e<=4294967295)this.bufferBuilder.append(223),this.pack_uint32(e);else throw new Error("Invalid length");for(var i in s)s.hasOwnProperty(i)&&(this.pack(i),this.pack(s[i]))};Jt.prototype.pack_uint8=function(s){this.bufferBuilder.append(s)};Jt.prototype.pack_uint16=function(s){this.bufferBuilder.append(s>>8),this.bufferBuilder.append(s&255)};Jt.prototype.pack_uint32=function(s){var t=s&4294967295;this.bufferBuilder.append((t&4278190080)>>>24),this.bufferBuilder.append((t&16711680)>>>16),this.bufferBuilder.append((t&65280)>>>8),this.bufferBuilder.append(t&255)};Jt.prototype.pack_uint64=function(s){var t=s/Math.pow(2,32),e=s%Math.pow(2,32);this.bufferBuilder.append((t&4278190080)>>>24),this.bufferBuilder.append((t&16711680)>>>16),this.bufferBuilder.append((t&65280)>>>8),this.bufferBuilder.append(t&255),this.bufferBuilder.append((e&4278190080)>>>24),this.bufferBuilder.append((e&16711680)>>>16),this.bufferBuilder.append((e&65280)>>>8),this.bufferBuilder.append(e&255)};Jt.prototype.pack_int8=function(s){this.bufferBuilder.append(s&255)};Jt.prototype.pack_int16=function(s){this.bufferBuilder.append((s&65280)>>8),this.bufferBuilder.append(s&255)};Jt.prototype.pack_int32=function(s){this.bufferBuilder.append(s>>>24&255),this.bufferBuilder.append((s&16711680)>>>16),this.bufferBuilder.append((s&65280)>>>8),this.bufferBuilder.append(s&255)};Jt.prototype.pack_int64=function(s){var t=Math.floor(s/Math.pow(2,32)),e=s%Math.pow(2,32);this.bufferBuilder.append((t&4278190080)>>>24),this.bufferBuilder.append((t&16711680)>>>16),this.bufferBuilder.append((t&65280)>>>8),this.bufferBuilder.append(t&255),this.bufferBuilder.append((e&4278190080)>>>24),this.bufferBuilder.append((e&16711680)>>>16),this.bufferBuilder.append((e&65280)>>>8),this.bufferBuilder.append(e&255)};function NT(s){var t=s.charCodeAt(0);return t<=2047?"00":t<=65535?"000":t<=2097151?"0000":t<=67108863?"00000":"000000"}function $T(s){return s.length>600?new Blob([s]).size:s.replace(/[^\u0000-\u007F]/g,NT).length}const U0=Lp(UT);let lS=!0,cS=!0;function Ph(s,t,e){const i=s.match(t);return i&&i.length>=e&&parseInt(i[e],10)}function Mc(s,t,e){if(!s.RTCPeerConnection)return;const i=s.RTCPeerConnection.prototype,n=i.addEventListener;i.addEventListener=function(r,l){if(r!==t)return n.apply(this,arguments);const c=h=>{const d=e(h);d&&(l.handleEvent?l.handleEvent(d):l(d))};return this._eventMap=this._eventMap||{},this._eventMap[t]||(this._eventMap[t]=new Map),this._eventMap[t].set(l,c),n.apply(this,[r,c])};const o=i.removeEventListener;i.removeEventListener=function(r,l){if(r!==t||!this._eventMap||!this._eventMap[t])return o.apply(this,arguments);if(!this._eventMap[t].has(l))return o.apply(this,arguments);const c=this._eventMap[t].get(l);return this._eventMap[t].delete(l),this._eventMap[t].size===0&&delete this._eventMap[t],Object.keys(this._eventMap).length===0&&delete this._eventMap,o.apply(this,[r,c])},Object.defineProperty(i,"on"+t,{get(){return this["_on"+t]},set(r){this["_on"+t]&&(this.removeEventListener(t,this["_on"+t]),delete this["_on"+t]),r&&this.addEventListener(t,this["_on"+t]=r)},enumerable:!0,configurable:!0})}function WT(s){return typeof s!="boolean"?new Error("Argument type: "+typeof s+". Please use a boolean."):(lS=s,s?"adapter.js logging disabled":"adapter.js logging enabled")}function VT(s){return typeof s!="boolean"?new Error("Argument type: "+typeof s+". Please use a boolean."):(cS=!s,"adapter.js deprecation warnings "+(s?"disabled":"enabled"))}function z_(){if(typeof window=="object"){if(lS)return;typeof console<"u"&&typeof console.log=="function"&&console.log.apply(console,arguments)}}function jp(s,t){cS&&console.warn(s+" is deprecated, please use "+t+" instead.")}function HT(s){const t={browser:null,version:null};if(typeof s>"u"||!s.navigator)return t.browser="Not a browser.",t;const{navigator:e}=s;if(e.mozGetUserMedia)t.browser="firefox",t.version=Ph(e.userAgent,/Firefox\/(\d+)\./,1);else if(e.webkitGetUserMedia||s.isSecureContext===!1&&s.webkitRTCPeerConnection&&!s.RTCIceGatherer)t.browser="chrome",t.version=Ph(e.userAgent,/Chrom(e|ium)\/(\d+)\./,2);else if(e.mediaDevices&&e.userAgent.match(/Edge\/(\d+).(\d+)$/))t.browser="edge",t.version=Ph(e.userAgent,/Edge\/(\d+).(\d+)$/,2);else if(s.RTCPeerConnection&&e.userAgent.match(/AppleWebKit\/(\d+)\./))t.browser="safari",t.version=Ph(e.userAgent,/AppleWebKit\/(\d+)\./,1),t.supportsUnifiedPlan=s.RTCRtpTransceiver&&"currentDirection"in s.RTCRtpTransceiver.prototype;else return t.browser="Not a supported browser.",t;return t}function N0(s){return Object.prototype.toString.call(s)==="[object Object]"}function hS(s){return N0(s)?Object.keys(s).reduce(function(t,e){const i=N0(s[e]),n=i?hS(s[e]):s[e],o=i&&!Object.keys(n).length;return n===void 0||o?t:Object.assign(t,{[e]:n})},{}):s}function vy(s,t,e){!t||e.has(t.id)||(e.set(t.id,t),Object.keys(t).forEach(i=>{i.endsWith("Id")?vy(s,s.get(t[i]),e):i.endsWith("Ids")&&t[i].forEach(n=>{vy(s,s.get(n),e)})}))}function $0(s,t,e){const i=e?"outbound-rtp":"inbound-rtp",n=new Map;if(t===null)return n;const o=[];return s.forEach(r=>{r.type==="track"&&r.trackIdentifier===t.id&&o.push(r)}),o.forEach(r=>{s.forEach(l=>{l.type===i&&l.trackId===r.id&&vy(s,l,n)})}),n}const W0=z_;function dS(s,t){const e=s&&s.navigator;if(!e.mediaDevices)return;const i=function(l){if(typeof l!="object"||l.mandatory||l.optional)return l;const c={};return Object.keys(l).forEach(h=>{if(h==="require"||h==="advanced"||h==="mediaSource")return;const d=typeof l[h]=="object"?l[h]:{ideal:l[h]};d.exact!==void 0&&typeof d.exact=="number"&&(d.min=d.max=d.exact);const u=function(f,p){return f?f+p.charAt(0).toUpperCase()+p.slice(1):p==="deviceId"?"sourceId":p};if(d.ideal!==void 0){c.optional=c.optional||[];let f={};typeof d.ideal=="number"?(f[u("min",h)]=d.ideal,c.optional.push(f),f={},f[u("max",h)]=d.ideal,c.optional.push(f)):(f[u("",h)]=d.ideal,c.optional.push(f))}d.exact!==void 0&&typeof d.exact!="number"?(c.mandatory=c.mandatory||{},c.mandatory[u("",h)]=d.exact):["min","max"].forEach(f=>{d[f]!==void 0&&(c.mandatory=c.mandatory||{},c.mandatory[u(f,h)]=d[f])})}),l.advanced&&(c.optional=(c.optional||[]).concat(l.advanced)),c},n=function(l,c){if(t.version>=61)return c(l);if(l=JSON.parse(JSON.stringify(l)),l&&typeof l.audio=="object"){const h=function(d,u,f){u in d&&!(f in d)&&(d[f]=d[u],delete d[u])};l=JSON.parse(JSON.stringify(l)),h(l.audio,"autoGainControl","googAutoGainControl"),h(l.audio,"noiseSuppression","googNoiseSuppression"),l.audio=i(l.audio)}if(l&&typeof l.video=="object"){let h=l.video.facingMode;h=h&&(typeof h=="object"?h:{ideal:h});const d=t.version<66;if(h&&(h.exact==="user"||h.exact==="environment"||h.ideal==="user"||h.ideal==="environment")&&!(e.mediaDevices.getSupportedConstraints&&e.mediaDevices.getSupportedConstraints().facingMode&&!d)){delete l.video.facingMode;let u;if(h.exact==="environment"||h.ideal==="environment"?u=["back","rear"]:(h.exact==="user"||h.ideal==="user")&&(u=["front"]),u)return e.mediaDevices.enumerateDevices().then(f=>{f=f.filter(g=>g.kind==="videoinput");let p=f.find(g=>u.some(y=>g.label.toLowerCase().includes(y)));return!p&&f.length&&u.includes("back")&&(p=f[f.length-1]),p&&(l.video.deviceId=h.exact?{exact:p.deviceId}:{ideal:p.deviceId}),l.video=i(l.video),W0("chrome: "+JSON.stringify(l)),c(l)})}l.video=i(l.video)}return W0("chrome: "+JSON.stringify(l)),c(l)},o=function(l){return t.version>=64?l:{name:{PermissionDeniedError:"NotAllowedError",PermissionDismissedError:"NotAllowedError",InvalidStateError:"NotAllowedError",DevicesNotFoundError:"NotFoundError",ConstraintNotSatisfiedError:"OverconstrainedError",TrackStartError:"NotReadableError",MediaDeviceFailedDueToShutdown:"NotAllowedError",MediaDeviceKillSwitchOn:"NotAllowedError",TabCaptureError:"AbortError",ScreenCaptureError:"AbortError",DeviceCaptureError:"AbortError"}[l.name]||l.name,message:l.message,constraint:l.constraint||l.constraintName,toString(){return this.name+(this.message&&": ")+this.message}}},r=function(l,c,h){n(l,d=>{e.webkitGetUserMedia(d,c,u=>{h&&h(o(u))})})};if(e.getUserMedia=r.bind(e),e.mediaDevices.getUserMedia){const l=e.mediaDevices.getUserMedia.bind(e.mediaDevices);e.mediaDevices.getUserMedia=function(c){return n(c,h=>l(h).then(d=>{if(h.audio&&!d.getAudioTracks().length||h.video&&!d.getVideoTracks().length)throw d.getTracks().forEach(u=>{u.stop()}),new DOMException("","NotFoundError");return d},d=>Promise.reject(o(d))))}}}function GT(s,t){if(!(s.navigator.mediaDevices&&"getDisplayMedia"in s.navigator.mediaDevices)&&s.navigator.mediaDevices){if(typeof t!="function"){console.error("shimGetDisplayMedia: getSourceId argument is not a function");return}s.navigator.mediaDevices.getDisplayMedia=function(i){return t(i).then(n=>{const o=i.video&&i.video.width,r=i.video&&i.video.height,l=i.video&&i.video.frameRate;return i.video={mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:n,maxFrameRate:l||3}},o&&(i.video.mandatory.maxWidth=o),r&&(i.video.mandatory.maxHeight=r),s.navigator.mediaDevices.getUserMedia(i)})}}}function uS(s){s.MediaStream=s.MediaStream||s.webkitMediaStream}function fS(s){if(typeof s=="object"&&s.RTCPeerConnection&&!("ontrack"in s.RTCPeerConnection.prototype)){Object.defineProperty(s.RTCPeerConnection.prototype,"ontrack",{get(){return this._ontrack},set(e){this._ontrack&&this.removeEventListener("track",this._ontrack),this.addEventListener("track",this._ontrack=e)},enumerable:!0,configurable:!0});const t=s.RTCPeerConnection.prototype.setRemoteDescription;s.RTCPeerConnection.prototype.setRemoteDescription=function(){return this._ontrackpoly||(this._ontrackpoly=i=>{i.stream.addEventListener("addtrack",n=>{let o;s.RTCPeerConnection.prototype.getReceivers?o=this.getReceivers().find(l=>l.track&&l.track.id===n.track.id):o={track:n.track};const r=new Event("track");r.track=n.track,r.receiver=o,r.transceiver={receiver:o},r.streams=[i.stream],this.dispatchEvent(r)}),i.stream.getTracks().forEach(n=>{let o;s.RTCPeerConnection.prototype.getReceivers?o=this.getReceivers().find(l=>l.track&&l.track.id===n.id):o={track:n};const r=new Event("track");r.track=n,r.receiver=o,r.transceiver={receiver:o},r.streams=[i.stream],this.dispatchEvent(r)})},this.addEventListener("addstream",this._ontrackpoly)),t.apply(this,arguments)}}else Mc(s,"track",t=>(t.transceiver||Object.defineProperty(t,"transceiver",{value:{receiver:t.receiver}}),t))}function pS(s){if(typeof s=="object"&&s.RTCPeerConnection&&!("getSenders"in s.RTCPeerConnection.prototype)&&"createDTMFSender"in s.RTCPeerConnection.prototype){const t=function(n,o){return{track:o,get dtmf(){return this._dtmf===void 0&&(o.kind==="audio"?this._dtmf=n.createDTMFSender(o):this._dtmf=null),this._dtmf},_pc:n}};if(!s.RTCPeerConnection.prototype.getSenders){s.RTCPeerConnection.prototype.getSenders=function(){return this._senders=this._senders||[],this._senders.slice()};const n=s.RTCPeerConnection.prototype.addTrack;s.RTCPeerConnection.prototype.addTrack=function(l,c){let h=n.apply(this,arguments);return h||(h=t(this,l),this._senders.push(h)),h};const o=s.RTCPeerConnection.prototype.removeTrack;s.RTCPeerConnection.prototype.removeTrack=function(l){o.apply(this,arguments);const c=this._senders.indexOf(l);c!==-1&&this._senders.splice(c,1)}}const e=s.RTCPeerConnection.prototype.addStream;s.RTCPeerConnection.prototype.addStream=function(o){this._senders=this._senders||[],e.apply(this,[o]),o.getTracks().forEach(r=>{this._senders.push(t(this,r))})};const i=s.RTCPeerConnection.prototype.removeStream;s.RTCPeerConnection.prototype.removeStream=function(o){this._senders=this._senders||[],i.apply(this,[o]),o.getTracks().forEach(r=>{const l=this._senders.find(c=>c.track===r);l&&this._senders.splice(this._senders.indexOf(l),1)})}}else if(typeof s=="object"&&s.RTCPeerConnection&&"getSenders"in s.RTCPeerConnection.prototype&&"createDTMFSender"in s.RTCPeerConnection.prototype&&s.RTCRtpSender&&!("dtmf"in s.RTCRtpSender.prototype)){const t=s.RTCPeerConnection.prototype.getSenders;s.RTCPeerConnection.prototype.getSenders=function(){const i=t.apply(this,[]);return i.forEach(n=>n._pc=this),i},Object.defineProperty(s.RTCRtpSender.prototype,"dtmf",{get(){return this._dtmf===void 0&&(this.track.kind==="audio"?this._dtmf=this._pc.createDTMFSender(this.track):this._dtmf=null),this._dtmf}})}}function mS(s){if(!s.RTCPeerConnection)return;const t=s.RTCPeerConnection.prototype.getStats;s.RTCPeerConnection.prototype.getStats=function(){const[i,n,o]=arguments;if(arguments.length>0&&typeof i=="function")return t.apply(this,arguments);if(t.length===0&&(arguments.length===0||typeof i!="function"))return t.apply(this,[]);const r=function(c){const h={};return c.result().forEach(u=>{const f={id:u.id,timestamp:u.timestamp,type:{localcandidate:"local-candidate",remotecandidate:"remote-candidate"}[u.type]||u.type};u.names().forEach(p=>{f[p]=u.stat(p)}),h[f.id]=f}),h},l=function(c){return new Map(Object.keys(c).map(h=>[h,c[h]]))};if(arguments.length>=2){const c=function(h){n(l(r(h)))};return t.apply(this,[c,i])}return new Promise((c,h)=>{t.apply(this,[function(d){c(l(r(d)))},h])}).then(n,o)}}function gS(s){if(!(typeof s=="object"&&s.RTCPeerConnection&&s.RTCRtpSender&&s.RTCRtpReceiver))return;if(!("getStats"in s.RTCRtpSender.prototype)){const e=s.RTCPeerConnection.prototype.getSenders;e&&(s.RTCPeerConnection.prototype.getSenders=function(){const o=e.apply(this,[]);return o.forEach(r=>r._pc=this),o});const i=s.RTCPeerConnection.prototype.addTrack;i&&(s.RTCPeerConnection.prototype.addTrack=function(){const o=i.apply(this,arguments);return o._pc=this,o}),s.RTCRtpSender.prototype.getStats=function(){const o=this;return this._pc.getStats().then(r=>$0(r,o.track,!0))}}if(!("getStats"in s.RTCRtpReceiver.prototype)){const e=s.RTCPeerConnection.prototype.getReceivers;e&&(s.RTCPeerConnection.prototype.getReceivers=function(){const n=e.apply(this,[]);return n.forEach(o=>o._pc=this),n}),Mc(s,"track",i=>(i.receiver._pc=i.srcElement,i)),s.RTCRtpReceiver.prototype.getStats=function(){const n=this;return this._pc.getStats().then(o=>$0(o,n.track,!1))}}if(!("getStats"in s.RTCRtpSender.prototype&&"getStats"in s.RTCRtpReceiver.prototype))return;const t=s.RTCPeerConnection.prototype.getStats;s.RTCPeerConnection.prototype.getStats=function(){if(arguments.length>0&&arguments[0]instanceof s.MediaStreamTrack){const i=arguments[0];let n,o,r;return this.getSenders().forEach(l=>{l.track===i&&(n?r=!0:n=l)}),this.getReceivers().forEach(l=>(l.track===i&&(o?r=!0:o=l),l.track===i)),r||n&&o?Promise.reject(new DOMException("There are more than one sender or receiver for the track.","InvalidAccessError")):n?n.getStats():o?o.getStats():Promise.reject(new DOMException("There is no sender or receiver for the track.","InvalidAccessError"))}return t.apply(this,arguments)}}function yS(s){s.RTCPeerConnection.prototype.getLocalStreams=function(){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},Object.keys(this._shimmedLocalStreams).map(r=>this._shimmedLocalStreams[r][0])};const t=s.RTCPeerConnection.prototype.addTrack;s.RTCPeerConnection.prototype.addTrack=function(r,l){if(!l)return t.apply(this,arguments);this._shimmedLocalStreams=this._shimmedLocalStreams||{};const c=t.apply(this,arguments);return this._shimmedLocalStreams[l.id]?this._shimmedLocalStreams[l.id].indexOf(c)===-1&&this._shimmedLocalStreams[l.id].push(c):this._shimmedLocalStreams[l.id]=[l,c],c};const e=s.RTCPeerConnection.prototype.addStream;s.RTCPeerConnection.prototype.addStream=function(r){this._shimmedLocalStreams=this._shimmedLocalStreams||{},r.getTracks().forEach(h=>{if(this.getSenders().find(u=>u.track===h))throw new DOMException("Track already exists.","InvalidAccessError")});const l=this.getSenders();e.apply(this,arguments);const c=this.getSenders().filter(h=>l.indexOf(h)===-1);this._shimmedLocalStreams[r.id]=[r].concat(c)};const i=s.RTCPeerConnection.prototype.removeStream;s.RTCPeerConnection.prototype.removeStream=function(r){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},delete this._shimmedLocalStreams[r.id],i.apply(this,arguments)};const n=s.RTCPeerConnection.prototype.removeTrack;s.RTCPeerConnection.prototype.removeTrack=function(r){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},r&&Object.keys(this._shimmedLocalStreams).forEach(l=>{const c=this._shimmedLocalStreams[l].indexOf(r);c!==-1&&this._shimmedLocalStreams[l].splice(c,1),this._shimmedLocalStreams[l].length===1&&delete this._shimmedLocalStreams[l]}),n.apply(this,arguments)}}function _S(s,t){if(!s.RTCPeerConnection)return;if(s.RTCPeerConnection.prototype.addTrack&&t.version>=65)return yS(s);const e=s.RTCPeerConnection.prototype.getLocalStreams;s.RTCPeerConnection.prototype.getLocalStreams=function(){const d=e.apply(this);return this._reverseStreams=this._reverseStreams||{},d.map(u=>this._reverseStreams[u.id])};const i=s.RTCPeerConnection.prototype.addStream;s.RTCPeerConnection.prototype.addStream=function(d){if(this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},d.getTracks().forEach(u=>{if(this.getSenders().find(p=>p.track===u))throw new DOMException("Track already exists.","InvalidAccessError")}),!this._reverseStreams[d.id]){const u=new s.MediaStream(d.getTracks());this._streams[d.id]=u,this._reverseStreams[u.id]=d,d=u}i.apply(this,[d])};const n=s.RTCPeerConnection.prototype.removeStream;s.RTCPeerConnection.prototype.removeStream=function(d){this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},n.apply(this,[this._streams[d.id]||d]),delete this._reverseStreams[this._streams[d.id]?this._streams[d.id].id:d.id],delete this._streams[d.id]},s.RTCPeerConnection.prototype.addTrack=function(d,u){if(this.signalingState==="closed")throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");const f=[].slice.call(arguments,1);if(f.length!==1||!f[0].getTracks().find(y=>y===d))throw new DOMException("The adapter.js addTrack polyfill only supports a single  stream which is associated with the specified track.","NotSupportedError");if(this.getSenders().find(y=>y.track===d))throw new DOMException("Track already exists.","InvalidAccessError");this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{};const g=this._streams[u.id];if(g)g.addTrack(d),Promise.resolve().then(()=>{this.dispatchEvent(new Event("negotiationneeded"))});else{const y=new s.MediaStream([d]);this._streams[u.id]=y,this._reverseStreams[y.id]=u,this.addStream(y)}return this.getSenders().find(y=>y.track===d)};function o(h,d){let u=d.sdp;return Object.keys(h._reverseStreams||[]).forEach(f=>{const p=h._reverseStreams[f],g=h._streams[p.id];u=u.replace(new RegExp(g.id,"g"),p.id)}),new RTCSessionDescription({type:d.type,sdp:u})}function r(h,d){let u=d.sdp;return Object.keys(h._reverseStreams||[]).forEach(f=>{const p=h._reverseStreams[f],g=h._streams[p.id];u=u.replace(new RegExp(p.id,"g"),g.id)}),new RTCSessionDescription({type:d.type,sdp:u})}["createOffer","createAnswer"].forEach(function(h){const d=s.RTCPeerConnection.prototype[h],u={[h](){const f=arguments;return arguments.length&&typeof arguments[0]=="function"?d.apply(this,[g=>{const y=o(this,g);f[0].apply(null,[y])},g=>{f[1]&&f[1].apply(null,g)},arguments[2]]):d.apply(this,arguments).then(g=>o(this,g))}};s.RTCPeerConnection.prototype[h]=u[h]});const l=s.RTCPeerConnection.prototype.setLocalDescription;s.RTCPeerConnection.prototype.setLocalDescription=function(){return!arguments.length||!arguments[0].type?l.apply(this,arguments):(arguments[0]=r(this,arguments[0]),l.apply(this,arguments))};const c=Object.getOwnPropertyDescriptor(s.RTCPeerConnection.prototype,"localDescription");Object.defineProperty(s.RTCPeerConnection.prototype,"localDescription",{get(){const h=c.get.apply(this);return h.type===""?h:o(this,h)}}),s.RTCPeerConnection.prototype.removeTrack=function(d){if(this.signalingState==="closed")throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");if(!d._pc)throw new DOMException("Argument 1 of RTCPeerConnection.removeTrack does not implement interface RTCRtpSender.","TypeError");if(!(d._pc===this))throw new DOMException("Sender was not created by this connection.","InvalidAccessError");this._streams=this._streams||{};let f;Object.keys(this._streams).forEach(p=>{this._streams[p].getTracks().find(y=>d.track===y)&&(f=this._streams[p])}),f&&(f.getTracks().length===1?this.removeStream(this._reverseStreams[f.id]):f.removeTrack(d.track),this.dispatchEvent(new Event("negotiationneeded")))}}function xy(s,t){!s.RTCPeerConnection&&s.webkitRTCPeerConnection&&(s.RTCPeerConnection=s.webkitRTCPeerConnection),s.RTCPeerConnection&&t.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(e){const i=s.RTCPeerConnection.prototype[e],n={[e](){return arguments[0]=new(e==="addIceCandidate"?s.RTCIceCandidate:s.RTCSessionDescription)(arguments[0]),i.apply(this,arguments)}};s.RTCPeerConnection.prototype[e]=n[e]})}function bS(s,t){Mc(s,"negotiationneeded",e=>{const i=e.target;if(!((t.version<72||i.getConfiguration&&i.getConfiguration().sdpSemantics==="plan-b")&&i.signalingState!=="stable"))return e})}const V0=Object.freeze(Object.defineProperty({__proto__:null,fixNegotiationNeeded:bS,shimAddTrackRemoveTrack:_S,shimAddTrackRemoveTrackWithNative:yS,shimGetDisplayMedia:GT,shimGetSendersWithDtmf:pS,shimGetStats:mS,shimGetUserMedia:dS,shimMediaStream:uS,shimOnTrack:fS,shimPeerConnection:xy,shimSenderReceiverGetStats:gS},Symbol.toStringTag,{value:"Module"}));function qT(s,t){let e=!1;return s=JSON.parse(JSON.stringify(s)),s.filter(i=>{if(i&&(i.urls||i.url)){let n=i.urls||i.url;i.url&&!i.urls&&jp("RTCIceServer.url","RTCIceServer.urls");const o=typeof n=="string";return o&&(n=[n]),n=n.filter(r=>{if(r.indexOf("stun:")===0)return!1;const l=r.startsWith("turn")&&!r.startsWith("turn:[")&&r.includes("transport=udp");return l&&!e?(e=!0,!0):l&&!e}),delete i.url,i.urls=o?n[0]:n,!!n.length}})}var vS={exports:{}};(function(s){var t={};t.generateIdentifier=function(){return Math.random().toString(36).substr(2,10)},t.localCName=t.generateIdentifier(),t.splitLines=function(e){return e.trim().split(`
`).map(function(i){return i.trim()})},t.splitSections=function(e){var i=e.split(`
m=`);return i.map(function(n,o){return(o>0?"m="+n:n).trim()+`\r
`})},t.getDescription=function(e){var i=t.splitSections(e);return i&&i[0]},t.getMediaSections=function(e){var i=t.splitSections(e);return i.shift(),i},t.matchPrefix=function(e,i){return t.splitLines(e).filter(function(n){return n.indexOf(i)===0})},t.parseCandidate=function(e){var i;e.indexOf("a=candidate:")===0?i=e.substring(12).split(" "):i=e.substring(10).split(" ");for(var n={foundation:i[0],component:parseInt(i[1],10),protocol:i[2].toLowerCase(),priority:parseInt(i[3],10),ip:i[4],address:i[4],port:parseInt(i[5],10),type:i[7]},o=8;o<i.length;o+=2)switch(i[o]){case"raddr":n.relatedAddress=i[o+1];break;case"rport":n.relatedPort=parseInt(i[o+1],10);break;case"tcptype":n.tcpType=i[o+1];break;case"ufrag":n.ufrag=i[o+1],n.usernameFragment=i[o+1];break;default:n[i[o]]=i[o+1];break}return n},t.writeCandidate=function(e){var i=[];i.push(e.foundation),i.push(e.component),i.push(e.protocol.toUpperCase()),i.push(e.priority),i.push(e.address||e.ip),i.push(e.port);var n=e.type;return i.push("typ"),i.push(n),n!=="host"&&e.relatedAddress&&e.relatedPort&&(i.push("raddr"),i.push(e.relatedAddress),i.push("rport"),i.push(e.relatedPort)),e.tcpType&&e.protocol.toLowerCase()==="tcp"&&(i.push("tcptype"),i.push(e.tcpType)),(e.usernameFragment||e.ufrag)&&(i.push("ufrag"),i.push(e.usernameFragment||e.ufrag)),"candidate:"+i.join(" ")},t.parseIceOptions=function(e){return e.substr(14).split(" ")},t.parseRtpMap=function(e){var i=e.substr(9).split(" "),n={payloadType:parseInt(i.shift(),10)};return i=i[0].split("/"),n.name=i[0],n.clockRate=parseInt(i[1],10),n.channels=i.length===3?parseInt(i[2],10):1,n.numChannels=n.channels,n},t.writeRtpMap=function(e){var i=e.payloadType;e.preferredPayloadType!==void 0&&(i=e.preferredPayloadType);var n=e.channels||e.numChannels||1;return"a=rtpmap:"+i+" "+e.name+"/"+e.clockRate+(n!==1?"/"+n:"")+`\r
`},t.parseExtmap=function(e){var i=e.substr(9).split(" ");return{id:parseInt(i[0],10),direction:i[0].indexOf("/")>0?i[0].split("/")[1]:"sendrecv",uri:i[1]}},t.writeExtmap=function(e){return"a=extmap:"+(e.id||e.preferredId)+(e.direction&&e.direction!=="sendrecv"?"/"+e.direction:"")+" "+e.uri+`\r
`},t.parseFmtp=function(e){for(var i={},n,o=e.substr(e.indexOf(" ")+1).split(";"),r=0;r<o.length;r++)n=o[r].trim().split("="),i[n[0].trim()]=n[1];return i},t.writeFmtp=function(e){var i="",n=e.payloadType;if(e.preferredPayloadType!==void 0&&(n=e.preferredPayloadType),e.parameters&&Object.keys(e.parameters).length){var o=[];Object.keys(e.parameters).forEach(function(r){e.parameters[r]?o.push(r+"="+e.parameters[r]):o.push(r)}),i+="a=fmtp:"+n+" "+o.join(";")+`\r
`}return i},t.parseRtcpFb=function(e){var i=e.substr(e.indexOf(" ")+1).split(" ");return{type:i.shift(),parameter:i.join(" ")}},t.writeRtcpFb=function(e){var i="",n=e.payloadType;return e.preferredPayloadType!==void 0&&(n=e.preferredPayloadType),e.rtcpFeedback&&e.rtcpFeedback.length&&e.rtcpFeedback.forEach(function(o){i+="a=rtcp-fb:"+n+" "+o.type+(o.parameter&&o.parameter.length?" "+o.parameter:"")+`\r
`}),i},t.parseSsrcMedia=function(e){var i=e.indexOf(" "),n={ssrc:parseInt(e.substr(7,i-7),10)},o=e.indexOf(":",i);return o>-1?(n.attribute=e.substr(i+1,o-i-1),n.value=e.substr(o+1)):n.attribute=e.substr(i+1),n},t.parseSsrcGroup=function(e){var i=e.substr(13).split(" ");return{semantics:i.shift(),ssrcs:i.map(function(n){return parseInt(n,10)})}},t.getMid=function(e){var i=t.matchPrefix(e,"a=mid:")[0];if(i)return i.substr(6)},t.parseFingerprint=function(e){var i=e.substr(14).split(" ");return{algorithm:i[0].toLowerCase(),value:i[1]}},t.getDtlsParameters=function(e,i){var n=t.matchPrefix(e+i,"a=fingerprint:");return{role:"auto",fingerprints:n.map(t.parseFingerprint)}},t.writeDtlsParameters=function(e,i){var n="a=setup:"+i+`\r
`;return e.fingerprints.forEach(function(o){n+="a=fingerprint:"+o.algorithm+" "+o.value+`\r
`}),n},t.parseCryptoLine=function(e){var i=e.substr(9).split(" ");return{tag:parseInt(i[0],10),cryptoSuite:i[1],keyParams:i[2],sessionParams:i.slice(3)}},t.writeCryptoLine=function(e){return"a=crypto:"+e.tag+" "+e.cryptoSuite+" "+(typeof e.keyParams=="object"?t.writeCryptoKeyParams(e.keyParams):e.keyParams)+(e.sessionParams?" "+e.sessionParams.join(" "):"")+`\r
`},t.parseCryptoKeyParams=function(e){if(e.indexOf("inline:")!==0)return null;var i=e.substr(7).split("|");return{keyMethod:"inline",keySalt:i[0],lifeTime:i[1],mkiValue:i[2]?i[2].split(":")[0]:void 0,mkiLength:i[2]?i[2].split(":")[1]:void 0}},t.writeCryptoKeyParams=function(e){return e.keyMethod+":"+e.keySalt+(e.lifeTime?"|"+e.lifeTime:"")+(e.mkiValue&&e.mkiLength?"|"+e.mkiValue+":"+e.mkiLength:"")},t.getCryptoParameters=function(e,i){var n=t.matchPrefix(e+i,"a=crypto:");return n.map(t.parseCryptoLine)},t.getIceParameters=function(e,i){var n=t.matchPrefix(e+i,"a=ice-ufrag:")[0],o=t.matchPrefix(e+i,"a=ice-pwd:")[0];return n&&o?{usernameFragment:n.substr(12),password:o.substr(10)}:null},t.writeIceParameters=function(e){return"a=ice-ufrag:"+e.usernameFragment+`\r
a=ice-pwd:`+e.password+`\r
`},t.parseRtpParameters=function(e){for(var i={codecs:[],headerExtensions:[],fecMechanisms:[],rtcp:[]},n=t.splitLines(e),o=n[0].split(" "),r=3;r<o.length;r++){var l=o[r],c=t.matchPrefix(e,"a=rtpmap:"+l+" ")[0];if(c){var h=t.parseRtpMap(c),d=t.matchPrefix(e,"a=fmtp:"+l+" ");switch(h.parameters=d.length?t.parseFmtp(d[0]):{},h.rtcpFeedback=t.matchPrefix(e,"a=rtcp-fb:"+l+" ").map(t.parseRtcpFb),i.codecs.push(h),h.name.toUpperCase()){case"RED":case"ULPFEC":i.fecMechanisms.push(h.name.toUpperCase());break}}}return t.matchPrefix(e,"a=extmap:").forEach(function(u){i.headerExtensions.push(t.parseExtmap(u))}),i},t.writeRtpDescription=function(e,i){var n="";n+="m="+e+" ",n+=i.codecs.length>0?"9":"0",n+=" UDP/TLS/RTP/SAVPF ",n+=i.codecs.map(function(r){return r.preferredPayloadType!==void 0?r.preferredPayloadType:r.payloadType}).join(" ")+`\r
`,n+=`c=IN IP4 0.0.0.0\r
`,n+=`a=rtcp:9 IN IP4 0.0.0.0\r
`,i.codecs.forEach(function(r){n+=t.writeRtpMap(r),n+=t.writeFmtp(r),n+=t.writeRtcpFb(r)});var o=0;return i.codecs.forEach(function(r){r.maxptime>o&&(o=r.maxptime)}),o>0&&(n+="a=maxptime:"+o+`\r
`),n+=`a=rtcp-mux\r
`,i.headerExtensions&&i.headerExtensions.forEach(function(r){n+=t.writeExtmap(r)}),n},t.parseRtpEncodingParameters=function(e){var i=[],n=t.parseRtpParameters(e),o=n.fecMechanisms.indexOf("RED")!==-1,r=n.fecMechanisms.indexOf("ULPFEC")!==-1,l=t.matchPrefix(e,"a=ssrc:").map(function(f){return t.parseSsrcMedia(f)}).filter(function(f){return f.attribute==="cname"}),c=l.length>0&&l[0].ssrc,h,d=t.matchPrefix(e,"a=ssrc-group:FID").map(function(f){var p=f.substr(17).split(" ");return p.map(function(g){return parseInt(g,10)})});d.length>0&&d[0].length>1&&d[0][0]===c&&(h=d[0][1]),n.codecs.forEach(function(f){if(f.name.toUpperCase()==="RTX"&&f.parameters.apt){var p={ssrc:c,codecPayloadType:parseInt(f.parameters.apt,10)};c&&h&&(p.rtx={ssrc:h}),i.push(p),o&&(p=JSON.parse(JSON.stringify(p)),p.fec={ssrc:c,mechanism:r?"red+ulpfec":"red"},i.push(p))}}),i.length===0&&c&&i.push({ssrc:c});var u=t.matchPrefix(e,"b=");return u.length&&(u[0].indexOf("b=TIAS:")===0?u=parseInt(u[0].substr(7),10):u[0].indexOf("b=AS:")===0?u=parseInt(u[0].substr(5),10)*1e3*.95-50*40*8:u=void 0,i.forEach(function(f){f.maxBitrate=u})),i},t.parseRtcpParameters=function(e){var i={},n=t.matchPrefix(e,"a=ssrc:").map(function(l){return t.parseSsrcMedia(l)}).filter(function(l){return l.attribute==="cname"})[0];n&&(i.cname=n.value,i.ssrc=n.ssrc);var o=t.matchPrefix(e,"a=rtcp-rsize");i.reducedSize=o.length>0,i.compound=o.length===0;var r=t.matchPrefix(e,"a=rtcp-mux");return i.mux=r.length>0,i},t.parseMsid=function(e){var i,n=t.matchPrefix(e,"a=msid:");if(n.length===1)return i=n[0].substr(7).split(" "),{stream:i[0],track:i[1]};var o=t.matchPrefix(e,"a=ssrc:").map(function(r){return t.parseSsrcMedia(r)}).filter(function(r){return r.attribute==="msid"});if(o.length>0)return i=o[0].value.split(" "),{stream:i[0],track:i[1]}},t.parseSctpDescription=function(e){var i=t.parseMLine(e),n=t.matchPrefix(e,"a=max-message-size:"),o;n.length>0&&(o=parseInt(n[0].substr(19),10)),isNaN(o)&&(o=65536);var r=t.matchPrefix(e,"a=sctp-port:");if(r.length>0)return{port:parseInt(r[0].substr(12),10),protocol:i.fmt,maxMessageSize:o};var l=t.matchPrefix(e,"a=sctpmap:");if(l.length>0){var c=t.matchPrefix(e,"a=sctpmap:")[0].substr(10).split(" ");return{port:parseInt(c[0],10),protocol:c[1],maxMessageSize:o}}},t.writeSctpDescription=function(e,i){var n=[];return e.protocol!=="DTLS/SCTP"?n=["m="+e.kind+" 9 "+e.protocol+" "+i.protocol+`\r
`,`c=IN IP4 0.0.0.0\r
`,"a=sctp-port:"+i.port+`\r
`]:n=["m="+e.kind+" 9 "+e.protocol+" "+i.port+`\r
`,`c=IN IP4 0.0.0.0\r
`,"a=sctpmap:"+i.port+" "+i.protocol+` 65535\r
`],i.maxMessageSize!==void 0&&n.push("a=max-message-size:"+i.maxMessageSize+`\r
`),n.join("")},t.generateSessionId=function(){return Math.random().toString().substr(2,21)},t.writeSessionBoilerplate=function(e,i,n){var o,r=i!==void 0?i:2;e?o=e:o=t.generateSessionId();var l=n||"thisisadapterortc";return`v=0\r
o=`+l+" "+o+" "+r+` IN IP4 127.0.0.1\r
s=-\r
t=0 0\r
`},t.writeMediaSection=function(e,i,n,o){var r=t.writeRtpDescription(e.kind,i);if(r+=t.writeIceParameters(e.iceGatherer.getLocalParameters()),r+=t.writeDtlsParameters(e.dtlsTransport.getLocalParameters(),n==="offer"?"actpass":"active"),r+="a=mid:"+e.mid+`\r
`,e.direction?r+="a="+e.direction+`\r
`:e.rtpSender&&e.rtpReceiver?r+=`a=sendrecv\r
`:e.rtpSender?r+=`a=sendonly\r
`:e.rtpReceiver?r+=`a=recvonly\r
`:r+=`a=inactive\r
`,e.rtpSender){var l="msid:"+o.id+" "+e.rtpSender.track.id+`\r
`;r+="a="+l,r+="a=ssrc:"+e.sendEncodingParameters[0].ssrc+" "+l,e.sendEncodingParameters[0].rtx&&(r+="a=ssrc:"+e.sendEncodingParameters[0].rtx.ssrc+" "+l,r+="a=ssrc-group:FID "+e.sendEncodingParameters[0].ssrc+" "+e.sendEncodingParameters[0].rtx.ssrc+`\r
`)}return r+="a=ssrc:"+e.sendEncodingParameters[0].ssrc+" cname:"+t.localCName+`\r
`,e.rtpSender&&e.sendEncodingParameters[0].rtx&&(r+="a=ssrc:"+e.sendEncodingParameters[0].rtx.ssrc+" cname:"+t.localCName+`\r
`),r},t.getDirection=function(e,i){for(var n=t.splitLines(e),o=0;o<n.length;o++)switch(n[o]){case"a=sendrecv":case"a=sendonly":case"a=recvonly":case"a=inactive":return n[o].substr(2)}return i?t.getDirection(i):"sendrecv"},t.getKind=function(e){var i=t.splitLines(e),n=i[0].split(" ");return n[0].substr(2)},t.isRejected=function(e){return e.split(" ",2)[1]==="0"},t.parseMLine=function(e){var i=t.splitLines(e),n=i[0].substr(2).split(" ");return{kind:n[0],port:parseInt(n[1],10),protocol:n[2],fmt:n.slice(3).join(" ")}},t.parseOLine=function(e){var i=t.matchPrefix(e,"o=")[0],n=i.substr(2).split(" ");return{username:n[0],sessionId:n[1],sessionVersion:parseInt(n[2],10),netType:n[3],addressType:n[4],address:n[5]}},t.isValidSDP=function(e){if(typeof e!="string"||e.length===0)return!1;for(var i=t.splitLines(e),n=0;n<i.length;n++)if(i[n].length<2||i[n].charAt(1)!=="=")return!1;return!0},s.exports=t})(vS);var xS=vS.exports;const Ku=Lp(xS);var re=xS;function XT(s){return{inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"}[s.type]||s.type}function H0(s,t,e,i,n){var o=re.writeRtpDescription(s.kind,t);if(o+=re.writeIceParameters(s.iceGatherer.getLocalParameters()),o+=re.writeDtlsParameters(s.dtlsTransport.getLocalParameters(),e==="offer"?"actpass":n||"active"),o+="a=mid:"+s.mid+`\r
`,s.rtpSender&&s.rtpReceiver?o+=`a=sendrecv\r
`:s.rtpSender?o+=`a=sendonly\r
`:s.rtpReceiver?o+=`a=recvonly\r
`:o+=`a=inactive\r
`,s.rtpSender){var r=s.rtpSender._initialTrackId||s.rtpSender.track.id;s.rtpSender._initialTrackId=r;var l="msid:"+(i?i.id:"-")+" "+r+`\r
`;o+="a="+l,o+="a=ssrc:"+s.sendEncodingParameters[0].ssrc+" "+l,s.sendEncodingParameters[0].rtx&&(o+="a=ssrc:"+s.sendEncodingParameters[0].rtx.ssrc+" "+l,o+="a=ssrc-group:FID "+s.sendEncodingParameters[0].ssrc+" "+s.sendEncodingParameters[0].rtx.ssrc+`\r
`)}return o+="a=ssrc:"+s.sendEncodingParameters[0].ssrc+" cname:"+re.localCName+`\r
`,s.rtpSender&&s.sendEncodingParameters[0].rtx&&(o+="a=ssrc:"+s.sendEncodingParameters[0].rtx.ssrc+" cname:"+re.localCName+`\r
`),o}function QT(s,t){var e=!1;return s=JSON.parse(JSON.stringify(s)),s.filter(function(i){if(i&&(i.urls||i.url)){var n=i.urls||i.url;i.url&&!i.urls&&console.warn("RTCIceServer.url is deprecated! Use urls instead.");var o=typeof n=="string";return o&&(n=[n]),n=n.filter(function(r){var l=r.indexOf("turn:")===0&&r.indexOf("transport=udp")!==-1&&r.indexOf("turn:[")===-1&&!e;return l?(e=!0,!0):r.indexOf("stun:")===0&&t>=14393&&r.indexOf("?transport=udp")===-1}),delete i.url,i.urls=o?n[0]:n,!!n.length}})}function mu(s,t){var e={codecs:[],headerExtensions:[],fecMechanisms:[]},i=function(o,r){o=parseInt(o,10);for(var l=0;l<r.length;l++)if(r[l].payloadType===o||r[l].preferredPayloadType===o)return r[l]},n=function(o,r,l,c){var h=i(o.parameters.apt,l),d=i(r.parameters.apt,c);return h&&d&&h.name.toLowerCase()===d.name.toLowerCase()};return s.codecs.forEach(function(o){for(var r=0;r<t.codecs.length;r++){var l=t.codecs[r];if(o.name.toLowerCase()===l.name.toLowerCase()&&o.clockRate===l.clockRate){if(o.name.toLowerCase()==="rtx"&&o.parameters&&l.parameters.apt&&!n(o,l,s.codecs,t.codecs))continue;l=JSON.parse(JSON.stringify(l)),l.numChannels=Math.min(o.numChannels,l.numChannels),e.codecs.push(l),l.rtcpFeedback=l.rtcpFeedback.filter(function(c){for(var h=0;h<o.rtcpFeedback.length;h++)if(o.rtcpFeedback[h].type===c.type&&o.rtcpFeedback[h].parameter===c.parameter)return!0;return!1});break}}}),s.headerExtensions.forEach(function(o){for(var r=0;r<t.headerExtensions.length;r++){var l=t.headerExtensions[r];if(o.uri===l.uri){e.headerExtensions.push(l);break}}}),e}function G0(s,t,e){return{offer:{setLocalDescription:["stable","have-local-offer"],setRemoteDescription:["stable","have-remote-offer"]},answer:{setLocalDescription:["have-remote-offer","have-local-pranswer"],setRemoteDescription:["have-local-offer","have-remote-pranswer"]}}[t][s].indexOf(e)!==-1}function Zm(s,t){var e=s.getRemoteCandidates().find(function(i){return t.foundation===i.foundation&&t.ip===i.ip&&t.port===i.port&&t.priority===i.priority&&t.protocol===i.protocol&&t.type===i.type});return e||s.addRemoteCandidate(t),!e}function ti(s,t){var e=new Error(t);return e.name=s,e.code={NotSupportedError:9,InvalidStateError:11,InvalidAccessError:15,TypeError:void 0,OperationError:void 0}[s],e}var YT=function(s,t){function e(c,h){h.addTrack(c),h.dispatchEvent(new s.MediaStreamTrackEvent("addtrack",{track:c}))}function i(c,h){h.removeTrack(c),h.dispatchEvent(new s.MediaStreamTrackEvent("removetrack",{track:c}))}function n(c,h,d,u){var f=new Event("track");f.track=h,f.receiver=d,f.transceiver={receiver:d},f.streams=u,s.setTimeout(function(){c._dispatchEvent("track",f)})}var o=function(c){var h=this,d=document.createDocumentFragment();if(["addEventListener","removeEventListener","dispatchEvent"].forEach(function(f){h[f]=d[f].bind(d)}),this.canTrickleIceCandidates=null,this.needNegotiation=!1,this.localStreams=[],this.remoteStreams=[],this._localDescription=null,this._remoteDescription=null,this.signalingState="stable",this.iceConnectionState="new",this.connectionState="new",this.iceGatheringState="new",c=JSON.parse(JSON.stringify(c||{})),this.usingBundle=c.bundlePolicy==="max-bundle",c.rtcpMuxPolicy==="negotiate")throw ti("NotSupportedError","rtcpMuxPolicy 'negotiate' is not supported");switch(c.rtcpMuxPolicy||(c.rtcpMuxPolicy="require"),c.iceTransportPolicy){case"all":case"relay":break;default:c.iceTransportPolicy="all";break}switch(c.bundlePolicy){case"balanced":case"max-compat":case"max-bundle":break;default:c.bundlePolicy="balanced";break}if(c.iceServers=QT(c.iceServers||[],t),this._iceGatherers=[],c.iceCandidatePoolSize)for(var u=c.iceCandidatePoolSize;u>0;u--)this._iceGatherers.push(new s.RTCIceGatherer({iceServers:c.iceServers,gatherPolicy:c.iceTransportPolicy}));else c.iceCandidatePoolSize=0;this._config=c,this.transceivers=[],this._sdpSessionId=re.generateSessionId(),this._sdpSessionVersion=0,this._dtlsRole=void 0,this._isClosed=!1};Object.defineProperty(o.prototype,"localDescription",{configurable:!0,get:function(){return this._localDescription}}),Object.defineProperty(o.prototype,"remoteDescription",{configurable:!0,get:function(){return this._remoteDescription}}),o.prototype.onicecandidate=null,o.prototype.onaddstream=null,o.prototype.ontrack=null,o.prototype.onremovestream=null,o.prototype.onsignalingstatechange=null,o.prototype.oniceconnectionstatechange=null,o.prototype.onconnectionstatechange=null,o.prototype.onicegatheringstatechange=null,o.prototype.onnegotiationneeded=null,o.prototype.ondatachannel=null,o.prototype._dispatchEvent=function(c,h){this._isClosed||(this.dispatchEvent(h),typeof this["on"+c]=="function"&&this["on"+c](h))},o.prototype._emitGatheringStateChange=function(){var c=new Event("icegatheringstatechange");this._dispatchEvent("icegatheringstatechange",c)},o.prototype.getConfiguration=function(){return this._config},o.prototype.getLocalStreams=function(){return this.localStreams},o.prototype.getRemoteStreams=function(){return this.remoteStreams},o.prototype._createTransceiver=function(c,h){var d=this.transceivers.length>0,u={track:null,iceGatherer:null,iceTransport:null,dtlsTransport:null,localCapabilities:null,remoteCapabilities:null,rtpSender:null,rtpReceiver:null,kind:c,mid:null,sendEncodingParameters:null,recvEncodingParameters:null,stream:null,associatedRemoteMediaStreams:[],wantReceive:!0};if(this.usingBundle&&d)u.iceTransport=this.transceivers[0].iceTransport,u.dtlsTransport=this.transceivers[0].dtlsTransport;else{var f=this._createIceAndDtlsTransports();u.iceTransport=f.iceTransport,u.dtlsTransport=f.dtlsTransport}return h||this.transceivers.push(u),u},o.prototype.addTrack=function(c,h){if(this._isClosed)throw ti("InvalidStateError","Attempted to call addTrack on a closed peerconnection.");var d=this.transceivers.find(function(p){return p.track===c});if(d)throw ti("InvalidAccessError","Track already exists.");for(var u,f=0;f<this.transceivers.length;f++)!this.transceivers[f].track&&this.transceivers[f].kind===c.kind&&(u=this.transceivers[f]);return u||(u=this._createTransceiver(c.kind)),this._maybeFireNegotiationNeeded(),this.localStreams.indexOf(h)===-1&&this.localStreams.push(h),u.track=c,u.stream=h,u.rtpSender=new s.RTCRtpSender(c,u.dtlsTransport),u.rtpSender},o.prototype.addStream=function(c){var h=this;if(t>=15025)c.getTracks().forEach(function(u){h.addTrack(u,c)});else{var d=c.clone();c.getTracks().forEach(function(u,f){var p=d.getTracks()[f];u.addEventListener("enabled",function(g){p.enabled=g.enabled})}),d.getTracks().forEach(function(u){h.addTrack(u,d)})}},o.prototype.removeTrack=function(c){if(this._isClosed)throw ti("InvalidStateError","Attempted to call removeTrack on a closed peerconnection.");if(!(c instanceof s.RTCRtpSender))throw new TypeError("Argument 1 of RTCPeerConnection.removeTrack does not implement interface RTCRtpSender.");var h=this.transceivers.find(function(f){return f.rtpSender===c});if(!h)throw ti("InvalidAccessError","Sender was not created by this connection.");var d=h.stream;h.rtpSender.stop(),h.rtpSender=null,h.track=null,h.stream=null;var u=this.transceivers.map(function(f){return f.stream});u.indexOf(d)===-1&&this.localStreams.indexOf(d)>-1&&this.localStreams.splice(this.localStreams.indexOf(d),1),this._maybeFireNegotiationNeeded()},o.prototype.removeStream=function(c){var h=this;c.getTracks().forEach(function(d){var u=h.getSenders().find(function(f){return f.track===d});u&&h.removeTrack(u)})},o.prototype.getSenders=function(){return this.transceivers.filter(function(c){return!!c.rtpSender}).map(function(c){return c.rtpSender})},o.prototype.getReceivers=function(){return this.transceivers.filter(function(c){return!!c.rtpReceiver}).map(function(c){return c.rtpReceiver})},o.prototype._createIceGatherer=function(c,h){var d=this;if(h&&c>0)return this.transceivers[0].iceGatherer;if(this._iceGatherers.length)return this._iceGatherers.shift();var u=new s.RTCIceGatherer({iceServers:this._config.iceServers,gatherPolicy:this._config.iceTransportPolicy});return Object.defineProperty(u,"state",{value:"new",writable:!0}),this.transceivers[c].bufferedCandidateEvents=[],this.transceivers[c].bufferCandidates=function(f){var p=!f.candidate||Object.keys(f.candidate).length===0;u.state=p?"completed":"gathering",d.transceivers[c].bufferedCandidateEvents!==null&&d.transceivers[c].bufferedCandidateEvents.push(f)},u.addEventListener("localcandidate",this.transceivers[c].bufferCandidates),u},o.prototype._gather=function(c,h){var d=this,u=this.transceivers[h].iceGatherer;if(!u.onlocalcandidate){var f=this.transceivers[h].bufferedCandidateEvents;this.transceivers[h].bufferedCandidateEvents=null,u.removeEventListener("localcandidate",this.transceivers[h].bufferCandidates),u.onlocalcandidate=function(p){if(!(d.usingBundle&&h>0)){var g=new Event("icecandidate");g.candidate={sdpMid:c,sdpMLineIndex:h};var y=p.candidate,b=!y||Object.keys(y).length===0;if(b)(u.state==="new"||u.state==="gathering")&&(u.state="completed");else{u.state==="new"&&(u.state="gathering"),y.component=1,y.ufrag=u.getLocalParameters().usernameFragment;var _=re.writeCandidate(y);g.candidate=Object.assign(g.candidate,re.parseCandidate(_)),g.candidate.candidate=_,g.candidate.toJSON=function(){return{candidate:g.candidate.candidate,sdpMid:g.candidate.sdpMid,sdpMLineIndex:g.candidate.sdpMLineIndex,usernameFragment:g.candidate.usernameFragment}}}var v=re.getMediaSections(d._localDescription.sdp);b?v[g.candidate.sdpMLineIndex]+=`a=end-of-candidates\r
`:v[g.candidate.sdpMLineIndex]+="a="+g.candidate.candidate+`\r
`,d._localDescription.sdp=re.getDescription(d._localDescription.sdp)+v.join("");var S=d.transceivers.every(function(T){return T.iceGatherer&&T.iceGatherer.state==="completed"});d.iceGatheringState!=="gathering"&&(d.iceGatheringState="gathering",d._emitGatheringStateChange()),b||d._dispatchEvent("icecandidate",g),S&&(d._dispatchEvent("icecandidate",new Event("icecandidate")),d.iceGatheringState="complete",d._emitGatheringStateChange())}},s.setTimeout(function(){f.forEach(function(p){u.onlocalcandidate(p)})},0)}},o.prototype._createIceAndDtlsTransports=function(){var c=this,h=new s.RTCIceTransport(null);h.onicestatechange=function(){c._updateIceConnectionState(),c._updateConnectionState()};var d=new s.RTCDtlsTransport(h);return d.ondtlsstatechange=function(){c._updateConnectionState()},d.onerror=function(){Object.defineProperty(d,"state",{value:"failed",writable:!0}),c._updateConnectionState()},{iceTransport:h,dtlsTransport:d}},o.prototype._disposeIceAndDtlsTransports=function(c){var h=this.transceivers[c].iceGatherer;h&&(delete h.onlocalcandidate,delete this.transceivers[c].iceGatherer);var d=this.transceivers[c].iceTransport;d&&(delete d.onicestatechange,delete this.transceivers[c].iceTransport);var u=this.transceivers[c].dtlsTransport;u&&(delete u.ondtlsstatechange,delete u.onerror,delete this.transceivers[c].dtlsTransport)},o.prototype._transceive=function(c,h,d){var u=mu(c.localCapabilities,c.remoteCapabilities);h&&c.rtpSender&&(u.encodings=c.sendEncodingParameters,u.rtcp={cname:re.localCName,compound:c.rtcpParameters.compound},c.recvEncodingParameters.length&&(u.rtcp.ssrc=c.recvEncodingParameters[0].ssrc),c.rtpSender.send(u)),d&&c.rtpReceiver&&u.codecs.length>0&&(c.kind==="video"&&c.recvEncodingParameters&&t<15019&&c.recvEncodingParameters.forEach(function(f){delete f.rtx}),c.recvEncodingParameters.length?u.encodings=c.recvEncodingParameters:u.encodings=[{}],u.rtcp={compound:c.rtcpParameters.compound},c.rtcpParameters.cname&&(u.rtcp.cname=c.rtcpParameters.cname),c.sendEncodingParameters.length&&(u.rtcp.ssrc=c.sendEncodingParameters[0].ssrc),c.rtpReceiver.receive(u))},o.prototype.setLocalDescription=function(c){var h=this;if(["offer","answer"].indexOf(c.type)===-1)return Promise.reject(ti("TypeError",'Unsupported type "'+c.type+'"'));if(!G0("setLocalDescription",c.type,h.signalingState)||h._isClosed)return Promise.reject(ti("InvalidStateError","Can not set local "+c.type+" in state "+h.signalingState));var d,u;if(c.type==="offer")d=re.splitSections(c.sdp),u=d.shift(),d.forEach(function(p,g){var y=re.parseRtpParameters(p);h.transceivers[g].localCapabilities=y}),h.transceivers.forEach(function(p,g){h._gather(p.mid,g)});else if(c.type==="answer"){d=re.splitSections(h._remoteDescription.sdp),u=d.shift();var f=re.matchPrefix(u,"a=ice-lite").length>0;d.forEach(function(p,g){var y=h.transceivers[g],b=y.iceGatherer,_=y.iceTransport,v=y.dtlsTransport,S=y.localCapabilities,T=y.remoteCapabilities,O=re.isRejected(p)&&re.matchPrefix(p,"a=bundle-only").length===0;if(!O&&!y.rejected){var M=re.getIceParameters(p,u),k=re.getDtlsParameters(p,u);f&&(k.role="server"),(!h.usingBundle||g===0)&&(h._gather(y.mid,g),_.state==="new"&&_.start(b,M,f?"controlling":"controlled"),v.state==="new"&&v.start(k));var B=mu(S,T);h._transceive(y,B.codecs.length>0,!1)}})}return h._localDescription={type:c.type,sdp:c.sdp},c.type==="offer"?h._updateSignalingState("have-local-offer"):h._updateSignalingState("stable"),Promise.resolve()},o.prototype.setRemoteDescription=function(c){var h=this;if(["offer","answer"].indexOf(c.type)===-1)return Promise.reject(ti("TypeError",'Unsupported type "'+c.type+'"'));if(!G0("setRemoteDescription",c.type,h.signalingState)||h._isClosed)return Promise.reject(ti("InvalidStateError","Can not set remote "+c.type+" in state "+h.signalingState));var d={};h.remoteStreams.forEach(function(_){d[_.id]=_});var u=[],f=re.splitSections(c.sdp),p=f.shift(),g=re.matchPrefix(p,"a=ice-lite").length>0,y=re.matchPrefix(p,"a=group:BUNDLE ").length>0;h.usingBundle=y;var b=re.matchPrefix(p,"a=ice-options:")[0];return b?h.canTrickleIceCandidates=b.substr(14).split(" ").indexOf("trickle")>=0:h.canTrickleIceCandidates=!1,f.forEach(function(_,v){var S=re.splitLines(_),T=re.getKind(_),O=re.isRejected(_)&&re.matchPrefix(_,"a=bundle-only").length===0,M=S[0].substr(2).split(" ")[2],k=re.getDirection(_,p),B=re.parseMsid(_),I=re.getMid(_)||re.generateIdentifier();if(O||T==="application"&&(M==="DTLS/SCTP"||M==="UDP/DTLS/SCTP")){h.transceivers[v]={mid:I,kind:T,protocol:M,rejected:!0};return}!O&&h.transceivers[v]&&h.transceivers[v].rejected&&(h.transceivers[v]=h._createTransceiver(T,!0));var E,L,V,A,D,N,q,Y,ie,he=re.parseRtpParameters(_),Pe,He;O||(Pe=re.getIceParameters(_,p),He=re.getDtlsParameters(_,p),He.role="client"),q=re.parseRtpEncodingParameters(_);var gt=re.parseRtcpParameters(_),lt=re.matchPrefix(_,"a=end-of-candidates",p).length>0,ei=re.matchPrefix(_,"a=candidate:").map(function(Ee){return re.parseCandidate(Ee)}).filter(function(Ee){return Ee.component===1});if((c.type==="offer"||c.type==="answer")&&!O&&y&&v>0&&h.transceivers[v]&&(h._disposeIceAndDtlsTransports(v),h.transceivers[v].iceGatherer=h.transceivers[0].iceGatherer,h.transceivers[v].iceTransport=h.transceivers[0].iceTransport,h.transceivers[v].dtlsTransport=h.transceivers[0].dtlsTransport,h.transceivers[v].rtpSender&&h.transceivers[v].rtpSender.setTransport(h.transceivers[0].dtlsTransport),h.transceivers[v].rtpReceiver&&h.transceivers[v].rtpReceiver.setTransport(h.transceivers[0].dtlsTransport)),c.type==="offer"&&!O){E=h.transceivers[v]||h._createTransceiver(T),E.mid=I,E.iceGatherer||(E.iceGatherer=h._createIceGatherer(v,y)),ei.length&&E.iceTransport.state==="new"&&(lt&&(!y||v===0)?E.iceTransport.setRemoteCandidates(ei):ei.forEach(function(Ee){Zm(E.iceTransport,Ee)})),Y=s.RTCRtpReceiver.getCapabilities(T),t<15019&&(Y.codecs=Y.codecs.filter(function(Ee){return Ee.name!=="rtx"})),N=E.sendEncodingParameters||[{ssrc:(2*v+2)*1001}];var _i=!1;if(k==="sendrecv"||k==="sendonly"){if(_i=!E.rtpReceiver,D=E.rtpReceiver||new s.RTCRtpReceiver(E.dtlsTransport,T),_i){var bi;ie=D.track,B&&B.stream==="-"||(B?(d[B.stream]||(d[B.stream]=new s.MediaStream,Object.defineProperty(d[B.stream],"id",{get:function(){return B.stream}})),Object.defineProperty(ie,"id",{get:function(){return B.track}}),bi=d[B.stream]):(d.default||(d.default=new s.MediaStream),bi=d.default)),bi&&(e(ie,bi),E.associatedRemoteMediaStreams.push(bi)),u.push([ie,D,bi])}}else E.rtpReceiver&&E.rtpReceiver.track&&(E.associatedRemoteMediaStreams.forEach(function(Ee){var yl=Ee.getTracks().find(function(Yc){return Yc.id===E.rtpReceiver.track.id});yl&&i(yl,Ee)}),E.associatedRemoteMediaStreams=[]);E.localCapabilities=Y,E.remoteCapabilities=he,E.rtpReceiver=D,E.rtcpParameters=gt,E.sendEncodingParameters=N,E.recvEncodingParameters=q,h._transceive(h.transceivers[v],!1,_i)}else if(c.type==="answer"&&!O){E=h.transceivers[v],L=E.iceGatherer,V=E.iceTransport,A=E.dtlsTransport,D=E.rtpReceiver,N=E.sendEncodingParameters,Y=E.localCapabilities,h.transceivers[v].recvEncodingParameters=q,h.transceivers[v].remoteCapabilities=he,h.transceivers[v].rtcpParameters=gt,ei.length&&V.state==="new"&&((g||lt)&&(!y||v===0)?V.setRemoteCandidates(ei):ei.forEach(function(Ee){Zm(E.iceTransport,Ee)})),(!y||v===0)&&(V.state==="new"&&V.start(L,Pe,"controlling"),A.state==="new"&&A.start(He));var fs=mu(E.localCapabilities,E.remoteCapabilities),ra=fs.codecs.filter(function(Ee){return Ee.name.toLowerCase()==="rtx"}).length;!ra&&E.sendEncodingParameters[0].rtx&&delete E.sendEncodingParameters[0].rtx,h._transceive(E,k==="sendrecv"||k==="recvonly",k==="sendrecv"||k==="sendonly"),D&&(k==="sendrecv"||k==="sendonly")?(ie=D.track,B?(d[B.stream]||(d[B.stream]=new s.MediaStream),e(ie,d[B.stream]),u.push([ie,D,d[B.stream]])):(d.default||(d.default=new s.MediaStream),e(ie,d.default),u.push([ie,D,d.default]))):delete E.rtpReceiver}}),h._dtlsRole===void 0&&(h._dtlsRole=c.type==="offer"?"active":"passive"),h._remoteDescription={type:c.type,sdp:c.sdp},c.type==="offer"?h._updateSignalingState("have-remote-offer"):h._updateSignalingState("stable"),Object.keys(d).forEach(function(_){var v=d[_];if(v.getTracks().length){if(h.remoteStreams.indexOf(v)===-1){h.remoteStreams.push(v);var S=new Event("addstream");S.stream=v,s.setTimeout(function(){h._dispatchEvent("addstream",S)})}u.forEach(function(T){var O=T[0],M=T[1];v.id===T[2].id&&n(h,O,M,[v])})}}),u.forEach(function(_){_[2]||n(h,_[0],_[1],[])}),s.setTimeout(function(){h&&h.transceivers&&h.transceivers.forEach(function(_){_.iceTransport&&_.iceTransport.state==="new"&&_.iceTransport.getRemoteCandidates().length>0&&(console.warn("Timeout for addRemoteCandidate. Consider sending an end-of-candidates notification"),_.iceTransport.addRemoteCandidate({}))})},4e3),Promise.resolve()},o.prototype.close=function(){this.transceivers.forEach(function(c){c.iceTransport&&c.iceTransport.stop(),c.dtlsTransport&&c.dtlsTransport.stop(),c.rtpSender&&c.rtpSender.stop(),c.rtpReceiver&&c.rtpReceiver.stop()}),this._isClosed=!0,this._updateSignalingState("closed")},o.prototype._updateSignalingState=function(c){this.signalingState=c;var h=new Event("signalingstatechange");this._dispatchEvent("signalingstatechange",h)},o.prototype._maybeFireNegotiationNeeded=function(){var c=this;this.signalingState!=="stable"||this.needNegotiation===!0||(this.needNegotiation=!0,s.setTimeout(function(){if(c.needNegotiation){c.needNegotiation=!1;var h=new Event("negotiationneeded");c._dispatchEvent("negotiationneeded",h)}},0))},o.prototype._updateIceConnectionState=function(){var c,h={new:0,closed:0,checking:0,connected:0,completed:0,disconnected:0,failed:0};if(this.transceivers.forEach(function(u){u.iceTransport&&!u.rejected&&h[u.iceTransport.state]++}),c="new",h.failed>0?c="failed":h.checking>0?c="checking":h.disconnected>0?c="disconnected":h.new>0?c="new":h.connected>0?c="connected":h.completed>0&&(c="completed"),c!==this.iceConnectionState){this.iceConnectionState=c;var d=new Event("iceconnectionstatechange");this._dispatchEvent("iceconnectionstatechange",d)}},o.prototype._updateConnectionState=function(){var c,h={new:0,closed:0,connecting:0,connected:0,completed:0,disconnected:0,failed:0};if(this.transceivers.forEach(function(u){u.iceTransport&&u.dtlsTransport&&!u.rejected&&(h[u.iceTransport.state]++,h[u.dtlsTransport.state]++)}),h.connected+=h.completed,c="new",h.failed>0?c="failed":h.connecting>0?c="connecting":h.disconnected>0?c="disconnected":h.new>0?c="new":h.connected>0&&(c="connected"),c!==this.connectionState){this.connectionState=c;var d=new Event("connectionstatechange");this._dispatchEvent("connectionstatechange",d)}},o.prototype.createOffer=function(){var c=this;if(c._isClosed)return Promise.reject(ti("InvalidStateError","Can not call createOffer after close"));var h=c.transceivers.filter(function(g){return g.kind==="audio"}).length,d=c.transceivers.filter(function(g){return g.kind==="video"}).length,u=arguments[0];if(u){if(u.mandatory||u.optional)throw new TypeError("Legacy mandatory/optional constraints not supported.");u.offerToReceiveAudio!==void 0&&(u.offerToReceiveAudio===!0?h=1:u.offerToReceiveAudio===!1?h=0:h=u.offerToReceiveAudio),u.offerToReceiveVideo!==void 0&&(u.offerToReceiveVideo===!0?d=1:u.offerToReceiveVideo===!1?d=0:d=u.offerToReceiveVideo)}for(c.transceivers.forEach(function(g){g.kind==="audio"?(h--,h<0&&(g.wantReceive=!1)):g.kind==="video"&&(d--,d<0&&(g.wantReceive=!1))});h>0||d>0;)h>0&&(c._createTransceiver("audio"),h--),d>0&&(c._createTransceiver("video"),d--);var f=re.writeSessionBoilerplate(c._sdpSessionId,c._sdpSessionVersion++);c.transceivers.forEach(function(g,y){var b=g.track,_=g.kind,v=g.mid||re.generateIdentifier();g.mid=v,g.iceGatherer||(g.iceGatherer=c._createIceGatherer(y,c.usingBundle));var S=s.RTCRtpSender.getCapabilities(_);t<15019&&(S.codecs=S.codecs.filter(function(O){return O.name!=="rtx"})),S.codecs.forEach(function(O){O.name==="H264"&&O.parameters["level-asymmetry-allowed"]===void 0&&(O.parameters["level-asymmetry-allowed"]="1"),g.remoteCapabilities&&g.remoteCapabilities.codecs&&g.remoteCapabilities.codecs.forEach(function(M){O.name.toLowerCase()===M.name.toLowerCase()&&O.clockRate===M.clockRate&&(O.preferredPayloadType=M.payloadType)})}),S.headerExtensions.forEach(function(O){var M=g.remoteCapabilities&&g.remoteCapabilities.headerExtensions||[];M.forEach(function(k){O.uri===k.uri&&(O.id=k.id)})});var T=g.sendEncodingParameters||[{ssrc:(2*y+1)*1001}];b&&t>=15019&&_==="video"&&!T[0].rtx&&(T[0].rtx={ssrc:T[0].ssrc+1}),g.wantReceive&&(g.rtpReceiver=new s.RTCRtpReceiver(g.dtlsTransport,_)),g.localCapabilities=S,g.sendEncodingParameters=T}),c._config.bundlePolicy!=="max-compat"&&(f+="a=group:BUNDLE "+c.transceivers.map(function(g){return g.mid}).join(" ")+`\r
`),f+=`a=ice-options:trickle\r
`,c.transceivers.forEach(function(g,y){f+=H0(g,g.localCapabilities,"offer",g.stream,c._dtlsRole),f+=`a=rtcp-rsize\r
`,g.iceGatherer&&c.iceGatheringState!=="new"&&(y===0||!c.usingBundle)&&(g.iceGatherer.getLocalCandidates().forEach(function(b){b.component=1,f+="a="+re.writeCandidate(b)+`\r
`}),g.iceGatherer.state==="completed"&&(f+=`a=end-of-candidates\r
`))});var p=new s.RTCSessionDescription({type:"offer",sdp:f});return Promise.resolve(p)},o.prototype.createAnswer=function(){var c=this;if(c._isClosed)return Promise.reject(ti("InvalidStateError","Can not call createAnswer after close"));if(!(c.signalingState==="have-remote-offer"||c.signalingState==="have-local-pranswer"))return Promise.reject(ti("InvalidStateError","Can not call createAnswer in signalingState "+c.signalingState));var h=re.writeSessionBoilerplate(c._sdpSessionId,c._sdpSessionVersion++);c.usingBundle&&(h+="a=group:BUNDLE "+c.transceivers.map(function(f){return f.mid}).join(" ")+`\r
`),h+=`a=ice-options:trickle\r
`;var d=re.getMediaSections(c._remoteDescription.sdp).length;c.transceivers.forEach(function(f,p){if(!(p+1>d)){if(f.rejected){f.kind==="application"?f.protocol==="DTLS/SCTP"?h+=`m=application 0 DTLS/SCTP 5000\r
`:h+="m=application 0 "+f.protocol+` webrtc-datachannel\r
`:f.kind==="audio"?h+=`m=audio 0 UDP/TLS/RTP/SAVPF 0\r
a=rtpmap:0 PCMU/8000\r
`:f.kind==="video"&&(h+=`m=video 0 UDP/TLS/RTP/SAVPF 120\r
a=rtpmap:120 VP8/90000\r
`),h+=`c=IN IP4 0.0.0.0\r
a=inactive\r
a=mid:`+f.mid+`\r
`;return}if(f.stream){var g;f.kind==="audio"?g=f.stream.getAudioTracks()[0]:f.kind==="video"&&(g=f.stream.getVideoTracks()[0]),g&&t>=15019&&f.kind==="video"&&!f.sendEncodingParameters[0].rtx&&(f.sendEncodingParameters[0].rtx={ssrc:f.sendEncodingParameters[0].ssrc+1})}var y=mu(f.localCapabilities,f.remoteCapabilities),b=y.codecs.filter(function(_){return _.name.toLowerCase()==="rtx"}).length;!b&&f.sendEncodingParameters[0].rtx&&delete f.sendEncodingParameters[0].rtx,h+=H0(f,y,"answer",f.stream,c._dtlsRole),f.rtcpParameters&&f.rtcpParameters.reducedSize&&(h+=`a=rtcp-rsize\r
`)}});var u=new s.RTCSessionDescription({type:"answer",sdp:h});return Promise.resolve(u)},o.prototype.addIceCandidate=function(c){var h=this,d;return c&&!(c.sdpMLineIndex!==void 0||c.sdpMid)?Promise.reject(new TypeError("sdpMLineIndex or sdpMid required")):new Promise(function(u,f){if(h._remoteDescription)if(!c||c.candidate==="")for(var p=0;p<h.transceivers.length&&!(!h.transceivers[p].rejected&&(h.transceivers[p].iceTransport.addRemoteCandidate({}),d=re.getMediaSections(h._remoteDescription.sdp),d[p]+=`a=end-of-candidates\r
`,h._remoteDescription.sdp=re.getDescription(h._remoteDescription.sdp)+d.join(""),h.usingBundle));p++);else{var g=c.sdpMLineIndex;if(c.sdpMid){for(var y=0;y<h.transceivers.length;y++)if(h.transceivers[y].mid===c.sdpMid){g=y;break}}var b=h.transceivers[g];if(b){if(b.rejected)return u();var _=Object.keys(c.candidate).length>0?re.parseCandidate(c.candidate):{};if(_.protocol==="tcp"&&(_.port===0||_.port===9)||_.component&&_.component!==1)return u();if((g===0||g>0&&b.iceTransport!==h.transceivers[0].iceTransport)&&!Zm(b.iceTransport,_))return f(ti("OperationError","Can not add ICE candidate"));var v=c.candidate.trim();v.indexOf("a=")===0&&(v=v.substr(2)),d=re.getMediaSections(h._remoteDescription.sdp),d[g]+="a="+(_.type?v:"end-of-candidates")+`\r
`,h._remoteDescription.sdp=re.getDescription(h._remoteDescription.sdp)+d.join("")}else return f(ti("OperationError","Can not add ICE candidate"))}else return f(ti("InvalidStateError","Can not add ICE candidate without a remote description"));u()})},o.prototype.getStats=function(c){if(c&&c instanceof s.MediaStreamTrack){var h=null;if(this.transceivers.forEach(function(u){u.rtpSender&&u.rtpSender.track===c?h=u.rtpSender:u.rtpReceiver&&u.rtpReceiver.track===c&&(h=u.rtpReceiver)}),!h)throw ti("InvalidAccessError","Invalid selector.");return h.getStats()}var d=[];return this.transceivers.forEach(function(u){["rtpSender","rtpReceiver","iceGatherer","iceTransport","dtlsTransport"].forEach(function(f){u[f]&&d.push(u[f].getStats())})}),Promise.all(d).then(function(u){var f=new Map;return u.forEach(function(p){p.forEach(function(g){f.set(g.id,g)})}),f})};var r=["RTCRtpSender","RTCRtpReceiver","RTCIceGatherer","RTCIceTransport","RTCDtlsTransport"];r.forEach(function(c){var h=s[c];if(h&&h.prototype&&h.prototype.getStats){var d=h.prototype.getStats;h.prototype.getStats=function(){return d.apply(this).then(function(u){var f=new Map;return Object.keys(u).forEach(function(p){u[p].type=XT(u[p]),f.set(p,u[p])}),f})}}});var l=["createOffer","createAnswer"];return l.forEach(function(c){var h=o.prototype[c];o.prototype[c]=function(){var d=arguments;return typeof d[0]=="function"||typeof d[1]=="function"?h.apply(this,[arguments[2]]).then(function(u){typeof d[0]=="function"&&d[0].apply(null,[u])},function(u){typeof d[1]=="function"&&d[1].apply(null,[u])}):h.apply(this,arguments)}}),l=["setLocalDescription","setRemoteDescription","addIceCandidate"],l.forEach(function(c){var h=o.prototype[c];o.prototype[c]=function(){var d=arguments;return typeof d[1]=="function"||typeof d[2]=="function"?h.apply(this,arguments).then(function(){typeof d[1]=="function"&&d[1].apply(null)},function(u){typeof d[2]=="function"&&d[2].apply(null,[u])}):h.apply(this,arguments)}}),["getStats"].forEach(function(c){var h=o.prototype[c];o.prototype[c]=function(){var d=arguments;return typeof d[1]=="function"?h.apply(this,arguments).then(function(){typeof d[1]=="function"&&d[1].apply(null)}):h.apply(this,arguments)}}),o};const KT=Lp(YT);function wS(s){const t=s&&s.navigator,e=function(n){return{name:{PermissionDeniedError:"NotAllowedError"}[n.name]||n.name,message:n.message,constraint:n.constraint,toString(){return this.name}}},i=t.mediaDevices.getUserMedia.bind(t.mediaDevices);t.mediaDevices.getUserMedia=function(n){return i(n).catch(o=>Promise.reject(e(o)))}}function SS(s){"getDisplayMedia"in s.navigator&&s.navigator.mediaDevices&&(s.navigator.mediaDevices&&"getDisplayMedia"in s.navigator.mediaDevices||(s.navigator.mediaDevices.getDisplayMedia=s.navigator.getDisplayMedia.bind(s.navigator)))}function wy(s,t){if(s.RTCIceGatherer&&(s.RTCIceCandidate||(s.RTCIceCandidate=function(n){return n}),s.RTCSessionDescription||(s.RTCSessionDescription=function(n){return n}),t.version<15025)){const i=Object.getOwnPropertyDescriptor(s.MediaStreamTrack.prototype,"enabled");Object.defineProperty(s.MediaStreamTrack.prototype,"enabled",{set(n){i.set.call(this,n);const o=new Event("enabled");o.enabled=n,this.dispatchEvent(o)}})}s.RTCRtpSender&&!("dtmf"in s.RTCRtpSender.prototype)&&Object.defineProperty(s.RTCRtpSender.prototype,"dtmf",{get(){return this._dtmf===void 0&&(this.track.kind==="audio"?this._dtmf=new s.RTCDtmfSender(this):this.track.kind==="video"&&(this._dtmf=null)),this._dtmf}}),s.RTCDtmfSender&&!s.RTCDTMFSender&&(s.RTCDTMFSender=s.RTCDtmfSender);const e=KT(s,t.version);s.RTCPeerConnection=function(n){return n&&n.iceServers&&(n.iceServers=qT(n.iceServers,t.version),z_("ICE servers after filtering:",n.iceServers)),new e(n)},s.RTCPeerConnection.prototype=e.prototype}function CS(s){s.RTCRtpSender&&!("replaceTrack"in s.RTCRtpSender.prototype)&&(s.RTCRtpSender.prototype.replaceTrack=s.RTCRtpSender.prototype.setTrack)}const q0=Object.freeze(Object.defineProperty({__proto__:null,shimGetDisplayMedia:SS,shimGetUserMedia:wS,shimPeerConnection:wy,shimReplaceTrack:CS},Symbol.toStringTag,{value:"Module"}));function PS(s,t){const e=s&&s.navigator,i=s&&s.MediaStreamTrack;if(e.getUserMedia=function(n,o,r){jp("navigator.getUserMedia","navigator.mediaDevices.getUserMedia"),e.mediaDevices.getUserMedia(n).then(o,r)},!(t.version>55&&"autoGainControl"in e.mediaDevices.getSupportedConstraints())){const n=function(r,l,c){l in r&&!(c in r)&&(r[c]=r[l],delete r[l])},o=e.mediaDevices.getUserMedia.bind(e.mediaDevices);if(e.mediaDevices.getUserMedia=function(r){return typeof r=="object"&&typeof r.audio=="object"&&(r=JSON.parse(JSON.stringify(r)),n(r.audio,"autoGainControl","mozAutoGainControl"),n(r.audio,"noiseSuppression","mozNoiseSuppression")),o(r)},i&&i.prototype.getSettings){const r=i.prototype.getSettings;i.prototype.getSettings=function(){const l=r.apply(this,arguments);return n(l,"mozAutoGainControl","autoGainControl"),n(l,"mozNoiseSuppression","noiseSuppression"),l}}if(i&&i.prototype.applyConstraints){const r=i.prototype.applyConstraints;i.prototype.applyConstraints=function(l){return this.kind==="audio"&&typeof l=="object"&&(l=JSON.parse(JSON.stringify(l)),n(l,"autoGainControl","mozAutoGainControl"),n(l,"noiseSuppression","mozNoiseSuppression")),r.apply(this,[l])}}}}function JT(s,t){s.navigator.mediaDevices&&"getDisplayMedia"in s.navigator.mediaDevices||s.navigator.mediaDevices&&(s.navigator.mediaDevices.getDisplayMedia=function(i){if(!(i&&i.video)){const n=new DOMException("getDisplayMedia without video constraints is undefined");return n.name="NotFoundError",n.code=8,Promise.reject(n)}return i.video===!0?i.video={mediaSource:t}:i.video.mediaSource=t,s.navigator.mediaDevices.getUserMedia(i)})}function RS(s){typeof s=="object"&&s.RTCTrackEvent&&"receiver"in s.RTCTrackEvent.prototype&&!("transceiver"in s.RTCTrackEvent.prototype)&&Object.defineProperty(s.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function Sy(s,t){if(typeof s!="object"||!(s.RTCPeerConnection||s.mozRTCPeerConnection))return;!s.RTCPeerConnection&&s.mozRTCPeerConnection&&(s.RTCPeerConnection=s.mozRTCPeerConnection),t.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(n){const o=s.RTCPeerConnection.prototype[n],r={[n](){return arguments[0]=new(n==="addIceCandidate"?s.RTCIceCandidate:s.RTCSessionDescription)(arguments[0]),o.apply(this,arguments)}};s.RTCPeerConnection.prototype[n]=r[n]});const e={inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"},i=s.RTCPeerConnection.prototype.getStats;s.RTCPeerConnection.prototype.getStats=function(){const[o,r,l]=arguments;return i.apply(this,[o||null]).then(c=>{if(t.version<53&&!r)try{c.forEach(h=>{h.type=e[h.type]||h.type})}catch(h){if(h.name!=="TypeError")throw h;c.forEach((d,u)=>{c.set(u,Object.assign({},d,{type:e[d.type]||d.type}))})}return c}).then(r,l)}}function OS(s){if(!(typeof s=="object"&&s.RTCPeerConnection&&s.RTCRtpSender)||s.RTCRtpSender&&"getStats"in s.RTCRtpSender.prototype)return;const t=s.RTCPeerConnection.prototype.getSenders;t&&(s.RTCPeerConnection.prototype.getSenders=function(){const n=t.apply(this,[]);return n.forEach(o=>o._pc=this),n});const e=s.RTCPeerConnection.prototype.addTrack;e&&(s.RTCPeerConnection.prototype.addTrack=function(){const n=e.apply(this,arguments);return n._pc=this,n}),s.RTCRtpSender.prototype.getStats=function(){return this.track?this._pc.getStats(this.track):Promise.resolve(new Map)}}function TS(s){if(!(typeof s=="object"&&s.RTCPeerConnection&&s.RTCRtpSender)||s.RTCRtpSender&&"getStats"in s.RTCRtpReceiver.prototype)return;const t=s.RTCPeerConnection.prototype.getReceivers;t&&(s.RTCPeerConnection.prototype.getReceivers=function(){const i=t.apply(this,[]);return i.forEach(n=>n._pc=this),i}),Mc(s,"track",e=>(e.receiver._pc=e.srcElement,e)),s.RTCRtpReceiver.prototype.getStats=function(){return this._pc.getStats(this.track)}}function kS(s){!s.RTCPeerConnection||"removeStream"in s.RTCPeerConnection.prototype||(s.RTCPeerConnection.prototype.removeStream=function(e){jp("removeStream","removeTrack"),this.getSenders().forEach(i=>{i.track&&e.getTracks().includes(i.track)&&this.removeTrack(i)})})}function ES(s){s.DataChannel&&!s.RTCDataChannel&&(s.RTCDataChannel=s.DataChannel)}function MS(s){if(!(typeof s=="object"&&s.RTCPeerConnection))return;const t=s.RTCPeerConnection.prototype.addTransceiver;t&&(s.RTCPeerConnection.prototype.addTransceiver=function(){this.setParametersPromises=[];const i=arguments[1],n=i&&"sendEncodings"in i;n&&i.sendEncodings.forEach(r=>{if("rid"in r&&!/^[a-z0-9]{0,16}$/i.test(r.rid))throw new TypeError("Invalid RID value provided.");if("scaleResolutionDownBy"in r&&!(parseFloat(r.scaleResolutionDownBy)>=1))throw new RangeError("scale_resolution_down_by must be >= 1.0");if("maxFramerate"in r&&!(parseFloat(r.maxFramerate)>=0))throw new RangeError("max_framerate must be >= 0.0")});const o=t.apply(this,arguments);if(n){const{sender:r}=o,l=r.getParameters();(!("encodings"in l)||l.encodings.length===1&&Object.keys(l.encodings[0]).length===0)&&(l.encodings=i.sendEncodings,r.sendEncodings=i.sendEncodings,this.setParametersPromises.push(r.setParameters(l).then(()=>{delete r.sendEncodings}).catch(()=>{delete r.sendEncodings})))}return o})}function AS(s){if(!(typeof s=="object"&&s.RTCRtpSender))return;const t=s.RTCRtpSender.prototype.getParameters;t&&(s.RTCRtpSender.prototype.getParameters=function(){const i=t.apply(this,arguments);return"encodings"in i||(i.encodings=[].concat(this.sendEncodings||[{}])),i})}function IS(s){if(!(typeof s=="object"&&s.RTCPeerConnection))return;const t=s.RTCPeerConnection.prototype.createOffer;s.RTCPeerConnection.prototype.createOffer=function(){return this.setParametersPromises&&this.setParametersPromises.length?Promise.all(this.setParametersPromises).then(()=>t.apply(this,arguments)).finally(()=>{this.setParametersPromises=[]}):t.apply(this,arguments)}}function DS(s){if(!(typeof s=="object"&&s.RTCPeerConnection))return;const t=s.RTCPeerConnection.prototype.createAnswer;s.RTCPeerConnection.prototype.createAnswer=function(){return this.setParametersPromises&&this.setParametersPromises.length?Promise.all(this.setParametersPromises).then(()=>t.apply(this,arguments)).finally(()=>{this.setParametersPromises=[]}):t.apply(this,arguments)}}const X0=Object.freeze(Object.defineProperty({__proto__:null,shimAddTransceiver:MS,shimCreateAnswer:DS,shimCreateOffer:IS,shimGetDisplayMedia:JT,shimGetParameters:AS,shimGetUserMedia:PS,shimOnTrack:RS,shimPeerConnection:Sy,shimRTCDataChannel:ES,shimReceiverGetStats:TS,shimRemoveStream:kS,shimSenderGetStats:OS},Symbol.toStringTag,{value:"Module"}));function LS(s){if(!(typeof s!="object"||!s.RTCPeerConnection)){if("getLocalStreams"in s.RTCPeerConnection.prototype||(s.RTCPeerConnection.prototype.getLocalStreams=function(){return this._localStreams||(this._localStreams=[]),this._localStreams}),!("addStream"in s.RTCPeerConnection.prototype)){const t=s.RTCPeerConnection.prototype.addTrack;s.RTCPeerConnection.prototype.addStream=function(i){this._localStreams||(this._localStreams=[]),this._localStreams.includes(i)||this._localStreams.push(i),i.getAudioTracks().forEach(n=>t.call(this,n,i)),i.getVideoTracks().forEach(n=>t.call(this,n,i))},s.RTCPeerConnection.prototype.addTrack=function(i,...n){return n&&n.forEach(o=>{this._localStreams?this._localStreams.includes(o)||this._localStreams.push(o):this._localStreams=[o]}),t.apply(this,arguments)}}"removeStream"in s.RTCPeerConnection.prototype||(s.RTCPeerConnection.prototype.removeStream=function(e){this._localStreams||(this._localStreams=[]);const i=this._localStreams.indexOf(e);if(i===-1)return;this._localStreams.splice(i,1);const n=e.getTracks();this.getSenders().forEach(o=>{n.includes(o.track)&&this.removeTrack(o)})})}}function jS(s){if(!(typeof s!="object"||!s.RTCPeerConnection)&&("getRemoteStreams"in s.RTCPeerConnection.prototype||(s.RTCPeerConnection.prototype.getRemoteStreams=function(){return this._remoteStreams?this._remoteStreams:[]}),!("onaddstream"in s.RTCPeerConnection.prototype))){Object.defineProperty(s.RTCPeerConnection.prototype,"onaddstream",{get(){return this._onaddstream},set(e){this._onaddstream&&(this.removeEventListener("addstream",this._onaddstream),this.removeEventListener("track",this._onaddstreampoly)),this.addEventListener("addstream",this._onaddstream=e),this.addEventListener("track",this._onaddstreampoly=i=>{i.streams.forEach(n=>{if(this._remoteStreams||(this._remoteStreams=[]),this._remoteStreams.includes(n))return;this._remoteStreams.push(n);const o=new Event("addstream");o.stream=n,this.dispatchEvent(o)})})}});const t=s.RTCPeerConnection.prototype.setRemoteDescription;s.RTCPeerConnection.prototype.setRemoteDescription=function(){const i=this;return this._onaddstreampoly||this.addEventListener("track",this._onaddstreampoly=function(n){n.streams.forEach(o=>{if(i._remoteStreams||(i._remoteStreams=[]),i._remoteStreams.indexOf(o)>=0)return;i._remoteStreams.push(o);const r=new Event("addstream");r.stream=o,i.dispatchEvent(r)})}),t.apply(i,arguments)}}}function BS(s){if(typeof s!="object"||!s.RTCPeerConnection)return;const t=s.RTCPeerConnection.prototype,e=t.createOffer,i=t.createAnswer,n=t.setLocalDescription,o=t.setRemoteDescription,r=t.addIceCandidate;t.createOffer=function(h,d){const u=arguments.length>=2?arguments[2]:arguments[0],f=e.apply(this,[u]);return d?(f.then(h,d),Promise.resolve()):f},t.createAnswer=function(h,d){const u=arguments.length>=2?arguments[2]:arguments[0],f=i.apply(this,[u]);return d?(f.then(h,d),Promise.resolve()):f};let l=function(c,h,d){const u=n.apply(this,[c]);return d?(u.then(h,d),Promise.resolve()):u};t.setLocalDescription=l,l=function(c,h,d){const u=o.apply(this,[c]);return d?(u.then(h,d),Promise.resolve()):u},t.setRemoteDescription=l,l=function(c,h,d){const u=r.apply(this,[c]);return d?(u.then(h,d),Promise.resolve()):u},t.addIceCandidate=l}function FS(s){const t=s&&s.navigator;if(t.mediaDevices&&t.mediaDevices.getUserMedia){const e=t.mediaDevices,i=e.getUserMedia.bind(e);t.mediaDevices.getUserMedia=n=>i(zS(n))}!t.getUserMedia&&t.mediaDevices&&t.mediaDevices.getUserMedia&&(t.getUserMedia=function(i,n,o){t.mediaDevices.getUserMedia(i).then(n,o)}.bind(t))}function zS(s){return s&&s.video!==void 0?Object.assign({},s,{video:hS(s.video)}):s}function US(s){if(!s.RTCPeerConnection)return;const t=s.RTCPeerConnection;s.RTCPeerConnection=function(i,n){if(i&&i.iceServers){const o=[];for(let r=0;r<i.iceServers.length;r++){let l=i.iceServers[r];!l.hasOwnProperty("urls")&&l.hasOwnProperty("url")?(jp("RTCIceServer.url","RTCIceServer.urls"),l=JSON.parse(JSON.stringify(l)),l.urls=l.url,delete l.url,o.push(l)):o.push(i.iceServers[r])}i.iceServers=o}return new t(i,n)},s.RTCPeerConnection.prototype=t.prototype,"generateCertificate"in t&&Object.defineProperty(s.RTCPeerConnection,"generateCertificate",{get(){return t.generateCertificate}})}function NS(s){typeof s=="object"&&s.RTCTrackEvent&&"receiver"in s.RTCTrackEvent.prototype&&!("transceiver"in s.RTCTrackEvent.prototype)&&Object.defineProperty(s.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function $S(s){const t=s.RTCPeerConnection.prototype.createOffer;s.RTCPeerConnection.prototype.createOffer=function(i){if(i){typeof i.offerToReceiveAudio<"u"&&(i.offerToReceiveAudio=!!i.offerToReceiveAudio);const n=this.getTransceivers().find(r=>r.receiver.track.kind==="audio");i.offerToReceiveAudio===!1&&n?n.direction==="sendrecv"?n.setDirection?n.setDirection("sendonly"):n.direction="sendonly":n.direction==="recvonly"&&(n.setDirection?n.setDirection("inactive"):n.direction="inactive"):i.offerToReceiveAudio===!0&&!n&&this.addTransceiver("audio"),typeof i.offerToReceiveVideo<"u"&&(i.offerToReceiveVideo=!!i.offerToReceiveVideo);const o=this.getTransceivers().find(r=>r.receiver.track.kind==="video");i.offerToReceiveVideo===!1&&o?o.direction==="sendrecv"?o.setDirection?o.setDirection("sendonly"):o.direction="sendonly":o.direction==="recvonly"&&(o.setDirection?o.setDirection("inactive"):o.direction="inactive"):i.offerToReceiveVideo===!0&&!o&&this.addTransceiver("video")}return t.apply(this,arguments)}}function WS(s){typeof s!="object"||s.AudioContext||(s.AudioContext=s.webkitAudioContext)}const Q0=Object.freeze(Object.defineProperty({__proto__:null,shimAudioContext:WS,shimCallbacksAPI:BS,shimConstraints:zS,shimCreateOfferLegacy:$S,shimGetUserMedia:FS,shimLocalStreamsAPI:LS,shimRTCIceServerUrls:US,shimRemoteStreamsAPI:jS,shimTrackEventTransceiver:NS},Symbol.toStringTag,{value:"Module"}));function Ju(s){if(!s.RTCIceCandidate||s.RTCIceCandidate&&"foundation"in s.RTCIceCandidate.prototype)return;const t=s.RTCIceCandidate;s.RTCIceCandidate=function(i){if(typeof i=="object"&&i.candidate&&i.candidate.indexOf("a=")===0&&(i=JSON.parse(JSON.stringify(i)),i.candidate=i.candidate.substr(2)),i.candidate&&i.candidate.length){const n=new t(i),o=Ku.parseCandidate(i.candidate),r=Object.assign(n,o);return r.toJSON=function(){return{candidate:r.candidate,sdpMid:r.sdpMid,sdpMLineIndex:r.sdpMLineIndex,usernameFragment:r.usernameFragment}},r}return new t(i)},s.RTCIceCandidate.prototype=t.prototype,Mc(s,"icecandidate",e=>(e.candidate&&Object.defineProperty(e,"candidate",{value:new s.RTCIceCandidate(e.candidate),writable:"false"}),e))}function Rh(s,t){if(!s.RTCPeerConnection)return;"sctp"in s.RTCPeerConnection.prototype||Object.defineProperty(s.RTCPeerConnection.prototype,"sctp",{get(){return typeof this._sctp>"u"?null:this._sctp}});const e=function(l){if(!l||!l.sdp)return!1;const c=Ku.splitSections(l.sdp);return c.shift(),c.some(h=>{const d=Ku.parseMLine(h);return d&&d.kind==="application"&&d.protocol.indexOf("SCTP")!==-1})},i=function(l){const c=l.sdp.match(/mozilla...THIS_IS_SDPARTA-(\d+)/);if(c===null||c.length<2)return-1;const h=parseInt(c[1],10);return h!==h?-1:h},n=function(l){let c=65536;return t.browser==="firefox"&&(t.version<57?l===-1?c=16384:c=2147483637:t.version<60?c=t.version===57?65535:65536:c=2147483637),c},o=function(l,c){let h=65536;t.browser==="firefox"&&t.version===57&&(h=65535);const d=Ku.matchPrefix(l.sdp,"a=max-message-size:");return d.length>0?h=parseInt(d[0].substr(19),10):t.browser==="firefox"&&c!==-1&&(h=2147483637),h},r=s.RTCPeerConnection.prototype.setRemoteDescription;s.RTCPeerConnection.prototype.setRemoteDescription=function(){if(this._sctp=null,t.browser==="chrome"&&t.version>=76){const{sdpSemantics:c}=this.getConfiguration();c==="plan-b"&&Object.defineProperty(this,"sctp",{get(){return typeof this._sctp>"u"?null:this._sctp},enumerable:!0,configurable:!0})}if(e(arguments[0])){const c=i(arguments[0]),h=n(c),d=o(arguments[0],c);let u;h===0&&d===0?u=Number.POSITIVE_INFINITY:h===0||d===0?u=Math.max(h,d):u=Math.min(h,d);const f={};Object.defineProperty(f,"maxMessageSize",{get(){return u}}),this._sctp=f}return r.apply(this,arguments)}}function Oh(s){if(!(s.RTCPeerConnection&&"createDataChannel"in s.RTCPeerConnection.prototype))return;function t(i,n){const o=i.send;i.send=function(){const l=arguments[0],c=l.length||l.size||l.byteLength;if(i.readyState==="open"&&n.sctp&&c>n.sctp.maxMessageSize)throw new TypeError("Message too large (can send a maximum of "+n.sctp.maxMessageSize+" bytes)");return o.apply(i,arguments)}}const e=s.RTCPeerConnection.prototype.createDataChannel;s.RTCPeerConnection.prototype.createDataChannel=function(){const n=e.apply(this,arguments);return t(n,this),n},Mc(s,"datachannel",i=>(t(i.channel,i.target),i))}function Cy(s){if(!s.RTCPeerConnection||"connectionState"in s.RTCPeerConnection.prototype)return;const t=s.RTCPeerConnection.prototype;Object.defineProperty(t,"connectionState",{get(){return{completed:"connected",checking:"connecting"}[this.iceConnectionState]||this.iceConnectionState},enumerable:!0,configurable:!0}),Object.defineProperty(t,"onconnectionstatechange",{get(){return this._onconnectionstatechange||null},set(e){this._onconnectionstatechange&&(this.removeEventListener("connectionstatechange",this._onconnectionstatechange),delete this._onconnectionstatechange),e&&this.addEventListener("connectionstatechange",this._onconnectionstatechange=e)},enumerable:!0,configurable:!0}),["setLocalDescription","setRemoteDescription"].forEach(e=>{const i=t[e];t[e]=function(){return this._connectionstatechangepoly||(this._connectionstatechangepoly=n=>{const o=n.target;if(o._lastConnectionState!==o.connectionState){o._lastConnectionState=o.connectionState;const r=new Event("connectionstatechange",n);o.dispatchEvent(r)}return n},this.addEventListener("iceconnectionstatechange",this._connectionstatechangepoly)),i.apply(this,arguments)}})}function Py(s,t){if(!s.RTCPeerConnection||t.browser==="chrome"&&t.version>=71||t.browser==="safari"&&t.version>=605)return;const e=s.RTCPeerConnection.prototype.setRemoteDescription;s.RTCPeerConnection.prototype.setRemoteDescription=function(n){if(n&&n.sdp&&n.sdp.indexOf(`
a=extmap-allow-mixed`)!==-1){const o=n.sdp.split(`
`).filter(r=>r.trim()!=="a=extmap-allow-mixed").join(`
`);s.RTCSessionDescription&&n instanceof s.RTCSessionDescription?arguments[0]=new s.RTCSessionDescription({type:n.type,sdp:o}):n.sdp=o}return e.apply(this,arguments)}}function Zu(s,t){if(!(s.RTCPeerConnection&&s.RTCPeerConnection.prototype))return;const e=s.RTCPeerConnection.prototype.addIceCandidate;!e||e.length===0||(s.RTCPeerConnection.prototype.addIceCandidate=function(){return arguments[0]?(t.browser==="chrome"&&t.version<78||t.browser==="firefox"&&t.version<68||t.browser==="safari")&&arguments[0]&&arguments[0].candidate===""?Promise.resolve():e.apply(this,arguments):(arguments[1]&&arguments[1].apply(null),Promise.resolve())})}const ZT=Object.freeze(Object.defineProperty({__proto__:null,removeExtmapAllowMixed:Py,shimAddIceCandidateNullOrEmpty:Zu,shimConnectionState:Cy,shimMaxMessageSize:Rh,shimRTCIceCandidate:Ju,shimSendThrowTypeError:Oh},Symbol.toStringTag,{value:"Module"}));function ek({window:s}={},t={shimChrome:!0,shimFirefox:!0,shimEdge:!0,shimSafari:!0}){const e=z_,i=HT(s),n={browserDetails:i,commonShim:ZT,extractVersion:Ph,disableLog:WT,disableWarnings:VT};switch(i.browser){case"chrome":if(!V0||!xy||!t.shimChrome)return e("Chrome shim is not included in this adapter release."),n;if(i.version===null)return e("Chrome shim can not determine version, not shimming."),n;e("adapter.js shimming chrome."),n.browserShim=V0,Zu(s,i),dS(s,i),uS(s),xy(s,i),fS(s),_S(s,i),pS(s),mS(s),gS(s),bS(s,i),Ju(s),Cy(s),Rh(s,i),Oh(s),Py(s,i);break;case"firefox":if(!X0||!Sy||!t.shimFirefox)return e("Firefox shim is not included in this adapter release."),n;e("adapter.js shimming firefox."),n.browserShim=X0,Zu(s,i),PS(s,i),Sy(s,i),RS(s),kS(s),OS(s),TS(s),ES(s),MS(s),AS(s),IS(s),DS(s),Ju(s),Cy(s),Rh(s,i),Oh(s);break;case"edge":if(!q0||!wy||!t.shimEdge)return e("MS edge shim is not included in this adapter release."),n;e("adapter.js shimming edge."),n.browserShim=q0,wS(s),SS(s),wy(s,i),CS(s),Rh(s,i),Oh(s);break;case"safari":if(!Q0||!t.shimSafari)return e("Safari shim is not included in this adapter release."),n;e("adapter.js shimming safari."),n.browserShim=Q0,Zu(s,i),US(s),$S(s),BS(s),LS(s),jS(s),NS(s),FS(s),WS(s),Ju(s),Rh(s,i),Oh(s),Py(s,i);break;default:e("Unsupported browser!");break}return n}const Y0=ek({window:typeof window>"u"?void 0:window});function Ks(s,t,e,i){Object.defineProperty(s,t,{get:e,set:i,enumerable:!0,configurable:!0})}var eg=Y0.default||Y0,lh=new(function(){function s(){this.isIOS=["iPad","iPhone","iPod"].includes(navigator.platform),this.supportedBrowsers=["firefox","chrome","safari"],this.minFirefoxVersion=59,this.minChromeVersion=72,this.minSafariVersion=605}return s.prototype.isWebRTCSupported=function(){return typeof RTCPeerConnection<"u"},s.prototype.isBrowserSupported=function(){var t=this.getBrowser(),e=this.getVersion(),i=this.supportedBrowsers.includes(t);return i?t==="chrome"?e>=this.minChromeVersion:t==="firefox"?e>=this.minFirefoxVersion:t==="safari"?!this.isIOS&&e>=this.minSafariVersion:!1:!1},s.prototype.getBrowser=function(){return eg.browserDetails.browser},s.prototype.getVersion=function(){return eg.browserDetails.version||0},s.prototype.isUnifiedPlanSupported=function(){var t=this.getBrowser(),e=eg.browserDetails.version||0;if(t==="chrome"&&e<this.minChromeVersion)return!1;if(t==="firefox"&&e>=this.minFirefoxVersion)return!0;if(!window.RTCRtpTransceiver||!("currentDirection"in RTCRtpTransceiver.prototype))return!1;var i,n=!1;try{i=new RTCPeerConnection,i.addTransceiver("audio"),n=!0}catch{}finally{i&&i.close()}return n},s.prototype.toString=function(){return`Supports:
    browser:`.concat(this.getBrowser(),`
    version:`).concat(this.getVersion(),`
    isIOS:`).concat(this.isIOS,`
    isWebRTCSupported:`).concat(this.isWebRTCSupported(),`
    isBrowserSupported:`).concat(this.isBrowserSupported(),`
    isUnifiedPlanSupported:`).concat(this.isUnifiedPlanSupported())},s}()),K0={iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:["turn:eu-0.turn.peerjs.com:3478","turn:us-0.turn.peerjs.com:3478"],username:"peerjs",credential:"peerjsp"}],sdpSemantics:"unified-plan"},tk=function(){function s(){this.CLOUD_HOST="0.peerjs.com",this.CLOUD_PORT=443,this.chunkedBrowsers={Chrome:1,chrome:1},this.chunkedMTU=16300,this.defaultConfig=K0,this.browser=lh.getBrowser(),this.browserVersion=lh.getVersion(),this.supports=function(){var t={browser:lh.isBrowserSupported(),webRTC:lh.isWebRTCSupported(),audioVideo:!1,data:!1,binaryBlob:!1,reliable:!1};if(!t.webRTC)return t;var e;try{e=new RTCPeerConnection(K0),t.audioVideo=!0;var i=void 0;try{i=e.createDataChannel("_PEERJSTEST",{ordered:!0}),t.data=!0,t.reliable=!!i.ordered;try{i.binaryType="blob",t.binaryBlob=!lh.isIOS}catch{}}catch{}finally{i&&i.close()}}catch{}finally{e&&e.close()}return t}(),this.pack=U0.pack,this.unpack=U0.unpack,this._dataCount=1}return s.prototype.noop=function(){},s.prototype.validateId=function(t){return!t||/^[A-Za-z0-9]+(?:[ _-][A-Za-z0-9]+)*$/.test(t)},s.prototype.chunk=function(t){for(var e=[],i=t.size,n=Math.ceil(i/Ce.chunkedMTU),o=0,r=0;r<i;){var l=Math.min(i,r+Ce.chunkedMTU),c=t.slice(r,l),h={__peerData:this._dataCount,n:o,data:c,total:n};e.push(h),r=l,o++}return this._dataCount++,e},s.prototype.blobToArrayBuffer=function(t,e){var i=new FileReader;return i.onload=function(n){n.target&&e(n.target.result)},i.readAsArrayBuffer(t),i},s.prototype.binaryStringToArrayBuffer=function(t){for(var e=new Uint8Array(t.length),i=0;i<t.length;i++)e[i]=t.charCodeAt(i)&255;return e.buffer},s.prototype.randomToken=function(){return Math.random().toString(36).slice(2)},s.prototype.isSecure=function(){return location.protocol==="https:"},s}(),Ce=new tk,VS={};Ks(VS,"Peer",()=>Ty,s=>Ty=s);var Bd={},ik=Object.prototype.hasOwnProperty,Ai="~";function Sd(){}Object.create&&(Sd.prototype=Object.create(null),new Sd().__proto__||(Ai=!1));function nk(s,t,e){this.fn=s,this.context=t,this.once=e||!1}function HS(s,t,e,i,n){if(typeof e!="function")throw new TypeError("The listener must be a function");var o=new nk(e,i||s,n),r=Ai?Ai+t:t;return s._events[r]?s._events[r].fn?s._events[r]=[s._events[r],o]:s._events[r].push(o):(s._events[r]=o,s._eventsCount++),s}function ef(s,t){--s._eventsCount===0?s._events=new Sd:delete s._events[t]}function fi(){this._events=new Sd,this._eventsCount=0}fi.prototype.eventNames=function(){var t=[],e,i;if(this._eventsCount===0)return t;for(i in e=this._events)ik.call(e,i)&&t.push(Ai?i.slice(1):i);return Object.getOwnPropertySymbols?t.concat(Object.getOwnPropertySymbols(e)):t};fi.prototype.listeners=function(t){var e=Ai?Ai+t:t,i=this._events[e];if(!i)return[];if(i.fn)return[i.fn];for(var n=0,o=i.length,r=new Array(o);n<o;n++)r[n]=i[n].fn;return r};fi.prototype.listenerCount=function(t){var e=Ai?Ai+t:t,i=this._events[e];return i?i.fn?1:i.length:0};fi.prototype.emit=function(t,e,i,n,o,r){var l=Ai?Ai+t:t;if(!this._events[l])return!1;var c=this._events[l],h=arguments.length,d,u;if(c.fn){switch(c.once&&this.removeListener(t,c.fn,void 0,!0),h){case 1:return c.fn.call(c.context),!0;case 2:return c.fn.call(c.context,e),!0;case 3:return c.fn.call(c.context,e,i),!0;case 4:return c.fn.call(c.context,e,i,n),!0;case 5:return c.fn.call(c.context,e,i,n,o),!0;case 6:return c.fn.call(c.context,e,i,n,o,r),!0}for(u=1,d=new Array(h-1);u<h;u++)d[u-1]=arguments[u];c.fn.apply(c.context,d)}else{var f=c.length,p;for(u=0;u<f;u++)switch(c[u].once&&this.removeListener(t,c[u].fn,void 0,!0),h){case 1:c[u].fn.call(c[u].context);break;case 2:c[u].fn.call(c[u].context,e);break;case 3:c[u].fn.call(c[u].context,e,i);break;case 4:c[u].fn.call(c[u].context,e,i,n);break;default:if(!d)for(p=1,d=new Array(h-1);p<h;p++)d[p-1]=arguments[p];c[u].fn.apply(c[u].context,d)}}return!0};fi.prototype.on=function(t,e,i){return HS(this,t,e,i,!1)};fi.prototype.once=function(t,e,i){return HS(this,t,e,i,!0)};fi.prototype.removeListener=function(t,e,i,n){var o=Ai?Ai+t:t;if(!this._events[o])return this;if(!e)return ef(this,o),this;var r=this._events[o];if(r.fn)r.fn===e&&(!n||r.once)&&(!i||r.context===i)&&ef(this,o);else{for(var l=0,c=[],h=r.length;l<h;l++)(r[l].fn!==e||n&&!r[l].once||i&&r[l].context!==i)&&c.push(r[l]);c.length?this._events[o]=c.length===1?c[0]:c:ef(this,o)}return this};fi.prototype.removeAllListeners=function(t){var e;return t?(e=Ai?Ai+t:t,this._events[e]&&ef(this,e)):(this._events=new Sd,this._eventsCount=0),this};fi.prototype.off=fi.prototype.removeListener;fi.prototype.addListener=fi.prototype.on;fi.prefixed=Ai;fi.EventEmitter=fi;Bd=fi;var K={};Ks(K,"LogLevel",()=>zi,s=>zi=s);Ks(K,"default",()=>J0,s=>J0=s);var la=function(s,t){var e=typeof Symbol=="function"&&s[Symbol.iterator];if(!e)return s;var i=e.call(s),n,o=[],r;try{for(;(t===void 0||t-- >0)&&!(n=i.next()).done;)o.push(n.value)}catch(l){r={error:l}}finally{try{n&&!n.done&&(e=i.return)&&e.call(i)}finally{if(r)throw r.error}}return o},ca=function(s,t,e){if(e||arguments.length===2)for(var i=0,n=t.length,o;i<n;i++)(o||!(i in t))&&(o||(o=Array.prototype.slice.call(t,0,i)),o[i]=t[i]);return s.concat(o||Array.prototype.slice.call(t))},sk="PeerJS: ",zi;(function(s){s[s.Disabled=0]="Disabled",s[s.Errors=1]="Errors",s[s.Warnings=2]="Warnings",s[s.All=3]="All"})(zi||(zi={}));var ok=function(){function s(){this._logLevel=zi.Disabled}return Object.defineProperty(s.prototype,"logLevel",{get:function(){return this._logLevel},set:function(t){this._logLevel=t},enumerable:!1,configurable:!0}),s.prototype.log=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];this._logLevel>=zi.All&&this._print.apply(this,ca([zi.All],la(t),!1))},s.prototype.warn=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];this._logLevel>=zi.Warnings&&this._print.apply(this,ca([zi.Warnings],la(t),!1))},s.prototype.error=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];this._logLevel>=zi.Errors&&this._print.apply(this,ca([zi.Errors],la(t),!1))},s.prototype.setLogFunction=function(t){this._print=t},s.prototype._print=function(t){for(var e=[],i=1;i<arguments.length;i++)e[i-1]=arguments[i];var n=ca([sk],la(e),!1);for(var o in n)n[o]instanceof Error&&(n[o]="("+n[o].name+") "+n[o].message);t>=zi.All?console.log.apply(console,ca([],la(n),!1)):t>=zi.Warnings?console.warn.apply(console,ca(["WARNING"],la(n),!1)):t>=zi.Errors&&console.error.apply(console,ca(["ERROR"],la(n),!1))},s}(),J0=new ok,GS={};Ks(GS,"Socket",()=>Z0,s=>Z0=s);var Kn;(function(s){s.Data="data",s.Media="media"})(Kn||(Kn={}));var ut;(function(s){s.BrowserIncompatible="browser-incompatible",s.Disconnected="disconnected",s.InvalidID="invalid-id",s.InvalidKey="invalid-key",s.Network="network",s.PeerUnavailable="peer-unavailable",s.SslUnavailable="ssl-unavailable",s.ServerError="server-error",s.SocketError="socket-error",s.SocketClosed="socket-closed",s.UnavailableID="unavailable-id",s.WebRTC="webrtc"})(ut||(ut={}));var ho;(function(s){s.Binary="binary",s.BinaryUTF8="binary-utf8",s.JSON="json"})(ho||(ho={}));var Co;(function(s){s.Message="message",s.Disconnected="disconnected",s.Error="error",s.Close="close"})(Co||(Co={}));var Gt;(function(s){s.Heartbeat="HEARTBEAT",s.Candidate="CANDIDATE",s.Offer="OFFER",s.Answer="ANSWER",s.Open="OPEN",s.Error="ERROR",s.IdTaken="ID-TAKEN",s.InvalidKey="INVALID-KEY",s.Leave="LEAVE",s.Expire="EXPIRE"})(Gt||(Gt={}));var U_={};U_=JSON.parse('{"name":"peerjs","version":"1.4.7","keywords":["peerjs","webrtc","p2p","rtc"],"description":"PeerJS client","homepage":"https://peerjs.com","bugs":{"url":"https://github.com/peers/peerjs/issues"},"repository":{"type":"git","url":"https://github.com/peers/peerjs"},"license":"MIT","contributors":["Michelle Bu <michelle@michellebu.com>","afrokick <devbyru@gmail.com>","ericz <really.ez@gmail.com>","Jairo <kidandcat@gmail.com>","Jonas Gloning <34194370+jonasgloning@users.noreply.github.com>","Jairo Caro-Accino Viciana <jairo@galax.be>","Carlos Caballero <carlos.caballero.gonzalez@gmail.com>","hc <hheennrryy@gmail.com>","Muhammad Asif <capripio@gmail.com>","PrashoonB <prashoonbhattacharjee@gmail.com>","Harsh Bardhan Mishra <47351025+HarshCasper@users.noreply.github.com>","akotynski <aleksanderkotbury@gmail.com>","lmb <i@lmb.io>","Jairooo <jairocaro@msn.com>","Moritz St√ºckler <moritz.stueckler@gmail.com>","Simon <crydotsnakegithub@gmail.com>","Denis Lukov <denismassters@gmail.com>","Philipp Hancke <fippo@andyet.net>","Hans Oksendahl <hansoksendahl@gmail.com>","Jess <jessachandler@gmail.com>","khankuan <khankuan@gmail.com>","DUODVK <kurmanov.work@gmail.com>","XiZhao <kwang1imsa@gmail.com>","Matthias Lohr <matthias@lohr.me>","=frank tree <=frnktrb@googlemail.com>","Andre Eckardt <aeckardt@outlook.com>","Chris Cowan <agentme49@gmail.com>","Alex Chuev <alex@chuev.com>","alxnull <alxnull@e.mail.de>","Yemel Jardi <angel.jardi@gmail.com>","Ben Parnell <benjaminparnell.94@gmail.com>","Benny Lichtner <bennlich@gmail.com>","fresheneesz <bitetrudpublic@gmail.com>","bob.barstead@exaptive.com <bob.barstead@exaptive.com>","chandika <chandika@gmail.com>","emersion <contact@emersion.fr>","Christopher Van <cvan@users.noreply.github.com>","eddieherm <edhermoso@gmail.com>","Eduardo Pinho <enet4mikeenet@gmail.com>","Evandro Zanatta <ezanatta@tray.net.br>","Gardner Bickford <gardner@users.noreply.github.com>","Gian Luca <gianluca.cecchi@cynny.com>","PatrickJS <github@gdi2290.com>","jonnyf <github@jonathanfoss.co.uk>","Hizkia Felix <hizkifw@gmail.com>","Hristo Oskov <hristo.oskov@gmail.com>","Isaac Madwed <i.madwed@gmail.com>","Ilya Konanykhin <ilya.konanykhin@gmail.com>","jasonbarry <jasbarry@me.com>","Jonathan Burke <jonathan.burke.1311@googlemail.com>","Josh Hamit <josh.hamit@gmail.com>","Jordan Austin <jrax86@gmail.com>","Joel Wetzell <jwetzell@yahoo.com>","xizhao <kevin.wang@cloudera.com>","Alberto Torres <kungfoobar@gmail.com>","Jonathan Mayol <mayoljonathan@gmail.com>","Jefferson Felix <me@jsfelix.dev>","Rolf Erik Lekang <me@rolflekang.com>","Kevin Mai-Husan Chia <mhchia@users.noreply.github.com>","Pepijn de Vos <pepijndevos@gmail.com>","JooYoung <qkdlql@naver.com>","Tobias Speicher <rootcommander@gmail.com>","Steve Blaurock <sblaurock@gmail.com>","Kyrylo Shegeda <shegeda@ualberta.ca>","Diwank Singh Tomer <singh@diwank.name>","SoÃàren Balko <Soeren.Balko@gmail.com>","Arpit Solanki <solankiarpit1997@gmail.com>","Yuki Ito <yuki@gnnk.net>","Artur Zayats <zag2art@gmail.com>"],"funding":{"type":"opencollective","url":"https://opencollective.com/peer"},"collective":{"type":"opencollective","url":"https://opencollective.com/peer"},"files":["dist/*"],"sideEffects":["lib/global.ts","lib/supports.ts"],"main":"dist/bundler.cjs","module":"dist/bundler.mjs","browser-minified":"dist/peerjs.min.js","browser-unminified":"dist/peerjs.js","types":"dist/types.d.ts","engines":{"node":">= 10"},"targets":{"types":{"source":"lib/exports.ts"},"main":{"source":"lib/exports.ts","sourceMap":{"inlineSources":true}},"module":{"source":"lib/exports.ts","includeNodeModules":["eventemitter3"],"sourceMap":{"inlineSources":true}},"browser-minified":{"context":"browser","outputFormat":"global","optimize":true,"engines":{"browsers":"cover 99%, not dead"},"source":"lib/global.ts"},"browser-unminified":{"context":"browser","outputFormat":"global","optimize":false,"engines":{"browsers":"cover 99%, not dead"},"source":"lib/global.ts"}},"scripts":{"contributors":"git-authors-cli --print=false && prettier --write package.json && git add package.json package-lock.json && git commit -m \\"chore(contributors): update and sort contributors list\\"","check":"tsc --noEmit","watch":"parcel watch","build":"rm -rf dist && parcel build","prepublishOnly":"npm run build","test":"mocha -r ts-node/register -r jsdom-global/register test/**/*.ts","format":"prettier --write .","semantic-release":"semantic-release"},"devDependencies":{"@parcel/config-default":"^2.5.0","@parcel/packager-ts":"^2.5.0","@parcel/transformer-typescript-tsc":"^2.5.0","@parcel/transformer-typescript-types":"^2.5.0","@semantic-release/changelog":"^6.0.1","@semantic-release/git":"^10.0.1","@types/chai":"^4.3.0","@types/mocha":"^9.1.0","@types/node":"^17.0.18","chai":"^4.3.6","git-authors-cli":"^1.0.40","jsdom":"^19.0.0","jsdom-global":"^3.0.2","mocha":"^9.2.0","mock-socket":"8.0.5","parcel":"^2.5.0","parcel-transformer-tsc-sourcemaps":"^1.0.2","prettier":"^2.6.2","semantic-release":"^19.0.2","standard":"^16.0.4","ts-node":"^10.5.0","typescript":"^4.5.5"},"dependencies":{"@swc/helpers":"^0.3.13","eventemitter3":"^4.0.7","peerjs-js-binarypack":"1.0.1","webrtc-adapter":"^7.7.1"}}');var rk=function(){var s=function(t,e){return s=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(i,n){i.__proto__=n}||function(i,n){for(var o in n)Object.prototype.hasOwnProperty.call(n,o)&&(i[o]=n[o])},s(t,e)};return function(t,e){if(typeof e!="function"&&e!==null)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");s(t,e);function i(){this.constructor=t}t.prototype=e===null?Object.create(e):(i.prototype=e.prototype,new i)}}(),ak=function(s,t){var e=typeof Symbol=="function"&&s[Symbol.iterator];if(!e)return s;var i=e.call(s),n,o=[],r;try{for(;(t===void 0||t-- >0)&&!(n=i.next()).done;)o.push(n.value)}catch(l){r={error:l}}finally{try{n&&!n.done&&(e=i.return)&&e.call(i)}finally{if(r)throw r.error}}return o},lk=function(s,t,e){if(e||arguments.length===2)for(var i=0,n=t.length,o;i<n;i++)(o||!(i in t))&&(o||(o=Array.prototype.slice.call(t,0,i)),o[i]=t[i]);return s.concat(o||Array.prototype.slice.call(t))},ck=function(s){var t=typeof Symbol=="function"&&Symbol.iterator,e=t&&s[t],i=0;if(e)return e.call(s);if(s&&typeof s.length=="number")return{next:function(){return s&&i>=s.length&&(s=void 0),{value:s&&s[i++],done:!s}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")},Z0=function(s){rk(t,s);function t(e,i,n,o,r,l){l===void 0&&(l=5e3);var c=s.call(this)||this;c.pingInterval=l,c._disconnected=!0,c._messagesQueue=[];var h=e?"wss://":"ws://";return c._baseUrl=h+i+":"+n+o+"peerjs?key="+r,c}return t.prototype.start=function(e,i){var n=this;this._id=e;var o="".concat(this._baseUrl,"&id=").concat(e,"&token=").concat(i);this._socket||!this._disconnected||(this._socket=new WebSocket(o+"&version="+U_.version),this._disconnected=!1,this._socket.onmessage=function(r){var l;try{l=JSON.parse(r.data),K.default.log("Server message received:",l)}catch{K.default.log("Invalid server message",r.data);return}n.emit(Co.Message,l)},this._socket.onclose=function(r){n._disconnected||(K.default.log("Socket closed.",r),n._cleanup(),n._disconnected=!0,n.emit(Co.Disconnected))},this._socket.onopen=function(){n._disconnected||(n._sendQueuedMessages(),K.default.log("Socket open"),n._scheduleHeartbeat())})},t.prototype._scheduleHeartbeat=function(){var e=this;this._wsPingTimer=setTimeout(function(){e._sendHeartbeat()},this.pingInterval)},t.prototype._sendHeartbeat=function(){if(!this._wsOpen()){K.default.log("Cannot send heartbeat, because socket closed");return}var e=JSON.stringify({type:Gt.Heartbeat});this._socket.send(e),this._scheduleHeartbeat()},t.prototype._wsOpen=function(){return!!this._socket&&this._socket.readyState===1},t.prototype._sendQueuedMessages=function(){var e,i,n=lk([],ak(this._messagesQueue),!1);this._messagesQueue=[];try{for(var o=ck(n),r=o.next();!r.done;r=o.next()){var l=r.value;this.send(l)}}catch(c){e={error:c}}finally{try{r&&!r.done&&(i=o.return)&&i.call(o)}finally{if(e)throw e.error}}},t.prototype.send=function(e){if(!this._disconnected){if(!this._id){this._messagesQueue.push(e);return}if(!e.type){this.emit(Co.Error,"Invalid message");return}if(this._wsOpen()){var i=JSON.stringify(e);this._socket.send(i)}}},t.prototype.close=function(){this._disconnected||(this._cleanup(),this._disconnected=!0)},t.prototype._cleanup=function(){this._socket&&(this._socket.onopen=this._socket.onmessage=this._socket.onclose=null,this._socket.close(),this._socket=void 0),clearTimeout(this._wsPingTimer)},t}(Bd.EventEmitter),Ry={};Ks(Ry,"MediaConnection",()=>iv,s=>iv=s);var N_={};Ks(N_,"Negotiator",()=>ev,s=>ev=s);var wf=function(){return wf=Object.assign||function(s){for(var t,e=1,i=arguments.length;e<i;e++){t=arguments[e];for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(s[n]=t[n])}return s},wf.apply(this,arguments)},gu=function(s,t,e,i){function n(o){return o instanceof e?o:new e(function(r){r(o)})}return new(e||(e=Promise))(function(o,r){function l(d){try{h(i.next(d))}catch(u){r(u)}}function c(d){try{h(i.throw(d))}catch(u){r(u)}}function h(d){d.done?o(d.value):n(d.value).then(l,c)}h((i=i.apply(s,t||[])).next())})},yu=function(s,t){var e={label:0,sent:function(){if(o[0]&1)throw o[1];return o[1]},trys:[],ops:[]},i,n,o,r;return r={next:l(0),throw:l(1),return:l(2)},typeof Symbol=="function"&&(r[Symbol.iterator]=function(){return this}),r;function l(h){return function(d){return c([h,d])}}function c(h){if(i)throw new TypeError("Generator is already executing.");for(;e;)try{if(i=1,n&&(o=h[0]&2?n.return:h[0]?n.throw||((o=n.return)&&o.call(n),0):n.next)&&!(o=o.call(n,h[1])).done)return o;switch(n=0,o&&(h=[h[0]&2,o.value]),h[0]){case 0:case 1:o=h;break;case 4:return e.label++,{value:h[1],done:!1};case 5:e.label++,n=h[1],h=[0];continue;case 7:h=e.ops.pop(),e.trys.pop();continue;default:if(o=e.trys,!(o=o.length>0&&o[o.length-1])&&(h[0]===6||h[0]===2)){e=0;continue}if(h[0]===3&&(!o||h[1]>o[0]&&h[1]<o[3])){e.label=h[1];break}if(h[0]===6&&e.label<o[1]){e.label=o[1],o=h;break}if(o&&e.label<o[2]){e.label=o[2],e.ops.push(h);break}o[2]&&e.ops.pop(),e.trys.pop();continue}h=t.call(s,e)}catch(d){h=[6,d],n=0}finally{i=o=0}if(h[0]&5)throw h[1];return{value:h[0]?h[1]:void 0,done:!0}}},ev=function(){function s(t){this.connection=t}return s.prototype.startConnection=function(t){var e=this._startPeerConnection();if(this.connection.peerConnection=e,this.connection.type===Kn.Media&&t._stream&&this._addTracksToConnection(t._stream,e),t.originator){if(this.connection.type===Kn.Data){var i=this.connection,n={ordered:!!t.reliable},o=e.createDataChannel(i.label,n);i.initialize(o)}this._makeOffer()}else this.handleSDP("OFFER",t.sdp)},s.prototype._startPeerConnection=function(){K.default.log("Creating RTCPeerConnection.");var t=new RTCPeerConnection(this.connection.provider.options.config);return this._setupListeners(t),t},s.prototype._setupListeners=function(t){var e=this,i=this.connection.peer,n=this.connection.connectionId,o=this.connection.type,r=this.connection.provider;K.default.log("Listening for ICE candidates."),t.onicecandidate=function(l){!l.candidate||!l.candidate.candidate||(K.default.log("Received ICE candidates for ".concat(i,":"),l.candidate),r.socket.send({type:Gt.Candidate,payload:{candidate:l.candidate,type:o,connectionId:n},dst:i}))},t.oniceconnectionstatechange=function(){switch(t.iceConnectionState){case"failed":K.default.log("iceConnectionState is failed, closing connections to "+i),e.connection.emit("error",new Error("Negotiation of connection to "+i+" failed.")),e.connection.close();break;case"closed":K.default.log("iceConnectionState is closed, closing connections to "+i),e.connection.emit("error",new Error("Connection to "+i+" closed.")),e.connection.close();break;case"disconnected":K.default.log("iceConnectionState changed to disconnected on the connection with "+i);break;case"completed":t.onicecandidate=Ce.noop;break}e.connection.emit("iceStateChanged",t.iceConnectionState)},K.default.log("Listening for data channel"),t.ondatachannel=function(l){K.default.log("Received data channel");var c=l.channel,h=r.getConnection(i,n);h.initialize(c)},K.default.log("Listening for remote stream"),t.ontrack=function(l){K.default.log("Received remote stream");var c=l.streams[0],h=r.getConnection(i,n);if(h.type===Kn.Media){var d=h;e._addStreamToMediaConnection(c,d)}}},s.prototype.cleanup=function(){K.default.log("Cleaning up PeerConnection to "+this.connection.peer);var t=this.connection.peerConnection;if(t){this.connection.peerConnection=null,t.onicecandidate=t.oniceconnectionstatechange=t.ondatachannel=t.ontrack=function(){};var e=t.signalingState!=="closed",i=!1;if(this.connection.type===Kn.Data){var n=this.connection,o=n.dataChannel;o&&(i=!!o.readyState&&o.readyState!=="closed")}(e||i)&&t.close()}},s.prototype._makeOffer=function(){return gu(this,void 0,Promise,function(){var t,e,i,n,o,r,l;return yu(this,function(c){switch(c.label){case 0:t=this.connection.peerConnection,e=this.connection.provider,c.label=1;case 1:return c.trys.push([1,7,,8]),[4,t.createOffer(this.connection.options.constraints)];case 2:i=c.sent(),K.default.log("Created offer."),this.connection.options.sdpTransform&&typeof this.connection.options.sdpTransform=="function"&&(i.sdp=this.connection.options.sdpTransform(i.sdp)||i.sdp),c.label=3;case 3:return c.trys.push([3,5,,6]),[4,t.setLocalDescription(i)];case 4:return c.sent(),K.default.log("Set localDescription:",i,"for:".concat(this.connection.peer)),n={sdp:i,type:this.connection.type,connectionId:this.connection.connectionId,metadata:this.connection.metadata,browser:Ce.browser},this.connection.type===Kn.Data&&(o=this.connection,n=wf(wf({},n),{label:o.label,reliable:o.reliable,serialization:o.serialization})),e.socket.send({type:Gt.Offer,payload:n,dst:this.connection.peer}),[3,6];case 5:return r=c.sent(),r!="OperationError: Failed to set local offer sdp: Called in wrong state: kHaveRemoteOffer"&&(e.emitError(ut.WebRTC,r),K.default.log("Failed to setLocalDescription, ",r)),[3,6];case 6:return[3,8];case 7:return l=c.sent(),e.emitError(ut.WebRTC,l),K.default.log("Failed to createOffer, ",l),[3,8];case 8:return[2]}})})},s.prototype._makeAnswer=function(){return gu(this,void 0,Promise,function(){var t,e,i,n,o;return yu(this,function(r){switch(r.label){case 0:t=this.connection.peerConnection,e=this.connection.provider,r.label=1;case 1:return r.trys.push([1,7,,8]),[4,t.createAnswer()];case 2:i=r.sent(),K.default.log("Created answer."),this.connection.options.sdpTransform&&typeof this.connection.options.sdpTransform=="function"&&(i.sdp=this.connection.options.sdpTransform(i.sdp)||i.sdp),r.label=3;case 3:return r.trys.push([3,5,,6]),[4,t.setLocalDescription(i)];case 4:return r.sent(),K.default.log("Set localDescription:",i,"for:".concat(this.connection.peer)),e.socket.send({type:Gt.Answer,payload:{sdp:i,type:this.connection.type,connectionId:this.connection.connectionId,browser:Ce.browser},dst:this.connection.peer}),[3,6];case 5:return n=r.sent(),e.emitError(ut.WebRTC,n),K.default.log("Failed to setLocalDescription, ",n),[3,6];case 6:return[3,8];case 7:return o=r.sent(),e.emitError(ut.WebRTC,o),K.default.log("Failed to create answer, ",o),[3,8];case 8:return[2]}})})},s.prototype.handleSDP=function(t,e){return gu(this,void 0,Promise,function(){var i,n,o,r;return yu(this,function(l){switch(l.label){case 0:e=new RTCSessionDescription(e),i=this.connection.peerConnection,n=this.connection.provider,K.default.log("Setting remote description",e),o=this,l.label=1;case 1:return l.trys.push([1,5,,6]),[4,i.setRemoteDescription(e)];case 2:return l.sent(),K.default.log("Set remoteDescription:".concat(t," for:").concat(this.connection.peer)),t!=="OFFER"?[3,4]:[4,o._makeAnswer()];case 3:l.sent(),l.label=4;case 4:return[3,6];case 5:return r=l.sent(),n.emitError(ut.WebRTC,r),K.default.log("Failed to setRemoteDescription, ",r),[3,6];case 6:return[2]}})})},s.prototype.handleCandidate=function(t){return gu(this,void 0,Promise,function(){var e,i,n,o,r,l;return yu(this,function(c){switch(c.label){case 0:K.default.log("handleCandidate:",t),e=t.candidate,i=t.sdpMLineIndex,n=t.sdpMid,o=this.connection.peerConnection,r=this.connection.provider,c.label=1;case 1:return c.trys.push([1,3,,4]),[4,o.addIceCandidate(new RTCIceCandidate({sdpMid:n,sdpMLineIndex:i,candidate:e}))];case 2:return c.sent(),K.default.log("Added ICE candidate for:".concat(this.connection.peer)),[3,4];case 3:return l=c.sent(),r.emitError(ut.WebRTC,l),K.default.log("Failed to handleCandidate, ",l),[3,4];case 4:return[2]}})})},s.prototype._addTracksToConnection=function(t,e){if(K.default.log("add tracks from stream ".concat(t.id," to peer connection")),!e.addTrack)return K.default.error("Your browser does't support RTCPeerConnection#addTrack. Ignored.");t.getTracks().forEach(function(i){e.addTrack(i,t)})},s.prototype._addStreamToMediaConnection=function(t,e){K.default.log("add stream ".concat(t.id," to media connection ").concat(e.connectionId)),e.addStream(t)},s}(),$_={};Ks($_,"BaseConnection",()=>tv,s=>tv=s);var hk=function(){var s=function(t,e){return s=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(i,n){i.__proto__=n}||function(i,n){for(var o in n)Object.prototype.hasOwnProperty.call(n,o)&&(i[o]=n[o])},s(t,e)};return function(t,e){if(typeof e!="function"&&e!==null)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");s(t,e);function i(){this.constructor=t}t.prototype=e===null?Object.create(e):(i.prototype=e.prototype,new i)}}(),tv=function(s){hk(t,s);function t(e,i,n){var o=s.call(this)||this;return o.peer=e,o.provider=i,o.options=n,o._open=!1,o.metadata=n.metadata,o}return Object.defineProperty(t.prototype,"open",{get:function(){return this._open},enumerable:!1,configurable:!0}),t}(Bd.EventEmitter),dk=function(){var s=function(t,e){return s=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(i,n){i.__proto__=n}||function(i,n){for(var o in n)Object.prototype.hasOwnProperty.call(n,o)&&(i[o]=n[o])},s(t,e)};return function(t,e){if(typeof e!="function"&&e!==null)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");s(t,e);function i(){this.constructor=t}t.prototype=e===null?Object.create(e):(i.prototype=e.prototype,new i)}}(),Sf=function(){return Sf=Object.assign||function(s){for(var t,e=1,i=arguments.length;e<i;e++){t=arguments[e];for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(s[n]=t[n])}return s},Sf.apply(this,arguments)},uk=function(s){var t=typeof Symbol=="function"&&Symbol.iterator,e=t&&s[t],i=0;if(e)return e.call(s);if(s&&typeof s.length=="number")return{next:function(){return s&&i>=s.length&&(s=void 0),{value:s&&s[i++],done:!s}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")},iv=function(s){dk(t,s);function t(e,i,n){var o=s.call(this,e,i,n)||this;return o._localStream=o.options._stream,o.connectionId=o.options.connectionId||t.ID_PREFIX+Ce.randomToken(),o._negotiator=new N_.Negotiator(o),o._localStream&&o._negotiator.startConnection({_stream:o._localStream,originator:!0}),o}return Object.defineProperty(t.prototype,"type",{get:function(){return Kn.Media},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"localStream",{get:function(){return this._localStream},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"remoteStream",{get:function(){return this._remoteStream},enumerable:!1,configurable:!0}),t.prototype.addStream=function(e){K.default.log("Receiving stream",e),this._remoteStream=e,s.prototype.emit.call(this,"stream",e)},t.prototype.handleMessage=function(e){var i=e.type,n=e.payload;switch(e.type){case Gt.Answer:this._negotiator.handleSDP(i,n.sdp),this._open=!0;break;case Gt.Candidate:this._negotiator.handleCandidate(n.candidate);break;default:K.default.warn("Unrecognized message type:".concat(i," from peer:").concat(this.peer));break}},t.prototype.answer=function(e,i){var n,o;if(i===void 0&&(i={}),this._localStream){K.default.warn("Local stream already exists on this MediaConnection. Are you answering a call twice?");return}this._localStream=e,i&&i.sdpTransform&&(this.options.sdpTransform=i.sdpTransform),this._negotiator.startConnection(Sf(Sf({},this.options._payload),{_stream:e}));var r=this.provider._getMessages(this.connectionId);try{for(var l=uk(r),c=l.next();!c.done;c=l.next()){var h=c.value;this.handleMessage(h)}}catch(d){n={error:d}}finally{try{c&&!c.done&&(o=l.return)&&o.call(l)}finally{if(n)throw n.error}}this._open=!0},t.prototype.close=function(){this._negotiator&&(this._negotiator.cleanup(),this._negotiator=null),this._localStream=null,this._remoteStream=null,this.provider&&(this.provider._removeConnection(this),this.provider=null),this.options&&this.options._stream&&(this.options._stream=null),this.open&&(this._open=!1,s.prototype.emit.call(this,"close"))},t.ID_PREFIX="mc_",t}($_.BaseConnection),Oy={};Ks(Oy,"DataConnection",()=>sv,s=>sv=s);var qS={};Ks(qS,"EncodingQueue",()=>nv,s=>nv=s);var fk=function(){var s=function(t,e){return s=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(i,n){i.__proto__=n}||function(i,n){for(var o in n)Object.prototype.hasOwnProperty.call(n,o)&&(i[o]=n[o])},s(t,e)};return function(t,e){if(typeof e!="function"&&e!==null)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");s(t,e);function i(){this.constructor=t}t.prototype=e===null?Object.create(e):(i.prototype=e.prototype,new i)}}(),nv=function(s){fk(t,s);function t(){var e=s.call(this)||this;return e.fileReader=new FileReader,e._queue=[],e._processing=!1,e.fileReader.onload=function(i){e._processing=!1,i.target&&e.emit("done",i.target.result),e.doNextTask()},e.fileReader.onerror=function(i){K.default.error("EncodingQueue error:",i),e._processing=!1,e.destroy(),e.emit("error",i)},e}return Object.defineProperty(t.prototype,"queue",{get:function(){return this._queue},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"size",{get:function(){return this.queue.length},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"processing",{get:function(){return this._processing},enumerable:!1,configurable:!0}),t.prototype.enque=function(e){this.queue.push(e),!this.processing&&this.doNextTask()},t.prototype.destroy=function(){this.fileReader.abort(),this._queue=[]},t.prototype.doNextTask=function(){this.size!==0&&(this.processing||(this._processing=!0,this.fileReader.readAsArrayBuffer(this.queue.shift())))},t}(Bd.EventEmitter),pk=function(){var s=function(t,e){return s=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(i,n){i.__proto__=n}||function(i,n){for(var o in n)Object.prototype.hasOwnProperty.call(n,o)&&(i[o]=n[o])},s(t,e)};return function(t,e){if(typeof e!="function"&&e!==null)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");s(t,e);function i(){this.constructor=t}t.prototype=e===null?Object.create(e):(i.prototype=e.prototype,new i)}}(),mk=function(s){var t=typeof Symbol=="function"&&Symbol.iterator,e=t&&s[t],i=0;if(e)return e.call(s);if(s&&typeof s.length=="number")return{next:function(){return s&&i>=s.length&&(s=void 0),{value:s&&s[i++],done:!s}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")},sv=function(s){pk(t,s);function t(e,i,n){var o=s.call(this,e,i,n)||this;return o.stringify=JSON.stringify,o.parse=JSON.parse,o._buffer=[],o._bufferSize=0,o._buffering=!1,o._chunkedData={},o._encodingQueue=new qS.EncodingQueue,o.connectionId=o.options.connectionId||t.ID_PREFIX+Ce.randomToken(),o.label=o.options.label||o.connectionId,o.serialization=o.options.serialization||ho.Binary,o.reliable=!!o.options.reliable,o._encodingQueue.on("done",function(r){o._bufferedSend(r)}),o._encodingQueue.on("error",function(){K.default.error("DC#".concat(o.connectionId,": Error occured in encoding from blob to arraybuffer, close DC")),o.close()}),o._negotiator=new N_.Negotiator(o),o._negotiator.startConnection(o.options._payload||{originator:!0}),o}return Object.defineProperty(t.prototype,"type",{get:function(){return Kn.Data},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"dataChannel",{get:function(){return this._dc},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"bufferSize",{get:function(){return this._bufferSize},enumerable:!1,configurable:!0}),t.prototype.initialize=function(e){this._dc=e,this._configureDataChannel()},t.prototype._configureDataChannel=function(){var e=this;(!Ce.supports.binaryBlob||Ce.supports.reliable)&&(this.dataChannel.binaryType="arraybuffer"),this.dataChannel.onopen=function(){K.default.log("DC#".concat(e.connectionId," dc connection success")),e._open=!0,e.emit("open")},this.dataChannel.onmessage=function(i){K.default.log("DC#".concat(e.connectionId," dc onmessage:"),i.data),e._handleDataMessage(i)},this.dataChannel.onclose=function(){K.default.log("DC#".concat(e.connectionId," dc closed for:"),e.peer),e.close()}},t.prototype._handleDataMessage=function(e){var i=this,n=e.data,o=n.constructor,r=this.serialization===ho.Binary||this.serialization===ho.BinaryUTF8,l=n;if(r){if(o===Blob){Ce.blobToArrayBuffer(n,function(h){var d=Ce.unpack(h);i.emit("data",d)});return}else if(o===ArrayBuffer)l=Ce.unpack(n);else if(o===String){var c=Ce.binaryStringToArrayBuffer(n);l=Ce.unpack(c)}}else this.serialization===ho.JSON&&(l=this.parse(n));if(l.__peerData){this._handleChunk(l);return}s.prototype.emit.call(this,"data",l)},t.prototype._handleChunk=function(e){var i=e.__peerData,n=this._chunkedData[i]||{data:[],count:0,total:e.total};if(n.data[e.n]=e.data,n.count++,this._chunkedData[i]=n,n.total===n.count){delete this._chunkedData[i];var o=new Blob(n.data);this._handleDataMessage({data:o})}},t.prototype.close=function(){this._buffer=[],this._bufferSize=0,this._chunkedData={},this._negotiator&&(this._negotiator.cleanup(),this._negotiator=null),this.provider&&(this.provider._removeConnection(this),this.provider=null),this.dataChannel&&(this.dataChannel.onopen=null,this.dataChannel.onmessage=null,this.dataChannel.onclose=null,this._dc=null),this._encodingQueue&&(this._encodingQueue.destroy(),this._encodingQueue.removeAllListeners(),this._encodingQueue=null),this.open&&(this._open=!1,s.prototype.emit.call(this,"close"))},t.prototype.send=function(e,i){if(!this.open){s.prototype.emit.call(this,"error",new Error("Connection is not open. You should listen for the `open` event before sending messages."));return}if(this.serialization===ho.JSON)this._bufferedSend(this.stringify(e));else if(this.serialization===ho.Binary||this.serialization===ho.BinaryUTF8){var n=Ce.pack(e);if(!i&&n.size>Ce.chunkedMTU){this._sendChunks(n);return}Ce.supports.binaryBlob?this._bufferedSend(n):this._encodingQueue.enque(n)}else this._bufferedSend(e)},t.prototype._bufferedSend=function(e){(this._buffering||!this._trySend(e))&&(this._buffer.push(e),this._bufferSize=this._buffer.length)},t.prototype._trySend=function(e){var i=this;if(!this.open)return!1;if(this.dataChannel.bufferedAmount>t.MAX_BUFFERED_AMOUNT)return this._buffering=!0,setTimeout(function(){i._buffering=!1,i._tryBuffer()},50),!1;try{this.dataChannel.send(e)}catch(n){return K.default.error("DC#:".concat(this.connectionId," Error when sending:"),n),this._buffering=!0,this.close(),!1}return!0},t.prototype._tryBuffer=function(){if(this.open&&this._buffer.length!==0){var e=this._buffer[0];this._trySend(e)&&(this._buffer.shift(),this._bufferSize=this._buffer.length,this._tryBuffer())}},t.prototype._sendChunks=function(e){var i,n,o=Ce.chunk(e);K.default.log("DC#".concat(this.connectionId," Try to send ").concat(o.length," chunks..."));try{for(var r=mk(o),l=r.next();!l.done;l=r.next()){var c=l.value;this.send(c,!0)}}catch(h){i={error:h}}finally{try{l&&!l.done&&(n=r.return)&&n.call(r)}finally{if(i)throw i.error}}},t.prototype.handleMessage=function(e){var i=e.payload;switch(e.type){case Gt.Answer:this._negotiator.handleSDP(e.type,i.sdp);break;case Gt.Candidate:this._negotiator.handleCandidate(i.candidate);break;default:K.default.warn("Unrecognized message type:",e.type,"from peer:",this.peer);break}},t.ID_PREFIX="dc_",t.MAX_BUFFERED_AMOUNT=8388608,t}($_.BaseConnection),XS={};Ks(XS,"API",()=>av,s=>av=s);var ov=function(s,t,e,i){function n(o){return o instanceof e?o:new e(function(r){r(o)})}return new(e||(e=Promise))(function(o,r){function l(d){try{h(i.next(d))}catch(u){r(u)}}function c(d){try{h(i.throw(d))}catch(u){r(u)}}function h(d){d.done?o(d.value):n(d.value).then(l,c)}h((i=i.apply(s,t||[])).next())})},rv=function(s,t){var e={label:0,sent:function(){if(o[0]&1)throw o[1];return o[1]},trys:[],ops:[]},i,n,o,r;return r={next:l(0),throw:l(1),return:l(2)},typeof Symbol=="function"&&(r[Symbol.iterator]=function(){return this}),r;function l(h){return function(d){return c([h,d])}}function c(h){if(i)throw new TypeError("Generator is already executing.");for(;e;)try{if(i=1,n&&(o=h[0]&2?n.return:h[0]?n.throw||((o=n.return)&&o.call(n),0):n.next)&&!(o=o.call(n,h[1])).done)return o;switch(n=0,o&&(h=[h[0]&2,o.value]),h[0]){case 0:case 1:o=h;break;case 4:return e.label++,{value:h[1],done:!1};case 5:e.label++,n=h[1],h=[0];continue;case 7:h=e.ops.pop(),e.trys.pop();continue;default:if(o=e.trys,!(o=o.length>0&&o[o.length-1])&&(h[0]===6||h[0]===2)){e=0;continue}if(h[0]===3&&(!o||h[1]>o[0]&&h[1]<o[3])){e.label=h[1];break}if(h[0]===6&&e.label<o[1]){e.label=o[1],o=h;break}if(o&&e.label<o[2]){e.label=o[2],e.ops.push(h);break}o[2]&&e.ops.pop(),e.trys.pop();continue}h=t.call(s,e)}catch(d){h=[6,d],n=0}finally{i=o=0}if(h[0]&5)throw h[1];return{value:h[0]?h[1]:void 0,done:!0}}},av=function(){function s(t){this._options=t}return s.prototype._buildRequest=function(t){var e=this._options.secure?"https":"http",i=this._options,n=i.host,o=i.port,r=i.path,l=i.key,c=new URL("".concat(e,"://").concat(n,":").concat(o).concat(r).concat(l,"/").concat(t));return c.searchParams.set("ts","".concat(Date.now()).concat(Math.random())),c.searchParams.set("version",U_.version),fetch(c.href,{referrerPolicy:this._options.referrerPolicy})},s.prototype.retrieveId=function(){return ov(this,void 0,Promise,function(){var t,e,i;return rv(this,function(n){switch(n.label){case 0:return n.trys.push([0,2,,3]),[4,this._buildRequest("id")];case 1:if(t=n.sent(),t.status!==200)throw new Error("Error. Status:".concat(t.status));return[2,t.text()];case 2:throw e=n.sent(),K.default.error("Error retrieving ID",e),i="",this._options.path==="/"&&this._options.host!==Ce.CLOUD_HOST&&(i=" If you passed in a `path` to your self-hosted PeerServer, you'll also need to pass in that same path when creating a new Peer."),new Error("Could not get an ID from the server."+i);case 3:return[2]}})})},s.prototype.listAllPeers=function(){return ov(this,void 0,Promise,function(){var t,e,i;return rv(this,function(n){switch(n.label){case 0:return n.trys.push([0,2,,3]),[4,this._buildRequest("peers")];case 1:if(t=n.sent(),t.status!==200)throw t.status===401?(e="",this._options.host===Ce.CLOUD_HOST?e="It looks like you're using the cloud server. You can email team@peerjs.com to enable peer listing for your API key.":e="You need to enable `allow_discovery` on your self-hosted PeerServer to use this feature.",new Error("It doesn't look like you have permission to list peers IDs. "+e)):new Error("Error. Status:".concat(t.status));return[2,t.json()];case 2:throw i=n.sent(),K.default.error("Error retrieving list peers",i),new Error("Could not get list peers from the server."+i);case 3:return[2]}})})},s}(),gk=function(){var s=function(t,e){return s=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(i,n){i.__proto__=n}||function(i,n){for(var o in n)Object.prototype.hasOwnProperty.call(n,o)&&(i[o]=n[o])},s(t,e)};return function(t,e){if(typeof e!="function"&&e!==null)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");s(t,e);function i(){this.constructor=t}t.prototype=e===null?Object.create(e):(i.prototype=e.prototype,new i)}}(),Lh=function(){return Lh=Object.assign||function(s){for(var t,e=1,i=arguments.length;e<i;e++){t=arguments[e];for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(s[n]=t[n])}return s},Lh.apply(this,arguments)},ch=function(s){var t=typeof Symbol=="function"&&Symbol.iterator,e=t&&s[t],i=0;if(e)return e.call(s);if(s&&typeof s.length=="number")return{next:function(){return s&&i>=s.length&&(s=void 0),{value:s&&s[i++],done:!s}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")},yk=function(s,t){var e=typeof Symbol=="function"&&s[Symbol.iterator];if(!e)return s;var i=e.call(s),n,o=[],r;try{for(;(t===void 0||t-- >0)&&!(n=i.next()).done;)o.push(n.value)}catch(l){r={error:l}}finally{try{n&&!n.done&&(e=i.return)&&e.call(i)}finally{if(r)throw r.error}}return o},Ty=function(s){gk(t,s);function t(e,i){var n=s.call(this)||this;n._id=null,n._lastServerId=null,n._destroyed=!1,n._disconnected=!1,n._open=!1,n._connections=new Map,n._lostMessages=new Map;var o;return e&&e.constructor==Object?i=e:e&&(o=e.toString()),i=Lh({debug:0,host:Ce.CLOUD_HOST,port:Ce.CLOUD_PORT,path:"/",key:t.DEFAULT_KEY,token:Ce.randomToken(),config:Ce.defaultConfig,referrerPolicy:"strict-origin-when-cross-origin"},i),n._options=i,n._options.host==="/"&&(n._options.host=window.location.hostname),n._options.path&&(n._options.path[0]!=="/"&&(n._options.path="/"+n._options.path),n._options.path[n._options.path.length-1]!=="/"&&(n._options.path+="/")),n._options.secure===void 0&&n._options.host!==Ce.CLOUD_HOST?n._options.secure=Ce.isSecure():n._options.host==Ce.CLOUD_HOST&&(n._options.secure=!0),n._options.logFunction&&K.default.setLogFunction(n._options.logFunction),K.default.logLevel=n._options.debug||0,n._api=new XS.API(i),n._socket=n._createServerConnection(),!Ce.supports.audioVideo&&!Ce.supports.data?(n._delayedAbort(ut.BrowserIncompatible,"The current browser does not support WebRTC"),n):o&&!Ce.validateId(o)?(n._delayedAbort(ut.InvalidID,'ID "'.concat(o,'" is invalid')),n):(o?n._initialize(o):n._api.retrieveId().then(function(r){return n._initialize(r)}).catch(function(r){return n._abort(ut.ServerError,r)}),n)}return Object.defineProperty(t.prototype,"id",{get:function(){return this._id},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"options",{get:function(){return this._options},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"open",{get:function(){return this._open},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"socket",{get:function(){return this._socket},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"connections",{get:function(){var e,i,n=Object.create(null);try{for(var o=ch(this._connections),r=o.next();!r.done;r=o.next()){var l=yk(r.value,2),c=l[0],h=l[1];n[c]=h}}catch(d){e={error:d}}finally{try{r&&!r.done&&(i=o.return)&&i.call(o)}finally{if(e)throw e.error}}return n},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"destroyed",{get:function(){return this._destroyed},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"disconnected",{get:function(){return this._disconnected},enumerable:!1,configurable:!0}),t.prototype._createServerConnection=function(){var e=this,i=new GS.Socket(this._options.secure,this._options.host,this._options.port,this._options.path,this._options.key,this._options.pingInterval);return i.on(Co.Message,function(n){e._handleMessage(n)}),i.on(Co.Error,function(n){e._abort(ut.SocketError,n)}),i.on(Co.Disconnected,function(){e.disconnected||(e.emitError(ut.Network,"Lost connection to server."),e.disconnect())}),i.on(Co.Close,function(){e.disconnected||e._abort(ut.SocketClosed,"Underlying socket is already closed.")}),i},t.prototype._initialize=function(e){this._id=e,this.socket.start(e,this._options.token)},t.prototype._handleMessage=function(e){var i,n,o=e.type,r=e.payload,l=e.src;switch(o){case Gt.Open:this._lastServerId=this.id,this._open=!0,this.emit("open",this.id);break;case Gt.Error:this._abort(ut.ServerError,r.msg);break;case Gt.IdTaken:this._abort(ut.UnavailableID,'ID "'.concat(this.id,'" is taken'));break;case Gt.InvalidKey:this._abort(ut.InvalidKey,'API KEY "'.concat(this._options.key,'" is invalid'));break;case Gt.Leave:K.default.log("Received leave message from ".concat(l)),this._cleanupPeer(l),this._connections.delete(l);break;case Gt.Expire:this.emitError(ut.PeerUnavailable,"Could not connect to peer ".concat(l));break;case Gt.Offer:var g=r.connectionId,y=this.getConnection(l,g);if(y&&(y.close(),K.default.warn("Offer received for existing Connection ID:".concat(g))),r.type===Kn.Media){var c=new Ry.MediaConnection(l,this,{connectionId:g,_payload:r,metadata:r.metadata});y=c,this._addConnection(l,y),this.emit("call",c)}else if(r.type===Kn.Data){var h=new Oy.DataConnection(l,this,{connectionId:g,_payload:r,metadata:r.metadata,label:r.label,serialization:r.serialization,reliable:r.reliable});y=h,this._addConnection(l,y),this.emit("connection",h)}else{K.default.warn("Received malformed connection type:".concat(r.type));return}var d=this._getMessages(g);try{for(var u=ch(d),f=u.next();!f.done;f=u.next()){var p=f.value;y.handleMessage(p)}}catch(b){i={error:b}}finally{try{f&&!f.done&&(n=u.return)&&n.call(u)}finally{if(i)throw i.error}}break;default:if(!r){K.default.warn("You received a malformed message from ".concat(l," of type ").concat(o));return}var g=r.connectionId,y=this.getConnection(l,g);y&&y.peerConnection?y.handleMessage(e):g?this._storeMessage(g,e):K.default.warn("You received an unrecognized message:",e);break}},t.prototype._storeMessage=function(e,i){this._lostMessages.has(e)||this._lostMessages.set(e,[]),this._lostMessages.get(e).push(i)},t.prototype._getMessages=function(e){var i=this._lostMessages.get(e);return i?(this._lostMessages.delete(e),i):[]},t.prototype.connect=function(e,i){if(i===void 0&&(i={}),this.disconnected){K.default.warn("You cannot connect to a new Peer because you called .disconnect() on this Peer and ended your connection with the server. You can create a new Peer to reconnect, or call reconnect on this peer if you believe its ID to still be available."),this.emitError(ut.Disconnected,"Cannot connect to new Peer after disconnecting from server.");return}var n=new Oy.DataConnection(e,this,i);return this._addConnection(e,n),n},t.prototype.call=function(e,i,n){if(n===void 0&&(n={}),this.disconnected){K.default.warn("You cannot connect to a new Peer because you called .disconnect() on this Peer and ended your connection with the server. You can create a new Peer to reconnect."),this.emitError(ut.Disconnected,"Cannot connect to new Peer after disconnecting from server.");return}if(!i){K.default.error("To call a peer, you must provide a stream from your browser's `getUserMedia`.");return}var o=new Ry.MediaConnection(e,this,Lh(Lh({},n),{_stream:i}));return this._addConnection(e,o),o},t.prototype._addConnection=function(e,i){K.default.log("add connection ".concat(i.type,":").concat(i.connectionId," to peerId:").concat(e)),this._connections.has(e)||this._connections.set(e,[]),this._connections.get(e).push(i)},t.prototype._removeConnection=function(e){var i=this._connections.get(e.peer);if(i){var n=i.indexOf(e);n!==-1&&i.splice(n,1)}this._lostMessages.delete(e.connectionId)},t.prototype.getConnection=function(e,i){var n,o,r=this._connections.get(e);if(!r)return null;try{for(var l=ch(r),c=l.next();!c.done;c=l.next()){var h=c.value;if(h.connectionId===i)return h}}catch(d){n={error:d}}finally{try{c&&!c.done&&(o=l.return)&&o.call(l)}finally{if(n)throw n.error}}return null},t.prototype._delayedAbort=function(e,i){var n=this;setTimeout(function(){n._abort(e,i)},0)},t.prototype._abort=function(e,i){K.default.error("Aborting!"),this.emitError(e,i),this._lastServerId?this.disconnect():this.destroy()},t.prototype.emitError=function(e,i){K.default.error("Error:",i);var n;typeof i=="string"?n=new Error(i):n=i,n.type=e,this.emit("error",n)},t.prototype.destroy=function(){this.destroyed||(K.default.log("Destroy peer with ID:".concat(this.id)),this.disconnect(),this._cleanup(),this._destroyed=!0,this.emit("close"))},t.prototype._cleanup=function(){var e,i;try{for(var n=ch(this._connections.keys()),o=n.next();!o.done;o=n.next()){var r=o.value;this._cleanupPeer(r),this._connections.delete(r)}}catch(l){e={error:l}}finally{try{o&&!o.done&&(i=n.return)&&i.call(n)}finally{if(e)throw e.error}}this.socket.removeAllListeners()},t.prototype._cleanupPeer=function(e){var i,n,o=this._connections.get(e);if(o)try{for(var r=ch(o),l=r.next();!l.done;l=r.next()){var c=l.value;c.close()}}catch(h){i={error:h}}finally{try{l&&!l.done&&(n=r.return)&&n.call(r)}finally{if(i)throw i.error}}},t.prototype.disconnect=function(){if(!this.disconnected){var e=this.id;K.default.log("Disconnect peer with ID:".concat(e)),this._disconnected=!0,this._open=!1,this.socket.close(),this._lastServerId=e,this._id=null,this.emit("disconnected",e)}},t.prototype.reconnect=function(){if(this.disconnected&&!this.destroyed)K.default.log("Attempting reconnection to server with ID ".concat(this._lastServerId)),this._disconnected=!1,this._initialize(this._lastServerId);else{if(this.destroyed)throw new Error("This peer cannot reconnect to the server. It has already been destroyed.");if(!this.disconnected&&!this.open)K.default.error("In a hurry? We're still trying to make the initial connection!");else throw new Error("Peer ".concat(this.id," cannot reconnect because it is not disconnected from the server!"))}},t.prototype.listAllPeers=function(e){var i=this;e===void 0&&(e=function(n){}),this._api.listAllPeers().then(function(n){return e(n)}).catch(function(n){return i._abort(ut.ServerError,n)})},t.DEFAULT_KEY="peerjs",t}(Bd.EventEmitter),ky=VS.Peer;const _k=Object.freeze(Object.defineProperty({__proto__:null,get Peer(){return Ty},default:ky,util:Ce},Symbol.toStringTag,{value:"Module"}));let W_;function mL(){return W_}function gL(s){W_=s}function bk(s,t){return t||(t={}),t={...W_,...t},s?new ky(s,t):new ky(t)}async function lv(){const s=await ts(()=>Promise.resolve().then(()=>_k),void 0,import.meta.url);return console.log(s),s.default===void 0?s:s.default}var Ey;(function(s){s.ConnectionList="connection-list"})(Ey||(Ey={}));class vk{constructor(){a(this,"_host");a(this,"_client");a(this,"_clientData");this.onEnable()}get isHost(){return this._host!==void 0}onEnable(){const t="HOST-5980e65c-8438-453e-8b35-f13c736dcd81";this.trySetupHost(t)}async trySetupHost(t){const e=await lv(),i=new e(t);i.on("error",n=>{console.error(n),this._host=void 0,this.trySetupClient(t)}),i.on("open",n=>{this._host=new wk(i)})}async trySetupClient(t){const e=await lv();this._client=new e,this._client.on("error",i=>{console.error("Client error",i)}),this._client.on("open",i=>{console.log("client connected",i),this._clientData=this._client.connect(t,{metadata:{id:i}}),this._clientData.on("open",()=>{console.log("Connected to host")}),this._clientData.on("data",n=>{console.log("<<",n)})})}}class xk{constructor(t){a(this,"_peer");this._peer=t}}class wk extends xk{constructor(e){var i;super(e);a(this,"_connections",[]);console.log("I AM THE HOST"),(i=this._peer)==null||i.on("connection",this.onConnection.bind(this)),this._peer.on("close",()=>{this.broadcast("BYE")}),setInterval(()=>{this.broadcast("HELLO")},2e3)}get isHost(){return!0}onConnection(e){console.log("host connection",e),e.on("open",()=>{this._connections.push(e),this.broadcastConnection(e)})}broadcastConnection(e){const i=this._connections.map(n=>{var o;return(o=n.metadata)==null?void 0:o.id}).filter(n=>n!==void 0);this.broadcast({type:Ey.ConnectionList,connections:i})}broadcast(e){if(e!=null){console.log(">>",e);for(const i in this._peer.connections){const n=this._peer.connections[i];if(n)if(Array.isArray(n))for(const o of n)o&&o.send(e);else console.warn(n)}}}}var Qn;(function(s){s[s.OnConnection=0]="OnConnection",s[s.OnRoomJoin=1]="OnRoomJoin",s[s.Queued=2]="Queued",s[s.Immediate=3]="Immediate"})(Qn||(Qn={}));const cv="https://urls.needle.tools/default-networking-backend/index";let Li="wss://networking.needle.tools/socket";const Zi=!!C("debugnet"),_u=!!(Zi||C("debugowner")),tg=C("debugnetbin");var My;(function(s){s.ConnectionInfo="connection-start-info"})(My||(My={}));var se;(function(s){s.Join="join-room",s.Leave="leave-room",s.JoinedRoom="joined-room",s.LeftRoom="left-room",s.UserJoinedRoom="user-joined-room",s.UserLeftRoom="user-left-room",s.RoomStateSent="room-state-sent"})(se||(se={}));class yL{constructor(){a(this,"room");a(this,"viewId");a(this,"allowEditing");a(this,"inRoom")}}class _L{constructor(){a(this,"room")}}class bL{constructor(){a(this,"userId")}}var si;(function(s){s.RequestHasOwner="request-has-owner",s.ResponseHasOwner="response-has-owner",s.RequestIsOwner="request-is-owner",s.ResponseIsOwner="response-is-owner",s.RequestOwnership="request-ownership",s.GainedOwnership="gained-ownership",s.RemoveOwnership="remove-ownership",s.LostOwnership="lost-ownership",s.GainedOwnershipBroadcast="gained-ownership-broadcast",s.LostOwnershipBroadcast="lost-ownership-broadcast"})(si||(si={}));class QS{constructor(t,e){a(this,"guid");a(this,"connection");a(this,"_hasOwnership",!1);a(this,"_isOwned");a(this,"_gainSubscription");a(this,"_lostSubscription");a(this,"_hasOwnerResponse");a(this,"_isWaitingForOwnershipResponseCallback",null);this.connection=t,this.guid=e,this._gainSubscription=this.onGainedOwnership.bind(this),this._lostSubscription=this.onLostOwnership.bind(this),t.beginListen(si.LostOwnership,this._lostSubscription),t.beginListen(si.GainedOwnershipBroadcast,this._gainSubscription),this._hasOwnerResponse=this.onHasOwnerResponse.bind(this),t.beginListen(si.ResponseHasOwner,this._hasOwnerResponse)}get hasOwnership(){return this._hasOwnership}get isOwned(){return this._isOwned}get isConnected(){return this.connection.isConnected}updateIsOwned(){this.connection.send(si.RequestHasOwner,{guid:this.guid})}onHasOwnerResponse(t){t.guid===this.guid&&(this._isOwned=t.value)}requestOwnershipIfNotOwned(){return this._isWaitingForOwnershipResponseCallback!==null?this:(this._isWaitingForOwnershipResponseCallback=this.waitForHasOwnershipRequestResponse.bind(this),this.connection.beginListen(si.ResponseHasOwner,this._isWaitingForOwnershipResponseCallback),this.connection.send(si.RequestHasOwner,{guid:this.guid}),this)}waitForHasOwnershipRequestResponse(t){t.guid===this.guid&&(this._isWaitingForOwnershipResponseCallback&&(this.connection.stopListen(si.ResponseHasOwner,this._isWaitingForOwnershipResponseCallback),this._isWaitingForOwnershipResponseCallback=null),this._isOwned=t.value,t.value||(_u&&console.log("request ownership",this.guid),this.requestOwnership()))}requestOwnershipAsync(){return new Promise((t,e)=>{this.requestOwnership();let i=0;const n=()=>{if(i++>10)return e("Timeout");setTimeout(()=>{this.hasOwnership?t(this):n()},100)};n()})}requestOwnership(){return _u&&console.log("Request ownership",this.guid),this.connection.send(si.RequestOwnership,{guid:this.guid}),this}freeOwnership(){return this.connection.send(si.RemoveOwnership,{guid:this.guid}),this._isWaitingForOwnershipResponseCallback&&(this.connection.stopListen(si.ResponseHasOwner,this._isWaitingForOwnershipResponseCallback),this._isWaitingForOwnershipResponseCallback=null),this}destroy(){this.connection.stopListen(si.GainedOwnership,this._gainSubscription),this.connection.stopListen(si.LostOwnership,this._lostSubscription),this.connection.stopListen(si.ResponseHasOwner,this._hasOwnerResponse),this._isWaitingForOwnershipResponseCallback&&(this.connection.stopListen(si.ResponseHasOwner,this._isWaitingForOwnershipResponseCallback),this._isWaitingForOwnershipResponseCallback=null)}onGainedOwnership(t){t.guid===this.guid&&(this._isOwned=!0,this.connection.connectionId===t.owner?(_u&&console.log("GAINED OWNERSHIP",this.guid),this._hasOwnership=!0):this._hasOwnership=!1)}onLostOwnership(t){t===this.guid&&(_u&&console.log("LOST OWNERSHIP",this.guid),this._hasOwnership=!1,this._isOwned=!1)}}class Sk{constructor(t){a(this,"context");a(this,"_peer",null);a(this,"_usersInRoomCopy",[]);a(this,"_defaultMessagesBuffer",[]);a(this,"_defaultMessagesBufferArray",[]);a(this,"netWebSocketUrlProvider");a(this,"_listeners",{});a(this,"_listenersBinary",{});a(this,"connected",!1);a(this,"channelId");a(this,"_connectionId",null);a(this,"_ws");a(this,"_waitingForSocket",{});a(this,"_isInRoom",!1);a(this,"_currentRoomName",null);a(this,"_currentRoomViewId",null);a(this,"_currentRoomAllowEditing",!0);a(this,"_currentInRoom",[]);a(this,"_state",{});a(this,"_currentDelay",-1);a(this,"_connectingToWebsocketPromise",null);this.context=t}get peer(){return this._peer||(this._peer=new vk),this._peer}tryGetState(t){return t==="invalid"?null:this._state[t]}get connectionId(){return this._connectionId}get isDebugEnabled(){return Zi}get isConnected(){return this.connected}get currentRoomName(){return this._currentRoomName}get allowEditing(){return this._currentRoomAllowEditing}get currentRoomViewId(){return this._currentRoomViewId}getViewOnlyUrl(){if(this.currentRoomViewId===null)return null;const t=new URL(window.location.href);return t.searchParams.set("view",this.currentRoomViewId),t.href}get isInRoom(){return this._isInRoom}get currentLatency(){return this._currentDelay}get currentServerUrl(){var t;return((t=this._ws)==null?void 0:t.url)??null}sendPing(){this.send("ping",{time:this.context.time.time})}userIsInRoom(t){return this._currentInRoom.indexOf(t)!==-1}usersInRoom(t=null){t||(t=this._usersInRoomCopy),t.length=0;for(const e of this._currentInRoom)t.push(e);return t}joinRoom(t,e=!1){return t?t.length>1024?(console.error('Room name too long, can not join: "'+t+'". Max length is 1024 characters.'),!1):(this.connect(),Zi&&console.log("join: "+t),this.send(se.Join,{room:t,viewOnly:e},Qn.OnConnection),!0):(console.error('Missing room name, can not join: "'+t+'"'),!1)}leaveRoom(t=null){return t||(t=this.currentRoomName),t?(this.send(se.Leave,{room:t}),!0):(console.error('Missing room name, can not join: "'+t+'"'),!1)}send(t,e=null,i=Qn.Queued){if(e===null&&(e={}),i===Qn.Queued){this._defaultMessagesBuffer.push({key:t,value:e});return}return this.sendWithWebsocket(t,e,i)}sendDeleteRemoteState(t){this.send("delete-state",{guid:t,dontSave:!0}),delete this._state[t]}sendDeleteRemoteStateAll(){this.send("delete-all-state"),this._state={}}sendBinary(t){var e;tg&&console.log("<< send binary",this.context.time.frame,t.length/1024+" KB"),(e=this._ws)==null||e.send(t)}sendBufferedMessagesNow(){var i;if(!this._ws)return;this._defaultMessagesBufferArray.length=0;const t=Object.keys(this._defaultMessagesBuffer).length;for(const n in this._defaultMessagesBuffer){const o=this._defaultMessagesBuffer[n];if(t<=1){this.sendWithWebsocket(o.key,o.value,Qn.Immediate);break}const r=this.toMessage(o.key,o.value);this._defaultMessagesBufferArray.push(r)}if(this._defaultMessagesBuffer.length=0,this._defaultMessagesBufferArray.length>0&&Zi&&console.log("SEND BUFFERED",this._defaultMessagesBufferArray.length),this._defaultMessagesBufferArray.length<=0)return;const e=JSON.stringify(this._defaultMessagesBufferArray);(i=this._ws)==null||i.send(e)}beginListen(t,e){return this._listeners[t]||(this._listeners[t]=[]),this._listeners[t].push(e),e}stopListening(t,e){return this.stopListen(t,e)}stopListen(t,e){if(!e||!this._listeners[t])return;const i=this._listeners[t].indexOf(e);i>=0&&this._listeners[t].splice(i,1)}beginListenBinary(t,e){return this._listenersBinary[t]||(this._listenersBinary[t]=[]),this._listenersBinary[t].push(e),e}stopListenBinary(t,e){if(!this._listenersBinary[t])return;const i=this._listenersBinary[t].indexOf(e);i>=0&&this._listenersBinary[t].splice(i,1)}registerProvider(t){this.netWebSocketUrlProvider=t}async connect(t){var i;if(this.connected&&t&&t!==Li)return Promise.reject("Can not connect to different server url. Please disconnect first.");if(this.connected)return Promise.resolve(!0);t&&console.debug("Connecting to user provided url "+t);const e=t||((i=this.netWebSocketUrlProvider)==null?void 0:i.getWebsocketUrl());return e?Li=e:lO()&&(Li="wss://"+window.location.host+"/socket"),this.connectWebsocket()}disconnect(){var t;(t=this._ws)==null||t.close(),this._ws=void 0,Li=void 0}connectWebsocket(){return this._connectingToWebsocketPromise?this._connectingToWebsocketPromise:this._connectingToWebsocketPromise=new Promise(async(t,e)=>{var h,d;let i=!1;const n=u=>{i||(i=!0,t(u))};if(Li===void 0&&(console.log("Fetch default backend url: "+cv),Li=await(await fetch(cv)).text()),Li===void 0){n(!1);return}console.debug(`‚ä° Connecting to networking backend on
`+Li);const o=await ts(()=>import("./index.d7be2e3b.js"),[],import.meta.url),r=((h=o.default)==null?void 0:h.WebsocketBuilder)??o.WebsocketBuilder,l=((d=o.default)==null?void 0:d.ExponentialBackoff)??o.ExponentialBackoff,c=new r(Li).withMaxRetries(10).withBackoff(new l(2e3,4)).onOpen(()=>{this._connectingToWebsocketPromise=null,this._ws=c,this.connected=!0,U()||Zi?console.log(`‚äû Connected to networking backend
`+Li):console.debug("‚äû Connected to networking backend",Li),n(!0),this.onSendQueued(Qn.OnConnection)}).onClose(u=>{this._connectingToWebsocketPromise=null,this.connected=!1,this._isInRoom=!1,n(!1);let f="Websocket connection closed...";Li!=null&&Li.includes("/socket")||(f+=' Do you perhaps mean to connect to "/socket"?'),console.error(f)}).onError(u=>{console.error("‚ä† Websocket connection failed..."),n(!1)}).onRetry(()=>{console.log("‚Üí Retry connecting to networking websocket")}).build();c.addEventListener(o.WebsocketEvent.message,(u,f)=>{this.onMessage(u,f)})})}onMessage(t,e){const i=e.data;try{if(typeof i!="string"){i.size&&this.handleIncomingBinaryMessage(i);return}const n=JSON.parse(i);if(Array.isArray(n))for(const o of n)this.handleIncomingStringMessage(o);else this.handleIncomingStringMessage(n);return}catch(n){Zi&&i==="pong"?console.log("<<",i):U()&&console.error("Failed to parse message",n)}}async handleIncomingBinaryMessage(t){tg&&console.log("<< bin",this.context.time.frame);const e=await t.arrayBuffer();var i=new Uint8Array(e);const n=new wd(i),o=n.getBufferIdentifier(),r=this._listenersBinary[o],l=jT(n),c=BT(l);if(c&&typeof c=="string"&&(this._state[c]=l),!r)return;const h=l??n;for(const d of r)d(h)}handleIncomingStringMessage(t){var n,o;if(Zi&&console.log("<<",t.key??t),t.key)switch(t.key){case My.ConnectionInfo:if(t.data){const c=t.data;c&&(console.assert(c.id!==void 0&&c.id!==null&&c.id.length>0,"server did not send connection id",c.id),console.debug("Your id is: "+c.id,this.context.alias??""),this._connectionId=c.id)}else console.warn("Expected connection id in "+t.key);break;case se.JoinedRoom:if(Zi&&console.log(t),t){this._isInRoom=!0;const c=t;this._currentRoomName=c.room,this._currentRoomViewId=c.viewId,this._currentRoomAllowEditing=c.allowEditing??!0,this._currentInRoom.length=0,this._currentInRoom.push(...c.inRoom),(tg||U())&&console.debug("Joined Needle Engine Room: "+c.room);const h=new URL(window.location.href);h.searchParams.has("room")&&h.searchParams.delete("room"),h.searchParams.set("view",this._currentRoomViewId),console.debug(`Room view id: ${this._currentRoomViewId}
${h.href}`)}this.onSendQueued(Qn.OnRoomJoin);break;case se.LeftRoom:t.room===this.currentRoomName&&(this._isInRoom=!1,this._currentRoomName=null,this._currentInRoom.length=0);break;case se.UserJoinedRoom:if(t.data){const c=t.data;this._currentInRoom.push(c.userId),Zi&&console.log(c.userId+" joined","now in room:",this._currentInRoom)}break;case se.UserLeftRoom:if(t.data){const c=t.data,h=this._currentInRoom.indexOf(c.userId);h>=0&&(Zi&&console.log(c.userId+" left","now in room:",this._currentInRoom),this._currentInRoom.splice(h,1)),c.userId===this.connectionId&&console.log("you left the room")}break;case"all-room-state-deleted":Zi&&console.log("RECEIVED all-room-state-deleted"),this._state={};break;case"ping":case"pong":const l=(n=t.data)==null?void 0:n.time;l&&(this._currentDelay=this.context.time.time-l),Zi&&console.log("Current latency: "+this._currentDelay.toFixed(4)+" sec","Clients in room: "+((o=this._currentInRoom)==null?void 0:o.length));break}const e=t.data;e&&(this._state[e.guid]=e);let i=this._listeners[t.key];if(i){i=[...i];for(const r of i)try{r(t.data)}catch(l){console.error('Error invoking callback for "'+t.key+'"',l)}}}toMessage(t,e){return{key:t,data:e}}sendWithWebsocket(t,e,i=Qn.OnRoomJoin){if(!this._ws){const o=this._waitingForSocket[i]||[];o.push(()=>this.sendWithWebsocket(t,e,i)),this._waitingForSocket[i]=o;return}const n=JSON.stringify(this.toMessage(t,e));Zi&&console.log(">>",t),this._ws.send(n)}onSendQueued(t){const e=this._waitingForSocket[t];if(e){for(const i of e)i();e.length=0}}}const jh=C("debugwebxr");class ig{constructor(t,e){a(this,"controllerStates",[]);a(this,"userId");a(this,"context");a(this,"userStateEvtName");a(this,"onReceivedControllerState",t=>{jh&&console.log(`XRSync: Received change for ${this.userId}: ${t.type} ${t.handedness}; tracked=${t.isTracking}`);let e=!1;for(let i=0;i<this.controllerStates.length;i++)if(this.controllerStates[i].index===t.index){this.controllerStates[i]=t,e=!0;break}e||this.controllerStates.push(t)});this.userId=t,this.context=e,this.userStateEvtName="xr-sync-user-state-"+t,this.context.connection.beginListen(this.userStateEvtName,this.onReceivedControllerState)}dispose(){this.context.connection.stopListen(this.userStateEvtName,this.onReceivedControllerState)}update(t){if(this.context.connection.isConnected!=!1){for(let e=this.controllerStates.length-1;e>=0;e--){const i=this.controllerStates[e];let n=!1;for(let o=0;o<t.controllers.length;o++)t.controllers[o].index===i.index&&(n=!0);n||(jh&&console.log(`XRSync: ${i.type} ${i.handedness} removed`,i.index),this.controllerStates.splice(e,1),this.sendControllerRemoved(i))}for(const e of t.controllers)this.updateControllerStates(e)}}onExitXR(t){for(const e of this.controllerStates)this.sendControllerRemoved(e);this.controllerStates.length=0}sendControllerRemoved(t){t.isTracking=!1,t.guid="",this.context.connection.send(this.userStateEvtName,t),this.context.connection.sendDeleteRemoteState(t.guid)}updateControllerStates(t){const e=this.controllerStates.find(i=>i.index===t.index);if(e){let i=!1;i||(i=e.isTracking!=t.isTracking),i&&(e.isTracking=t.isTracking,this.context.connection.send(this.userStateEvtName,e))}else{const i={guid:this.userId+"-"+t.index,isTracking:t.isTracking,handedness:t.side,index:t.index,type:t.hand?"hand":"controller"};this.controllerStates.push(i),this.context.connection.send(this.userStateEvtName,i),jh&&console.log(`XRSync: ${i.type} ${i.handedness} added`,i.index)}}}class Ck{constructor(t){a(this,"context");a(this,"onJoinedRoom",()=>{if(this.context.connection.connectionId){this._states.has(this.context.connection.connectionId)||(jh&&console.log("XRSync: Local user joined room",this.context.connection.connectionId),this._states.set(this.context.connection.connectionId,new ig(this.context.connection.connectionId,this.context)));for(const t of this.context.connection.usersInRoom())this._states.has(t)||this._states.set(t,new ig(t,this.context))}});a(this,"onLeftRoom",()=>{if(this.context.connection.connectionId&&!this._states.has(this.context.connection.connectionId)){const t=this._states.get(this.context.connection.connectionId);t==null||t.dispose(),this._states.delete(this.context.connection.connectionId)}});a(this,"onOtherUserJoinedRoom",t=>{const e=t.userId;this._states.has(e)||(jh&&console.log("XRSync: Remote user joined room",e),this._states.set(e,new ig(e,this.context)))});a(this,"onOtherUserLeftRoom",t=>{const e=t.userId;if(!this._states.has(e)){const i=this._states.get(e);i==null||i.dispose(),this._states.delete(e)}});a(this,"_states",new Map);this.context=t,this.context.connection.beginListen(se.JoinedRoom,this.onJoinedRoom),this.context.connection.beginListen(se.LeftRoom,this.onLeftRoom),this.context.connection.beginListen(se.UserJoinedRoom,this.onOtherUserJoinedRoom),this.context.connection.beginListen(se.UserLeftRoom,this.onOtherUserLeftRoom)}hasState(t){return t?this._states.has(t):!1}isTracking(t,e){if(!t)return;const i=this._states.get(t);if(!i)return;const n=i.controllerStates.find(o=>o.handedness===e);return(n==null?void 0:n.isTracking)||!1}getDeviceType(t,e){if(!t)return;const i=this._states.get(t);if(!i)return;const n=i.controllerStates.find(o=>o.handedness===e);return(n==null?void 0:n.type)||"unknown"}destroy(){this.context.connection.stopListen(se.JoinedRoom,this.onJoinedRoom),this.context.connection.stopListen(se.LeftRoom,this.onLeftRoom),this.context.connection.stopListen(se.UserJoinedRoom,this.onOtherUserJoinedRoom),this.context.connection.stopListen(se.UserLeftRoom,this.onOtherUserLeftRoom)}onUpdate(t){if(this.context.connection.isConnected&&this.context.connection.connectionId){const e=this._states.get(this.context.connection.connectionId);e==null||e.update(t)}}onExitXR(t){if(this.context.connection.isConnected&&this.context.connection.connectionId){const e=this._states.get(this.context.connection.connectionId);e==null||e.onExitXR(t)}}}class hv{constructor(){a(this,"_fadeToColorQuad");a(this,"_fadeToColorMaterial");a(this,"_requestedFadeValue",0);a(this,"_transitionPromise",null);a(this,"_transitionResolve",null);this._fadeToColorMaterial=new Ue({color:0,transparent:!0,depthTest:!1,fog:!1,side:hn}),this._fadeToColorQuad=new Z(new Ys(10,10),this._fadeToColorMaterial)}dispose(){this._fadeToColorQuad.geometry.dispose(),this._fadeToColorMaterial.dispose()}update(t,e){const i=this._fadeToColorQuad,n=this._fadeToColorMaterial;i.parent!==t&&n.opacity>0?t.add(i):n.opacity===0&&i.removeFromParent(),i.layers.set(2),i.material=this._fadeToColorMaterial,i.position.z=-1,i.renderOrder=1/0;const o=this._requestedFadeValue;n.opacity=W.lerp(n.opacity,o,e/.03),Math.abs(n.opacity-o)<=.01&&this._transitionResolve&&(this._transitionResolve(),this._transitionResolve=null,this._transitionPromise=null,this._requestedFadeValue=0)}remove(){this._fadeToColorQuad.removeFromParent()}fadeTransition(){if(this._transitionPromise)return this._transitionPromise;this._requestedFadeValue=1;const t=new Promise(e=>{this._transitionResolve=e});return this._transitionPromise=t,t}}var Jn;(function(s){s[s.Quad=0]="Quad",s[s.Cube=1]="Cube",s[s.Sphere=2]="Sphere",s[s.RoundedCube=10]="RoundedCube"})(Jn||(Jn={}));var Ad,Ay;class Ka{static createText(t,e){let i=null;const n=(e==null?void 0:e.font)||Rk((e==null?void 0:e.familyFamily)||null);n instanceof IR?i=aa(this,Ad,Ay).call(this,t,n,e):i==null&&(i=new ko);const o=(e==null?void 0:e.color)||16777215,r=new Z(i,(e==null?void 0:e.material)??new Vi({color:o}));return this.applyDefaultObjectOptions(r,e),n instanceof Promise?n.then(l=>{r.geometry=aa(this,Ad,Ay).call(this,t,l,e),e!=null&&e.onGeometry&&e.onGeometry(r)}):e!=null&&e.onGeometry&&e.onGeometry(r),r}static createOccluder(t){const e=new Ue({colorWrite:!1,depthWrite:!0,side:hn});return this.createPrimitive(t,{material:e})}static createPrimitive(t,e){let i;const n=(e==null?void 0:e.color)||16777215;switch(t){case"Quad":case Jn.Quad:{const o=new Ys(1,1,1,1),r=(e==null?void 0:e.material)??new Vi({color:n});e!=null&&e.texture&&"map"in r&&(r.map=e.texture),i=new Z(o,r),i.name="Quad"}break;case"Cube":case Jn.Cube:{const o=new gd(1,1,1),r=(e==null?void 0:e.material)??new Vi({color:n});e!=null&&e.texture&&"map"in r&&(r.map=e.texture),i=new Z(o,r),i.name="Cube"}break;case Jn.RoundedCube:case"RoundedCube":{const o=Pk(1,1,1,.1,2),r=(e==null?void 0:e.material)??new Vi({color:n});e!=null&&e.texture&&"map"in r&&(r.map=e.texture),i=new Z(o,r),i.name="RoundedCube"}break;case"Sphere":case Jn.Sphere:{const o=new wp(.5,16,16),r=(e==null?void 0:e.material)??new Vi({color:n});e!=null&&e.texture&&"map"in r&&(r.map=e.texture),i=new Z(o,r),i.name="Sphere"}break;case"ShaderBall":i=new Mr,i.name="ShaderBall",Ok(i,e);break}return this.applyDefaultObjectOptions(i,e),i}static createSprite(t){const i=new mP({color:16777215});t!=null&&t.texture&&"map"in i&&(i.map=t.texture);const n=new gP(i);return this.applyDefaultObjectOptions(n,t),n}static applyDefaultObjectOptions(t,e){t.receiveShadow=!0,t.castShadow=!0,e!=null&&e.name&&(t.name=e.name),e!=null&&e.position&&(Array.isArray(e.position)?t.position.set(e.position[0],e.position[1],e.position[2]):t.position.set(e.position.x,e.position.y,e.position.z)),e!=null&&e.rotation&&(Array.isArray(e.rotation)?t.rotation.set(e.rotation[0],e.rotation[1],e.rotation[2]):t.rotation.set(e.rotation.x,e.rotation.y,e.rotation.z)),e!=null&&e.scale&&(typeof e.scale=="number"?t.scale.set(e.scale,e.scale,e.scale):t.scale.set(e.scale.x,e.scale.y,e.scale.z)),(e==null?void 0:e.receiveShadow)!=null&&(t.receiveShadow=e.receiveShadow),(e==null?void 0:e.castShadow)!=null&&(t.castShadow=e.castShadow),e!=null&&e.parent&&e.parent.add(t)}}Ad=new WeakSet,Ay=function(t,e,i){const n=(i==null?void 0:i.depth)||.1;return new DR(t,{font:e,size:1,depth:n,height:n,bevelEnabled:(i==null?void 0:i.bevel)||!1,bevelThickness:.01,bevelOffset:.01,bevelSize:.01})},Yi(Ka,Ad);function Pk(s,t,e,i,n){const o=new yP,r=1e-5,l=i-r;o.absarc(r,r,r,-Math.PI/2,-Math.PI,!0),o.absarc(r,t-l*2,r,Math.PI,Math.PI/2,!0),o.absarc(s-l*2,t-l*2,r,Math.PI/2,0,!0),o.absarc(s-l*2,r,r,0,-Math.PI/2,!0);const c=new _P(o,{bevelEnabled:!0,bevelSegments:n*2,steps:1,bevelSize:l,bevelThickness:i,curveSegments:n});return c.scale(1,1,1-i),c.center(),c.computeVertexNormals(),c}const bu=new Map;function Rk(s){let t="";switch(s){default:case"OpenSans":t="https://cdn.needle.tools/static/fonts/facetype/Open Sans_Regular_ascii.json";break;case"Helvetiker":t="https://raw.githubusercontent.com/mrdoob/three.js/master/examples/fonts/helvetiker_regular.typeface.json";break}if(bu.has(t)){const n=bu.get(t);if(n)return n}const e=new LR,i=new Promise((n,o)=>{e.load(t,r=>{bu.set(t,r),n(r)},void 0,o)});return bu.set(t,i),i}let ng=!1,sg=null;function Ok(s,t){if(sg===null){const e="https://cdn.needle.tools/static/models/shaderball.glb",i=new Va,n=M_(null);i.setDRACOLoader(n.dracoLoader),i.setKTX2Loader(n.ktx2Loader),ng=!0,sg=i.loadAsync(e).then(o=>{const r=o.scene;return r.position.y-=.5,r}).catch(o=>(console.warn("Failed to load shaderball mesh: "+o.message),uv())).finally(()=>{ng=!1})}if(ng){const e=uv();e.name="ShaderBall-Placeholder";const i=e.children[0];(i==null?void 0:i.type)==="Mesh"&&dv(i,t),s.add(e)}sg.then(e=>{s.children.forEach(o=>{o.name==="ShaderBall-Placeholder"&&s.remove(o)});const i=e.clone(),n=i.children[0];(n==null?void 0:n.type)==="Mesh"&&dv(n,t),s.add(i)})}function dv(s,t){var i;if((t==null?void 0:t.color)||(t==null?void 0:t.material)||(t==null?void 0:t.texture)){const n=(t==null?void 0:t.material)??((i=s.material)==null?void 0:i.clone())??new Vi;t.color&&"color"in n&&n.color instanceof ue&&n.color.set(t.color),t!=null&&t.texture&&"map"in n&&(n.map=t.texture),s.material=n}}function uv(){return new Mr().add(Ka.createPrimitive("Sphere",{material:new Ue({transparent:!0,opacity:.1})}))}const Hb=class{constructor(t,e,i){a(this,"_session");a(this,"_mode");a(this,"_init");a(this,"_renderer");a(this,"_camera");a(this,"_scene");a(this,"onEnd",()=>{var t;(t=this._session)==null||t.removeEventListener("end",this.onEnd),this._renderer.setAnimationLoop(null),this._renderer.dispose(),this._scene.clear()});a(this,"_lastTime",0);a(this,"onFrame",(t,e)=>{const i=t-this._lastTime;this.update(t,i),this._camera.parent!==this._scene&&this._scene.add(this._camera),this._renderer.render(this._scene,this._camera)});a(this,"_objects",[]);this._mode=t,this._init=e,this._session=i,this._session.addEventListener("end",this.onEnd),this._renderer=new Qa({alpha:!0}),this._renderer.setAnimationLoop(this.onFrame),this._renderer.xr.setSession(i),this._renderer.xr.enabled=!0,this._camera=new Re,this._scene=new In,this._scene.fog=new lw(4473924,10,250),this._scene.add(this._camera),this.setupScene()}static get active(){return this._active}static async start(t,e){if(this._active)return console.error("Cannot start a new XR session while one is already active"),null;if(this._requestInFlight)return console.error("Cannot start a new XR session while a request is already in flight"),null;if("xr"in navigator&&navigator.xr){if(!e)return console.error("XRSessionInit must be provided"),null;this._requestInFlight=!0;const i=await navigator.xr.requestSession(t,e);return i.addEventListener("end",()=>{this._active=null}),this._requestInFlight?(this._requestInFlight=!1,this._active=new Hb(t,e,i),this._active):(i.end(),null)}return null}static async handoff(){return this._active?this._active.handoff():null}static async stop(){this._requestInFlight=!1,this._active&&(await this._active.end(),await Xs(100)),this._active=null}get isAR(){return this._mode==="immersive-ar"}end(){return this._session?this._session.end():Promise.resolve()}async handoff(){if(!this._session)throw new Error("Cannot handoff a session that has already ended");const t={session:this._session,mode:this._mode,init:this._init};return await this.onBeforeHandoff(),this.onEnd(),this._session=null,t}async onBeforeHandoff(){await Xs(1e3),this._scene.clear()}setupScene(){this._scene.background=new ue(0),this._scene.add(new w_(5,10,1118481,1118481));const t=new sy(16777215,1);t.position.set(0,20,0),t.castShadow=!1,this._scene.add(t);const e=new sy(16777215,1);e.position.set(0,-1,0),e.castShadow=!1,this._scene.add(e);const i=new cw(16777215,1,100,1);i.position.set(0,2,0),i.castShadow=!1,i.distance=200,this._scene.add(i);const n=50;for(let o=0;o<100;o++){const r=new Vi({color:2236962,metalness:1,roughness:.8});this.isAR&&(r.emissive=new ue(Math.random(),Math.random(),Math.random()),r.emissiveIntensity=Math.random());const l=W.random(0,1)>.5?Jn.Sphere:Jn.Cube,c=Ka.createPrimitive(l,{material:r});c.position.x=W.random(-n,n),c.position.y=W.random(-2,n),c.position.z=W.random(-n,n),c.rotation.x=W.random(0,Math.PI*2),c.rotation.y=W.random(0,Math.PI*2),c.rotation.z=W.random(0,Math.PI*2),c.scale.multiplyScalar(.5+Math.random()*10);const h=c.position.distanceTo(this._camera.position)-c.scale.x;h<1&&c.position.multiplyScalar(1+1/h),this._objects.push(c),this._scene.add(c)}}update(t,e){const i=t*4e-4;for(let n=0;n<this._objects.length;n++){const o=this._objects[n];o.position.y+=Math.sin(i+n*.5)*.005,o.rotateY(.002)}}};let Cr=Hb;a(Cr,"_active",null),a(Cr,"_requestInFlight",!1);var Cd;(function(s){const t=[];function e(){if(!(t!=null&&t.length))return!1;for(const o of t)o.exportAndOpen();return!0}s.exportAndOpen=e;function i(o){t.push(o)}s.registerExporter=i;function n(o){if(!t)return;const r=t.indexOf(o);r>=0&&t.splice(r,1)}s.unregisterExporter=n})(Cd||(Cd={}));const fv="NeedleXRSession onStart",pv="NeedleXRSession onEnd",Rt=C("debugwebxr"),mv=C("stats");let og=0;function Tk(s){let t=null;const e=s;return e.getAROverlayContainer?t=e.getAROverlayContainer():t=s,t}kk();async function kk(){var s;if(C("debugasap")){let t=globalThis["needle:XRSession"];if(t instanceof Promise){delete globalThis["needle:XRSession"],be.addContextCreatedCallback(async e=>{if(!t)return;tc(!0);const i=await t;if(i){const n=te.getDefaultSessionInit("immersive-vr");te.setSession("immersive-vr",i,n,e.context)}else console.error("NeedleXRSession: ASAP session was rejected");t=void 0});return}}if("xr"in navigator){if(/WebXRViewer\//i.test(navigator.userAgent)){console.warn("WebXRViewer does not support addEventListener");return}(s=navigator.xr)==null||s.addEventListener("sessiongranted",async()=>{tc(!0),console.log("Received Session Granted..."),await Xs(100);const t=sessionStorage.getItem("needle_xr_session_mode"),e=sessionStorage.getItem("needle_xr_session_init")??null,i=e?JSON.parse(e):null;let n=null;if(YS()&&(await Cr.start(t||"immersive-vr",i||te.getDefaultSessionInit("immersive-vr")),await Ak(),n=await Cr.handoff()),n)te.setSession(n.mode,n.session,n.init,ne.Current);else if(t&&e){console.log("Session Granted: Restore last session");const o=JSON.parse(e);te.start(t,o).catch(r=>console.warn(r))}else te.start("immersive-vr").catch(o=>console.warn("Session Granted failed:",o))},{once:!0})}}function Ek(s,t){sessionStorage.setItem("needle_xr_session_mode",s),sessionStorage.setItem("needle_xr_session_init",JSON.stringify(t))}function Mk(){sessionStorage.removeItem("needle_xr_session_mode"),sessionStorage.removeItem("needle_xr_session_init")}const V_=new Set;be.registerCallback(me.ContextCreationStart,async s=>{V_.add(s.context)});be.registerCallback(me.ContextCreated,async s=>{V_.delete(s.context)});function YS(){return V_.size>0}function Ak(){return new Promise(s=>{const t=Date.now(),e=setInterval(()=>{(!YS()||Date.now()-t>6e4)&&(clearInterval(e),s())},100)})}J.isDesktop()&&U()&&window.addEventListener("keydown",s=>{(s.key==="x"||s.key==="Escape")&&te.active&&te.stop()});const mo=class{constructor(t,e,i,n){a(this,"context");a(this,"session");a(this,"mode");a(this,"controllers",[]);a(this,"_rigScale",1);a(this,"_lastRigScaleUpdate",-1);a(this,"_rigs",[]);a(this,"_viewerHitTestSource",null);a(this,"_defaultRig");a(this,"_xr_scripts");a(this,"_xr_update_scripts",[]);a(this,"_inactive_scripts",[]);a(this,"_controllerAdded");a(this,"_controllerRemoved");a(this,"_originalCameraWorldPosition");a(this,"_originalCameraWorldRotation");a(this,"_originalCameraWorldScale");a(this,"_originalCameraParent");a(this,"_mainCamera",null);a(this,"onRendererSessionSet",()=>{var t;this.running&&(this.context.renderer.xr.enabled=!0,this.context.renderer.xr.updateCamera(this.context.mainCamera),(t=this.context.mainCameraComponent)==null||t.applyClearFlags())});a(this,"onInputSourceAdded",t=>{if(t.targetRayMode==="screen")return;let e=0;for(let n=0;n<this.session.inputSources.length;n++)if(this.session.inputSources[n]===t){e=n;break}if(this.controllers.find(n=>n.inputSource===t)){console.debug("Controller already exists for input source",e);return}else if(this._newControllers.find(n=>n.inputSource===t)){console.debug("Controller already registered for input source",e);return}const i=new iS(this,t,e);this._newControllers.push(i)});a(this,"_ended",!1);a(this,"_newControllers",[]);a(this,"onEnd",t=>{var o,r,l;if(this._ended)return;this._ended=!0,console.debug("XR Session ended"),Mk(),this.onAfterRender(),this.revertCustomForward(),this._didStart=!1,this._previousCameraParent=null,qr(this.onBefore,oe.LateUpdate);const e=this.context.pre_render_callbacks.indexOf(this.onBeforeRender);e>=0&&this.context.pre_render_callbacks.splice(e,1);const i=this.context.post_render_callbacks.indexOf(this.onAfterRender);i>=0&&this.context.post_render_callbacks.splice(i,1),this.context.xr=null,this.context.renderer.xr.enabled=!1,this.context.pre_update_oneshot_callbacks.push(()=>{var c,h;(c=this.context.mainCameraComponent)==null||c.applyClearFlags(),(h=this.context.mainCameraComponent)==null||h.applyClippingPlane()}),xT({session:this});for(const c of mo._xrEndListeners)c({xr:this});const n=[...this.controllers];for(let c=0;c<n.length;c++)this.disconnectInputSource(n[c].inputSource);this._newControllers.length=0,this.controllers.length=0;for(const c of this._xr_scripts)(o=c==null?void 0:c.onLeaveXR)==null||o.call(c,{xr:this});(r=this.sync)==null||r.onExitXR(this),this.context.mainCamera&&((l=this._originalCameraParent)==null||l.add(this.context.mainCamera),this._originalCameraWorldPosition&&jt(this.context.mainCamera,this._originalCameraWorldPosition),this._originalCameraWorldRotation&&as(this.context.mainCamera,this._originalCameraWorldRotation),this._originalCameraWorldScale&&xd(this.context.mainCamera,this._originalCameraWorldScale)),this.context.requestSizeUpdate(),this._defaultRig.gameObject.removeFromParent(),tc(!1),performance.mark(pv),performance.measure("NeedleXRSession",fv,pv)});a(this,"_didStart",!1);a(this,"onBefore",t=>{var n,o,r,l,c,h,d,u;const e=t.xrFrame;if(!e)return;performance.mark("NeedleXRSession onBefore start"),this.context.xr=this,this.context.mainCameraComponent&&this.context.mainCameraComponent!==this._mainCamera&&(this._mainCamera=this.context.mainCameraComponent),((n=this.rig)==null?void 0:n.isActive)==!1&&(Rt&&console.warn("Latest rig is not active - trying to activate a different rig",this.rig),this.updateActiveXRRig()),this.rig&&((o=this._mainCamera)!=null&&o.gameObject)&&((l=(r=this._mainCamera)==null?void 0:r.gameObject)==null?void 0:l.parent)!==this.rig.gameObject&&this.rig.gameObject.add((c=this._mainCamera)==null?void 0:c.gameObject),this.internalUpdateState(),this.applyCustomForward();const i={xr:this};if(this._didStart){if(this.context.new_scripts_xr.length>0){const f=[...this.context.new_scripts_xr];for(let p=0;p<f.length;p++){const g=this.context.new_scripts_xr[p];if(!g||g.destroyed||((h=g.supportsXR)==null?void 0:h.call(g,this.mode))==!1){this.context.new_scripts_xr.splice(p,1);continue}if(!g.activeAndEnabled){this.context.new_scripts_xr.splice(p,1),this.markInactive(g);continue}if(this.addScript(g)){this.invokeCallback_EnterXR(g);for(const y of this.controllers)this.invokeCallback_ControllerAdded(g,y)}}}}else{if(this._didStart=!0,this.mode==="immersive-vr"){const p=dn(this.context.scene.children);if(p){const g=p.getSize(Q());if(g.length()>0){const y=this._defaultRig.gameObject;y.position.set(p.min.x+g.x*.5,p.min.y,p.max.z+g.z*.5+1.5);const b=p.getCenter(Q());b.y=y.position.y,y.lookAt(b)}}}vT({session:this});for(const p of mo._xrStartListeners)p(i);const f=[...this._xr_scripts];Rt&&console.log("NeedleXRSession start, handle scripts:",f);for(const p of f){if(p.destroyed){this._script_to_remove.push(p);continue}if(!p.activeAndEnabled){this.markInactive(p);continue}this.invokeCallback_EnterXR(p);for(const g of this.controllers)this.invokeCallback_ControllerAdded(p,g)}}this.syncCameraCullingMask();for(const f of this.controllers)f.onUpdate(e);if(this._newControllers.length>0){const f=[...this._newControllers];this._newControllers.length=0;for(const p of f){if(!p.connected){console.warn("New controller is not connected",p);continue}this.controllers.push(p);for(const g of this._xr_scripts){if(g.destroyed){this._script_to_remove.push(g);continue}g.activeAndEnabled!==!1&&this.invokeCallback_ControllerAdded(g,p)}}this.controllers.sort((p,g)=>p.index-g.index)}Rt&&this.context.time.frame%30===0&&this.controllers.length<=0&&this.session.inputSources.length>0&&(tc(!0),console.error("XRControllers are not added but inputSources are present")),performance.mark("NeedleXRSession update scripts start");for(const f of this._xr_update_scripts){if(f.destroyed===!0){this._script_to_remove.push(f);continue}if(f.activeAndEnabled===!1){this.markInactive(f);continue}f.onUpdateXR&&f.onUpdateXR(i)}if(performance.mark("NeedleXRSession update scripts end"),performance.measure("NeedleXRSession update scripts","NeedleXRSession update scripts start","NeedleXRSession update scripts end"),this.handleInactiveScripts(),this._script_to_remove.length>0){const f=[...new Set(this._script_to_remove)];this._script_to_remove.length=0;for(const p of f)!p.destroyed&&this.running&&((d=p.onLeaveXR)==null||d.call(p,i)),this.removeScript(p)}(u=this.sync)==null||u.onUpdate(this),this.onRenderDebug(),performance.mark("NeedleXRSession onBefore end"),performance.measure("NE XR frame","NeedleXRSession onBefore start","NeedleXRSession onBefore end")});a(this,"onBeforeRender",()=>{this.context.mainCamera&&this.updateFade(this.context.mainCamera)});a(this,"onAfterRender",()=>{if(this.onUpdateFade_PostRender(),J.isDesktop()||!this._renderOnceOnDevice){const t=this.context.renderer;if(t.xr.isPresenting&&this.context.mainCamera){this._renderOnceOnDevice=!0;const e=t.xr.enabled,i=t.getRenderTarget(),n=this.context.scene.background;t.xr.enabled=!1,t.setRenderTarget(null),this.isPassThrough&&(this.context.scene.background=null),this.context.composer?this.context.composer.render(this.context.time.deltaTime):t.render(this.context.scene,this.context.mainCamera),t.xr.enabled=e,t.setRenderTarget(i),this.context.scene.background=n}}});a(this,"_script_to_remove",[]);a(this,"_camera");a(this,"_cameraRenderParent",new F().rotateY(Math.PI));a(this,"_previousCameraParent");a(this,"_customforward",!0);a(this,"originalCameraNearPlane");a(this,"_viewerPose");a(this,"_transformOrientation",new H);a(this,"_transformPosition",new x);a(this,"_transition");var o,r;performance.mark(fv),Ek(t,n.init),this.session=e,this.mode=t,this.context=i,(Rt||C("console"))&&tc(!0),this._xr_scripts=[...n.scripts],this._xr_update_scripts=this._xr_scripts.filter(l=>typeof l.onUpdateXR=="function"),this._controllerAdded=n.controller_added,this._controllerRemoved=n.controller_removed,qo(this.onBefore,oe.LateUpdate),this.context.pre_render_callbacks.push(this.onBeforeRender),this.context.post_render_callbacks.push(this.onAfterRender),((o=n.init.optionalFeatures)!=null&&o.includes("hit-test")||(r=n.init.requiredFeatures)!=null&&r.includes("hit-test"))&&e.requestReferenceSpace("viewer").then(l=>{var c,h;return(h=(c=e.requestHitTestSource)==null?void 0:c.call(e,{space:l}))==null?void 0:h.then(d=>this._viewerHitTestSource=d).catch(d=>console.error(d))}).catch(l=>console.error(l)),this.context.mainCamera&&(this._originalCameraWorldPosition=ae(this.context.mainCamera,new x),this._originalCameraWorldRotation=Le(this.context.mainCamera,new H),this._originalCameraWorldScale=pt(this.context.mainCamera,new x),this._originalCameraParent=this.context.mainCamera.parent),this._defaultRig=new MT,this.context.scene.add(this._defaultRig.gameObject),this.addRig(this._defaultRig);for(let l=0;l<e.inputSources.length;l++){const c=e.inputSources[l];if(!c.handedness){console.warn("Input source in xr session has no handedness - ignoring",l);continue}this.onInputSourceAdded(c)}this.session.addEventListener("end",this.onEnd),this.session.addEventListener("inputsourceschange",l=>{for(const c of l.removed)this.disconnectInputSource(c);for(const c of l.added)this.onInputSourceAdded(c)}),this.context.xr=this,this.context.renderer.xr.setSession(this.session).then(this.onRendererSessionSet),"controllerAutoUpdate"in this.context.renderer.xr?(console.debug("Disabling three.js controllerAutoUpdate"),this.context.renderer.xr.controllerAutoUpdate=!1):Rt&&console.warn("controllerAutoUpdate is not available in three.js - cannot disable it")}static getXRSync(t){return this._sync||(this._sync=new Ck(t)),this._sync}static get currentSessionRequest(){return this._currentSessionRequestMode}static get active(){return this._activeSession}static get activeMode(){var t;return((t=this._activeSession)==null?void 0:t.mode)??null}static get xrSystem(){return"xr"in navigator?navigator.xr:void 0}static isXRSupported(){return Promise.all([this.isVRSupported(),this.isARSupported()]).then(t=>t.some(e=>e)).catch(()=>!1)}static isVRSupported(){return this.isSessionSupported("immersive-vr")}static isARSupported(){return this.isSessionSupported("immersive-ar")}static isSessionSupported(t){var e;return((e=this.xrSystem)==null?void 0:e.isSessionSupported(t).catch(i=>(Rt&&console.error(i),!1)))??Promise.resolve(!1)}static onSessionRequestStart(t){this._sessionRequestStartListeners.push(t)}static offSessionRequestStart(t){const e=this._sessionRequestStartListeners.indexOf(t);e>=0&&this._sessionRequestStartListeners.splice(e,1)}static onSessionRequestEnd(t){this._sessionRequestEndListeners.push(t)}static offSessionRequestEnd(t){const e=this._sessionRequestEndListeners.indexOf(t);e>=0&&this._sessionRequestEndListeners.splice(e,1)}static onXRSessionStart(t){this._xrStartListeners.push(t)}static offXRSessionStart(t){const e=this._xrStartListeners.indexOf(t);e>=0&&this._xrStartListeners.splice(e,1)}static onXRSessionEnd(t){this._xrEndListeners.push(t)}static offXRSessionEnd(t){const e=this._xrEndListeners.indexOf(t);e>=0&&this._xrEndListeners.splice(e,1)}static onControllerAdded(t){this._controllerAddedListeners.push(t)}static offControllerAdded(t){const e=this._controllerAddedListeners.indexOf(t);e>=0&&this._controllerAddedListeners.splice(e,1)}static onControllerRemoved(t){this._controllerRemovedListeners.push(t)}static offControllerRemoved(t){const e=this._controllerRemovedListeners.indexOf(t);e>=0&&this._controllerRemovedListeners.splice(e,1)}static offerSession(t,e,i){return"xr"in navigator&&navigator.xr&&"offerSession"in navigator.xr?(typeof navigator.xr.offerSession=="function"&&(console.log("WebXR offerSession is available - requesting mode: "+t),e=="default"&&(e=this.getDefaultSessionInit(t)),navigator.xr.offerSession(t,{...e}).then(n=>mo.setSession(t,n,e,i)).catch(n=>{console.log("XRSession offer rejected (perhaps because another call to offerSession was made or a call to requestSession was made)")})),!0):!1}static getDefaultSessionInit(t){switch(t){case"immersive-ar":const e=["anchors","local-floor","layers","dom-overlay","hit-test","unbounded"];return J.isVisionOS()||e.push("hand-tracking"),{optionalFeatures:e};case"immersive-vr":const i=["local-floor","bounded-floor","high-fixed-foveation-level","layers"];return J.isVisionOS()||i.push("hand-tracking"),{optionalFeatures:i};default:return console.warn("No default session init for mode",t),{}}}static async start(t,e,i){var l,c,h,d;if(J.isiOS()){if(t==="ar")if(await this.isARSupported())t="immersive-ar";else return Cd.exportAndOpen(),null}else t=="ar"&&(t="immersive-ar");if(U()&&C("debugxrpreroom"))return console.warn("Debug: Starting temporary XR session"),await Cr.start(t,e||mo.getDefaultSessionInit(t)),null;if(this._currentSessionRequest)return console.warn("A XRSession is already being requested"),(Rt||U())&&Me("A XRSession is already being requested"),this._currentSessionRequest.then(()=>this._activeSession);if(this._activeSession)return console.error("A XRSession is already running"),this._activeSession;if(i||(i=ne.Current),i||(i=be.All[0]),!i)throw new Error("No Needle Engine Context found");switch(performance.mark("NeedleXRSession start"),e||(e={}),t){case"immersive-ar":{if(await((l=this.xrSystem)==null?void 0:l.isSessionSupported("immersive-ar"))!==!0)return console.error(t+" is not supported by this browser."),null;const f=this.getDefaultSessionInit(t),p=Tk(i.domElement);p&&!J.isQuest()&&(f.domOverlay={root:p},f.optionalFeatures.push("dom-overlay")),e={...f,...e}}break;case"immersive-vr":{if(await((c=this.xrSystem)==null?void 0:c.isSessionSupported("immersive-vr"))!==!0)return console.error(t+" is not supported by this browser."),null;e={...this.getDefaultSessionInit(t),...e}}break;default:console.warn("No default session init for mode",t);break}e.optionalFeatures??(e.optionalFeatures=[]),e.requiredFeatures??(e.requiredFeatures=[]),await Cr.stop();const n=t=="immersive-ar"?i.scripts_immersive_ar:i.scripts_immersive_vr;Rt?console.log(`%cRequesting ${t} session`,"font-weight:bold;",e,n):console.log(`%cRequesting ${t} session`,"font-weight:bold;");for(const u of n)u.onBeforeXR&&u.onBeforeXR(t,e);for(const u of this._sessionRequestStartListeners)u({mode:t,init:e});Rt&&tt("Requesting "+t+" session ("+Date.now()+")"),this._currentSessionRequest=(h=navigator.xr)==null?void 0:h.requestSession(t,e),this._currentSessionRequestMode=t;const o=await((d=this._currentSessionRequest)==null?void 0:d.catch(u=>{console.error(u,"Code: "+u.code),u.code===9&&Me("Make sure your device has the required permissions (e.g. camera access)"),console.log("If the specified XR configuration is not supported (e.g. entering AR doesnt work) - make sure you access the website on a secure connection (HTTPS) and your device has the required permissions (e.g. camera access)"),location.protocol==="http:"&&Me("XR requires a secure connection (HTTPS)")}));this._currentSessionRequest=void 0,this._currentSessionRequestMode=null;for(const u of this._sessionRequestEndListeners)u({mode:t,init:e,newSession:o||null});if(!o)return console.warn("XR Session request was rejected"),null;const r=this.setSession(t,o,e,i);return performance.mark("NeedleXRSession end"),performance.measure("NeedleXRSession Startup","NeedleXRSession start","NeedleXRSession end"),r}static setSession(t,e,i,n){if(this._activeSession)return console.error("A XRSession is already running"),this._activeSession;const o=t=="immersive-ar"?n.scripts_immersive_ar:n.scripts_immersive_vr;return this._activeSession=new mo(t,e,n,{scripts:o,controller_added:this._controllerAddedListeners,controller_removed:this._controllerRemovedListeners,init:i}),e.addEventListener("end",this.onEnd),Rt?console.log(`%cStarted ${t} session`,"font-weight:bold;",o):console.log(`%cStarted ${t} session`,"font-weight:bold;"),this._activeSession}static stop(){var t;(t=this._activeSession)==null||t.end()}get sync(){return mo._sync}get running(){return!this._ended&&this.session!=null}get interactionMode(){return this.session.interactionMode}get visibilityState(){return this.session.visibilityState}get isVisibleBlurred(){return this.session.visibilityState==="visible-blurred"}get isSystemKeyboardSupported(){return this.session.isSystemKeyboardSupported}get environmentBlendMode(){return this.session.environmentBlendMode}get frame(){return this.context.xrFrame}get leftController(){return this.controllers.find(t=>t.side==="left")}get rightController(){return this.controllers.find(t=>t.side==="right")}getController(t){return typeof t=="number"?this.controllers[t]||null:this.controllers.find(e=>e.side===t)||null}get isPassThrough(){return!!(this.environmentBlendMode!=="opaque"&&this.interactionMode==="world-space"||this.mode==="immersive-ar"&&this.environmentBlendMode!=="opaque"&&this.controllers.some(t=>t.inputSource.targetRayMode==="tracked-pointer")||U()&&J.isDesktop()&&this.mode==="immersive-ar")}get isAR(){return this.mode==="immersive-ar"}get isVR(){return this.mode==="immersive-vr"}get isScreenBasedAR(){return this.isAR&&!this.isPassThrough}get posePosition(){return this._transformPosition}get poseOrientation(){return this._transformOrientation}get referenceSpace(){return this.context.renderer.xr.getReferenceSpace()}get viewerPose(){return this._viewerPose}get isTrackingImages(){if(this.frame&&"getImageTrackingResults"in this.frame&&typeof this.frame.getImageTrackingResults=="function")try{const t=this.frame.getImageTrackingResults();for(const e of t)if(e.trackingState==="tracked")return!0}catch{return!1}return!1}get rig(){const t=this._rigs[0]??null;return t!=null&&t.gameObject&&Sc(t.gameObject)||(t==null?void 0:t.isActive)===!1?(this.updateActiveXRRig(),this._rigs[0]??null):t}get rigScale(){return this._rigs[0]?(this._lastRigScaleUpdate!==this.context.time.frame&&(this._lastRigScaleUpdate=this.context.time.frame,this._rigScale=this._rigs[0].gameObject.worldScale.x),this._rigScale):1}addRig(t){this._rigs.indexOf(t)>=0||(t.priority===void 0&&(t.priority=0),this._rigs.push(t),this.updateActiveXRRig())}removeRig(t){const e=this._rigs.indexOf(t);e!==-1&&(this._rigs.splice(e,1),this.updateActiveXRRig())}setRigActive(t){const e=this._rigs.indexOf(t),i=this._rigs[0];this._rigs.splice(e,1),this._rigs.unshift(t),t.priority=(i==null?void 0:i.priority)??0,this.updateActiveXRRig()}getUserOffsetInRig(){var i;const t=(i=this.context.mainCamera)==null?void 0:i.position;if(!t||!this.rig)return Q(0,0,0);const e=Q(t);return e.x*=-1,e.z*=-1,e.applyQuaternion(Os(this.rig.gameObject.quaternion)),e}updateActiveXRRig(){const t=this._rigs[0]??null;this._defaultRig.gameObject.parent!==this.context.scene&&this.context.scene.add(this._defaultRig.gameObject),this._defaultRig.gameObject.visible=!0,this._rigs.includes(this._defaultRig)||this._rigs.push(this._defaultRig);let e=this._rigs[0];e&&e.priority===void 0&&(e.priority=0);for(let i=1;i<this._rigs.length;i++){const n=this._rigs[i];if(n.isActive){if(Sc(n.gameObject)){this._rigs.splice(i,1),i--;continue}(!e||e.isActive===!1||n.priority!==void 0&&n.priority>e.priority)&&(e=n)}}if(t!==e){const i=this._rigs.indexOf(e);i>=0&&this._rigs.splice(i,1),this._rigs.unshift(e)}Rt&&(t===e?console.log("Updated Active XR Rig:",e,"prev:",t):console.log("Updated Active XRRig:",e," (the same as before)"))}getHitTest(t){if(t)return this.getControllerHitTest(t);if(!this._viewerHitTestSource)return null;const e=this._viewerHitTestSource,i=this.frame.getHitTestResults(e);if(i.length>0){const n=i[0];return this.convertHitTestResult(n)}return null}getControllerHitTest(t){const e=t.getHitTestSource();if(!e)return null;const i=this.frame.getHitTestResultsForTransientInput(e);for(const n of i)if(n.inputSource===t.inputSource)for(const o of n.results)return this.convertHitTestResult(o);return null}convertHitTestResult(t){const e=this.context.renderer.xr.getReferenceSpace(),i=e&&t.getPose(e);if(i){const n=Q(i.transform.position),o=Os(i.transform.orientation),r=this.context.mainCamera;if((r==null?void 0:r.parent)!==this._cameraRenderParent&&n.applyMatrix4(ic),r!=null&&r.parent){n.applyMatrix4(r.parent.matrixWorld),o.multiply(Sn);const l=Le(r.parent);l.premultiply(Sn),o.premultiply(l)}return{hit:t,position:n,quaternion:o}}return null}convertSpace(t){const e=Q(t.position);e.applyMatrix4(ic);const i=Os(t.orientation);return i.premultiply(Sn),{position:e,quaternion:i}}disconnectInputSource(t){const e=(i,n,o)=>{if(i.inputSource===t){Rt&&console.log("Disconnecting controller",i.index),this.controllers.splice(o,1),this.invokeControllerEvent(i,this._controllerRemoved,"removed");const r={xr:this,controller:i,change:"removed"};for(const l of this._xr_scripts)l.onXRControllerRemoved&&l.onXRControllerRemoved(r);i.onDisconnected()}};for(let i=this.controllers.length-1;i>=0;i--){const n=this.controllers[i];e(n,this.controllers,i)}for(let i=this._newControllers.length-1;i>=0;i--){const n=this._newControllers[i];e(n,this._newControllers,i)}}end(){this._ended||this.session.end().catch(t=>console.warn(t))}onRenderDebug(){if(Rt)for(const t of this.controllers)t.onRenderDebug();if((Rt||mv)&&this.rig&&(og++,og>=20)){const t=this.rig.gameObject.worldPosition,e=this.rig.gameObject.worldForward;t.add(e.multiplyScalar(1.5));const i=this.rig.gameObject.worldUp;t.add(i.multiplyScalar(2.5));let n="";if(n+=`${this.context.time.smoothedFps.toFixed(0)} FPS`,n+=`, calls: ${this.context.renderer.info.render.calls}, tris: ${this.context.renderer.info.render.triangles.toLocaleString()}`,Rt||mv)for(const o of this.controllers)n+=`
${o.hand?"hand":"ctrl"} ${o.inputSource.handedness}[${o.index}] con:${o.connected} tr:${o.isTracking} hts:${o.hasHitTestSource?"yes":"no"}`;og=0,G.DrawLabel(t,n,void 0,1/60*20)}}addScript(t){return this._xr_scripts.includes(t)?!1:(Rt&&console.log("Register new XRScript",t),this._xr_scripts.push(t),typeof t.onUpdateXR=="function"&&this._xr_update_scripts.push(t),!0)}markInactive(t){if(!(this._inactive_scripts.indexOf(t)>=0)){this.removeScript(t,!1),this._inactive_scripts.push(t);for(const e of this.controllers)this.invokeCallback_ControllerRemoved(t,e);this.invokeCallback_LeaveXR(t)}}handleInactiveScripts(){if(this._inactive_scripts.length>0)for(let t=this._inactive_scripts.length-1;t>=0;t--){const e=this._inactive_scripts[t];if(e.activeAndEnabled){this._inactive_scripts.splice(t,1),this.addScript(e),this.invokeCallback_EnterXR(e);for(const i of this.controllers)this.invokeCallback_ControllerAdded(e,i)}}}removeScript(t,e=!0){Rt&&console.log("Remove XRScript",t);const i=this._xr_scripts.indexOf(t);i>=0&&this._xr_scripts.splice(i,1);const n=this._xr_update_scripts.indexOf(t);if(n>=0&&this._xr_update_scripts.splice(n,1),e){const o=this._inactive_scripts.indexOf(t);o>=0&&this._inactive_scripts.splice(o,1)}}invokeCallback_EnterXR(t){t.onEnterXR&&t.onEnterXR({xr:this})}invokeCallback_ControllerAdded(t,e){t.onXRControllerAdded&&t.onXRControllerAdded({xr:this,controller:e,change:"added"})}invokeCallback_ControllerRemoved(t,e){t.onXRControllerRemoved&&t.onXRControllerRemoved({xr:this,controller:e,change:"removed"})}invokeCallback_LeaveXR(t){t.onLeaveXR&&!t.destroyed&&t.onLeaveXR({xr:this})}syncCameraCullingMask(){var i;const t=this.context.xrCamera,e=(i=this.context.mainCameraComponent)==null?void 0:i.cullingMask;if(t&&e!==void 0){for(const n of t.cameras)n.layers.mask=e;t.layers.mask=e}else if(t){for(const n of t.cameras)n.layers.enableAll();t.layers.enableAll()}}invokeControllerEvent(t,e,i){for(let n=e.length-1;n>=0;n--){const o=e[n];if(o)try{o({xr:this,controller:t,change:i})}catch(r){console.error(r)}}}applyCustomForward(){var t;if(this.context.mainCamera&&this._customforward){this._camera=this.context.mainCamera,this._camera.parent!==this._cameraRenderParent&&(this._previousCameraParent=this._camera.parent,(t=this._previousCameraParent)==null||t.add(this._cameraRenderParent)),this._cameraRenderParent.name="XR Camera Render Parent",this._cameraRenderParent.add(this._camera);let e=.02;if(this.rig){const i=pt(this.rig.gameObject);e*=i.x}this._camera instanceof Re&&this._camera.near>e&&(this.originalCameraNearPlane=this._camera.near,this._camera.near=e)}}revertCustomForward(){this._camera&&this._previousCameraParent&&this._previousCameraParent.add(this._camera),this._previousCameraParent=null,this._camera instanceof Re&&this.originalCameraNearPlane!=null&&(this._camera.near=this.originalCameraNearPlane)}internalUpdateState(){const t=this.context.renderer.xr.getReferenceSpace();if(!t){this._viewerPose=void 0;return}if(this._viewerPose=this.frame.getViewerPose(t),this._viewerPose){const e=this._viewerPose.transform;this._transformPosition.set(e.position.x,e.position.y,e.position.z),this._transformOrientation.set(e.orientation.x,e.orientation.y,e.orientation.z,e.orientation.w)}}get transition(){return this._transition||(this._transition=new hv),this._transition}fadeTransition(){return this._transition||(this._transition=new hv),this._transition.fadeTransition()}updateFade(t){this._transition&&t instanceof Re&&this._transition.update(t,this.context.time.deltaTime)}onUpdateFade_PostRender(){var t;(t=this._transition)==null||t.remove()}};let te=mo;a(te,"_sync",null),a(te,"_currentSessionRequestMode",null),a(te,"_currentSessionRequest"),a(te,"_activeSession"),a(te,"_sessionRequestStartListeners",[]),a(te,"_sessionRequestEndListeners",[]),a(te,"_xrStartListeners",[]),a(te,"_xrEndListeners",[]),a(te,"_controllerAddedListeners",[]),a(te,"_controllerRemovedListeners",[]),a(te,"onEnd",()=>{Rt&&console.log("XR Session ended"),mo._activeSession=null});const rg=C("debugwebxr");class Ik{static tryFindAvatarObjects(t,e,i){if(i.head&&i.leftHand&&i.rightHand)return;const n=t.name.toLocaleLowerCase();!i.head&&n.includes("head")&&(rg&&console.log("FOUND AVATAR HEAD",t.name),i.head=new de("",e,t)),n.includes("hand")&&(!i.leftHand&&n.includes("left")&&(rg&&console.log("FOUND AVATAR LEFT HAND",t.name),i.leftHand=new de("",e,t)),!i.rightHand&&n.includes("right")&&(rg&&console.log("FOUND AVATAR RIGHT HAND",t.name),i.rightHand=new de("",e,t)));for(let o=0;o<t.children.length;o++){if(i.head&&i.leftHand&&i.rightHand)return;const r=t.children[o];this.tryFindAvatarObjects(r,e,i)}}}const ii=new x,gv=new x,yv=new H,Dk=C("debuggizmos"),Nn=8947848,ag=32,wn=class{constructor(){}static isGizmo(t){return t[Iy]!==void 0}static setVisible(t){for(const e of $e.timedObjectsBuffer)e.visible=t}static DrawLabel(t,e,i=.05,n=0,o,r,l){var d;if(!wn.enabled)return null;o||(o=Nn);const c=((d=te.active)==null?void 0:d.rigScale)??1,h=$e.getTextLabel(n,e,i*c,o,r);return l instanceof F&&l.add(h),h.position.x=t.x,h.position.y=t.y,h.position.z=t.z,h}static DrawRay(t,e,i=Nn,n=0,o=!0){if(!wn.enabled)return;const r=$e.getLine(n),l=r.geometry.getAttribute("position");l.setXYZ(0,t.x,t.y,t.z),ii.set(e.x,e.y,e.z).multiplyScalar(999999999),l.setXYZ(1,t.x+ii.x,t.y+ii.y,t.z+ii.z),l.needsUpdate=!0,r.material.color.set(i),r.material.depthTest=o,r.material.depthWrite=!1}static DrawDirection(t,e,i=Nn,n=0,o=!0,r=1){if(!wn.enabled)return;const l=$e.getLine(n),c=l.geometry.getAttribute("position");c.setXYZ(0,t.x,t.y,t.z),e.w!==void 0?(ii.set(0,0,-r),yv.set(e.x,e.y,e.z,e.w),ii.applyQuaternion(yv)):(ii.set(e.x,e.y,e.z),ii.multiplyScalar(r)),c.setXYZ(1,t.x+ii.x,t.y+ii.y,t.z+ii.z),c.needsUpdate=!0,l.material.color.set(i),l.material.depthTest=o,l.material.depthWrite=!1}static DrawLine(t,e,i=Nn,n=0,o=!0){if(!wn.enabled)return;const r=$e.getLine(n),l=r.geometry.getAttribute("position");l.setXYZ(0,t.x,t.y,t.z),l.setXYZ(1,e.x,e.y,e.z),l.needsUpdate=!0,r.material.color.set(i),r.material.depthTest=o,r.material.depthWrite=!1,r.material.fog=!1}static DrawCircle(t,e,i,n=Nn,o=0,r=!0){if(!wn.enabled)return;const l=$e.getCircle(o);l.position.set(t.x,t.y,t.z),l.scale.set(i,i,i),l.quaternion.setFromUnitVectors(this._up,ii.set(e.x,e.y,e.z).normalize()),l.material.color.set(n),l.material.depthTest=r,l.material.depthWrite=!1,l.material.fog=!1}static DrawWireSphere(t,e,i=Nn,n=0,o=!0){if(!wn.enabled)return;const r=$e.getSphere(e,n,!0);_c(r,t.x,t.y,t.z),r.material.color.set(i),r.material.depthTest=o,r.material.depthWrite=!1,r.material.fog=!1}static DrawSphere(t,e,i=Nn,n=0,o=!0){if(!wn.enabled)return;const r=$e.getSphere(e,n,!1);_c(r,t.x,t.y,t.z),r.material.color.set(i),r.material.depthTest=o,r.material.depthWrite=!1}static DrawWireBox(t,e,i=Nn,n=0,o=!0){if(!wn.enabled)return;const r=$e.getBox(n);r.position.set(t.x,t.y,t.z),r.scale.set(e.x,e.y,e.z),r.material.color.set(i),r.material.depthTest=o,r.material.wireframe=!0,r.material.depthWrite=!1,r.material.fog=!1}static DrawWireBox3(t,e=Nn,i=0,n=!0){if(!wn.enabled)return;const o=$e.getBox(i);o.position.copy(t.getCenter(ii)),o.scale.copy(t.getSize(ii)),o.material.color.set(e),o.material.depthTest=n,o.material.wireframe=!0,o.material.depthWrite=!1,o.material.fog=!1}static DrawArrow(t,e,i=Nn,n=0,o=!0,r=!1){if(!wn.enabled)return;const l=$e.getArrowHead(n);l.position.set(e.x,e.y,e.z),l.quaternion.setFromUnitVectors(this._up.set(0,1,0),ii.set(e.x,e.y,e.z).sub(gv.set(t.x,t.y,t.z)).normalize());const h=ii.set(e.x,e.y,e.z).sub(gv.set(t.x,t.y,t.z)).length()*.1;l.scale.set(h,h,h),l.material.color.set(i),l.material.depthTest=o,l.material.wireframe=r,this.DrawLine(t,e,i,n,o)}static DrawWireMesh(t){const e=$e.getMesh(t.duration??0);"mesh"in t?(e.geometry=t.mesh.geometry,e.matrix.copy(t.mesh.matrixWorld)):(e.geometry=t.geometry,e.matrix.copy(t.matrix)),e.matrixAutoUpdate=!1,e.matrixWorldAutoUpdate=!1,e.material.color.set(t.color??Nn),e.material.depthTest=t.depthTest??!0,e.material.wireframe=!0}};let G=wn;a(G,"enabled",!0),a(G,"_up",new x(0,1,0));const Lk=new gd(1,1,1);function H_(s=null){const t=new ue(s??14540253),e=new vP(Lk);return new hw(e,new dw({color:t}))}const Iy=Symbol("GizmoCache");class $e{static ensureFont(){let t=Be.FontLibrary.getFontFamily(this.familyName);if(!t){t=Be.FontLibrary.addFontFamily(this.familyName);const e=t.addVariant("normal","normal","https://uploads.needle.tools/include/font-msdf.json","https://uploads.needle.tools/include/font.png");e==null||e.addEventListener("ready",()=>{Be.update()})}}static getTextLabel(t,e,i,n,o){this.ensureFont();let r=this.textLabelCache.pop(),l=1;o&&typeof o=="string"&&(o==null?void 0:o.length)>=8&&o.startsWith("#")?(l=parseInt(o.substring(7),16)/255,o=o.substring(0,7),Dk&&console.log(o,l)):typeof o=="object"&&o.a!==void 0&&(l=o.a);const c={boxSizing:"border-box",fontFamily:this.familyName,width:"auto",fontSize:i,color:n,lineHeight:1,backgroundColor:o??void 0,backgroundOpacity:l,textContent:e,borderRadius:.5*i,padding:.8*i,whiteSpace:"pre",offset:.05*i};if(r)r.set(c);else{r=new _w(c);const h=this,d=r;d.setText=function(u){this.set({textContent:u}),h.tmuiNeedsUpdate=!0}}return this.tmuiNeedsUpdate=!0,this.registerTimedObject(ne.Current,r,t,this.textLabelCache),r}static getBox(t){let e=this.boxesCache.pop();if(!e){const i=new gd(1,1,1);e=new Z(i)}return this.registerTimedObject(ne.Current,e,t,this.boxesCache),e}static getLine(t){let e=this.linesCache.pop();if(!e){e=new yd;let i=e.geometry.getAttribute("position");i||(i=new $i(new Float32Array(2*3),3),e.geometry.setAttribute("position",i))}return e.frustumCulled=!1,this.registerTimedObject(ne.Current,e,t,this.linesCache),e}static getCircle(t){let e=this.circlesCache.pop();if(!e){e=new yd;let i=e.geometry.getAttribute("position");if(!i){i=new $i(new Float32Array(ag*3),3),e.geometry.setAttribute("position",i);const n=Q(0,1,0),o=Q(0,0,1),r=Q(o);r.cross(n).normalize();const l=Q(r),c=Math.PI*2/(ag-1);for(let h=0;h<ag+1;h++){const d=c*h;n.copy(l).multiplyScalar(Math.cos(d)*1),r.copy(o).multiplyScalar(Math.sin(d)*1);const u=n.add(r);i.setXYZ(h,u.x,u.y,u.z)}}}return e.frustumCulled=!1,this.registerTimedObject(ne.Current,e,t,this.circlesCache),e}static getSphere(t,e,i){let n=this.spheresCache.pop();return n||(n=new Z(new wp(1,8,8))),n.scale.set(t,t,t),n.material.wireframe=i,this.registerTimedObject(ne.Current,n,e,this.spheresCache),n}static getArrowHead(t){let e=this.arrowHeadsCache.pop();return e||(e=new Z(new bP(0,.5,1,8))),this.registerTimedObject(ne.Current,e,t,this.arrowHeadsCache),e}static getMesh(t){let e=this.mesh.pop();return e||(e=new Z,e.material=new Ue),this.registerTimedObject(ne.Current,e,t,this.mesh),e}static registerTimedObject(t,e,i,n){if(!t){console.error("No Needle Engine context available. Did you call a Gizmos function in global scope?");return}const o=this.contextBeforeRenderCallbacks.get(t),r=this.contextPostRenderCallbacks.get(t);if(o){if(t.pre_render_callbacks[t.pre_render_callbacks.length-1]!==o){const l=t.pre_render_callbacks.indexOf(o);l>=0&&t.pre_render_callbacks.splice(l,1),t.pre_render_callbacks.push(o)}}else{const l=()=>{this.onBeforeRender(t,this.timedObjectsBuffer)};this.contextBeforeRenderCallbacks.set(t,l),t.pre_render_callbacks.push(l)}if(r){if(t.post_render_callbacks[t.post_render_callbacks.length-1]!==r){const l=t.post_render_callbacks.indexOf(r);l>=0&&t.post_render_callbacks.splice(l,1),t.post_render_callbacks.push(r)}}else{const l=()=>{this.onPostRender(t,this.timedObjectsBuffer,this.timesBuffer)};this.contextPostRenderCallbacks.set(t,l),t.post_render_callbacks.push(l)}e.traverse(l=>{l.layers.disableAll(),l.layers.enable(2)}),e.renderOrder=999999,e[Iy]=n,e.castShadow=!1,e.receiveShadow=!1,e.isGizmo=!0,this.timedObjectsBuffer.push(e),this.timesBuffer.push(ne.Current.time.realtimeSinceStartup+i),t.scene.add(e)}static onBeforeRender(t,e){this.tmuiNeedsUpdate&&(this.tmuiNeedsUpdate=!1,Be.update());for(let i=0;i<e.length;i++){const n=e[i];if(t.mainCamera&&n instanceof Be.MeshUIBaseElement){if(Sc(n))continue;const o=t.isInVR,r=!1,l=!o;Mp(n,t.mainCamera,r,l)}}}static onPostRender(t,e,i){const n=t.time.realtimeSinceStartup;for(let o=e.length-1;o>=0;o--){const r=e[o];n>=i[o]-1e-6&&(e.splice(o,1),i.splice(o,1),r.removeFromParent(),Sc(r)!=!0&&r[Iy].push(r))}}}a($e,"familyName","needle-gizmos"),a($e,"linesCache",[]),a($e,"circlesCache",[]),a($e,"spheresCache",[]),a($e,"boxesCache",[]),a($e,"arrowHeadsCache",[]),a($e,"mesh",[]),a($e,"textLabelCache",[]),a($e,"timedObjectsBuffer",new Array),a($e,"timesBuffer",new Array),a($e,"contextPostRenderCallbacks",new Map),a($e,"contextBeforeRenderCallbacks",new Map),a($e,"tmuiNeedsUpdate",!1);const on=C("debugphysics"),_v=new Nr;class $o{constructor(){a(this,"ray");a(this,"cam");a(this,"screenPoint");a(this,"raycaster");a(this,"results");a(this,"targets");a(this,"recursive",!0);a(this,"minDistance");a(this,"maxDistance");a(this,"lineThreshold");a(this,"layerMask");a(this,"ignore");a(this,"testObject");a(this,"useAcceleratedRaycast")}screenPointFromOffset(t,e){this.screenPoint===void 0&&(this.screenPoint=new ce),this.screenPoint.x=t/window.innerWidth*2-1,this.screenPoint.y=-(e/window.innerHeight)*2+1}setLayer(t){_v.set(t),this.layerMask=_v}setMask(t){this.layerMask||(this.layerMask=new Nr);const e=this.layerMask;e?e.mask=t:this.layerMask=t}}a($o,"AllLayers",4294967295);class KS{constructor(t,e,i){a(this,"distance");a(this,"point");a(this,"object");this.object=t,this.distance=e,this.point=i}}const cp=class{constructor(t){a(this,"context");a(this,"engine");a(this,"raycaster",new Sp);a(this,"defaultRaycastOptions",new $o);a(this,"targetBuffer",new Array(1));a(this,"defaultThresholds",{Mesh:{},Line:{threshold:-1},LOD:{},Points:{threshold:0},Sprite:{}});a(this,"sphereResults",new Array);a(this,"sphereMask",new Nr);a(this,"sphere",new Cp);a(this,"tempBoundingBox",new En);this.context=t}static get raycasting(){return this._raycasting>0}raycastPhysicsFast(t,e=void 0,i=1/0,n=!0){var o;return((o=this.context.physics.engine)==null?void 0:o.raycast(t,e,{maxDistance:i,solid:n}))??null}raycastPhysicsFastAndGetNormal(t,e=void 0,i=1/0,n=!0){var o;return((o=this.context.physics.engine)==null?void 0:o.raycastAndGetNormal(t,e,{maxDistance:i,solid:n}))??null}sphereOverlapPhysics(t,e){var i;return((i=this.context.physics.engine)==null?void 0:i.sphereOverlap(t,e))??null}sphereOverlap(t,e,i=!0,n=!1,o=null){if(this.sphereResults.length=0,!this.context.scene)return this.sphereResults;const r=this.sphereMask;r.enableAll(),r.disable(2);for(const l of this.context.scene.children)this.intersectSphere(l,t,e,r,this.sphereResults,i,n,o);return this.sphereResults.sort((l,c)=>l.distance-c.distance)}raycastFromRay(t,e=null){const i=e??this.defaultRaycastOptions;i.ray=t;const n=this.raycast(i);return i===this.defaultRaycastOptions&&(i.ray=void 0),n}raycast(t=null){on&&performance.mark("raycast.start"),t||(t=this.defaultRaycastOptions);const e=t.screenPoint??this.context.input.mousePositionRC,i=t.raycaster??this.raycaster;if(i.near=t.minDistance??0,i.far=t.maxDistance??1/0,i.params=this.defaultThresholds,t.lineThreshold===void 0&&(t.lineThreshold=-1),i.params.Line={threshold:t.lineThreshold},t.ray)i.ray.copy(t.ray);else{const l=t.cam??this.context.mainCamera;if(!l)return on&&console.error("Can not perform raycast - no main camera found"),this.defaultRaycastOptions.results&&(this.defaultRaycastOptions.results.length=0),this.defaultRaycastOptions.results??[];const c=this.context.xrCamera;this.context.isInXR&&c instanceof xP&&c.cameras.length>0?i.setFromCamera(e,c.cameras[0]):i.setFromCamera(e,l)}let n=t.targets;n||(n=this.targetBuffer,n.length=1,n[0]=this.context.scene);let o=t.results;this.defaultRaycastOptions.results&&(this.defaultRaycastOptions.results.length=0),o||(this.defaultRaycastOptions.results||(this.defaultRaycastOptions.results=new Array),o=this.defaultRaycastOptions.results),t.layerMask!==void 0?t.layerMask instanceof Nr?i.layers.mask=t.layerMask.mask:i.layers.mask=t.layerMask:(i.layers.enableAll(),i.layers.disable(2)),on&&console.time("raycast"),o.length=0,cp._raycasting++,this.intersect(this.raycaster,n,o,t),o.sort((l,c)=>l.distance-c.distance);const r=t.ignore;return r!==void 0&&r.length>0&&(o=o.filter(l=>!r.includes(l.object))),cp._raycasting--,on&&(console.timeEnd("raycast"),console.warn("#"+this.context.time.frame+", hits:",o!=null&&o.length?[...o]:"nothing"),performance.mark("raycast.end"),performance.measure("raycast","raycast.start","raycast.end")),o}intersect(t,e,i,n){var o,r,l;for(const c of e){if(!c||c.visible===!1||G.isGizmo(c)||n.lineThreshold!==void 0&&n.lineThreshold<0&&c instanceof yd)continue;let h=!0;const d=c,u=d.geometry;if(n.testObject){const f=(o=n.testObject)==null?void 0:o.call(n,c);if(f===!1)continue;f==="continue in children"&&(h=!1)}if(h&&(u&&bv(u)||(h=!1)),h){const f=Pw(c);f&&(d.geometry=f);const p=i.length;let g=!0;if(n.precise===!1&&(g=!1),g||(g=((l=(r=u.getAttribute("position"))==null?void 0:r.array)==null?void 0:l.length)<64),d instanceof yc&&(g=!1),!g&&Bk(d,t,i)||(n.useAcceleratedRaycast!==!1?Cf.runMeshBVHRaycast(t,d,i,this.context):t.intersectObject(d,!1,i)),on&&i.length!=p){const y=i[i.length-1],b=f?8969557:7798784;G.DrawWireSphere(y.point,.1,b,1,!1),G.DrawWireMesh({mesh:c,depthTest:!1,duration:.2,color:b})}d.geometry=u}n.recursive!==!1&&this.intersect(t,c.children,i,n)}return i}intersectSphere(t,e,i,n,o,r,l,c){let h=t&&t.isMesh&&t.layers.test(n)&&!G.isGizmo(t);h&&(h=t.visible),h&&(h=!(t instanceof yd)),h&&(h=!(t instanceof yc));const d=t,u=d.geometry;if(h&&c){const f=c(t);if(f===!1)return;f==="continue in children"&&(h=!1)}if(u&&bv(u)||(h=!1),h){if(l){const f=this.sphere;f.center.copy(e),f.radius=i;const p=o.length;if(Cf.runMeshBVHRaycast(this.sphere,d,o,this.context),p!=o.length&&!r)return}else if(u.boundingBox||u.computeBoundingBox(),u.boundingBox){d.matrixWorldNeedsUpdate&&d.updateWorldMatrix(!1,!1);const f=this.tempBoundingBox.copy(u.boundingBox).applyMatrix4(d.matrixWorld),p=this.sphere;if(p.center.copy(e),p.radius=i,p.intersectsBox(f)){const g=ae(t),y=g.distanceTo(p.center),b=new KS(t,y,g);if(o.push(b),!r)return}}}if(t.children)for(const f of t.children){const p=o.length;if(this.intersectSphere(f,e,i,n,o,r,l,c),p!=o.length&&!r)return}}};let Bh=cp;a(Bh,"_raycasting",0);function bv(s){return!(s.index&&s.index.array.length<3)}const ha=new Cp,vu=new $a,jk=new aw;function Bk(s,t,e){const i=s._computeIntersections;if(!i)return!1;let n=s["_computeIntersections:Needle"];return n||(n=s["_computeIntersections:Needle"]=function(o,r,l){const c=this,h=c.geometry.boundingSphere;if(h){if(c instanceof yc){vu.setFromNormalAndCoplanarPoint(Q(0,1,0),Q(0,-c.position.y,0)),vu.applyMatrix4(c.matrixWorld,jk);const u=o.ray.intersectPlane(vu,Q());if(u){ha.copy(h),ha.applyMatrix4(c.matrixWorld);const p=Q(u).sub(o.ray.origin).length(),g=ha.radius*.5;p<g&&r.push({distance:p,point:u,object:c,normal:vu.normal.clone()})}return}ha.copy(h),ha.applyMatrix4(c.matrixWorld);const d=o.ray.intersectSphere(ha,Q());if(d){const u=Q(d).sub(o.ray.origin),f=u.length();if(f>ha.radius){const p=u.clone().normalize();r.push({distance:f,point:d,object:c,normal:p})}}}}),s._computeIntersections=n,t.intersectObject(s,!1,e),s._computeIntersections=i,!0}var Cf;(function(s){function t(_,v,S,T){var M,k,B;if(!v.geometry||!v.geometry.hasAttribute("position"))return!1;const O=v.geometry;if(v!=null&&v.isSkinnedMesh){const I=v,E=I.bvhNeedsUpdate;if(!I.staticGenerator)l(),o&&(I.staticGenerator=new o(v),I.staticGenerator.applyWorldTransforms=!1,I.staticGeometry=I.staticGenerator.generate(),O.boundsTree=r==null?void 0:r.call(I.staticGeometry),I.staticGeometryLastUpdate=performance.now()+Math.random()*200,I.autoUpdateMeshBVH===void 0&&(I.autoUpdateMeshBVH=!1));else if(O.boundsTree&&(I.autoUpdateMeshBVH===!0||E===!0)){const L=performance.now(),V=L-I.staticGeometryLastUpdate;(E||V>100)&&(I.bvhNeedsUpdate=!1,I.staticGeometryLastUpdate=L,(M=I.staticGenerator)==null||M.generate(I.staticGeometry),O.boundsTree.refit())}}else if(!O.boundsTree){h||b();let I=!0;if((T.xr||O[p]===!1||(k=O.getAttribute("position"))!=null&&k.isInterleavedBufferAttribute||O.index&&((B=O.index)!=null&&B.isInterleavedBufferAttribute))&&(I=!1),I&&u){if(O[f]===void 0){let E=null;if(y.length>0){const L=y.shift();L&&!L.running&&(E=L)}if(!E&&g.length<3&&(E=new u,g.push(E)),E!=null&&!E.running){const L=v.name;on&&console.log("<<<< worker start",L,E),O[f]="queued",performance.mark("bvh.create.start");const V=O.clone();try{E.generate(V).then(A=>{O[f]="done",O.boundsTree=A}).catch(A=>{O[f]="failed - "+(A==null?void 0:A.message),O[p]=!1,on&&console.error("Failed to generate mesh bvh on worker",A)}).finally(()=>{on&&console.log(">>>>> worker done",L,{hasBoundsTre:O.boundsTree!=null}),y.push(E),V.dispose(),performance.mark("bvh.create.end"),performance.measure("bvh.create (worker)","bvh.create.start","bvh.create.end")})}catch(A){console.error("Failed to generate mesh bvh on worker",A)}}else on&&console.warn("No worker available")}}else(!d||!I)&&(l(),n&&(performance.mark("bvh.create.start"),O.boundsTree=new n(O),performance.mark("bvh.create.end"),performance.measure("bvh.create","bvh.create.start","bvh.create.end")))}if(_ instanceof Sp){const I=_,E=v.raycast;O.boundsTree?(l(),i&&(v.acceleratedRaycast||(v.acceleratedRaycast=i.bind(v),on&&console.debug(`Physics: bind acceleratedRaycast fn to "${v.name}"`)),v.raycast=v.acceleratedRaycast)):on&&console.warn("No bounds tree found for mesh",v.name,{workerTask:O[f],hasAcceleratedRaycast:i!=null});const L=I.firstHitOnly;return I.firstHitOnly=!1,I.intersectObject(v,!1,S),I.firstHitOnly=L,v.raycast=E,!0}else if(_ instanceof Cp){const I=O.boundsTree;if(I){const E=_;if(c.copy(v.matrixWorld).invert(),E.applyMatrix4(c),I.intersectsSphere(E)){const V=ae(v),A=V.distanceTo(E.center),D=new KS(v,A,V);S.push(D)}}return!0}return!1}s.runMeshBVHRaycast=t;let e=!1,i=null,n=null,o=null,r=null;function l(){e||(e=!0,ts(()=>import("./index.bf5a704e.js"),["./index.bf5a704e.js","./MeshBVH.f9f8c76a.js","./three@0.169.5.js"],import.meta.url).then(_=>{i=_.acceleratedRaycast,n=_.MeshBVH,o=_.StaticGeometryGenerator,r=_.computeBoundsTree}).catch(_=>{(on||U())&&console.error("Failed to load BVH library...",_.message)}))}const c=new le;let h=!1,d=!1,u=null;const f=Symbol("Needle:MeshBVH-Worker"),p=Symbol("Needle:MeshBVH-CanUseWorker"),g=[],y=[];function b(){h=!0,d=!0,ts(()=>import("./GenerateMeshBVHWorker.5abf722c.js"),["./GenerateMeshBVHWorker.5abf722c.js","./three@0.169.5.js","./MeshBVH.f9f8c76a.js"],import.meta.url).then(_=>{u=_.GenerateMeshBVHWorker}).catch(_=>{(on||U())&&console.warn("Failed to setup mesh bvh worker")}).finally(()=>{d=!1})}})(Cf||(Cf={}));const vv=Symbol("gltf-loader-internal-usage-tracker"),Fk=C("debugusers"),rd=class{constructor(t){a(this,"parser");a(this,"_getDependency");a(this,"_loadingId");a(this,"_loadedObjects",new Set);this.parser=t,this._getDependency=this.parser.getDependency,this._loadingId=Date.now().toString()}get name(){return"NEEDLE_internal_usage_tracker"}static isLoading(t){return rd._loadingProcesses>0}beforeRoot(){rd._loadingProcesses++;const t=this,e=this._getDependency;return this.parser.getDependency=function(i,n){const o=e.call(this,i,n);return o.then(r=>(r&&(t._loadedObjects.add(r),r[vv]=t._loadingId),r)),o},null}afterRoot(t){rd._loadingProcesses--,this.parser.getDependency=this._getDependency;for(const e of this._loadedObjects)delete e[vv],e instanceof F&&(e.parent||e instanceof Z&&setTimeout(()=>{Fk&&console.warn("> GLTF LOADER: Mesh not used in scene!",e),e.material=null,e.geometry=null},1e3));return null}};let Fh=rd;a(Fh,"_loadingProcesses",0);class zk{constructor(){window.addEventListener("unhandledrejection",t=>{var i;if(t.defaultPrevented)return;const e=(i=t==null?void 0:t.reason)==null?void 0:i.path;if(e){const n=e[0];n&&n.tagName==="IMG"&&(console.warn(`Could not load image:
`+n.src),t.preventDefault())}})}}const Bp=C("trackresources");function JS(){return Bp==="dispose"}let Ja=!0;Bp===0&&(Ja=!1);function vL(s){Ja=s}function Uk(){return Ja}const ZS=Symbol("disposable");function eC(s,t){s&&(s[ZS]=t,Ia&&console.warn("Set disposable",t,s))}const tC=Symbol("disposed");function xL(s){return s[tC]===!0}function Ne(s){var t;if(s){if(s[ZS]===!1){Ia&&console.warn("Object is marked as not disposable",s);return}if(s[tC]=!0,s instanceof In)Ne(s.environment),Ne(s.background),Ne(s.customDepthMaterial),Ne(s.customDistanceMaterial);else if(s instanceof Eo)Ne(s.geometry),Ne(s.material),Ne(s.skeleton),Ne(s.bindMatrix),Ne(s.bindMatrixInverse),Ne(s.customDepthMaterial),Ne(s.customDistanceMaterial),s.geometry=null,s.material=null,s.visible=!1;else if(s instanceof Z)Ne(s.geometry),Ne(s.material),Ne(s.customDepthMaterial),Ne(s.customDistanceMaterial),s.geometry=null,s.material=null,s.visible=!1;else if(s instanceof ko){bl(s);for(const e of Object.keys(s.attributes)){const i=s.attributes[e];Ne(i)}}else if(s instanceof $i||s instanceof uw)Ia&&console.warn("BufferAttribute dispose not supported",s.count);else if(s instanceof Array)for(const e of s)e instanceof De&&Ne(e);else if(s instanceof De){bl(s);for(const i of Object.keys(s)){const n=s[i];n instanceof Je&&(Ne(n),s[i]=null)}const e=s.uniforms;if(e)for(const i of Object.keys(e)){const n=e[i];n instanceof Je?(Ne(n),e[i]=null):n instanceof Er&&(Ne(n.value),n.value=null)}}else s instanceof Je?(bl(s),bl(s.source),((t=s.source)==null?void 0:t.data)instanceof ImageBitmap&&bl(s.source.data)):s instanceof wP?(bl(s.boneTexture),s.boneTexture=null):s instanceof SP||!(s instanceof F)&&Ia&&console.warn("Unknown object type",s)}}function bl(s){s&&((Ia||JS()||Bp)&&console.warn("üß® FREE",s),s instanceof ImageBitmap?s.close():s instanceof CP?s.data=null:s.dispose())}function Nk(s){(s instanceof Z||s instanceof Eo)&&(s.material=null,s.geometry=null)}const $k=new Set;function iC(s,t,e=null,i){if(i||(i=$k,i.clear()),!s)return i;const n=s[Pd];if(n)for(const o of n)i.has(o)||(e==null?void 0:e.call(null,o))!==!1&&(i.add(o),t&&iC(o,!0,e,i));return i}function wL(s){return s[Th]}const Ia=C("debugresourceusers")||C("debugmemory"),Pd=Symbol("needle-resource-users"),Th=Symbol("needle-resource-users-count");function vi(s,t){L_(s,t,function(e,i){Ja&&!Bh.raycasting&&(Pf(Pd,this,e,!1),Pf(Pd,this,i,!0))})}Ja&&(vi(Z.prototype,"material"),vi(Z.prototype,"geometry"),vi(De.prototype,"map"),vi(De.prototype,"bumpMap"),vi(De.prototype,"alphaMap"),vi(De.prototype,"normalMap"),vi(De.prototype,"displacementMap"),vi(De.prototype,"roughnessMap"),vi(De.prototype,"metalnessMap"),vi(De.prototype,"emissiveMap"),vi(De.prototype,"specularMap"),vi(De.prototype,"envMap"),vi(De.prototype,"lightMap"),vi(De.prototype,"aoMap"),vi(De.prototype,"gradientMap"));function Wk(s){if(Ja===!1)return;const t=s[Pd];if(t)for(const e of t)Pf(Pd,e,s,!1)}Ja&&L_(De.prototype,"dispose",function(){Wk(this)});let Dy=0;function Pf(s,t,e,i){if(Dy>0)return;if(Array.isArray(e)){for(const o of e)Pf(s,t,o,i);return}if(!e)return;let n=e[s];if(n||(n=new Set),i){if(t&&!n.has(t)){n.add(t);let o=e[Th]||0;o+=1,e[Th]=o,Ia&&console.warn(`üü¢ Added user of "${e.type}"`,t,e,o,"users:",n)}}else if(t&&n.has(t)){n.delete(t);let o=e[Th]||0;o>0&&(o-=1,e[Th]=o),Ia&&console.warn(`üî¥ Removed user of "${e.type}"`,t,e,o,"users:",n),o<=0&&(Fh.isLoading(e)||(Bp&&console.warn(`üî¥ Removed all user of "${e.type}"`,e),JS()&&Ne(e)))}e[s]=n}try{L_(Qa.prototype,"render",function(){Dy++},function(){Dy--})}catch(s){console.warn("Could not wrap WebGLRenderer.render",s)}const xv=C("debugcomponentevents");class Fp{static addComponentLifecylceEventListener(t,e){this.eventListeners.has(t)&&this.eventListeners.set(t,[]);let i=this.eventListeners.get(t);i||(i=[]),i.push(e),this.eventListeners.set(t,i),xv&&console.log("Added event listener for "+t,this.eventListeners)}static removeComponentLifecylceEventListener(t,e){const i=this.eventListeners.get(t);if(!i)return;const n=i.indexOf(e);n<0||i.splice(n,1)}static dispatchComponentLifecycleEvent(t,e){const i=this.eventListeners.get(t);if(xv&&console.log("Dispatching event "+t,i),!!i)for(const n of i)n(e)}}a(Fp,"eventListeners",new Map);const Rd=Symbol("NEEDLE_NEED_UPDATE_INSTANCE"),nC=Symbol("isUsingInstancing"),sC=Symbol("instancingRenderer"),kh=Symbol("instancingAutoUpdateBounds");class is{static isUsingInstancing(t){return t[nC]===!0}static getRenderer(t){return t[sC]||null}setAutoUpdateBounds(t,e){const i=is.getRenderer(t);i&&(i[kh]=e)}static markDirty(t,e=!0){if(t&&(this.isUsingInstancing(t)&&(t[Rd]=!0,t.matrixWorldNeedsUpdate=!0),e))for(const i of t.children)is.markDirty(i,!0)}}function sc(s,t){try{t?s(t):s()}catch(e){return console.error(e),!1}return!0}const Ly=C("debugnewscripts"),Vk=C("debughierarchy"),Xe=[];function Hk(){return Xe.length>0}function Rf(s){if(Ly&&console.log("Register new components",s.new_scripts.length,[...s.new_scripts],s.alias?"element: "+s.alias:s.hash,s),s.new_scripts_pre_setup_callbacks.length>0){for(const t of s.new_scripts_pre_setup_callbacks)t&&t();s.new_scripts_pre_setup_callbacks.length=0}if(!(s.new_scripts.length<=0)){Xe.length=0,s.new_scripts.length>0&&Xe.push(...s.new_scripts),s.new_scripts.length=0;for(let t=0;t<Xe.length;t++)try{const e=Xe[t];if(e.isComponent!==!0){(U()||Ly)&&console.error(`Registered script is not a Needle Engine component. 
The script will be ignored. Please make sure your component extends "Behaviour" imported from "@needle-tools/engine"
`,e),Xe.splice(t,1),t--;continue}if(e.destroyed)continue;if(!e.gameObject){console.warn(`Component can not be initialized: no GameObject assigned.
Did you add and remove a component in the same frame?`),Xe.splice(t,1),t--;continue}e.context=s,zh(e.gameObject),G_(e,s)}catch(e){console.error(e),bo(Xe[t],s),Xe.splice(t,1),t--}for(let t=0;t<Xe.length;t++)try{const e=Xe[t];if(e.destroyed){bo(Xe[t],s),Xe.splice(t,1),t--;continue}if(e.registering)try{e.registering()}catch(i){console.error(i)}e.__internalAwake!==void 0&&(e.gameObject||console.error("Calling awake for a component without a GameObject",e,e.gameObject),zh(e.gameObject),e.activeAndEnabled&&sc(e.__internalAwake.bind(e)))}catch(e){console.error(e),bo(Xe[t],s),Xe.splice(t,1),t--}for(let t=0;t<Xe.length;t++)try{const e=Xe[t];if(e.destroyed||e.enabled===!1||(zh(e.gameObject),e.activeAndEnabled===!1))continue;e.__internalEnable!==void 0&&(e.enabled=!0,sc(e.__internalEnable.bind(e)))}catch(e){console.error(e),bo(Xe[t],s),Xe.splice(t,1),t--}for(let t=0;t<Xe.length;t++)try{const e=Xe[t];if(e.destroyed||!e.gameObject)continue;s.new_script_start.push(e)}catch(e){console.error(e),bo(Xe[t],s),Xe.splice(t,1),t--}Xe.length=0;for(const t of s.new_scripts_post_setup_callbacks)t&&t();s.new_scripts_post_setup_callbacks.length=0}}function Gk(s){s&&(s.__internalDisable(!0),bo(s,s.context))}function oC(s,t){for(let e=0;e<s.new_script_start.length;e++)try{const i=s.new_script_start[e];if(t!==void 0&&i.gameObject!==t||i.destroyed||i.activeAndEnabled===!1)continue;sc(i.__internalAwake.bind(i)),i.enabled&&(sc(i.__internalEnable.bind(i)),sc(i.__internalStart.bind(i)),s.new_script_start.splice(e,1),e--)}catch(i){console.error(i),bo(s.new_script_start[e],s),s.new_script_start.splice(e,1),e--}}function G_(s,t){t.scripts.indexOf(s)===-1&&(t.scripts.push(s),s.earlyUpdate&&t.scripts_earlyUpdate.push(s),s.update&&t.scripts_update.push(s),s.lateUpdate&&t.scripts_lateUpdate.push(s),s.onBeforeRender&&t.scripts_onBeforeRender.push(s),s.onAfterRender&&t.scripts_onAfterRender.push(s),s.onPausedChanged&&t.scripts_pausedChanged.push(s),lg(s,null)&&t.new_scripts_xr.push(s),lg(s,"immersive-vr")&&t.scripts_immersive_vr.push(s),lg(s,"immersive-ar")&&t.scripts_immersive_ar.push(s))}function bo(s,t){bn(s,t.new_scripts),bn(s,t.new_script_start),bn(s,t.scripts),bn(s,t.scripts_earlyUpdate),bn(s,t.scripts_update),bn(s,t.scripts_lateUpdate),bn(s,t.scripts_onBeforeRender),bn(s,t.scripts_onAfterRender),bn(s,t.scripts_pausedChanged),bn(s,t.new_scripts_xr),bn(s,t.scripts_immersive_vr),bn(s,t.scripts_immersive_ar),t.stopAllCoroutinesFrom(s)}function bn(s,t){const e=t.indexOf(s);e>=0&&t.splice(e,1)}function lg(s,t){var e;if(s){const i=s;if(i.onBeforeXR||i.onEnterXR||i.onUpdateXR||i.onLeaveXR||i.onXRControllerAdded||i.onXRControllerRemoved)return!(t!=null&&((e=i.supportsXR)==null?void 0:e.call(i,t))===!1)}return!1}function tf(s){if(s||(s=be.Current.scene),!s){console.trace("Invalid call - no current context.");return}const t=Ud(s);rC(s,t,!0)||(Ly||U()?console.error(`Error updating hierarchy
Do you have circular references in your project? <a target="_blank" href="https://docs.needle.tools/circular-reference"> Click here for more information.`,s):console.error('Failed to update active state in hierarchy of "'+s.name+'"',s),console.warn(" ‚Üë this error might be caused by circular references. Please make sure you don't have files with circular references (e.g. one GLB 1 is loading GLB 2 which is then loading GLB 1 again)."))}function rC(s,t,e,i=0){if(i>1e3)return console.warn("Hierarchy is too deep (> 1000 level) - will abort updating active state"),!1;const n=Ud(s);if(t&&(t=n,t&&s.parent)){const c=s.parent;t=c[Dr],t===void 0&&(c instanceof In||(t=!0))}const r=s[Dr]!==t;s[Dr]=t,r&&(Vk&&console.warn("ACTIVE CHANGE",s.name,n,s.visible,t,"changed?"+r,s),e&&qk(s,c=>{t?c.enabled&&(sc(c.__internalAwake.bind(c)),c.enabled&&c.__internalEnable()):c.__didAwake&&c.enabled&&(c.__didEnable=!1,c.onDisable())}));let l=!0;if(s.children)for(const c of s.children)rC(c,t,e,i+1)===!1&&(l=!1);return l}function zh(s){let t=!0,e=s,i=!1;for(;e&&e;){if(e.type==="Scene"&&(i=!0),!Ud(e)){t=!1;break}e=e.parent}if(!s){console.error("GO is null");return}s[Dr]=t&&i}function qk(s,t){var e;if((e=s.userData)!=null&&e.components)for(const i of s.userData.components)t(i)}const nf=new Map,aC=Symbol("prewarmFlag"),jy=Symbol("waitingForPrewarm"),By=C("debugprewarm");function Xk(s,t){if(!s||s[aC]===!0||s[jy]===!0)return;nf.has(t)||nf.set(t,[]),s[jy]=!0,nf.get(t).push(s),By&&console.debug("register prewarm",s.name)}let wv=null,Sv=null;function Qk(s){if(!s)return;const t=nf.get(s);if(!(t!=null&&t.length))return;const e=s.mainCamera;if(e){By&&console.log("prewarm",t.length,"objects",[...t]);const i=s.renderer;if(i.compile){const n=s.scene;i.compile(n,e),wv??(wv=new PP(64)),Sv??(Sv=new RP(.001,9999999,wv)),Sv.update(i,n);for(const o of t)o[aC]=!0,o[jy]=!1;t.length=0,By&&console.log("prewarm done")}}}const Yk=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000)$/i;function Kk(s){return typeof s=="string"&&Yk.test(s)}const Ht=[];for(let s=0;s<256;++s)Ht.push((s+256).toString(16).slice(1));function Jk(s,t=0){return Ht[s[t+0]]+Ht[s[t+1]]+Ht[s[t+2]]+Ht[s[t+3]]+"-"+Ht[s[t+4]]+Ht[s[t+5]]+"-"+Ht[s[t+6]]+Ht[s[t+7]]+"-"+Ht[s[t+8]]+Ht[s[t+9]]+"-"+Ht[s[t+10]]+Ht[s[t+11]]+Ht[s[t+12]]+Ht[s[t+13]]+Ht[s[t+14]]+Ht[s[t+15]]}function Zk(s){if(!Kk(s))throw TypeError("Invalid UUID");let t;const e=new Uint8Array(16);return e[0]=(t=parseInt(s.slice(0,8),16))>>>24,e[1]=t>>>16&255,e[2]=t>>>8&255,e[3]=t&255,e[4]=(t=parseInt(s.slice(9,13),16))>>>8,e[5]=t&255,e[6]=(t=parseInt(s.slice(14,18),16))>>>8,e[7]=t&255,e[8]=(t=parseInt(s.slice(19,23),16))>>>8,e[9]=t&255,e[10]=(t=parseInt(s.slice(24,36),16))/1099511627776&255,e[11]=t/4294967296&255,e[12]=t>>>24&255,e[13]=t>>>16&255,e[14]=t>>>8&255,e[15]=t&255,e}function eE(s){s=unescape(encodeURIComponent(s));const t=[];for(let e=0;e<s.length;++e)t.push(s.charCodeAt(e));return t}const tE="6ba7b810-9dad-11d1-80b4-00c04fd430c8",iE="6ba7b811-9dad-11d1-80b4-00c04fd430c8";function nE(s,t,e){function i(n,o,r,l){var c;if(typeof n=="string"&&(n=eE(n)),typeof o=="string"&&(o=Zk(o)),((c=o)===null||c===void 0?void 0:c.length)!==16)throw TypeError("Namespace must be array-like (16 iterable integer values, 0-255)");let h=new Uint8Array(16+n.length);if(h.set(o),h.set(n,o.length),h=e(h),h[6]=h[6]&15|t,h[8]=h[8]&63|128,r){l=l||0;for(let d=0;d<16;++d)r[l+d]=h[d];return r}return Jk(h)}try{i.name=s}catch{}return i.DNS=tE,i.URL=iE,i}function sE(s,t,e,i){switch(s){case 0:return t&e^~t&i;case 1:return t^e^i;case 2:return t&e^t&i^e&i;case 3:return t^e^i}}function cg(s,t){return s<<t|s>>>32-t}function oE(s){const t=[1518500249,1859775393,2400959708,3395469782],e=[1732584193,4023233417,2562383102,271733878,3285377520];if(typeof s=="string"){const r=unescape(encodeURIComponent(s));s=[];for(let l=0;l<r.length;++l)s.push(r.charCodeAt(l))}else Array.isArray(s)||(s=Array.prototype.slice.call(s));s.push(128);const i=s.length/4+2,n=Math.ceil(i/16),o=new Array(n);for(let r=0;r<n;++r){const l=new Uint32Array(16);for(let c=0;c<16;++c)l[c]=s[r*64+c*4]<<24|s[r*64+c*4+1]<<16|s[r*64+c*4+2]<<8|s[r*64+c*4+3];o[r]=l}o[n-1][14]=(s.length-1)*8/Math.pow(2,32),o[n-1][14]=Math.floor(o[n-1][14]),o[n-1][15]=(s.length-1)*8&4294967295;for(let r=0;r<n;++r){const l=new Uint32Array(80);for(let p=0;p<16;++p)l[p]=o[r][p];for(let p=16;p<80;++p)l[p]=cg(l[p-3]^l[p-8]^l[p-14]^l[p-16],1);let c=e[0],h=e[1],d=e[2],u=e[3],f=e[4];for(let p=0;p<80;++p){const g=Math.floor(p/20),y=cg(c,5)+sE(g,h,d,u)+f+t[g]+l[p]>>>0;f=u,u=d,d=cg(h,30)>>>0,h=c,c=y}e[0]=e[0]+c>>>0,e[1]=e[1]+h>>>0,e[2]=e[2]+d>>>0,e[3]=e[3]+u>>>0,e[4]=e[4]+f>>>0}return[e[0]>>24&255,e[0]>>16&255,e[0]>>8&255,e[0]&255,e[1]>>24&255,e[1]>>16&255,e[1]>>8&255,e[1]&255,e[2]>>24&255,e[2]>>16&255,e[2]>>8&255,e[2]&255,e[3]>>24&255,e[3]>>16&255,e[3]>>8&255,e[3]&255,e[4]>>24&255,e[4]>>16&255,e[4]>>8&255,e[4]&255]}const rE=nE("v5",80,oE),Cv=rE;be.registerCallback(me.ContextCreated,s=>{const t=s.context;dE(t),lE(t)});const Of=C("debugcomponents"),Pv="eff8ba80-635d-11ec-90d6-0242ac120003";class ui{constructor(t){a(this,"_originalSeed");a(this,"_seed");typeof t=="string"&&(t=ui.hash(t)),this._originalSeed=t,this._seed=t}get seed(){return this._seed}set seed(t){this._seed=t}reset(){this._seed=this._originalSeed}generateUUID(t){if(typeof t=="string")return Cv(t,Pv);const e=this._seed;return this._seed-=1,Cv(e.toString(),Pv)}initialize(t){typeof t=="string"?this._seed=ui.hash(t):this._seed=t}static createFromString(t){return new ui(this.hash(t))}static hash(t){let e=0;for(let i=0;i<t.length;i++)e=t.charCodeAt(i)+((e<<5)-e);return e}}var xc;(function(s){s.NewInstanceCreated="new-instance-created",s.InstanceDestroyed="instance-destroyed"})(xc||(xc={}));class aE{constructor(t){a(this,"guid");a(this,"dontSave");this.guid=t}}function zp(s,t,e=!0,i){if(!s)return;const n=s;if(Ln(s,e),!t){console.warn("Can not send destroy: No networking connection provided",s.guid);return}if(!t.isConnected){U()&&console.debug("Can not send destroy: not connected",s.guid);return}let o=s.guid;if(!o&&n.uuid&&(o=n.uuid),!o){console.warn("Can not send destroy: failed to find guid",s);return}lC(o,t,i)}function lC(s,t,e){const i=new aE(s);(e==null?void 0:e.saveInRoom)===!1&&(i.dontSave=!0),t.send(xc.InstanceDestroyed,i,Qn.Queued)}function lE(s){s.connection.beginListen(xc.InstanceDestroyed,t=>{Of&&console.log("[Remote] Destroyed",s.scene,t);const e=vC(t.guid,s.scene);e&&Ln(e)})}class SL{constructor(t,e,i){a(this,"filename");a(this,"hash");a(this,"size");this.filename=t,this.hash=e,this.size=i}}class cE{constructor(t,e){a(this,"guid");a(this,"originalGuid");a(this,"seed");a(this,"visible");a(this,"hostData");a(this,"dontSave");a(this,"parent");a(this,"position");a(this,"rotation");a(this,"scale");a(this,"preventCreation");a(this,"deleteStateOnDisconnect");this.originalGuid=t,this.guid=e}}function cC(s,t,e,i){var c,h;const n=s;if(!n.guid)return console.warn("Can not instantiate: No guid",n),null;if(t.context||(t.context=ne.Current),!t.context)return console.error("Missing network instantiate options / reference to network connection in sync instantiate"),null;const o=t?{...t}:null,{instance:r,seed:l}=uE(n,t);if(r){const d=r;if(d.guid){Of&&console.log("[Local] new instance","gameobject:",r==null?void 0:r.guid);const u=new cE(n.guid,d.guid);u.seed=l,t.deleteOnDisconnect===!0&&(u.deleteStateOnDisconnect=!0),o&&(o.position&&(u.position={x:o.position.x,y:o.position.y,z:o.position.z}),o.rotation&&(u.rotation={x:o.rotation.x,y:o.rotation.y,z:o.rotation.z,w:o.rotation.w}),o.scale&&(u.scale={x:o.scale.x,y:o.scale.y,z:o.scale.z})),u.position||(u.position={x:d.position.x,y:d.position.y,z:d.position.z}),u.rotation||(u.rotation={x:d.quaternion.x,y:d.quaternion.y,z:d.quaternion.z,w:d.quaternion.w}),u.scale||(u.scale={x:d.scale.x,y:d.scale.y,z:d.scale.z}),u.visible=n.visible,o!=null&&o.parent&&(typeof o.parent=="string"?u.parent=o.parent:u.parent=o.parent.guid),u.hostData=e,i===!1&&(u.dontSave=!0),!((c=t==null?void 0:t.context)==null?void 0:c.connection)&&U()&&console.debug("Object will be instantiated but it will not be synced: not connected",n.guid),t.context.connection.isInRoom&&El.push(new WeakRef(d)),(h=t==null?void 0:t.context)==null||h.connection.send(xc.NewInstanceCreated,u)}else console.warn("Missing guid, can not send new instance event",d)}return r}function hE(){return Math.random()*9999999}const El=new Array;function dE(s){s.connection.beginListen(xc.NewInstanceCreated,async t=>{const e=await pE(t.originalGuid,s.scene);if(t.preventCreation===!0)return;if(!e){console.warn("could not find object that was instantiated: "+t.guid);return}const i=new Js;t.position&&(i.position=new x(t.position.x,t.position.y,t.position.z)),t.rotation&&(i.rotation=new H(t.rotation.x,t.rotation.y,t.rotation.z,t.rotation.w)),t.scale&&(i.scale=new x(t.scale.x,t.scale.y,t.scale.z)),i.parent=t.parent,t.seed&&(i.idProvider=new ui(t.seed)),i.visible=t.visible,i.context=s,Of&&s.alias&&console.log("[Remote] instantiate in: "+s.alias);const n=Pc(e,i);El.push(new WeakRef(n)),n&&(t.parent==="scene"&&s.scene.add(n),Of&&console.log("[Remote] new instance","gameobject:",n==null?void 0:n.guid,e))}),s.connection.beginListen("left-room",()=>{El.length>0&&console.debug(`Left networking room, cleaning up ${El.length} instantiated objects`);for(const t of El){const e=t.deref();e&&e.destroy()}El.length=0})}function uE(s,t){const e=hE(),i=t??new Js;i.idProvider=new ui(e);const n=Pc(s,i);return{seed:e,instance:n}}const hC={};function fE(s,t){hC[s]=t}async function pE(s,t){const e=hC[s];if(e!=null){const i=await e(s);if(i)return i}return dC(s,t)}function dC(s,t){if(t===null||!s)return null;if(t.guid===s)return t;if(t.children)for(const e of t.children){const i=dC(s,e);if(i)return i}return null}const Fd=C("gizmos"),At=C("debugextension"),hg=C("debugtypes");class mE{constructor(){a(this,"_types",new Map);hg&&console.warn("TypeStore: Created",this)}add(t,e){hg&&console.warn("ADD TYPE",t);const i=this._types.get(t);i?hg&&i!==e&&console.warn("Type name exists multiple times in your project and may lead to runtime errors:",t):this._types.set(t,e)}get(t){return this._types.get(t)||null}getKey(t){for(const[e,i]of this._types)if(i===t)return e;return null}}const gE=Symbol("BuiltInType"),w=new mE,CL=function(s){w.get(s.name)||w.add(s.name,s)},q_=C("debugresolvedependencies"),yE=["/extensions/","extensions/"],_E=[{prefix:"/nodes/",dependencyName:"node"},{prefix:"/meshes/",dependencyName:"mesh"},{prefix:"/materials/",dependencyName:"material"},{prefix:"/textures/",dependencyName:"texture"},{prefix:"/animations/",dependencyName:"animation"},{prefix:"nodes/",dependencyName:"node"},{prefix:"meshes/",dependencyName:"mesh"},{prefix:"materials/",dependencyName:"material"},{prefix:"textures/",dependencyName:"texture"},{prefix:"animations/",dependencyName:"animation"}];async function X_(s,t){q_&&console.log(s,t);const e=[];Fy(_E,s,t,e);const i=await Promise.all(e);return typeof t=="string"&&i.length===1?i[0]:i}function bE(s,t){return!s||!t?!1:s["needle:identifier"]!=null&&t["needle:identifier"]!=null?s["needle:identifier"]===t["needle:identifier"]:!1}function vE(s,t){s["needle:identifier"]=t}function Fy(s,t,e,i){if(typeof e=="object"&&e!==void 0&&e!==null)for(const n of Object.keys(e)){const o=e[n];if(typeof o=="string"){const r=Rv(t,o);if(r!=null)typeof r.then=="function"?i.push(r.then(l=>e[n]=l)):e[n]=r;else{const l=Ov(s,t,o);if(l){i.push(l.then(c=>(e[n]=c,c)));continue}}}else if(Array.isArray(o))for(let r=0;r<o.length;r++){const l=o[r],c=Rv(t,l);if(c!==null){typeof c.then=="function"?i.push(c.then(h=>o[r]=h)):o[r]=c;continue}for(const h of s){const d=uC(h.prefix,l);if(d>=0){q_&&console.log(h,d,h.dependencyName),i.push(t.getDependency(h.dependencyName,d).then(u=>o[r]=u));break}}typeof l=="object"&&Fy(s,t,l,i)}else typeof o=="object"&&Fy(s,t,o,i)}else if(typeof e=="string"){const n=Ov(s,t,e);n&&i.push(n)}}function Rv(s,t){if(s&&s.plugins&&typeof t=="string"){for(const e of yE)if(t.startsWith(e)){let i=t.substring(e.length);const n=i.indexOf("/");n>=0&&(i=i.substring(0,n));const o=s.plugins[i];if(At&&console.log(i,o),typeof(o==null?void 0:o.resolve)=="function"){const r=t.substring(e.length+i.length+1);return o.resolve(s,r)}break}}return null}function Ov(s,t,e){for(const i of s){const n=uC(i.prefix,e);if(n>=0)return q_&&console.warn("GET DEPENDENCY",i,n,i.dependencyName),t.getDependency(i.dependencyName,n)}return null}function uC(s,t){if(typeof t=="string"&&t.startsWith(s)){const e=t.substring(s.length),i=Number.parseInt(e);if(i>=0)return i}return-1}const dg="NEEDLE_persistent_assets";function xE(s){return(s==null?void 0:s.___persistentAsset)===!0}class wE{constructor(t){a(this,"parser");this.parser=t}get name(){return dg}async afterRoot(t){var n,o;if(!((o=(n=this.parser)==null?void 0:n.json)!=null&&o.extensions))return;const e=this.parser.json.extensions[dg];if(!e)return;At&&console.log(e);const i=new Array;for(const r of e==null?void 0:e.assets){const l=X_(this.parser,r);l&&i.push(l)}await Promise.all(i)}resolve(t,e){const i=Number.parseInt(e);if(i>=0){At&&console.log(e);const n=t.json.extensions[dg];if(n){const o=n==null?void 0:n.assets[i];if(o&&typeof o=="object"){o.___persistentAsset=!0;const r=o.__type;r&&w.get(r)}return o}}return null}}const ks=C("debugserializer");class SE{constructor(){a(this,"typeMap",new Map)}register(t,e){if(this.typeMap.has(t)){const i=this.typeMap.get(t);if(i===e)return;ks&&console.warn("Type: "+t+" is already registered",e,i)}ks&&console.log("Register type serializer",e.name,e,t),this.typeMap.set(t,e)}getSerializer(t){if(t)return this.typeMap.get(t)}getSerializerForConstructor(t,e=0){if(e>20)return;if(!t||!t.constructor){ks&&console.log("invalid type");return}const i=t.name,n=this.getSerializer(t);if(n!==void 0)return ks&&console.log("FOUND SERIALIZER",n==null?void 0:n.name,t.name,t.constructor.name,"for type: "+i,n,t,this.typeMap),n;const o=Object.getPrototypeOf(t);if(o&&o!==t){const r=this.getSerializerForConstructor(o,++e);if(r){const l=o.constructor||o.prototype;ks&&console.log("FOUND SERIALIZER(in constructor) "+l.constructor.name,l.name,l,r),this.register(l,r)}return r}ks&&console.warn("No serializer found for "+i,t,t.name,t.constructor.name)}}const Tf=new SE;class Fn{constructor(t,e){a(this,"name");if(this.name=e,Array.isArray(t))for(const i of t)Tf.register(i,this);else Tf.register(t,this)}}class CE{constructor(){a(this,"isDevMode",qi());a(this,"cache",{})}registerDefinedKeys(t,e){if(this.isDevMode&&this.cache[t]===void 0){this.cache[t]=Object.keys(e);const i=e;i.$serializedTypes&&Object.keys(i.$serializedTypes)&&this.cache[t].push(...Object.keys(i.$serializedTypes)),ks&&console.log("registerDefinedKeys for "+t,this.cache[t],e)}}getDefinedKey(t,e){return this.cache[t]===void 0?!1:this.cache[t].includes(e)}}class fC{constructor(t){a(this,"root");a(this,"gltf");a(this,"gltfId");a(this,"object");a(this,"target");a(this,"nodeId");a(this,"nodeToObject");a(this,"objectToNode");a(this,"context");a(this,"path");a(this,"type");a(this,"serializable");a(this,"implementationInformation");this.root=t}}function PE(s,t){const e=s.$serializedTypes;if(e===void 0)return null;const i={};for(const o in e){const r=s[o];if(r!=null&&typeof r=="object"){const l=Tf.getSerializerForConstructor(r);if(l){i[o]=l.onSerialize(r,t);continue}}i[o]=r}function n(o){const r=w._types;for(const[l,c]of r)if(c===s.constructor)return l;return o.__name||o.constructor.name}return i.name=n(s),typeof s.guid=="string"&&(i.guid=s.guid),i}const sf=[];function pC(s,t){if(!s)return t;typeof s.$serializedTypes=="object"&&(t||(t={}),Object.assign(t,s.$serializedTypes));const e=Object.getPrototypeOf(s);return pC(e,t)}function zy(s,t,e){if(!s)return!1;if(e.target=s,s.onBeforeDeserialize!==void 0){const n=s.onBeforeDeserialize(t,e);if(typeof n=="boolean")return n}const i=pC(s);if(t){if(typeof t.guid=="string"&&(s.guid=t.guid),i)for(const n in i){let l=function(c){const d=c.type;return d?Uy(r,d,e,void 0,s[n]):Uy(r,c,e,void 0,s[n])};const o=i[n],r=t[n];if(ks&&console.log(n,r,s,o),!(s[n]!==void 0&&r===void 0)&&(e.type=void 0,e.path=n,e.serializable=o,!(s.onBeforeDeserializeMember!==void 0&&s.onBeforeDeserializeMember(n,r,e)===!0))){if(o===null)s[n]=r;else{if(Array.isArray(o))for(let c=0;c<o.length;c++){const h=o[c],d=l(h);if(d!==void 0||c===o.length-1){s[n]=d;break}}else s[n]=l(o);sf.length=0}s.onAfterDeserializeMember!==void 0&&s.onAfterDeserializeMember(n,r,e)}}TE(s,t)}return OE(s,t,e.implementationInformation),s.onAfterDeserialize!==void 0&&s.onAfterDeserialize(t,e),!0}const RE=C("noerrors");function OE(s,t,e){var o,r;if(RE||!t||!qi()||!s||s.constructor&&s.constructor[gE]===!0)return;const i=(o=s.constructor)==null?void 0:o.name,n=Object.getOwnPropertyNames(t);for(const l of n){if(l==="sourceId")continue;const c=s[l];if(c==null)continue;const h=t[l];if((e==null?void 0:e.getDefinedKey(i,l))===!1){const d=l.charAt(0).toUpperCase()+l.slice(1);e.getDefinedKey(i,d)&&(js(_t.Warn,'<strong>Please rename</strong> "'+d+'" to "'+l+'" in '+i),console.warn('Please use lowercase for field: "'+d+'" in '+i,h,s));continue}if(h!=null){if(typeof h=="object"&&(c===void 0||!c.isObject3D)){if(typeof h.node=="number"||typeof h.guid=="string"){if(h.could_not_resolve)continue;if(!(c!==void 0&&Object.keys(c).length>1)){js(_t.Warn,`<strong>Missing serialization for object reference!</strong>

Please change to: 
@serializable(Object3D)
${l}? : Object3D;

in ${i}.ts
<a href="https://docs.needle.tools/serializable" target="_blank">See documentation</a>`),console.warn(i,l,s[l],s);continue}}else if(!Array.isArray(c)){const d=(r=c.constructor)==null?void 0:r.name;if(d==="Object"&&!c.constructor["did_warn:missing_serializable"]){c.constructor["did_warn:missing_serializable"]=!0;const u='You might be missing a @serializable(Type) decorator for field "'+l+'" in '+i+".ts";console.warn(u+`
${l}:`,h,d),js(_t.Warn,"Dev Warning: Are you missing a type in @serializable? Please check the browser console for details")}}}if(typeof c=="string"&&typeof h=="string"&&(h.endsWith(".gltf")||h.endsWith(".glb"))){js(_t.Warn,`<strong>Missing serialization for object reference!</strong>

Please change to: 
@serializable(AssetReference)
${l}? : AssetReference;

in script ${i}.ts
<a href="https://docs.needle.tools/serializable" target="_blank">documentation</a>`),console.warn(i,l,s[l],s);continue}}}}function TE(s,t){for(const e of Object.keys(t)){const i=t[e];if(typeof i=="object"&&i!==null&&i!==void 0){const n=s[e];if(!n){ks&&console.log(e,"is undefined on",s);continue}for(const o of Object.keys(i))if(n[o]===void 0&&Tv(i[o])&&!Tv(n)){const l=kE(n,o);if(l&&((l==null?void 0:l.writable)===void 0||(l==null?void 0:l.writable)===!1)&&l.set===void 0){ks&&console.warn('Property is not writable "'+o+'"',n,l,i[o],n[o]);continue}n[o]=i[o]}}}}function kE(s,t){for(;s;){const e=Object.getOwnPropertyDescriptor(s,t);if(e)return e;s=Object.getPrototypeOf(s)}}function Tv(s){switch(typeof s){case"number":case"string":case"boolean":return!0}return!1}function Uy(s,t,e,i,n){let o=typeof t=="function"&&t.prototype===void 0,r=t;if(o)try{if(r=t==null?void 0:t.call(t,n),o=!1,r==null)return}catch(d){console.error("Error in callback",d,s)}if(e.type=r,!o&&n&&(n instanceof De||n instanceof Je||n instanceof Z||n instanceof ko||n instanceof Ar))return n;if(i||(i={serializer:Tf.getSerializerForConstructor(r)}),n&&typeof n=="object"&&xE(n)){if(n.__concreteInstance)return n.__concreteInstance;const d=n;if(!d.$serializedTypes&&r.prototype.$serializedTypes&&(d.$serializedTypes=r.prototype.$serializedTypes),d.$serializedTypes&&zy(d,s,e),n&&r!==void 0)try{let u=null;i.serializer&&(u=i.serializer.onDeserialize(s,e)),u||(u=new r,At&&console.log("Create concrete instance for persistent asset",n,"instance:",u),wc(u,n)),n.__concreteInstance=u,n=u}catch(u){console.error("Error creating instance or creating values on instance",u,n,r)}return n}if(Array.isArray(s)){const d=[];for(let u=0;u<s.length;u++){const f=s[u],p=Uy(f,t,e,i,f);d.push(p)}return d}const l=i==null?void 0:i.serializer;if(l)return l.onDeserialize(s,e);let c;if(s&&(s.isMaterial||s.isTexture||s.isObject3D||s instanceof Ar))c=s;else{if(s===void 0)return;if(s===null&&(r===De||r===Je||r===Z||r===Ar))return null;try{c=new r(...EE(s))}catch(d){console.error("Error creating "+e.path,e.target,d);return}}const h=c;return h.$serializedTypes&&zy(h,s,e),c}function EE(s){if(sf.length=0,typeof s=="object"&&s!==null&&s!==void 0)for(const t of Object.keys(s))sf.push(s[t]);return sf}const Ny=Symbol("assigned component properties");function wc(s,t,e){var n;if(t==null||s==null)return;s[Ny]=!0;const i=((n=s.constructor)==null?void 0:n.name)??"unknown";e==null||e.registerDefinedKeys(i,s);for(const o of Object.keys(t)){const r=ME(s,o);typeof(r==null?void 0:r.value)!="function"&&(!r||r.writable===!0||(r==null?void 0:r.set)!==void 0)&&(s[o]=t[o])}delete s[Ny]}function ME(s,t){let e;do e=Object.getOwnPropertyDescriptor(s,t);while(!e&&(s=Object.getPrototypeOf(s)));return e}const mC=Symbol("customVisibilityFlag");function vo(s,t){s.layers[mC]=t}const kv=Symbol("DidPatchLayers");function AE(){const s=Nr.prototype;if(s[kv])return;s[kv]=!0;const t=s.test;s.test=function(e){return this[mC]===!1?!1:t.call(this,e)}}AE();Object.defineProperty(Re.prototype,"fov",{get:function(){return this._fov},set:function(s){const t=s!==this._fov;this._fov=s,t&&this.view!==void 0&&this.updateProjectionMatrix()},configurable:!0});Object.defineProperty(Re.prototype,"near",{get:function(){return this._near},set:function(s){const t=s!==this._near;this._near=s,t&&this.view!==void 0&&this.updateProjectionMatrix()},configurable:!0});Object.defineProperty(Re.prototype,"far",{get:function(){return this._far},set:function(s){const t=s!==this._far;this._far=s,t&&this.view!==void 0&&this.updateProjectionMatrix()},configurable:!0});const gC=new Map;function IE(s,t){if(!s)return;if(!t){console.warn("No prototype found",s,s.prototype,s.constructor);return}const e=gC.get(t);e&&e.apply(s)}function DE(s){const t=LE(s.prototype);gC.set(s,t)}function LE(s){return new jE(s)}class jE{constructor(t){a(this,"$symbol");a(this,"extensions");a(this,"descriptors");this.$symbol=Symbol("prototype-extension"),this.extensions=Object.keys(t),this.descriptors=new Array;for(let e=0;e<this.extensions.length;e++){const i=this.extensions[e],n=Object.getOwnPropertyDescriptor(t,i);n&&this.descriptors.push(n)}}apply(t){if(!t[this.$symbol]){t[this.$symbol]=!0;for(let e=0;e<this.extensions.length;e++){const i=this.extensions[e],n=this.descriptors[e];n&&Object.defineProperty(t,i,n)}}}}const BE=C("debuggetcomponent"),Ev=()=>BE||globalThis.NEEDLE_DEBUG_GETCOMPONENT===!0;function FE(s){return s==null||s.isObject3D?s:s.object&&s.object.isObject3D?s.object:s}function yC(s,t){if(!s||!s.userData.components)return t;const e=s.userData.components.indexOf(t);return e<0||(Fp.dispatchComponentLifecycleEvent("removing-component",t),t.gameObject=null,s.userData.components.splice(e,1)),t}function Up(s,t,e){const i=Ac(s,t);return i||Mn(s,t,e)}const _C=new ui("addComponentIdProvider");function oc(s,t,e=!0){s.userData||(s.userData={}),s.userData.components||(s.userData.components=[]),s.userData.components.push(t),t.gameObject=s,(t.guid===void 0||t.guid==="invalid")&&(t.guid=_C.generateUUID()),Y_(s),eb(t,t.context);try{e&&t.__internalAwake&&(zh(s),t.activeAndEnabled&&t.__internalAwake()),Fp.dispatchComponentLifecycleEvent("component-added",t)}catch(i){console.error(i)}return t}function Mn(s,t,e,i){if(typeof t=="function"){const n=new t;e&&n.__internalNewInstanceCreated(e);let o=!0;return(i==null?void 0:i.callAwake)!=null&&(o=i.callAwake),oc(s,n,o)}if(t.destroyed)return console.warn("Can not move/add a destroyed component",t),t;if(t.gameObject===s)return t;if(t.gameObject&&t.gameObject.userData.components){const n=t.gameObject.userData.components.indexOf(t);t.gameObject.userData.components.splice(n,1)}if(!s.userData.components)s.userData.components=[];else if(s.userData.components.includes(t))return t;return s.userData.components.push(t),t.gameObject=s,(t.guid===void 0||t.guid==="invalid")&&(t.guid=_C.generateUUID()),e&&t._internalInit(e),eb(t,t.context),t}function zE(s){if(s.gameObject&&s.gameObject.userData.components){const t=s.gameObject.userData.components.indexOf(s);s.gameObject.userData.components.splice(t,1)}s.__internalDisable&&s.__internalDisable(),bo(s,s.context??ne.Current),s.destroy(),s.gameObject=null}let Mv=!1;function bC(s,t,e){var i;if(s==null)return null;if(!s.isObject3D)return console.error("Object is not object3D"),null;if(!((i=s==null?void 0:s.userData)!=null&&i.components)||(typeof t=="string"&&(Mv||(Mv=!0,console.warn(`Accessing components by name is not supported.
Please use the component type instead. This may keep working in local development but it will fail when bundling your application.

You can import other modules your main module to get access to types
or if you use npmdefs you can make types available globally using globalThis:
https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/globalThis`,t))),Ev()&&console.log("[onGetComponent] FIND",t),t==null))return null;for(let n=0;n<s.userData.components.length;n++){const o=s.userData.components[n];let r=Object.getPrototypeOf(o);for(;r;){if(r===t.prototype)if(Ev()&&console.log("[onGetComponent] MATCH BY PROTOYPE",r),e)e.push(o);else return o;r=Object.getPrototypeOf(r)}}return e||null}function Ac(s,t){const e=bC(s,t);return e?Array.isArray(e)?e[0]:e:null}function Np(s,t,e,i=!0){return e||(e=[]),i&&(e.length=0),bC(s,t,e),e}function $p(s,t,e){var n;const i=Ac(s,t);if(e===!1&&(i==null?void 0:i.enabled)===!1)return null;if(i)return i;for(let o=0;o<((n=s==null?void 0:s.children)==null?void 0:n.length);o++){const r=$p(s.children[o],t);if(r)return r}return null}function zd(s,t,e,i=!0){var n;e||(e=[]),i&&(e.length=0),Np(s,t,e,!1);for(let o=0;o<((n=s==null?void 0:s.children)==null?void 0:n.length);o++)zd(s.children[o],t,e,!1);return e}function kf(s,t){if(!s)return null;if(Array.isArray(s)){for(let i=0;i<s.length;i++){const n=FE(s[i]),o=kf(n,t);if(o)return o}return null}const e=Ac(s,t);return e||(s.parent?kf(s.parent,t):null)}function Q_(s,t,e,i=!0){return e||(e=[]),i&&(e.length=0),s?(Np(s,t,e,!1),s.parent?Q_(s.parent,t,e,!1):e):e}function Wp(s,t=void 0,e=!0){if(!s)return null;if(!t&&(t=ne.Current,!t))return console.error("Can not search object without any needle context or scene!!!"),null;let i=t;if(i.isScene||(i=t==null?void 0:t.scene),!i)return null;for(const n in i.children){const o=i.children[n];if(e===!1&&o[Dr]===!1)continue;const r=$p(o,s);if(r)return r}return null}function UE(s,t,e=void 0){if(!s)return t??[];if(t||(t=[]),t.length=0,!e&&(e=ne.Current,!e))return console.error("Can not search object without any needle context or scene!!!"),t;"scene"in e&&(e=e.scene);const i=e;if(!i)return t;for(const n in i.children){const o=i.children[n];zd(o,s,t,!1)}return t}function Y_(s){s&&s.isObject3D===!0&&IE(s,F)}F.prototype.SetActive=function(s){this.visible=s};F.prototype.setActive=function(s){this.visible=s};F.prototype.destroy=function(){Ln(this)};F.prototype.addComponent=function(s,t){return Mn(this,s,t)};F.prototype.addNewComponent=function(s,t){return Mn(this,s,t)};F.prototype.removeComponent=function(s){return yC(this,s)};F.prototype.getOrAddComponent=function(s,t){return Up(this,s,t)};F.prototype.getComponent=function(s){return Ac(this,s)};F.prototype.getComponents=function(s,t){return Np(this,s,t)};F.prototype.getComponentInChildren=function(s){return $p(this,s)};F.prototype.getComponentsInChildren=function(s,t){return zd(this,s,t)};F.prototype.getComponentInParent=function(s){return kf(this,s)};F.prototype.getComponentsInParent=function(s,t){return Q_(this,s,t)};Object.getOwnPropertyDescriptor(F.prototype,"activeSelf")||Object.defineProperty(F.prototype,"activeSelf",{get:function(){return Ud(this)},set:function(s){af(this,s)}});Object.getOwnPropertyDescriptor(F.prototype,"worldPosition")||Object.defineProperty(F.prototype,"worldPosition",{get:function(){return this instanceof vw?ae(this.object):ae(this)},set:function(s){jt(this,s)}});Object.getOwnPropertyDescriptor(F.prototype,"worldQuaternion")||Object.defineProperty(F.prototype,"worldQuaternion",{get:function(){return this instanceof vw?Le(this.object):Le(this)},set:function(s){as(this,s)}});Object.getOwnPropertyDescriptor(F.prototype,"worldRotation")||Object.defineProperty(F.prototype,"worldRotation",{get:function(){return Ap(this)},set:function(s){Nw(this,s)}});Object.getOwnPropertyDescriptor(F.prototype,"worldScale")||Object.defineProperty(F.prototype,"worldScale",{get:function(){return pt(this)},set:function(s){xd(this,s)}});Object.getOwnPropertyDescriptor(F.prototype,"worldForward")||Object.defineProperty(F.prototype,"worldForward",{get:function(){return Q().set(0,0,1).applyQuaternion(Le(this))}});Object.getOwnPropertyDescriptor(F.prototype,"worldRight")||Object.defineProperty(F.prototype,"worldRight",{get:function(){return Q().set(1,0,0).applyQuaternion(Le(this))}});Object.getOwnPropertyDescriptor(F.prototype,"worldUp")||Object.defineProperty(F.prototype,"worldUp",{get:function(){return Q().set(0,1,0).applyQuaternion(Le(this))}});DE(F);class Ae extends ue{constructor(e,i,n,o){var t=(...args)=>{super(...args);a(this,"alpha",1)};i!=null&&n!=null?(t(e,i,n),this.alpha=o):(t(e),this.alpha=1)}get isRGBAColor(){return!0}set a(e){this.alpha=e}get a(){return this.alpha}clone(){const e=super.clone();return e.alpha=this.alpha,e}copy(e){return this.r=e.r,this.g=e.g,this.b=e.b,"alpha"in e&&typeof e.alpha=="number"?this.alpha=e.alpha:typeof e.a=="number"&&(this.alpha=e.a),this}lerp(e,i){const n=e;return n.alpha!=null&&(this.alpha=W.lerp(this.alpha,n.alpha,i)),super.lerp(e,i)}lerpColors(e,i,n){const o=e,r=i;return o.alpha!=null&&r.alpha!=null&&(this.alpha=W.lerp(o.alpha,r.alpha,n)),super.lerpColors(e,i,n)}multiply(e){const i=e;return i.alpha!=null&&(this.alpha=this.alpha*i.alpha),super.multiply(e)}fromArray(e,i=0){return this.alpha=e[i+3],super.fromArray(e,i)}}const of=C("debuggetcomponent"),rf=C("debuginstantiate");class Js{constructor(){a(this,"idProvider");a(this,"parent");a(this,"keepWorldPosition");a(this,"position");a(this,"rotation");a(this,"scale");a(this,"visible");a(this,"context");a(this,"components")}clone(){var e,i,n;const t=new Js;return t.idProvider=this.idProvider,t.parent=this.parent,t.keepWorldPosition=this.keepWorldPosition,t.position=(e=this.position)==null?void 0:e.clone(),t.rotation=(i=this.rotation)==null?void 0:i.clone(),t.scale=(n=this.scale)==null?void 0:n.clone(),t.visible=this.visible,t.context=this.context,t.components=this.components,t}cloneAssign(t){var e,i,n;this.idProvider=t.idProvider,this.parent=t.parent,this.keepWorldPosition=t.keepWorldPosition,this.position=(e=t.position)==null?void 0:e.clone(),this.rotation=(i=t.rotation)==null?void 0:i.clone(),this.scale=(n=t.scale)==null?void 0:n.clone(),this.visible=t.visible,this.context=t.context,this.components=t.components}}function Ud(s){return s.visible}function af(s,t){return typeof t=="number"&&(t=t>.5),s.visible=t,s.visible}function NE(s){return s[Dr]||K_(s)}function $E(s,t){s[nC]=t}function K_(s){return is.isUsingInstancing(s)}function vC(s,t){return bd(s,t,!0,!0)}const xC=Symbol("isDestroyed");function Sc(s){return s[xC]}function WE(s,t){s[xC]=t}const $y=Symbol("isDontDestroy");function hh(s,t=!0){s[$y]=t}const lf=[],cf=[];function Ln(s,t=!0,e=!1){lf.length=0,cf.length=0,Wy(s,t,!0);for(const i of lf)i.gameObject=null,i.context=null;for(const i of cf)WE(i,!0),e&&Ne(i),Nk(i);cf.length=0,lf.length=0}function Wy(s,t=!0,e=!0){var r;if(s==null)return;const i=s;if(i.isComponent){if(i[$y])return;lf.push(i);const l=i.gameObject;i.__internalDisable(),i.__internalDestroy(),i.gameObject=l;return}if(s[$y])return;const n=s;of&&console.log(n),cf.push(n);const o=(r=n.userData)==null?void 0:r.components;if(o!=null&&Array.isArray(o)){let l=o.length;for(let c=0;c<o.length;c++){const h=o[c];Wy(h,t,!1),o.length<l&&(l=o.length,c--)}}if(t&&n.children)for(const l of n.children)Wy(l,t,!1);e&&n.removeFromParent()}function Cc(s,t,e=!0){return wC(s,t,e)}function*J_(s,t,e=!1,i=999,n=0){if(s!=null&&s.userData.components&&!(n>i)){for(const o of s.userData.components)t&&(o==null?void 0:o.isComponent)===!0&&o instanceof t?yield o:yield o;if(e===!0)for(const o of s.children)yield*J_(o,t,!0,i,n+1)}}function wC(s,t,e,i=0){var n;if(s){if(s.isObject3D,i>1e3){console.warn("Failed to iterate components: too many levels");return}if((n=s.userData)!=null&&n.components)for(let o=0;o<s.userData.components.length;o++){const r=s.userData.components[o];if((r==null?void 0:r.isComponent)===!0){const l=t(r);if(l!==void 0)return l}}if(e&&s.children){const o=i+1;for(let r=0;r<s.children.length;r++){const l=s.children[r];if(!l)continue;const c=wC(l,t,e,o);if(c!==void 0)return c}}}}function Pc(s,t){if("isAssetReference"in s)return s.instantiate(t??void 0);let e=null;t!=null&&(t.x!==void 0?(e=new Js,e.position=t):e=t);let i=ne.Current;e!=null&&e.context&&(i=e.context),of&&i.alias&&console.log("context",i.alias),e&&!e.idProvider&&(e.idProvider=new ui(Date.now()));const n=[],o={},r={},l=SC(i,s,e,n,o,r);l&&(HE(o),VE(r,o)),of&&(py(s,!0),py(l,!0));const c={};if((e==null?void 0:e.components)!==!1){for(const h in n){const d=n[h],u=d.guid;e&&e.idProvider&&(d.guid=e.idProvider.generateUUID(),c[u]=d.guid,of&&console.log(d.name,d.guid)),eb(d,i),d.__internalNewInstanceCreated&&d.__internalNewInstanceCreated()}for(const h in n){const d=n[h];d.resolveGuids&&d.resolveGuids(c),d.enabled!==!1&&(d.enabled=!0)}Rf(i)}return l}function SC(s,t,e,i,n,o){var d;if(!t)return null;const r=t.userData;t.userData={};const l=t.children;t.children=[];const c=t.clone(!1);if(Y_(c),t.userData=r,t.children=l,n[t.uuid]={original:t,clone:c},rf&&console.log("ADD",t,c),t.type==="SkinnedMesh"&&(o[t.uuid]={original:t,clone:c}),(e==null?void 0:e.visible)!==void 0&&(c.visible=e.visible),e!=null&&e.idProvider){c.uuid=e.idProvider.generateUUID();const u=c;u&&(u.guid=c.uuid)}t.animations&&t.animations.length>0&&(c.animations=[...t.animations]);const h=t.parent;if(h&&h.add(c),e!=null&&e.position?jt(c,e.position):c.position.copy(t.position),e!=null&&e.rotation?as(c,e.rotation):c.quaternion.copy(t.quaternion),e!=null&&e.scale?c.scale.copy(e.scale):c.scale.copy(t.scale),e!=null&&e.parent&&e.parent!=="scene"){let u=null;if(typeof e.parent=="string"?u=bd(e.parent,s.scene,!0):u=e.parent,u){const f=e.keepWorldPosition===!0?u.attach:u.add;f?f.call(u,c):console.error("Invalid parent object",u,"received when instantiating:",t)}else console.warn("could not find parent:",e.parent)}for(const[u,f]of Object.entries(t.userData))u!=="components"&&(c.userData[u]=f);if((d=t.userData)!=null&&d.components){const u=t.userData.components,f=[];c.userData.components=f;for(let p=0;p<u.length;p++){const g=u[p],y=new g.constructor;wc(y,g),g[Yu]!==void 0&&(y[Yu]=g[Yu]),f.push(y),y.gameObject=c,i.push(y),n[g.guid]={original:g,clone:y},Fp.dispatchComponentLifecycleEvent("component-added",y)}}e&&(e.position=void 0,e.rotation=void 0,e.scale=void 0,e.parent=void 0);for(const u in t.children){const f=t.children[u],p=SC(s,f,e,i,n,o);p&&c.add(p)}return c}function VE(s,t){for(const e in s){const i=s[e],n=i.original,o=n.skeleton,r=i.clone;if(!o){console.warn("Skinned mesh has no skeleton?",i);continue}const l=o.bones,c=r.skeleton.clone();r.skeleton=c,r.bindMatrix.clone().copy(n.bindMatrix),r.bindMatrixInverse.copy(n.bindMatrixInverse);const h=[];c.bones=h;for(let d=0;d<l.length;d++){const u=l[d],p=t[u.uuid].clone;h.push(p)}}for(const e in s){const i=s[e].clone;i.skeleton.update(),i.bind(i.skeleton,i.bindMatrix),i.updateMatrixWorld(!0)}}function HE(s){var t;for(const e in s){const n=s[e].clone;if(n!=null&&n.isObject3D&&((t=n==null?void 0:n.userData)!=null&&t.components))for(let o=0;o<n.userData.components.length;o++){const r=n.userData.components[o],l=Object.entries(r);for(const[c,h]of l)if(Array.isArray(h)){const d=[];r[c]=d;for(let u=0;u<h.length;u++){const f=h[u];if(typeof f!="object"){d.push(f);continue}const p=Av(r,c,f,s);p!==void 0?d.push(p):d.push(f)}}else if(typeof h=="object"){const d=Av(r,c,h,s);d!==void 0&&(r[c]=d)}}}}function Av(s,t,e,i){var n,o;if(e!=null)if(e.isComponent===!0){const r=e.gameObject;if(r){const l=r.uuid,c=(n=i[l])==null?void 0:n.clone;if(!c){rf&&console.log("reference did not change",t,s,e);return}const h=r.userData.components.indexOf(e);if(h>=0&&c.isObject3D)return rf&&console.log(t,l),c.userData.components[h];console.warn("could not find component",t,e)}}else if(e.isObject3D===!0){if(t==="gameObject")return;const r=e;if(r){const l=r.uuid,c=(o=i[l])==null?void 0:o.clone;if(c)return rf&&console.log(t,"old",e,"new",c),c}}else{if(e.isVector4||e.isVector3||e.isVector2||e.isQuaternion||e.isEuler)return e.clone();if(e.isColor===!0)return e.clone();if(e.isEventList===!0)return e.__internalOnInstantiate(i)}}var CC={exports:{}},PC={exports:{}};(function(){var s="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",t={rotl:function(e,i){return e<<i|e>>>32-i},rotr:function(e,i){return e<<32-i|e>>>i},endian:function(e){if(e.constructor==Number)return t.rotl(e,8)&16711935|t.rotl(e,24)&4278255360;for(var i=0;i<e.length;i++)e[i]=t.endian(e[i]);return e},randomBytes:function(e){for(var i=[];e>0;e--)i.push(Math.floor(Math.random()*256));return i},bytesToWords:function(e){for(var i=[],n=0,o=0;n<e.length;n++,o+=8)i[o>>>5]|=e[n]<<24-o%32;return i},wordsToBytes:function(e){for(var i=[],n=0;n<e.length*32;n+=8)i.push(e[n>>>5]>>>24-n%32&255);return i},bytesToHex:function(e){for(var i=[],n=0;n<e.length;n++)i.push((e[n]>>>4).toString(16)),i.push((e[n]&15).toString(16));return i.join("")},hexToBytes:function(e){for(var i=[],n=0;n<e.length;n+=2)i.push(parseInt(e.substr(n,2),16));return i},bytesToBase64:function(e){for(var i=[],n=0;n<e.length;n+=3)for(var o=e[n]<<16|e[n+1]<<8|e[n+2],r=0;r<4;r++)n*8+r*6<=e.length*8?i.push(s.charAt(o>>>6*(3-r)&63)):i.push("=");return i.join("")},base64ToBytes:function(e){e=e.replace(/[^A-Z0-9+\/]/ig,"");for(var i=[],n=0,o=0;n<e.length;o=++n%4)o!=0&&i.push((s.indexOf(e.charAt(n-1))&Math.pow(2,-2*o+8)-1)<<o*2|s.indexOf(e.charAt(n))>>>6-o*2);return i}};PC.exports=t})();var GE=PC.exports,Vy={utf8:{stringToBytes:function(s){return Vy.bin.stringToBytes(unescape(encodeURIComponent(s)))},bytesToString:function(s){return decodeURIComponent(escape(Vy.bin.bytesToString(s)))}},bin:{stringToBytes:function(s){for(var t=[],e=0;e<s.length;e++)t.push(s.charCodeAt(e)&255);return t},bytesToString:function(s){for(var t=[],e=0;e<s.length;e++)t.push(String.fromCharCode(s[e]));return t.join("")}}},Iv=Vy;/*!
 * Determine if an object is a Buffer
 *
 * @author   Feross Aboukhadijeh <https://feross.org>
 * @license  MIT
 */var qE=function(s){return s!=null&&(RC(s)||XE(s)||!!s._isBuffer)};function RC(s){return!!s.constructor&&typeof s.constructor.isBuffer=="function"&&s.constructor.isBuffer(s)}function XE(s){return typeof s.readFloatLE=="function"&&typeof s.slice=="function"&&RC(s.slice(0,0))}(function(){var s=GE,t=Iv.utf8,e=qE,i=Iv.bin,n=function(o,r){o.constructor==String?r&&r.encoding==="binary"?o=i.stringToBytes(o):o=t.stringToBytes(o):e(o)?o=Array.prototype.slice.call(o,0):!Array.isArray(o)&&o.constructor!==Uint8Array&&(o=o.toString());for(var l=s.bytesToWords(o),c=o.length*8,h=1732584193,d=-271733879,u=-1732584194,f=271733878,p=0;p<l.length;p++)l[p]=(l[p]<<8|l[p]>>>24)&16711935|(l[p]<<24|l[p]>>>8)&4278255360;l[c>>>5]|=128<<c%32,l[(c+64>>>9<<4)+14]=c;for(var g=n._ff,y=n._gg,b=n._hh,_=n._ii,p=0;p<l.length;p+=16){var v=h,S=d,T=u,O=f;h=g(h,d,u,f,l[p+0],7,-680876936),f=g(f,h,d,u,l[p+1],12,-389564586),u=g(u,f,h,d,l[p+2],17,606105819),d=g(d,u,f,h,l[p+3],22,-1044525330),h=g(h,d,u,f,l[p+4],7,-176418897),f=g(f,h,d,u,l[p+5],12,1200080426),u=g(u,f,h,d,l[p+6],17,-1473231341),d=g(d,u,f,h,l[p+7],22,-45705983),h=g(h,d,u,f,l[p+8],7,1770035416),f=g(f,h,d,u,l[p+9],12,-1958414417),u=g(u,f,h,d,l[p+10],17,-42063),d=g(d,u,f,h,l[p+11],22,-1990404162),h=g(h,d,u,f,l[p+12],7,1804603682),f=g(f,h,d,u,l[p+13],12,-40341101),u=g(u,f,h,d,l[p+14],17,-1502002290),d=g(d,u,f,h,l[p+15],22,1236535329),h=y(h,d,u,f,l[p+1],5,-165796510),f=y(f,h,d,u,l[p+6],9,-1069501632),u=y(u,f,h,d,l[p+11],14,643717713),d=y(d,u,f,h,l[p+0],20,-373897302),h=y(h,d,u,f,l[p+5],5,-701558691),f=y(f,h,d,u,l[p+10],9,38016083),u=y(u,f,h,d,l[p+15],14,-660478335),d=y(d,u,f,h,l[p+4],20,-405537848),h=y(h,d,u,f,l[p+9],5,568446438),f=y(f,h,d,u,l[p+14],9,-1019803690),u=y(u,f,h,d,l[p+3],14,-187363961),d=y(d,u,f,h,l[p+8],20,1163531501),h=y(h,d,u,f,l[p+13],5,-1444681467),f=y(f,h,d,u,l[p+2],9,-51403784),u=y(u,f,h,d,l[p+7],14,1735328473),d=y(d,u,f,h,l[p+12],20,-1926607734),h=b(h,d,u,f,l[p+5],4,-378558),f=b(f,h,d,u,l[p+8],11,-2022574463),u=b(u,f,h,d,l[p+11],16,1839030562),d=b(d,u,f,h,l[p+14],23,-35309556),h=b(h,d,u,f,l[p+1],4,-1530992060),f=b(f,h,d,u,l[p+4],11,1272893353),u=b(u,f,h,d,l[p+7],16,-155497632),d=b(d,u,f,h,l[p+10],23,-1094730640),h=b(h,d,u,f,l[p+13],4,681279174),f=b(f,h,d,u,l[p+0],11,-358537222),u=b(u,f,h,d,l[p+3],16,-722521979),d=b(d,u,f,h,l[p+6],23,76029189),h=b(h,d,u,f,l[p+9],4,-640364487),f=b(f,h,d,u,l[p+12],11,-421815835),u=b(u,f,h,d,l[p+15],16,530742520),d=b(d,u,f,h,l[p+2],23,-995338651),h=_(h,d,u,f,l[p+0],6,-198630844),f=_(f,h,d,u,l[p+7],10,1126891415),u=_(u,f,h,d,l[p+14],15,-1416354905),d=_(d,u,f,h,l[p+5],21,-57434055),h=_(h,d,u,f,l[p+12],6,1700485571),f=_(f,h,d,u,l[p+3],10,-1894986606),u=_(u,f,h,d,l[p+10],15,-1051523),d=_(d,u,f,h,l[p+1],21,-2054922799),h=_(h,d,u,f,l[p+8],6,1873313359),f=_(f,h,d,u,l[p+15],10,-30611744),u=_(u,f,h,d,l[p+6],15,-1560198380),d=_(d,u,f,h,l[p+13],21,1309151649),h=_(h,d,u,f,l[p+4],6,-145523070),f=_(f,h,d,u,l[p+11],10,-1120210379),u=_(u,f,h,d,l[p+2],15,718787259),d=_(d,u,f,h,l[p+9],21,-343485551),h=h+v>>>0,d=d+S>>>0,u=u+T>>>0,f=f+O>>>0}return s.endian([h,d,u,f])};n._ff=function(o,r,l,c,h,d,u){var f=o+(r&l|~r&c)+(h>>>0)+u;return(f<<d|f>>>32-d)+r},n._gg=function(o,r,l,c,h,d,u){var f=o+(r&c|l&~c)+(h>>>0)+u;return(f<<d|f>>>32-d)+r},n._hh=function(o,r,l,c,h,d,u){var f=o+(r^l^c)+(h>>>0)+u;return(f<<d|f>>>32-d)+r},n._ii=function(o,r,l,c,h,d,u){var f=o+(l^(r|~c))+(h>>>0)+u;return(f<<d|f>>>32-d)+r},n._blocksize=16,n._digestsize=16,CC.exports=function(o,r){if(o==null)throw new Error("Illegal argument "+o);var l=s.wordsToBytes(n(o,r));return r&&r.asBytes?l:r&&r.asString?i.bytesToString(l):s.bytesToHex(l)}})();var QE=CC.exports;const Dv=Lp(QE);var Rc;(function(s){s.baseUrl="https://networking.needle.tools";function i(d){return Dv(new Uint8Array(d))}s.hashMD5=i;function n(d){const u=Dv(new Uint8Array(d),{encoding:"binary",asBytes:!0});return btoa(String.fromCharCode(...u))}s.hashMD5_Base64=n;function o(d){const u=new Uint8Array(d);return crypto.subtle.digest("SHA-256",u).then(p=>btoa(String.fromCharCode(...new Uint8Array(p))))}s.hashSha256=o;function r(d){const u=d.filesize/1024/1024;return Vs()?u<50:u<5}s.canUpload=r;async function l(d,u){var S;const f=s.baseUrl;if(f){if(!d.name)return console.error("Upload: file name is missing"),null}else return console.error("Blob storage base url is not set"),null;let p=null;d instanceof File?p=await d.arrayBuffer():p=d.data;const g=p.byteLength,y=g/1024/1024;if(y>50)return(u==null?void 0:u.silent)!==!0&&Me(`File (${y.toFixed(1)}MB) is too large for uploading (see console for details)`),console.warn(`Your file is too large for uploading (${y.toFixed(1)}MB). Max allowed size is 50MB`),null;if(!Vs()&&y>5)return(u==null?void 0:u.silent)!==!0&&Me('File is too large for uploading. Please get a <a href="https://needle.tools/pricing" target="_blank">commercial license</a> to upload files larger than 5MB'),console.warn(`Your file is too large for uploading (${y.toFixed(1)}MB). Max size is 5MB for non-commercial users. Please get a commercial license at https://needle.tools/pricing for larger files (up to 50MB)`),null;if(g<1)return console.warn(`Your file is too small for uploading (${y.toFixed(1)}MB). Min size is 1 byte`),null;const b=n(p),_={filename:d.name,"Content-Md5":b,"Content-Type":d.type||"application/octet-stream",FileSize:g.toString(),"Content-Disposition":`attachment; filename="${d.name}"`,"x-amz-server-side-encryption":"AES256"},v=await fetch(f+"/api/needle/blob",{method:"POST",headers:_,signal:u==null?void 0:u.abort}).then(T=>T.json()).catch(T=>(console.error(T),null));if(v==null)return console.warn("Upload failed..."),null;if("error"in v)return console.error(v.error),null;if("upload"in v&&v.upload){let M=function(k){var I;return(I=u==null?void 0:u.onProgress)==null||I.call(null,{progress01:0,state:"inprogress"}),fetch(k,{method:"PUT",headers:_,body:p,signal:u==null?void 0:u.abort}).then(E=>{var L;return(L=u==null?void 0:u.onProgress)==null||L.call(null,{progress01:1,state:"finished"}),E}).catch(E=>E)};console.debug("Uploading file",v.upload);let T=!1,O=null;for(let k=0;k<3;k++)try{if(T)break;if((S=u==null?void 0:u.abort)!=null&&S.aborted)return console.debug("Aborted upload"),null;const B=await M(v.upload);B instanceof Error?(O=B,await Xs(1e3*k)):B.ok&&(console.debug("File uploaded successfully"),T=!0)}catch(B){console.error(B)}if(!T)return console.error((O==null?void 0:O.message)||"Failed to upload file"),null}if("download"in v){const T=f+v.download;return console.debug("File found in blob storage",T),{key:v.key,success:!0,download_url:T}}return null}s.upload=l;function c(d){return`${s.baseUrl}/api/needle/blob/${d}`}s.getBlobUrlForKey=c;async function h(d,u){var T;const f=await fetch(d),p=(T=f.body)==null?void 0:T.getReader(),g=f.headers.get("Content-Length"),y=g?parseInt(g):0;if(!p)return null;let b=0;const _=[];for(;;){const{done:O,value:M}=await p.read();if(M&&(_.push(M),b+=M.length,u==null||u.call(null,new ProgressEvent("progress",{loaded:b,total:y}))),O)break}const v=new Uint8Array(b);let S=0;for(const O of _)v.set(O,S),S+=O.length;return v}s.download=h})(Rc||(Rc={}));const sr=C("debugaddressables");class YE{constructor(t){a(this,"_context");a(this,"_assetReferences",{});a(this,"preUpdate",()=>{});this._context=t,this._context.pre_update_callbacks.push(this.preUpdate)}dispose(){const t=this._context.pre_update_callbacks.indexOf(this.preUpdate);t>=0&&this._context.pre_update_callbacks.splice(t,1);for(const e in this._assetReferences){const i=this._assetReferences[e];i==null||i.unload()}this._assetReferences={}}findAssetReference(t){return this._assetReferences[t]||null}registerAssetReference(t){return t.url&&(this._assetReferences[t.url]?console.warn("Asset reference already registered",t):this._assetReferences[t.url]=t),t}unregisterAssetReference(t){t.url&&delete this._assetReferences[t.url]}}const ug=Symbol("assetReference"),wa=class{constructor(t,e,i=null){a(this,"_loading");a(this,"_asset");a(this,"_glbRoot");a(this,"_url");a(this,"_urlName");a(this,"_progressListeners",[]);a(this,"_hash");a(this,"_hashedUri");a(this,"_isLoadingRawBinary",!1);a(this,"_rawBinary");this._url=t;const n=t.lastIndexOf("/");if(n>=0){this._urlName=t.substring(n+1);const o=this._urlName.lastIndexOf(".");o>=0&&(this._urlName=this._urlName.substring(0,o))}else this._urlName=t;this._hash=e,t.includes("?v=")?this._hashedUri=t:this._hashedUri=e?t+"?v="+e:t,i!==null&&(this.asset=i),fE(this._url,this.onResolvePrefab.bind(this))}static getOrCreateFromUrl(t,e){if(!e&&(e=ne.Current,!e))throw new Error('Context is required when sourceId is a string. When you call this method from a component you can call it with "getOrCreate(this, url)" where "this" is the component.');const i=e.addressables,n=i.findAssetReference(t);if(n)return n;const o=new wa(t,e.hash);return i.registerAssetReference(o),o}static getOrCreate(t,e,i){if(typeof t=="string"){if(!i&&(i=ne.Current,!i))throw new Error('Context is required when sourceId is a string. When you call this method from a component you can call it with "getOrCreate(this, url)" where "this" is the component.')}else i=t.context,t=t.sourceId;const n=Ya(t,e);sr&&console.log("GetOrCreate Addressable from",t,e,"FinalPath=",n);const o=i.addressables,r=o.findAssetReference(n);if(r)return r;const l=new wa(n,i.hash);return o.registerAssetReference(l),l}get isAssetReference(){return!0}get asset(){return this._glbRoot??this._asset}set asset(t){this._asset=t}get uri(){return this._url}get url(){return this._url}get urlName(){return this._urlName}get hasUrl(){return this._url!==void 0&&(this._url.startsWith("http")||this._url.startsWith("blob:")||this._url.startsWith("www.")||this._url.includes("/"))}get rawAsset(){return this._asset}async onResolvePrefab(t){return t===this.url&&(this.mustLoad&&await this.loadAssetAsync(),this.asset)?this.asset:null}get mustLoad(){return!this.asset||this.asset.__destroyed===!0||Sc(this.asset)===!0}isLoaded(){return this._rawBinary||this.asset!==void 0}unload(){this.asset&&(sr&&console.log("Unload",this.asset),"scene"in this.asset&&this.asset.scene&&Ln(this.asset.scene,!0,!0),Ln(this.asset,!0,!0)),this.asset=null,this._rawBinary=void 0,this._glbRoot=null,this._loading=void 0,ne.Current&&ne.Current.addressables.unregisterAssetReference(this)}async preload(){if(!this.mustLoad||this._isLoadingRawBinary)return null;if(this._rawBinary!==void 0)return this._rawBinary;this._isLoadingRawBinary=!0,sr&&console.log("Preload",this._hashedUri);const t=await Rc.download(this._hashedUri,e=>{this.raiseProgressEvent(e)});return this._rawBinary=(t==null?void 0:t.buffer)??null,this._isLoadingRawBinary=!1,this._rawBinary}async loadAssetAsync(t){if(sr&&console.log("loadAssetAsync",this.url),!this.mustLoad)return this.asset;if(t&&this._progressListeners.push(t),this._loading!==void 0)return this._loading.then(n=>this.asset);const e=ne.Current;if(this._rawBinary){if(!(this._rawBinary instanceof ArrayBuffer))return console.error("Invalid raw binary data",this._rawBinary),null;this._loading=qs().parseSync(e,this._rawBinary,this.url,null),this.raiseProgressEvent(new ProgressEvent("progress",{loaded:this._rawBinary.byteLength,total:this._rawBinary.byteLength}))}else sr&&console.log("Load async",this.url),this._loading=qs().loadSync(e,this._hashedUri,this.url,null,n=>{this.raiseProgressEvent(n)});const i=await this._loading;return this._progressListeners.length=0,this._glbRoot=this.tryGetActualGameObjectRoot(i),this._loading=void 0,i?(i[ug]=this,this._glbRoot&&(this._glbRoot[ug]=this),this.asset&&(this.asset[ug]=this),Rf(e),i.scene!==void 0&&(this.asset=i),this.asset):null}async instantiate(t){return this.onInstantiate(t,!1)}async instantiateSynced(t,e=!0){return this.onInstantiate(t,!0,e)}beginListenDownload(t){this._progressListeners.indexOf(t)<0&&this._progressListeners.push(t)}endListenDownload(t){const e=this._progressListeners.indexOf(t);e>=0&&this._progressListeners.splice(e,1)}raiseProgressEvent(t){for(const e of this._progressListeners)e(this,t)}async onInstantiate(t,e=!1,i){const n=ne.Current,o=new Js;if(t instanceof F?o.parent=t:t&&(Object.assign(o,t),o.cloneAssign(t)),o.parent||(o.parent=n.scene),this.mustLoad&&await this.loadAssetAsync(),sr&&console.log("Instantiate",this.url,"parent:",t),this.asset){sr&&console.log("Add to scene",this.asset);let r=wa.currentlyInstantiating.get(this.url);if(r!==void 0&&r>=1e4)return console.error("Recursive or too many instantiations of "+this.url+" in the same frame ("+r+")"),null;try{if(r===void 0&&(r=0),r+=1,wa.currentlyInstantiating.set(this.url,r),e){o.context=n;const l=this.asset;l.guid=this.url;const c=cC(l,o,void 0,i);if(c)return c}else{const l=Pc(this.asset,o);if(l)return l}}finally{n.post_render_callbacks.push(()=>{r===void 0||r<0?r=0:r-=1,wa.currentlyInstantiating.set(this.url,r)})}}else sr&&console.warn("Failed to load asset",this.url);return null}tryGetActualGameObjectRoot(t){if(t&&t.scene){const e=t.scene;return e.isGroup&&e.children.length===1&&e.children[0].name+"glb"===e.name?e.children[0]:e}return null}};let de=wa;a(de,"currentlyInstantiating",new Map);class KE extends Fn{constructor(){super([de],"AssetReferenceSerializer")}onSerialize(t,e){if(t&&t.uri!==void 0&&typeof t.uri=="string")return t.uri}onDeserialize(t,e){if(typeof t=="string")return e.context?e.gltfId?de.getOrCreate(e.gltfId,t,e.context):(console.error("Missing source id"),null):(console.error("Missing context"),null);if(t instanceof F){if(!e.context)return console.error("Missing context"),null;if(!e.gltfId)return console.error("Missing source id"),null;const i=t,n=e.context,o=i.guid??i.uuid,r=n.addressables.findAssetReference(o);if(r)return r;const l=new de(o,void 0,i);return n.addressables.registerAssetReference(l),l}return null}}new KE;const JE=Promise.resolve(null),ad=class{constructor(t){a(this,"url");a(this,"_bitmap");a(this,"_bitmapObject");a(this,"loader",null);this.url=t}static getOrCreate(t){let e=ad.imageReferences.get(t);return e||(e=new ad(t),ad.imageReferences.set(t,e)),e}dispose(){this._bitmapObject&&this._bitmapObject.close(),this._bitmap=void 0}createHTMLImage(){const t=new Image;return t.src=this.url,t}createTexture(){return this.url?(this.loader||(this.loader=new ec),this.loader.setCrossOrigin("anonymous"),this.loader.loadAsync(this.url).then(t=>{var e;return t&&!((e=t.name)!=null&&e.length)&&(t.name=this.url.split("/").pop()??this.url),t})):(console.error("Can not load texture without url"),JE)}getBitmap(){return this._bitmap?this._bitmap:(this._bitmap=new Promise((t,e)=>{const i=document.createElement("img");i.addEventListener("load",()=>{this._bitmap=createImageBitmap(i).then(n=>(this._bitmapObject=n,t(n),n))}),i.addEventListener("error",n=>{console.error("Failed to load image:"+this.url,n),t(null)}),i.src=this.url}),this._bitmap)}};let Uh=ad;a(Uh,"imageReferences",new Map);class ZE extends Fn{constructor(){super([Uh],"ImageReferenceSerializer")}onSerialize(t,e){return null}onDeserialize(t,e){if(typeof t=="string"){const i=Ya(e.gltfId,t);return Uh.getOrCreate(i)}}}new ZE;const ld=class{constructor(t){a(this,"url");a(this,"res");this.url=t}static getOrCreate(t){let e=ld.cache.get(t);return e||(e=new ld(t),ld.cache.set(t,e)),e}async loadRaw(){return this.res||(this.res=fetch(this.url)),this.res.then(t=>t.blob())}async loadText(){return this.res||(this.res=fetch(this.url)),this.res.then(t=>t.text())}};let Nh=ld;a(Nh,"cache",new Map);class eM extends Fn{constructor(){super([Nh],"FileReferenceSerializer")}onSerialize(t,e){return null}onDeserialize(t,e){if(typeof t=="string"){const i=Ya(e.gltfId,t);return Nh.getOrCreate(i)}}}new eM;class tM{constructor(t){a(this,"context");a(this,"mixers",[]);this.context=t}onDestroy(){this.mixers.forEach(t=>t.stopAllAction()),this.mixers.length=0}registerAnimationMixer(t){if(!t){console.warn("AnimationsRegistry.registerAnimationMixer called with null or undefined mixer");return}this.mixers.includes(t)||this.mixers.push(t)}unregisterAnimationMixer(t){if(!t){console.warn("AnimationsRegistry.unregisterAnimationMixer called with null or undefined mixer");return}const e=this.mixers.indexOf(t);e!==-1&&this.mixers.splice(e,1)}}class Od{static tryGetActionsFromMixer(t){const e=t._actions;return e||null}static tryGetAnimationClipsFromObjectHierarchy(t,e){if(e||(e=new Array),t)t.animations&&e.push(...t.animations);else return e;if(t.children)for(const i of t.children)this.tryGetAnimationClipsFromObjectHierarchy(i,e);return e}static assignAnimationsFromFile(t,e){if(!t||!t.animations){console.debug("No animations found in file");return}for(let n=0;n<t.animations.length;n++){const o=t.animations[n];if(!o.tracks||o.tracks.length<=0){console.warn("Animation has no tracks");continue}for(const r in o.tracks){const l=o.tracks[r],c=mc.parseTrackName(l.name);let h=mc.findNode(t.scene,c.nodeName);if(!h){const u=l.__objectName??l.name.substring(0,l.name.indexOf("."));if(h=t.scene.getObjectByProperty("uuid",u),!h)continue}let d=i(h);if(!d){if(!(e!=null&&e.createAnimationComponent)){console.warn("No AnimationComponent found in parent hierarchy of object and no 'createAnimationComponent' callback was provided in options.");continue}d=e.createAnimationComponent(t.scene,o)}d.addClip&&d.addClip(o)}}function i(n){var r;if(!n)return null;const o=(r=n.userData)==null?void 0:r.components;if(o&&o.length>0){for(let l=0;l<o.length;l++)if(o[l].isAnimationComponent===!0)return n}return i(n.parent)}}}var Da;(function(s){s.Visible="application-visible",s.Hidden="application-hidden",s.MuteChanged="application-mutechanged"})(Da||(Da={}));let Ef=!1;const jl=[];function Za(){if(Ef)return;U()&&console.debug("User interaction registered: audio can now be played"),Ef=!0;const s=[...jl];jl.length=0,s.forEach(t=>t())}document.addEventListener("mousedown",Za);document.addEventListener("pointerup",Za);document.addEventListener("click",Za);document.addEventListener("dragstart",Za);document.addEventListener("touchend",Za);document.addEventListener("keydown",Za);te.onXRSessionStart(()=>{Za()});const Gb=class extends EventTarget{constructor(e){super();a(this,"_mute",!1);a(this,"context");a(this,"_isVisible",!0);this.context=e,window.addEventListener("visibilitychange",this.onVisiblityChanged.bind(this),!1)}static get userInteractionRegistered(){return Ef}static registerWaitForInteraction(e){if(e!==null){if(Ef){e();return}jl.indexOf(e)===-1&&jl.push(e)}}static unregisterWaitForInteraction(e){const i=jl.indexOf(e);i!==-1&&jl.splice(i,1)}get muted(){return this._mute}set muted(e){e!==this._mute&&(this._mute=e,this.dispatchEvent(new Event(Da.MuteChanged)))}get hasFocus(){return document.hasFocus()}get isVisible(){return this._isVisible}onVisiblityChanged(e){switch(e.target.visibilityState){case"hidden":this._isVisible=!1,this.dispatchEvent(new Event(Da.Hidden));break;case"visible":this._isVisible=!0,this.dispatchEvent(new Event(Da.Visible));break}}};let Ws=Gb;a(Ws,"registerWaitForAllowAudio",Gb.registerWaitForInteraction);function*OC(s,t=null){const e=t?t.time:ne.Current.time,i=e.time;for(;e.time-i<s;)yield}function*PL(s){for(let t=0;t<s;t++)yield}function*iM(s){let t=!0;for(s.then(()=>t=!1),s.catch(()=>t=!1);t;)yield}const Lv="NEEDLE_lightmaps",dh=C("debuglightmapsextension")||C("debuglightmaps");var Po;(function(s){s[s.Lightmap=0]="Lightmap",s[s.Skybox=1]="Skybox",s[s.Reflection=2]="Reflection"})(Po||(Po={}));class nM{constructor(t,e,i){a(this,"parser");a(this,"registry");a(this,"source");this.parser=t,this.registry=e,this.source=i}get name(){return Lv}afterRoot(t){const e=this.parser.json.extensions;if(e){const i=e[Lv];if(i){const n=i.textures;return n!=null&&n.length?(dh&&console.log(i),new Promise(async(o,r)=>{const l=[];for(const h of n)if(h.pointer){dh&&console.log(h);let d=null;if(h.pointer.startsWith("/textures/"))dh&&console.log("Load texture from gltf",h.pointer),d=X_(this.parser,h.pointer).then(u=>this.resolveTexture(h,u));else if(typeof h.pointer=="string"){dh&&console.log("Load texture from path",h.pointer);const u=Ya(this.source,h.pointer);let f;u.endsWith(".exr")?f=new _f(this.parser.options.manager):u.endsWith(".hdr")?f=new ly(this.parser.options.manager):f=new ec(this.parser.options.manager),d=f.loadAsync(u,void 0).then(p=>this.resolveTexture(h,p))}else h.pointer;d&&l.push(d)}const c=await Ew(l);c!=null&&c.anyFailed&&U()&&console.error("Failed to load lightmap extension",c),o()})):null}}return null}resolveTexture(t,e){const i=e;dh&&console.log("Lightmap loaded:",i),i!=null&&i.isTexture&&(this.registry?(i.colorSpace=Wa,this.registry.registerTexture(this.source,t.type,i,t.index)):console.log(Po[t.type],t.pointer,i))}}const jv=!!C("debuglightmaps");class sM{constructor(t){a(this,"_context");a(this,"_lightmaps",new Map);this._context=t}clear(){this._lightmaps.clear()}registerTexture(t,e,i,n){jv&&console.log("Registering ",Po[e]+' "'+t+'"',i),this._lightmaps.has(t)||this._lightmaps.set(t,new Map);const o=this._lightmaps.get(t),r=(o==null?void 0:o.get(e))??[];r.length<n&&(r.length=n+1),r[n]=i,o==null||o.set(e,r)}tryGetLightmap(t,e=0){return this.tryGet(t,Po.Lightmap,e)}tryGetSkybox(t){return this.tryGet(t,Po.Skybox,0)}tryGetReflection(t){return this.tryGet(t,Po.Reflection,0)}tryGet(t,e,i){if(!t)return jv&&console.warn("Missing source id"),null;const n=this._lightmaps.get(t);if(!n)return null;const o=n.get(e);return o===void 0||!(o!=null&&o.length)||o.length<=i?null:o[i]}}Ei.lights_fragment_maps=Ei.lights_fragment_maps.replace("vec4 lightMapTexel = texture2D( lightMap, vLightMapUv );",`
    vec2 lUv = vLightMapUv.xy * lightmapScaleOffset.xy + vec2(lightmapScaleOffset.z, (1. - (lightmapScaleOffset.y + lightmapScaleOffset.w)));
    vec4 lightMapTexel = texture2D( lightMap, lUv);
    // The range of RGBM lightmaps goes from 0 to 34.49 (5^2.2) in linear space, and from 0 to 5 in gamma space.
    lightMapTexel.rgb *= lightMapTexel.a * 8.; // no idea where that "8" comes from... heuristically derived
    lightMapTexel.a = 1.;
    lightMapTexel = conv_sRGBToLinear(lightMapTexel);
    `);Ei.lightmap_pars_fragment=`
    #ifdef USE_LIGHTMAP
        uniform sampler2D lightMap;
        uniform float lightMapIntensity;
        uniform vec4 lightmapScaleOffset;
        
        // took from threejs 05fc79cd52b79e8c3e8dec1e7dca72c5c39983a4
        vec4 conv_sRGBToLinear( in vec4 value ) {
            return vec4( mix( pow( value.rgb * 0.9478672986 + vec3( 0.0521327014 ), vec3( 2.4 ) ), value.rgb * 0.0773993808, vec3( lessThanEqual( value.rgb, vec3( 0.04045 ) ) ) ), value.a );
        }
    #endif
    `;Ei.lights_fragment_begin=Ei.lights_fragment_begin.replace("irradiance += getLightProbeIrradiance( lightProbe, geometry.normal );",`
#if defined(USE_LIGHTMAP)
irradiance += 0.;
#else
irradiance += getLightProbeIrradiance( lightProbe, geometry.normal );
#endif`);OP.lightmap.lightmapScaleOffset={value:new xe(1,1,0,0)};const fg=C("debugprogressive"),xu=new En,wu=new Cp;class oM{constructor(t){a(this,"context");a(this,"_lodsManager");this.context=t}get manager(){return this._lodsManager}get targetTriangleDensity(){var t;return((t=this._lodsManager)==null?void 0:t.targetTriangleDensity)??-1}set targetTriangleDensity(t){this._lodsManager&&(this._lodsManager.targetTriangleDensity=t)}setRenderer(t){var e;(e=this._lodsManager)==null||e.disable(),_l.removePlugin(this),_l.addPlugin(this),_l.debugDrawLine=G.DrawLine,this._lodsManager=_l.get(t),this._lodsManager.enable()}disable(){var t;(t=this._lodsManager)==null||t.disable(),_l.removePlugin(this)}onAfterUpdatedLOD(t,e,i,n,o){fg&&this.onRenderDebug(i,n,o)}onRenderDebug(t,e,i){var l,c,h;if(!e.geometry||!mt.hasLODLevelAvailable(e.geometry)&&!mt.hasLODLevelAvailable(e.material))return;const n=_l.getObjectLODState(e);if(!n)return;let o=i.mesh_lod;const r=i.mesh_lod!=n.lastLodLevel_Mesh||i.texture_lod!=n.lastLodLevel_Texture;if(fg&&e.geometry.boundingSphere){const d=e.geometry.boundingSphere;wu.copy(d),wu.applyMatrix4(e.matrixWorld);const u=wu.center,f=wu.radius,p=["#76c43e","#bcc43e","#c4ac3e","#c4673e","#ff3e3e"];if(r)G.DrawWireSphere(u,f,p[o],.1);else{const g=((l=e.geometry.index)==null?void 0:l.count)??0,y=(c=mt.getMeshLODInformation(e.geometry))==null?void 0:c.lods;o=y?Math.min((y==null?void 0:y.length)-1,o):0;let b="";if(y&&n.lastScreenCoverage>0)for(let S=0;S<y.length;S++){const T=y[S].density,O=S==y.length-1;b+=T.toFixed(0)+">"+(T/n.lastScreenCoverage).toFixed(0)+(O?"":",")}const _=y?(h=y[o])==null?void 0:h.density:-1;let v="LOD "+i.mesh_lod+`
TEX `+i.texture_lod;if(fg=="density"&&(v+=`
`+g+` tris
`+(_/n.lastScreenCoverage).toFixed(0)+` dens
`+(n.lastScreenCoverage*100).toFixed(1)+`% cov
`+(n.lastCentrality*100).toFixed(1)+`% centr
`+(xu.min.x.toFixed(2)+"-"+xu.max.x.toFixed(2)+"x"+xu.min.y.toFixed(2)+"-"+xu.max.y.toFixed(2))+" scr"),n.lastScreenCoverage>.1){const S=t,T=S.worldForward,O=S.worldPosition,k=Q(T).multiplyScalar(f*.7).add(u),B=k.distanceTo(O),I=p[Math.min(p.length-1,Math.max(0,o))]+"88",E=this.context.domHeight>0?screen.height/this.context.domHeight:1,L=t.isPerspectiveCamera?Math.tan(t.fov*Math.PI/180/2):1;G.DrawLabel(k,v,B*.012*E*L,void 0,16777215,I)}}}}}const rM=C("debugplayerview");var Io;(function(s){s.Browser="browser",s.Headset="headset",s.Handheld="handheld"})(Io||(Io={}));class aM{constructor(t,e){a(this,"userId");a(this,"context");a(this,"viewDevice",Io.Browser);a(this,"removed",!1);a(this,"_object");this.userId=t,this.context=e}get currentObject(){return this._object}set currentObject(t){this._object=t}get isConnected(){return this.context.connection.userIsInRoom(this.userId)}}class lM{constructor(t){a(this,"context");a(this,"playerViews",new Map);this.context=t}setPlayerView(t,e,i){let n=this.playerViews.get(t);n||(n=new aM(t,this.context),this.playerViews.set(t,n)),n.viewDevice=i,n.currentObject=e,n.removed=!1}getPlayerView(t){if(!t)return;if(!this.context.connection.userIsInRoom(t)){this.playerViews.delete(t);return}return this.playerViews.get(t)}removePlayerView(t,e){const i=this.playerViews.get(t);(i==null?void 0:i.viewDevice)===e&&(rM&&console.log("REMOVE",t),i.removed=!0,this.playerViews.delete(t))}}new fw;const Nd=new Uint8Array(4);Nd[0]=255;Nd[1]=255;Nd[2]=255;Nd[3]=255;const cM=new S_(Nd,1,1,Pp);function Z_(s,t=1){const e="alpha"in s,i=t*t,n=new Uint8Array(4*i),o=Math.floor(s.r*255),r=Math.floor(s.g*255),l=Math.floor(s.b*255);for(let h=0;h<i;h++){const d=h*4;n[d+0]=o,n[d+1]=r,n[d+2]=l,e?n[d+3]=Math.floor(s.alpha*255):n[d+3]=255}const c=new S_(n,t,t);return c.needsUpdate=!0,c}function hM(s,t,e,i=1,n=3){const r=i*n,l=[s,t,e],c=l.length,h=new Uint8Array(4*c*r),d=new ue;for(let f=0;f<n;f++){const p=Math.floor(f/n*c),g=W.clamp(p+1,0,c-1),y=l[p],b=l[g],_=f/n*c%1;d.lerpColors(y,b,_);const v=Math.floor(d.r*255),S=Math.floor(d.g*255),T=Math.floor(d.b*255);for(let O=0;O<i;O++){const M=(f*i+O)*4;h[M+0]=v,h[M+1]=S,h[M+2]=T,h[M+3]=255}}const u=new S_(h,i,n);return u.needsUpdate=!0,u}var Bv;(function(s){s[s.Vertex=0]="Vertex",s[s.Fragment=1]="Fragment"})(Bv||(Bv={}));function Mf(s,t){const e=s.elements;t||(t=[]),t.length=0;for(let i=0;i<16;i+=4){const n=e[i],o=e[i+1],r=e[i+2],l=e[i+3],c=new xe(n,o,r,l);t.push(c)}return t}const pg=[],Fv=[];function dM(s,t){if(pg.length===0)for(let e=0;e<27;e++)pg.push(0);t||(t=pg);for(let e=0;e<27;e++)Fv[e]=t[e];t=Fv,s.unity_SHAr={value:new xe(t[9],t[3],t[6],t[0])},s.unity_SHBr={value:new xe(t[12],t[15],t[18],t[21])},s.unity_SHAg={value:new xe(t[10],t[4],t[7],t[1])},s.unity_SHBg={value:new xe(t[13],t[16],t[19],t[22])},s.unity_SHAb={value:new xe(t[11],t[5],t[8],t[2])},s.unity_SHBb={value:new xe(t[14],t[17],t[20],t[23])},s.unity_SHC={value:new xe(t[24],t[25],t[26],1)}}class uM{constructor(t,e,i){a(this,"vertexShader");a(this,"fragmentShader");a(this,"technique");this.vertexShader=t,this.fragmentShader=e,this.technique=i}}async function fM(s,t){if(!s)return console.error("Can not find technique: no shader data"),null;const e=s.programs[t],i=e.vertexShader,n=e.fragmentShader;if(i!==void 0&&n!==void 0){const o=s.shaders[i],r=s.shaders[n];if(o.uri&&r.uri||o.code&&r.code){if(!o.code&&o.uri&&await zv(o),!r.code&&r.uri&&await zv(r),!o.code||!r.code)return null;const l=s.techniques[t];return new uM(o.code,r.code,l)}}return console.error("Shader technique not found",t),null}async function zv(s){const t=s.uri;if(t)if(t.endsWith(".glsl")){const i=await new fw().loadAsync(t);s.code=i.toString()}else s.code=pM(s.uri)}function pM(s){return decodeURIComponent(Array.prototype.map.call(atob(s),function(t){return"%"+("00"+t.charCodeAt(0).toString(16)).slice(-2)}).join(""))}const $n=C("debugenvlight");var Ds;(function(s){s[s.Skybox=0]="Skybox",s[s.Trilight=1]="Trilight",s[s.Flat=3]="Flat",s[s.Custom=4]="Custom"})(Ds||(Ds={}));var Td;(function(s){s[s.Skybox=0]="Skybox",s[s.Custom=1]="Custom"})(Td||(Td={}));class mM{constructor(t){a(this,"context");a(this,"_currentLightSettingsId");a(this,"_sceneLightSettings");a(this,"_timevec4",new xe);a(this,"__currentReflectionId",null);a(this,"_lighting",{});this.context=t,this.context.pre_update_callbacks.push(this.preUpdate.bind(this))}preUpdate(){const t=this.context.time;this._timevec4.x=t.time,this._timevec4.y=Math.sin(t.time),this._timevec4.z=Math.cos(t.time),this._timevec4.w=t.deltaTime}get timeVec4(){return this._timevec4}get environmentIntensity(){if(!this._sceneLightSettings||!this._currentLightSettingsId)return 1;const t=this._sceneLightSettings.get(this._currentLightSettingsId);return t?t.ambientIntensity:1}get sceneLightSettings(){var t;return(t=this._sceneLightSettings)==null?void 0:t.values()}enable(t){var i;t instanceof de&&(t=t.url);const e=(i=this._sceneLightSettings)==null?void 0:i.get(t);return e?($n&&console.log("Enable scene light settings",t,e),t!==this._currentLightSettingsId&&this._currentLightSettingsId&&this.disable(this._currentLightSettingsId),this._currentLightSettingsId=t,e.enabled=!0,!0):($n&&console.warn("No light settings found for",t),!1)}disable(t){var i;if(t instanceof de&&(t=t.url),t==null)return!1;const e=(i=this._sceneLightSettings)==null?void 0:i.get(t);return e?($n&&console.log("Disable scene light settings",t,e),e.enabled=!1,!0):!1}disableCurrent(){if(this._currentLightSettingsId){const t=this._currentLightSettingsId;return this.disable(this._currentLightSettingsId),t}return null}internalRegisterSceneLightSettings(t){const e=t.sourceId;if(!e){console.error("Missing source id for scene light settings, can not register:",t);return}$n&&console.log("Register "+(t==null?void 0:t.sourceId)+" lighting",t),this._sceneLightSettings||(this._sceneLightSettings=new Map),this._sceneLightSettings.set(e,t)}internalUnregisterSceneLightSettings(t){const e=t.sourceId;if(!e){console.error("Missing source id for scene light settings, can not unregister:",t);return}$n&&console.log("Unregister "+(t==null?void 0:t.sourceId)+" lighting",t),this._sceneLightSettings&&this._sceneLightSettings.delete(e)}internalRegisterReflection(t,e){$n&&console.log("Register reflection",t,e);const i=new gM(this.context,e,1);this._lighting[t]=i}internalGetReflection(t){return this._lighting[t]}internalEnableReflection(t){var i;this.__currentReflectionId=t;const e=(i=this._sceneLightSettings)==null?void 0:i.get(t);switch($n&&console.log("Enable reflection",t,e?Ds[e.ambientMode]:"Unknown ambient mode",e),e==null?void 0:e.ambientMode){case Ds.Skybox:case Ds.Custom:const n=this.internalGetReflection(t);if(n&&n.Source){$n&&console.log("Setting environment reflection",n);const o=this.context.scene,r=n.Source;r.mapping=Mo,o.environment=r;return}else $n&&console.warn("Could not find reflection for source",t);break}if((e==null?void 0:e.environmentReflectionSource)===Td.Custom)switch(e==null?void 0:e.ambientMode){case Ds.Trilight:if(e.ambientTrilight){const n=e.ambientTrilight,o=hM(n[0],n[1],n[2],64,64);o.colorSpace=rs,o.mapping=Mo,this.context.scene.environment=o}else console.error("Missing ambient trilight",e.sourceId);return;case Ds.Flat:if(e.ambientLight){const n=Z_(e.ambientLight,64);n.colorSpace=rs,n.mapping=Mo,this.context.scene.environment=n}else console.error("Missing ambientlight",e.sourceId);return;default:return}}internalDisableReflection(t){if(t&&t!==this.__currentReflectionId){$n&&console.log("Not disabling reflection for",t,"because it is not the current light settings id",this.__currentReflectionId);return}$n&&console.log("Disable reflection",t);const e=this.context.scene;e.environment=null}}class gM{constructor(t,e,i=1){a(this,"_source");this._source=e,e.mapping=Mo}get Source(){return this._source}}const Uv=C("timescale");let Hy=1;typeof Uv=="number"&&(Hy=Uv);class yM{constructor(){a(this,"_time",0);a(this,"_deltaTime",0);a(this,"_deltaTimeUnscaled",0);a(this,"timeScale",1);a(this,"_frame",0);a(this,"clock",new TP);a(this,"_smoothedFps",0);a(this,"_smoothedDeltaTime",0);a(this,"_fpsSamples",[]);a(this,"_fpsSampleIndex",0);typeof Hy=="number"&&(this.timeScale=Hy)}get time(){return this._time}set time(t){this._time=t}get deltaTime(){return this._deltaTime}set deltaTime(t){this._deltaTime=t}get deltaTimeUnscaled(){return this._deltaTimeUnscaled}get frame(){return this._frame}set frame(t){this._frame=t}get frameCount(){return this.frame}get realtimeSinceStartup(){return this.clock.elapsedTime}get fps(){return 1/this.deltaTime}get smoothedFps(){return this._smoothedFps}get smoothedDeltaTime(){return 1/this._smoothedFps}update(){this.deltaTime=this.clock.getDelta(),this.deltaTime=Math.min(.1,this.deltaTime),this._deltaTimeUnscaled=this.deltaTime,this.deltaTime<=0&&(this.deltaTime=1e-12),this.deltaTime*=this.timeScale,this.frame+=1,this.time+=this.deltaTime,this._fpsSamples.length<60?this._fpsSamples.push(this.deltaTime):this._fpsSamples[this._fpsSampleIndex++%60]=this.deltaTime;let t=0;for(let e=0;e<this._fpsSamples.length;e++)t+=this._fpsSamples[e];this._smoothedDeltaTime=t/this._fpsSamples.length,this._smoothedFps=1/this._smoothedDeltaTime}}let Nv=!1;function TC(s){Nv||(Nv=!0,_M(),bM())}TC();function _M(){const s=`
float startCompression = 0.8;
float desaturation = 0.5;
// Patched tonemapping function
vec3 NeutralToneMapping( vec3 color ) {
    color *= toneMappingExposure;
    
    float d = 1. - startCompression;
    // float peak = dot(color, vec3(0.299, 0.587, 0.114));
    float peak = max(color.r, max(color.g, color.b));
    if (peak < startCompression) return color;
    float newPeak = 1. - d * d / (peak + d - startCompression);
    float invPeak = 1. / peak;
    
    float extraBrightness = dot(color * (1. - startCompression * invPeak), vec3(1, 1, 1));
    
    color *= newPeak * invPeak;
    float g = 1. - 3. / (desaturation * extraBrightness + 3.);
    return mix(color, vec3(1, 1, 1), g);
}
`,t="vec3 NeutralToneMapping( vec3 color ) {",e=`return mix( color, vec3( newPeak ), g );
}`,i=Ei.tonemapping_pars_fragment.indexOf(t),n=Ei.tonemapping_pars_fragment.indexOf(e,i);if(i>=0&&n>=0){const o=Ei.tonemapping_pars_fragment.substring(i,n+e.length);Ei.tonemapping_pars_fragment=Ei.tonemapping_pars_fragment.replace(o,s)}else U()&&console.error("Couldn't find NeutralToneMapping in ShaderChunk.tonemapping_pars_fragment")}function bM(){const s=`
// 0: Default, 1: Golden, 2: Punchy
#define AGX_LOOK 0        

vec3 userSlope = vec3(1.0);
vec3 userOffset = vec3(0.0);
vec3 userPower = vec3(1.0);
float userSaturation = 1.0;

// Mean error^2: 3.6705141e-06
vec3 _agxDefaultContrastApprox(vec3 x) {
    vec3 x2 = x * x;
    vec3 x4 = x2 * x2;
    
    return  + 15.5     * x4 * x2
            - 40.14    * x4 * x
            + 31.96    * x4
            - 6.868    * x2 * x
            + 0.4298   * x2
            + 0.1191   * x
            - 0.00232;
}

vec3 _agx(vec3 val) {
    const mat3 agx_mat = mat3(
        0.842479062253094, 0.0423282422610123, 0.0423756549057051,
        0.0784335999999992,  0.878468636469772,  0.0784336,
        0.0792237451477643, 0.0791661274605434, 0.879142973793104);
    
    const float min_ev = -12.47393;
    const float max_ev = 4.026069;

    // val = pow(val, vec3(2.2)); 

    // Input transform (inset)
    val = agx_mat * val;
    
    // Log2 space encoding
    val = clamp(log2(val), min_ev, max_ev);
    val = (val - min_ev) / (max_ev - min_ev);
    
    // Apply sigmoid function approximation
    val = _agxDefaultContrastApprox(val);

    return val;
}

vec3 _agxEotf(vec3 val) {
    const mat3 agx_mat_inv = mat3(
        1.19687900512017, -0.0528968517574562, -0.0529716355144438,
        -0.0980208811401368, 1.15190312990417, -0.0980434501171241,
        -0.0990297440797205, -0.0989611768448433, 1.15107367264116);
        
    // Inverse input transform (outset)
    val = agx_mat_inv * val;
    
    // sRGB IEC 61966-2-1 2.2 Exponent Reference EOTF Display
    // NOTE: We're linearizing the output here. Comment/adjust when
    // *not* using a sRGB render target
    val = pow(val, vec3(2.2)); 

    return val;
}

vec3 _agxLook(vec3 val) {
    const vec3 lw = vec3(0.2126, 0.7152, 0.0722);
    float luma = dot(val, lw);
    
    // Default
    vec3 offset = vec3(0.0);
    vec3 slope = vec3(1.0);
    vec3 power = vec3(1.0);
    float sat = 1.0;
    
    #if AGX_LOOK == 1
    // Golden
    slope = vec3(1.0, 0.9, 0.5);
    power = vec3(0.8);
    sat = 0.8;
    #elif AGX_LOOK == 2
    // Punchy
    slope = vec3(1.0);
    power = vec3(1.35, 1.35, 1.35);
    sat = 1.4;
    #endif        
    
    // Needle
    slope = vec3(1.05);
    power = vec3(1.10, 1.10, 1.10);
    sat = 1.15;

    // User
    // slope = userSlope;
    // offset = userOffset;
    // power = userPower;
    // sat = userSaturation;
    
    // ASC CDL
    val = pow(val * slope + offset, power);
    return luma + sat * (val - luma);
}


vec3 AgXToneMapping( vec3 color ) {
    // apply AGX
    color *= toneMappingExposure;
    color = _agx(color);
    color = _agxLook(color); // Optional
    color = _agxEotf(color);
    return color;
`,t="vec3 AgXToneMapping( vec3 color ) {",e="return color;",i=Ei.tonemapping_pars_fragment.indexOf(t),n=Ei.tonemapping_pars_fragment.indexOf(e,i);if(i>=0&&n>=0){const o=Ei.tonemapping_pars_fragment.substring(i,n+e.length);Ei.tonemapping_pars_fragment=Ei.tonemapping_pars_fragment.replace(o,s)}else U()&&console.error("Couldn't find AgXToneMapping in ShaderChunk.tonemapping_pars_fragment")}function li(s){const t=document.createElement("span");return t.style.maxWidth="48px",t.style.maxHeight="48px",t.style.overflow="hidden",t.classList.add("material-symbols-outlined","notranslate"),t.setAttribute("translate","no"),t.innerText=s,t}function vM(s){var e;return((e=s.classList)==null?void 0:e.contains("material-symbols-outlined"))||!1}const Su=new Map;async function $v(s){const t="Material Symbols Outlined";if(document.fonts.check(`1em '${t}'`)||(console.log("Font not loaded yet"),await document.fonts.ready),Su.has(s))return Su.get(s);const e=document.createElement("canvas"),i=48;e.width=i,e.height=i;const n=e.getContext("2d");if(n){n.font=`${i}px '${t}'`,n.fillStyle="black",n.fillText(s,0,i);const o=e.toDataURL(),r=new Je;return r.name=s+" icon",r.image=new Image,r.image.src=o,r.needsUpdate=!0,Su.set(s,r),r}return Su.set(s,null),null}const hp=class{constructor(){a(this,"_fullscreenButton");a(this,"_muteButton");a(this,"_qrButton")}static getOrCreate(){return this._instance||(this._instance=new hp),this._instance}static create(){return new hp}get fullscreenButton(){return this._fullscreenButton}createFullscreenButton(t){if(this._fullscreenButton)return this._fullscreenButton;if(!document.fullscreenEnabled)return U()&&console.warn("NeedleMenu: Fullscreen button could not be created, device doesn't support the Fullscreen API"),null;const e=document.createElement("button");this._fullscreenButton=e,e.classList.add("fullscreen-button"),e.title="Click to enter fullscreen mode";const i=li("fullscreen"),n=li("fullscreen_exit");return e.appendChild(i),e.onclick=()=>{document.fullscreenElement?document.exitFullscreen():"webkitRequestFullscreen"in t.domElement&&typeof t.domElement.webkitRequestFullscreen=="function"?t.domElement.webkitRequestFullscreen():"requestFullscreen"in t.domElement&&t.domElement.requestFullscreen()},document.addEventListener("fullscreenchange",()=>{document.fullscreenElement?(i.remove(),e.appendChild(n),e.title="Click to enter fullscreen mode"):(n.remove(),e.appendChild(i),e.title="Click to exit fullscreen mode")}),globalThis.addEventListener("needle-xrsession-start",()=>{e.style.display="none"}),globalThis.addEventListener("needle-xrsession-end",()=>{e.style.display=""}),e}get muteButton(){return this._muteButton}createMuteButton(t){if(this._muteButton)return this._muteButton;const e=document.createElement("button");this._muteButton=e,e.classList.add("mute-button"),e.title="Click to mute/unmute";const i=li("volume_off"),n=li("volume_up");return t.application.muted?e.appendChild(i):e.appendChild(n),e.onclick=()=>{t.application.muted?(i.remove(),e.appendChild(n),t.application.muted=!1):(n.remove(),e.appendChild(i),t.application.muted=!0)},e}get qrButton(){return this._qrButton}createQRCode(){if(this._qrButton)return this._qrButton;const t=document.createElement("button");this._qrButton=t,t.innerText="QR Code",t.prepend(li("qr_code")),t.title="Scan this QR code with your phone to open this page",this.hideElementDuringXRSession(t);const e=document.createElement("div");e.style.cssText=`
            position: fixed;
            display: inline-block;
            padding: 1rem;
            background-color: white;
            border-radius: 0.4rem;
            cursor: pointer;
            z-index: 1000;
            box-shadow: 0 0 12px rgba(0, 0, 0, 0.2);
        `;const i=document.createElement("div");i.classList.add("qr-code-container"),e.appendChild(i),t.addEventListener("click",()=>{if(e.parentNode)return o();window.location.href.includes("://localhost")&&Me("To access your website from another device in the same local network you have to use the IP address instead of localhost."),n()});async function n(){await r(),document.body.appendChild(e);const l=i.getBoundingClientRect(),c=t.getBoundingClientRect();e.style.left=c.left+c.width*.5-l.width*.5+"px",c.top<l.height?e.style.top=`calc(${c.bottom}px + ${e.style.padding} * .6)`:e.style.top=`calc(${c.top-l.height}px - ${e.style.padding} * 2.5)`,e.style.opacity="0",e.style.pointerEvents="all",e.style.transition="opacity 0.2s ease-in-out",setTimeout(()=>{e.style.opacity="1",window.addEventListener("click",o,{once:!0})}),window.addEventListener("resize",o),window.addEventListener("scroll",o),document.fullscreenElement?document.fullscreenElement.appendChild(e):document.body.appendChild(e)}function o(){e.style.pointerEvents="none",e.style.transition="opacity 0.2s",e.style.opacity="0",setTimeout(()=>{var l;return(l=e.parentNode)==null?void 0:l.removeChild(e)},500),window.removeEventListener("click",o),window.removeEventListener("resize",o),window.removeEventListener("scroll",o)}async function r(){const c=await bO({text:window.location.href,width:200,height:200});i.innerHTML="",i.appendChild(c)}return t.addEventListener("pointerenter",()=>{r()},{once:!0}),t}hideElementDuringXRSession(t){B_(e=>{t["previous-display"]=t.style.display,t.style.display="none"}),eS(e=>{t["previous-display"]!=null&&(t.style.display=t["previous-display"])})}};let Fs=hp;a(Fs,"_instance");function Af(s,t){const e=(t==null?void 0:t.element)||document.head,i=Array.from(e.querySelectorAll(`link[rel=stylesheet][href*='${s}']`));if(i.length<=0){const n=document.createElement("link");n.href=s,n.rel="stylesheet",e.appendChild(n),i.push(n)}if(t!=null&&t.loadedCallback)for(let n=0;n<i.length;n++)t!=null&&t.loadedCallback&&i[n].addEventListener("load",t.loadedCallback)}function kC(){Af("https://fonts.googleapis.com/css2?family=Roboto+Flex:opsz,wght@8..144,100..1000&display=swap")}const Gy="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0&display=block",If="needle-logo-element";class EC extends HTMLElement{constructor(){super();a(this,"_root");a(this,"wrapper");a(this,"logoElement",document.createElement("img"));a(this,"textElement",document.createElement("span"));this._root=this.attachShadow({mode:"closed"});const e=document.createElement("template");e.innerHTML=`<style>
        :host {
            position: relative;
            min-width: fit-content;
            /* height: 100%; can not have height 100% because of align-items: stretch; in the parent */
            display: flex;
        }

        .wrapper {
            position: relative;
            display: grid;
            grid-template-columns: auto auto;
            padding: .1rem;
        }
        .wrapper:hover {
            cursor: pointer;
        }
        img {
            width: 95px;
            height: 100%;
            align-self: end;
            margin-left: 0.6rem;
        }
        span {
            font-size: 1rem;
            white-space: nowrap;
        }
        </style>
        <div class="wrapper">
            <img class="logo" src=${yT} />
        </div>
        `,this._root.appendChild(e.content.cloneNode(!0)),this.wrapper=this._root.querySelector(".wrapper"),this._root.appendChild(this.wrapper),this.addEventListener("click",()=>{globalThis.open("https://needle.tools","_blank")}),this.wrapper.setAttribute("title","Made with Needle Engine")}static get elementName(){return If}static create(){return document.createElement(If)}setLogoVisible(e){this.logoElement.style.display=e?"block":"none"}}customElements.get(If)||customElements.define(If,EC);const mg=C("debugspatialmenu");class xM{constructor(t,e){a(this,"_context");a(this,"needleMenu");a(this,"htmlButtonsMap",new Map);a(this,"enabled",!0);a(this,"userRequestedMenu",!1);a(this,"uiisDirty",!1);a(this,"_showNeedleLogo");a(this,"_wasInXR",!1);a(this,"preRender",()=>{var e;if(!this.enabled){(e=this.menu)==null||e.removeFromParent();return}mg&&J.isDesktop()&&this.updateMenu();const t=this._context.xr;if(!(t!=null&&t.running)){this._wasInXR&&(this._wasInXR=!1,this.onExitXR());return}this._wasInXR||(this._wasInXR=!0,this.onEnterXR()),this.updateMenu()});a(this,"_menuTarget",new F);a(this,"positionFilter",new jw(90,.5));a(this,"familyName","Needle Spatial Menu");a(this,"menu");a(this,"_poweredByNeedleElement");var n;this._context=t,this._context.pre_render_callbacks.push(this.preRender),this.needleMenu=e;const i=(n=this.needleMenu.shadowRoot)==null?void 0:n.querySelector(".options");i?new MutationObserver(r=>{if(this.enabled&&!(this._context.isInXR==!1&&!mg))for(const l of r)l.type==="childList"&&(l.addedNodes.forEach(c=>{this.createButtonFromHTMLNode(c)}),l.removedNodes.forEach(c=>{const h=c,d=this.htmlButtonsMap.get(h);d&&(this.htmlButtonsMap.delete(h),d.remove(),Be.update())}))}).observe(i,{childList:!0}):console.error("Could not find options container in needle menu")}setEnabled(t){var e;this.enabled=t,t||(e=this.menu)==null||e.removeFromParent()}setDisplay(t){return this.enabled?(this.userRequestedMenu=t,!0):!1}onDestroy(){const t=this._context.pre_render_callbacks.indexOf(this.preRender);t>-1&&this._context.pre_render_callbacks.splice(t,1)}markDirty(){this.uiisDirty=!0}showNeedleLogo(t){this._showNeedleLogo=t}onEnterXR(){var e;const t=(e=this.needleMenu.shadowRoot)==null?void 0:e.querySelector(".options");t&&t.childNodes.forEach(i=>{this.createButtonFromHTMLNode(i)})}onExitXR(){var t;(t=this.menu)==null||t.removeFromParent()}createButtonFromHTMLNode(t){const e=this.getMenu(),i=this.htmlButtonsMap.get(t);if(i){i.add();return}if(t instanceof HTMLButtonElement){const n=this.createButton(e,t);this.htmlButtonsMap.set(t,n),n.add()}else t instanceof HTMLSlotElement&&t.assignedNodes().forEach(n=>{this.createButtonFromHTMLNode(n)})}updateMenu(){var o,r;performance.mark("NeedleSpatialMenu updateMenu start");const t=this.getMenu();this.handleNeedleWatermark(),this._context.scene.add(t);const e=this._context.mainCamera,i=this._context.xr,n=(i==null?void 0:i.rigScale)||1;if(e){const l=e.worldPosition,c=e.worldForward.multiplyScalar(-1),h=c.y>.6,d=c.y>.4,u=(t.visible?d:h)||this.userRequestedMenu,f=!t.visible&&u;t.visible=u||J.isDesktop()&&mg,c.multiplyScalar(3*n),l.add(c),(f||!1)&&(t.position.copy(this._menuTarget.position),t.position.y+=.25,this._menuTarget.position.copy(t.position),this.positionFilter.reset(t.position),t.quaternion.copy(this._menuTarget.quaternion),this.markDirty());const g=this._menuTarget.position.distanceTo(l);(f||g>1.5*n)&&(this.ensureRenderOnTop(this.menu),this._menuTarget.position.copy(l),this._context.scene.add(this._menuTarget),Mp(this._menuTarget,this._context.mainCamera,!0,!0),this._menuTarget.removeFromParent()),this.positionFilter.filter(this._menuTarget.position,t.position,this._context.time.time);const y=5;(o=this.menu)==null||o.quaternion.slerp(this._menuTarget.quaternion,this._context.time.deltaTime*y),(r=this.menu)==null||r.scale.setScalar(n)}this.uiisDirty&&(performance.mark("SpatialMenu.update.uiisDirty.start"),this.uiisDirty=!1,Be.update(),performance.mark("SpatialMenu.update.uiisDirty.end"),performance.measure("SpatialMenu.update.uiisDirty","SpatialMenu.update.uiisDirty.start","SpatialMenu.update.uiisDirty.end")),performance.mark("NeedleSpatialMenu updateMenu end"),performance.measure("SpatialMenu.update","NeedleSpatialMenu updateMenu start","NeedleSpatialMenu updateMenu end")}ensureRenderOnTop(t,e=0){t instanceof Z&&(t.material.depthTest=!1,t.material.depthWrite=!1),t.renderOrder=1e3+e*2;for(const i of t.children)this.ensureRenderOnTop(i,e+1)}get isVisible(){var t;return(t=this.menu)==null?void 0:t.visible}getMenu(){if(this.menu)return this.menu;this.ensureFont(),this.menu=new Be.Block({boxSizing:"border-box",fontFamily:this.familyName,height:"auto",fontSize:.1,color:0,lineHeight:1,backgroundColor:16777215,backgroundOpacity:.55,borderRadius:1,whiteSpace:"pre-wrap",flexDirection:"row",alignItems:"center",padding:new xe(0,.05,0,.05),borderColor:0,borderOpacity:.05,borderWidth:.005});const t=w.get("ObjectRaycaster");return t&&oc(this.menu,new t),this.menu}handleNeedleWatermark(){var t;if(!this._poweredByNeedleElement){this._poweredByNeedleElement=new Be.Block({width:"auto",height:"auto",fontSize:.05,whiteSpace:"pre-wrap",flexDirection:"row",flexWrap:"wrap",justifyContent:"center",margin:.02,borderRadius:.02,padding:.02,backgroundColor:16777215,backgroundOpacity:1}),this._poweredByNeedleElement["needle:use_eventsystem"]=!0;const e=new Wv(this._context,()=>globalThis.open("https://needle.tools","_self"));oc(this._poweredByNeedleElement,e);const i=new Be.Text({textContent:"Powered by",width:"auto",height:"auto"}),n=new Be.Text({textContent:"needle",width:"auto",height:"auto",fontSize:.07,margin:new xe(0,0,0,.02)});this._poweredByNeedleElement.add(i),this._poweredByNeedleElement.add(n),(t=this.menu)==null||t.add(this._poweredByNeedleElement),this.markDirty(),new ec().load("./include/needle/poweredbyneedle.webp",r=>{var c;e.allowModifyUI=!1,i.removeFromParent(),n.removeFromParent();const l=r.image.width/r.image.height;(c=this._poweredByNeedleElement)==null||c.set({backgroundImage:r,backgroundOpacity:1,width:.1*l,height:.1}),this.markDirty()})}if(this.menu){const e=this.menu.children.indexOf(this._poweredByNeedleElement);if(!this._showNeedleLogo&&La())e>=0&&(this._poweredByNeedleElement.removeFromParent(),this.markDirty());else{this._poweredByNeedleElement.visible=!0,this.menu.add(this._poweredByNeedleElement);const i=this.menu.children.indexOf(this._poweredByNeedleElement);e!==i&&this.markDirty()}}}ensureFont(){let t=Be.FontLibrary.getFontFamily(this.familyName);if(!t){t=Be.FontLibrary.addFontFamily(this.familyName);const e=t.addVariant("normal","normal","./include/needle/arial-msdf.json","./include/needle/arial.png");e==null||e.addEventListener("ready",()=>{this.markDirty()})}}createButton(t,e){const i=new Be.Block({width:"auto",height:"auto",whiteSpace:"pre-wrap",flexDirection:"row",flexWrap:"wrap",justifyContent:"center",backgroundColor:16777215,backgroundOpacity:0,padding:.02,margin:.01,borderRadius:.02,cursor:"pointer",fontSize:.05}),n=new Be.Text({textContent:"",width:"auto",justifyContent:"center",alignItems:"center",backgroundOpacity:0,backgroundColor:16777215,fontFamily:this.familyName,color:0,borderRadius:.02,padding:.01});i.add(n),i["needle:use_eventsystem"]=!0;const o=new Wv(this._context,()=>e.click());return oc(i,o),new wM(this,t,e,i,n)}}class wM{constructor(t,e,i,n,o){a(this,"menu");a(this,"root");a(this,"htmlbutton");a(this,"spatialContainer");a(this,"spatialText");a(this,"spatialIcon");a(this,"_lastText","");a(this,"_lastTexture");this.menu=t,this.root=e,this.htmlbutton=i,this.spatialContainer=n,this.spatialText=o,new MutationObserver(l=>{for(const c of l)c.type==="attributes"?c.attributeName==="style"&&this.updateVisible():c.type==="childList"&&this.updateText()}).observe(i,{attributes:!0,childList:!0}),this.updateText()}add(){this.spatialContainer.parent!=this.root&&(this.root.add(this.spatialContainer),this.menu.markDirty(),this.updateVisible(),this.updateText())}remove(){this.spatialContainer.parent&&(this.spatialContainer.removeFromParent(),this.menu.markDirty())}updateVisible(){const t=this.spatialContainer.visible;this.spatialContainer.visible=this.htmlbutton.style.display!=="none",t!==this.spatialContainer.visible&&this.menu.markDirty()}updateText(){let t="",e="";this.htmlbutton.childNodes.forEach(i=>{i.nodeType===Node.TEXT_NODE?t+=i.textContent:i instanceof HTMLElement&&vM(i)&&i.textContent&&(e=i.textContent)}),this._lastText!==t&&(this._lastText=t,this.spatialText.name=t,this.spatialText.set({textContent:t}),this.menu.markDirty()),t.length<=0?this.spatialText.parent&&(this.spatialText.removeFromParent(),this.menu.markDirty()):this.spatialText.parent||(this.spatialContainer.add(this.spatialText),this.menu.markDirty()),e&&this.createIcon(e)}async createIcon(t){var i;if(!this.spatialIcon){const n=await $v(t);if(n&&!this.spatialIcon){const r=new Be.Block({width:.08,height:.08,backgroundColor:16777215,backgroundImage:n,backgroundOpacity:1,margin:new xe(0,.005,0,0)});this.spatialIcon=r,this.spatialContainer.add(r),this.menu.markDirty()}}if(t!=this._lastTexture){this._lastTexture=t;const n=await $v(t);n&&((i=this.spatialIcon)==null||i.set({backgroundImage:n}),this.menu.markDirty())}const e=this.spatialContainer.children.indexOf(this.spatialIcon);e>0&&(this.spatialContainer.children.splice(e,1),this.spatialContainer.children.unshift(this.spatialIcon),this.menu.markDirty())}}class Wv{constructor(t,e){a(this,"isComponent",!0);a(this,"enabled",!0);a(this,"gameObject");a(this,"allowModifyUI",!0);a(this,"context");a(this,"onclick");this.context=t,this.onclick=e}get activeAndEnabled(){return!0}__internalAwake(){}__internalEnable(){}__internalDisable(){}__internalStart(){}onEnable(){}onDisable(){}get element(){return this.gameObject}onPointerEnter(){this.context.input.setCursor("pointer"),this.allowModifyUI&&(this.element.set({backgroundOpacity:1}),Be.update())}onPointerExit(){this.context.input.unsetCursor("pointer"),this.allowModifyUI&&(this.element.set({backgroundOpacity:0}),Be.update())}onPointerDown(t){t.use()}onPointerUp(t){t.use()}onPointerClick(t){t.use(),this.onclick()}}const ya="needle-menu",$h=C("debugmenu"),Vv=C("debugnoncommercial");let SM=class{constructor(t){a(this,"_context");a(this,"_menu");a(this,"_spatialMenu");a(this,"onPostMessage",t=>{if(t.origin===globalThis.location.origin&&typeof t.data=="object"){const e=t.data,i=e.type;if(i==="needle:menu"){const n=e.button;if(n){if(!n.label)return console.error("NeedleMenu: buttoninfo.label is required");if(!n.onclick)return console.error("NeedleMenu: buttoninfo.onclick is required");const o=document.createElement("button");if(o.textContent=n.label,n.icon){const r=li(n.icon);o.prepend(r)}n.priority&&o.setAttribute("priority",n.priority.toString()),o.onclick=()=>{if(n.onclick){const r=n.onclick.startsWith("http")||n.onclick.startsWith("www."),l=n.target||"_blank";r?globalThis.open(n.onclick,l):console.error("NeedleMenu: onclick is not a valid link",n.onclick)}},this._menu.appendChild(o)}else $h&&console.error("NeedleMenu: unknown postMessage event",e)}else $h&&console.warn("NeedleMenu: unknown postMessage type",i,e)}});a(this,"onStartXR",t=>{t.session.isScreenBasedAR&&(this._menu.previousParent=this._menu.parentNode,this._context.arOverlayElement.appendChild(this._menu),t.session.session.addEventListener("end",this.onExitXR),this._menu.closeFoldout())});a(this,"onExitXR",()=>{this._menu.previousParent&&(this._menu.previousParent.appendChild(this._menu),delete this._menu.previousParent)});a(this,"_muteButton");a(this,"_fullscreenButton");this._menu=Df.getOrCreate(t.domElement,t),this._context=t,this._spatialMenu=new xM(t,this._menu),window.addEventListener("message",this.onPostMessage),B_(this.onStartXR)}onDestroy(){window.removeEventListener("message",this.onPostMessage),this._menu.remove(),this._spatialMenu.onDestroy()}setPosition(t){this._menu.setPosition(t)}setVisible(t){this._menu.setVisible(t)}showNeedleLogo(t){var e;this._menu.showNeedleLogo(t),(e=this._spatialMenu)==null||e.showNeedleLogo(t)}showSpatialMenu(t){this._spatialMenu.setEnabled(t)}setSpatialMenuVisible(t){this._spatialMenu.setDisplay(t)}get spatialMenuIsVisible(){return this._spatialMenu.isVisible}showQRCodeButton(t){if(t==="desktop-only"&&(t=!J.isMobileDevice()),t){const e=Fs.getOrCreate().createQRCode();return e.style.display="",this._menu.appendChild(e),e}else{const e=Fs.getOrCreate().qrButton;return e&&(e.style.display="none"),e??null}}showAudioPlaybackOption(t){var e;if(!t){(e=this._muteButton)==null||e.remove();return}this._muteButton=Fs.getOrCreate().createMuteButton(this._context),this._muteButton.setAttribute("priority","100"),this._menu.appendChild(this._muteButton)}showFullscreenOption(t){var e;if(!t){(e=this._fullscreenButton)==null||e.remove();return}this._fullscreenButton=Fs.getOrCreate().createFullscreenButton(this._context),this._fullscreenButton&&(this._fullscreenButton.setAttribute("priority","150"),this._menu.appendChild(this._fullscreenButton))}appendChild(t){return this._menu.appendChild(t)}};var Id,Dd,qy;const qb=class extends HTMLElement{constructor(){var u,f,p,g,y,b;super();Yi(this,Dd);a(this,"_domElement",null);a(this,"_context",null);a(this,"_sizeChangeInterval");Yi(this,Id,e=>{if(!e.defaultPrevented&&e.target==this._domElement&&e instanceof PointerEvent&&e.button===0&&this.root.classList.contains("open")){const i=this.foldout.getBoundingClientRect(),n=e;n.clientX>i.left&&n.clientX<i.right&&n.clientY>i.top&&n.clientY<i.bottom||this.root.classList.toggle("open",!1)}});a(this,"_userRequestedLogoVisible");a(this,"_userRequestedMenuVisible");a(this,"root");a(this,"wrapper");a(this,"options");a(this,"logoContainer");a(this,"compactMenuButton");a(this,"foldout");a(this,"_isHandlingChange",!1);a(this,"_didSort",new Map);a(this,"_lastAvailableWidthChange",0);a(this,"_timeoutHandle",0);a(this,"handleSizeChange",(e,i)=>{if(!this._domElement)return;const n=this._domElement.clientWidth;if(n<100){clearTimeout(this._timeoutHandle),this.root.classList.add("compact"),this.foldout.classList.add("floating-panel-style");return}const o=20*2,r=n-o;if(!i&&Math.abs(r-this._lastAvailableWidthChange)<1)return;this._lastAvailableWidthChange=r,clearTimeout(this._timeoutHandle),this._timeoutHandle=setTimeout(()=>{const h=c();h<0?(this.root.classList.add("compact"),this.foldout.classList.add("floating-panel-style")):h>0&&(this.root.classList.remove("compact"),this.foldout.classList.remove("floating-panel-style"),c()<0&&(this.root.classList.add("compact"),this.foldout.classList.add("floating-panel-style")))},5);const l=()=>this.options.clientWidth+this.logoContainer.clientWidth,c=()=>r-l()});const e=document.createElement("template");e.innerHTML=`<style>

        #root {
            position: absolute;
            width: auto;
            max-width: 95%;
            left: 50%;
            transform: translateX(-50%);
            top: min(20px, 10vh);
            padding: 0.3rem;
            display: flex;
            visibility: visible;
            flex-direction: row-reverse; /* if we overflow this should be right aligned so the logo is always visible */
            pointer-events: all;
            z-index: 1000;
        }

        /** hide the menu if it's empty **/
        #root.has-no-options.logo-hidden {
            display: none; 
        }

        /** using a div here because then we can change the class for placement **/
        #root.bottom {
            top: auto;
            bottom: min(30px, 10vh);
        }
        #root.top {
            top: calc(.7rem + env(safe-area-inset-top));
        }
        
        .wrapper {
            position: relative;
            display: flex;
            flex-direction: row;
            justify-content: center;
            align-items: stretch;
            gap: 0px;
            padding: 0 0rem;
        }

        .wrapper > *, .options > button, .options > select, ::slotted(*) {
            position: relative;
            border: none;
            border-radius: 0;
            outline: 1px solid rgba(0,0,0,0);
            display: flex;
            justify-content: center;
            align-items: center;
            max-height: 2.3rem;
            max-width: 100%;

            /** basic font settings for all entries **/
            font-size: 1rem;
            font-family: 'Roboto Flex', sans-serif;
            font-optical-sizing: auto;
            font-weight: 500;
            font-weight: 200;
            font-variation-settings: "wdth" 100;
            color: rgb(20,20,20);
        }

        .floating-panel-style {
            background: rgba(255, 255, 255, .4);
            outline: rgb(0 0 0 / 5%) 1px solid;
            border: 1px solid rgba(255, 255, 255, .1);
            box-shadow: 0px 7px 0.5rem 0px rgb(0 0 0 / 6%), inset 0px 0px 1.3rem rgba(0,0,0,.05);
            border-radius: 1.5rem;
            /** 
             * to make nested background filter work 
             * https://stackoverflow.com/questions/60997948/backdrop-filter-not-working-for-nested-elements-in-chrome 
             **/
            &::before {
                content: '';
                position: absolute;
                width: 100%;
                height: 100%;
                top: 0;
                left: 0;
                z-index: -1;
                border-radius: 1.5rem;
                -webkit-backdrop-filter: blur(8px);
                backdrop-filter: blur(8px);
            }
        }

        a {
            color: inherit;
            text-decoration: none;
        }

        .options {
            display: flex;
            flex-direction: row;
            align-items: center;
        }

        .options > *, ::slotted(*) {
            max-height: 2.25rem;
            padding: .4rem .5rem;
        }
        
        :host .options > *, ::slotted(*) {
            background: transparent;
            border: none;
            white-space: nowrap;
            transition: all 0.1s linear .02s;
            border-radius: 1.5rem;
            user-select: none;
        }
        :host .options > *:hover, ::slotted(*:hover) {
            cursor: pointer;
            color: black;
            background: rgba(245, 245, 245, .8);
            box-shadow: inset 0 0 1rem rgba(0,0,30,.2);
            outline: rgba(0,0,0,.1) 1px solid;
        }
        :host .options > *:active, ::slotted(*:active) {
            background: rgba(255, 255, 255, .8);
            box-shadow: inset 0px 1px 1px rgba(255,255,255,.5), inset 0 0 2rem rgba(0,0,30,.2), inset 0px 2px 4px rgba(0,0,20,.5);
            transition: all 0.05s linear;
        }
        :host .options > *:focus, ::slotted(*:focus) {
            outline: rgba(255,255,255,.5) 1px solid;
        }
        :host .options > *:focus-visible, ::slotted(*:focus-visible) {
            outline: rgba(0,0,0,.5) 1px solid;
        }

        :host .options > *:disabled, ::slotted(*:disabled) {
            background: rgba(0,0,0,.05);
            color: rgba(60,60,60,.7);
            pointer-events: none;
        }

        button, ::slotted(button) {
            gap: 0.3rem;
        }

        /** XR button animation **/
        :host button.this-mode-is-requested {
            background: repeating-linear-gradient(to right, #fff 0%, #fff 40%, #aaffff 55%, #fff 80%);
            background-size: 200% auto;
            background-position: 0 100%;
            animation: AnimationName .7s ease infinite forwards;
        }
        :host button.other-mode-is-requested {
            opacity: .5;
        }
        
        @keyframes AnimationName {
            0% { background-position: 0% 0 }
            100% { background-position: -200% 0 }
        }




        .logo {
            cursor: pointer;
            padding-left: 0.6rem;
            padding-bottom: .02rem;
            margin-right: 0.5rem;
        }
        .logo-hidden {
            .logo {
                display: none;
            }
        }
        :host .has-options .logo {
            border-left: 1px solid rgba(40,40,40,.4);
            margin-left: 0.3rem;
            margin-right: 0.5rem;
        }

        .logo > span {
            white-space: nowrap;
        }



        /** COMPACT */

        /** Hide the menu button normally **/
        .compact-menu-button { display: none; }
        /** And show it when we're in compact mode **/
        .compact .compact-menu-button {
            position: relative;
            display: block;
            background: none;
            border: none;
            border-radius: 2rem;

            margin: 0;
            padding: 0 .3rem;
            padding-top: .2rem;

            z-index: 100;

            color: #000;

            &:hover {
                background: rgba(255,255,255,.2);
                cursor: pointer;
            }
            &:focus {
                outline: 1px solid rgba(255,255,255,.5);
            }
            &:focus-visible {
                outline: 1px solid rgba(0,0,0,.5);
            }
            & .expanded-click-area {
                position: absolute;
                left: 0;
                right: 0;
                top: 10%;
                bottom: 10%;
                transform: scale(1.8);
            }
        }  
        .has-no-options .compact-menu-button {
            display: none;
        }
        .open .compact-menu-button {
            background: rgba(255,255,255,.2);
        }
        .logo-visible .compact-menu-button { 
            margin-left: .2rem;
        }
        
        /** Open and hide menu **/
        .compact .foldout { 
            display: none;
        }
        .open .options, .open .foldout {
            display: flex;
            justify-content: center;
        }
        .compact .wrapper {
            padding: 0;
        }
        .compact .wrapper, .compact .options {
            height: auto;
            max-height: initial;
            flex-direction: row;
            gap: .12rem;
        }
        .compact .options { 
            flex-wrap: wrap;
            gap: .3rem;
        }
        .compact .top .options {
            height: auto;
            flex-direction: row;
        }
        .compact .bottom .wrapper {
            height: auto;
            flex-direction: column;
        }

        .compact .foldout {
            max-height: min(100ch, calc(100vh - 100px));
            overflow: auto;
            overflow-x: hidden;
            align-items: center;

            position: fixed;
            bottom: calc(100% + 5px);
            z-index: 100;
            width: auto;
            left: .2rem;
            right: .2rem;
            padding: .2rem;

        }
        .compact.logo-hidden .foldout {
            /** for when there's no logo we want to center the foldout **/
            min-width: 24ch;
            margin-left: 50%;
            transform: translateX(calc(-50% - .2rem));
        }
        
        .compact.top .foldout {
            top: calc(100% + 5px);
            bottom: auto;
        }

        ::-webkit-scrollbar {
            max-width: 7px;
            background: rgba(100,100,100,.2);
            border-radius: .2rem;
        }
        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, .3);
            border-radius: .2rem;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: rgb(150,150,150);
        }

        .compact .options > *, .compact .options > ::slotted(*) {
            font-size: 1.2rem;
            padding: .6rem .5rem;
            width: 100%;
        }
        .compact.has-options .logo {
            border: none;
            padding-left: 0;
            margin-left: 1rem;
            margin-bottom: .02rem;
        }
        .compact .options {
            /** e.g. if we have a very wide menu item like a select with long option names we don't want to overflow **/
            max-width: 100%;

            & > button, & > select {
                display: flex;
                flex-basis: 100%;
                min-height: 3rem;
            }
            & > button.row2 {
                //border: 1px solid red !important;
                display: flex;
                flex: 1;
                flex-basis: 30%;
            }
        }

        /** If there's really not enough space then just hide all options **/
        @media (max-width: 100px) or (max-height: 100px){
            .foldout {
                display: none !important;
            }
            .compact-menu-button {
                display: none !important;
            }
        }
        
        /* dark mode */
        /*
        @media (prefers-color-scheme: dark) {
            :host {
                background: rgba(0,0,0, .6);
            }
            :host button {
                color: rgba(200,200,200);
            }
            :host button:hover {
                background: rgba(100,100,100, .8);
            }
        }
        */

        </style>
        
        <div id="root" class="logo-visible floating-panel-style bottom">
            <div class="wrapper">
                <div class="foldout">
                    <div class="options" part="options">
                        <slot></slot>
                    </div>
                    <div class="options" part="options">
                        <slot name="end"></slot>
                    </div>
                </div>
                <div style="user-select:none" class="logo">
                    <span class="madewith notranslate">powered by</span>
                </div>
            </div>
            <button class="compact-menu-button">
                <div class="expanded-click-area"></div>
            </button>
        </div>
        `;const i=this.attachShadow({mode:"open"});kC(),Af(Gy,{loadedCallback:()=>{this.handleSizeChange()}}),Af(Gy,{element:i});const n=e.content.cloneNode(!0);i==null||i.appendChild(n),this.root=i.querySelector("#root"),this.wrapper=(u=this.root)==null?void 0:u.querySelector(".wrapper"),this.options=(f=this.root)==null?void 0:f.querySelector(".options"),this.logoContainer=(p=this.root)==null?void 0:p.querySelector(".logo"),this.compactMenuButton=(g=this.root)==null?void 0:g.querySelector(".compact-menu-button"),this.compactMenuButton.append(li("more_vert")),this.foldout=(y=this.root)==null?void 0:y.querySelector(".foldout"),(b=this.root)==null||b.appendChild(this.wrapper),this.wrapper.classList.add("wrapper");const o=EC.create();o.style.minHeight="1rem",this.logoContainer.append(o),this.logoContainer.addEventListener("click",()=>{globalThis.open("https://needle.tools","_blank")});try{window.requestAnimationFrame(()=>TM(_=>{if(_==!0&&Vs()&&!Vv){let v=this._userRequestedLogoVisible;v===void 0&&(v=!1),aa(this,Dd,qy).call(this,v)}}))}catch(_){console.error("[Needle Menu] License check failed.",_)}this.compactMenuButton.addEventListener("click",_=>{_.preventDefault(),this.root.classList.toggle("open")});let r=this._context;setTimeout(()=>r=this._context);let l=0;const c=(_,v)=>{var S,T,O;$h&&console.log("Set menu visible",v),r!=null&&r.isInAR&&r.arOverlayElement?_!=r.arOverlayElement&&r.arOverlayElement.appendChild(this):this.parentNode!=((S=this._domElement)==null?void 0:S.shadowRoot)&&((O=(T=this._domElement)==null?void 0:T.shadowRoot)==null||O.appendChild(this)),this.style.display=v?"flex":"none",this.style.visibility="visible",this.style.opacity="1"};let h=!1;new MutationObserver(_=>{var v;if(!h)try{h=!0,this.onChangeDetected(_);const S=this==null?void 0:this.parentNode;if((this.style.display!="flex"||this.style.visibility!="visible"||this.style.opacity!="1"||S!=((v=this._domElement)==null?void 0:v.shadowRoot))&&!Vs()){const T=l++;qi()&&this._userRequestedMenuVisible===!1?(T===0&&c(S,this._userRequestedMenuVisible),T===1&&console.warn("Needle Menu Warning: You need a PRO license to hide the Needle Engine menu ‚Üí The menu will be visible in your deployed website if you don't have a PRO license. See https://needle.tools/pricing for details.")):T===0?c(S,!0):setTimeout(()=>c(S,!0),5)}}finally{h=!1}}).observe(this.root,{childList:!0,subtree:!0,attributes:!0}),$h&&this.___insertDebugOptions()}static create(){return document.createElement(ya,{is:ya})}static getOrCreate(e,i){let n=e.querySelector(ya);return!n&&e.shadowRoot&&(n=e.shadowRoot.querySelector(ya)),n||(n=window.document.body.querySelector(ya)),n||(n=qb.create(),e.shadowRoot?e.shadowRoot.appendChild(n):e.appendChild(n)),n._domElement=e,n._context=i,n}connectedCallback(){window.addEventListener("resize",this.handleSizeChange),this.handleMenuVisible(),this._sizeChangeInterval=setInterval(()=>this.handleSizeChange(void 0,!0),5e3),setTimeout(()=>{var e,i;(e=this._domElement)==null||e.addEventListener("resize",this.handleSizeChange),(i=this._domElement)==null||i.addEventListener("click",_e(this,Id))},1)}disconnectedCallback(){var e,i;window.removeEventListener("resize",this.handleSizeChange),clearInterval(this._sizeChangeInterval),(e=this._domElement)==null||e.removeEventListener("resize",this.handleSizeChange),(i=this._context)==null||i.domElement.removeEventListener("click",_e(this,Id))}showNeedleLogo(e){this._userRequestedLogoVisible=e,!(!e&&(!Vs()||Vv)&&(console.warn("Needle Menu: You need a PRO license to hide the Needle Engine logo."),!qi()))&&aa(this,Dd,qy).call(this,e)}setPosition(e){if(e!=="top"&&e!=="bottom")return console.error("NeedleMenu.setPosition: invalid position",e);this.root.classList.remove("top","bottom"),this.root.classList.add(e)}setVisible(e){this._userRequestedMenuVisible=e,this.style.display=e?"flex":"none"}closeFoldout(){this.root.classList.remove("open")}append(...e){for(const i of e)if(typeof i=="string"){const n=document.createTextNode(i);this.options.appendChild(n)}else this.options.appendChild(i)}appendChild(e){var n;if(!(e instanceof Node)){const o=document.createElement("button");if(o.textContent=e.label,o.onclick=e.onClick,o.setAttribute("priority",((n=e.priority)==null?void 0:n.toString())??"0"),e.title&&(o.title=e.title),e.icon){const r=li(e.icon);e.iconSide==="right"?o.appendChild(r):o.prepend(r)}e.class&&o.classList.add(e.class),e=o}return this.options.appendChild(e)}prepend(...e){for(const i of e)if(typeof i=="string"){const n=document.createTextNode(i);this.options.prepend(n)}else this.options.prepend(i)}onChangeDetected(e){if(!this._isHandlingChange){this._isHandlingChange=!0;try{this.handleMenuVisible();for(const i of e)i.target==this.options&&this.onOptionsChildrenChanged(i)}finally{this._isHandlingChange=!1}}}onOptionsChildrenChanged(e){if(this.root.classList.toggle("has-options",this.hasAnyVisibleOptions),this.root.classList.toggle("has-no-options",!this.hasAnyVisibleOptions),this.handleSizeChange(void 0,!0),e.type==="childList"&&e.addedNodes.length>0){const i=Array.from(this.options.children);i.sort((o,r)=>{const l=parseInt(o.getAttribute("priority")||"0"),c=parseInt(r.getAttribute("priority")||"0");return l-c});let n=!1;for(let o=0;o<i.length;o++){const r=this.options.children[o],l=i[o];if(r!==l){n=!0;break}}if(n)for(const o of i)this.options.appendChild(o)}}handleMenuVisible(){$h&&console.log("Update VisibleState: Any Content?",this.hasAnyContent),this.hasAnyContent?this.root.style.display="":this.root.style.display="none",this.root.classList.toggle("has-options",this.hasAnyVisibleOptions),this.root.classList.toggle("has-no-options",!this.hasAnyVisibleOptions)}get hasAnyContent(){return!!(this.logoContainer.style.display!="none"||this.hasAnyVisibleOptions)}get hasAnyVisibleOptions(){for(let e=0;e<this.options.children.length;e++){const i=this.options.children[e];if(i.tagName==="SLOT"){const o=i.assignedNodes();for(const r of o)if(r instanceof HTMLElement&&r.style.display!="none")return!0}else if(i.style.display!="none")return!0}return!1}___insertDebugOptions(){window.addEventListener("keydown",n=>{n.key==="p"&&this.setPosition(this.root.classList.contains("top")?"bottom":"top")});const e=document.createElement("button");e.textContent="Hide Buttons",e.onclick=()=>{const n=new Array(this.options.children.length);for(let o=0;o<this.options.children.length;o++)n[o]=this.options.children[o];for(const o of n)this.options.removeChild(o);setTimeout(()=>{for(const o of n)this.options.appendChild(o)},1e3)},this.appendChild(e);const i=document.createElement("button");i.textContent="Toggle Logo",i.addEventListener("click",()=>{this.logoContainer.style.display=this.logoContainer.style.display==="none"?"":"none"}),this.appendChild(i)}};let Df=qb;Id=new WeakMap,Dd=new WeakSet,qy=function(e){this.logoContainer.style.display="",this.logoContainer.style.opacity="1",this.logoContainer.style.visibility="visible",e?(this.root.classList.remove("logo-hidden"),this.root.classList.add("logo-visible")):(this.root.classList.remove("logo-visible"),this.root.classList.add("logo-hidden"))};customElements.get(ya)||customElements.define(ya,Df);const yt=C("debugcontext"),CM=C("stats"),PM=C("debugactive"),RM=C("debugframerate"),OM=C("debugcoroutine"),OL={};class TL{constructor(){a(this,"name");a(this,"alias");a(this,"hash");a(this,"runInBackground");a(this,"domElement");a(this,"renderer");a(this,"camera");a(this,"scene")}}var oe;(function(s){s[s.Start=-1]="Start",s[s.EarlyUpdate=0]="EarlyUpdate",s[s.Update=1]="Update",s[s.LateUpdate=2]="LateUpdate",s[s.OnBeforeRender=3]="OnBeforeRender",s[s.OnAfterRender=4]="OnAfterRender",s[s.PrePhysicsStep=9]="PrePhysicsStep",s[s.PostPhysicsStep=10]="PostPhysicsStep",s[s.Undefined=-1]="Undefined"})(oe||(oe={}));function eb(s,t){if(!s)return;if(!s.isComponent){(U()||yt)&&console.error(`Registered script is not a Needle Engine component. 
The script will be ignored. Please make sure your component extends "Behaviour" imported from "@needle-tools/engine"
`,s);return}t||(t=ne.Current,yt&&console.warn("> Registering component without context"));const e=t==null?void 0:t.new_scripts;e.includes(s)||e.push(s)}const je=class{constructor(t){a(this,"name");a(this,"alias");a(this,"isManagedExternally",!1);a(this,"isPaused",!1);a(this,"runInBackground",!1);a(this,"targetFrameRate");a(this,"physicsSteps",1);a(this,"hash");a(this,"domElement");a(this,"_resolutionScaleFactor",1);a(this,"_boundingClientRectFrame",-1);a(this,"_boundingClientRect",null);a(this,"_domX");a(this,"_domY");a(this,"xr",null);a(this,"_xrFrame",null);a(this,"_currentFrameEvent",oe.Undefined);a(this,"scene");a(this,"renderer");a(this,"composer",null);a(this,"scripts",[]);a(this,"scripts_pausedChanged",[]);a(this,"scripts_earlyUpdate",[]);a(this,"scripts_update",[]);a(this,"scripts_lateUpdate",[]);a(this,"scripts_onBeforeRender",[]);a(this,"scripts_onAfterRender",[]);a(this,"scripts_WithCorroutines",[]);a(this,"scripts_immersive_vr",[]);a(this,"scripts_immersive_ar",[]);a(this,"coroutines",{});a(this,"post_setup_callbacks",[]);a(this,"pre_update_callbacks",[]);a(this,"pre_render_callbacks",[]);a(this,"post_render_callbacks",[]);a(this,"pre_update_oneshot_callbacks",[]);a(this,"new_scripts",[]);a(this,"new_script_start",[]);a(this,"new_scripts_pre_setup_callbacks",[]);a(this,"new_scripts_post_setup_callbacks",[]);a(this,"new_scripts_xr",[]);a(this,"mainCameraComponent");a(this,"_mainCamera",null);a(this,"_fallbackCamera",null);a(this,"application");a(this,"animations");a(this,"time");a(this,"input");a(this,"physics");a(this,"connection");a(this,"assets");a(this,"mainLight",null);a(this,"sceneLighting");a(this,"addressables");a(this,"lightmaps");a(this,"players");a(this,"lodsManager");a(this,"menu");a(this,"_sizeChanged",!1);a(this,"_isCreated",!1);a(this,"_isCreating",!1);a(this,"_isVisible",!1);a(this,"_stats",CM?new jR:null);a(this,"_intersectionObserver",null);a(this,"_disposeCallbacks",[]);a(this,"maxRenderResolution");a(this,"_originalCreationArgs");a(this,"onUnhandledRejection",t=>{this.onError(t.reason)});a(this,"_cameraStack",[]);a(this,"_onBeforeRenderListeners",new Map);a(this,"_onAfterRenderListeners",new Map);a(this,"_requireDepthTexture",!1);a(this,"_requireColorTexture",!1);a(this,"_renderTarget");a(this,"_isRendering",!1);a(this,"_createId",0);a(this,"_renderlooperrors",0);a(this,"_lastTimestamp",0);a(this,"_accumulatedTime",0);a(this,"_dispatchReadyAfterFrame",!1);a(this,"_contextRestoreTries",0);a(this,"_wasPaused",!1);this.name=(t==null?void 0:t.name)||"",this.alias=t==null?void 0:t.alias,this.domElement=(t==null?void 0:t.domElement)||document.body,this.hash=t==null?void 0:t.hash,t!=null&&t.renderer&&(this.renderer=t.renderer,this.isManagedExternally=!0),(t==null?void 0:t.runInBackground)!==void 0&&(this.runInBackground=t.runInBackground),t!=null&&t.scene?this.scene=t.scene:this.scene=new In,t!=null&&t.camera&&(this._mainCamera=t.camera),this.application=new Ws(this),this.time=new yM,this.input=new kT(this),this.physics=new Bh(this),this.connection=new Sk(this),this.assets=new zk,this.sceneLighting=new mM(this),this.addressables=new YE(this),this.lightmaps=new sM(this),this.players=new lM(this),this.menu=new SM(this),this.lodsManager=new oM(this),this.animations=new tM(this);const e=()=>this._sizeChanged=!0;window.addEventListener("resize",e),this._disposeCallbacks.push(()=>window.removeEventListener("resize",e));const i=new ResizeObserver(n=>this._sizeChanged=!0);i.observe(this.domElement),this._disposeCallbacks.push(()=>i.disconnect()),this._intersectionObserver=new IntersectionObserver(n=>{this._isVisible=n[0].isIntersecting}),this._disposeCallbacks.push(()=>{var n;return(n=this._intersectionObserver)==null?void 0:n.disconnect()}),be.register(this)}static get DefaultTargetFrameRate(){return je._defaultTargetFramerate.value}static set DefaultTargetFrameRate(t){je._defaultTargetFramerate.value=t}static get DefaultWebGLRendererParameters(){return je._defaultWebglRendererParameters}get version(){return $s}static get Current(){return be.Current}static set Current(t){be.Current=t}static get All(){return be.All}appendHTMLElement(t){return this.domElement.shadowRoot?this.domElement.shadowRoot.appendChild(t):this.domElement.appendChild(t)}get resolutionScaleFactor(){return this._resolutionScaleFactor}set resolutionScaleFactor(t){if(t!==this._resolutionScaleFactor&&typeof t=="number"){if(t<=0){console.error("Invalid resolution scale factor",t);return}this._resolutionScaleFactor=t,this.updateSize()}}calculateBoundingClientRect(){if(this.xr){this._domX=0,this._domY=0;return}this._boundingClientRectFrame!==this.time.frame&&(this._boundingClientRectFrame=this.time.frame,this._boundingClientRect=this.domElement.getBoundingClientRect(),this._domX=this._boundingClientRect.x,this._domY=this._boundingClientRect.y)}get domWidth(){return this.isInAR?window.innerWidth:this.domElement.clientWidth}get domHeight(){return this.isInAR?window.innerHeight:this.domElement.clientHeight}get domX(){return this.calculateBoundingClientRect(),this._domX}get domY(){return this.calculateBoundingClientRect(),this._domY}get isInXR(){var t,e;return((e=(t=this.renderer)==null?void 0:t.xr)==null?void 0:e.isPresenting)||!1}get xrSessionMode(){var t;return(t=this.xr)==null?void 0:t.mode}get isInVR(){return this.xrSessionMode==="immersive-vr"}get isInAR(){return this.xrSessionMode==="immersive-ar"}get isInPassThrough(){return this.xr?this.xr.isPassThrough:!1}get xrSession(){var t,e;return(e=(t=this.renderer)==null?void 0:t.xr)==null?void 0:e.getSession()}get xrFrame(){return this._xrFrame}get xrCamera(){var t,e;return this.renderer.xr.isPresenting?(e=(t=this.renderer)==null?void 0:t.xr)==null?void 0:e.getCamera():void 0}get arOverlayElement(){const t=this.domElement;return typeof t.getAROverlayContainer=="function"?t.getAROverlayContainer():this.domElement}get currentFrameEvent(){return this._currentFrameEvent}get mainCamera(){if(this._mainCamera)return this._mainCamera;if(this.mainCameraComponent){const t=this.mainCameraComponent;return t.threeCamera||t.buildCamera(),t.threeCamera}return this._fallbackCamera||(this._fallbackCamera=new Re(75,this.domWidth/this.domHeight,.1,1e3)),this._fallbackCamera}set mainCamera(t){this._mainCamera=t}get rendererData(){return this.sceneLighting}get isCreated(){return this._isCreated}createNewRenderer(t){var e,i,n;if((e=this.renderer)==null||e.dispose(),t={...je.DefaultWebGLRendererParameters,...t},!t.canvas){const o=(n=(i=this.domElement)==null?void 0:i.shadowRoot)==null?void 0:n.querySelector("canvas");o&&(t.canvas=o,yt&&console.log("Using canvas from shadow root",o))}yt&&console.log("Using Renderer Parameters:",t,this.domElement),this.renderer=new Qa(t),this.renderer.debug.checkShaderErrors=U()||C("checkshadererrors")===!0,this.renderer.toneMappingExposure=1,this.renderer.toneMapping=gc,this.renderer.setClearColor(new ue("lightgrey"),0),this.renderer.shadowMap.enabled=!0,this.renderer.shadowMap.type=kP,this.renderer.setSize(this.domWidth,this.domHeight),this.renderer.outputColorSpace=rs,this.renderer.nodes={library:new EP,modelViewMatrix:null,modelNormalViewMatrix:null},this.lodsManager.setRenderer(this.renderer),this.input.bindEvents()}internalOnUpdateVisible(){var t,e;(t=this._intersectionObserver)==null||t.disconnect(),(e=this._intersectionObserver)==null||e.observe(this.domElement)}requestSizeUpdate(){this._sizeChanged=!0}updateSize(t=!1){var e,i,n;if(t||!this.isManagedExternally&&((e=this.renderer.xr)==null?void 0:e.isPresenting)===!1){this._sizeChanged=!1;const o=this.resolutionScaleFactor;let r=this.domWidth*o,l=this.domHeight*o;this.maxRenderResolution&&(this.maxRenderResolution.x=Math.max(1,this.maxRenderResolution.x),r=Math.min(this.maxRenderResolution.x,r),this.maxRenderResolution.y=Math.max(1,this.maxRenderResolution.y),l=Math.min(this.maxRenderResolution.y,l));const c=this.mainCamera;this.updateAspect(c),this.renderer.setSize(r,l,!0),this.renderer.setPixelRatio(window.devicePixelRatio),this.renderer.domElement.style.width="100%",this.renderer.domElement.style.height="100%",this.composer&&((i=this.composer.setSize)==null||i.call(this.composer,r,l),"setPixelRatio"in this.composer&&typeof this.composer.setPixelRatio=="function"&&((n=this.composer.setPixelRatio)==null||n.call(this.composer,window.devicePixelRatio)))}}updateAspect(t,e,i){if(!t)return;e===void 0&&(e=this.domWidth),i===void 0&&(i=this.domHeight);const n=e/i;if(t.isPerspectiveCamera){const o=t,r=o.aspect;o.aspect=n,r!==o.aspect&&t.updateProjectionMatrix()}else if(t.isOrthographicCamera){const o=t,r=o.top-o.bottom,c=r*n/2,h=r/2;(o.left!=-c||o.top!=h)&&(o.left=-c,o.right=c,o.top=h,o.bottom=-h,t.updateProjectionMatrix())}}recreate(){this.clear(),this.create(this._originalCreationArgs)}async onCreate(t){return this.create(t)}async create(t){try{this._isCreating=!0,t!==this._originalCreationArgs&&(this._originalCreationArgs=kp(t)),window.addEventListener("unhandledrejection",this.onUnhandledRejection);const e=await this.internalOnCreate(t);return this._isCreated=e,e}finally{window.removeEventListener("unhandledrejection",this.onUnhandledRejection),this._isCreating=!1}}onError(t){this.domElement.dispatchEvent(new CustomEvent("error",{detail:t}))}clear(){var t,e,i,n;be.dispatchCallback(me.ContextClearing,this),ps(this,me.ContextClearing),Ln(this.scene,!0,!0),this.scene=new In,(t=this.addressables)==null||t.dispose(),(e=this.lightmaps)==null||e.clear(),(n=(i=this.physics)==null?void 0:i.engine)==null||n.clearCaches(),this.lodsManager.disable(),this.isManagedExternally||this.renderer&&(this.renderer.renderLists.dispose(),this.renderer.state.reset(),this.renderer.resetState()),be.dispatchCallback(me.ContextCleared,this)}dispose(){this.internalOnDestroy()}onDestroy(){this.internalOnDestroy()}internalOnDestroy(){var t,e;je.Current=this,be.dispatchCallback(me.ContextDestroying,this),ps(this,me.ContextDestroying),this.clear(),(t=this.renderer)==null||t.setAnimationLoop(null),this.renderer&&(this.renderer.setClearAlpha(0),this.renderer.clear(),this.isManagedExternally||(yt&&console.log("Disposing renderer"),this.renderer.dispose())),this.scene=null,this.renderer=null,this.input.dispose(),this.menu.onDestroy(),this.animations.onDestroy();for(const i of this._disposeCallbacks)try{i()}catch(n){console.error("Error in on dispose callback:",n,i)}(e=this.domElement)!=null&&e.parentElement&&this.domElement.parentElement.removeChild(this.domElement),this._isCreated=!1,be.dispatchCallback(me.ContextDestroyed,this),ps(this,me.ContextDestroyed),be.unregister(this),je.Current===this&&(je.Current=null)}registerCoroutineUpdate(t,e,i){return typeof(e==null?void 0:e.next)!="function"?(console.error("Registered invalid coroutine function from "+t.name+`
Coroutine functions must be generators: "*myCoroutine() {...}"
Start a coroutine from a component by calling "this.startCoroutine(myCoroutine())"`),e):(this.coroutines[i]||(this.coroutines[i]=[]),this.coroutines[i].push({comp:t,main:e}),e)}unregisterCoroutineUpdate(t,e){if(!this.coroutines[e])return;const i=this.coroutines[e].findIndex(n=>n.main===t);i>=0&&this.coroutines[e].splice(i,1)}stopAllCoroutinesFrom(t){for(const e in this.coroutines){const i=this.coroutines[e];for(let n=i.length-1;n>=0;n--)i[n].comp===t&&i.splice(n,1)}}setCurrentCamera(t){var n;if(!t)return;if(t.threeCamera||t.buildCamera(),!t.threeCamera){console.warn("Camera component is missing camera",t);return}const e=this._cameraStack.indexOf(t);e>=0&&this._cameraStack.splice(e,1),this._cameraStack.push(t),this.mainCameraComponent=t;const i=t.threeCamera;i.isPerspectiveCamera&&this.updateAspect(i),(n=this.mainCameraComponent)==null||n.applyClearFlagsIfIsActiveCamera()}removeCamera(t){if(!t)return;const e=this._cameraStack.indexOf(t);if(e>=0&&this._cameraStack.splice(e,1),this.mainCameraComponent===t&&(this.mainCameraComponent=void 0,this._cameraStack.length>0)){const i=this._cameraStack[this._cameraStack.length-1];this.setCurrentCamera(i)}}addBeforeRenderListener(t,e){this._onBeforeRenderListeners.has(t.uuid)||(this._onBeforeRenderListeners.set(t.uuid,[]),t.onBeforeRender=this._createRenderCallbackWrapper(t,this._onBeforeRenderListeners)),this._onBeforeRenderListeners.get(t.uuid).push(e)}removeBeforeRenderListener(t,e){if(this._onBeforeRenderListeners.has(t.uuid)){const i=this._onBeforeRenderListeners.get(t.uuid),n=i.indexOf(e);n>=0&&i.splice(n,1)}}addAfterRenderListener(t,e){var i;this._onAfterRenderListeners.has(t.uuid)||(this._onAfterRenderListeners.set(t.uuid,[]),t.onAfterRender=this._createRenderCallbackWrapper(t,this._onAfterRenderListeners)),(i=this._onAfterRenderListeners.get(t.uuid))==null||i.push(e)}removeAfterRenderListener(t,e){if(this._onAfterRenderListeners.has(t.uuid)){const i=this._onAfterRenderListeners.get(t.uuid),n=i.indexOf(e);n>=0&&i.splice(n,1)}}_createRenderCallbackWrapper(t,e){return(i,n,o,r,l,c)=>{const h=e.get(t.uuid);if(h)for(let d=0;d<h.length;d++){const u=h[d];u(i,n,o,r,l,c)}}}get isRendering(){return this._isRendering}setRequireDepth(t){this._requireDepthTexture=t}setRequireColor(t){this._requireColorTexture=t}get depthTexture(){var t;return((t=this._renderTarget)==null?void 0:t.depthTexture)||null}get opaqueColorTexture(){var t;return((t=this._renderTarget)==null?void 0:t.texture)||null}get isVisibleToUser(){if(this.isInXR)return!0;if(!this._isVisible)return!1;const t=getComputedStyle(this.domElement);return t.visibility!=="hidden"&&t.display!=="none"&&t.opacity!=="0"}async internalOnCreate(t){var l,c,h,d,u,f,p,g;const e=++this._createId;yt&&console.log("Creating context",this.name,t);const i=globalThis["needle:dependencies:ready"];i instanceof Promise&&(yt&&console.log("Waiting for dependencies to be ready"),await i.catch(y=>{if(yt||U()){if(Dp("Needle Engine dependencies failed to load. Please check the console for more details"),y instanceof ReferenceError){let b="YourComponentName";const _=y.message.indexOf("'");if(_>0){const v=y.message.indexOf("'",_+1);if(v>0){const S=y.message.substring(_+1,v);S.length>3&&(b=S)}}console.error(`Needle Engine dependencies failed to load:

# Make sure you don't have circular imports in your scripts!

Possible solutions: 
‚Üí Replace @serializable(${b}) in your script with @serializable(Behaviour)
‚Üí If you only need type information try importing the type only, e.g: import { type ${b} }

---`,y);return}console.error("Needle Engine dependencies failed to load",y)}}).then(()=>{yt&&console.log("Needle Engine dependencies are ready")})),this.clear(),this.isManagedExternally===!1&&(this.createNewRenderer(),(l=this.renderer)==null||l.setAnimationLoop(null)),await Xs(1),je.Current=this,await be.dispatchCallback(me.ContextCreationStart,this);let n=!0,o;try{je.Current=this,t?o=await this.internalLoadInitialContent(e,t):o=[]}catch(y){console.error(y),n=!1}if(!n)return this.onError("Failed to load initial content"),!1;if(e!==this._createId||(c=t==null?void 0:t.abortSignal)!=null&&c.aborted)return!1;if(this.internalOnUpdateVisible(),!this.renderer)return yt&&console.warn("Context has no renderer (perhaps it was disconnected?",this.domElement.isConnected),!1;!this.isManagedExternally&&!this.domElement.shadowRoot&&this.domElement.prepend(this.renderer.domElement),je.Current=this,je.Current=this;for(let y=0;y<this.new_scripts.length;y++){const b=this.new_scripts[y];if(b.gameObject!==void 0&&b.gameObject!==null){b.gameObject.userData===void 0&&(b.gameObject.userData={}),b.gameObject.userData.components===void 0&&(b.gameObject.userData.components=[]);const _=b.gameObject.userData.components;_.includes(b)||_.push(b)}}if(this.post_setup_callbacks)for(let y=0;y<this.post_setup_callbacks.length;y++)je.Current=this,await this.post_setup_callbacks[y](this);if(!this._mainCamera){je.Current=this;let y=null;Cc(this.scene,b=>{const _=b;if(_!=null&&_.isCamera){if(zh(_.gameObject),!_.activeAndEnabled)return;if(_.tag==="MainCamera")return y=_,!0;y=_}}),y?this.setCurrentCamera(y):!be.dispatchCallback(me.MissingCamera,this,{files:o})&&!this.mainCamera&&!this.isManagedExternally&&console.warn("Missing camera in main scene",this)}this.input.bindEvents(),je.Current=this,Rf(this),this.physics.engine&&((h=this.physics.engine)==null||h.step(0),(d=this.physics.engine)==null||d.postStep()),!this.isManagedExternally&&this.composer&&this.mainCamera,this._sizeChanged=!0,this._stats&&(this._stats.showPanel(0),this._stats.dom.style.position="absolute",(u=this.domElement.shadowRoot)==null||u.appendChild(this._stats.dom)),yt&&py(this.scene,!0),this.targetFrameRate===void 0?(yt&&console.warn("No target framerate set, using default",je.DefaultTargetFrameRate),this.targetFrameRate=je._defaultTargetFramerate):yt&&console.log("Target framerate set to",this.targetFrameRate),this._dispatchReadyAfterFrame=!0;const r=be.dispatchCallback(me.ContextCreated,this,{files:o});return r&&("internalSetLoadingMessage"in this.domElement&&typeof this.domElement.internalSetLoadingMessage=="function"&&((f=this.domElement)==null||f.internalSetLoadingMessage("finish loading")),await r),(p=t==null?void 0:t.abortSignal)!=null&&p.aborted?!1:(ps(this,me.ContextCreated),yt&&console.log("Context Created...",this.renderer,this.renderer.domElement),this._isCreating=!1,!this.isManagedExternally&&!((g=t==null?void 0:t.abortSignal)!=null&&g.aborted)&&this.restartRenderLoop(),!0)}async internalLoadInitialContent(t,e){var c,h,d,u;const i=new Array;if(e.files.length===0)return i;const n=[...e.files],o={name:"",progress:null,index:0,count:n.length},r=qs(),l=0;for(let f=0;f<n.length;f++){if((c=e.abortSignal)!=null&&c.aborted){yt&&console.log("Aborting loading because of abort signal");break}if(t!==this._createId){yt&&console.log("Aborting loading because create id changed",t,this._createId);break}const p=n[f];(h=e==null?void 0:e.onLoadingStart)==null||h.call(this,f,p),yt&&console.log("Context Load "+p);const g=await r.loadSync(this,p,p,l,y=>{var b,_;(b=e.abortSignal)!=null&&b.aborted||(o.name=p,o.progress=y,o.index=f,o.count=n.length,(_=e.onLoadingProgress)==null||_.call(this,o))});(d=e==null?void 0:e.onLoadingFinished)==null||d.call(this,f,p,g??null),g?i.push({src:p,file:g}):console.warn("Could not load file: "+p)}if(t!==this._createId||(u=e.abortSignal)!=null&&u.aborted){yt&&console.log("Aborting loading because create id changed or abort signal was set",t,this._createId);for(const f of i)if(f&&f.file)for(const p of f.file.scenes)Ln(p,!0,!0)}else{let f=!1;for(const p of i)p&&p.file&&(p.file.scene?(f=!0,this.scene.add(p.file.scene)):console.warn("No scene found in loaded file"));if(!f){for(const p of i)if(p&&p.file&&"parser"in p.file){let g=0;if(!Array.isArray(p.file.parser.json.materials))continue;for(let y=0;y<p.file.parser.json.materials.length;y++){const b=await p.file.parser.getDependency("material",y),_=new F;_.position.x=y*1.1,_.position.y=g,this.scene.add(_),Ka.createPrimitive("ShaderBall",{parent:_,material:b})}g+=1}}}return i}restartRenderLoop(){return this.renderer?this._isCreating?(console.warn("Can not start render loop while creating context"),!1):(this.renderer.setAnimationLoop((t,e)=>{this.isManagedExternally||this.update(t,e)}),!0):(console.error("Can not start render loop without renderer"),!1)}update(t,e){if(e===void 0&&(e=null),U()||yt||Hk())try{performance.mark("update.start"),this.internalStep(t,e),this._renderlooperrors=0,performance.mark("update.end"),performance.measure("NE Frame","update.start","update.end")}catch(i){this._renderlooperrors+=1,(U()||yt)&&(i instanceof Error||i instanceof TypeError)&&tt("Caught unhandled exception during render-loop - see console for details.",_t.Error),console.error("Frame #"+this.time.frame+`
`,i),this._renderlooperrors>=3&&(console.warn("Stopping render loop due to error"),this.renderer.setAnimationLoop(null)),this.domElement.dispatchEvent(new CustomEvent("error",{detail:i}))}else this.internalStep(t,e)}updatePhysics(t){this.internalUpdatePhysics(t)}internalStep(t,e){this.internalOnBeforeRender(t,e)!==!1&&(this.internalOnRender(),this.internalOnAfterRender())}internalOnBeforeRender(t,e){var n;this.renderer.info.autoReset=!0;const i=e!==null&&this._xrFrame===null;if(this._xrFrame=e,i&&this.domElement.dispatchEvent(new CustomEvent("xr-session-started",{detail:{context:this,session:this.xrSession,frame:e}})),this._currentFrameEvent=oe.Undefined,this.isManagedExternally===!1&&this.isInXR===!1&&this.targetFrameRate!==void 0){this._lastTimestamp===0&&(this._lastTimestamp=t),this._accumulatedTime+=(t-this._lastTimestamp)/1e3,this._lastTimestamp=t;let o=this.targetFrameRate;if(typeof o=="object"&&(o=o.value),this._accumulatedTime<1/(o+1))return!1;this._accumulatedTime=0}if((n=this._stats)==null||n.begin(),je.Current=this,this.onHandlePaused())return!1;for(je.Current=this,this.time.update(),RM&&console.log("FPS",this.time.smoothedFps.toFixed(0)),Rf(this),tf(this.scene),oC(this),ps(this,oe.Start);this._cameraStack.length>0&&(!this.mainCameraComponent||this.mainCameraComponent.destroyed);){this._cameraStack.splice(this._cameraStack.length-1,1);const o=this._cameraStack[this._cameraStack.length-1];this.setCurrentCamera(o)}if(this.pre_update_oneshot_callbacks){for(const o in this.pre_update_oneshot_callbacks)this.pre_update_oneshot_callbacks[o]();this.pre_update_oneshot_callbacks.length=0}if(this.pre_update_callbacks)for(const o in this.pre_update_callbacks)this.pre_update_callbacks[o]();this._currentFrameEvent=oe.EarlyUpdate;for(let o=0;o<this.scripts_earlyUpdate.length;o++){const r=this.scripts_earlyUpdate[o];r.activeAndEnabled&&r.earlyUpdate!==void 0&&(je.Current=this,r.earlyUpdate())}if(this.executeCoroutines(oe.EarlyUpdate),ps(this,oe.EarlyUpdate),this.onHandlePaused())return!1;this._currentFrameEvent=oe.Update;for(let o=0;o<this.scripts_update.length;o++){const r=this.scripts_update[o];r.activeAndEnabled&&r.update!==void 0&&(je.Current=this,r.update())}if(this.executeCoroutines(oe.Update),ps(this,oe.Update),this.onHandlePaused())return!1;this._currentFrameEvent=oe.LateUpdate;for(let o=0;o<this.scripts_lateUpdate.length;o++){const r=this.scripts_lateUpdate[o];r.activeAndEnabled&&r.lateUpdate!==void 0&&(je.Current=this,r.lateUpdate())}if(this.executeCoroutines(oe.LateUpdate),ps(this,oe.LateUpdate),this.onHandlePaused()||(this.physicsSteps===void 0&&(this.physicsSteps=1),this.physics.engine&&this.physicsSteps>0&&this.internalUpdatePhysics(this.physicsSteps),this.onHandlePaused()))return!1;if(this.isVisibleToUser||this.runInBackground){this._currentFrameEvent=oe.OnBeforeRender;for(let o=0;o<this.scripts_onBeforeRender.length;o++){const r=this.scripts_onBeforeRender[o];r.activeAndEnabled&&r.onBeforeRender!==void 0&&(je.Current=this,r.onBeforeRender(e))}if(this.executeCoroutines(oe.OnBeforeRender),ps(this,oe.OnBeforeRender),this._sizeChanged&&this.updateSize(),this.pre_render_callbacks)for(const o in this.pre_render_callbacks)this.pre_render_callbacks[o](e)}return!0}internalUpdatePhysics(t){if(!this.physics.engine)return!1;const e=t,i=this.time.deltaTime/e;for(let n=0;n<e;n++)this._currentFrameEvent=oe.PrePhysicsStep,this.executeCoroutines(oe.PrePhysicsStep),this.physics.engine.step(i),this._currentFrameEvent=oe.PostPhysicsStep,this.executeCoroutines(oe.PostPhysicsStep);return this.physics.engine.postStep(),!0}internalOnRender(){this.isManagedExternally||(Qk(this),this._currentFrameEvent=oe.Undefined,BR.update(),this.renderNow(),this._currentFrameEvent=oe.OnAfterRender)}internalOnAfterRender(){if(this.isVisibleToUser||this.runInBackground){for(let t=0;t<this.scripts_onAfterRender.length;t++){const e=this.scripts_onAfterRender[t];e.activeAndEnabled&&e.onAfterRender!==void 0&&(je.Current=this,e.onAfterRender())}if(this.executeCoroutines(oe.OnAfterRender),ps(this,oe.OnAfterRender),this.post_render_callbacks)for(const t in this.post_render_callbacks)this.post_render_callbacks[t]()}this._currentFrameEvent=-1,this.connection.sendBufferedMessagesNow(),this._stats&&(this._stats.end(),this.time.frameCount%150===0&&console.log(this.renderer.info.render.calls+" DrawCalls",`
Render:`,{...this.renderer.info.render},`
Memory:`,{...this.renderer.info.memory},`
Target Framerate: `+this.targetFrameRate)),this._dispatchReadyAfterFrame&&(this._dispatchReadyAfterFrame=!1,this.domElement.dispatchEvent(new CustomEvent("ready")),be.dispatchCallback(me.ContextFirstFrameRendered,this))}renderNow(t){var e;return!t&&(t=this.mainCamera,!t)?!1:(this.handleRendererContextLost(),this._isRendering=!0,this.renderRequiredTextures(),this.renderer.toneMapping!==gc&&TC(),this.composer&&!this.isInXR?(t&&"setMainCamera"in this.composer&&((e=this.composer.passes[0])==null?void 0:e.mainCamera)!=t&&this.composer.setMainCamera(t),this.composer.render(this.time.deltaTime)):t&&(this.isInXR&&J.isMacOS()&&this.renderer.clearDepth(),this.renderer.render(this.scene,t)),this._isRendering=!1,!0)}handleRendererContextLost(){this.time.frame%10&&this.renderer.getContext().isContextLost()&&this._contextRestoreTries++<100&&(console.warn("Attempting to recover WebGL context..."),this.renderer.forceContextRestore())}onHandlePaused(){const t=this.evaluatePaused();if(this._wasPaused!==t){PM&&console.log("Paused?",t,"context:"+this.alias);for(let e=0;e<this.scripts_pausedChanged.length;e++){const i=this.scripts_pausedChanged[e];i.activeAndEnabled&&i.onPausedChanged!==void 0&&(je.Current=this,i.onPausedChanged(t,this._wasPaused))}}return this._wasPaused=t,t}evaluatePaused(){return this.isInXR?!1:this.isPaused?!0:this.runInBackground?!1:!this.isVisibleToUser}renderRequiredTextures(){if(!this.mainCamera||!this._requireDepthTexture&&!this._requireColorTexture)return;if(!this._renderTarget){if(this._renderTarget=new No(this.domWidth,this.domHeight),this._requireDepthTexture){const i=new MP(this.domWidth,this.domHeight);this._renderTarget.depthTexture=i}this._requireColorTexture&&(this._renderTarget.texture=new Je,this._renderTarget.texture.generateMipmaps=!1,this._renderTarget.texture.minFilter=gf,this._renderTarget.texture.magFilter=gf,this._renderTarget.texture.format=Pp)}const t=this._renderTarget;t.texture&&(t.texture.colorSpace=this.renderer.outputColorSpace);const e=this.renderer.getRenderTarget();this.renderer.setRenderTarget(t),this.renderer.render(this.scene,this.mainCamera),this.renderer.setRenderTarget(e)}executeCoroutines(t){var i;if(this.coroutines[t]){const n=this.coroutines[t];for(let o=0;o<n.length;o++)try{const r=n[o];if(!r.comp||r.comp.destroyed||!r.main||r.comp.enabled===!1){OM&&console.log("Removing coroutine",r.comp,r.comp.enabled),n.splice(o,1),--o;continue}const c=r.chained;if(c&&c.length>0){const f=c[c.length-1].next();if(f.done&&c.pop(),e(f)&&(r.chained||(r.chained=[]),r.chained.push(f.value)),!f.done)continue}const h=r.main.next();if(h.done===!0){n.splice(o,1),--o;continue}const d=h.value;if(e(d)){if(d.next().done)continue;r.chained||(r.chained=[]),r.chained.push(d)}else if(d instanceof Promise){const u=d;r.chained||(r.chained=[]);const f=iM(u);(i=r.chained)==null||i.push(f);continue}}catch(r){console.error(r)}}function e(n){return!!(n&&n.next&&n.return)}}};let ne=je;a(ne,"_defaultTargetFramerate",{value:90,toString(){return this.value}}),a(ne,"_defaultWebglRendererParameters",{antialias:!0,alpha:!1,powerPreference:J.isiOS()||J.isMacOS()?"default":"high-performance",stencil:!0});const Pr=C("debuglicense");let $d="pro";Pr&&console.log("License Type: "+$d);function La(){switch($d){case"pro":case"enterprise":return!0}return!1}function MC(){switch($d){case"indie":return!0}return!1}function Vs(){return La()||MC()}function TM(s){if(La()||MC())return s(!0)}be.registerCallback(me.ContextRegistered,s=>{MM(s.context),IM(),EM(s.context)});let Lr,Cu="";async function kM(){if(Lr)return Lr;Pr&&console.log('Runtime license check is skipped because license is already applied as "'+$d+'"')}Lr=kM();async function EM(s){function t(){const i=document.createElement("div");i.className="needle-forbidden",i.style.cssText=`
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: all;
        zIndex: 2147483647;
        line-height: 1.5;
        backdrop-filter: blur(15px);
        -webkit-backdrop-filter: blur(15px);
        `;const n=i.style.cssText,o=document.createElement("div");i.appendChild(o),o.style.cssText=`
        position: absolute;
        left: 0;
        right: 0;
        top:0;
        bottom: 0;
        padding: 10%;
        color: white;
        font-size: 20px;
        font-family: sans-serif;
        text-align: center;
        pointer-events: all;
        display: flex;
        justify-content: center;
        align-items: center;
        background-color: rgba(0,0,0,.3);
        text-shadow: 0 0 2px black;
        `;const r=o.style.cssText,l=(Cu==null?void 0:Cu.length)>1?Cu:"This web application has been paused.<br/>You might be in violation of the Needle Engine terms of use.<br/>Please contact the Needle support if you think this is a mistake.";return o.innerHTML=l,setInterval(()=>{o.innerHTML!==l&&(o.innerHTML=l),o.parentNode!==i&&i.appendChild(o),i.style.cssText!==n&&(i.style.cssText=n),o.style.cssText!==r&&(o.style.cssText=r)},500),i}t().style.cssText,setInterval(()=>{},500)}async function MM(s){try{if(Vs()!==!0)return gg(s)}catch(t){return Pr&&console.log("License check failed",t),gg(s)}Pr&&gg(s)}async function gg(s){s.domElement.addEventListener("ready",()=>!0),await(Lr==null?void 0:Lr.catch(()=>{})),!Vs()&&AM()}let Hv=0;async function AM(s){var r;const t=Date.now();if(t-Hv<2e3)return;Hv=t;const i=`
        position: relative;
        display: block;
        font-size: 18px;
        background-size: 20px;
        background-position: 10px 5px;
        background-repeat:no-repeat;
        background-image:url('data:image/webp;base64,UklGRrABAABXRUJQVlA4WAoAAAAQAAAAHwAAHwAAQUxQSKEAAAARN6CmbSM4WR7vdARON11EBDq3fLiNbVtVzpMCPlKAEzsx0Y/x+Ovuv4dn0EFE/ydAvz6YggXzgh5sVgXM/zOC/4sii7qgGvB5N7hmuQYwkvazWAu1JPW41FXSHq6pnaQWvqYH18Fc0j1hO/BFTtIeSBlJi5w6qIIO7IOrwhFsB2Yxukif0FTRLpXswHR8MxbslKe9VZsn/Ub5C7YFOpqSTABWUDgg6AAAAFAGAJ0BKiAAIAA+7VyoTqmkpCI3+qgBMB2JbACdMt69DwMIQBLhkTO6XwY00UEDK6cNIDnuNibPf0EgAP7Y1myuiQHLDsF/0h5unrGh6WAbv7aegg2ZMd3uRKfT/3SJztcaujYfTvMXspfCTmYcoO6a+vhC3ss4M8uM58t4siiu59I4aOl59e9Sr6xoxYlHf2v+NnBNpJYeJf8jABQAId/PXuBkLEFkiCucgSGEcfhvajql/j3reCGl0M5/9gQWy7ayNPs+wlvIxFnNfSlfuND4CZOCyxOHhRqOmHN4ULHo3tCSrUNvgAA=');
        background-max-size: 40px;
        margin-bottom: 5px;
        margin-top: .3em;
        margin-bottom: .5em;
        padding: .2em;
        padding-left: 25px;
        border-radius: .5em;
        border: 2px solid rgba(160,160,160,.3);
    `,o=`Needle Engine ‚Äî No license active, commercial use is not allowed. Visit https://needle.tools/pricing for more information and licensing options! v${$s}`;(r=ne.Current)!=null&&r.xr?console.log(o):console.log("%c "+o,i)}async function IM(){var s;if(!window.crossOriginIsolated)try{const t="https://needle-engine-analytics-v2-r26roub2hq-lz.a.run.app";if(t){Pr&&console.log("Analytics backend url",t);const e=window.location.href.split("?")[0];let i="api/v2/new/request";t.endsWith("/")||(i="/"+i);const n=$d,o=`${t}${i}`;Pr&&console.log("Sending non-commercial usage message to analytics backend",o);const r={license:n,url:e,hostname:window.location.hostname,pathname:window.location.pathname,version:$s,generator:Yw,build_time:Kw,public_key:Qu},l=(s=navigator.sendBeacon)==null?void 0:s.call(navigator,o,JSON.stringify(r));Pr&&console.log("Send beacon result",l)}}catch(t){Pr&&console.log("Failed to send non-commercial usage message to analytics backend",t)}}const _a=C("debugloading"),uh=C("debugloadingrendering"),Gv=C("debuglicense");class kL{constructor(){a(this,"className");a(this,"additionalClasses")}}let fh=0,qv;function AC(s){_a&&console.log(s.progress.loaded.toFixed(0)+"/"+s.progress.total.toFixed(0),s);const t=s.count,e=s.progress.total;e===0||e===void 0?(qv!==s.name&&(fh=0),qv=s.name,fh+=(1-fh)*.001,_a&&Me("Loading "+s.name+" did not report total size")):fh=s.progress.loaded/e;const i=s.index/t+fh/t;return W.clamp01(i)}const dp=class{constructor(t,e){a(this,"loadingProgress",0);a(this,"_element");a(this,"_progress",0);a(this,"_allowCustomLoadingElement",!0);a(this,"_loadingElement");a(this,"_loadingTextContainer",null);a(this,"_loadingBar",null);a(this,"_messageContainer",null);a(this,"_loadingElementOptions");a(this,"_progressLoop");this._element=t,this._loadingElementOptions=e}async onLoadingBegin(t){const e=this._element.shadowRoot||this._element;if(_a&&console.warn("Begin Loading"),!this._loadingElement){for(let i=0;i<e.children.length;i++){const n=e.children[i];if(n.classList.contains(dp.LoadingContainerClassName)){if(!this._allowCustomLoadingElement){_a&&console.warn("Remove custom loading container"),e.removeChild(n);continue}this._loadingElement=this.createLoadingElement(n)}}this._loadingElement||(this._loadingElement=this.createLoadingElement())}this._progress=0,this.loadingProgress=0,this._loadingElement.style.display="flex",e.appendChild(this._loadingElement),this.smoothProgressLoop(),this.setMessage(t??"")}onLoadingUpdate(t,e){var n;if(!((n=this._loadingElement)!=null&&n.parentNode))return;let i=0;typeof t=="number"?i=t:("index"in t&&(i=AC(t)),!e&&"name"in t&&this.setMessage("loading "+t.name)),this.loadingProgress=i,e&&this.setMessage(e),this.updateDisplay()}onLoadingFinished(){_a&&console.warn("Finished Loading"),uh||(this.loadingProgress=1,this.onDoneLoading())}setMessage(t){this._messageContainer&&(this._messageContainer.innerText=t)}smoothProgressLoop(){if(this._progressLoop)return;let t=1/12;uh&&(t=1/500,typeof uh=="number"&&(t*=uh)),this._progressLoop=setInterval(()=>{this.loadingProgress>=.95&&!uh&&(t=.9),this._progress=W.lerp(this._progress,this.loadingProgress,t*this.loadingProgress),this.updateDisplay()},t)}onDoneLoading(){this._loadingElement&&(_a&&console.log("Hiding loading element"),this._loadingElement.style.display="none",this._loadingElement.remove()),this._progressLoop&&clearInterval(this._progressLoop),this._progressLoop=null}updateDisplay(){const t=this._progress,e=(t*100).toFixed(0)+"%";this._loadingBar&&(this._loadingBar.style.width=t*100+"%"),this._loadingTextContainer&&(this._loadingTextContainer.textContent=e)}createLoadingElement(t){var p,g;_a&&!t&&console.log("Creating loading element"),this._loadingElement=t||document.createElement("div");let e=this._element.getAttribute("loading-style");(!e||e==="auto")&&(window.matchMedia("(prefers-color-scheme: dark)").matches?e="dark":e="light");const i=La();if(!t&&(this._loadingElement.style.position="absolute",this._loadingElement.style.width="100%",this._loadingElement.style.height="100%",this._loadingElement.style.left="0",this._loadingElement.style.top="0",e==="light"?this._loadingElement.style.backgroundColor="#ddd":this._loadingElement.style.backgroundColor="#222",this._loadingElement.style.display="flex",this._loadingElement.style.alignItems="center",this._loadingElement.style.justifyContent="center",this._loadingElement.style.zIndex=Number.MAX_SAFE_INTEGER.toString(),this._loadingElement.style.flexDirection="column",this._loadingElement.style.pointerEvents="none",this._loadingElement.style.color="white",this._loadingElement.style.fontFamily='system-ui, Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol"',this._loadingElement.style.fontSize="1rem",e==="light"?this._loadingElement.style.color="rgba(0,0,0,.6)":this._loadingElement.style.color="rgba(255,255,255,.3)",i&&this._element)){const y=this._element.getAttribute("loading-background-color");y&&(this._loadingElement.style.backgroundColor=y);const b=this._element.getAttribute("loading-text-color");b&&(this._loadingElement.style.color=b)}const n=((p=this._loadingElementOptions)==null?void 0:p.className)??dp.LoadingContainerClassName;if(this._loadingElement.classList.add(n),(g=this._loadingElementOptions)!=null&&g.additionalClasses)for(const y of this._loadingElementOptions.additionalClasses)this._loadingElement.classList.add(y);const o=document.createElement("div");this._loadingElement.appendChild(o);const r=document.createElement("img"),l=120;if(r.style.width=`${l}px`,r.style.height=`${l}px`,r.style.paddingTop="20px",r.style.paddingBottom="10px",r.style.margin="0px",r.style.userSelect="none",r.style.objectFit="contain",r.style.transition="transform 1.5s ease-out, opacity .3s ease-in-out",r.style.transform="translateY(30px)",r.style.opacity="0.05",setTimeout(()=>{r.style.opacity="1",r.style.transform="translateY(0px)"},1),r.src=uT,i&&this._element){const y=this._element.getAttribute("loading-logo-src");y&&(r.src=y)}o.appendChild(r);const c=document.createElement("div");c.style.cssText=`
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        width: 100%;
        opacity: 0;
        transition: opacity 1s ease-in-out 4s;
        `,setTimeout(()=>{c.style.opacity="1"},1),this._loadingElement.appendChild(c);const h=document.createElement("div"),d=100;h.style.display="flex",h.style.width=d+"%",h.style.height="3px",h.style.position="absolute",h.style.left="0",h.style.bottom="0px",h.style.opacity="0",h.style.transition="opacity 1s ease-in-out 2s",setTimeout(()=>{h.style.opacity="1"},1),e==="light"?h.style.backgroundColor="rgba(0,0,0,.2)":h.style.backgroundColor="rgba(255,255,255,.2)",this._loadingElement.appendChild(h),this._loadingBar=document.createElement("div"),h.appendChild(this._loadingBar);const u=function(y){return W.lerp(0,d,y)+"%"};if(this._loadingBar.style.background=`linear-gradient(90deg, #204f49 ${u(0)}, #0BA398 ${u(.3)}, #66A22F ${u(.6)}, #D7DB0A ${u(1)})`,this._loadingBar.style.backgroundAttachment="fixed",this._loadingBar.style.width="0%",this._loadingBar.style.height="100%",i&&this._element){const y=this._element.getAttribute("primary-color"),b=this._element.getAttribute("secondary-color");y&&b?this._loadingBar.style.background=`linear-gradient(90deg, ${y} ${u(0)}, ${b} ${u(1)})`:y?this._loadingBar.style.background=y:b&&(this._loadingBar.style.background=b)}this._loadingTextContainer=document.createElement("div"),this._loadingTextContainer.style.display="flex",this._loadingTextContainer.style.justifyContent="center",this._loadingTextContainer.style.marginTop=".2rem",c.appendChild(this._loadingTextContainer);const f=document.createElement("div");if(this._messageContainer=f,f.style.display="flex",f.style.fontSize=".8rem",f.style.paddingTop=".1rem",f.style.justifyContent="center",c.appendChild(f),i&&this._element){const y=this._element.getAttribute("loading-text-color");y&&(f.style.color=y)}return this.handleRuntimeLicense(this._loadingElement),this._loadingElement}async handleRuntimeLicense(t){let e=Vs();if(e)return;Gv&&console.log("Loading UI has commercial license?",e);const i=document.createElement("div");i.style.paddingTop=".6em",i.style.fontSize=".8em",i.style.textTransform="uppercase",i.innerText=`NEEDLE ENGINE NON COMMERCIAL VERSION
CLICK HERE TO GET A LICENSE`,i.style.cursor="pointer",i.style.userSelect="none",i.style.textAlign="center",i.style.pointerEvents="all",i.addEventListener("click",()=>window.open("https://needle.tools/pricing","_self")),i.style.opacity="0",t.appendChild(i),!U()&&Lr&&(Gv&&console.log("Waiting for runtime license check"),await Lr,e=Vs()),!e&&(i.style.transition="opacity .5s ease-in-out",i.style.opacity="1")}};let hf=dp;a(hf,"LoadingContainerClassName","loading");const ph=C("debugoverlay"),IC="ar",DM="quit-ar";class LM{constructor(){a(this,"arContainer",null);a(this,"currentSession",null);a(this,"_createdAROnlyElements",[]);a(this,"_reparentedObjects",[]);a(this,"contentElement",null);a(this,"originalDomOverlayParent",null);a(this,"requestEndAR",()=>{this.onRequestedEndAR()})}get ARContainer(){return this.arContainer}onBegin(t,e,i){var n;if(this.currentSession=i,this.arContainer=e,J.isMozillaXR()){const o=t.domElement.children;for(let r=0;r<(o==null?void 0:o.length);r++){const l=o[r];if(!l||l===this.arContainer)return;this._reparentedObjects.push({el:l,previousParent:l.parentElement}),(n=this.arContainer)==null||n.appendChild(l)}e?(this.originalDomOverlayParent=e.parentNode,this.originalDomOverlayParent&&(console.log("Reparent DOM Overlay to body",e,e.style.display),e.style.display="",e.style.visibility="",document.body.appendChild(e))):console.warn("WebXRViewer: No DOM Overlay found")}this.ensureQuitARButton(this.arContainer)}onEnd(t){var e;for(const i of this._createdAROnlyElements)i.remove&&i.remove();for(const i of this._reparentedObjects){const n=i.el;(e=i.previousParent)==null||e.appendChild(n)}this._reparentedObjects.length=0,J.isMozillaXR()&&setTimeout(()=>{var r;const i=t.renderer.domElement;i&&((r=t.domElement.shadowRoot)==null||r.prepend(i));const n=document.querySelectorAll("*");for(var o=0;o<n.length;o++){const l=n[o];l&&l._displayChanged!==void 0&&l._displayWas!==void 0&&(l.style.display=l._displayWas)}},10)}createOverlayContainer(t){if(this.contentElement)return this.contentElement;ph&&console.log("Setup overlay container");const e=t.shadowRoot.querySelector(".content");this.contentElement=e;const i=t.shadowRoot.querySelector(".overlay-content");return i&&e.appendChild(i),ph&&!J.isMobileDevice()&&this.ensureQuitARButton(e),e}onRequestedEndAR(){this.currentSession&&(this.currentSession.end(),this.currentSession=null)}ensureQuitARButton(t){const e=document.createElement("slot");e.setAttribute("name","quit-ar"),this.appendElement(e,t),this._createdAROnlyElements.push(e),e.style.pointerEvents="auto";const i=document.querySelector(`.${DM}`);if(i){i.addEventListener("click",this.requestEndAR),ph&&i.addEventListener("click",()=>console.log("Clicked quit-ar button"));return}e.addEventListener("click",this.requestEndAR),ph&&e.addEventListener("click",()=>console.log("Clicked fallback close button"));const n=document.createElement("div");n.style.cssText=`
            position: fixed;
            top: 0;
            right: 0;
            z-index: 600;
            pointer-events: all;
        `,this.appendElement(n,e);var o=document.createElementNS("http://www.w3.org/2000/svg","svg");o.classList.add("quit-ar-button"),o.setAttribute("width","40px"),o.setAttribute("height","40px"),o.style.cssText=`
            background: rgba(255, 255, 255, .4);
            -webkit-backdrop-filter: blur(8px);
            backdrop-filter: blur(8px);
            border-radius: 50%;
            box-shadow: 0 0 5px rgba(0,0,0,.3);
            outline: 1px solid rgba(255, 255, 255, .6);
            display: flex;
            justify-content: center;
            align-items: center;
        `,n.appendChild(o);var r=document.createElementNS("http://www.w3.org/2000/svg","path");r.setAttribute("d","M 12,12 L 28,28 M 28,12 12,28"),r.setAttribute("stroke","#000000"),r.setAttribute("stroke-width","2px"),r.style.cssText=`
            /**filter: drop-shadow(0 0px 1.2px rgba(0,0,0,.7));**/
        `,o.appendChild(r),ph&&console.log("Created fallback close button",o,t)}appendElement(t,e){return e.shadowRoot?e.shadowRoot.appendChild(t):e.appendChild(t)}}const jM=C("debugdecoders");let yg=null;function DC(){if(!yg){const s=M_(null);yg={dracoLoader:s.dracoLoader,ktx2Loader:s.ktx2Loader,meshoptDecoder:s.meshoptDecoder}}return yg}function Xv(s){s!==void 0&&typeof s=="string"&&ZR(s)}function Qv(s){if(s!==void 0&&typeof s=="string"&&s!=="js"){const t=DC();jM&&console.log("Setting draco decoder type to",s),t.dracoLoader.setDecoderConfig({type:s})}}function Yv(s){s!==void 0&&typeof s=="string"&&eO(s)}function Vp(s,t){const e=DC();return t.renderer?e.ktx2Loader.detectSupport(t.renderer):console.warn("No renderer provided to detect ktx2 support - loading KTX2 textures will probably fail"),tO(s),s.dracoLoader||s.setDRACOLoader(e.dracoLoader),s.ktx2Loader||s.setKTX2Loader(e.ktx2Loader),s.meshoptDecoder||s.setMeshoptDecoder(e.meshoptDecoder),iO(s,{progressive:!0}),s}const Ic=function(s){return m(s)},m=function(s){if(s===void 0&&(s=null),!Array.isArray(s))s=Kv(s);else for(let t=0;t<s.length;t++){const e=s[t];s[t]=Kv(e)}return function(t,e){typeof e!="string"&&(e=e.name),Object.getOwnPropertyDescriptor(t,"$serializedTypes")||(t.$serializedTypes={});const i=t.$serializedTypes=t.$serializedTypes||{};i[e]=s}};function Kv(s){var t,e;switch((e=(t=s==null?void 0:s.prototype)==null?void 0:t.constructor)==null?void 0:e.name){case"Number":case"String":case"Boolean":return null}return s}class P extends F{constructor(){super(...arguments);a(this,"guid")}static isDestroyed(e){return Sc(e)}static setActive(e,i,n=!0){e&&(af(e,i),tf(e),i&&n&&oC(ne.Current,e))}static isActiveSelf(e){return Ud(e)}static isActiveInHierarchy(e){return NE(e)}static markAsInstancedRendered(e,i){$E(e,i)}static isUsingInstancing(e){return K_(e)}static foreachComponent(e,i,n=!0){return Cc(e,i,n)}static instantiateSynced(e,i){return e?cC(e,i):null}static instantiate(e,i=null){return"isAssetReference"in e,Pc(e,i)}static destroySynced(e,i,n=!0){if(!e)return;const o=e;i=i??ne.Current,zp(o,i.connection,n)}static destroy(e,i=!0){return Ln(e,i)}static add(e,i,n){if(!(!e||!i)){if(e===i){console.warn("Can not add object to self",e);return}n||(n=ne.Current),i.add(e),af(e,!0),tf(e),n?P.foreachComponent(e,o=>{G_(o,n),!o.__internalDidAwakeAndStart&&n.new_script_start.includes(o)===!1&&n.new_script_start.push(o)},!0):console.warn("Missing context")}}static remove(e){var i;e&&((i=e.parent)==null||i.remove(e),af(e,!1),tf(e),P.foreachComponent(e,n=>{Gk(n)},!0))}static invokeOnChildren(e,i,...n){this.invoke(e,i,!0,n)}static invoke(e,i,n=!1,...o){e&&this.foreachComponent(e,r=>{const l=r[i];l&&typeof l=="function"&&(l==null||l.call(r,...o))},n)}static addNewComponent(e,i,n,o=!0){return Mn(e,i,n,{callAwake:o})}static addComponent(e,i,n,o){return Mn(e,i,n,o)}static moveComponent(e,i){return Mn(e,i)}static removeComponent(e){return yC(e.gameObject,e),e}static getOrAddComponent(e,i){return Up(e,i)}static getComponent(e,i){return e===null?null:Ac(e,i)}static getComponents(e,i,n=null){return e===null?n??[]:Np(e,i,n)}static findByGuid(e,i){return vC(e,i)}static findObjectOfType(e,i,n=!0){return Wp(e,i??ne.Current,n)}static findObjectsOfType(e,i){const n=[];return UE(e,n,i),n}static getComponentInChildren(e,i){return $p(e,i)}static getComponentsInChildren(e,i,n=null){return zd(e,i,n??void 0)}static getComponentInParent(e,i){return kf(e,i)}static getComponentsInParent(e,i,n=null){return Q_(e,i,n)}static getAllComponents(e){var o;const i=(o=e.userData)==null?void 0:o.components;return i?[...i]:[]}static*iterateComponents(e){var n;const i=(n=e==null?void 0:e.userData)==null?void 0:n.components;if(i&&Array.isArray(i))for(let o=0;o<i.length;o++)yield i[o]}}const cd=class{constructor(t){a(this,"__context");a(this,"__name");a(this,"gameObject");a(this,"guid","invalid");a(this,"sourceId");a(this,"__didAwake",!1);a(this,"__didStart",!1);a(this,"__didEnable",!1);a(this,"__isEnabled");a(this,"__destroyed",!1);a(this,"_eventListeners",new Map);this.__didAwake=!1,this.__didStart=!1,this.__didEnable=!1,this.__isEnabled=void 0,this.__destroyed=!1,this._internalInit(t)}get isComponent(){return!0}get context(){return this.__context??ne.Current}set context(t){this.__context=t}get scene(){return this.context.scene}get layer(){var t,e;return(e=(t=this.gameObject)==null?void 0:t.userData)==null?void 0:e.layer}get name(){var t,e;return(t=this.gameObject)!=null&&t.name?this.gameObject.name:(e=this.gameObject)==null?void 0:e.userData.name}set name(t){this.gameObject?(this.gameObject.userData||(this.gameObject.userData={}),this.gameObject.userData.name=t,this.__name=t):this.__name=t}get tag(){var t;return(t=this.gameObject)==null?void 0:t.userData.tag}set tag(t){this.gameObject&&(this.gameObject.userData||(this.gameObject.userData={}),this.gameObject.userData.tag=t)}get static(){var t;return(t=this.gameObject)==null?void 0:t.userData.static}set static(t){this.gameObject&&(this.gameObject.userData||(this.gameObject.userData={}),this.gameObject.userData.static=t)}get activeAndEnabled(){return!(this.destroyed||this.__isEnabled===!1||!this.__isActiveInHierarchy)}get __isActive(){return this.gameObject.visible}get __isActiveInHierarchy(){if(!this.gameObject)return!1;const t=this.gameObject[Dr];return t===void 0?!0:t}set __isActiveInHierarchy(t){this.gameObject&&(this.gameObject[Dr]=t)}awake(){}onEnable(){}onDisable(){}onDestroy(){this.__destroyed=!0}startCoroutine(t,e=oe.Update){return this.context.registerCoroutineUpdate(this,t,e)}stopCoroutine(t,e=oe.Update){this.context.unregisterCoroutineUpdate(t,e)}get destroyed(){return this.__destroyed}destroy(){this.__destroyed||this.__internalDestroy()}get __internalDidAwakeAndStart(){return this.__didAwake&&this.__didStart}__internalNewInstanceCreated(t){return this.__didAwake=!1,this.__didStart=!1,this.__didEnable=!1,this.__isEnabled=void 0,this.__destroyed=!1,this._internalInit(t),this}_internalInit(t){if(typeof t=="object")for(const e of Object.keys(t)){const i=t[e];typeof i!="function"&&(this[e]=i)}}__internalAwake(){this.__didAwake||(this.__didAwake=!0,this.awake())}__internalStart(){this.__didStart||(this.__didStart=!0,this.start&&this.start())}__internalEnable(t){return this.__destroyed?(U()&&console.warn("[Needle Engine Dev] Trying to enable destroyed component"),!1):this.__didAwake?this.__didEnable?(t!==!0&&(this.__isEnabled=!0),!1):(this.__didEnable=!0,this.__isEnabled=!0,this.onEnable(),!0):!1}__internalDisable(t){if(this.__didAwake){if(!this.__didEnable){t!==!0&&(this.__isEnabled=!1);return}this.__didEnable=!1,this.__isEnabled=!1,this.onDisable()}}__internalDestroy(){var t;this.__destroyed||(this.__destroyed=!0,this.__didAwake&&((t=this.onDestroy)==null||t.call(this),this.dispatchEvent(new CustomEvent("destroyed",{detail:this}))),zE(this))}get enabled(){return typeof this.__isEnabled=="boolean"?this.__isEnabled:!0}set enabled(t){if(this.__destroyed){U()&&console.warn(`[Needle Engine Dev] Trying to ${t?"enable":"disable"} destroyed component`);return}if(typeof t=="number"&&(t>=.5?t=!0:t=!1),!this.__didAwake){this.__isEnabled=t;return}t?this.__internalEnable():this.__internalDisable()}get worldPosition(){return ae(this.gameObject)}set worldPosition(t){jt(this.gameObject,t)}setWorldPosition(t,e,i){_c(this.gameObject,t,e,i)}get worldQuaternion(){return Le(this.gameObject)}set worldQuaternion(t){as(this.gameObject,t)}setWorldQuaternion(t,e,i,n){Fw(this.gameObject,t,e,i,n)}get worldEuler(){return zw(this.gameObject)}set worldEuler(t){Uw(this.gameObject,t)}get worldRotation(){return this.gameObject.worldRotation}set worldRotation(t){this.setWorldRotation(t.x,t.y,t.z,!0)}setWorldRotation(t,e,i,n=!0){Ip(this.gameObject,t,e,i,n)}get forward(){return cd._forward.set(0,0,-1).applyQuaternion(this.worldQuaternion)}get right(){return cd._right.set(1,0,0).applyQuaternion(this.worldQuaternion)}get up(){return cd._up.set(0,1,0).applyQuaternion(this.worldQuaternion)}addEventListener(t,e){this._eventListeners[t]=this._eventListeners[t]||[],this._eventListeners[t].push(e)}removeEventListener(t,e){if(!this._eventListeners[t])return;const i=this._eventListeners[t].indexOf(e);i>=0&&this._eventListeners[t].splice(i,1)}dispatchEvent(t){if(!t||!this._eventListeners[t.type])return!1;const e=this._eventListeners[t.type];for(let i=0;i<e.length;i++)e[i](t);return!1}};let j=cd;a(j,"_forward",new x),a(j,"_right",new x),a(j,"_up",new x);const BM=Object.freeze(Object.defineProperty({__proto__:null,Behaviour:j,Component:j,GameObject:P},Symbol.toStringTag,{value:"Module"}));var LC=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};class Hp extends j{constructor(){super(...arguments);a(this,"from");a(this,"to");a(this,"width",0);a(this,"centered",!0);a(this,"_centerPos")}awake(){this._centerPos=new x}update(){if(!this.from||!this.to)return;const e=ae(this.from).clone(),i=ae(this.to).clone(),n=e.distanceTo(i);this._centerPos.copy(e),this._centerPos.add(i),this._centerPos.multiplyScalar(.5),jt(this.gameObject,this.centered?this._centerPos:e),this.gameObject.lookAt(ae(this.to).clone()),this.gameObject.scale.set(this.width,this.width,n)}}LC([m(P)],Hp.prototype,"from",void 0);LC([m(P)],Hp.prototype,"to",void 0);var el=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const or=C("debuganimation");let jC=class{constructor(){a(this,"x");a(this,"y")}};class Mi extends j{constructor(){super(...arguments);a(this,"playAutomatically",!0);a(this,"randomStartTime",!0);a(this,"minMaxSpeed");a(this,"minMaxOffsetNormalized");a(this,"loop",!0);a(this,"clampWhenFinished",!1);a(this,"_tempAnimationClipBeforeGameObjectExisted",null);a(this,"_tempAnimationsArray");a(this,"mixer");a(this,"_actions");a(this,"_handles")}get isAnimationComponent(){return!0}addClip(e){this.animations||(this.animations=[]),this.animations.push(e)}get time(){if(this.actions){for(const e of this.actions)if(e.isRunning())return e.time}return 0}set time(e){if(this.actions)for(const i of this.actions)i.time=e}get clip(){var e;return(e=this.animations)!=null&&e.length?this.animations[0]:null}set clip(e){if(!this.__didAwake){or&&console.warn("Assign clip during serialization",e),this._tempAnimationClipBeforeGameObjectExisted=e;return}e&&(this.gameObject.animations||(this.gameObject.animations=[]),!this.animations.includes(e)&&(this.animations.length>0?this.animations.splice(0,0,e):this.animations.push(e)))}set clips(e){this.animations=e}set animations(e){e==null||!Array.isArray(e)||(this.gameObject?this.gameObject.animations=e:this._tempAnimationsArray=e)}get animations(){return this.gameObject.animations||this._tempAnimationsArray||[]}get actions(){return this._actions}set actions(e){this._actions=e}awake(){this.mixer=void 0,or&&console.log("Animation Awake",this.name,this),this._tempAnimationsArray&&(this.animations=this._tempAnimationsArray,this._tempAnimationsArray=void 0),this._tempAnimationClipBeforeGameObjectExisted&&(this.clip=this._tempAnimationClipBeforeGameObjectExisted,this._tempAnimationClipBeforeGameObjectExisted=null),this.actions=[],this._handles=[]}onEnable(){var e;if(this.playAutomatically&&((e=this.animations)==null?void 0:e.length)>0){const i=Math.floor(Math.random()*this.animations.length),n=this.animations[i];this.play(i,{exclusive:!0,fadeDuration:0,startTime:this.randomStartTime?Math.random()*n.duration:0,loop:this.loop,clampWhenFinished:this.clampWhenFinished})}}update(){this.mixer&&(this.mixer.update(this.context.time.deltaTime),this._handles.forEach(e=>e.update()))}onDisable(){this.mixer&&this.mixer.stopAllAction()}onDestroy(){this.context.animations.unregisterAnimationMixer(this.mixer)}getAction(e){var i;return((i=this.actions)==null?void 0:i.find(n=>n.getClip().name===e))||null}get isPlaying(){if(this.actions){for(let e=0;e<this.actions.length;e++)if(this.actions[e].isRunning())return!0}return!1}stopAll(e){if(this.actions)for(const i of this.actions)e!=null&&e.fadeDuration?i.fadeOut(e.fadeDuration):i.stop()}stop(e,i){if(e===void 0){this.stopAll();return}else if(typeof e=="number"){if(e>=this.animations.length){or&&console.log("No animation at index",e);return}e=this.animations[e]}else typeof e=="string"&&(e=this.animations.find(o=>o.name===e));if(!e){console.error("Could not find clip",e);return}const n=this.actions.find(o=>o.getClip()===e);if(!n){console.error("Could not find action",e);return}i!=null&&i.fadeDuration?n.fadeOut(i.fadeDuration):n.stop()}pause(e,i=!1){if(e===void 0){for(const o of this.actions)o.paused=!i;return}else if(typeof e=="number"){if(e>=this.animations.length){or&&console.log("No animation at index",e);return}e=this.animations[e]}else typeof e=="string"&&(e=this.animations.find(o=>o.name===e));if(!e){console.error("Could not find clip",e);return}const n=this.actions.find(o=>o.getClip()===e);if(!n){console.error("Could not find action",e);return}n.paused=!i}resume(){for(const e of this.actions)e.paused=!1}play(e=0,i){if(or&&console.log("PLAY",e),this.ensureMixer(),!this.mixer){or&&console.warn("Missing mixer",this);return}e===void 0&&(e=0);let n=e;if(typeof e=="number"){if(e>=this.animations.length){or&&console.log("No animation at index",e);return}n=this.animations[e]}else typeof e=="string"&&(n=this.animations.find(r=>r.name===e));if(!n){console.error("Could not find clip",e);return}i||(i={});for(const r of this.actions)if(r.getClip()===n)return this.internalOnPlay(r,i);if(!n.tracks){console.warn("Clip is no AnimationClip",n);return}const o=this.mixer.clipAction(n);return this.actions.push(o),this.internalOnPlay(o,i)}internalOnPlay(e,i){var n=this.actions.find(l=>l===e);if(n===e&&n.isRunning()&&n.time<n.getClip().duration){const l=this.tryFindHandle(e);if(n.paused&&(n.paused=!1),l)return l.waitForFinish()}if(i.loop===void 0&&(i.loop=this.loop),i.clampWhenFinished===void 0&&(i.clampWhenFinished=this.clampWhenFinished),i.minMaxOffsetNormalized===void 0&&this.randomStartTime&&(i.minMaxOffsetNormalized=this.minMaxOffsetNormalized),i.minMaxSpeed===void 0&&(i.minMaxSpeed=this.minMaxSpeed),(i==null?void 0:i.exclusive)??!0)for(const l of this.actions)l!=n&&(i.fadeDuration?l.fadeOut(i.fadeDuration):l.stop());if(i!=null&&i.fadeDuration&&e.fadeIn(i.fadeDuration),e.enabled=!0,(i==null?void 0:i.startTime)!=null)e.time=i.startTime;else if(i!=null&&i.minMaxOffsetNormalized&&i.minMaxOffsetNormalized.x!=0&&i.minMaxOffsetNormalized.y!=0){const l=e.getClip();e.time=W.lerp(i.minMaxOffsetNormalized.x,i.minMaxOffsetNormalized.y,Math.random())*l.duration}else e.time>=e.getClip().duration&&(e.time=0);i!=null&&i.minMaxSpeed?e.timeScale=W.lerp(i.minMaxSpeed.x,i.minMaxSpeed.y,Math.random()):e.timeScale=(i==null?void 0:i.speed)??1,(i==null?void 0:i.loop)!=null?e.loop=i.loop?AP:oy:e.loop=oy,i!=null&&i.clampWhenFinished&&(e.clampWhenFinished=!0),e.paused=!1,e.play(),or&&console.log("PLAY",e.getClip().name,e);const r=new FM(e,this.mixer,i,l=>{this._handles.splice(this._handles.indexOf(r),1)});return this._handles.push(r),r.waitForFinish()}tryFindHandle(e){for(const i of this._handles)if(i.action===e)return i}ensureMixer(){if(!this.mixer){const e="animationMixer";this.gameObject[e]&&(this.mixer=this.gameObject[e]),(!this.mixer||!this.mixer.clipAction)&&(this.mixer=new C_(this.gameObject),this.gameObject[e]=this.mixer)}this.context.animations.registerAnimationMixer(this.mixer)}}el([m()],Mi.prototype,"playAutomatically",void 0);el([m()],Mi.prototype,"randomStartTime",void 0);el([m(jC)],Mi.prototype,"minMaxSpeed",void 0);el([m(jC)],Mi.prototype,"minMaxOffsetNormalized",void 0);el([m()],Mi.prototype,"loop",void 0);el([m()],Mi.prototype,"clampWhenFinished",void 0);el([m(Ar)],Mi.prototype,"clips",null);class FM{constructor(t,e,i,n){a(this,"mixer");a(this,"action");a(this,"promise",null);a(this,"_options");a(this,"_resolveCallback",null);a(this,"_resolvedOrRejectedCallback");a(this,"onFinished",t=>{t.action===this.action&&this.onResolve()});this.action=t,this.mixer=e,this._resolvedOrRejectedCallback=n,this._options=i}waitForFinish(){return this.promise?this.promise:(this.promise=new Promise(t=>{this._resolveCallback=t}),this.mixer.addEventListener("finished",this.onFinished),this.promise)}update(){this._options&&this._options.endTime!==void 0&&this.action.time>this._options.endTime&&(this._options.loop===!0?this.action.time=this._options.startTime??0:(this.action.time=this._options.endTime,this.action.timeScale=0,this.onResolve()))}onResolve(){var t,e;this.dispose(),(t=this._resolvedOrRejectedCallback)==null||t.call(this,this),(e=this._resolveCallback)==null||e.call(this,this.action)}dispose(){this.mixer.removeEventListener("finished",this.onFinished)}}var Xr=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};class Hi{constructor(t=0,e=0){a(this,"time",0);a(this,"value",0);a(this,"inTangent",1/0);a(this,"inWeight");a(this,"outTangent",1/0);a(this,"outWeight");a(this,"weightedMode");this.time=t,this.value=e}}Xr([m()],Hi.prototype,"time",void 0);Xr([m()],Hi.prototype,"value",void 0);Xr([m()],Hi.prototype,"inTangent",void 0);Xr([m()],Hi.prototype,"inWeight",void 0);Xr([m()],Hi.prototype,"outTangent",void 0);Xr([m()],Hi.prototype,"outWeight",void 0);Xr([m()],Hi.prototype,"weightedMode",void 0);class Zn{constructor(){a(this,"keys",[])}static linearFromTo(t,e,i){const n=new Zn,o=new Hi;o.time=0,o.value=t;const r=new Hi;return r.time=i,r.value=e,n.keys.push(o,r),n}static constant(t){const e=new Zn,i=new Hi;return i.time=0,i.value=t,e.keys.push(i),e}clone(){var e;const t=new Zn;return t.keys=((e=this.keys)==null?void 0:e.map(i=>{const n=new Hi;return n.time=i.time,n.value=i.value,n.inTangent=i.inTangent,n.inWeight=i.inWeight,n.outTangent=i.outTangent,n.outWeight=i.outWeight,n.weightedMode=i.weightedMode,n}))||[],t}get duration(){return!this.keys||this.keys.length==0?0:this.keys[this.keys.length-1].time}evaluate(t){if(!this.keys||this.keys.length==0)return 0;if(this.keys.length===1)return this.keys[0].value;if(this.keys[0].time>=t)return this.keys[0].value;for(let e=0;e<this.keys.length;e++){const i=this.keys[e];if(i.time<=t)if(e+1<this.keys.length){const o=this.keys[e+1];if(o.time<t)continue;return!isFinite(i.outTangent)||!isFinite(o.inTangent)?i.value:Zn.interpolateValue(t,i,o)}else return i.value}return this.keys[this.keys.length-1].value}static interpolateValue(t,e,i){const n=e.time,o=e.value,r=e.outTangent,l=i.time,c=i.value,h=i.inTangent,d=l-n,u=d*d,f=u*d,p=((r+h)*d-2*(c-o))/f,g=(3*(c-o)-(h+2*r)*d)/u,y=r,b=o,_=t-n,v=_*_,S=v*_;return p*S+g*v+y*_+b}}Xr([m(Hi)],Zn.prototype,"keys",void 0);const df=Symbol("objectIsAnimatedData");function Jv(s,t,e){if(!s)return;if(s[df]===void 0){if(!e)return;s[df]=new Set}const i=s[df];e?i.add(t):i.has(t)&&i.delete(t)}function zM(s){if(!s)return!1;const t=s[df];return t!==void 0&&t.size>0}class ML{constructor(){a(this,"_context")}get context(){return this._context??ne.Current}get isStateMachineBehaviour(){return!0}}class Pu{constructor(t,e,i,n){a(this,"name");a(this,"nameHash");a(this,"normalizedTime");a(this,"length");a(this,"speed");a(this,"action");a(this,"hasTransitions");var o;this.name=t.name,this.nameHash=t.hash,this.normalizedTime=e,this.length=i,this.speed=n,this.action=t.motion.action||null,this.hasTransitions=((o=t.transitions)==null?void 0:o.length)>0||!1}}function UM(s,t){return{name:"Empty",isLooping:!1,guid:(t==null?void 0:t.generateUUID())??To.generateUUID(),index:-1,clip:new Ar(s,0,[])}}var gr;(function(s){s[s.If=1]="If",s[s.IfNot=2]="IfNot",s[s.Greater=3]="Greater",s[s.Less=4]="Less",s[s.Equals=6]="Equals",s[s.NotEqual=7]="NotEqual"})(gr||(gr={}));var Xy;(function(s){s[s.Float=1]="Float",s[s.Int=3]="Int",s[s.Bool=4]="Bool",s[s.Trigger=9]="Trigger"})(Xy||(Xy={}));const xt=C("debuganimatorcontroller"),Ru=C("debugrootmotion");class An{constructor(t){a(this,"_speed",1);a(this,"normalizedStartOffset",0);a(this,"animator");a(this,"model");a(this,"_mixer");a(this,"_activeState");a(this,"_activeStates",[]);a(this,"_heldActions",[]);a(this,"rootMotionHandler");this.model=t,xt&&console.log(this)}static createFromClips(t,e={looping:!1,autoTransition:!0,transitionDuration:0}){const i=[];for(let r=0;r<t.length;r++){const l=t[r],c=[];if(e.autoTransition!==!1){const d=e.transitionDuration??0,u=d/l.duration;let f=r;(e.autoTransition===void 0||e.autoTransition===!0)&&(f=(r+1)%t.length),c.push({exitTime:1-u,offset:0,duration:d,hasExitTime:!0,destinationState:f,conditions:[]})}const h={name:l.name,hash:r,motion:{name:l.name,clip:l,isLooping:(e==null?void 0:e.looping)??!1},transitions:c,behaviours:[]};i.push(h)}const n={name:"AnimatorController",guid:new ui(Date.now()).generateUUID(),parameters:[],layers:[{name:"Base Layer",stateMachine:{defaultState:0,states:i}}]};return new An(n)}play(t,e=-1,i=Number.NEGATIVE_INFINITY,n=0){if(e<0)e=0;else if(e>=this.model.layers.length){console.warn("invalid layer");return}const r=this.model.layers[e].stateMachine;for(const l of r.states)if(l.name===t||l.hash===t){xt&&console.log("transition to ",l),this.transitionTo(l,n,i);return}console.warn("Could not find "+t+" to play")}reset(){this.setStartTransition()}setBool(t,e){var n,o;const i=typeof t=="string"?"name":"hash";return(o=(n=this.model)==null?void 0:n.parameters)==null?void 0:o.filter(r=>r[i]===t).forEach(r=>r.value=e)}getBool(t){var i,n,o;const e=typeof t=="string"?"name":"hash";return((o=(n=(i=this.model)==null?void 0:i.parameters)==null?void 0:n.find(r=>r[e]===t))==null?void 0:o.value)??!1}setFloat(t,e){var o,r;const i=typeof t=="string"?"name":"hash",n=(r=(o=this.model)==null?void 0:o.parameters)==null?void 0:r.filter(l=>l[i]===t);return n.forEach(l=>l.value=e),(n==null?void 0:n.length)>0}getFloat(t){var i,n,o;const e=typeof t=="string"?"name":"hash";return((o=(n=(i=this.model)==null?void 0:i.parameters)==null?void 0:n.find(r=>r[e]===t))==null?void 0:o.value)??0}setInteger(t,e){var n,o;const i=typeof t=="string"?"name":"hash";return(o=(n=this.model)==null?void 0:n.parameters)==null?void 0:o.filter(r=>r[i]===t).forEach(r=>r.value=e)}getInteger(t){var i,n,o;const e=typeof t=="string"?"name":"hash";return((o=(n=(i=this.model)==null?void 0:i.parameters)==null?void 0:n.find(r=>r[e]===t))==null?void 0:o.value)??0}setTrigger(t){var i,n;xt&&console.log("SET TRIGGER",t);const e=typeof t=="string"?"name":"hash";return(n=(i=this.model)==null?void 0:i.parameters)==null?void 0:n.filter(o=>o[e]===t).forEach(o=>o.value=!0)}resetTrigger(t){var i,n;const e=typeof t=="string"?"name":"hash";return(n=(i=this.model)==null?void 0:i.parameters)==null?void 0:n.filter(o=>o[e]===t).forEach(o=>o.value=!1)}getTrigger(t){var i,n,o;const e=typeof t=="string"?"name":"hash";return((o=(n=(i=this.model)==null?void 0:i.parameters)==null?void 0:n.find(r=>r[e]===t))==null?void 0:o.value)??!1}isInTransition(){return this._activeStates.length>1}setSpeed(t){this._speed=t}FindState(t){return this.findState(t)}findState(t){if(!t)return null;if(Array.isArray(this.model.layers)){for(const e of this.model.layers)for(const i of e.stateMachine.states)if(i.name===t||i.hash==t)return i}return null}getCurrentStateInfo(){if(!this._activeState)return null;const t=this._activeState.motion.action;if(!t)return null;const e=this._activeState.motion.clip.duration,i=e<=0?0:Math.abs(t.time/e);return new Pu(this._activeState,i,e,this._speed)}get currentAction(){if(!this._activeState)return null;const t=this._activeState.motion.action;return t||null}get context(){var t;return(t=this.animator)==null?void 0:t.context}get mixer(){return this._mixer}dispose(){var t;if(this._mixer.stopAllAction(),this.animator){this._mixer.uncacheRoot(this.animator.gameObject);for(const e of this._activeStates)e.motion.clip&&this.mixer.uncacheAction(e.motion.clip,this.animator.gameObject)}(t=this.context)==null||t.animations.unregisterAnimationMixer(this._mixer)}bind(t){var e,i;t?this.animator!==t&&(this._mixer&&(this._mixer.stopAllAction(),(e=this.context)==null||e.animations.unregisterAnimationMixer(this._mixer)),this.animator=t,this._mixer=new C_(this.animator.gameObject),(i=this.context)==null||i.animations.registerAnimationMixer(this._mixer),this.createActions(this.animator)):console.error("AnimatorController.bind: animator is null")}clone(){if(typeof this.model=="string")return console.warn("AnimatorController has not been resolved, can not create model from string",this.model),null;xt&&console.warn("AnimatorController clone()",this.model);const t=kp(this.model,(i,n,o)=>o==null?!0:!(o.type==="Object3D"||o.isObject3D===!0||WO(o)||o.tracks!==void 0||o instanceof An));return console.assert(t!==this.model),new An(t)}update(t){var i,n;if(!this.animator)return;this.evaluateTransitions(),this.updateActiveStates(t);const e=this.animator.context.time.deltaTime;this.animator.applyRootMotion&&((i=this.rootMotionHandler)==null||i.onBeforeUpdate(t)),this._mixer.update(e),this.animator.applyRootMotion&&((n=this.rootMotionHandler)==null||n.onAfterUpdate(t))}get activeState(){return this._activeState}updateActiveStates(t){for(let e=0;e<this._activeStates.length;e++){const i=this._activeStates[e],n=i.motion;if(!n.action)this._activeStates.splice(e,1),e--;else{const o=n.action;o.weight=t,o.getEffectiveWeight()<=0&&!o.isRunning()&&(xt&&console.debug("REMOVE",i.name,o.getEffectiveWeight(),o.isRunning(),o.isScheduled()),this._activeStates.splice(e,1),e--)}}}setStartTransition(){var t;this.model.layers.length>1&&(xt||U())&&console.warn("Multiple layers are not supported yet "+((t=this.animator)==null?void 0:t.name));for(const e of this.model.layers){const i=e.stateMachine;i.defaultState===void 0&&(xt&&console.warn("AnimatorController default state is undefined, will assign state 0 as default",e),i.defaultState=0);const n=i.states[i.defaultState];this.transitionTo(n,0,this.normalizedStartOffset);break}}evaluateTransitions(){var o;let t=!1;if(!this._activeState){if(this.setStartTransition(),!this._activeState)return;t=!0}const e=this._activeState,i=e.motion.action;for(const r of e.transitions){if(!r.hasExitTime&&r.conditions.length<=0)continue;let l=!0;for(const c of r.conditions)if(!this.evaluateCondition(c)){l=!1;break}if(l)if(i){const c=e.motion.clip.duration,h=c<=0?1:Math.abs(i.time/c);let d=r.exitTime;i.timeScale<0&&(d=1-d);let u=!1;if(r.hasExitTime?i.timeScale>0?u=h>=r.exitTime:i.timeScale<0&&(u=1-h>=r.exitTime):u=!0,u){for(const f of r.conditions){const p=this.model.parameters.find(g=>g.name===f.parameter);(p==null?void 0:p.type)===Xy.Trigger&&p.value&&(p.value=!1)}if(i.clampWhenFinished=!0,xt){const f=this.getState(r.destinationState,0);console.log(`Transition to ${r.destinationState} / ${f==null?void 0:f.name}`,r,`
Timescale: `+i.timeScale,`
Normalized time: `+h.toFixed(3),`
Exit Time: `+d,r.hasExitTime)}this.transitionTo(r.destinationState,r.duration,r.offset);return}}else{this.transitionTo(r.destinationState,r.duration,r.offset);return}}i&&this.setTimescale(i,e);let n=!1;if(e.motion.isLooping&&i&&(i.time>=i.getClip().duration?(n=!0,i.reset(),i.time=0,i.play()):i.time<=0&&i.timeScale<0&&(n=!0,i.reset(),i.time=i.getClip().duration,i.play())),!n&&e&&!t&&i&&this.animator&&e.behaviours){const r=i==null?void 0:i.getClip().duration,l=i.time/r,c=new Pu(this._activeState,l,r,this._speed);for(const h of e.behaviours)h.instance&&((o=h.instance.onStateUpdate)==null||o.call(h.instance,this.animator,c,0))}}setTimescale(t,e){let i=e.speed??1;e.speedParameter&&(i*=this.getFloat(e.speedParameter)),i!==void 0&&(t.timeScale=i*this._speed)}getState(t,e){return typeof t=="number"&&(t==-1&&(t=this.model.layers[e].stateMachine.defaultState,t===void 0&&(xt&&console.warn("AnimatorController default state is undefined: ",this.model,"Layer: "+e),t=0)),t=this.model.layers[e].stateMachine.states[t]),t}releaseHeldActions(t){for(const e of this._heldActions)e.fadeOut(t);this._heldActions.length=0}transitionTo(t,e,i){var d,u,f,p,g,y,b,_;if(!this.animator)return;const n=0;if(t=this.getState(t,n),!(t!=null&&t.motion)||!t.motion.clip||!(t.motion.clip instanceof Ar))return;const o=this._activeState===t;if(o){const v=t.motion;if(!v.action_loopback&&v.clip){const S=this.rootMotionHandler?this.animator.gameObject.matrix.clone():null;this._mixer.uncacheAction(v.clip,this.animator.gameObject),S&&S.decompose(this.animator.gameObject.position,this.animator.gameObject.quaternion,this.animator.gameObject.scale),v.action_loopback=this.createAction(v.clip)}}if((d=this._activeState)!=null&&d.behaviours&&this._activeState.motion.action){const v=(u=this._activeState)==null?void 0:u.motion.clip.duration,S=this._activeState.motion.action.time/v,T=new Pu(this._activeState,S,v,this._speed);for(const O of this._activeState.behaviours)(p=(f=O.instance)==null?void 0:f.onStateExit)==null||p.call(O.instance,this.animator,T,n)}const r=(g=this._activeState)==null?void 0:g.motion.action;o&&(t.motion.action=t.motion.action_loopback,t.motion.action_loopback=r);const l=this._activeState;this._activeState=t;const c=(y=t.motion)==null?void 0:y.action,h=t.motion.clip;if((h==null?void 0:h.duration)<=0&&h.tracks.length<=0?r&&this._heldActions.push(r):r&&(r.fadeOut(e),this.releaseHeldActions(e)),c){if(i=Math.max(0,Math.min(1,i)),t.cycleOffsetParameter){let S=this.getFloat(t.cycleOffsetParameter);typeof S=="number"?(S<0&&(S+=1),i+=S,i%=1):xt&&console.warn("AnimatorController cycle offset parameter is not a number",t.cycleOffsetParameter)}else typeof t.cycleOffset=="number"&&(i+=t.cycleOffset,i%=1);c.isRunning()&&c.stop(),c.reset(),c.enabled=!0,this.setTimescale(c,t);const v=t.motion.clip.duration;if(c.time=o?0:i*v,c.timeScale<0&&(c.time=v-c.time),c.clampWhenFinished=!0,c.setLoop(oy,0),e>0?c.fadeIn(e):c.weight=1,c.play(),this.rootMotionHandler&&this.rootMotionHandler.onStart(c),this._activeStates.includes(t)||this._activeStates.push(t),this._activeState.behaviours){const S=new Pu(t,i,v,this._speed);for(const T of this._activeState.behaviours)(_=(b=T.instance)==null?void 0:b.onStateEnter)==null||_.call(T.instance,this.animator,S,n)}}else xt&&(t.__warned_no_motion||(t.__warned_no_motion=!0,console.warn("No action",t.motion,this)));xt&&console.log("TRANSITION FROM "+(l==null?void 0:l.name)+" TO "+t.name,e,r,c,c==null?void 0:c.getEffectiveTimeScale(),c==null?void 0:c.getEffectiveWeight(),c==null?void 0:c.isRunning(),c==null?void 0:c.isScheduled(),c==null?void 0:c.paused)}createAction(t){var i,n;if(this._mixer.existingAction(t)&&this._mixer.uncacheAction(t,(i=this.animator)==null?void 0:i.gameObject),(n=this.animator)!=null&&n.applyRootMotion){this.rootMotionHandler||(this.rootMotionHandler=new NM(this));const o=this.animator.gameObject;return this.rootMotionHandler.createClip(this._mixer,o,t)}else return this._mixer.clipAction(t)}evaluateCondition(t){const e=this.model.parameters.find(i=>i.name===t.parameter);if(!e)return!1;switch(t.mode){case gr.If:return e.value===!0;case gr.IfNot:return e.value===!1;case gr.Greater:return e.value>t.threshold;case gr.Less:return e.value<t.threshold;case gr.Equals:return e.value===t.threshold;case gr.NotEqual:return e.value!==t.threshold}return!1}createActions(t){var e,i,n,o;xt&&console.log("AnimatorController createActions",this.model);for(const r of this.model.layers){const l=r.stateMachine;for(let c=0;c<l.states.length;c++){const h=l.states[c];h.transitions||(h.transitions=[]);for(const d of h.transitions)d.conditions||(d.conditions=[]);if(h.motion||(xt&&console.warn("No motion",h),h.motion=UM(h.name)),this.animator&&h.motion.clips){const d=(e=h.motion.clips)==null?void 0:e.find(u=>{var f,p;return u.node.name===((p=(f=this.animator)==null?void 0:f.gameObject)==null?void 0:p.name)});d?h.motion.clip=d.clip:(xt||U())&&console.warn('Could not find clip for animator "'+((n=(i=this.animator)==null?void 0:i.gameObject)==null?void 0:n.name)+'"',h.motion.clips.map(u=>u.node.name))}if(!h.motion.clip){xt&&console.warn("No clip assigned to state",h);const d=new Ar(void 0,void 0,[]);h.motion.clip=d}if((o=h.motion)!=null&&o.clip){const d=h.motion.clip;if(d instanceof Ar){const u=this.createAction(d);h.motion.action=u}else(xt||U())&&console.warn("No valid animationclip assigned",h)}if(h.behaviours&&Array.isArray(h.behaviours))for(const d of h.behaviours){if(!(d!=null&&d.typeName))continue;const u=w.get(d.typeName);if(u){const f=new u;f.isStateMachineBehaviour&&(f._context=this.context??void 0,wc(f,d.properties),d.instance=f),xt&&console.log("Created animator controller behaviour",h.name,d.typeName,d.properties,f)}else(xt||U())&&console.warn("Could not find AnimatorBehaviour type: "+d.typeName)}}}}*enumerateActions(){if(this.model.layers)for(const t of this.model.layers){const e=t.stateMachine;for(let i=0;i<e.states.length;i++){const n=e.states[i];n!=null&&n.motion&&(n.motion.action&&(yield n.motion.action),n.motion.action_loopback&&(yield n.motion.action_loopback))}}}}class Zv{constructor(t,e){a(this,"track");a(this,"createdInterpolant");a(this,"originalEvaluate");a(this,"customEvaluate");this.track=t;const i=t,n=i.createInterpolant.bind(t);i.createInterpolant=()=>(i.createInterpolant=n,this.createdInterpolant=n(),this.originalEvaluate=this.createdInterpolant.evaluate.bind(this.createdInterpolant),this.customEvaluate=o=>{if(!this.originalEvaluate)return;const r=this.originalEvaluate(o);return e(o,r)},this.createdInterpolant.evaluate=this.customEvaluate,this.createdInterpolant)}dispose(){this.createdInterpolant&&this.originalEvaluate&&(this.createdInterpolant.evaluate=this.originalEvaluate),this.track=void 0,this.createdInterpolant=null,this.originalEvaluate=void 0,this.customEvaluate=void 0}}const St=class{constructor(t,e,i,n,o){a(this,"_action");a(this,"root");a(this,"clip");a(this,"positionWrapper",null);a(this,"rotationWrapper",null);a(this,"context");a(this,"positionChange",new x);a(this,"rotationChange",new H);a(this,"_prevTime",0);if(this.context=t,this.root=e,this.clip=i,St.firstKeyframeRotation[this.cacheId]||(St.firstKeyframeRotation[this.cacheId]=new H),o){const r=o.values;St.firstKeyframeRotation[this.cacheId].set(r[0],r[1],r[2],r[3])}St.spaceRotation[this.cacheId]||(St.spaceRotation[this.cacheId]=new H),St.effectiveSpaceRotation[this.cacheId]||(St.effectiveSpaceRotation[this.cacheId]=new H),St.clipOffsetRotation[this.cacheId]=new H,o&&St.clipOffsetRotation[this.cacheId].set(o.values[0],o.values[1],o.values[2],o.values[3]).invert(),this.handlePosition(i,n),this.handleRotation(i,o)}set action(t){this._action=t}get action(){return this._action}get cacheId(){return this.root.uuid}onStart(t){if(t.getClip()!==this.clip)return;St.lastObjRotation[this.cacheId]||(St.lastObjRotation[this.cacheId]=this.root.quaternion.clone());const e=St.lastObjRotation[this.cacheId];if(St.spaceRotation[this.cacheId].copy(e),Ru){const i=new di().setFromQuaternion(e);console.log("START",this.clip.name,W.toDegrees(i.y),this.root.position.z)}}getClipRotationOffset(){return St.clipOffsetRotation[this.cacheId]}handlePosition(t,e){if(e){const i=this.root;Ru&&i.add(new ln),St.lastObjPosition[this.cacheId]||(St.lastObjPosition[this.cacheId]=this.root.position.clone());const n=new x,o=new x;this.positionWrapper=new Zv(e,(r,l)=>{const c=this.action.getEffectiveWeight();return Ru&&i.position.length()>8&&i.position.set(0,i.position.y,0),r>this._prevTime&&(n.set(l[0],l[1],l[2]),n.sub(o),n.multiplyScalar(c),n.applyQuaternion(this.getClipRotationOffset()),n.applyQuaternion(i.quaternion),this.positionChange.copy(n)),o.fromArray(l),this._prevTime=r,l[0]=0,l[1]=0,l[2]=0,l})}}handleRotation(t,e){if(e){if(Ru){const r=e.values,l=new di().setFromQuaternion(new H(r[0],r[1],r[2],r[3]));console.log(t.name,e.name,"FIRST ROTATION IN TRACK",W.toDegrees(l.y));const c=e.values.length-4,h=new H().set(r[c],r[c+1],r[c+2],r[c+3]),d=new di().setFromQuaternion(h);console.log(t.name,e.name,"LAST ROTATION IN TRACK",W.toDegrees(d.y))}let i=0;const n=new H,o=new H;this.rotationWrapper=new Zv(e,(r,l)=>(r>i&&(o.set(l[0],l[1],l[2],l[3]),n.invert(),o.multiply(n),this.rotationChange.copy(o)),n.fromArray(l),i=r,l[0]=0,l[1]=0,l[2]=0,l[3]=1,l))}}onBeforeUpdate(t){this.positionChange.set(0,0,0),this.rotationChange.set(0,0,0,1)}onAfterUpdate(t){return!this.action||(t*=this.action.getEffectiveWeight(),t<=0)?!1:(this.positionChange.multiplyScalar(t),this.rotationChange.slerp(St.identityQuaternion,1-t),!0)}};let gs=St;a(gs,"lastObjPosition",{}),a(gs,"lastObjRotation",{}),a(gs,"firstKeyframeRotation",{}),a(gs,"spaceRotation",{}),a(gs,"effectiveSpaceRotation",{}),a(gs,"clipOffsetRotation",{}),a(gs,"identityQuaternion",new H);class NM{constructor(t){a(this,"controller");a(this,"handler",[]);a(this,"root");a(this,"basePosition",new x);a(this,"baseQuaternion",new H);a(this,"baseRotation",new di);a(this,"summedPosition",new x);a(this,"summedRotation",new H);this.controller=t}createClip(t,e,i){this.root=e,e&&"name"in e&&e.name;const n=this.findRootTrack(i,".position"),o=this.findRootTrack(i,".quaternion"),r=new gs(this.controller.context,e,i,n,o);this.handler.push(r);const l=t.clipAction(i);return r.action=l,l}onStart(t){for(const e of this.handler)e.onStart(t)}onBeforeUpdate(t){this.basePosition.copy(this.root.position),this.baseQuaternion.copy(this.root.quaternion);for(const e of this.handler)e.onBeforeUpdate(t)}onAfterUpdate(t){if(!(t<=0)){this.root.position.copy(this.basePosition),this.root.quaternion.copy(this.baseQuaternion),this.summedPosition.set(0,0,0),this.summedRotation.set(0,0,0,1);for(const e of this.handler)e.onAfterUpdate(t)&&(this.summedPosition.add(e.positionChange),this.summedRotation.multiply(e.rotationChange));this.root.position.add(this.summedPosition),this.root.quaternion.multiply(this.summedRotation)}}findRootTrack(t,e){const i=t.tracks;if(!i)return null;for(const n of i)if(n.name.endsWith(e))return n;return null}}class $M extends Fn{onSerialize(t,e){}onDeserialize(t,e){if(e.type===An&&(t==null?void 0:t.__type)==="AnimatorController")return new An(t)}}new $M(An);var Gp=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const vn=C("debuganimator");class pi extends j{constructor(){super(...arguments);a(this,"applyRootMotion",!1);a(this,"hasRootMotion",!1);a(this,"keepAnimatorControllerStateOnDisable",!1);a(this,"_parametersAreDirty",!1);a(this,"_isDirty",!1);a(this,"_speed",1);a(this,"_normalizedStartOffset",0);a(this,"_animatorController",null);a(this,"_initializeWithRuntimeAnimatorController")}get isAnimationComponent(){return!0}set runtimeAnimatorController(e){var i;this._animatorController&&this._animatorController.model===e||(e?e instanceof An?(e.animator&&e.animator!==this&&(console.warn("AnimatorController can not be bound to multiple animators",(i=e.model)==null?void 0:i.name),e.model||console.error("AnimatorController has no model"),e=new An(e.model)),this._animatorController=e,this._animatorController.bind(this)):(vn&&console.log("Assign animator controller",e,this),this._animatorController=new An(e),this.__didAwake&&this._animatorController.bind(this)):this._animatorController=null)}get runtimeAnimatorController(){return this._animatorController}getCurrentStateInfo(){var e;return(e=this.runtimeAnimatorController)==null?void 0:e.getCurrentStateInfo()}get currentAction(){var e;return((e=this.runtimeAnimatorController)==null?void 0:e.currentAction)||null}get parametersAreDirty(){return this._parametersAreDirty}get isDirty(){return this._isDirty}Play(e,i=-1,n=Number.NEGATIVE_INFINITY,o=0){this.play(e,i,n,o)}play(e,i=-1,n=Number.NEGATIVE_INFINITY,o=0){var r;(r=this.runtimeAnimatorController)==null||r.play(e,i,n,o),this._isDirty=!0}Reset(){this.reset()}reset(){var e;(e=this._animatorController)==null||e.reset(),this._isDirty=!0}SetBool(e,i){this.setBool(e,i)}setBool(e,i){var n,o;vn&&console.log("setBool",e,i),((n=this.runtimeAnimatorController)==null?void 0:n.getBool(e))!==i&&(this._parametersAreDirty=!0),(o=this.runtimeAnimatorController)==null||o.setBool(e,i)}GetBool(e){return this.getBool(e)}getBool(e){var n;const i=((n=this.runtimeAnimatorController)==null?void 0:n.getBool(e))??!1;return vn&&console.log("getBool",e,i),i}toggleBool(e){this.setBool(e,!this.getBool(e))}SetFloat(e,i){this.setFloat(e,i)}setFloat(e,i){var n,o;((n=this.runtimeAnimatorController)==null?void 0:n.getFloat(e))!==i&&(this._parametersAreDirty=!0),vn&&console.log("setFloat",e,i),(o=this.runtimeAnimatorController)==null||o.setFloat(e,i)}GetFloat(e){return this.getFloat(e)}getFloat(e){var n;const i=((n=this.runtimeAnimatorController)==null?void 0:n.getFloat(e))??-1;return vn&&console.log("getFloat",e,i),i}SetInteger(e,i){this.setInteger(e,i)}setInteger(e,i){var n,o;((n=this.runtimeAnimatorController)==null?void 0:n.getInteger(e))!==i&&(this._parametersAreDirty=!0),vn&&console.log("setInteger",e,i),(o=this.runtimeAnimatorController)==null||o.setInteger(e,i)}GetInteger(e){return this.getInteger(e)}getInteger(e){var n;const i=((n=this.runtimeAnimatorController)==null?void 0:n.getInteger(e))??-1;return vn&&console.log("getInteger",e,i),i}SetTrigger(e){this.setTrigger(e)}setTrigger(e){var i;this._parametersAreDirty=!0,vn&&console.log("setTrigger",e),(i=this.runtimeAnimatorController)==null||i.setTrigger(e)}ResetTrigger(e){this.resetTrigger(e)}resetTrigger(e){var i;this._parametersAreDirty=!0,vn&&console.log("resetTrigger",e),(i=this.runtimeAnimatorController)==null||i.resetTrigger(e)}GetTrigger(e){this.getTrigger(e)}getTrigger(e){var n;const i=(n=this.runtimeAnimatorController)==null?void 0:n.getTrigger(e);return vn&&console.log("getTrigger",e,i),i}IsInTransition(){return this.isInTransition()}isInTransition(){var e;return((e=this.runtimeAnimatorController)==null?void 0:e.isInTransition())??!1}SetSpeed(e){return this.setSpeed(e)}setSpeed(e){var i;e!==this._speed&&(vn&&console.log("setSpeed",e),this._speed=e,((i=this._animatorController)==null?void 0:i.animator)==this&&this._animatorController.setSpeed(e))}set minMaxSpeed(e){var i;this._speed=W.lerp(e.x,e.y,Math.random()),((i=this._animatorController)==null?void 0:i.animator)==this&&this._animatorController.setSpeed(this._speed)}set minMaxOffsetNormalized(e){var i;this._normalizedStartOffset=W.lerp(e.x,e.y,Math.random()),((i=this.runtimeAnimatorController)==null?void 0:i.animator)==this&&(this.runtimeAnimatorController.normalizedStartOffset=this._normalizedStartOffset)}awake(){vn&&console.log("ANIMATOR",this.name,this),this.gameObject&&this.initializeRuntimeAnimatorController()}initializeRuntimeAnimatorController(e=!1){const i=e||this.runtimeAnimatorController!==this._initializeWithRuntimeAnimatorController;if(this.runtimeAnimatorController&&i){const n=this.runtimeAnimatorController.clone();this._initializeWithRuntimeAnimatorController=n,n?(console.assert(this.runtimeAnimatorController!==n),this.runtimeAnimatorController=n,console.assert(this.runtimeAnimatorController===n),this.runtimeAnimatorController.bind(this),this.runtimeAnimatorController.setSpeed(this._speed),this.runtimeAnimatorController.normalizedStartOffset=this._normalizedStartOffset):console.warn("Could not clone animator controller",this.runtimeAnimatorController)}}onDisable(){var e;this.keepAnimatorControllerStateOnDisable||(e=this._animatorController)==null||e.reset()}onBeforeRender(){this._isDirty=!1,this._parametersAreDirty=!1,!zM(this.gameObject)&&this._animatorController&&this._animatorController.update(1)}}Gp([m()],pi.prototype,"applyRootMotion",void 0);Gp([m()],pi.prototype,"hasRootMotion",void 0);Gp([m()],pi.prototype,"keepAnimatorControllerStateOnDisable",void 0);Gp([m()],pi.prototype,"runtimeAnimatorController",null);const ex=Symbol("previous-visibility"),Hl=class extends No{render(t,e,i){if("addPass"in i)this._unsupported_effectcomposer_warning||(console.warn("RenderTexture.render() does not yet support EffectComposer"),this._unsupported_effectcomposer_warning=!0);else if(i instanceof Qa){this.onBeforeRender();const o=i.getRenderTarget(),r=i.xr.enabled;i.xr.enabled=!1,i.setRenderTarget(this),i.clear(!0,!0,!0),i.render(t,e),i.setRenderTarget(o),i.xr.enabled=r,this.onAfterRender()}}onBeforeRender(){Hl._userSet.clear();const t=iC(this.texture,!0,null,Hl._userSet);for(const e of t)e instanceof Z&&(e[ex]=e.visible,e.visible=!1)}onAfterRender(){for(const t of Hl._userSet)t instanceof Z&&(t.visible=t[ex]);Hl._userSet.clear()}};let ja=Hl;a(ja,"_userSet",new Set);var Wd=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const Ou=C("debuggroundprojection");class Xo extends j{constructor(){super(...arguments);a(this,"applyOnAwake",!1);a(this,"autoFit",!0);a(this,"_radius",50);a(this,"_height",3);a(this,"_arblending",0);a(this,"_lastBackground");a(this,"_lastRadius");a(this,"_lastHeight");a(this,"_projection");a(this,"_watcher");a(this,"_needsTextureUpdate",!1);a(this,"_blurrynessShader",null);a(this,"_lastBlurriness",-1)}set radius(e){this._radius=e,this._projection&&this.updateProjection()}get radius(){return this._radius}set height(e){this._height=e,this._projection&&this.updateProjection()}get height(){return this._height}set arBlending(e){this._arblending=e,this._needsTextureUpdate=!0}get arBlending(){return this._arblending}awake(){this.applyOnAwake&&this.updateAndCreate()}onEnable(){this.context.time.frameCount>0&&this.applyOnAwake&&this.updateAndCreate(),this._watcher||(this._watcher=new Ir(this.context.scene,"background"),this._watcher.subscribeWrite(e=>{Ou&&console.log("Background changed",this.context.scene.background),this._needsTextureUpdate=!0}))}onDisable(){var e,i;(e=this._watcher)==null||e.revoke(),(i=this._projection)==null||i.removeFromParent()}onEnterXR(){this.activeAndEnabled&&(this._needsTextureUpdate=!0,this.updateProjection())}async onLeaveXR(){this.activeAndEnabled&&(await Ep(1),this.updateProjection())}onBeforeRender(){this._projection&&this.scene.backgroundRotation&&this._projection.rotation.copy(this.scene.backgroundRotation),this.context.scene.backgroundBlurriness!==void 0&&this._lastBlurriness!=this.context.scene.backgroundBlurriness&&this.context.scene.backgroundBlurriness>.001?this.updateProjection():this._needsTextureUpdate&&this.context.scene.background instanceof Je&&this.updateBlurriness(this.context.scene.background,this.context.scene.backgroundBlurriness)}updateAndCreate(){var e;this.updateProjection(),(e=this._watcher)==null||e.apply()}updateProjection(){var r,l,c,h,d,u;if(!this.context.scene.background){(r=this._projection)==null||r.removeFromParent();return}const e=this.context.scene.background;if(!(e instanceof Je)){(l=this._projection)==null||l.removeFromParent();return}if(((c=this.context.xr)!=null&&c.isPassThrough||(h=this.context.xr)!=null&&h.isAR)&&this.arBlending===0){(d=this._projection)==null||d.removeFromParent();return}if(!this.gameObject||this.destroyed)return;let i=!0;const n=0,o=e!==this._lastBackground||this._height!==this._lastHeight||this._radius!==this._lastRadius;if(!this._projection||o){Ou&&console.log("Create/Update Ground Projection",e.name),(u=this._projection)==null||u.removeFromParent();try{this._projection=new yc(e,this._height,this._radius,64)}catch(f){console.error("Error creating three GroundProjection",f);return}this._projection.position.y=this._height-n,this._projection.name="GroundProjection",$w(this._projection,!1)}else i=!1;if(this._projection.parent||this.gameObject.add(this._projection),this.autoFit&&i){this._projection.updateWorldMatrix(!0,!0);const f=dn(this.context.scene.children,[this._projection]),p=f.min.y;if(p<1/0){const g=Q();g.x=f.min.x+(f.max.x-f.min.x)*.5;const y=pt(this.gameObject).x;g.y=p+this._height*y-n,g.z=f.min.z+(f.max.z-f.min.z)*.5,jt(this._projection,g)}Ou&&G.DrawWireBox3(f,65280,5)}this.context.scene.backgroundBlurriness>.001&&this._needsTextureUpdate&&this.updateBlurriness(e,this.context.scene.backgroundBlurriness),this._lastBackground=e,this._lastHeight=this._height,this._lastRadius=this._radius,this._needsTextureUpdate=!1}updateBlurriness(e,i){var o;if(this._projection){if(!e)return}else return;this._needsTextureUpdate=!1,Ou&&console.log("Update Blurriness",i),this._blurrynessShader??(this._blurrynessShader=new os({name:"GroundProjectionBlurriness",uniforms:{map:{value:e},blurriness:{value:i},blending:{value:0},alphaFactor:{value:1}},vertexShader:WM,fragmentShader:VM})),this._blurrynessShader.depthWrite=!1,this._blurrynessShader.uniforms.map.value=e,this._blurrynessShader.uniforms.blurriness.value=1,this._lastBlurriness=i,e.needsUpdate=!0;const n=this._projection.material.transparent;this._projection.material.transparent=(((o=this.context.xr)==null?void 0:o.isAR)===!0&&this.arBlending>1e-6)??!1,this._projection.material.transparent?this._blurrynessShader.uniforms.blending.value=this.arBlending:this._blurrynessShader.uniforms.blending.value=0,this.context.isInPassThrough?this._blurrynessShader.uniforms.alphaFactor.value=.95:this._blurrynessShader.uniforms.alphaFactor.value=1,n!==this._projection.material.transparent&&(this._projection.material.needsUpdate=!0),this._projection.material.map=qn.copyTexture(e,this._blurrynessShader),this._projection.material.depthTest=!0,this._projection.material.depthWrite=!1}}Wd([m()],Xo.prototype,"applyOnAwake",void 0);Wd([m()],Xo.prototype,"autoFit",void 0);Wd([m()],Xo.prototype,"radius",null);Wd([m()],Xo.prototype,"height",null);Wd([m()],Xo.prototype,"arBlending",null);const WM=`
  varying vec2 vUv;

  void main() {
    vUv = uv;
    gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
  }
`,VM=`
  uniform sampler2D map;
  uniform float blurriness;
  uniform float alphaFactor;
  uniform float blending;
  varying vec2 vUv;

  const float PI = 3.14159265359;

  // Gaussian function
  float gaussian(float x, float sigma) {
    return exp(-(x * x) / (2.0 * sigma * sigma)) / (sqrt(2.0 * PI) * sigma);
  }

  // Custom smoothstep function for desired falloff
  float customSmoothstep(float edge0, float edge1, float x) {
    float t = clamp((x - edge0) / (edge1 - edge0), 0.0, 1.0);
    return t * t * (3.0 - 2.0 * t);
  }

  void main() {
    vec2 center = vec2(0.0, 0.0);
    vec2 pos = vUv;
    pos.x = 0.0; // Only consider vertical distance
    float distance = length(pos - center);
    
    // Calculate blur amount based on custom falloff
    float blurAmount = customSmoothstep(0.5, 1.0, distance * 2.0);
    blurAmount = clamp(blurAmount, 0.0, 1.0); // Ensure blur amount is within valid range

    // Gaussian blur
    vec2 pixelSize = 1.0 / vec2(textureSize(map, 0));
    vec4 color = vec4(0.0);
    float totalWeight = 0.0;
    int blurSize = int(60.0 * min(1.0, blurriness) * blurAmount); // Adjust blur size based on distance and blurriness
    float lodLevel = log2(float(blurSize)) * 0.5; // Compute LOD level

    for (int x = -blurSize; x <= blurSize; x++) {
        for (int y = -blurSize; y <= blurSize; y++) {
            vec2 offset = vec2(float(x), float(y)) * pixelSize * blurAmount;
            float weight = gaussian(length(vec2(float(x), float(y))), 1000.0 * blurAmount); // Use a fixed sigma value
            color += textureLod(map, vUv + offset, lodLevel) * weight;
            totalWeight += weight;
        }
    }

    color = totalWeight > 0.0 ? color / totalWeight : texture2D(map, vUv);

    gl_FragColor = color;

    float brightness = dot(gl_FragColor.rgb, vec3(0.299, 0.587, 0.114));
    float stepFactor = blending - brightness * .1;
    gl_FragColor.a = pow(1.0 - blending * customSmoothstep(0.35 * stepFactor, 0.45 * stepFactor, distance), 5.);
    gl_FragColor.a *= alphaFactor;
    // gl_FragColor.rgb = vec3(1.0);

    // #include <tonemapping_fragment>
    // #include <colorspace_fragment>
    
    // Uncomment to visualize blur amount
    // gl_FragColor = vec4(blurAmount, 0.0, 0.0, 1.0);
  }
`;var tb=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};class Dc extends j{constructor(){super(...arguments);a(this,"constraintActive",!0);a(this,"locked",!1);a(this,"sources",[])}}tb([m()],Dc.prototype,"constraintActive",void 0);tb([m()],Dc.prototype,"locked",void 0);tb([m(F)],Dc.prototype,"sources",void 0);function BC(s,t){return qo(s,me.ContextCreated,t),()=>qr(s,me.ContextCreated)}function HM(s,t){return qo(s,me.ContextClearing,t),()=>qr(s,me.ContextClearing)}function GM(s,t){return qo(s,me.ContextDestroying,t),()=>qr(s,me.ContextDestroying)}function FC(s,t){return qo(s,oe.Start,t),()=>qr(s,oe.Start)}function zC(s,t){return qo(s,oe.Update,t),()=>qr(s,oe.Update)}function qM(s,t){return qo(s,oe.OnBeforeRender,t),()=>qr(s,oe.OnBeforeRender)}function XM(s,t){return qo(s,oe.OnAfterRender,t),()=>qr(s,oe.OnAfterRender)}let Ba=class{constructor(){a(this,"bb",null);a(this,"bb_pos",0)}__init(t,e){return this.bb_pos=t,this.bb=e,this}x(){return this.bb.readFloat32(this.bb_pos)}y(){return this.bb.readFloat32(this.bb_pos+4)}z(){return this.bb.readFloat32(this.bb_pos+8)}static sizeOf(){return 12}static createVec3(t,e,i,n){return t.prep(4,12),t.writeFloat32(n),t.writeFloat32(i),t.writeFloat32(e),t.offset()}};class UC{constructor(){a(this,"bb",null);a(this,"bb_pos",0)}__init(t,e){return this.bb_pos=t,this.bb=e,this}position(t){return(t||new Ba).__init(this.bb_pos,this.bb)}rotation(t){return(t||new Ba).__init(this.bb_pos+12,this.bb)}scale(t){return(t||new Ba).__init(this.bb_pos+24,this.bb)}static sizeOf(){return 36}static createTransform(t,e,i,n,o,r,l,c,h,d){return t.prep(4,36),t.prep(4,12),t.writeFloat32(d),t.writeFloat32(h),t.writeFloat32(c),t.prep(4,12),t.writeFloat32(l),t.writeFloat32(r),t.writeFloat32(o),t.prep(4,12),t.writeFloat32(n),t.writeFloat32(i),t.writeFloat32(e),t.offset()}}class xo{constructor(){a(this,"bb",null);a(this,"bb_pos",0)}__init(t,e){return this.bb_pos=t,this.bb=e,this}static getRootAsSyncedTransformModel(t,e){return(e||new xo).__init(t.readInt32(t.position())+t.position(),t)}static getSizePrefixedRootAsSyncedTransformModel(t,e){return t.setPosition(t.position()+F_),(e||new xo).__init(t.readInt32(t.position())+t.position(),t)}guid(t){const e=this.bb.__offset(this.bb_pos,4);return e?this.bb.__string(this.bb_pos+e,t):null}fast(){const t=this.bb.__offset(this.bb_pos,6);return t?!!this.bb.readInt8(this.bb_pos+t):!1}transform(t){const e=this.bb.__offset(this.bb_pos,8);return e?(t||new UC).__init(this.bb_pos+e,this.bb):null}dontSave(){const t=this.bb.__offset(this.bb_pos,10);return t?!!this.bb.readInt8(this.bb_pos+t):!1}static startSyncedTransformModel(t){t.startObject(4)}static addGuid(t,e){t.addFieldOffset(0,e,0)}static addFast(t,e){t.addFieldInt8(1,+e,0)}static addTransform(t,e){t.addFieldStruct(2,e,0)}static addDontSave(t,e){t.addFieldInt8(3,+e,0)}static endSyncedTransformModel(t){return t.endObject()}static finishSyncedTransformModelBuffer(t,e){t.finish(e)}static finishSizePrefixedSyncedTransformModelBuffer(t,e){t.finish(e,void 0,!0)}}var z;(function(s){(function(t){t.MAYBEMODULE=null;const e=[];function i(){return t.MODULE?Promise.resolve(t.MODULE):new Promise(o=>{e.push(o)})}t.ready=i;async function n(){if(t.MODULE)return t.MODULE;const o=await ts(()=>import("./rapier3d.787eda45.js"),[],import.meta.url);return t.MODULE=o,t.MAYBEMODULE=o,e.forEach(r=>r(o)),e.length=0,o}t.load=n})(s.RAPIER_PHYSICS||(s.RAPIER_PHYSICS={})),function(t){t.MAYBEMODULE=null;const e=[];function i(){return t.MODULE?Promise.resolve(t.MODULE):new Promise(o=>{e.push(o)})}t.ready=i;async function n(){if(t.MODULE)return t.MODULE;const o=await ts(()=>import("./postprocessing.e3fc0158.js"),["./postprocessing.e3fc0158.js","./three@0.169.5.js"],import.meta.url);return t.MODULE=o,t.MAYBEMODULE=o,e.forEach(r=>r(o)),e.length=0,o}t.load=n}(s.POSTPROCESSING||(s.POSTPROCESSING={})),function(t){t.MAYBEMODULE=null;const e=[];function i(){return t.MODULE?Promise.resolve(t.MODULE):new Promise(o=>{e.push(o)})}t.ready=i;async function n(){if(t.MODULE)return t.MODULE;const o=await ts(()=>import("./postprocessing.ao.54b5d37f.js"),["./postprocessing.ao.54b5d37f.js","./three@0.169.5.js","./three-examples.d909655c.js","./postprocessing.e3fc0158.js"],import.meta.url);return t.MODULE=o,t.MAYBEMODULE=o,e.forEach(r=>r(o)),e.length=0,o}t.load=n}(s.POSTPROCESSING_AO||(s.POSTPROCESSING_AO={}))})(z||(z={}));var Tt;(function(s){s[s.Average=0]="Average",s[s.Multiply=1]="Multiply",s[s.Minimum=2]="Minimum",s[s.Maximum=3]="Maximum"})(Tt||(Tt={}));var Lf;(function(s){s[s.Discrete=0]="Discrete",s[s.Continuous=1]="Continuous"})(Lf||(Lf={}));var ct;(function(s){s[s.None=0]="None",s[s.FreezePositionX=2]="FreezePositionX",s[s.FreezePositionY=4]="FreezePositionY",s[s.FreezePositionZ=8]="FreezePositionZ",s[s.FreezePosition=14]="FreezePosition",s[s.FreezeRotationX=16]="FreezeRotationX",s[s.FreezeRotationY=32]="FreezeRotationY",s[s.FreezeRotationZ=64]="FreezeRotationZ",s[s.FreezeRotation=112]="FreezeRotation",s[s.FreezeAll=126]="FreezeAll"})(ct||(ct={}));var Bl;(function(s){s[s.None=0]="None",s[s.X=2]="X",s[s.Y=4]="Y",s[s.Z=8]="Z",s[s.All=-1]="All"})(Bl||(Bl={}));const mi=function(s,t){return function(e,i,n){QM(e,i,n,s,t)}};function QM(s,t,e,i,n){if(!n&&!i&&!s.onValidate)return;if(e!==void 0){console.error("Invalid usage of validate decorator. Only fields can be validated.",s,t,e),tt("Invalid usage of validate decorator. Only fields can be validated. Property: "+t,_t.Error);return}let o="";if(typeof t=="string"?o=t:o=t.name,s.__internalAwake){const r=Symbol(o),l=s.__internalAwake;s.__internalAwake=function(){var c;if(!this.onValidate){U()&&console.warn('Usage of @validate decorate detected but there is no onValidate method in your class: "'+((c=s.constructor)==null?void 0:c.name)+'"');return}if(this[r]===void 0){this[r]=this[o];const h=this[o];if(h instanceof ce||h instanceof x||h instanceof xe||h instanceof H){const d=this[o];A_(d,()=>{this.onValidate(o)})}Object.defineProperty(this,o,{set:function(d){var u;if(this[Ny]===!0)this[r]=d;else{i==null||i.call(this,d);const f=this[r];this[r]=d,(u=this.onValidate)==null||u.call(this,o,f)}},get:function(){return n==null||n.call(this),this[r]}})}l.call(this)}}}const IL=function(s){return function(t,e,i){let n="";typeof e=="string"?n=e:n=e.name;const o=s.prototype,r=Object.getOwnPropertyDescriptor(o,n);if(!(r!=null&&r.value)){console.warn("Can not apply prefix: type does not have method named",e,s);return}const l=r.value,c=t[n];Object.defineProperty(o,n,{value:function(...h){const d=c==null?void 0:c.call(this,...h);if(d instanceof Promise){d.then(u=>{if(u!==!1)return l.call(this,...h)});return}if(d!==!1)return l.call(this,...h)}})}};var un=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};class YM{constructor(t,e){a(this,"positionChanged",!1);a(this,"rotationChanged",!1);a(this,"position");a(this,"quaternion");a(this,"_positionKeys",["x","y","z"]);a(this,"_quaternionKeys",["_x","_y","_z","_w"]);a(this,"mute",!1);a(this,"context");a(this,"obj");a(this,"_positionWatch");a(this,"_rotationWatch");this.context=e,this.obj=t}get isDirty(){return this.positionChanged||this.rotationChanged}reset(t=!1){if(this.positionChanged=!1,this.rotationChanged=!1,this.mute=!1,t){if(this.position)for(const e of this._positionKeys)delete this.position[e];if(this.quaternion)for(const e of this._quaternionKeys)delete this.quaternion[e]}}syncValues(){for(const t of this._positionKeys)this.position[t]=this.obj.position[t];for(const t of this._quaternionKeys)this.quaternion[t]=this.obj.quaternion[t]}applyValues(){if(this.positionChanged&&this.position)for(const t of this._positionKeys){const e=this.position[t];e!==void 0&&(this.obj.position[t]=e)}if(this.rotationChanged&&this.quaternion)for(const t of this._quaternionKeys){const e=this.quaternion[t];e!==void 0&&(this.obj.quaternion[t]=e)}}start(t,e){this.reset(),t&&(this._positionWatch||(this._positionWatch=new Ir(this.obj.position,["x","y","z"])),this._positionWatch.apply(),this.position={},this._positionWatch.subscribeWrite((o,r)=>{var c;if((c=this.context.physics.engine)!=null&&c.isUpdating||this.mute)return;const l=this.position[r];Math.abs(l-o)<1e-5||(this.position[r]=o,this.positionChanged=!0)})),e&&(this._rotationWatch||(this._rotationWatch=new Ir(this.obj.quaternion,["_x","_y","_z","_w"])),this._rotationWatch.apply(),this.quaternion={},this._rotationWatch.subscribeWrite((o,r)=>{var c;if((c=this.context.physics.engine)!=null&&c.isUpdating||this.mute)return;const l=this.quaternion[r];Math.abs(l-o)<1e-5||(this.quaternion[r]=o,this.rotationChanged=!0)}));const i=this.obj.matrixWorld.multiplyMatrices.bind(this.obj.matrixWorld),n=new le;this.obj.matrixWorld.multiplyMatrices=(o,r)=>{var l;return(l=this.context.physics.engine)!=null&&l.isUpdating||this.mute||n.equals(o)||(this.positionChanged=!0,this.rotationChanged=!0,n.copy(o)),i(o,r)}}stop(){var t,e;(t=this._positionWatch)==null||t.revoke(),(e=this._rotationWatch)==null||e.revoke()}}const hd=class extends j{constructor(){super(...arguments);a(this,"autoMass",!0);a(this,"_mass",0);a(this,"useGravity",!0);a(this,"centerOfMass",new x(0,0,0));a(this,"constraints",ct.None);a(this,"isKinematic",!1);a(this,"drag",0);a(this,"angularDrag",1);a(this,"detectCollisions",!0);a(this,"sleepThreshold",.01);a(this,"collisionDetectionMode",Lf.Discrete);a(this,"_gravityScale",1);a(this,"dominanceGroup",0);a(this,"_propertiesChanged",!1);a(this,"_currentVelocity",new x);a(this,"_smoothedVelocity",new x);a(this,"_smoothedVelocityGetter",new x);a(this,"_lastPosition",new x);a(this,"_watch")}get isRigidbody(){return!0}set mass(e){e!==this._mass&&(this._mass=e,this._propertiesChanged=!0,this.__didAwake&&(this.autoMass=!1))}get mass(){var e,i;return this.autoMass?((i=(e=this.context.physics.engine)==null?void 0:e.getBody(this))==null?void 0:i.mass())??-1:this._mass}get lockPositionX(){return(this.constraints&ct.FreezePositionX)!==0}get lockPositionY(){return(this.constraints&ct.FreezePositionY)!==0}get lockPositionZ(){return(this.constraints&ct.FreezePositionZ)!==0}get lockRotationX(){return(this.constraints&ct.FreezeRotationX)!==0}get lockRotationY(){return(this.constraints&ct.FreezeRotationY)!==0}get lockRotationZ(){return(this.constraints&ct.FreezeRotationZ)!==0}set lockPositionX(e){e?this.constraints|=ct.FreezePositionX:this.constraints&=~ct.FreezePositionX}set lockPositionY(e){e?this.constraints|=ct.FreezePositionY:this.constraints&=~ct.FreezePositionY}set lockPositionZ(e){e?this.constraints|=ct.FreezePositionZ:this.constraints&=~ct.FreezePositionZ}set lockRotationX(e){e?this.constraints|=ct.FreezeRotationX:this.constraints&=~ct.FreezeRotationX}set lockRotationY(e){e?this.constraints|=ct.FreezeRotationY:this.constraints&=~ct.FreezeRotationY}set lockRotationZ(e){e?this.constraints|=ct.FreezeRotationZ:this.constraints&=~ct.FreezeRotationZ}set gravityScale(e){this._gravityScale=e}get gravityScale(){return this._gravityScale}awake(){this._watch=void 0,this._propertiesChanged=!1}onEnable(){this._watch||(this._watch=new YM(this.gameObject,this.context)),this._watch.start(!0,!0),this.startCoroutine(this.beforePhysics(),oe.LateUpdate),U()&&(globalThis.true?z.RAPIER_PHYSICS.ready().then(async()=>{var e;await Ep(3),(e=this.context.physics.engine)!=null&&e.getBody(this)||console.warn(`Rigidbody could not be created. Ensure "${this.name}" has a Collider component.`)}):console.warn("Rigidbody could not be created: Rapier physics are explicitly disabled."))}onDisable(){var e,i;(e=this._watch)==null||e.stop(),(i=this.context.physics.engine)==null||i.removeBody(this)}onDestroy(){var e;(e=this.context.physics.engine)==null||e.removeBody(this)}onValidate(){this._propertiesChanged=!0}*beforePhysics(){var e,i,n,o;for(;;)this._propertiesChanged&&(this._propertiesChanged=!1,(e=this.context.physics.engine)==null||e.updateProperties(this)),(i=this._watch)!=null&&i.isDirty?(this._watch.mute=!0,this._watch.applyValues(),(n=this.context.physics.engine)==null||n.updateBody(this,this._watch.positionChanged,this._watch.rotationChanged),this._watch.reset()):(o=this._watch)==null||o.syncValues(),this.captureVelocity(),yield}teleport(e,i=!0){var n;(n=this._watch)==null||n.reset(!0),i?this.gameObject.position.set(e.x,e.y,e.z):this.setWorldPosition(e.x,e.y,e.z),this.resetForcesAndTorques(),this.resetVelocities()}resetForces(e=!0){var i;(i=this.context.physics.engine)==null||i.resetForces(this,e)}resetTorques(e=!0){var i;(i=this.context.physics.engine)==null||i.resetTorques(this,e)}resetVelocities(){this.setVelocity(0,0,0),this.setAngularVelocity(0,0,0)}resetForcesAndTorques(){this.resetForces(),this.resetTorques()}wakeUp(){var e;(e=this.context.physics.engine)==null||e.wakeup(this)}get isSleeping(){var e;return(e=this.context.physics.engine)==null?void 0:e.isSleeping(this)}updateProperties(){var e;return this._propertiesChanged=!1,(e=this.context.physics.engine)==null?void 0:e.updateProperties(this)}applyForce(e,i,n=!0){var o;this._propertiesChanged&&this.updateProperties(),(o=this.context.physics.engine)==null||o.addForce(this,e,n)}applyImpulse(e,i=!0){var n;this._propertiesChanged&&this.updateProperties(),(n=this.context.physics.engine)==null||n.applyImpulse(this,e,i)}setForce(e,i,n,o=!0){var r,l,c;(r=this.context.physics.engine)==null||r.resetForces(this,o),typeof e=="number"?(i??(i=0),n??(n=0),(l=this.context.physics.engine)==null||l.addForce(this,{x:e,y:i,z:n},o)):(c=this.context.physics.engine)==null||c.addForce(this,e,o)}getVelocity(){var i;const e=(i=this.context.physics.engine)==null?void 0:i.getLinearVelocity(this);return e?(this._currentVelocity.x=e.x,this._currentVelocity.y=e.y,this._currentVelocity.z=e.z,this._currentVelocity):this._currentVelocity.set(0,0,0)}setVelocity(e,i,n,o=!0){var r,l;if(e instanceof x){const c=e;(r=this.context.physics.engine)==null||r.setLinearVelocity(this,c,o);return}i===void 0||n===void 0||(l=this.context.physics.engine)==null||l.setLinearVelocity(this,{x:e,y:i,z:n},o)}getAngularVelocity(){var i;const e=(i=this.context.physics.engine)==null?void 0:i.getAngularVelocity(this);return e?(this._currentVelocity.x=e.x,this._currentVelocity.y=e.y,this._currentVelocity.z=e.z,this._currentVelocity):this._currentVelocity.set(0,0,0)}setAngularVelocity(e,i,n,o=!0){var r,l;if(typeof e=="object"){const c=e;(r=this.context.physics.engine)==null||r.setAngularVelocity(this,c,o);return}if(i===void 0||n===void 0||typeof i=="boolean"){console.warn("setAngularVelocity expects either a Vec3 or 3 numbers");return}(l=this.context.physics.engine)==null||l.setAngularVelocity(this,{x:e,y:i,z:n},o)}setTorque(e,i,n){typeof e=="number"?this.setAngularVelocity(e,i,n):this.setAngularVelocity(e)}get smoothedVelocity(){return this._smoothedVelocityGetter.copy(this._smoothedVelocity),this._smoothedVelocityGetter.multiplyScalar(1/this.context.time.deltaTime)}setBodyFromGameObject(e=null){}captureVelocity(){const e=this.gameObject.matrixWorld;hd.tempPosition.setFromMatrixPosition(e);const i=hd.tempPosition.sub(this._lastPosition);this._lastPosition.copy(hd.tempPosition),this._smoothedVelocity.lerp(i,this.context.time.deltaTime/.1)}};let ve=hd;a(ve,"tempPosition",new x);un([mi()],ve.prototype,"autoMass",void 0);un([m()],ve.prototype,"mass",null);un([mi(),m()],ve.prototype,"useGravity",void 0);un([m(x)],ve.prototype,"centerOfMass",void 0);un([mi(),m()],ve.prototype,"constraints",void 0);un([mi(),m()],ve.prototype,"isKinematic",void 0);un([mi(),m()],ve.prototype,"drag",void 0);un([mi(),m()],ve.prototype,"angularDrag",void 0);un([mi(),m()],ve.prototype,"detectCollisions",void 0);un([mi(),m()],ve.prototype,"sleepThreshold",void 0);un([mi(),m()],ve.prototype,"collisionDetectionMode",void 0);un([mi()],ve.prototype,"_gravityScale",void 0);un([mi()],ve.prototype,"dominanceGroup",void 0);new x;new x;const ur=C("debugsync"),kd="STRS";oS(kd,xo.getRootAsSyncedTransformModel);const ms=new jd;function NC(s,t,e=!0){ms.clear();const i=ms.createString(s);xo.startSyncedTransformModel(ms),xo.addGuid(ms,i),xo.addFast(ms,e);const n=t.worldPosition,o=t.worldEuler,r=t.gameObject.scale;xo.addTransform(ms,UC.createTransform(ms,n.x,n.y,n.z,o.x,o.y,o.z,r.x,r.y,r.z));const l=xo.endSyncedTransformModel(ms);return ms.finish(l,kd),ms.asUint8Array()}let Qy=0,Wh=0;zC(s=>{var i;const e=((i=s.connection.currentServerUrl)==null?void 0:i.includes("glitch"))?10:40;Wh=Math.floor(Qy/e),Qy=0,ur&&Wh>0&&console.log("Sync Transform Fast Interval",Wh)});class Wo extends j{constructor(){super(...arguments);a(this,"overridePhysics",!0);a(this,"interpolatePosition",!0);a(this,"interpolateRotation",!0);a(this,"fastMode",!1);a(this,"syncDestroy",!1);a(this,"_model",null);a(this,"_needsUpdate",!0);a(this,"rb",null);a(this,"_wasKinematic",!1);a(this,"_receivedDataBefore",!1);a(this,"_targetPosition");a(this,"_targetRotation");a(this,"_receivedFastUpdate",!1);a(this,"_shouldRequestOwnership",!1);a(this,"joinedRoomCallback",null);a(this,"receivedDataCallback",null);a(this,"tempEuler",new di);a(this,"receivedUpdate",!1);a(this,"lastWorldPos");a(this,"lastWorldRotation")}requestOwnership(){ur&&console.log("Request ownership"),this._model?this._model.requestOwnership():(this._shouldRequestOwnership=!0,this._needsUpdate=!0)}hasOwnership(){var e;return((e=this._model)==null?void 0:e.hasOwnership)??void 0}isOwned(){var e;return(e=this._model)==null?void 0:e.isOwned}awake(){ur&&console.log("new instance",this.guid,this),this._receivedDataBefore=!1,this._targetPosition=new x,this._targetRotation=new H,this.lastWorldPos=new x,this.lastWorldRotation=new H,this.rb=P.getComponentInChildren(this.gameObject,ve),this.rb&&(this._wasKinematic=this.rb.isKinematic),this.receivedUpdate=!0,this._model=new QS(this.context.connection,this.guid),this.context.connection.isConnected&&this.tryGetLastState(),this.joinedRoomCallback=this.tryGetLastState.bind(this),this.context.connection.beginListen(se.JoinedRoom,this.joinedRoomCallback),this.receivedDataCallback=this.onReceivedData.bind(this),this.context.connection.beginListenBinary(kd,this.receivedDataCallback)}onDestroy(){this.syncDestroy&&lC(this.guid,this.context.connection),this._model=null,this.context.connection.stopListen(se.JoinedRoom,this.joinedRoomCallback),this.context.connection.stopListenBinary(kd,this.receivedDataCallback)}tryGetLastState(){const e=this.context.connection.tryGetState(this.guid);e&&this.onReceivedData(e)}onReceivedData(e){var i;if(!this.destroyed&&typeof e.guid=="function"&&e.guid()===this.guid){ur&&console.log("new data",this.context.connection.connectionId,this.context.time.frameCount,this.guid,e),this.receivedUpdate=!0,this._receivedFastUpdate=e.fast();const n=e.transform();if(n){is.markDirty(this.gameObject,!0);const o=n.position();o&&(this.interpolatePosition&&((i=this._targetPosition)==null||i.set(o.x(),o.y(),o.z())),(!this.interpolatePosition||!this._receivedDataBefore)&&this.setWorldPosition(o.x(),o.y(),o.z()));const r=n.rotation();r&&(this.tempEuler.set(r.x(),r.y(),r.z()),this.interpolateRotation&&this._targetRotation.setFromEuler(this.tempEuler),(!this.interpolateRotation||!this._receivedDataBefore)&&Uw(this.gameObject,this.tempEuler))}this._receivedDataBefore=!0}}onEnable(){this.lastWorldPos.copy(this.worldPosition),this.lastWorldRotation.copy(this.worldQuaternion),this._needsUpdate=!0,this._model&&this._model.updateIsOwned()}onDisable(){this._model&&this._model.freeOwnership()}onBeforeRender(){if(!this.activeAndEnabled||!this.context.connection.isConnected)return;if(!this.context.connection.isInRoom||!this._model){ur&&console.log("no model or room",this.name,this.guid,this.context.connection.isInRoom);return}this._shouldRequestOwnership&&(this._shouldRequestOwnership=!1,this._model.requestOwnership());const e=this.worldPosition,i=this.worldQuaternion;if(this._model.isOwned&&!this.receivedUpdate){const r=e.distanceTo(this.lastWorldPos),l=i.angleTo(this.lastWorldRotation),c=this._model.hasOwnership||this.fastMode?1e-4:.001;(r>c||l>c)&&(this._model.hasOwnership?this._needsUpdate=!0:(ur&&console.log(this.guid,"reset because not owned but",this.gameObject.name,this.lastWorldPos),this.worldPosition=this.lastWorldPos,e.copy(this.lastWorldPos),this.worldQuaternion=this.lastWorldRotation,i.copy(this.lastWorldRotation),is.markDirty(this.gameObject,!0),this._needsUpdate=!1))}if(this._model&&!this._model.hasOwnership&&this._model.isOwned&&this._receivedDataBefore){const l=this._receivedFastUpdate||this.fastMode?.5:.3;let c=!1;if(this.interpolatePosition&&this._targetPosition){const h=this.worldPosition;h.lerp(this._targetPosition,l),this.worldPosition=h,c=!0}if(this.interpolateRotation&&this._targetRotation){const h=this.worldQuaternion;h.slerp(this._targetRotation,l),this.worldQuaternion=h,c=!0}c&&is.markDirty(this.gameObject,!0)}if(this.receivedUpdate=!1,this.lastWorldPos.copy(e),this.lastWorldRotation.copy(i),!this._model||!this._model||this._model.hasOwnership===void 0||!this._model.hasOwnership)return;this.rb&&this.overridePhysics&&this._wasKinematic!==void 0&&(ur&&console.log("reset kinematic",this.rb.name,this._wasKinematic),this.rb.isKinematic=this._wasKinematic);const n=10,o=this.rb||this.fastMode;if(this._needsUpdate&&(this.context.time.frameCount%n===0||o)){if(Qy++,o&&Wh>0&&this.context.time.frameCount%Wh!==0)return;ur&&console.log("send update",this.context.connection.connectionId,this.guid,this.gameObject.name,this.gameObject.guid),this._needsUpdate=!1;const r=NC(this.guid,this,!!o);this.context.connection.sendBinary(r)}}}const KM=C("debugshadowcomponents");bw.prototype.interactable={get(){return this.interactive},set(s){this.interactable=s}};const On=Symbol("shadowDomOwner");class ls extends j{constructor(){super(...arguments);a(this,"_shadowComponent",null);a(this,"_controlsChildLayout",!0);a(this,"_root");a(this,"_parentComponent")}isRoot(){var e;return((e=this.Root)==null?void 0:e.gameObject)===this.gameObject}get canvas(){const e=this.Root;return e!=null&&e.isCanvas?e:null}get Canvas(){return this.canvas}markDirty(){Gi.markUIDirty(this.context)}get shadowComponent(){return this._shadowComponent}set shadowComponent(e){this._shadowComponent=e}get controlsChildLayout(){return this._controlsChildLayout}set controlsChildLayout(e){this._controlsChildLayout=e,this.shadowComponent&&(this.shadowComponent.autoLayout=e)}get Root(){return this._root===void 0&&(this._root=P.getComponentInParent(this.gameObject,qp)),this._root}__internalNewInstanceCreated(e){return super.__internalNewInstanceCreated(e),this.shadowComponent=null,this._root=void 0,this._parentComponent=void 0,this}onEnable(){super.onEnable()}addShadowComponent(e,i){var r;if(!e)return;this.removeShadowComponent();const n=this.isRoot()?this.gameObject:this.gameObject.parent;if(this._parentComponent=P.getComponentInParent(n,ls),!this._parentComponent){console.warn(`Component "${this.name}" doesn't have a UI parent anywhere. Do you have an UI element outside a Canvas? UI components must be a child of a Canvas component`,this);return}e.name=this.name+" ("+(this.constructor.name??"UI")+")",e.autoLayout=this._parentComponent.controlsChildLayout,e[On]=this,this.setShadowComponentOwner(e);let o=!1;if(((r=this.Root)==null?void 0:r.gameObject)===this.gameObject)this.gameObject.add(e);else{const l=this._parentComponent.shadowComponent;l&&(l==null||l.add(e),o=!0)}this.shadowComponent=e,i&&i.shadowComponent&&this.shadowComponent&&i.shadowComponent.add(this.shadowComponent),Fd&&e.add(new ln(.5)),this.onAfterAddedToScene(),o&&MR(),KM&&console.warn("Added shadow component",this.shadowComponent)}setShadowComponentOwner(e){if(e&&(e[On]===void 0||e[On]===this)&&(e[On]=this,e.children))for(const i of e.children)this.setShadowComponentOwner(i)}traverseOwnedShadowComponents(e,i,n){if(e&&e[On]===i){n(e);for(const o of e.children)this.traverseOwnedShadowComponents(o,i,n)}}removeShadowComponent(){this.shadowComponent&&this.shadowComponent.removeFromParent()}onAfterAddedToScene(){}setInteractable(e){this.shadowComponent&&(this.shadowComponent.interactable=e)}}class qp extends ls{awake(){super.awake()}}class Vd{constructor(t,e){a(this,"event");a(this,"button");a(this,"buttonName");a(this,"_used",!1);a(this,"_propagationStopped",!1);a(this,"z__pointer_ctured",!1);a(this,"z__pointer_cture_rleased",!1);a(this,"inputSource");a(this,"object");a(this,"point");a(this,"normal");a(this,"face");a(this,"distance");a(this,"instanceId");a(this,"intersection");a(this,"isDown");a(this,"isUp");a(this,"isPressed");a(this,"isClick");a(this,"isDoubleClick");a(this,"input");this.event=e,this.input=t,this.button=e.button}get deviceIndex(){return this.event.deviceIndex}get pointerId(){return this.event.pointerId}get pressure(){return this.event.pressure}get used(){return this._used}use(){this._used||(this._used=!0,this.event.use())}get propagationStopped(){return this._propagationStopped}stopPropagation(){this._propagationStopped=!0,this.event.stopImmediatePropagation()}stopImmediatePropagation(){this._propagationStopped=!0,this.event.stopImmediatePropagation()}setPointerCapture(){this.z__pointer_ctured=!0}releasePointerCapture(){this.z__pointer_cture_rleased=!0}get mode(){return this.event.mode}clone(){const t=new Vd(this.input,this.event);return Object.assign(t,this),t}Use(){this.use()}StopPropagation(){this.event.stopImmediatePropagation()}}function Yy(s,t){return P.foreachComponent(s,i=>{if(!i.enabled)return;const n=i;if(t)switch(t){case"pointerdown":if(n.onPointerDown)return!0;break;case"pointerup":if(n.onPointerUp||n.onPointerClick)return!0;break;case"pointermove":if(n.onPointerEnter||n.onPointerExit||n.onPointerMove)return!0;break}else if(n.onPointerDown||n.onPointerUp||n.onPointerEnter||n.onPointerExit||n.onPointerClick)return!0},!1)===!0}const oo=new Array;class wo{constructor(t,e,i,n){a(this,"enabled",!0);a(this,"target");a(this,"methodName");a(this,"arguments");this.target=t,this.methodName=e||null,this.arguments=i,n!=null&&(this.enabled=n)}get canClone(){return this.target instanceof Object}invoke(...t){if(this.enabled!==!1){if(typeof this.target=="function")this.arguments?(oo.length=0,t!==void 0&&t.length>0&&oo.push(...t),oo.push(...this.arguments),this.target(...this.arguments),oo.length=0):this.target(...t);else if(this.methodName!=null){const e=this.target[this.methodName];typeof e=="function"?this.arguments?(oo.length=0,t!==void 0&&t.length>0&&oo.push(...t),oo.push(...this.arguments),e.call(this.target,...oo),oo.length=0):e.call(this.target,...t):this.arguments?this.target[this.methodName]=this.arguments[0]||t[0]:this.target[this.methodName]=t[0]}}}}const JM=s=>/^[A-Z]*$/.test(s);class ib extends Event{constructor(){super(...arguments);a(this,"args")}}class Te{constructor(t){a(this,"isEventList",!0);a(this,"target");a(this,"key");a(this,"_isInvoking",!1);a(this,"methods",[]);a(this,"_methodsCopy",[]);if(this.methods=[],Array.isArray(t))for(const e of t)e instanceof wo?this.methods.push(e):typeof e=="function"&&this.methods.push(new wo(e));else typeof t=="function"&&this.methods.push(new wo(t))}__internalOnInstantiate(t){var n;const e=new Array;for(let o=0;o<this.methods.length;o++){const r=this.methods[o];if(!(r.target instanceof Function)){const l=r.target;let c=l==null?void 0:l.uuid;if(l&&(c=l.guid),c){const h=t[c];if(h){const d=(n=r.arguments)==null?void 0:n.map(u=>u instanceof Object&&u.uuid?t[u.uuid]:u!=null&&u.isComponent?t[u.guid]:u);e.push(new wo(h.clone,r.methodName,d,r.enabled))}else U()&&console.warn("Could not find target for event listener")}}}return new Te(e)}setEventTarget(t,e){if(this.key=t,this.target=e,this.key!==void 0){let i="",n=!1;for(const o of this.key)n&&JM(o)&&(i+="-"),n=!0,i+=o.toLowerCase();this.key=i}}get listenerCount(){var t;return((t=this.methods)==null?void 0:t.length)??0}get isInvoking(){return this._isInvoking}static from(...t){return new Te(t)}invoke(...t){var e;if(this._isInvoking)return console.warn("Circular event invocation detected. Please check your event listeners for circular references.",this),!1;if(((e=this.methods)==null?void 0:e.length)<=0)return!1;this._isInvoking=!0;try{this._methodsCopy.length=0,this._methodsCopy.push(...this.methods);for(const i of this._methodsCopy)i.invoke(...t);if(typeof this.target=="object"&&typeof this.key=="string"){const i=this.target.dispatchEvent;if(typeof i=="function"){const n=new ib(this.key);n.args=t,i.call(this.target,n)}}}finally{this._isInvoking=!1,this._methodsCopy.length=0}return!0}addEventListener(t){return this.methods.push(new wo(t)),t}removeEventListener(t){if(t)for(let e=this.methods.length-1;e>=0;e--)this.methods[e].target===t&&(this.methods[e].enabled=!1,this.methods.splice(e,1))}removeAllEventListeners(){this.methods.length=0}}class ZM extends Fn{constructor(){super([ue,Ae],"ColorSerializer")}onDeserialize(t){if(t!=null)return t.a!==void 0?new Ae(t.r,t.g,t.b,t.a):t.alpha!==void 0?new Ae(t.r,t.g,t.b,t.alpha):new ue(t.r,t.g,t.b)}onSerialize(t){if(t!=null)return t.a!==void 0?{r:t.r,g:t.g,b:t.b,a:t.a}:{r:t.r,g:t.g,b:t.b}}}const DL=new ZM;class eA extends Fn{constructor(){super([di],"EulerSerializer")}onDeserialize(t,e){if(t!=null){if(t.order)return new di(t.x,t.y,t.z,t.order);if(t.x!=null)return new di(t.x,t.y,t.z)}}onSerialize(t,e){return{x:t.x,y:t.y,z:t.z,order:t.order}}}const LL=new eA;class tA extends Fn{constructor(){super(F,"ObjectSerializer")}onSerialize(t,e){if(e.objectToNode!==void 0&&t.uuid){const i=e.objectToNode[t.uuid];return At&&console.log(i,t.name,t.uuid),{node:i}}}onDeserialize(t,e){var i,n,o;if(typeof t=="string"){if(t.endsWith(".glb")||t.endsWith(".gltf")){if(e.serializable instanceof Array&&e.serializable.includes(de))return;U()&&Me("Detected wrong usage of @serializable with Object3D or GameObject. Instead you should use AssetReference here! Please see the console for details.");const r=(n=(i=e.target)==null?void 0:i.constructor)==null?void 0:n.name;console.warn(`Wrong usage of @serializable detected in your script "${r}"

It looks like you used @serializable(Object3D) or @serializable(GameObject) for a prefab or scene reference which is exported to a separate glTF file.

To fix this please change your code to:

@serializable(AssetReference)
${e.path}! : AssetReference;
\0`)}return}if(t){if(t.node!==void 0&&e.nodeToObject){const r=e.nodeToObject[t.node];return At&&console.log("Deserialized object reference?",t,r,e==null?void 0:e.nodeToObject),r||console.warn("Did not find node: "+t.node,e.nodeToObject,e.object),r}else if(t.guid){if(!e.context){console.error("Missing context");return}let r;const l=(o=e.gltf)==null?void 0:o.scene;return l&&(r=P.findByGuid(t.guid,l)),r||(r=P.findByGuid(t.guid,e.context.scene)),r?(r&&r.isComponent===!0&&(At&&console.warn("Deserialized object reference is a component"),r=r.gameObject),At&&console.log("Deserialized object reference?",t,r,e==null?void 0:e.nodeToObject)):((U()||At)&&console.warn("Could not resolve object reference",e.path,t,e.target,e.context.scene),t.could_not_resolve=!0),r}}}}const iA=new tA;class nA extends Fn{constructor(){super([j,j],"ComponentSerializer")}onSerialize(t,e){if(t!=null&&t.guid)return{guid:t.guid}}onDeserialize(t,e){var i;if(t!=null&&t.guid){if(t.___persistentAsset){At&&console.log("Skipping component deserialization because it's a persistent asset",t);return}const n=e.path;At&&console.log(t.guid,e.root,e.object,e.target);let o=this.findObjectForGuid(t.guid,e.root);if(o||e.context&&(o=this.findObjectForGuid(t.guid,(i=e.context)==null?void 0:i.scene),o))return o;(U()||At)&&console.warn('Could not resolve component reference: "'+n+'" using guid '+t.guid,e.target),t.could_not_resolve=!0;return}}findObjectForGuid(t,e){if(e.guid===t)return e;const i=P.foreachComponent(e,n=>{if(n.guid===t)return n},!1);if(i!==void 0)return i;for(let n=0;n<e.children.length;n++){const o=e.children[n],r=this.findObjectForGuid(t,o);if(r)return r}}}const _g=new nA;class sA extends Fn{constructor(){super([Te])}onSerialize(t,e){console.log("TODO: SERIALIZE EVENT")}onDeserialize(t,e){var i,n,o;if(typeof t=="function")return new Te([new wo(t,null,[],!0)]);if(t&&t.type==="EventList"){At&&console.log("DESERIALIZE EVENT",t);const r=new Array;if(t.calls&&Array.isArray(t.calls))for(const h of t.calls){let f=function(p){if(typeof p=="object"){let g=iA.onDeserialize(p,e);if(g||(g=_g.onDeserialize(p,e)),g)return g}return p};At&&console.log(h);let d=_g.findObjectForGuid(h.target,e.root);!d&&((i=e.context)!=null&&i.scene)&&(d=_g.findObjectForGuid(h.target,(n=e.context)==null?void 0:n.scene));const u=((o=h.method)==null?void 0:o.length)>0;if(d&&u){const p=()=>{const y=h.method[0].toUpperCase()+h.method.slice(1);if(typeof d[y]=="function"){console.warn(`EventList method:
Could not find method ${h.method} on object ${d.name}. Please rename ${h.method} to ${y}?
`,d[y],`
 in script: `,d),Me("EventList methods must start with lowercase letter, see console for details");return}else console.warn(`EventList method:
Could not find method ${h.method} on object ${d.name}`,d,typeof d[h.method])};if(typeof d[h.method]!="function"){let y=!1,b=d;for(;b;){const _=Object.getOwnPropertyDescriptor(b,h.method);if(_&&(_.writable===!0||_.set)){y=!0;break}b=Object.getPrototypeOf(b)}!y&&(U()||At)&&p()}}if(d){let p=h.argument;if(p!==void 0?p=f(p):h.arguments!==void 0&&(p=h.arguments.map(f)),!d[h.method])console.warn(`EventList method not found: "${h.method}" on ${d==null?void 0:d.name}`);else{p!==void 0&&!Array.isArray(p)&&(p=[p]);const y=new wo(d,h.method,p,h.enabled);r.push(y)}}else U()&&console.warn("[Debug] EventList: Could not find event listener in scene",h,e.object,t)}const l=new Te(r);At&&console.log(l);const c=e.target;return c!==void 0&&e.path!==void 0&&l.setEventTarget(e.path,c),l}}}const jL=new sA,jf=new WeakMap,oA=Je.prototype.clone;Je.prototype.clone=function(){const s=oA.call(this);return jf.has(s)||jf.set(s,this),s};class rA extends Fn{constructor(){super([ja,No])}onSerialize(t,e){}onDeserialize(t,e){if(t instanceof Je&&e.type===ja){let i=t;jf.has(i)&&(i=jf.get(i)),i.isRenderTargetTexture=!0,i.flipY=!0,i.offset.y=1,i.repeat.y=-1,i.needsUpdate=!0,i.mipmaps=[],i instanceof IP&&(i.isCompressedTexture=!1,i.format=Pp);const n=new ja(i.image.width,i.image.height,{colorSpace:Wa});return n.texture=i,n}}}new rA;class aA extends Fn{constructor(){super([URL])}onSerialize(t,e){return null}onDeserialize(t,e){if(typeof t=="string"&&t.length>0)return Ya(e.gltfId,t)}}new aA;var lA=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};class Oc extends j{awake(){Gi.createIfNoneExists(this.context)}onEnable(){var t;(t=Gi.get(this.context))==null||t.register(this)}onDisable(){var t;(t=Gi.get(this.context))==null||t.unregister(this)}}class jn extends Oc{constructor(){super(...arguments);a(this,"targets",null);a(this,"raycastHits",[]);a(this,"ignoreSkinnedMeshes",!1)}start(){this.targets=[this.gameObject]}performRaycast(e=null){if(!this.targets)return null;e??(e=new $o),e.targets=this.targets,e.results=this.raycastHits,e.useAcceleratedRaycast=!0;const i=e.testObject;this.ignoreSkinnedMeshes&&(e.testObject=o=>o instanceof Eo?"continue in children":i?i(o):!0);const n=this.context.physics.raycast(e);return e.testObject=i,n}}lA([m()],jn.prototype,"ignoreSkinnedMeshes",void 0);class nb extends jn{constructor(){super(),this.ignoreSkinnedMeshes=!0}}const Xb=class extends Oc{performRaycast(t){if(!te.active||!Xb.allow||!(t!=null&&t.ray))return null;const e=t.ray.origin,i=.015;return this.context.physics.sphereOverlap(e,i,!1,!0)}};let Fa=Xb;a(Fa,"allow",!0);class sb{static getObject(t){const e=t[On];return e&&(e.isComponent===!0?t=e.gameObject:t=e),t}static isInteractable(t,e){if(e&&(e.canvasGroup=void 0,e.graphic=void 0),t==null||!t.visible||(t=this.getObject(t),!t.visible))return!1;const i=this.tryFindCanvasGroup(t);if((i==null?void 0:i.isCanvasGroup)===!0&&(e&&(e.canvasGroup=i),i.blocksRaycasts===!1||i.interactable===!1))return!1;const n=Cc(t,o=>{if(o.isGraphic===!0)return o},!1);return e&&(n==null?void 0:n.isGraphic)===!0&&(e.graphic=n),!((n==null?void 0:n.raycastTarget)===!1||(n==null?void 0:n.layer)===2)}static tryFindCanvasGroup(t){if(!t)return null;const e=Cc(t,i=>{const n=i;if(n.blocksRaycasts!==void 0&&n.interactable!==void 0)return n},!1);return e!==void 0?e:this.tryFindCanvasGroup(t.parent)}}function ob(s){const t=s[On];return t||(s.parent?ob(s.parent):null)}function cA(s){return s.isUI===!0||typeof s[On]=="object"}function Bf(s,t){if(!s)return;const e=s.material;if((e==null?void 0:e.isMaterial)===!0){const i=s.parent;i&&i.isText,e.side=t.doubleSided??!0?hn:Wr,e.shadowSide=t.doubleSided?hn:Wr,s.castShadow=t.castShadows?t.castShadows:!1,s.receiveShadow=t.receiveShadows?t.receiveShadows:!1}for(const i of s.children)Bf(i,t)}function Ml(s,t,e){s[t]===void 0&&console.warn("Field",t,"is undefined on",s);const i=Proxy.revocable(s[t],{set(r,l,c,h){const d=r[l],u=Reflect.set(r,l,c,h);return e(c,d),u}}),n=i.revoke,o=s[t];return i.revoke=()=>{s[t]=o,n()},s[t]=i.proxy,i}const tx=Symbol("Scheduled action");function hA(s,t,e=oe.OnBeforeRender){let i=s[tx];i||(i=s[tx]={});const n=t.name;i[e]||(i[e]={});const o=i[e];if(o[n])return;function*l(){t==null||t.call(s),o[n]=null}const c=s.startCoroutine(l(),e);o[n]=c}const fr=C("debugeventsystem");var Tc;(function(s){s.BeforeHandleInput="BeforeHandleInput",s.AfterHandleInput="AfterHandleInput"})(Tc||(Tc={}));BC(s=>{Gi.createIfNoneExists(s)});class Gi extends j{constructor(){super(...arguments);a(this,"raycaster",[]);a(this,"pressedByID",new Map);a(this,"hoveredByID",new Map);a(this,"onPointerEvent",e=>{if(e===void 0||e.propagationStopped||e.defaultPrevented||e.used)return;const i=new Vd(this.context.input,e);this._currentPointerEventName=e.type,i.inputSource=this.context.input,i.isClick=e.isClick,i.isDoubleClick=e.isDoubleClick,i.isDown=e.type==ye.PointerDown,i.isUp=e.type==ye.PointerUp,i.isPressed=this.context.input.getPointerPressed(e.pointerId),fr&&(i.isDown?console.log("DOWN",i.pointerId):i.isUp&&console.log("UP",i.pointerId),i.isClick&&console.log("CLICK",i.pointerId));const n=new $o;e.hasRay?n.ray=e.ray:n.screenPoint=this.context.input.getPointerPositionRC(e.pointerId);const o=this.performRaycast(n);if(o){for(const l of o)l.event=e,e.intersections.push(l);e.origin.onPointerHits&&e.origin.onPointerHits({sender:this,event:e,hits:o})}fr&&i.isClick&&tt("EventSystem: "+i.pointerId+" - "+this.context.time.frame+" - Up:"+i.isUp+", Down:"+i.isDown);const r={sender:this,args:i,hasActiveUI:this.currentActiveMeshUIComponents.length>0};this.dispatchEvent(new CustomEvent(Tc.BeforeHandleInput,{detail:r})),this.handleIntersections(o,i),this.dispatchEvent(new CustomEvent(Tc.AfterHandleInput,{detail:r}))});a(this,"_sortedHits",[]);a(this,"_testObjectsCache",new Map);a(this,"_currentlyActiveRaycaster",null);a(this,"_currentPointerEventName",null);a(this,"shouldRaycastObject",e=>{var r;const i=e&&"getComponent"in e?e.getComponent(Oc):null;if(i&&i!=this._currentlyActiveRaycaster)return!1;let n=null;if(cA(e)&&(n=(r=e[On])==null?void 0:r.gameObject),this._testObjectsCache.has(e)||n&&this._testObjectsCache.has(n))return this._testObjectsCache.get(e)===!1?"continue in children":!0;{let l=Yy(e,this._currentPointerEventName);if(!l&&n&&(l=Yy(n,this._currentPointerEventName)),l){this._testObjectsCache.set(e,!0);for(const c of e.children)this.shouldRaycastObject_AddToYesCache(c);return!0}return this._testObjectsCache.set(e,!1),"continue in children"}});a(this,"_sortingBuffer",[]);a(this,"_noDepthTestingResults",[]);a(this,"out",{});a(this,"_capturedPointer",{});a(this,"pointerEnterSymbol",Symbol("pointerEnter"));a(this,"pointerExitSymbol",Symbol("pointerExit"));a(this,"currentActiveMeshUIComponents",[])}static ensureUpdateMeshUI(e,i,n=!1){br.update(e,i,n)}static markUIDirty(e){br.markDirty()}static createIfNoneExists(e){e.scene.getComponent(Gi)||e.scene.addComponent(Gi)}static get(e){return this.createIfNoneExists(e),e.scene.getComponent(Gi)}static get instance(){return this.get(ne.Current)}register(e){var i;e&&this.raycaster&&!this.raycaster.includes(e)&&((i=this.raycaster)==null||i.push(e))}unregister(e){var n,o;const i=(n=this.raycaster)==null?void 0:n.indexOf(e);i!==void 0&&i!==-1&&((o=this.raycaster)==null||o.splice(i,1))}get hasActiveUI(){return this.currentActiveMeshUIComponents.length>0}get isHoveringObjects(){return this.hoveredByID.size>0}awake(){this.gameObject!==this.context.scene&&(this.enabled=!1)}start(){this.context.scene.getComponent(Oc)||this.context.scene.addComponent(jn)}onEnable(){this.context.input.addEventListener(ye.PointerDown,this.onPointerEvent),this.context.input.addEventListener(ye.PointerUp,this.onPointerEvent),this.context.input.addEventListener(ye.PointerMove,this.onPointerEvent)}onDisable(){this.context.input.removeEventListener(ye.PointerDown,this.onPointerEvent),this.context.input.removeEventListener(ye.PointerUp,this.onPointerEvent),this.context.input.removeEventListener(ye.PointerMove,this.onPointerEvent)}onBeforeRender(){this.resetMeshUIStates()}shouldRaycastObject_AddToYesCache(e){this._testObjectsCache.set(e,!0);for(const i of e.children)this.shouldRaycastObject_AddToYesCache(i)}performRaycast(e){if(!this.raycaster)return null;this._testObjectsCache.clear(),this._sortedHits.length=0,e||(e=new $o),e.testObject=this.shouldRaycastObject;for(const i of this.raycaster){if(!i.activeAndEnabled)continue;this._currentlyActiveRaycaster=i;const n=i.performRaycast(e);this._currentlyActiveRaycaster=null,n&&n.length>0&&this._sortedHits.push(...n)}return this._sortedHits.sort((i,n)=>i.distance-n.distance),this._sortedHits}assignHitInformation(e,i){i?(e.intersection=i,e.point=i.point,e.normal=i.normal,e.face=i.face,e.distance=i.distance,e.instanceId=i.instanceId):(e.intersection=void 0,e.point=void 0,e.normal=void 0,e.face=void 0,e.distance=void 0,e.instanceId=void 0)}handleIntersections(e,i){var o;if(e!=null&&e.length){e=this.sortCandidates(e);for(const r of e){if(i.event.immediatePropagationStopped)return!1;if(this.assignHitInformation(i,r),this.handleEventOnObject(r.object,i))return!0}}this.assignHitInformation(i,e==null?void 0:e[0]),this.invokePointerCapture(i);const n=this.hoveredByID.get(i.pointerId);return n&&this.propagatePointerExit(n.obj,n.data,null),this.hoveredByID.delete(i.pointerId),i.isUp&&((o=this.pressedByID.get(i.pointerId))==null||o.handlers.forEach(r=>this.invokeOnPointerUp(i,r)),this.pressedByID.delete(i.pointerId)),!1}sortCandidates(e){this._sortingBuffer.length=0,this._noDepthTestingResults.length=0;for(let i=0;i<e.length;i++){const n=e[i],o=n.object;if(o.material&&o.material.depthTest===!1){this._noDepthTestingResults.push(n);continue}this._sortingBuffer.push(n)}for(const i of this._sortingBuffer)this._noDepthTestingResults.push(i);return this._noDepthTestingResults}handleEventOnObject(e,i){if(!this.testIsVisible(e))return i.isClick&&fr&&console.log("not allowed",e),!1;if(i.pointerId===void 0)return fr&&console.error("Event without pointer can't be handled",i),!1;i.object=e;const n=e.parent,o=i.isClick??!1;let r=null;if(n&&n.isUI){const u=(i.isPressed||i.isClick)??!1;if(n[On]){const f=n[On].gameObject;if(f){if(!sb.isInteractable(f,this.out))return!1;r=this.out.canvasGroup??null,this.handleMeshUIIntersection(e,u),e=f}}}o&&fr&&console.log(this.context.time.frame,e);const l=this.hoveredByID.get(i.pointerId),c=l==null?void 0:l.obj;c!==e&&c&&this.propagatePointerExit(c,l.data,e);const d=this.hoveredByID.get(i.pointerId);if(d?(d.obj=e,d.data=i):this.hoveredByID.set(i.pointerId,{obj:e,data:i}),i.isDown){const u=this.pressedByID.get(i.pointerId);u?(u.obj=e,u.data=i):this.pressedByID.set(i.pointerId,{obj:e,data:i,handlers:new Set})}return(r===null||r.interactable)&&this.handleMainInteraction(e,i,c??null),!0}propagate(e,i){for(;e;)P.foreachComponent(e,n=>{i(n)},!1),e=e.parent}handleMainInteraction(e,i,n){const o=this.pressedByID.get(i.pointerId),r=n!==e;let l=!0;switch(i.event.pointerType){case"mouse":case"touch":const c=this.context.input.getPointerPositionLastFrame(i.pointerId),h=this.context.input.getPointerPosition(i.pointerId);l=c&&!W.approximately(c,h);break}this.propagate(e,c=>{var d;const h=c;h.interactable!==!1&&(!h.activeAndEnabled||!h.enabled||(h.onPointerEnter&&r&&this.handlePointerEnter(h,i),i.isDown&&h.onPointerDown&&(h.onPointerDown(i),o==null||o.handlers.add(h),this.handlePointerCapture(i,h)),h.onPointerMove&&(l&&h.onPointerMove(i),this.handlePointerCapture(i,h)),i.isUp&&(h.onPointerUp&&(this.invokeOnPointerUp(i,h),o==null||o.handlers.delete(h)),h.onPointerExit&&((d=i.event)==null?void 0:d.pointerType)===Sr.Touch&&(this.handlePointerExit(h,i),this.hoveredByID.delete(i.pointerId))),i.isClick&&h.onPointerClick&&h.onPointerClick(i)))}),i.isUp&&(o==null||o.handlers.forEach(c=>{this.invokeOnPointerUp(i,c)}),this.pressedByID.delete(i.pointerId))}propagatePointerExit(e,i,n){this.propagate(e,o=>{if(!o.gameObject||o.destroyed)return;const r=o;if(r.onPointerExit||r.onPointerEnter){if(n&&this.isChild(n,o.gameObject))return;this.handlePointerExit(r,i)}})}invokeOnPointerUp(e,i){var n;(n=i.onPointerUp)==null||n.call(i,e),this.releasePointerCapture(e,i)}handlePointerEnter(e,i){e.onPointerEnter&&this.updatePointerState(e,i.pointerId,this.pointerEnterSymbol,!0)&&e.onPointerEnter(i),this.updatePointerState(e,i.pointerId,this.pointerExitSymbol,!1)}handlePointerExit(e,i){e.onPointerExit&&this.updatePointerState(e,i.pointerId,this.pointerExitSymbol,!0)&&e.onPointerExit(i),this.updatePointerState(e,i.pointerId,this.pointerEnterSymbol,!1)}updatePointerState(e,i,n,o){let r=e[n];if(o)return r&&r.includes(i)?!1:(r=r||[],r.push(i),e[n]=r,!0);{if(!r||!r.includes(i))return!1;const l=r.indexOf(i);return l!==-1&&r.splice(l,1),!0}}handlePointerCapture(e,i){if(e.z__pointer_ctured){e.z__pointer_ctured=!1;const n=e.pointerId;if(i.onPointerMove){const o=this._capturedPointer[n]||[];o.push(i),this._capturedPointer[n]=o}else U()&&!i.z__warned_no_pointermove&&(i.z__warned_no_pointermove=!0,console.warn("PointerCapture was requested but the component doesn't implement onPointerMove. It will not receive any pointer events"))}else e.z__pointer_cture_rleased&&(e.z__pointer_cture_rleased=!1,this.releasePointerCapture(e,i))}releasePointerCapture(e,i){const n=e.pointerId;if(this._capturedPointer[n]){const o=this._capturedPointer[n].indexOf(i);o!==-1&&(this._capturedPointer[n].splice(o,1),fr&&console.log("released pointer capture",n,i,this._capturedPointer))}}invokePointerCapture(e){var i;if(e.event.type===ye.PointerMove){const n=e.pointerId,o=this._capturedPointer[n];if(o){fr&&console.log("Captured",n,o);for(let r=0;r<o.length;r++){const l=o[r];if(l.destroyed){o.splice(r,1),r--;continue}(i=l.onPointerMove)==null||i.call(l,e)}}}}isChild(e,i){return!e||!i?!1:e===i?!0:e.parent?this.isChild(e.parent,i):!1}handleMeshUiObjectWithoutShadowDom(e,i){return!e||!e.isUI?!0:this.handleMeshUIIntersection(e,i)}handleMeshUIIntersection(e,i){const n=br.updateState(e,i);return n&&this.currentActiveMeshUIComponents.push(n),n!==null}resetMeshUIStates(){if(this.context.input.getPointerPressedCount()>0&&br.resetLastSelected(),!(!this.currentActiveMeshUIComponents||this.currentActiveMeshUIComponents.length<=0)){for(let e=0;e<this.currentActiveMeshUIComponents.length;e++){const i=this.currentActiveMeshUIComponents[e];br.resetState(i)}this.currentActiveMeshUIComponents.length=0}}testIsVisible(e){return e?P.isActiveSelf(e)?this.testIsVisible(e.parent):!1:!0}}class br{static markDirty(){this.needsUpdate=!0}static update(t,e,i=!1){if(i){t.update();return}const n=e.time.frameCount;for(const o of this.lastUpdateFrame)if(o.context===e){if(n===o.frame)return;o.frame=n;let r=this.needsUpdate||n<1;o.nextUpdate<=n&&(r=!0),r&&(fr&&console.log("Update threemeshui"),this.needsUpdate=!1,o.nextUpdate=n+60,t.update());return}this.lastUpdateFrame=[{context:e,frame:n,nextUpdate:n+60}],t.update(),this.needsUpdate=!1}static updateState(t,e){let i=null;if(t&&(i=this.findBlockOrTextInParent(t),i&&i!==this.lastSelected)){if(i.interactable===!1)return null;this.needsUpdate=!0}return i}static resetLastSelected(){const t=this.lastSelected;t&&(this.lastSelected=null,this.resetState(t))}static resetState(t){t&&(this.needsUpdate=!0)}static findBlockOrTextInParent(t){return t?t.isBlock||t.isText?t:this.findBlockOrTextInParent(t.parent):null}}a(br,"lastSelected",null),a(br,"lastUpdateFrame",[]),a(br,"needsUpdate",!1);var et=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const vl=C("debugorbit"),bg=C("freecam"),Tu=C("debugcamerafit"),ku=C("smoothcam"),dA={LEFT:"",UP:"",RIGHT:"",BOTTOM:""};let vg;var Ky;(function(s){s.CameraTargetReached="target-reached"})(Ky||(Ky={}));class Ff extends CustomEvent{constructor(t,e){super(Ky.CameraTargetReached,{detail:{controls:t,type:e}})}}class ke extends j{constructor(){super(...arguments);a(this,"autoTarget",!0);a(this,"autoFit",!1);a(this,"enableRotate",!0);a(this,"autoRotate",!1);a(this,"autoRotateSpeed",1);a(this,"minAzimuthAngle",1/0);a(this,"maxAzimuthAngle",1/0);a(this,"minPolarAngle",0);a(this,"maxPolarAngle",Math.PI);a(this,"enableKeys",!1);a(this,"enableDamping",!0);a(this,"dampingFactor",.1);a(this,"enableZoom",!0);a(this,"minZoom",0);a(this,"maxZoom",1/0);a(this,"zoomSpeed",1);a(this,"zoomToCursor",!1);a(this,"enablePan",!0);a(this,"lookAtConstraint",null);a(this,"lookAtConstraint01",1);a(this,"allowInterrupt",!0);a(this,"middleClickToFocus",!0);a(this,"doubleClickToFocus",!0);a(this,"clickBackgroundToFitScene",2);a(this,"debugLog",!1);a(this,"targetLerpDuration",1);a(this,"_controls",null);a(this,"_cameraObject",null);a(this,"_lookTargetLerpActive",!1);a(this,"_lookTargetStartPosition",new x);a(this,"_lookTargetEndPosition",new x);a(this,"_lookTargetLerp01",0);a(this,"_lookTargetLerpDuration",0);a(this,"_cameraLerpActive",!1);a(this,"_cameraStartPosition",new x);a(this,"_cameraEndPosition",new x);a(this,"_cameraLerp01",0);a(this,"_cameraLerpDuration",0);a(this,"_fovLerpActive",!1);a(this,"_fovLerpStartValue",0);a(this,"_fovLerpEndValue",0);a(this,"_fovLerp01",0);a(this,"_fovLerpDuration",0);a(this,"_inputs",0);a(this,"_enableTime",0);a(this,"_startedListeningToKeyEvents",!1);a(this,"_eventSystem");a(this,"_afterHandleInputFn");a(this,"_camera",null);a(this,"_syncedTransform");a(this,"_didSetTarget",0);a(this,"targetElement",null);a(this,"_activePointerEvents");a(this,"_lastTimeClickOnBackground",-1);a(this,"_clickOnBackgroundCount",0);a(this,"_onPointerDown",e=>{this._activePointerEvents.push(e)});a(this,"_onPointerDownLate",e=>{e.used&&this._controls&&(this._controls.enabled=!1)});a(this,"_onPointerUp",e=>{for(let i=this._activePointerEvents.length-1;i>=0;i--){const n=this._activePointerEvents[i];if(n.pointerId===e.pointerId&&n.button===e.button){this._activePointerEvents.splice(i,1);break}}if(this.clickBackgroundToFitScene>0&&e.isClick&&e.button===0){if(e.hasRay||e.intersections.push(...this.context.physics.raycast()),e.intersections.length<=0){const i=this.context.time.time-this._lastTimeClickOnBackground;this._lastTimeClickOnBackground=this.context.time.time,this.clickBackgroundToFitScene<=1||i<this.clickBackgroundToFitScene*.15?(this._clickOnBackgroundCount+=1,this._clickOnBackgroundCount>=this.clickBackgroundToFitScene-1&&this.fitCamera(this.context.scene.children,{immediate:!1})):this._clickOnBackgroundCount=0}vl&&console.log(this.clickBackgroundToFitScene,e.intersections.length,this._clickOnBackgroundCount)}});a(this,"_onPointerUpLate",e=>{var i,n,o;if(this.doubleClickToFocus&&e.isDoubleClick&&!e.used)this.setTargetFromRaycast();else if(!e.used&&this.autoTarget){const r=new $r((i=this._cameraObject)==null?void 0:i.worldPosition,(n=this._cameraObject)==null?void 0:n.worldForward.multiplyScalar(-1)),l=this.context.physics.raycastFromRay(r),c=l.length>0?l[0]:void 0;c&&c.distance>this.minZoom&&c.distance<this.maxZoom&&(vl&&G.DrawWireSphere(c.point,.1,16711680,2),(o=this._controls)==null||o.target.copy(l[0].point))}});a(this,"onControlsChangeStarted",()=>{this._syncedTransform&&this._syncedTransform.requestOwnership()});a(this,"_shouldDisable",!1);a(this,"__onPreRender",()=>{const e=this.context.pre_render_callbacks.indexOf(this.__onPreRender);e>=0&&this.context.pre_render_callbacks.splice(e,1),this.autoFit&&(this.autoFit=!1,this.fitCamera({centerCamera:"y",immediate:!0,objects:this.scene.children}))});a(this,"_haveAttachedKeyboardEvents",!1)}get isCameraController(){return!0}get controls(){return this._controls}get controllerObject(){return this._cameraObject}onStartInteraction(e){var i;(i=this.controls)==null||i.addEventListener("start",e)}get targetLerpSpeed(){return 5}set targetLerpSpeed(e){this.targetLerpDuration=1/e}awake(){vl&&console.debug("OrbitControls",this),this._didSetTarget=0,this._startedListeningToKeyEvents=!1}start(){this._eventSystem=Gi.get(this.context)??void 0,this._eventSystem&&(this._afterHandleInputFn=this.afterHandleInput.bind(this),this._eventSystem.addEventListener(Tc.AfterHandleInput,this._afterHandleInputFn))}onDestroy(){var e,i;(e=this._controls)==null||e.dispose(),(i=this._eventSystem)==null||i.removeEventListener(Tc.AfterHandleInput,this._afterHandleInputFn)}onEnable(){this._didSetTarget=0,this._enableTime=this.context.time.time;const e=P.getComponent(this.gameObject,Se);this._camera=e;let i=e==null?void 0:e.threeCamera;if(!i&&this.gameObject instanceof Re&&(i=this.gameObject),i&&v0(i,this,!0),!this._controls&&i instanceof F){this._cameraObject=i;const n=this.targetElement??this.context.renderer.domElement,o=i==null?void 0:i.quaternion.clone();this._controls=new xw(i,n),i==null||i.quaternion.copy(o),vg===void 0&&(vg={...this._controls.keys});const r=ae(i),l=this.gameObject.worldForward,c=2.5,h=r.clone().sub(l.multiplyScalar(c));this._controls.target.copy(h)}if(this._controls)if(bg&&(this.enablePan=!0,this.enableZoom=!0,this.middleClickToFocus=!0,J.isMobileDevice()&&(this.doubleClickToFocus=!0)),this._controls.addEventListener("start",this.onControlsChangeStarted),!this._startedListeningToKeyEvents&&this.enableKeys)this._startedListeningToKeyEvents=!0,this._controls.listenToKeyEvents(this.context.domElement);else try{this._controls.stopListenToKeyEvents()}catch{}this._syncedTransform=P.getComponent(this.gameObject,Wo)??void 0,this.context.pre_render_callbacks.push(this.__onPreRender),this._activePointerEvents=[],this.context.input.addEventListener("pointerdown",this._onPointerDown,{queue:Wi.Early}),this.context.input.addEventListener("pointerdown",this._onPointerDownLate,{queue:Wi.Late}),this.context.input.addEventListener("pointerup",this._onPointerUp,{queue:Wi.Early}),this.context.input.addEventListener("pointerup",this._onPointerUpLate,{queue:Wi.Late})}onDisable(){var e;if((e=this._camera)!=null&&e.threeCamera&&v0(this._camera.threeCamera,this,!1),this._controls){this._controls.enabled=!1,this._controls.autoRotate=!1,this._controls.removeEventListener("start",this.onControlsChangeStarted);try{this._controls.stopListenToKeyEvents()}catch{}this._startedListeningToKeyEvents=!1}this._activePointerEvents.length=0,this.context.input.removeEventListener("pointerdown",this._onPointerDown),this.context.input.removeEventListener("pointerdown",this._onPointerDownLate),this.context.input.removeEventListener("pointerup",this._onPointerUp),this.context.input.removeEventListener("pointerup",this._onPointerUpLate)}afterHandleInput(e){e.detail.args.pointerId===0&&(e.detail.args.isDown?this._controls&&this._eventSystem&&(this._shouldDisable=this._eventSystem.hasActiveUI):(!e.detail.args.isPressed||e.detail.args.isUp)&&(this._shouldDisable=!1))}onBeforeRender(){var i,n,o,r;if(!this._controls)return;if(this._cameraObject!==this.context.mainCamera){this._controls.enabled=!1;return}if(this._controls.enabled=!0,(this.context.input.getPointerDown(1)||this.context.input.getPointerDown(2)||this.context.input.mouseWheelChanged||this.context.input.getPointerPressed(0)&&((i=this.context.input.getPointerPositionDelta(0))!=null&&i.length())||0>.1)&&(this._inputs+=1),this._inputs>0&&this.allowInterrupt&&(this.enableRotate&&(this.autoRotate=!1),this._cameraLerpActive=!1,this._lookTargetLerpActive=!1),this._inputs=0,this.autoTarget&&this._didSetTarget++===0){const l=P.getComponent(this.gameObject,Se);if(l&&!this.setLookTargetFromConstraint()){this.debugLog&&console.log("NO TARGET");const c=ae(l.threeCamera),h=Math.max(.01,c.length()),d=new x(0,0,-h).applyMatrix4(l.threeCamera.matrixWorld);this.setLookTargetPosition(d,!0)}if(!this.setLookTargetFromConstraint()){const c=new $o;c.screenPoint=new ce(0,0),c.lineThreshold=.1;const h=this.context.physics.raycast(c);h.length>0&&this.setLookTargetPosition(h[0].point,!0),Tu&&console.log("OrbitControls hits",...h)}}if(this.middleClickToFocus&&this.context.input.getPointerClicked(1)&&this.setTargetFromRaycast(),this._lookTargetLerpActive||this._cameraLerpActive||this._fovLerpActive){if(this._cameraLerpActive&&this._cameraObject)if(this._cameraLerp01+=this.context.time.deltaTime/this._cameraLerpDuration,this._cameraLerp01>=1)this._cameraObject.position.copy(this._cameraEndPosition),this._cameraLerpActive=!1,this.dispatchEvent(new Ff(this,"camera"));else{const l=W.easeInOutCubic(this._cameraLerp01);this._cameraObject.position.lerpVectors(this._cameraStartPosition,this._cameraEndPosition,l)}if(this._lookTargetLerpActive)if(this._lookTargetLerp01+=this.context.time.deltaTime/this._lookTargetLerpDuration,this._lookTargetLerp01>=1)this._controls.target.copy(this._lookTargetEndPosition),this._lookTargetLerpActive=!1,this.dispatchEvent(new Ff(this,"lookat"));else{const l=W.easeInOutCubic(this._lookTargetLerp01);this._controls.target.lerpVectors(this._lookTargetStartPosition,this._lookTargetEndPosition,l)}if(this._fovLerpActive&&this._cameraObject){const l=this._cameraObject;if(this._fovLerp01+=this.context.time.deltaTime/this._fovLerpDuration,this._fovLerp01>=1)l.fov=this._fovLerpEndValue,this._fovLerpActive=!1;else{const c=W.easeInOutCubic(this._fovLerp01);l.fov=W.lerp(this._fovLerpStartValue,this._fovLerpEndValue,c)}l.updateProjectionMatrix()}}if(this._controls){if(this.debugLog&&(this._controls.domElement=this.context.renderer.domElement),this._controls.enabled=!this._shouldDisable&&this._camera===this.context.mainCameraComponent&&!this.context.isInXR&&!this._activePointerEvents.some(l=>l.used),this._controls.keys=this.enableKeys?vg:dA,this._controls.autoRotate=this.autoRotate,this._controls.autoRotateSpeed=this.autoRotateSpeed,this._controls.enableZoom=this.enableZoom,this._controls.zoomSpeed=this.zoomSpeed,this._controls.zoomToCursor=this.zoomToCursor,this._controls.enableDamping=this.enableDamping,this._controls.dampingFactor=this.dampingFactor,this._controls.enablePan=this.enablePan,this._controls.enableRotate=this.enableRotate,this._controls.minAzimuthAngle=this.minAzimuthAngle,this._controls.maxAzimuthAngle=this.maxAzimuthAngle,this._controls.minPolarAngle=this.minPolarAngle,this._controls.maxPolarAngle=this.maxPolarAngle,bg||(((o=(n=this._camera)==null?void 0:n.threeCamera)==null?void 0:o.type)==="PerspectiveCamera"?(this._controls.minDistance=this.minZoom,this._controls.maxDistance=this.maxZoom,this._controls.minZoom=0,this._controls.maxZoom=1/0):(this._controls.minDistance=0,this._controls.maxDistance=1/0,this._controls.minZoom=this.minZoom,this._controls.maxZoom=this.maxZoom)),typeof ku=="number"||ku===!0){this._controls.enableDamping=!0;const l=typeof ku=="number"?ku:.99;this._controls.dampingFactor=Math.max(.001,1-Math.min(1,l))}this.allowInterrupt||(this._lookTargetLerpActive&&(this._controls.enablePan=!1),this._cameraLerpActive&&(this._controls.enableRotate=!1,this._controls.autoRotate=!1),(this._lookTargetLerpActive||this._cameraLerpActive)&&(this._controls.enableZoom=!1)),this.context.isInXR||(!bg&&((r=this.lookAtConstraint)!=null&&r.locked)&&this.setLookTargetFromConstraint(0,this.lookAtConstraint01),this._controls.update(this.context.time.deltaTime),vl&&G.DrawWireSphere(this._controls.target,.1,65280))}}setCameraAndLookTarget(e,i=!1){if(!e)return U()&&console.warn("[OrbitControls] setCameraAndLookTarget target is null"),!1;if(!(e instanceof F)&&!(e instanceof Se))return U()&&console.warn("[OrbitControls] setCameraAndLookTarget target is not an Object3D or Camera"),!1;e instanceof Se&&(e=e.gameObject);const n=e.worldPosition,o=e.worldForward,r=new $r(n,o.multiplyScalar(-1));return vl&&G.DrawRay(r.origin,r.direction,16711680,10),this.setTargetFromRaycast(r,i)||this.setLookTargetPosition(r.at(2,Q()),i),this.setCameraTargetPosition(n,i),!0}setCameraTargetPosition(e,i=!1){var n;e&&(e instanceof F&&(e=ae(e)),this._cameraEndPosition||(this._cameraEndPosition=new x),this._cameraEndPosition.copy(e),i===!0?(this._cameraLerpActive=!1,this._cameraObject&&this._cameraObject.position.copy(this._cameraEndPosition)):this._cameraObject&&(this._cameraLerpActive=!0,this._cameraLerp01=0,this._cameraStartPosition.copy((n=this._cameraObject)==null?void 0:n.position),typeof i=="number"?this._cameraLerpDuration=i:this._cameraLerpDuration=this.targetLerpDuration))}get cameraLerpActive(){return this._cameraLerpActive}stopCameraLerp(){this._cameraLerpActive=!1}setFieldOfView(e,i=!1){var o;if(!this._controls||typeof e!="number")return;const n=(o=this._camera)==null?void 0:o.threeCamera;n&&(i===!0?n.fov=e:(this._fovLerpActive=!0,this._fovLerp01=0,this._fovLerpStartValue=n.fov,this._fovLerpEndValue=e,typeof i=="number"?this._fovLerpDuration=i:this._fovLerpDuration=this.targetLerpDuration))}setLookTargetPosition(e=null,i=!1){this._controls&&e&&(e instanceof F&&(e=ae(e)),this._lookTargetEndPosition.copy(e),this._didSetTarget++,vl&&(console.warn("OrbitControls: setLookTargetPosition",e,i),G.DrawWireSphere(this._lookTargetEndPosition,.2,16711680,2)),i===!0?this._controls.target.copy(this._lookTargetEndPosition):(this._lookTargetLerpActive=!0,this._lookTargetLerp01=0,this._lookTargetStartPosition.copy(this._controls.target),typeof i=="number"?this._lookTargetLerpDuration=i:this._lookTargetLerpDuration=this.targetLerpDuration))}get lookTargetLerpActive(){return this._lookTargetLerpActive}stopLookTargetLerp(){this._lookTargetLerpActive=!1}setLookTargetFromConstraint(e=0,i=1){var o,r;if(!this._controls||((o=this.lookAtConstraint)==null?void 0:o.enabled)===!1)return!1;const n=(r=this.lookAtConstraint)==null?void 0:r.sources;if(n&&n.length>0){const l=n[e];if(l)return l.getWorldPosition(this._lookTargetEndPosition),this.lerpLookTarget(this._lookTargetEndPosition,i),!0}return!1}lerpTarget(e,i){return this.lerpLookTarget(e,i)}lerpLookTarget(e,i){this._controls&&(i>=1?this._controls.target.copy(e):this._controls.target.lerp(e,i))}setTargetFromRaycast(e,i=!1){if(!this.controls)return!1;const n=e?this.context.physics.raycastFromRay(e):this.context.physics.raycast();for(const o of n)if(o.distance>0&&P.isActiveInHierarchy(o.object)){const r=ob(o.object);if(r){const l=r.canvas;if(l!=null&&l.screenspace)break}return this.setLookTargetPosition(o.point,i),!0}return!1}fitCamera(e,i){var V,A;if(this.context.isInXR)return;let n;if(Array.isArray(e)?n=e:e&&"type"in e?n=e.children:e&&"objects"in e&&(n=e==null?void 0:e.objects,i=e),n&&!Array.isArray(n)&&(n=n.children),(!Array.isArray(n)||n&&n.length<=0)&&(n=this.context.scene.children),!Array.isArray(n)||n.length<=0){console.warn("No objects to fit camera to...");return}const o=this._cameraObject,r=this._controls;if(!o||!r){console.warn("No camera or controls found to fit camera to objects...");return}i||(i={});const{immediate:l=!1,centerCamera:c="y",cameraNearFar:h="auto",fitOffset:d=1.1,fov:u=o==null?void 0:o.fov}=i,f=new x,p=new x,g=dn(n,void 0,(A=(V=this._camera)==null?void 0:V.threeCamera)==null?void 0:A.layers),y=g.clone();o.updateMatrixWorld(),o.updateProjectionMatrix(),g.getCenter(p);const b=new x;if(g.getSize(b),g.applyMatrix4(o.matrixWorldInverse),g.getSize(f),g.setFromCenterAndSize(p,f),Number.isNaN(f.x)||Number.isNaN(f.y)||Number.isNaN(f.z)){console.warn("Camera fit size resultet in NaN",o,g,[...n]);return}if(f.length()<=1e-10){Tu&&console.warn("Camera fit size is zero",g,[...n]);return}const _=i.fov||o.fov,v=2*Math.atan(Math.tan(_*Math.PI/360/2)*o.aspect)/Math.PI*360,S=f.y/(2*Math.atan(Math.PI*_/360)),T=f.x/(2*Math.atan(Math.PI*v/360)),O=d*Math.max(S,T)+f.z/2;Tu&&console.log("Fit camera to objects",{fitHeightDistance:S,fitWidthDistance:T,distance:O,verticalFov:_,horizontalFov:v}),this.maxZoom=O*10,this.minZoom=O*.01;const M=.05,k=p.clone();if(k.y-=f.y*M,this.setLookTargetPosition(k,l),this.setFieldOfView(i.fov,l),h==null||h=="auto"){const D=P.findObjectOfType(Xo),N=D?D.radius:0,q=Math.max(b.x,b.y,b.z,N);o.near=O/100,o.far=q+O*10,D&&(this.maxZoom=Math.max(Math.min(this.maxZoom,N*.5),O))}const B=r.getDistance();B<this.minZoom&&(this.minZoom=B*.9),B>this.maxZoom&&(this.maxZoom=B*1.1),o.updateMatrixWorld(),o.updateProjectionMatrix();const I=ae(o),E=p.clone();E.sub(I),c==="y"&&(E.y=0),E.normalize(),E.multiplyScalar(O),c==="y"&&(E.y+=-M*4*O);let L=p.clone().sub(E);if(o.parent&&(L=o.parent.worldToLocal(L)),this.setCameraTargetPosition(L,l),Tu){const D=new rw(g);this.context.scene.add(D),Nw(D,Ap(o)),setTimeout(()=>{this.context.scene.remove(D)},1e4),G.DrawWireBox3(y,65280,10),this._haveAttachedKeyboardEvents||(this._haveAttachedKeyboardEvents=!0,document.body.addEventListener("keydown",N=>{if(N.code==="KeyF"){let q;this._cameraObject instanceof Re&&(q=Math.random()*Math.random()*170+10),this.fitCamera({objects:n,fitOffset:d,immediate:!1,fov:q})}N.code==="KeyV"&&this._cameraObject instanceof Re&&(this._cameraObject.fov=60)}))}r.update()}}et([m()],ke.prototype,"autoTarget",void 0);et([m()],ke.prototype,"autoFit",void 0);et([m()],ke.prototype,"enableRotate",void 0);et([m()],ke.prototype,"autoRotate",void 0);et([m()],ke.prototype,"autoRotateSpeed",void 0);et([m()],ke.prototype,"minAzimuthAngle",void 0);et([m()],ke.prototype,"maxAzimuthAngle",void 0);et([m()],ke.prototype,"minPolarAngle",void 0);et([m()],ke.prototype,"maxPolarAngle",void 0);et([m()],ke.prototype,"enableKeys",void 0);et([m()],ke.prototype,"enableDamping",void 0);et([m()],ke.prototype,"dampingFactor",void 0);et([m()],ke.prototype,"enableZoom",void 0);et([m()],ke.prototype,"minZoom",void 0);et([m()],ke.prototype,"maxZoom",void 0);et([m()],ke.prototype,"zoomSpeed",void 0);et([m()],ke.prototype,"enablePan",void 0);et([m(Dc)],ke.prototype,"lookAtConstraint",void 0);et([m()],ke.prototype,"lookAtConstraint01",void 0);et([m()],ke.prototype,"allowInterrupt",void 0);et([m()],ke.prototype,"middleClickToFocus",void 0);et([m()],ke.prototype,"doubleClickToFocus",void 0);et([m()],ke.prototype,"clickBackgroundToFitScene",void 0);et([m()],ke.prototype,"targetLerpDuration",void 0);var Ii=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o},Ui;(function(s){s[s.None=0]="None",s[s.Skybox=1]="Skybox",s[s.SolidColor=2]="SolidColor",s[s.Uninitialized=4]="Uninitialized"})(Ui||(Ui={}));const pr=C("debugcam"),ix=C("debugscreenpointtoray"),Gl=class extends j{constructor(){super(...arguments);a(this,"_nearClipPlane",.1);a(this,"_farClipPlane",1e3);a(this,"orthographic",!1);a(this,"orthographicSize",5);a(this,"ARBackgroundAlpha",0);a(this,"_cullingMask",4294967295);a(this,"_backgroundBlurriness");a(this,"_backgroundIntensity");a(this,"_backgroundRotation");a(this,"_environmentIntensity");a(this,"_targetTexture",null);a(this,"_backgroundColor");a(this,"_fov");a(this,"_cam",null);a(this,"_clearFlags",Ui.SolidColor);a(this,"_skybox");a(this,"_frustum");a(this,"_projScreenMatrix",new le)}get isCamera(){return!0}get aspect(){return this._cam instanceof Re?this._cam.aspect:this.context.domWidth/this.context.domHeight}set aspect(e){this._cam instanceof Re&&this._cam.aspect!==e&&(this._cam.aspect=e,this._cam.updateProjectionMatrix())}get fieldOfView(){return this._cam instanceof Re?this._cam.fov:this._fov}set fieldOfView(e){const i=this.fieldOfView!=e;if(this._fov=e,i&&this._cam&&this._cam instanceof Re){if(this._fov===void 0){console.warn("Can not set undefined fov on PerspectiveCamera");return}this._cam.fov=this._fov,this._cam.updateProjectionMatrix()}}get nearClipPlane(){return this._nearClipPlane}set nearClipPlane(e){const i=this._nearClipPlane!=e;this._nearClipPlane=e,this._cam&&(i||this._cam.near!=e)&&(this._cam.near=e,this._cam.updateProjectionMatrix())}get farClipPlane(){return this._farClipPlane}set farClipPlane(e){const i=this._farClipPlane!=e;this._farClipPlane=e,this._cam&&(i||this._cam.far!=e)&&(this._cam.far=e,this._cam.updateProjectionMatrix())}applyClippingPlane(){this._cam&&(this._cam.near=this._nearClipPlane,this._cam.far=this._farClipPlane,this._cam.updateProjectionMatrix())}get clearFlags(){return this._clearFlags}set clearFlags(e){e!==this._clearFlags&&(this._clearFlags=e,this.applyClearFlagsIfIsActiveCamera())}set cullingMask(e){this._cullingMask=e,this._cam&&(this._cam.layers.mask=e)}get cullingMask(){return this._cam?this._cam.layers.mask:this._cullingMask}set cullingLayer(e){this.cullingMask=(1<<e|0)>>>0}set backgroundBlurriness(e){e!==this._backgroundBlurriness&&(e===void 0?this._backgroundBlurriness=void 0:this._backgroundBlurriness=Math.min(Math.max(e,0),1),this.applyClearFlagsIfIsActiveCamera())}get backgroundBlurriness(){return this._backgroundBlurriness}set backgroundIntensity(e){e!==this._backgroundIntensity&&(e===void 0?this._backgroundIntensity=void 0:this._backgroundIntensity=Math.min(Math.max(e,0),10),this.applyClearFlagsIfIsActiveCamera())}get backgroundIntensity(){return this._backgroundIntensity}set backgroundRotation(e){e!==this._backgroundRotation&&(e===void 0?this._backgroundRotation=void 0:this._backgroundRotation=e,this.applyClearFlagsIfIsActiveCamera())}get backgroundRotation(){return this._backgroundRotation}set environmentIntensity(e){this._environmentIntensity=e}get environmentIntensity(){return this._environmentIntensity}get backgroundColor(){return this._backgroundColor??null}set backgroundColor(e){if(e){if(this._backgroundColor)this._backgroundColor.copy(e);else{if(!e.clone)return;this._backgroundColor=e.clone()}e.alpha===void 0&&(this._backgroundColor.alpha=1),this.applyClearFlagsIfIsActiveCamera()}}set targetTexture(e){this._targetTexture=e}get targetTexture(){return this._targetTexture}get cam(){return this.threeCamera}get threeCamera(){return this.activeAndEnabled&&this.buildCamera(),this._cam}screenPointToRay(e,i,n){const o=this.threeCamera,r=Gl._origin;r.set(e,i,-1),this.context.input.convertScreenspaceToRaycastSpace(r),ix&&console.log("screenPointToRay",e.toFixed(2),i.toFixed(2),"now:",r.x.toFixed(2),r.y.toFixed(2),"isInXR:"+this.context.isInXR),r.z=-1,r.unproject(o);const l=Gl._direction.set(r.x,r.y,r.z),c=ae(o);return l.sub(c),l.normalize(),n?(n.set(c,l),n):new $r(c.clone(),l.clone())}getFrustum(){return this._frustum||(this._frustum=new s0,this.updateFrustum()),this._frustum}updateFrustum(){this._frustum||(this._frustum=new s0),this._frustum.setFromProjectionMatrix(this.getProjectionScreenMatrix(this._projScreenMatrix,!0),this.context.renderer.coordinateSystem)}getProjectionScreenMatrix(e,i){return i&&this._projScreenMatrix.multiplyMatrices(this.threeCamera.projectionMatrix,this.threeCamera.matrixWorldInverse),e===this._projScreenMatrix?e:e.copy(this._projScreenMatrix)}awake(){ix&&window.addEventListener("pointerdown",e=>{const i=e.clientX,n=e.clientY;console.log("touch",i.toFixed(2),n.toFixed(2));const o=this.screenPointToRay(i,n),r="#"+Math.floor(Math.random()*16777215).toString(16);G.DrawRay(o.origin,o.direction,r,10)})}onEnable(){pr&&console.log(`Camera enabled: "${this.name}". ClearFlags=${Ui[this._clearFlags]}`,this),this.buildCamera(),(this.tag=="MainCamera"||!this.context.mainCameraComponent)&&(this.context.setCurrentCamera(this),fA(this)),this.applyClearFlagsIfIsActiveCamera({applySkybox:!0})}onDisable(){this.context.removeCamera(this)}onBeforeRender(){if(this._cam&&(this._frustum&&this.updateFrustum(),this._clearFlags===Ui.SolidColor&&this.applyClearFlagsIfIsActiveCamera(),this._targetTexture)){this.context.isManagedExternally&&(this._warnedAboutExternalRenderer||(this._warnedAboutExternalRenderer=!0,console.warn("Rendering with external renderer is not supported yet. This may not work or throw errors. Please remove the the target texture from your camera: "+this.name,this.targetTexture))),this.context.composer;const e=this.context.renderer;if(e){const i=this.context.mainCameraComponent;this.applyClearFlags(),this._targetTexture.render(this.context.scene,this._cam,e),i==null||i.applyClearFlags()}}}buildCamera(){if(this._cam)return;const e=this.gameObject.isCamera;let i=null;if(e?(i=this.gameObject,i==null||i.layers.enableAll(),i instanceof Re&&(this._fov=i.fov)):i=this.gameObject.children[0],i&&i.isCamera)i instanceof Re&&(this._fov&&(i.fov=this._fov),i.near=this._nearClipPlane,i.far=this._farClipPlane,i.updateProjectionMatrix());else if(!this.orthographic)i=new Re(this.fieldOfView,window.innerWidth/window.innerHeight,this._nearClipPlane,this._farClipPlane),this.fieldOfView&&(i.fov=this.fieldOfView),this.gameObject.add(i);else{const n=this.orthographicSize*100;i=new P_(window.innerWidth/-n,window.innerWidth/n,window.innerHeight/n,window.innerHeight/-n,this._nearClipPlane,this._farClipPlane),this.gameObject.add(i)}this._cam=i,this._cam.layers.mask=this._cullingMask,this.tag=="MainCamera"&&this.context.setCurrentCamera(this)}applyClearFlagsIfIsActiveCamera(e){this.context.mainCameraComponent===this&&this.applyClearFlags(e)}applyClearFlags(e){var i;if(!this._cam){pr&&console.log("Camera does not exist (apply clear flags)");return}if(this.fieldOfView=this._fov,pr){const n=`Camera "${this.name}" clear flags: ${Ui[this._clearFlags]}`;console.debug(n)}switch(this._clearFlags){case Ui.None:return;case Ui.Skybox:if(Gl.backgroundShouldBeTransparent(this.context)&&(!this.ARBackgroundAlpha||this.ARBackgroundAlpha<.001)){this.context.scene.background=null,this.context.renderer.setClearColor(0,0);return}(!this.scene.background||!this._skybox||(e==null?void 0:e.applySkybox)===!0)&&this.applySceneSkybox(),this._backgroundBlurriness!==void 0?this.context.scene.backgroundBlurriness=this._backgroundBlurriness:pr&&console.warn(`Camera "${this.name}" has no background blurriness`),this._backgroundIntensity!==void 0&&(this.context.scene.backgroundIntensity=this._backgroundIntensity),this._backgroundRotation!==void 0?this.context.scene.backgroundRotation=this._backgroundRotation:pr&&console.warn(`Camera "${this.name}" has no background intensity`);break;case Ui.SolidColor:if(this._backgroundColor){let n=this._backgroundColor.alpha;Gl.backgroundShouldBeTransparent(this.context)&&(n=this.ARBackgroundAlpha??0),this.context.scene.background=null,(i=this.context.xr)!=null&&i.isVR?this.context.renderer.setClearColor(LO(this._backgroundColor).convertLinearToSRGB()):this.context.renderer.setClearColor(this._backgroundColor,n)}else pr&&console.warn(`Camera "${this.name}" has no background color`,this);break;case Ui.Uninitialized:this.context.scene.background=null,this.context.renderer.setClearColor(0,0);break}}applySceneSkybox(){this._skybox||(this._skybox=new uA(this)),this._skybox.apply()}static backgroundShouldBeTransparent(e){var r,l,c,h;const i=(r=e.renderer.xr)==null?void 0:r.getSession();if(!i)return!1;if(typeof i._transparent=="boolean")return i._transparent;const n=i.environmentBlendMode;pr&&tt("Environment blend mode: "+n+" on "+navigator.userAgent);let o=n==="additive"||n==="alpha-blend";return e.isInAR&&n==="opaque"&&((l=navigator.userAgent)!=null&&l.includes("OculusBrowser")||(c=navigator.userAgent)!=null&&c.includes("Mozilla")&&((h=navigator.userAgent)!=null&&h.includes("Mobile WebXRViewer/v2")))&&(o=!0),i._transparent=o,o}};let Se=Gl;a(Se,"_origin",new x),a(Se,"_direction",new x);Ii([m()],Se.prototype,"aspect",null);Ii([m()],Se.prototype,"fieldOfView",null);Ii([m()],Se.prototype,"nearClipPlane",null);Ii([m()],Se.prototype,"farClipPlane",null);Ii([m()],Se.prototype,"clearFlags",null);Ii([m()],Se.prototype,"orthographic",void 0);Ii([m()],Se.prototype,"orthographicSize",void 0);Ii([m()],Se.prototype,"ARBackgroundAlpha",void 0);Ii([m()],Se.prototype,"cullingMask",null);Ii([m()],Se.prototype,"backgroundBlurriness",null);Ii([m()],Se.prototype,"backgroundIntensity",null);Ii([m(di)],Se.prototype,"backgroundRotation",null);Ii([m()],Se.prototype,"environmentIntensity",null);Ii([m(Ae)],Se.prototype,"backgroundColor",null);Ii([m(ja)],Se.prototype,"targetTexture",null);class uA{constructor(t){a(this,"_camera");a(this,"_skybox");this._camera=t}get context(){var t;return(t=this._camera)==null?void 0:t.context}apply(){this._skybox=this.context.lightmaps.tryGetSkybox(this._camera.sourceId),this._skybox?this.context.scene.background!==this._skybox&&(pr&&console.log(`Camera "${this._camera.name}" set skybox`,this._camera,this._skybox),this._skybox.mapping=Mo,this.context.scene.background=this._skybox):this._did_log_failed_to_find_skybox||(this._did_log_failed_to_find_skybox=!0,console.warn(`Camera "${this._camera.name}" has no skybox texture. ${this._camera.sourceId}`))}}function fA(s){C("freecam")&&s.context.mainCameraComponent===s&&P.getOrAddComponent(s.gameObject,ke)}class Rr extends j{constructor(){super(...arguments);a(this,"_listener",null);a(this,"onInteraction",()=>{this.destroyed||this.listener==null||this.addListenerIfItExists()})}get listener(){return this._listener==null&&(this._listener=new DP),this._listener}onEnable(){Ws.registerWaitForInteraction(this.onInteraction),this.addListenerIfItExists()}onDisable(){Ws.unregisterWaitForInteraction(this.onInteraction),this.removeListenerIfItExists()}addListenerIfItExists(){const e=this._listener;if(!e||e!=null&&e.parent)return;const i=this.context.mainCameraComponent||P.getComponentInParent(this.gameObject,Se);i!=null&&i.threeCamera?i.threeCamera.add(e):this.gameObject.add(e),e.filter?(e.gain.connect(e.filter),e.filter.connect(e.context.destination)):e.gain.connect(e.context.destination)}removeListenerIfItExists(){const e=this._listener;e&&(e.removeFromParent(),e.filter&&e.filter.disconnect(),e.gain&&e.gain.disconnect())}}var cs=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const ni=C("debugaudio");var Vh;(function(s){s[s.Logarithmic=0]="Logarithmic",s[s.Linear=1]="Linear",s[s.Custom=2]="Custom"})(Vh||(Vh={}));class Oe extends j{constructor(){super(...arguments);a(this,"clip","");a(this,"playOnAwake",!1);a(this,"preload",!1);a(this,"playInBackground",!0);a(this,"_spatialBlend",0);a(this,"_minDistance",1);a(this,"_maxDistance",100);a(this,"_volume",1);a(this,"rollOffMode",0);a(this,"_loop",!1);a(this,"sound",null);a(this,"helper",null);a(this,"wasPlaying",!1);a(this,"audioLoader",null);a(this,"shouldPlay",!1);a(this,"_lastClipStartedLoading",null);a(this,"_audioElement",null);a(this,"onVisibilityChanged",()=>{switch(document.visibilityState){case"hidden":(this.playInBackground===!1||J.isMobileDevice())&&(this.wasPlaying=this.isPlaying,this.isPlaying&&this.pause());break;case"visible":ni&&console.log("visible",this.enabled,this.playOnAwake,!this.isPlaying,Oe.userInteractionRegistered,this.wasPlaying),this.enabled&&this.playOnAwake&&!this.isPlaying&&Oe.userInteractionRegistered&&this.wasPlaying&&this.play();break}});a(this,"onApplicationMuteChanged",()=>{var e,i;this.context.application.muted?(e=this.sound)==null||e.setVolume(0):(i=this.sound)==null||i.setVolume(this.volume)});a(this,"createAudio",e=>{ni&&console.log("AudioBuffer finished loading",e);const i=this.Sound;if(!i){ni&&console.warn("Failed getting sound?",this.name);return}i.isPlaying&&i.stop(),e&&i.setBuffer(e),i.loop=this._loop,this.context.application.muted?i.setVolume(0):i.setVolume(this.volume),i.autoplay=this.shouldPlay&&Oe.userInteractionRegistered,this.applySpatialDistanceSettings(),i.isPlaying&&i.stop(),Oe.registerWaitForAllowAudio(this.__onAllowAudioCallback)});a(this,"__onAllowAudioCallback",()=>{this.shouldPlay&&this.play()});a(this,"_lastContextTime",0);a(this,"_hasEnded",!0);a(this,"_needUpdateSpatialDistanceSettings",!1)}static get userInteractionRegistered(){return Ws.userInteractionRegistered}static registerWaitForAllowAudio(e){Ws.registerWaitForInteraction(e)}get isPlaying(){var e;return((e=this.sound)==null?void 0:e.isPlaying)??!1}get duration(){var e,i;return(i=(e=this.sound)==null?void 0:e.buffer)==null?void 0:i.duration}get time01(){var i;const e=this.duration;return e&&this.sound?((i=this.sound)==null?void 0:i.context.currentTime)/e:0}set time01(e){const i=this.duration;i&&this.sound&&(this.time=e*i)}get time(){var e,i;return(e=this.sound)!=null&&e.source?((i=this.sound.source)==null?void 0:i.context.currentTime)-this._lastContextTime+this.sound.offset:0}set time(e){if(this.sound){if(e===this.sound.offset)return;const i=this.isPlaying;this.stop(),this.sound.offset=e,i&&this.play()}}get loop(){return this.sound&&(this._loop=this.sound.getLoop()),this._loop}set loop(e){this._loop=e,this.sound&&this.sound.setLoop(e)}get spatialBlend(){return this._spatialBlend}set spatialBlend(e){e!==this._spatialBlend&&(this._spatialBlend=e,this._needUpdateSpatialDistanceSettings=!0)}get minDistance(){return this._minDistance}set minDistance(e){this._minDistance!==e&&(this._minDistance=e,this._needUpdateSpatialDistanceSettings=!0)}get maxDistance(){return this._maxDistance}set maxDistance(e){this._maxDistance!==e&&(this._maxDistance=e,this._needUpdateSpatialDistanceSettings=!0)}get volume(){return this._volume}set volume(e){this._volume=e,this.sound&&!this.context.application.muted&&(ni&&console.log(this.name,"audio set volume",e),this.sound.setVolume(e))}set pitch(e){this.sound&&this.sound.setPlaybackRate(e)}get pitch(){return this.sound?this.sound.getPlaybackRate():1}get Sound(){var e;if(!this.sound&&Oe.userInteractionRegistered){let i=this.gameObject.getComponent(Rr)??this.context.mainCamera.getComponent(Rr)??Wp(Rr,this.context,!1);!i&&this.context.mainCamera&&(i=this.context.mainCamera.addComponent(Rr)),i!=null&&i.listener?(this.sound=new LP(i.listener),(e=this.gameObject)==null||e.add(this.sound)):ni&&console.warn("No audio listener found in scene - can not play audio")}return this.sound}get ShouldPlay(){return this.shouldPlay}get audioContext(){var e;return(e=this.sound)==null?void 0:e.context}awake(){ni&&console.log(this),this.audioLoader=new ry,this.playOnAwake&&(this.shouldPlay=!0),this.preload&&typeof this.clip=="string"&&this.audioLoader.load(this.clip,this.createAudio,()=>{},console.error)}onEnable(){this.sound&&this.gameObject.add(this.sound),Oe.userInteractionRegistered?this.playOnAwake&&this.context.application.isVisible&&this.play():Oe.registerWaitForAllowAudio(()=>{this.enabled&&!this.destroyed&&this.shouldPlay&&this.onNewClip(this.clip)}),globalThis.addEventListener("visibilitychange",this.onVisibilityChanged),this.context.application.addEventListener(Da.MuteChanged,this.onApplicationMuteChanged)}onDisable(){globalThis.removeEventListener("visibilitychange",this.onVisibilityChanged),this.context.application.removeEventListener(Da.MuteChanged,this.onApplicationMuteChanged),this.pause()}applySpatialDistanceSettings(){const e=this.sound;if(!e)return;this._needUpdateSpatialDistanceSettings=!1;const i=W.lerp(10*this._maxDistance/Math.max(1e-4,this.spatialBlend),this._minDistance,this.spatialBlend);switch(ni&&console.log(this.name,this._minDistance,this._maxDistance,this.spatialBlend,"Ref distance="+i),e.setRefDistance(i),e.setMaxDistance(Math.max(.01,this._maxDistance)),this.rollOffMode){case Vh.Logarithmic:e.setDistanceModel("exponential");break;case Vh.Linear:e.setDistanceModel("linear");break;case Vh.Custom:console.warn("Custom rolloff for AudioSource is not supported: "+this.name);break}this.spatialBlend>0?ni&&!this.helper&&(this.helper=new FR(e,e.getRefDistance()),e.add(this.helper)):this.helper&&this.helper.parent&&this.helper.removeFromParent()}async onNewClip(e){if(e&&(this.clip=e),typeof e=="string")if(ni&&console.log(e),e.endsWith(".mp3")||e.endsWith(".wav")){if(this.audioLoader||(this.audioLoader=new ry),this.shouldPlay=!0,this._lastClipStartedLoading===e){ni&&console.log("Is currently loading:",this._lastClipStartedLoading,this);return}this._lastClipStartedLoading=e,ni&&console.log("load audio",e);const i=await this.audioLoader.loadAsync(e).catch(console.error);this._lastClipStartedLoading=null,i&&this.createAudio(i)}else console.warn("Unsupported audio clip type",e);else this.shouldPlay=!0,this.createAudio()}play(e=void 0){var n,o,r;!e&&this.clip&&(e=this.clip),e!==void 0&&typeof e!="string"&&!(e instanceof MediaStream)&&(U()&&console.warn("Called play on AudioSource with unknown argument type:",e+`
Using the assigned clip instead:`,this.clip),e=this.clip);let i=!this.sound||e&&e!==this.clip;if(typeof e=="string"&&!this.audioLoader&&(i=!0),(e instanceof MediaStream||typeof e=="string")&&(this.clip=e),i){this.shouldPlay=!0,this.onNewClip(e);return}if(this.shouldPlay=!0,this._hasEnded=!1,ni&&console.log("play",(n=this.sound)==null?void 0:n.getVolume(),this.sound),this.sound&&!this.sound.isPlaying){const l=this.context.application.muted;l&&this.sound.setVolume(0),(o=this.gameObject)==null||o.add(this.sound),this.clip instanceof MediaStream?(this.sound.setMediaStreamSource(this.clip),this._audioElement||(this._audioElement=document.createElement("audio"),this._audioElement.style.display="none"),this._audioElement.parentNode||(r=this.context.domElement.shadowRoot)==null||r.append(this._audioElement),this._audioElement.srcObject=this.clip,this._audioElement.autoplay=!1):(this._audioElement&&this._audioElement.remove(),this.sound.play(l?.1:0))}}pause(){var e,i;ni&&console.log("Pause",this),this._hasEnded=!0,this.shouldPlay=!1,this.sound&&this.sound.isPlaying&&this.sound.source&&(this._lastContextTime=(e=this.sound)==null?void 0:e.context.currentTime,this.sound.pause()),(i=this._audioElement)==null||i.remove()}stop(){var e,i;ni&&console.log("Pause",this),this._hasEnded=!0,this.shouldPlay=!1,this.sound&&this.sound.source&&(this._lastContextTime=(e=this.sound)==null?void 0:e.context.currentTime,ni&&console.log(this._lastContextTime),this.sound.stop()),(i=this._audioElement)==null||i.remove()}update(){this.helper&&(this.isPlaying&&this.helper.update(),this.helper.visible=this.isPlaying),this._needUpdateSpatialDistanceSettings&&this.applySpatialDistanceSettings(),this.sound&&!this.sound.isPlaying&&this.shouldPlay&&!this._hasEnded&&(this._hasEnded=!0,ni&&console.log("Audio clip ended",this.clip),this.dispatchEvent(new CustomEvent("ended",{detail:this})))}}cs([m(URL)],Oe.prototype,"clip",void 0);cs([m()],Oe.prototype,"playOnAwake",void 0);cs([m()],Oe.prototype,"preload",void 0);cs([m()],Oe.prototype,"playInBackground",void 0);cs([m()],Oe.prototype,"loop",null);cs([m()],Oe.prototype,"spatialBlend",null);cs([m()],Oe.prototype,"minDistance",null);cs([m()],Oe.prototype,"maxDistance",null);cs([m()],Oe.prototype,"volume",null);cs([m()],Oe.prototype,"pitch",null);cs([m()],Oe.prototype,"rollOffMode",void 0);const pA=C("debugavatar"),Vn=class extends j{constructor(){super(...arguments);a(this,"connectionId");a(this,"avatar")}static getAvatar(e){return e>=0&&e<Vn.instances.length?Vn.instances[e]:null}static onAvatarMarkerCreated(e){return Vn._onNewAvatarMarkerAdded.push(e),e}static onAvatarMarkerDestroyed(e){return Vn._onAvatarMarkerDestroyed.push(e),e}awake(){Vn.instances.push(this),pA&&console.log(this);for(const e of Vn._onNewAvatarMarkerAdded)e({avatarMarker:this,gameObject:this.gameObject})}onDestroy(){Vn.instances.splice(Vn.instances.indexOf(this),1);for(const e of Vn._onAvatarMarkerDestroyed)e({avatarMarker:this,gameObject:this.gameObject})}isLocalAvatar(){return this.connectionId===this.context.connection.connectionId}};let It=Vn;a(It,"instances",[]),a(It,"_onNewAvatarMarkerAdded",[]),a(It,"_onAvatarMarkerDestroyed",[]);class Do{static Add(t,e,i=null){if(e){for(const n of this.Pois)if(n.obj===e)return;this.Pois.push({obj:e,avatar:i}),this.LastChangeTime=t.time.time}}static Remove(t,e){var i;if(e){for(const n of this.Pois)if(n.obj===e){this.Pois.splice(this.Pois.indexOf(n),1),this.LastChangeTime=(t==null?void 0:t.time.time)??((i=ne.Current)==null?void 0:i.time.time);return}}}}a(Do,"Pois",[]),a(Do,"LastChangeTime",0);var zf;(function(s){s.TargetChanged="avatar-look-target-changed"})(zf||(zf={}));class mA{constructor(){a(this,"guid");a(this,"position",new x)}}class Uf extends j{constructor(){super(...arguments);a(this,"target",null);a(this,"avatar",null);a(this,"_model",null);a(this,"_targetModel",new mA);a(this,"_currentTargetObject",null);a(this,"_lastUpdateTime",0);a(this,"_lookDuration",0);a(this,"_lastPoiChangedTime",0)}set controlledTarget(e){this.target=e;const i=w.get("MoveRandom");if(i&&this.target){const n=P.getComponent(this.target,i);n&&n.destroy()}}awake(){if(this.avatar=P.getComponentInParent(this.gameObject,It),this.avatar){const e=P.getComponentInParent(this.gameObject,It);this._model=new QS(this.context.connection,this.guid),e!=null&&e.isLocalAvatar&&this._model.requestOwnership()}this.context.connection.beginListen(zf.TargetChanged,e=>{var i;this.target&&e&&e.guid===((i=this.avatar)==null?void 0:i.guid)&&jt(this.target,e.position)})}update(){var i;if((!this.context.connection.isConnected||(i=this._model)!=null&&i.hasOwnership)&&(Do.LastChangeTime!==this._lastPoiChangedTime&&(this._lastPoiChangedTime=Do.LastChangeTime,this._lookDuration=0),this.selectTarget(),this._currentTargetObject&&this.context.time.frameCount%10===0&&this.target)){const n=ae(this._currentTargetObject);jt(this.target,n),this.context.connection.isConnected&&this.avatar&&(this.context.connection.send(zf.TargetChanged,this._targetModel),this._targetModel.guid=this.avatar.guid,this._targetModel.position.copy(n))}}selectTarget(){if(this.context.time.time-this._lastUpdateTime>this._lookDuration){this._lastUpdateTime=this.context.time.time,this._lookDuration=Math.random()*.5+.2;const i=Do.Pois;if(i.length>0){const n=i[Math.floor(Math.random()*i.length)];if(n&&n.obj){if(n.avatar&&n.avatar===this.avatar)return;this._currentTargetObject=n.obj}}}}}var Nf;(function(s){s[s.None=0]="None",s[s.DontExport=1]="DontExport"})(Nf||(Nf={}));function gA(s){return s&&s.isComponent}const BL=Symbol("object"),xg=new Dn(()=>new x,20);class yA{constructor(t,e,i,n,o,r){a(this,"_point");a(this,"_normal");a(this,"_tangentVelocity");a(this,"distance");a(this,"impulse");a(this,"friction");this._point=t,this.distance=e,this._normal=i,this.impulse=n,this.friction=o,this._tangentVelocity=r}get point(){return xg.get().set(this._point.x,this._point.y,this._point.z)}get normal(){return xg.get().set(this._normal.x,this._normal.y,this._normal.z)}get tangentVelocity(){return xg.get().set(this._tangentVelocity.x,this._tangentVelocity.y,this._tangentVelocity.z)}}class _A{constructor(t,e,i){a(this,"contacts");a(this,"me");a(this,"_collider");a(this,"_gameObject");this.me=t,this._collider=e,this._gameObject=e.gameObject,this.contacts=i}get collider(){return this._collider}get gameObject(){return this._gameObject}get rigidBody(){var t;return(t=this.collider)==null?void 0:t.attachedRigidbody}}class bA{constructor(t,e){a(this,"object");a(this,"collider");this.object=t,this.collider=e}}const dt=C("debugnetworkingstreams");var rt;(function(s){s.Connected="peer-user-connected",s.StreamReceived="receive-stream",s.StreamEnded="call-ended",s.Disconnected="peer-user-disconnected",s.UserJoined="user-joined"})(rt||(rt={}));class $C{constructor(t,e){a(this,"type",rt.StreamEnded);a(this,"userId");a(this,"direction");this.userId=t,this.direction=e}}class vA{constructor(t,e,i){a(this,"type",rt.StreamReceived);a(this,"userId");a(this,"stream");a(this,"target");this.userId=t,this.stream=e,this.target=i}}class xA{constructor(t,e){a(this,"guid");a(this,"peerId");a(this,"dontSave",!0);this.guid=t.id,this.peerId=e}}var So;(function(s){s.Incoming="incoming",s.Outgoing="outgoing"})(So||(So={}));class wA extends R_{constructor(e,i,n,o=null){super();a(this,"peerId");a(this,"userId");a(this,"direction");a(this,"call");a(this,"_stream",null);a(this,"_isDisposed",!1);this.peerId=i.peer,this.userId=e,this.call=i,this.direction=n,this._stream=o,i.on("stream",r=>{if(dt&&console.log("Receive stream",`
Audio:`,r.getAudioTracks(),`
Video:`,r.getVideoTracks()),this._stream=r,n===So.Incoming){const l=new vA(e,r,this);this.dispatchEvent(l)}}),i.on("close",()=>{this.dispatchEvent(new $C(e,n))})}get stream(){return this._stream}close(){this._isDisposed||(this._isDisposed=!0,this.call.close(),Ro(this._stream))}get isOpen(){var e;return((e=this.call.peerConnection)==null?void 0:e.connectionState)==="connected"}get isOpening(){var e;return((e=this.call.peerConnection)==null?void 0:e.connectionState)==="connecting"}get isClosed(){return!this.isOpen||this._isDisposed}}function nx(s){return s=s.replace("a=fmtp:111 minptime=10;useinbandfec=1","a=fmtp:111 ptime=5;useinbandfec=1;stereo=1;maxplaybackrate=48000;maxaveragebitrat=128000;sprop-stereo=1"),s}const ql=class extends R_{constructor(e,i){super();a(this,"updateCalls",()=>{var e;for(let i=this._incomingCalls.length-1;i>=0;i--){const n=this._incomingCalls[i];n.isClosed&&!n.isOpening&&this._incomingCalls.splice(i,1)}for(let i=this._outgoingCalls.length-1;i>=0;i--){const n=this._outgoingCalls[i];let o=!1;n.isClosed&&!n.isOpening&&((e=n.stream)!=null&&e.active?dt&&console.warn("!!! Stream is still active, don't remove call",n.userId,"Your id: "+this.context.connection.connectionId):(dt&&console.warn("!!! Remove closed call",n.userId),o=!0)),this.context.connection.userIsInRoom(n.userId)===!1&&(dt&&console.warn("!!! User is not in room anymore, remove call",n.userId),o=!0),o&&(n.close(),this._outgoingCalls.splice(i,1))}});a(this,"id");a(this,"context");a(this,"_incomingCalls",[]);a(this,"_outgoingCalls",[]);a(this,"_peer");a(this,"_enabled",!1);a(this,"_enabledPeer",!1);a(this,"onConnectRoomFn",this.onConnectRoom.bind(this));a(this,"onPeerConnect",e=>{if(dt&&console.log("PEER opened as",e),e===null){console.error("Peer connection failed",e);return}this.context.connection.send(rt.Connected,new xA(this,e))});a(this,"onPeerClose",()=>{dt&&console.log("PEER closed"),this.updateCalls()});a(this,"onPeerDisconnected",()=>{dt&&console.log("PEER disconnected"),this.updateCalls()});a(this,"onPeerError",e=>{dt&&console.error("PEER error",e)});a(this,"onPeerReceivingCall",e=>{e.answer(void 0,{sdpTransform:i=>nx(i)}),this.registerCall(e,So.Incoming,null)});this.context=e,this.id=i,this.setupPeer(),navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia}static getOrCreate(e,i){if(ql.instances.has(i))return ql.instances.get(i);const n=new ql(e,i);return ql.instances.set(i,n),n}getMyPeerId(){if(this.context.connection.connectionId)return this.getPeerIdFromUserId(this.context.connection.connectionId)}getPeerIdFromUserId(e){return this.id+"-"+e}getUserIdFromPeerId(e){return e.substring(this.id.length+1)}makeCall(e,i){var r;if(!(i!=null&&i.id)){dt?console.warn("Can not make a call: mediastream has no id or is undefined"):console.debug("Can not make a call: mediastream has no id or is undefined");return}const n={metadata:{userId:this.context.connection.connectionId,streamId:i.id},sdpTransform:l=>nx(l)},o=(r=this._peer)==null?void 0:r.call(e,i,n);if(o){const l=this.registerCall(o,So.Outgoing,i);return dt&&console.warn(`üìû CALL ${e}`,`
Outgoing:`,this._outgoingCalls,`
Incoming:`,this._incomingCalls),l}else dt&&console.error("Failed to make call",e,i,this._peer)}closeAll(){for(const e of this._incomingCalls)e.close();for(const e of this._outgoingCalls)e.close();this.updateCalls()}get peer(){return this._peer}get incomingCalls(){return this._incomingCalls}enable(){this._enabled||(this._enabled=!0,this.context.connection.beginListen(se.JoinedRoom,this.onConnectRoomFn),this.subscribePeerEvents())}disable(){this._enabled&&(this._enabled=!1,this.context.connection.stopListen(se.JoinedRoom,this.onConnectRoomFn),this.unsubscribePeerEvents())}onConnectRoom(){this.setupPeer()}setupPeer(){if(this.context.connection.connectionId&&!this._enabledPeer){if(this._enabledPeer=!0,!this._peer){const e=this.getMyPeerId();e?this._peer=bk(e):console.error("Failed to setup peerjs because we dont have a connection id",this.context.connection.connectionId)}this._enabled&&this.subscribePeerEvents()}}subscribePeerEvents(){this._peer&&(this._peer.on("open",this.onPeerConnect),this._peer.on("close",this.onPeerClose),this._peer.on("call",this.onPeerReceivingCall),this._peer.on("disconnected",this.onPeerDisconnected),this._peer.on("error",this.onPeerError))}unsubscribePeerEvents(){this._peer&&(this._peer.off("open",this.onPeerConnect),this._peer.off("close",this.onPeerClose),this._peer.off("call",this.onPeerReceivingCall),this._peer.off("disconnected",this.onPeerDisconnected),this._peer.off("error",this.onPeerError))}registerCall(e,i,n){const o=e.metadata;(!o||!o.userId)&&console.error("Missing call metadata",e);const r=o.userId;i===So.Incoming&&dt?console.warn("‚Üê Receive call from",e.metadata,e.connectionId):dt&&console.warn("‚Üí Make call to",e.metadata);const l=i===So.Incoming?this._incomingCalls:this._outgoingCalls,c=new wA(r,e,i,n);return l.push(c),e.on("error",h=>{console.error("Call error",h)}),e.on("close",()=>{dt&&console.log("Call ended",e.metadata);const h=l.indexOf(c);h!==-1&&l.splice(h,1),c.close(),this.dispatchEvent(new $C(r,i))}),c.addEventListener(rt.StreamEnded,h=>{this.dispatchEvent(h)}),i===So.Incoming&&(c.addEventListener(rt.StreamReceived,h=>{this.dispatchEvent(h)}),e.on("stream",()=>{dt&&console.log("Received stream for call",e.metadata);let h=0;const d=setInterval(()=>{const u=h===0;!c.isOpen&&u&&(dt&&console.warn("Close call because stream is not active",e.metadata),h+=1,clearInterval(d),c.close())},2e3)})),c}};let rc=ql;a(rc,"instances",new Map);class Xp extends R_{constructor(e,i){super();a(this,"context");a(this,"peer");a(this,"_sendingStreams",new Map);a(this,"debug",!1);a(this,"_enabled",!1);a(this,"_tickIntervalId");a(this,"tick",()=>{this.updateSendingCalls()});a(this,"onJoinedRoom",e=>{this._sendingStreams.size>0&&(this.debug&&console.warn(`${e!=null&&e.userId?`User ${e.userId}`:"You"} joined room`,e,this._sendingStreams.size),this.updateSendingCalls())});a(this,"onLeftRoom",e=>{this.debug&&console.warn(`${(e==null?void 0:e.userId)||"You"} left room`,e),this.stopCallsToUsersThatAreNotInTheRoomAnymore(),this.peer.closeAll()});a(this,"onCallStreamReceived",e=>{this.debug&&console.log("Call with "+e.userId+" started"),this.dispatchEvent({type:rt.StreamReceived,target:this,stream:e.stream,userId:e.userId}),this.debug&&this.debugLogCurrentState()});a(this,"onCallEnded",e=>{this.debug&&console.log("Call with "+e.userId+" ended"),this.dispatchEvent(e),this.debug&&this.debugLogCurrentState()});a(this,"onUserConnected",e=>{if(this.peer.id===e.guid){this.debug&&console.log("PEER USER CONNECTED",e.guid,e,this._sendingStreams.size);const i=this._sendingStreams.keys().next().value;this.peer.makeCall(e.peerId,i)}else dt&&console.log("Unknown user connected",e.guid,e.peerId)});a(this,"onUserLeft",e=>{this.debug&&console.log("User left room: "+e.userId),this.stopCallsToUsersThatAreNotInTheRoomAnymore()});if(gA(e)){const n=e;e=n.context,i=rc.getOrCreate(n.context,n.guid)}else typeof i=="string"&&(i=rc.getOrCreate(e,i));if(e){if(!(e instanceof ne))throw new Error("Failed to create NetworkedStreams because context is not an instance of Context")}else throw new Error("Failed to create NetworkedStreams because context is undefined");if(!i)throw new Error("Failed to create NetworkedStreams because peer is undefined");this.context=e,this.peer=i,dt&&(this.debug=!0)}static create(e,i){const n=rc.getOrCreate(e.context,i||e.context.connection.connectionId||e.guid);return new Xp(e.context,n)}startSendingStream(e){this._sendingStreams.has(e)?console.warn("Received start sending stream with stream that is already being sent"):(this._sendingStreams.set(e,[]),this.updateSendingCalls())}stopSendingStream(e){if(e){const i=this._sendingStreams.get(e);if(i){for(const n of i)n.close();i.length=0}this._sendingStreams.delete(e),i&&this.debug&&this.debugLogCurrentState()}this.updateSendingCalls()}get enabled(){return this._enabled}enable(){this._enabled||(this._enabled=!0,this.peer.enable(),this.peer.addEventListener(rt.StreamReceived,this.onCallStreamReceived),this.peer.addEventListener(rt.StreamEnded,this.onCallEnded),this.context.connection.beginListen(rt.Connected,this.onUserConnected),this.context.connection.beginListen(se.JoinedRoom,this.onJoinedRoom),this.context.connection.beginListen(se.UserJoinedRoom,this.onJoinedRoom),this.context.connection.beginListen(se.UserLeftRoom,this.onUserLeft),this.context.connection.beginListen(se.LeftRoom,this.onLeftRoom),this._tickIntervalId=setInterval(this.tick,5e3))}disable(){this._enabled&&(this._enabled=!1,this.peer.disable(),this.peer.removeEventListener(rt.StreamReceived,this.onCallStreamReceived),this.peer.removeEventListener(rt.StreamEnded,this.onCallEnded),this.context.connection.stopListen(rt.Connected,this.onUserConnected),this.context.connection.stopListen(se.JoinedRoom,this.onJoinedRoom),this.context.connection.stopListen(se.UserJoinedRoom,this.onJoinedRoom),this.context.connection.stopListen(se.UserLeftRoom,this.onUserLeft),this.context.connection.stopListen(se.LeftRoom,this.onLeftRoom),this._tickIntervalId!=null&&(clearInterval(this._tickIntervalId),this._tickIntervalId=void 0))}updateSendingCalls(){const e=this.context.connection.connectionId;for(const i of this._sendingStreams.keys()){const n=this._sendingStreams.get(i)||[];for(const o of this.context.connection.usersInRoom()){if(o===e)continue;const r=this.peer.getPeerIdFromUserId(o);if(n.find(c=>{var h;return c.peerId===r&&c.direction===So.Outgoing&&!c.isClosed&&((h=c.stream)==null?void 0:h.active)}))dt&&console.debug("Already have a call with user "+o+" / peer "+r);else{const c=this.peer.makeCall(r,i);c&&n.push(c)}}this._sendingStreams.set(i,n)}this.stopCallsToUsersThatAreNotInTheRoomAnymore()}stopCallsToUsersThatAreNotInTheRoomAnymore(){for(const e of this._sendingStreams.keys()){const i=this._sendingStreams.get(e);if(i)for(let n=i.length-1;n>=0;n--){const o=i[n];this.context.connection.userIsInRoom(o.userId)?dt&&(this.context.connection.connectionId===o.userId?console.warn(`You are still in the room [${n}] ${o.userId}`):console.log(`User is still in room [${n}] ${o.userId}`)):(dt&&console.log(`Remove call ${[n]} to user that is not in room anymore ${o.userId}`),o.close(),i.splice(n,1))}}this.peer.updateCalls(),this.debug&&this.debugLogCurrentState()}debugLogCurrentState(){console.warn(`You (${this.context.connection.connectionId}) are currently sending ${this._sendingStreams.size} and receiving ${this.peer.incomingCalls.length} calls (${this.peer.incomingCalls.map(e=>e.userId).join(", ")})`,this.peer.incomingCalls)}}function Ro(s){if(s&&s instanceof MediaStream)for(const t of s.getTracks())t.stop()}var rb=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const SA="noVoip",CA=C("debugvoip");class tl extends j{constructor(){super(...arguments);a(this,"autoConnect",!0);a(this,"runInBackground",!0);a(this,"createMenuButton",!0);a(this,"debug",!1);a(this,"_net");a(this,"_menubutton");a(this,"_allowSending",!0);a(this,"_outputStream",null);a(this,"onJoinedRoom",async()=>{this.debug&&console.log("VOIP: Joined room"),await Xs(300),this.autoConnect&&!this.isSending&&this._allowSending&&this.connect()});a(this,"onLeftRoom",()=>{this.debug&&console.log("VOIP: Left room"),this.disconnect();for(const e of this._incomingStreams.values())Ro(e.srcObject);this._incomingStreams.clear()});a(this,"_incomingStreams",new Map);a(this,"onReceiveStream",e=>{const i=e.target.userId,n=e.stream;let o=this._incomingStreams.get(i);o||(o=new Audio,this._incomingStreams.set(i,o)),o.srcObject=n,o.setAttribute("autoplay","true"),Ws.registerWaitForInteraction(()=>{o==null||o.play().catch(r=>{console.error("VOIP: Failed to play audio",r)})})});a(this,"onStreamEnded",e=>{const i=this._incomingStreams.get(e.userId);Ro(i==null?void 0:i.srcObject),this._incomingStreams.delete(e.userId)});a(this,"onEnabledChanged",()=>{for(const e of this._incomingStreams){const i=e[1];i.muted=!this.enabled}});a(this,"onVisibilityChanged",()=>{if(this.runInBackground)return;const i=!(document.visibilityState==="visible");this.setMuted(i);for(const n of this._incomingStreams){const o=n[1];o.muted=i}})}awake(){CA&&(this.debug=!0),this.debug&&(console.log("VOIP debugging: press 'v' to toggle mute or 'c' to toggle connect/disconnect"),window.addEventListener("keydown",async e=>{switch(e.key.toLowerCase()){case"v":console.log("MUTE?",!this.isMuted),this.setMuted(!this.isMuted);break;case"c":this.isSending?this.disconnect():this.connect();break}}),window.addEventListener("blur",()=>{console.log("VOIP: MUTE ON BLUR"),this.setMuted(!0)}),window.addEventListener("focus",()=>{console.log("VOIP: UNMUTE ON FOCUS"),this.setMuted(!1)}))}onEnable(){this._net||(this._net=Xp.create(this)),this.debug&&(this._net.debug=!0),this._net.addEventListener(rt.StreamReceived,this.onReceiveStream),this._net.addEventListener(rt.StreamEnded,this.onStreamEnded),this._net.enable(),this.autoConnect&&this.context.connection.isConnected&&this.connect(),this.context.connection.beginListen(se.JoinedRoom,this.onJoinedRoom),this.context.connection.beginListen(se.LeftRoom,this.onLeftRoom),this.onEnabledChanged(),this.updateButton(),window.addEventListener("visibilitychange",this.onVisibilityChanged)}onDisable(){var e;this._net&&(this._net.stopSendingStream(this._outputStream),this._net.removeEventListener(rt.StreamReceived,this.onReceiveStream),this._net.removeEventListener(rt.StreamEnded,this.onStreamEnded),(e=this._net)==null||e.disable()),this.context.connection.stopListen(se.JoinedRoom,this.onJoinedRoom),this.context.connection.stopListen(se.LeftRoom,this.onLeftRoom),this.onEnabledChanged(),this.updateButton(),window.removeEventListener("visibilitychange",this.onVisibilityChanged)}onDestroy(){var e;(e=this._menubutton)==null||e.remove(),this._menubutton=void 0}get isSending(){return this._outputStream!=null&&this._outputStream.active}async connect(e){var i,n;if(!this._net)return console.error("Cannot connect to voice chat - NetworkedStreams not initialized. Make sure the component is enabled before calling this method."),!1;if(this.context.connection.isConnected){if(!await J.microphonePermissionsGranted())return console.error("Cannot connect to voice chat - microphone permissions not granted"),this.updateButton(),!1}else return console.error("Cannot connect to voice chat - not connected to server"),this.updateButton(),!1;return this._allowSending=!0,(i=this._net)==null||i.stopSendingStream(this._outputStream),Ro(this._outputStream),this._outputStream=await this.getAudioStream(e),this._outputStream?(this.debug&&console.log("VOIP: Got audio stream"),(n=this._net)==null||n.startSendingStream(this._outputStream),this.updateButton(),!0):(this.updateButton(),await J.microphonePermissionsGranted()?console.error("VOIP: Could not get audio stream - please make sure to connect an audio device and grant microphone permissions"):Dp("Microphone permissions not granted: Please grant microphone permissions to use voice chat"),(this.debug||U())&&console.log("VOIP: Failed to get audio stream"),!1)}disconnect(e){var i;e!=null&&e.remember&&(this._allowSending=!1),(i=this._net)==null||i.stopSendingStream(this._outputStream),Ro(this._outputStream),this._outputStream=null,this.updateButton()}setMuted(e){var n;const i=(n=this._outputStream)==null?void 0:n.getAudioTracks();if(i)for(const o of i)o.enabled=!e}get isMuted(){var i;if(this._outputStream===null)return!1;const e=(i=this._outputStream)==null?void 0:i.getAudioTracks();if(e){for(const n of e)if(!n.enabled)return!0}return!1}async updateButton(){var e;if(this.createMenuButton){if(this._menubutton||(this._menubutton=document.createElement("button"),this._menubutton.addEventListener("click",()=>{this.isSending?this.disconnect({remember:!0}):this.connect(),J.microphonePermissionsGranted().then(i=>{i||Me("<strong>Microphone permissions not granted</strong>. Please allow your browser to use the microphone to be able to talk. Click on the button on the left side of your browser's address bar to allow microphone permissions.")})})),this._menubutton){this.context.menu.appendChild(this._menubutton),this.activeAndEnabled?this._menubutton.style.display="":this._menubutton.style.display="none",this._menubutton.title=this.isSending?"Click to disable your microphone":"Click to enable your microphone";let i=(this.isSending,""),n=this.isSending?"mic":"mic_off";await J.microphonePermissionsGranted()||(i="No Permission",n="mic_off",this._menubutton.title="Microphone permissions not granted. Please allow your browser to use the microphone to be able to talk. This can usually be done in the addressbar of the webpage."),this._menubutton.innerText=i,this._menubutton.prepend(li(n)),this.context.connection.isConnected==!1?this._menubutton.setAttribute("disabled",""):this._menubutton.removeAttribute("disabled")}}else this.activeAndEnabled||(e=this._menubutton)==null||e.remove()}getFrequency(e){return this.unsupported_getfrequency||(this.unsupported_getfrequency=!0,U()&&Me("VOIP: getFrequency is currently not supported"),console.warn("VOIP: getFrequency is currently not supported")),null}async getAudioStream(e){if(!navigator.mediaDevices.getUserMedia)return console.error("No getDisplayMedia support"),null;const i=async o=>await navigator.mediaDevices.getUserMedia({audio:o??!0,video:!1}).catch(r=>(console.warn("VOIP failed getting audio stream",r),null)),n=await i(e);if(!n)return null;if(J.isiOS()&&(e==null?void 0:e.deviceId)===void 0){const r=(await navigator.mediaDevices.enumerateDevices()).find(l=>(l.kind==="audioinput"||l.kind==="audiooutput")&&!l.label.includes("iPhone"));if(r){const l=Object.assign({},e);return l.deviceId=r.deviceId,await i(l)}}return n}}rb([m()],tl.prototype,"autoConnect",void 0);rb([m()],tl.prototype,"runInBackground",void 0);rb([m()],tl.prototype,"createMenuButton",void 0);var WC=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const PA=C("debugmouth");class Qp extends j{constructor(){super(...arguments);a(this,"idle",[]);a(this,"talking",[]);a(this,"marker",null);a(this,"voip",null);a(this,"lastMouthChangeTime",0);a(this,"mouthChangeLength",0)}awake(){setTimeout(()=>{this.voip=P.findObjectOfType(tl,this.context),this.marker||(this.marker=P.getComponentInParent(this.gameObject,It))},3e3)}update(){var n;if(!this.voip||this.context.time.frameCount%10!==0)return;let e=((n=this.marker)==null?void 0:n.connectionId)??null;if(!e){PA&&(e=null);return}const i=this.voip.getFrequency(e)??0;this.updateLips(i)}updateLips(e){if(this.context.time.time-this.lastMouthChangeTime>this.mouthChangeLength){if(this.mouthChangeLength=.05+Math.random()*.1,this.talking&&this.talking.length>0&&e>30){this.lastMouthChangeTime=this.context.time.time;const i=Math.floor(Math.random()*this.talking.length);this.setMouthShapeActive(this.talking,i)}else if(this.idle.length>0&&this.context.time.time-this.lastMouthChangeTime>.5){this.lastMouthChangeTime=this.context.time.time;const i=Math.floor(Math.random()*this.idle.length);this.setMouthShapeActive(this.idle,i)}}}setMouthShapeActive(e,i){if(e){e!=this.idle?this.idle.map(n=>n.visible=!1):this.talking.map(n=>n.visible=!1);for(let n=0;n<e.length;n++){const o=e[n];o&&(o.visible=n===i)}}}}WC([m(F)],Qp.prototype,"idle",void 0);WC([m(F)],Qp.prototype,"talking",void 0);class VC extends j{constructor(){super(...arguments);a(this,"voip",null);a(this,"marker",null);a(this,"_startPosition",null)}awake(){this.voip=P.findObjectOfType(tl,this.context),this.marker=P.getComponentInParent(this.gameObject,It)}update(){if(!this.voip||!this.marker||this.context.time.frameCount%10!==0)return;const e=this.marker.connectionId,i=this.voip.getFrequency(e);if(i==null)return;this._startPosition||(this._startPosition=this.gameObject.position.clone());const n=i/100;this.gameObject.position.y=this._startPosition.y+n*.07}}var RA=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const Al=C("debugxrflags"),HC=C("disablexrflags");HC&&console.warn("XRFlags are disabled");var Tn;(function(s){s[s.Never=0]="Never",s[s.Browser=1]="Browser",s[s.AR=2]="AR",s[s.VR=4]="VR",s[s.FirstPerson=8]="FirstPerson",s[s.ThirdPerson=16]="ThirdPerson",s[s.All=4294967295]="All"})(Tn||(Tn={}));const Qb=class{constructor(){a(this,"Mask",Tn.Browser|Tn.ThirdPerson)}Has(t){return(this.Mask&t)!==0}Set(t){Al&&console.warn("Set XR flag state to",t),this.Mask=t,qt.Apply()}Enable(t){this.Mask|=t,qt.Apply()}Disable(t){this.Mask&=~t,qt.Apply()}Toggle(t){this.Mask^=t,qt.Apply()}EnableAll(){this.Mask=-1,qt.Apply()}DisableAll(){this.Mask=0,qt.Apply()}};let ci=Qb;a(ci,"Global",new Qb);const Cs=class extends j{constructor(){super(...arguments);a(this,"visibleIn")}static Apply(){for(const e of this.registry)e.UpdateVisible(ci.Global)}awake(){Cs.registry.push(this)}onEnable(){Cs.firstApply?this.UpdateVisible(ci.Global):(Cs.firstApply=!0,Cs.Apply())}onDestroy(){const e=Cs.registry.indexOf(this);e>=0&&Cs.registry.splice(e,1)}get isOn(){return this.gameObject.visible}UpdateVisible(e=null){if(HC)return;let i;const n=e;if(n&&typeof n=="number"&&(console.assert(typeof n=="number","XRFlag.UpdateVisible: state must be a number",n),Al&&console.log(n),Cs.buffer.Mask=n,e=Cs.buffer),e instanceof ci?(Al&&console.warn(this.name,"use passed in mask",e.Mask,this.visibleIn),i=e.Has(this.visibleIn)):(Al&&console.log(this.name,"use global mask"),ci.Global.Has(this.visibleIn)),i!==void 0)if(i)Al&&console.log(this.name,"is visible",this.gameObject.uuid),P.setActive(this.gameObject,!0);else{if(Al&&console.log(this.name,"is not visible",this.gameObject.uuid),!this.gameObject.visible)return;this.gameObject.visible=!1}}};let qt=Cs;a(qt,"registry",[]),a(qt,"firstApply"),a(qt,"buffer",new ci);RA([m()],qt.prototype,"visibleIn",void 0);var Yp=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};class Lc extends j{constructor(){super(...arguments);a(this,"eyes",[]);a(this,"lastBlinkTime",0);a(this,"blinkLength",0);a(this,"eyesOpen",!0);a(this,"state",null)}awake(){this.state=P.getComponentInParent(this.gameObject,qt)}update(){if(!this.gameObject||!this.gameObject.visible||!this.eyes||!Array.isArray(this.eyes)||this.eyes.length===0)return;if(this.context.time.time-this.lastBlinkTime>this.blinkLength){if(this.lastBlinkTime=this.context.time.time,this.state&&!this.state.isOn||!this.activeAndEnabled)return;if(this.eyesOpen=!this.eyesOpen,this.blinkLength=Math.random(),this.eyesOpen?(this.blinkLength*=3,this.blinkLength+=.5,Math.random()<.1&&(this.blinkLength=.1+Math.random()*.2)):(this.blinkLength*=Math.random()*.2,this.blinkLength+=.1),Math.random()<.1&&(this.blinkLength*=3),this.blinkLength=Math.max(.2,this.blinkLength),this.blinkLength=Math.min(3,this.blinkLength),this.eyes)for(const i of this.eyes)i&&(i.visible=this.eyesOpen)}}}Yp([m(F)],Lc.prototype,"eyes",void 0);Yp([m()],Lc.prototype,"lastBlinkTime",void 0);Yp([m()],Lc.prototype,"blinkLength",void 0);Yp([m()],Lc.prototype,"eyesOpen",void 0);var ab=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const Yb=class extends j{constructor(){super(...arguments);a(this,"head",null);a(this,"eyes",null);a(this,"target",null);a(this,"brain",null);a(this,"vec",new x);a(this,"currentTargetPoint",new x)}awake(){this.brain||(this.brain=P.getComponentInParent(this.gameObject,Uf)),this.brain||(this.brain=P.addComponent(this.gameObject,Uf)),this.brain&&this.target&&(this.brain.controlledTarget=this.target)}update(){const e=this.target;if(e&&this.head){const i=this.eyes;if(i){const n=ae(e);this.currentTargetPoint.lerp(n,this.context.time.deltaTime/.1);const o=ae(this.head),r=this.vec.copy(this.currentTargetPoint).sub(o).normalize();if(r.length()<.1)return;const l=Yb.forward;if(l.set(0,0,1),l.applyQuaternion(Le(this.head)),l.dot(r)>.45)for(let h=0;h<i.length;h++)i[h].lookAt(this.currentTargetPoint)}}}};let jr=Yb;a(jr,"forward",new x(0,0,1));ab([m(F)],jr.prototype,"head",void 0);ab([m(F)],jr.prototype,"eyes",void 0);ab([m(F)],jr.prototype,"target",void 0);const mh=C("debugavatar");class lb{constructor(t,e,i,n){a(this,"root");a(this,"head");a(this,"leftHand");a(this,"rigthHand");var o;this.root=t,this.head=e,this.leftHand=i,this.rigthHand=n,(o=this.root)==null||o.traverse(r=>r.layers.set(2))}get isValid(){return this.head!==null&&this.head!==void 0}}class GC{constructor(){a(this,"avatarRegistryUrl",null)}async getOrCreateNewAvatarInstance(t,e){if(!e)return console.error("Can not create avatar: failed to provide id or root object"),null;let i=null;if(typeof e=="string"){if(i=await this.loadAvatar(t,e),!i){const o=new Js;i=P.instantiate(bd(e,t.scene),o)}}else i=e;if(!i)return null;const n=this.findAvatar(i);return n.isValid?(mh&&console.log("[Custom Avatar] valid config",e,mh?n:""),n):(console.warn("[Custom Avatar] config isn't valid",e,mh?n:""),null)}async loadAvatar(t,e){if(console.assert(e!=null&&typeof e=="string","Avatar id must not be null"),e.length<=0||!e)return null;if(mh&&console.log("[Custom Avatar] "+e+", loading..."),e.endsWith(".glb")||(e+=".glb"),this.avatarRegistryUrl===null){const n=await fetch("./"+e);let o=null;if(n.ok){const l=await n.blob();l&&(o=await l.arrayBuffer())}if(!o)return null;const r=await qs().parseSync(t,o,null,0);return(r==null?void 0:r.scene)??null}const i=new Va;return Vp(i,t),new Promise((n,o)=>{const r=this.avatarRegistryUrl+"/"+e;i.load(r,async l=>{await qs().createBuiltinComponents(t,r,l,null,void 0),n(l.scene)},l=>{mh&&console.log("[Custom Avatar] "+l.loaded/l.total*100+"% loaded of "+l.total/1024+"kB")},l=>{console.error("[Custom Avatar] Error when loading: "+l),n(null)})})}cacheModel(t,e){}findAvatar(t){const e=t;let i=e;i.children.length==1&&(i=t.children[0]);let n=this.findAvatarPart(i,["head"]);const o=this.findAvatarPart(i,["left","hand"]),r=this.findAvatarPart(i,["right","hand"]);if(!n){n=e;const c=new x;new En().setFromObject(n).getSize(c);const h=Math.max(c.x,c.y,c.z);console.warn("[Custom Avatar] Normalizing head scale, it's too big: "+h+" meters! Should be < 0.3m"),h>.3&&n.scale.multiplyScalar(1/h*.3)}return new lb(e,n,o,r)}findAvatarPart(t,e){const i=t.name.toLowerCase();let n=!0;for(const o of e){if(!n)break;i.indexOf(o)===-1&&(n=!1)}if(n)return t;if(t.children)for(const o of t.children){const r=this.findAvatarPart(o,e);if(r)return r}return null}handleCustomAvatarErrors(t){if(!t.ok)throw Error(t.statusText);return t}}var cb=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};class Hd extends j{constructor(){super(...arguments);a(this,"length",1);a(this,"depthTest",!0);a(this,"isGizmo",!1);a(this,"_axes",null)}onEnable(){if(this.isGizmo&&!Fd)return;this._axes||(this._axes=new ln(this.length)),this._axes.layers.disableAll(),this._axes.layers.set(this.layer),this.gameObject.add(this._axes);const e=this._axes.material;e&&e.depthTest!==void 0&&(e.depthTest=this.depthTest)}onDisable(){this._axes&&this.gameObject.remove(this._axes)}}cb([m()],Hd.prototype,"length",void 0);cb([m()],Hd.prototype,"depthTest",void 0);cb([m()],Hd.prototype,"isGizmo",void 0);class qC extends j{constructor(){super(...arguments);a(this,"from");a(this,"to");a(this,"hint");a(this,"desiredDistance",1)}onEnable(){}update(){if(!this.from||!this.to||!this.hint)return;const e=ae(this.to).clone(),i=ae(this.from).clone(),n=e.distanceTo(i),o=e.clone();o.sub(i);const r=i.clone();r.add(e),r.multiplyScalar(.5);const l=ae(this.hint).clone();l.sub(r);const c=new x;c.crossVectors(l,o),c.crossVectors(o,c),c.normalize();const h=n*.5,d=Math.max(this.desiredDistance,h),u=Math.sqrt(d*d-h*h),f=c.clone();f.multiplyScalar(u),f.add(r),jt(this.gameObject,f);const p=r.clone();p.sub(c),this.gameObject.lookAt(p)}}const OA=C("gizmos"),TA=C("debugboxhelper"),Hn=class extends j{constructor(){super(...arguments);a(this,"box",null);a(this,"_lastMatrixUpdateFrame",-1);a(this,"_helper",null);a(this,"_color",null)}isInBox(e){var n;if(!e)return;if(this.box||(this.box=new En),dn([e],void 0,void 0,Hn.testBox),Hn.testBox.isEmpty()){const o=ae(e,Hn._position);Hn.testBox.setFromCenterAndSize(o,Hn._emptyObjectSize)}this.updateBox();const i=(n=this.box)==null?void 0:n.intersectsBox(Hn.testBox);return i&&TA&&G.DrawWireBox3(Hn.testBox,16711680,5),i}intersects(e){return e?this.updateBox(!1).intersectsBox(e):!1}updateBox(e=!1){if(this.box||(this.box=new En),e||this.context.time.frameCount!=this._lastMatrixUpdateFrame){const i=this._lastMatrixUpdateFrame<0;this._lastMatrixUpdateFrame=this.context.time.frameCount;const n=i,o=ae(this.gameObject,Hn._position,n),r=pt(this.gameObject,Hn._size);this.box.setFromCenterAndSize(o,r)}return this.box}awake(){this._helper=null,this._color=null,this.box=null}showHelper(e=null,i=!1){var n;if(!(!OA&&!i)){if(this._helper){e&&((n=this._color)==null||n.set(e)),this.gameObject.add(this._helper);return}this._helper=H_(e),this.gameObject.add(this._helper)}}};let rn=Hn;a(rn,"testBox",new En),a(rn,"_position",new x),a(rn,"_size",new x(.01,.01,.01)),a(rn,"_emptyObjectSize",new x(.01,.01,.01));var Xi=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};class fn extends j{constructor(){super(...arguments);a(this,"attachedRigidbody",null);a(this,"isTrigger",!1);a(this,"sharedMaterial");a(this,"membership",[0]);a(this,"filter");a(this,"updateProperties",()=>{var e;(e=this.context.physics.engine)==null||e.updateProperties(this)})}get isCollider(){return!0}awake(){super.awake(),this.attachedRigidbody||(this.attachedRigidbody=this.gameObject.getComponentInParent(ve))}start(){this.attachedRigidbody||(this.attachedRigidbody=this.gameObject.getComponentInParent(ve))}onEnable(){this.attachedRigidbody||(this.attachedRigidbody=this.gameObject.getComponentInParent(ve))}onDisable(){var e;(e=this.context.physics.engine)==null||e.removeBody(this)}get body(){var e;return(e=this.context.physics.engine)==null?void 0:e.getBody(this)}updatePhysicsMaterial(){var e;(e=this.context.physics.engine)==null||e.updatePhysicsMaterial(this)}}Xi([m(ve)],fn.prototype,"attachedRigidbody",void 0);Xi([m()],fn.prototype,"isTrigger",void 0);Xi([m()],fn.prototype,"sharedMaterial",void 0);Xi([m()],fn.prototype,"membership",void 0);Xi([m()],fn.prototype,"filter",void 0);class Gd extends fn{constructor(){super(...arguments);a(this,"radius",.5);a(this,"center",new x(0,0,0))}onEnable(){var e;super.onEnable(),(e=this.context.physics.engine)==null||e.addSphereCollider(this),A_(this.gameObject.scale,this.updateProperties)}onDisable(){super.onDisable(),kw(this.gameObject.scale,this.updateProperties)}onValidate(){this.updateProperties()}}Xi([mi(),m()],Gd.prototype,"radius",void 0);Xi([m(x)],Gd.prototype,"center",void 0);class il extends fn{constructor(){super(...arguments);a(this,"size",new x(1,1,1));a(this,"center",new x(0,0,0))}static add(e,i){const n=Mn(e,il);return n.autoFit(),(i==null?void 0:i.rigidbody)===!0&&Mn(e,ve,{isKinematic:!1}),n}onEnable(){var e;super.onEnable(),(e=this.context.physics.engine)==null||e.addBoxCollider(this,this.size),A_(this.gameObject.scale,this.updateProperties)}onDisable(){super.onDisable(),kw(this.gameObject.scale,this.updateProperties)}onValidate(){this.updateProperties()}autoFit(e){const i=this.gameObject,n=i.position.clone(),o=i.quaternion.clone(),r=i.scale.clone(),l=i.parent;i.position.set(0,0,0),i.quaternion.set(0,0,0,1),i.scale.set(1,1,1),i.parent=null,i.updateMatrix();const c=dn([i]);i.position.copy(n),i.quaternion.copy(o),i.scale.copy(r),i.parent=l,(e==null?void 0:e.debug)===!0&&G.DrawWireBox3(c,16768256,20),this.size=c.getSize(new x)||new x(1,1,1),this.center=c.getCenter(new x)||new x(0,0,0),this.size.length()<=0&&this.size.set(.01,.01,.01)}}Xi([mi(),m(x)],il.prototype,"size",void 0);Xi([m(x)],il.prototype,"center",void 0);class nl extends fn{constructor(){super(...arguments);a(this,"sharedMesh");a(this,"convex",!1)}onEnable(){var i,n,o;if(super.onEnable(),!this.context.physics.engine)return;(i=this.sharedMesh)!=null&&i.isMesh||(this.gameObject instanceof Z||this.gameObject instanceof Mr)&&(this.sharedMesh=this.gameObject);const e=0;if((n=this.sharedMesh)!=null&&n.isMesh)this.context.physics.engine.addMeshCollider(this,this.sharedMesh,this.convex),mt.assignMeshLOD(this.sharedMesh,e).then(r=>{r&&this.activeAndEnabled&&this.context.physics.engine&&this.sharedMesh&&(this.context.physics.engine.removeBody(this),this.sharedMesh.geometry=r,this.context.physics.engine.addMeshCollider(this,this.sharedMesh,this.convex))});else{const r=this.sharedMesh;if(r!=null&&r.isGroup){console.warn(`MeshCollider mesh is a group "${((o=this.sharedMesh)==null?void 0:o.name)||this.gameObject.name}", adding all children as colliders. This is currently not fully supported (colliders can not be removed from world again)`,this);const l=new Array;for(const c in r.children){const h=r.children[c];h.isMesh&&(this.context.physics.engine.addMeshCollider(this,h,this.convex),l.push(mt.assignMeshLOD(h,e)))}Promise.all(l).then(c=>{var d,u;if(c.some(f=>f)==!1)return;(d=this.context.physics.engine)==null||d.removeBody(this);const h=new Z;for(const f of c)f&&this.activeAndEnabled&&(h.geometry=f,(u=this.context.physics.engine)==null||u.addMeshCollider(this,h,this.convex))})}else(U()||C("showcolliders"))&&console.warn(`[MeshCollider] A MeshCollider mesh is assigned to an unknown object on "${this.gameObject.name}", but it's neither a Mesh nor a Group. Please double check that you attached the collider component to the right object and report a bug otherwise!`,this)}}}Xi([m(Z)],nl.prototype,"sharedMesh",void 0);Xi([m()],nl.prototype,"convex",void 0);class Vr extends fn{constructor(){super(...arguments);a(this,"center",new x(0,0,0));a(this,"radius",.5);a(this,"height",2)}onEnable(){var e;super.onEnable(),(e=this.context.physics.engine)==null||e.addCapsuleCollider(this,this.height,this.radius)}}Xi([m(x)],Vr.prototype,"center",void 0);Xi([m()],Vr.prototype,"radius",void 0);Xi([m()],Vr.prototype,"height",void 0);var Qo=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const sx=C("debugcharactercontroller");class jc extends j{constructor(){super(...arguments);a(this,"center",new x(0,0,0));a(this,"radius",.5);a(this,"height",2);a(this,"_rigidbody",null);a(this,"_activeGroundCollisions");a(this,"_contactVelocity",new x)}get rigidbody(){return this._rigidbody?this._rigidbody:(this._rigidbody=this.gameObject.getComponent(ve),this._rigidbody||(this._rigidbody=this.gameObject.addComponent(ve)),this.rigidbody)}awake(){this._activeGroundCollisions=new Set}onEnable(){const e=this.rigidbody;let i=this.gameObject.getComponent(Vr);i||(i=this.gameObject.addComponent(Vr)),i.center.copy(this.center),i.radius=this.radius,i.height=this.height;const n=new x(0,0,1),o=new x(1,0,0),r=new x(0,1,0),l=this.gameObject.getWorldDirection(new x);l.y=0;const c=o.dot(l)<0?-1:1,h=n.angleTo(l)*c;this.gameObject.setRotationFromAxisAngle(r,h),e.lockRotationX=!0,e.lockRotationY=!0,e.lockRotationZ=!0}move(e){this.gameObject.position.add(e)}onCollisionEnter(e){(e.contacts.length==0||e.contacts.some(i=>i.normal.y>.2))&&(this._activeGroundCollisions.add(e),sx&&console.log(`Collision(${this._activeGroundCollisions.size}): ${e.contacts.map(i=>i.normal.y.toFixed(2)).join(", ")} - ${this.isGrounded}`))}onCollisionExit(e){this._activeGroundCollisions.delete(e),sx&&console.log(`Collision(${this._activeGroundCollisions.size}) - ${this.isGrounded}`)}get isGrounded(){return this._activeGroundCollisions.size>0}get contactVelocity(){var e;this._contactVelocity.set(0,0,0);for(const i of this._activeGroundCollisions){const n=(e=this.context.physics.engine)==null?void 0:e.getLinearVelocity(i.collider);n&&(this._contactVelocity.x+=n.x,this._contactVelocity.y+=n.y,this._contactVelocity.z+=n.z)}return this._contactVelocity}}Qo([m(x)],jc.prototype,"center",void 0);Qo([m()],jc.prototype,"radius",void 0);Qo([m()],jc.prototype,"height",void 0);class Qr extends j{constructor(){super(...arguments);a(this,"controller");a(this,"movementSpeed",2);a(this,"rotationSpeed",2);a(this,"jumpForce",1);a(this,"doubleJumpForce",2);a(this,"animator");a(this,"lookForward",!0);a(this,"lookInput",new ce(0,0));a(this,"moveInput",new ce(0,0));a(this,"jumpInput",!1);a(this,"_currentSpeed",new x(0,0,0));a(this,"_currentAngularSpeed",new x(0,0,0));a(this,"_temp",new x(0,0,0));a(this,"_jumpCount",0);a(this,"_currentRotation");a(this,"_raycastOptions",new $o)}awake(){this._currentRotation=new H}update(){const e=this.context.input;e.isKeyPressed("KeyW")?this.moveInput.y+=1:e.isKeyPressed("KeyS")&&(this.moveInput.y-=1),e.isKeyPressed("KeyD")?this.lookInput.x+=1:e.isKeyPressed("KeyA")&&(this.lookInput.x-=1),this.jumpInput||(this.jumpInput=e.isKeyDown("Space"))}move(e){this.moveInput.add(e)}look(e){this.lookInput.add(e)}jump(){this.jumpInput=!0}onBeforeRender(){this.handleInput(this.moveInput,this.lookInput,this.jumpInput),this.lookInput.set(0,0),this.moveInput.set(0,0),this.jumpInput=!1}handleInput(e,i,n){var o,r,l,c,h,d,u,f,p,g,y;if((o=this.controller)!=null&&o.isGrounded&&(this._jumpCount=0,this.doubleJumpForce>0&&((r=this.animator)==null||r.setBool("doubleJump",!1))),this._currentSpeed.z+=e.y*this.movementSpeed*this.context.time.deltaTime,(l=this.animator)==null||l.setBool("running",e.length()>.01),(h=this.animator)==null||h.setBool("jumping",((c=this.controller)==null?void 0:c.isGrounded)===!0&&n),this._temp.copy(this._currentSpeed),this._temp.applyQuaternion(this.gameObject.quaternion),this.controller?this.controller.move(this._temp):this.gameObject.position.add(this._temp),this._currentAngularSpeed.y+=W.toRadians(-i.x*this.rotationSpeed)*this.context.time.deltaTime,this.lookForward&&Math.abs(this._currentAngularSpeed.y)<.01){const b=this.context.mainCameraComponent.forward;b.y=0,b.normalize(),this._currentRotation.setFromUnitVectors(new x(0,0,1),b),this.gameObject.quaternion.slerp(this._currentRotation,this.context.time.deltaTime*10)}if(this.gameObject.rotateY(this._currentAngularSpeed.y),this._currentSpeed.multiplyScalar(1-this.context.time.deltaTime*10),this._currentAngularSpeed.y*=1-this.context.time.deltaTime*10,this.controller&&n&&this.jumpForce>0){let b=(d=this.controller)==null?void 0:d.isGrounded;if(this.doubleJumpForce>0&&!((u=this.controller)!=null&&u.isGrounded)&&this._jumpCount===1&&(b=!0,(f=this.animator)==null||f.setBool("doubleJump",!0)),b){this._jumpCount+=1;const _=this.controller.rigidbody,v=this._jumpCount===2?this.doubleJumpForce:this.jumpForce;_.applyImpulse(new x(0,1,0).multiplyScalar(v))}}if(this.controller){const b=(p=this.controller)==null?void 0:p.rigidbody.getVelocity().y;if(b<-1){this._raycastOptions.ray||(this._raycastOptions.ray=new $r),this._raycastOptions.ray.origin.copy(ae(this.gameObject)),this._raycastOptions.ray.direction.set(0,-1,0);const _=this.layer;this.gameObject.layers.disableAll(),this.gameObject.layers.set(2);const v=this.context.physics.raycast(this._raycastOptions);this.gameObject.layers.set(_),(v.length&&v[0].distance>2||b<-10)&&((g=this.animator)==null||g.setBool("falling",!0))}else(y=this.animator)==null||y.setBool("falling",!1)}}}Qo([m(jc)],Qr.prototype,"controller",void 0);Qo([m()],Qr.prototype,"movementSpeed",void 0);Qo([m()],Qr.prototype,"rotationSpeed",void 0);Qo([m()],Qr.prototype,"jumpForce",void 0);Qo([m()],Qr.prototype,"doubleJumpForce",void 0);Qo([m(pi)],Qr.prototype,"animator",void 0);var Bc=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const gh=C("debugcontactshadows");FC(s=>{const t=s.domElement.getAttribute("contactshadows");t!=null&&t!="0"&&t!="false"&&cn.auto(s)});const Xl=class extends j{constructor(){super(...arguments);a(this,"autoFit",!1);a(this,"darkness",.5);a(this,"opacity",.5);a(this,"blur",4);a(this,"occludeBelowGround",!1);a(this,"backfaceShadows",!0);a(this,"minSize");a(this,"shadowsRoot",new F);a(this,"shadowCamera");a(this,"shadowGroup",new Mr);a(this,"renderTarget");a(this,"renderTargetBlur");a(this,"plane");a(this,"occluderMesh");a(this,"blurPlane");a(this,"depthMaterial");a(this,"horizontalBlurMaterial");a(this,"verticalBlurMaterial");a(this,"textureSize",512)}static auto(e){if(e||(e=ne.Current),!e)throw new Error("No context provided and no current context set.");let i=this._instances.get(e);if(!i||i.destroyed){const n=new F;i=Mn(n,Xl,{autoFit:!1,occludeBelowGround:!1}),this._instances.set(e,i)}return e.scene.add(i.gameObject),i.fitShadows(),i}fitShadows(){gh&&console.warn("Fitting shadows to scene"),fy(this.shadowsRoot,!1);const e=dn(this.context.scene.children,[this.shadowsRoot]),i=Math.max(1,this.blur/32),n=e.max.x-e.min.x,o=e.max.z-e.min.z;e.expandByVector(new x(i*n,0,i*o)),gh&&G.DrawWireBox3(e,16776960,60),this.gameObject.parent&&e.applyMatrix4(this.gameObject.parent.matrixWorld.clone().invert());const r=e.min,l=Math.max(1e-5,(e.max.y-r.y)*.002);e.max.y+=l,this.shadowsRoot.position.set((r.x+e.max.x)/2,r.y-l,(r.z+e.max.z)/2),this.shadowsRoot.scale.set(e.max.x-r.x,e.max.y-r.y,e.max.z-r.z),this.applyMinSize(),this.shadowsRoot.matrixWorldNeedsUpdate=!0,gh&&console.log("Fitted shadows to scene",this.shadowsRoot.scale.clone())}awake(){Xl._instances.set(this.context,this),this.shadowsRoot.hideFlags=Nf.DontExport,fy(this.shadowsRoot,!1)}start(){gh&&console.log("Create ContactShadows on "+this.gameObject.name,this),this.gameObject.add(this.shadowsRoot),this.shadowsRoot.add(this.shadowGroup),this.renderTarget=new No(this.textureSize,this.textureSize),this.renderTarget.texture.generateMipmaps=!1,this.renderTargetBlur=new No(this.textureSize,this.textureSize),this.renderTargetBlur.texture.generateMipmaps=!1;const e=new Ys(1,1).rotateX(Math.PI/2);this.gameObject instanceof Z&&(console.warn("ContactShadows can not be added to a Mesh. Please add it to a Group or an empty Object"),vo(this.gameObject,!1));const i=new Ue({map:this.renderTarget.texture,opacity:this.opacity,color:0,transparent:!0,depthWrite:!1,side:Wr});this.plane=new Z(e,i),this.plane.scale.y=-1,this.plane.layers.set(2),this.shadowsRoot.add(this.plane),this.plane&&(this.plane.renderOrder=1),this.occluderMesh=new Z(this.plane.geometry,new Ue({depthWrite:!0,stencilWrite:!0,colorWrite:!1,side:O_})).translateY(-1e-4),this.occluderMesh.renderOrder=-100,this.occluderMesh.layers.set(2),this.shadowsRoot.add(this.occluderMesh),this.blurPlane=new Z(e),this.blurPlane.visible=!1,this.shadowGroup.add(this.blurPlane);const n=0,o=1;this.shadowCamera=new P_(-1/2,1/2,1/2,-1/2,n,o),this.shadowCamera.layers.enableAll(),this.shadowCamera.rotation.x=Math.PI/2,this.shadowGroup.add(this.shadowCamera),this.depthMaterial=new jP,this.depthMaterial.userData.darkness={value:this.darkness},this.depthMaterial.blending=BP,this.depthMaterial.blendEquation=FP,this.depthMaterial.onBeforeCompile=r=>{this.depthMaterial&&(r.uniforms.darkness=this.depthMaterial.userData.darkness,r.fragmentShader=`
                uniform float darkness;
                ${r.fragmentShader.replace("gl_FragColor = vec4( vec3( 1.0 - fragCoordZ ), opacity );","gl_FragColor = vec4( vec3( 1.0 ), ( 1.0 - fragCoordZ ) * darkness * opacity * (gl_FrontFacing ? 1.0 : 0.66) );")}
            `)},this.depthMaterial.depthTest=!1,this.depthMaterial.depthWrite=!1,this.horizontalBlurMaterial=new os(zR),this.horizontalBlurMaterial.depthTest=!1,this.verticalBlurMaterial=new os(UR),this.verticalBlurMaterial.depthTest=!1,this.shadowGroup.visible=!1,this.autoFit?this.fitShadows():this.applyMinSize()}onDestroy(){var i,n,o,r,l,c,h,d;Xl._instances.get(this.context)===this&&Xl._instances.delete(this.context),(i=this.renderTarget)==null||i.dispose(),(n=this.renderTargetBlur)==null||n.dispose(),(o=this.depthMaterial)==null||o.dispose(),(r=this.horizontalBlurMaterial)==null||r.dispose(),(l=this.verticalBlurMaterial)==null||l.dispose(),(c=this.blurPlane)==null||c.geometry.dispose(),(h=this.plane)==null||h.geometry.dispose(),(d=this.occluderMesh)==null||d.geometry.dispose()}onBeforeRender(e){if(!this.renderTarget||!this.renderTargetBlur||!this.depthMaterial||!this.shadowCamera||!this.blurPlane||!this.shadowGroup||!this.plane||!this.horizontalBlurMaterial||!this.verticalBlurMaterial){gh&&console.error("ContactShadows: not initialized yet");return}const i=this.context.scene,n=this.context.renderer,o=n.getRenderTarget();this.shadowGroup.visible=!0,this.occluderMesh&&(this.occluderMesh.visible=!1);const r=this.plane.visible;this.plane.visible=!1,this.gameObject instanceof Z&&vo(this.gameObject,!1);const l=i.background;i.background=null,i.overrideMaterial=this.depthMaterial,this.backfaceShadows?this.depthMaterial.side=hn:this.depthMaterial.side=Wr;const c=n.getClearAlpha();n.setClearAlpha(0);const h=n.xr.enabled;n.xr.enabled=!1;const d=this.context.scene.matrixWorldAutoUpdate;this.context.scene.matrixWorldAutoUpdate=!1;const u=n.renderLists.get(i,0),f=u.transparent;ox.length=0,u.transparent=ox,wg.length=0;for(const g of u.opaque){if(!g.object.visible)continue;const y=g.material;let b=g.material.colorWrite==!1||y.wireframe===!0||qO(g.object)===!1;!b&&g.material.isLineMaterial&&(b=!0),!b&&g.material.isPointsMaterial&&(b=!0),b&&(wg.push(g.object),g.object["needle:visible"]=g.object.visible,g.object.visible=!1)}n.setRenderTarget(this.renderTarget),n.clear(),n.render(i,this.shadowCamera),u.transparent=f;for(const g of wg)g["needle:visible"]!=null&&(g.visible=g["needle:visible"]);i.overrideMaterial=null;const p=Math.max(this.blur,.05);this.blurShadow(p*2),this.blurShadow(p*.5),this.shadowGroup.visible=!1,this.occluderMesh&&(this.occluderMesh.visible=this.occludeBelowGround),this.plane.visible=r,n.setRenderTarget(o),n.setClearAlpha(c),i.background=l,n.xr.enabled=h,this.context.scene.matrixWorldAutoUpdate=d}blurShadow(e){if(!this.blurPlane||!this.shadowCamera||!this.renderTarget||!this.renderTargetBlur||!this.horizontalBlurMaterial||!this.verticalBlurMaterial)return;this.blurPlane.visible=!0;const i=this.shadowsRoot.worldScale,n=(i.x+i.z)/2,o=i.z/n,r=i.x/n;this.blurPlane.material=this.horizontalBlurMaterial,this.blurPlane.material.uniforms.tDiffuse.value=this.renderTarget.texture,this.horizontalBlurMaterial.uniforms.h.value=e*1/this.textureSize*o;const l=this.context.renderer,c=l.getRenderTarget();l.setRenderTarget(this.renderTargetBlur),l.render(this.blurPlane,this.shadowCamera),this.blurPlane.material=this.verticalBlurMaterial,this.blurPlane.material.uniforms.tDiffuse.value=this.renderTargetBlur.texture,this.verticalBlurMaterial.uniforms.v.value=e*1/this.textureSize*r,l.setRenderTarget(this.renderTarget),l.render(this.blurPlane,this.shadowCamera),this.blurPlane.visible=!1,l.setRenderTarget(c)}applyMinSize(){this.minSize&&this.shadowsRoot.scale.set(Math.max(this.minSize.x||0,this.shadowsRoot.scale.x),Math.max(this.minSize.y||0,this.shadowsRoot.scale.y),Math.max(this.minSize.z||0,this.shadowsRoot.scale.z))}};let cn=Xl;a(cn,"_instances",new Map);Bc([m()],cn.prototype,"autoFit",void 0);Bc([m()],cn.prototype,"darkness",void 0);Bc([m()],cn.prototype,"opacity",void 0);Bc([m()],cn.prototype,"blur",void 0);Bc([m()],cn.prototype,"occludeBelowGround",void 0);Bc([m()],cn.prototype,"backfaceShadows",void 0);const ox=[],wg=new Array,kA=C("logstats");class XC extends j{onEnable(){console.log(this),kA&&this.startCoroutine(this.run(),oe.OnAfterRender)}*run(){for(;this.enabled;){const t=this.context.renderer.info;console.log(t.memory,t.render,t.programs),yield}}}class Kp extends j{constructor(){super(...arguments);a(this,"isUsed",!0);a(this,"usedBy",null)}}class QC extends j{}const rx=C("debugdeletable"),dd=class extends rn{onEnable(){dd._instances.push(this)}onDisable(){const t=dd._instances.indexOf(this);t>=0&&dd._instances.splice(t,1)}};let ac=dd;a(ac,"_instances",[]);class YC extends j{update(){for(const t of ac._instances){const e=this.gameObject;if(t.isInBox(e)===!0){const n=P.getComponentInParent(this.gameObject,Kp);if(n)rx&&console.warn("DeleteBox: Not deleting object with usage marker",this.guid,n);else{if(rx)try{if(t.box){const o=t.box,r=rn.testBox;G.DrawWireBox3(o,16711680,5),G.DrawWireBox3(r,255,5),console.log("DeleteBox: Destroying",this.gameObject,{deleteBoxArea:o,deletedObjectArea:r})}else console.log("DeleteBox: Destroying",this.gameObject)}catch{}zp(this.gameObject,this.context.connection)}}}}}var EA=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o},$f;(function(s){s[s.Never=0]="Never",s[s.Desktop=1]="Desktop",s[s.Mobile=2]="Mobile"})($f||($f={}));class hb extends j{constructor(){super(...arguments);a(this,"visibleOn")}onEnable(){this.apply()}apply(){this.test()||P.setActive(this.gameObject,!1)}test(){return this.visibleOn<0?!0:J.isMobileDevice()?(this.visibleOn&$f.Mobile)!==0:(this.visibleOn&$f.Desktop)!==0}}EA([m()],hb.prototype,"visibleOn",void 0);var sl=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const zs=C("debugdrag"),Sg=[];var ri;(function(s){s[s.XZPlane=0]="XZPlane",s[s.Attached=1]="Attached",s[s.HitNormal=2]="HitNormal",s[s.DynamicViewAngle=3]="DynamicViewAngle",s[s.SnapToSurfaces=4]="SnapToSurfaces",s[s.None=5]="None"})(ri||(ri={}));const nn=class extends j{constructor(){super(...arguments);a(this,"dragMode",ri.DynamicViewAngle);a(this,"snapGridResolution",0);a(this,"keepRotation",!0);a(this,"xrDragMode",ri.Attached);a(this,"xrKeepRotation",!1);a(this,"xrDistanceDragFactor",1);a(this,"showGizmo",!1);a(this,"_rigidbody",null);a(this,"_targetObject",null);a(this,"_dragHelper",null);a(this,"_draggingRigidbodies",[]);a(this,"_potentialDragStartEvt",null);a(this,"_dragHandlers",new Map);a(this,"_totalMovement",new x);a(this,"_marker",null);a(this,"_isDragging",!1);a(this,"_didDrag",!1)}static get HasAnySelected(){return this._active>0}static get CurrentlySelected(){Sg.length=0;for(const e of this._instances)e._isDragging&&Sg.push(e);return Sg}get draggedObject(){return this._targetObject}setTargetObject(e){var n,o;this._targetObject=e;for(const r of this._dragHandlers.values())r.setTargetObject(e);const i="_rigidbody-was-kinematic";((n=this._rigidbody)==null?void 0:n[i])===!1&&(this._rigidbody.isKinematic=!1,this._rigidbody[i]=void 0),this._rigidbody=null,e&&(this._rigidbody=P.getComponentInChildren(e,ve),((o=this._rigidbody)==null?void 0:o.isKinematic)===!1&&(this._rigidbody.isKinematic=!0,this._rigidbody[i]=!1))}awake(){this._potentialDragStartEvt=null,this._dragHandlers=new Map,this._totalMovement=new x,this._marker=null,this._isDragging=!1,this._didDrag=!1,this._dragHelper=null,this._draggingRigidbodies=[]}start(){this.gameObject.getComponentInParent(jn)||this.gameObject.addComponent(jn)}onEnable(){nn._instances.push(this)}onDisable(){nn._instances=nn._instances.filter(e=>e!==this)}allowEdit(e=null){return this.context.connection.allowEditing}onPointerEnter(e){if(!this.allowEdit(this.gameObject)||e.mode!=="screen"||(e.event.mode==="tracked-pointer"||e.event.mode==="transient-pointer"?this.xrDragMode:this.dragMode)===ri.None)return;const o=P.getComponentInParent(e.object,nn);!o||o!==this||(nn.lastHovered=e.object,this.context.domElement.style.cursor="pointer")}onPointerMove(e){(this._isDragging||this._potentialDragStartEvt!==null)&&e.use()}onPointerExit(e){this.allowEdit(this.gameObject)&&e.mode==="screen"&&nn.lastHovered===e.object&&(this.context.domElement.style.cursor="auto")}onPointerDown(e){if(!(!this.allowEdit(this.gameObject)||e.used||(e.mode==="tracked-pointer"||e.mode==="transient-pointer"?this.xrDragMode:this.dragMode)===ri.None)&&(nn.lastHovered=e.object,e.button===0)){this._dragHandlers.size===0&&(this._didDrag=!1,this._totalMovement.set(0,0,0),this._potentialDragStartEvt=e),this._targetObject||this.setTargetObject(this.gameObject),nn._active+=1;const o=new Cg(this,this._targetObject);if(this._dragHandlers.set(e.event.space,o),o.onDragStart(e),this._dragHandlers.size===2){const r=this._dragHandlers.values(),l=r.next().value,c=r.next().value;if(l instanceof Cg&&c instanceof Cg){const h=new MA(this,this._targetObject,l,c);this._dragHandlers.set(this.gameObject,h),h.onDragStart(e)}else console.error("Attempting to construct a MultiTouchDragHandler with invalid DragPointerHandlers. This is likely a bug.",{a:l,b:c})}e.use()}}onPointerUp(e){if(zs&&G.DrawLabel(e.point??this.gameObject.worldPosition,"POINTERUP:"+e.pointerId+", "+e.button,.03,3),!this.allowEdit(this.gameObject)||e.button!==0)return;this._potentialDragStartEvt=null;const i=this._dragHandlers.get(e.event.space),n=this._dragHandlers.get(this.gameObject);n&&(n.handlerA===i||n.handlerB===i)&&(this._dragHandlers.delete(this.gameObject),n.onDragEnd(e)),i&&(nn._active>0&&(nn._active-=1),this.setTargetObject(null),i.onDragEnd&&i.onDragEnd(e),this._dragHandlers.delete(e.event.space),this._dragHandlers.size===0&&this.onLastDragEnd(e),e.use())}update(){for(const e of this._dragHandlers.values())e.collectMovementInfo&&e.collectMovementInfo(),e.getTotalMovement&&this._totalMovement.add(e.getTotalMovement());if(this._potentialDragStartEvt){if(!this._didDrag)if(this._totalMovement.length()>3e-4)this._didDrag=!0;else return;const e=this._potentialDragStartEvt;this._potentialDragStartEvt=null,this.onFirstDragStart(e)}for(const e of this._dragHandlers.values())e.onDragUpdate&&e.onDragUpdate(this._dragHandlers.size);this._dragHelper&&this._dragHelper.hasSelected&&this.onAnyDragUpdate()}onFirstDragStart(e){if(!e||!e.object)return;const i=P.getComponentInParent(e.object,nn);if(!i||i!==this&&i._isDragging)return;const n=this._targetObject||this.gameObject;if(!n)return;this._isDragging=!0;const o=P.getComponentInChildren(n,Wo);zs&&console.log("DRAG START",o,n),o&&(o.fastMode=!0,o==null||o.requestOwnership()),this._marker=P.addComponent(n,Kp),this._draggingRigidbodies.length=0;const r=P.getComponentsInChildren(n,ve);r&&this._draggingRigidbodies.push(...r)}onAnyDragUpdate(){if(!this._dragHelper)return;this._dragHelper.showGizmo=this.showGizmo,this._dragHelper.onUpdate(this.context);for(const i of this._draggingRigidbodies)i.wakeUp(),i.resetVelocities(),i.resetForcesAndTorques();const e=this._targetObject||this.gameObject;is.markDirty(e)}onLastDragEnd(e){if(!this||!this._isDragging)return;this._isDragging=!1;for(const n of this._draggingRigidbodies)n.setVelocity(n.smoothedVelocity);if(this._draggingRigidbodies.length=0,this._targetObject=null,e!=null&&e.object){const n=P.getComponentInChildren(e.object,Wo);n&&(n.fastMode=!1)}if(this._marker&&this._marker.destroy(),!this._dragHelper)return;const i=this._dragHelper.selected;zs&&console.log("DRAG END",i,i==null?void 0:i.visible),this._dragHelper.setSelected(null,this.context)}};let Dt=nn;a(Dt,"_active",0),a(Dt,"_instances",[]),a(Dt,"lastHovered");sl([m()],Dt.prototype,"dragMode",void 0);sl([m()],Dt.prototype,"snapGridResolution",void 0);sl([m()],Dt.prototype,"keepRotation",void 0);sl([m()],Dt.prototype,"xrDragMode",void 0);sl([m()],Dt.prototype,"xrKeepRotation",void 0);sl([m()],Dt.prototype,"xrDistanceDragFactor",void 0);sl([m()],Dt.prototype,"showGizmo",void 0);class MA{constructor(t,e,i,n){a(this,"handlerA");a(this,"handlerB");a(this,"context");a(this,"settings");a(this,"gameObject");a(this,"_handlerAAttachmentPoint",new x);a(this,"_handlerBAttachmentPoint",new x);a(this,"_followObject");a(this,"_manipulatorObject");a(this,"_deviceMode");a(this,"_followObjectStartWorldQuaternion",new H);a(this,"_manipulatorPosOffset",new x);a(this,"_manipulatorRotOffset",new H);a(this,"_manipulatorScaleOffset",new x);a(this,"_tempVec1",new x);a(this,"_tempVec2",new x);a(this,"_tempVec3",new x);a(this,"tempLookMatrix",new le);a(this,"_initialScale",new x);a(this,"_initialDistance",0);var r,l;this.context=t.context,this.settings=t,this.gameObject=e,this.handlerA=i,this.handlerB=n,this._followObject=new F,this._manipulatorObject=new F,this.context.scene.add(this._manipulatorObject);const o=(l=(r=te.active)==null?void 0:r.rig)==null?void 0:l.gameObject;if(!this.handlerA||!this.handlerB||!this.handlerA.hitPointInLocalSpace||!this.handlerB.hitPointInLocalSpace){console.error("Invalid: MultiTouchDragHandler needs two valid DragPointerHandlers with hitPointInLocalSpace set.");return}if(this._tempVec1.copy(this.handlerA.hitPointInLocalSpace),this._tempVec2.copy(this.handlerB.hitPointInLocalSpace),this.gameObject.localToWorld(this._tempVec1),this.gameObject.localToWorld(this._tempVec2),o&&(o.worldToLocal(this._tempVec1),o.worldToLocal(this._tempVec2)),this._initialDistance=this._tempVec1.distanceTo(this._tempVec2),this._initialDistance<.02?(zs&&console.log("Finding alternative drag attachment points since initial distance is too low: "+this._initialDistance.toFixed(2)),this.handlerA.followObject.parent.getWorldPosition(this._tempVec1),this.handlerB.followObject.parent.getWorldPosition(this._tempVec2),this._handlerAAttachmentPoint.copy(this._tempVec1),this._handlerBAttachmentPoint.copy(this._tempVec2),this.gameObject.worldToLocal(this._handlerAAttachmentPoint),this.gameObject.worldToLocal(this._handlerBAttachmentPoint),this._initialDistance=this._tempVec1.distanceTo(this._tempVec2),this._initialDistance<.001&&(console.warn("Not supported right now ‚Äì controller drag points for multitouch are too close!"),this._initialDistance=1)):(this._handlerAAttachmentPoint.copy(this.handlerA.hitPointInLocalSpace),this._handlerBAttachmentPoint.copy(this.handlerB.hitPointInLocalSpace)),this._tempVec3.lerpVectors(this._tempVec1,this._tempVec2,.5),this._initialScale.copy(e.scale),zs){this._followObject.add(new ln(2)),this._manipulatorObject.add(new ln(5));const c=h=>`${h.x.toFixed(2)}, ${h.y.toFixed(2)}, ${h.z.toFixed(2)}`;G.DrawLine(this._tempVec1,this._tempVec2,65535,0,!1),G.DrawLabel(this._tempVec3,"A:B "+this._initialDistance.toFixed(2)+`
`+c(this._tempVec1)+`
`+c(this._tempVec2),.03,5)}}onDragStart(t){this.gameObject.add(this._followObject),this._followObject.matrixAutoUpdate=!1,this._followObject.matrix.identity(),this._deviceMode=t.mode,this._followObjectStartWorldQuaternion.copy(this._followObject.worldQuaternion),this.alignManipulator(),this._manipulatorObject.attach(this._followObject),this._manipulatorPosOffset.copy(this._followObject.position),this._manipulatorRotOffset.copy(this._followObject.quaternion),this._manipulatorScaleOffset.copy(this._followObject.scale)}onDragEnd(t){if(!this.handlerA||!this.handlerB){console.error("onDragEnd called on MultiTouchDragHandler without valid handlers. This is likely a bug.");return}this.handlerA.recenter(),this.handlerB.recenter(),this._manipulatorObject.removeFromParent(),this._followObject.removeFromParent(),this._manipulatorObject.destroy(),this._followObject.destroy()}alignManipulator(){if(!this.handlerA||!this.handlerB){console.error("alignManipulator called on MultiTouchDragHandler without valid handlers. This is likely a bug.",this);return}if(!this.handlerA.followObject||!this.handlerB.followObject){console.error("alignManipulator called on MultiTouchDragHandler without valid follow objects. This is likely a bug.",this.handlerA,this.handlerB);return}this._tempVec1.copy(this._handlerAAttachmentPoint),this._tempVec2.copy(this._handlerBAttachmentPoint),this.handlerA.followObject.localToWorld(this._tempVec1),this.handlerB.followObject.localToWorld(this._tempVec2),this._tempVec3.lerpVectors(this._tempVec1,this._tempVec2,.5),this._manipulatorObject.position.copy(this._tempVec3);const t=this.context.mainCamera;this.tempLookMatrix.lookAt(this._tempVec3,this._tempVec2,t.worldUp),this._manipulatorObject.quaternion.setFromRotationMatrix(this.tempLookMatrix);const e=this._tempVec1.distanceTo(this._tempVec2);this._manipulatorObject.scale.copy(this._initialScale).multiplyScalar(e/this._initialDistance),this._manipulatorObject.updateMatrix(),this._manipulatorObject.updateMatrixWorld(!0),zs&&(G.DrawLabel(this._tempVec3.clone().add(new x(0,.2,0)),"A:B "+e.toFixed(2),.03),G.DrawLine(this._tempVec1,this._tempVec2,65280,0,!1))}onDragUpdate(){this.alignManipulator();const t=30,e=1;this._followObject.position.copy(this._manipulatorPosOffset),this._followObject.quaternion.copy(this._manipulatorRotOffset),this._followObject.scale.copy(this._manipulatorScaleOffset);const i=this.gameObject,n=this._followObject;if(!i){console.error("MultiTouchDragHandler has no dragged object. This is likely a bug.");return}n.updateMatrix(),n.updateMatrixWorld(!0);const r=this._deviceMode==="tracked-pointer"||this._deviceMode==="transient-pointer"?this.settings.xrKeepRotation:this.settings.keepRotation;if(this.settings.snapGridResolution>0){const u=this._followObject.worldPosition,f=this.settings.snapGridResolution;u.x=Math.round(u.x/f)*f,u.y=Math.round(u.y/f)*f,u.z=Math.round(u.z/f)*f,this._followObject.worldPosition=u,this._followObject.updateMatrix()}r&&(this._followObject.worldQuaternion=this._followObjectStartWorldQuaternion,this._followObject.updateMatrix());const l=W.clamp01(this.context.time.deltaTime*t*e),c=i.worldPosition;c.lerp(n.worldPosition,l),i.worldPosition=c;const h=i.worldQuaternion;h.slerp(n.worldQuaternion,l),i.worldQuaternion=h;const d=i.worldScale;d.lerp(n.worldScale,l),i.worldScale=d}setTargetObject(t){this.gameObject=t}}class Cg{constructor(t,e){a(this,"context");a(this,"gameObject");a(this,"settings");a(this,"_lastRig");a(this,"_followObject");a(this,"_totalMovement",new x);a(this,"_totalMovementAlongRayDirection",0);a(this,"_grabStartDistance",0);a(this,"_deviceMode");a(this,"_followObjectStartPosition",new x);a(this,"_followObjectStartQuaternion",new H);a(this,"_followObjectStartWorldQuaternion",new H);a(this,"_lastDragPosRigSpace");a(this,"_tempVec",new x);a(this,"_tempMat",new le);a(this,"_hitPointInLocalSpace",new x);a(this,"_hitNormalInLocalSpace",new x);a(this,"_bottomCenter",new x);a(this,"_backCenter",new x);a(this,"_backBottomCenter",new x);a(this,"_bounds",new En);a(this,"_dragPlane",new $a(new x(0,1,0)));a(this,"_draggedOverObject",null);a(this,"_draggedOverObjectLastSetUp",null);a(this,"_draggedOverObjectLastNormal",new x);a(this,"_draggedOverObjectDuration",0);a(this,"_hasLastSurfaceHitPoint",!1);a(this,"_lastSurfaceHitPoint",new x);this.settings=t,this.context=t.context,this.gameObject=e,this._followObject=new F}getTotalMovement(){return this._totalMovement}get followObject(){return this._followObject}get hitPointInLocalSpace(){return this._hitPointInLocalSpace}setTargetObject(t){this.gameObject=t}recenter(){var o,r;if(!this._followObject.parent){console.warn("Error: space follow object doesn't have parent but recenter() is called. This is likely a bug");return}if(!this.gameObject){console.warn("Error: space follow object doesn't have a gameObject");return}const t=this._followObject.parent;this.gameObject.add(this._followObject),this._followObject.matrixAutoUpdate=!1,this._followObject.position.set(0,0,0),this._followObject.quaternion.set(0,0,0,1),this._followObject.scale.set(1,1,1),this._followObject.updateMatrix(),this._followObject.updateMatrixWorld(!0),t.attach(this._followObject),this._followObjectStartPosition.copy(this._followObject.position),this._followObjectStartQuaternion.copy(this._followObject.quaternion),this._followObjectStartWorldQuaternion.copy(this._followObject.worldQuaternion),this._followObject.updateMatrix(),this._followObject.updateMatrixWorld(!0);const e=this._hitPointInLocalSpace.clone();this.gameObject.localToWorld(e),this._grabStartDistance=e.distanceTo(t.worldPosition);const i=(r=(o=te.active)==null?void 0:o.rig)==null?void 0:r.gameObject,n=(i==null?void 0:i.worldScale.x)||1;this._grabStartDistance/=n,this._totalMovementAlongRayDirection=0,this._lastDragPosRigSpace=void 0,zs&&(G.DrawLine(e,t.worldPosition,65280,.5,!1),G.DrawLabel(t.worldPosition.add(new x(0,.1,0)),this._grabStartDistance.toFixed(2),.03,.5))}onDragStart(t){if(!this.gameObject){console.warn("Error: space follow object doesn't have a gameObject");return}if(t.event.space.add(this._followObject),this._lastDragPosRigSpace=void 0,t.point&&t.normal)this._hitPointInLocalSpace.copy(t.point),this.gameObject.worldToLocal(this._hitPointInLocalSpace),this._hitNormalInLocalSpace.copy(t.normal);else if(t){const y=t.event.space,b=y.worldPosition;this.gameObject.worldToLocal(b),this._hitPointInLocalSpace.copy(b);const _=y.worldUp;this._tempMat.copy(this.gameObject.matrixWorld).invert(),_.transformDirection(this._tempMat),this._hitNormalInLocalSpace.copy(_)}this.recenter(),this._totalMovement.set(0,0,0),this._deviceMode=t.mode;const i=this._followObject.parent.worldForward,o=this._deviceMode==="tracked-pointer"||this._deviceMode==="transient-pointer"?this.settings.xrDragMode:this.settings.dragMode,r=this._hitPointInLocalSpace.clone();switch(this.gameObject.localToWorld(r),o){case ri.XZPlane:const y=new x(0,1,0);this.gameObject.parent&&y.transformDirection(this.gameObject.parent.matrixWorld.clone().invert()),this._dragPlane.setFromNormalAndCoplanarPoint(y,r);break;case ri.HitNormal:const b=this._hitNormalInLocalSpace.clone();b.transformDirection(this.gameObject.matrixWorld),this._dragPlane.setFromNormalAndCoplanarPoint(b,r);break;case ri.Attached:this._dragPlane.setFromNormalAndCoplanarPoint(i,r);break;case ri.DynamicViewAngle:this.setPlaneViewAligned(r,!0);break;case ri.SnapToSurfaces:this.setPlaneViewAligned(r,!1);break;case ri.None:break}const l=this.gameObject.parent,c=this.gameObject.position.clone(),h=this.gameObject.quaternion.clone(),d=this.gameObject.scale.clone(),u=this.gameObject.matrixWorld.clone();l&&l.remove(this.gameObject),this.gameObject.position.set(0,0,0),this.gameObject.quaternion.set(0,0,0,1),this.gameObject.scale.set(1,1,1);const f=dn([this.gameObject]);f.expandByPoint(this.gameObject.worldPosition);const p=new x;f.getCenter(p);const g=new x;f.getSize(g),this._bottomCenter.copy(p.clone().add(new x(0,-g.y/2,0))),this._backCenter.copy(p.clone().add(new x(0,0,g.z/2))),this._backBottomCenter.copy(p.clone().add(new x(0,-g.y/2,g.z/2))),this._bounds.copy(f),l&&l.add(this.gameObject),this.gameObject.position.copy(c),this.gameObject.quaternion.copy(h),this.gameObject.scale.copy(d),this.gameObject.matrixWorld.copy(u),this._draggedOverObject=null,this._draggedOverObjectLastSetUp=null,this._draggedOverObjectLastNormal.set(0,1,0),this._draggedOverObjectDuration=0}collectMovementInfo(){var o,r;if(!this._followObject.parent)return;const t=this._followObject.parent;this._followObject.updateMatrix();const e=t.worldPosition,i=(r=(o=te.active)==null?void 0:o.rig)==null?void 0:r.gameObject;i&&i.worldToLocal(e),(this._lastDragPosRigSpace===void 0||i!=this._lastRig)&&(this._lastDragPosRigSpace=e.clone(),this._lastRig=i),this._tempVec.copy(e).sub(this._lastDragPosRigSpace);const n=t.worldForward;if(i&&(this._tempMat.copy(i.matrixWorld).invert(),n.transformDirection(this._tempMat)),this._totalMovementAlongRayDirection+=n.dot(this._tempVec),this._tempVec.x=Math.abs(this._tempVec.x),this._tempVec.y=Math.abs(this._tempVec.y),this._tempVec.z=Math.abs(this._tempVec.z),this._totalMovement.add(this._tempVec),this._lastDragPosRigSpace.copy(e),zs){let l=e;i&&(l=l.clone(),l.transformDirection(i.matrixWorld)),G.DrawRay(l,n,255)}}onDragUpdate(t){if(t>1)return;const e=this.gameObject;if(!e||!this._followObject){console.warn("Warning: DragPointerHandler doesn't have a dragged object. This is likely a bug.");return}const i=this._followObject.parent;if(!i){console.warn("Warning: DragPointerHandler doesn't have a drag source. This is likely a bug.");return}this._followObject.updateMatrix();const n=i.worldPosition,o=i.worldForward,r=this._deviceMode==="tracked-pointer"||this._deviceMode==="transient-pointer",l=r?this.settings.xrKeepRotation:this.settings.keepRotation,c=r?this.settings.xrDragMode:this.settings.dragMode;if(c===ri.None)return;const h=10;l&&(this._followObject.worldQuaternion=this._followObjectStartWorldQuaternion),this._followObject.updateMatrix(),this._followObject.updateMatrixWorld(!0);let d=1,u=2;if(r&&this._grabStartDistance>.5){const v=1+this._totalMovementAlongRayDirection*(2*this.settings.xrDistanceDragFactor);d=Math.max(0,v),d=d*d*d}else this._grabStartDistance<=.5&&(u=3);this._followObject.position.copy(this._followObjectStartPosition),l||this._followObject.quaternion.copy(this._followObjectStartQuaternion),this._followObject.position.multiplyScalar(d),this._followObject.updateMatrix();const f=this._hasLastSurfaceHitPoint;this._hasLastSurfaceHitPoint=!1;const p=new $r(n,o);if(c==ri.SnapToSurfaces){const v=this.context.physics.raycastFromRay(p,{testObject:S=>S!==this.followObject&&S!==i&&S!==e});if(v.length>0){const S=v[0];if(this._draggedOverObject===S.object?this._draggedOverObjectDuration+=this.context.time.deltaTime:(this._draggedOverObject=S.object,this._draggedOverObjectDuration=0),S.face){this._hasLastSurfaceHitPoint=!0,this._lastSurfaceHitPoint.copy(S.point);const T=.15,O=this._draggedOverObjectDuration>=T,M=.001,k=this._totalMovement.length()>=M,B=Q(S.normal||S.face.normal).applyQuaternion(S.object.worldQuaternion);if((O||k)&&(this._draggedOverObjectLastSetUp!==this._draggedOverObject||this._draggedOverObjectLastNormal.dot(B)<.999999||this.context.time.frame%60===0)){this._draggedOverObjectLastSetUp=this._draggedOverObject,this._draggedOverObjectLastNormal.copy(S.face.normal);const I=Q(),E=Q();this._bounds.getCenter(I),this._bounds.getSize(E),I.sub(E.multiplyScalar(.5).multiply(B)),this._hitPointInLocalSpace.copy(I),this._hitNormalInLocalSpace.copy(S.face.normal),this._bounds.getCenter(I),this._bounds.getSize(E),I.add(E.multiplyScalar(.5).multiply(S.face.normal));const L=Q(this._hitPointInLocalSpace).add(I);this._followObject.localToWorld(L);const V=S.point;this._dragPlane.setFromNormalAndCoplanarPoint(B,V)}else if(!(O||k))return}}else f&&this.gameObject&&this.setPlaneViewAligned(this.gameObject.worldPosition,!1)}if(c!==ri.Attached&&p.intersectPlane(this._dragPlane,this._tempVec)){this._followObject.worldPosition=this._tempVec,this._followObject.updateMatrix(),this._followObject.updateMatrixWorld(!0);const v=Q(this._hitPointInLocalSpace);this._followObject.localToWorld(v),zs&&G.DrawLine(v,this._tempVec,65535,0,!1),this._followObject.worldPosition=this._tempVec.multiplyScalar(2).sub(v),this._followObject.updateMatrix(),this._followObject.updateMatrix()}if(this.settings.snapGridResolution>0){const v=this._followObject.worldPosition,S=this.settings.snapGridResolution;v.x=Math.round(v.x/S)*S,v.y=Math.round(v.y/S)*S,v.z=Math.round(v.z/S)*S,this._followObject.worldPosition=v,this._followObject.updateMatrix()}l&&(this._followObject.worldQuaternion=this._followObjectStartWorldQuaternion,this._followObject.updateMatrix());const g=W.clamp01(this.context.time.deltaTime*h*u),y=W.clamp01(this.context.time.deltaTime*h*.5*u),b=e.worldPosition;b.lerp(this._followObject.worldPosition,g),e.worldPosition=b;const _=e.worldQuaternion;if(_.slerp(this._followObject.worldQuaternion,y),e.worldQuaternion=_,zs){const v=this._hitPointInLocalSpace.clone();e.localToWorld(v),G.DrawSphere(v,.02,16711680);const S=this._hitNormalInLocalSpace.clone();S.applyQuaternion(_),G.DrawRay(v,S,16711680),G.DrawLabel(b.add(new x(0,.25,0)),`Distance: ${this._totalMovement.length().toFixed(2)}

                Along Ray: ${this._totalMovementAlongRayDirection.toFixed(2)}

                Session: ${!!te.active}

                Device: ${this._deviceMode}

                `,.03);const T=this._bottomCenter.clone(),O=this._backCenter.clone(),M=this._backBottomCenter.clone();e.localToWorld(T),e.localToWorld(O),e.localToWorld(M),G.DrawSphere(T,.01,65280,0,!1),G.DrawSphere(O,.01,255,0,!1),G.DrawSphere(M,.01,16711935,0,!1),G.DrawLine(T,M,65535,0,!1),G.DrawLine(M,O,65535,0,!1)}}onDragEnd(t){console.assert(this._followObject.parent===t.event.space,"Drag end: _followObject is not parented to the space object"),this._followObject.removeFromParent(),this._followObject.destroy(),this._lastDragPosRigSpace=void 0}setPlaneViewAligned(t,e){if(!this._followObject.parent)return!1;const i=this._followObject.parent.worldForward,n=Q(0,1,0),o=i,r=n.angleTo(o),l=.5;return e&&(r>Math.PI/2+l||r<Math.PI/2-l)?this._dragPlane.setFromNormalAndCoplanarPoint(n,t):this._dragPlane.setFromNormalAndCoplanarPoint(i,t),!0}}const Kb=class{constructor(t){a(this,"showGizmo",!0);a(this,"useViewAngle",!0);a(this,"_selected",null);a(this,"_context",null);a(this,"_camera");a(this,"_cameraPlane",new $a);a(this,"_hasGroundPlane",!1);a(this,"_groundPlane",new $a);a(this,"_groundOffset",new x);a(this,"_groundOffsetFactor",0);a(this,"_groundDistance",0);a(this,"_groundPlanePoint",new x);a(this,"_raycaster",new Sp);a(this,"_cameraPlaneOffset",new x);a(this,"_intersection",new x);a(this,"_worldPosition",new x);a(this,"_inverseMatrix",new le);a(this,"_rbs",[]);a(this,"_groundLine");a(this,"_groundMarker");a(this,"_groundOffsetVector",new x(0,1,0));a(this,"_requireUpdateGroundPlane",!0);a(this,"_didDragOnGroundPlaneLastFrame",!1);this._camera=t;const e=new yd(Kb.geometry),i=e.material;i.color=new ue(.4,.4,.4),e.layers.set(2),e.name="line",e.scale.y=1,this._groundLine=e;const n=new wp(.5,22,22),o=new Ue({color:i.color}),r=new Z(n,o);r.visible=!1,r.layers.set(2),this._groundMarker=r}get hasSelected(){return this._selected!==null&&this._selected!==void 0}get selected(){return this._selected}setSelected(t,e){if(this._selected&&e)for(const i of this._rbs)i.wakeUp(),i.setVelocity(0,0,0);if(this._selected&&Do.Remove(e,this._selected),this._selected=t,this._context=e,this._rbs.length=0,t?(e.scene.add(this._groundLine),e.scene.add(this._groundMarker)):(this._groundLine.removeFromParent(),this._groundMarker.removeFromParent()),this._selected){if(!e){console.error("DragHelper: no context");return}Do.Add(e,this._selected,null),this._groundOffsetFactor=0,this._hasGroundPlane=!0,this._groundOffset.set(0,0,0),this._requireUpdateGroundPlane=!0,this.onUpdateScreenSpacePlane()}}onUpdate(t){this._selected}onUpdateWorldPosition(t,e,i){if(this._selected){if(i){const n=ae(this._selected);n.y=t.y,t=n}if(jt(this._selected,t),jt(this._groundLine,t),this._hasGroundPlane?this._groundLine.scale.y=this._groundDistance:this._groundLine.scale.y=1e3,this._groundLine.visible=this.showGizmo,this._groundMarker.visible=e!==null&&this.showGizmo,e){const n=ae(this._camera).distanceTo(e)*.01;this._groundMarker.scale.set(n,n,n),jt(this._groundMarker,e)}}}onUpdateScreenSpacePlane(){if(!this._selected||!this._context)return;const t=this._context.input.getPointerPositionRC(0);t&&(this._raycaster.setFromCamera(t,this._camera),this._cameraPlane.setFromNormalAndCoplanarPoint(this._camera.getWorldDirection(this._cameraPlane.normal),this._worldPosition.setFromMatrixPosition(this._selected.matrixWorld)),this._raycaster.ray.intersectPlane(this._cameraPlane,this._intersection)&&this._selected.parent&&(this._inverseMatrix.copy(this._selected.parent.matrixWorld).invert(),this._cameraPlaneOffset.copy(this._intersection).sub(this._worldPosition.setFromMatrixPosition(this._selected.matrixWorld))))}onUpdateGroundPlane(){if(!this._selected||!this._context)return;const t=ae(this._selected),e=new $r(Q(0,.1,0).add(t),Q(0,-1,0)),i=new $o;i.testObject=o=>o!==this._selected;const n=this._context.physics.raycastFromRay(e,i);for(let o=0;o<n.length;o++){const r=n[o];if(!r.face||this.contains(this._selected,r.object))continue;const l=Q(0,1,0);this._groundPlane.setFromNormalAndCoplanarPoint(l,r.point);break}this._hasGroundPlane=!0,this._groundPlane.setFromNormalAndCoplanarPoint(e.direction.multiplyScalar(-1),e.origin),this._raycaster.ray.intersectPlane(this._groundPlane,this._intersection),this._groundDistance=this._intersection.distanceTo(t),this._groundOffset.copy(this._intersection).sub(t)}contains(t,e){if(t===e)return!0;if(t.children){for(const i of t.children)if(this.contains(i,e))return!0}return!1}};let Pg=Kb;a(Pg,"geometry",new ko().setFromPoints([new x(0,0,0),new x(0,-1,0)]));var ax;(function(s){s.File_Spawned="file-spawned"})(ax||(ax={}));class FL{constructor(t,e,i,n,o,r,l,c,h){a(this,"guid");a(this,"file_name");a(this,"file_hash");a(this,"file_size");a(this,"position");a(this,"scale");a(this,"seed");a(this,"sender");a(this,"downloadUrl");a(this,"parentGuid");a(this,"boundsSize");this.seed=e,this.guid=i,this.file_name=n,this.file_hash=o,this.file_size=r,this.position=l,this.scale=c,this.sender=t,this.downloadUrl=h}}var ba;(function(s){const t=new Map;function e(n){var u;t.has(n.guid)&&i(n.guid);const o=new F;t.set(n.guid,o);const r=new F;r.position.y=-.5,o.add(r);const l=new Z(new gd(1,1,1,1,1,1),new Ue({color:14540253,wireframe:!0,transparent:!0,opacity:.3}));l.position.y=.5,r.add(l);const c=new F;r.add(c);const h=new Z(new gd(1,1,1,1,1,1),new Ue({color:12307660,transparent:!0,opacity:.4}));h.position.y=.5,c.scale.y=.01,c.add(h);const d=new Z(new Ys(1,1,1,1),new Ue({color:34,transparent:!0,opacity:.05,depthTest:!1}));return d.rotateX(-Math.PI/2),d.position.y=.51,h.add(d),n.parent.add(o),o.rotateY(Math.PI/2),n.position&&((u=o.position)==null||u.copy(n.position)),n.size&&(o.worldScale=new x().copy(n.size)),o.position.y=o.scale.y/2,{object:o,onProgress:f=>{c instanceof F&&c.scale.set(1,f,1)}}}s.addPreview=e;function i(n){const o=t.get(n);o&&(t.delete(n),o.removeFromParent())}s.removePreview=i})(ba||(ba={}));var Fc=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const Xn=C("debugdroplistener");var Wf;(function(s){s.FileDropped="file-dropped",s.ObjectAdded="object-added"})(Wf||(Wf={}));class AA extends CustomEvent{constructor(t){super(Wf.ObjectAdded,{detail:t})}}const IA="blob";class Yr extends j{constructor(){super(...arguments);a(this,"useNetworking",!0);a(this,"dropArea");a(this,"fitIntoVolume",!1);a(this,"fitVolumeSize",new x(1,1,1));a(this,"placeAtHitPosition",!0);a(this,"onDropped",new Te);a(this,"onNetworkEvent",e=>{var i;if(!this.useNetworking){Xn&&console.debug("[DropListener] Ignoring networked event because networking is disabled",e);return}if((i=e.guid)!=null&&i.startsWith(this.guid)){const n=e.url;if(console.debug("[DropListener] Received networked event",e),n)if(Array.isArray(n))for(const o of n)this.addFromUrl(o,{screenposition:new ce,point:e.point,size:e.size},!0);else this.addFromUrl(n,{screenposition:new ce,point:e.point,size:e.size},!0)}});a(this,"handlePaste",e=>{if(this.context.connection.allowEditing===!1||e.defaultPrevented)return;navigator.clipboard.readText().then(n=>{if(n&&(n.startsWith("http")||n.startsWith("https")||n.startsWith("blob"))){const r={screenposition:new ce(this.context.input.mousePosition.x,this.context.input.mousePosition.y)};this.testIfIsInDropArea(r)&&this.addFromUrl(n,r,!1)}}).catch(console.warn)});a(this,"onDrag",e=>{this.context.connection.allowEditing!==!1&&e.preventDefault()});a(this,"onDrop",async e=>{if(this.context.connection.allowEditing===!1||(Xn&&console.log(e),!(e!=null&&e.dataTransfer))||e["droplistener:handled"])return;e.preventDefault();const i={screenposition:new ce(e.offsetX,e.offsetY)};if(this.dropArea&&this.testIfIsInDropArea(i)===!1)return;e["droplistener:handled"]=!0;const n=e.dataTransfer.items;if(!n)return;const o=[];for(const r in n){const l=n[r];if(l.kind==="file"){const c=l.getAsFile();if(!c)continue;o.push(c)}else l.kind==="string"&&l.type=="text/plain"&&l.getAsString(c=>{this.addFromUrl(c,i,!1)})}o.length>0&&await this.addDroppedFiles(o,i)});a(this,"_abort",null);a(this,"_addedObjects",new Array);a(this,"_addedModels",new Array)}onEnable(){this.context.renderer.domElement.addEventListener("dragover",this.onDrag),this.context.renderer.domElement.addEventListener("drop",this.onDrop),window.addEventListener("paste",this.handlePaste),this.context.connection.beginListen("droplistener",this.onNetworkEvent)}onDisable(){this.context.renderer.domElement.removeEventListener("dragover",this.onDrag),this.context.renderer.domElement.removeEventListener("drop",this.onDrop),window.removeEventListener("paste",this.handlePaste),this.context.connection.stopListen("droplistener",this.onNetworkEvent)}loadFromURL(e,i){this.addFromUrl(e,{screenposition:new ce,point:i==null?void 0:i.point,size:i==null?void 0:i.size},!0)}forgetObjects(){this.removePreviouslyAddedObjects(!1)}async addFromUrl(e,i,n){Xn&&console.log("dropped url",e);try{if(e.startsWith("https://github.com/")){const l=e.split("/"),c=l[3],h=l[4],d=l[6],u=l.slice(7).join("/");e=`https://raw.githubusercontent.com/${c}/${h}/${d}/${u}`}else e.startsWith("https://polyhaven.com/a")&&(e=DA(e));if(!e)return null;const o=e.toLowerCase();if(o.endsWith(".hdr")||o.endsWith(".hdri")||o.endsWith(".exr")||o.endsWith(".png")||o.endsWith(".jpg")||o.endsWith(".jpeg"))return null;this.removePreviouslyAddedObjects();const r=await Vf.loadFileFromURL(new URL(e),{guid:this.guid,context:this.context,parent:this.gameObject,point:i.point,size:i.size});if(r&&this._addedObjects.length<=0)return i.url=e,this.addObject(r,i,n)}catch{console.warn("String is not a valid URL",e)}return null}async addDroppedFiles(e,i){var n,o;if(Xn&&console.log("Add files",e),!!Array.isArray(e)&&e.length){this.deleteDropEvent(),this.removePreviouslyAddedObjects(),bf(IA,null),(n=this._abort)==null||n.abort("New files dropped"),this._abort=new AbortController;for(const r of e){if(!r)continue;console.debug("Load file "+r.name);const l=await Vf.loadFile(r,this.context,{guid:this.guid});if(l){this.dispatchEvent(new CustomEvent(Wf.FileDropped,{detail:r})),i.file=r;const c=this.addObject(l,i,!1);c&&this.context.connection.isConnected&&this.useNetworking&&(console.debug("Uploading dropped file to blob storage"),Rc.upload(r,{abort:(o=this._abort)==null?void 0:o.signal}).then(h=>{h!=null&&h.download_url&&this._addedObjects.includes(c)&&this.sendDropEvent(h.download_url,c,l.contentMD5)}).catch(console.warn));break}}}}removePreviouslyAddedObjects(e=!0){if(e)for(const i of this._addedObjects)i.parent===this.gameObject&&Ln(i,!0,!0);this._addedObjects.length=0,this._addedModels.length=0}addObject(e,i,n){var d,u;const{model:o,contentMD5:r}=e;if(Xn&&console.log(`Dropped ${this.gameObject.name}`,o),!(o!=null&&o.scene))return console.warn("No object specified to add to scene",o),null;this.removePreviouslyAddedObjects();const l=o.scene;this.gameObject.attach(l),l.position.set(0,0,0),l.quaternion.identity(),this._addedObjects.push(l),this._addedModels.push(o);const c=new En().setFromCenterAndSize(new x(0,this.fitVolumeSize.y*.5,0).add(this.gameObject.worldPosition),this.fitVolumeSize);if(Xn&&G.DrawWireBox3(c,255,5),this.fitIntoVolume&&XO(l,c,{position:!this.placeAtHitPosition}),this.placeAtHitPosition&&i&&i.screenposition){l.visible=!1;const f=this.context.physics.raycast({screenPoint:this.context.input.convertScreenspaceToRaycastSpace(i.screenposition.clone())});if(l.visible=!0,f&&f.length>0)for(const p of f){const g=p.point.clone();Xn&&console.log("Place object at hit",p),QO(l,g);break}}Od.assignAnimationsFromFile(o,{createAnimationComponent:f=>Mn(f,Mi)});const h=new AA({sender:this,gltf:o,model:o,object:l,contentMD5:r,dropped:i.file||(i.url?new URL(i.url):void 0)});return this.dispatchEvent(h),(d=this.onDropped)==null||d.invoke(h.detail),!n&&((u=i.url)!=null&&u.startsWith("http"))&&this.context.connection.isConnected&&l&&this.sendDropEvent(i.url,l,r),l}async sendDropEvent(e,i,n){if(!this.useNetworking){Xn&&console.debug("[DropListener] Ignoring networked event because networking is disabled",e);return}if(this.context.connection.isConnected){console.debug('Sending drop event "'+i.name+'"',e);const o=dn([i]),r={name:i.name,guid:this.guid,url:e,point:i.worldPosition.clone(),size:o.getSize(new x),contentMD5:n};this.context.connection.send("droplistener",r)}}deleteDropEvent(){this.context.connection.sendDeleteRemoteState(this.guid)}testIfIsInDropArea(e){if(this.dropArea){const i=this.context.input.convertScreenspaceToRaycastSpace(e.screenposition.clone());if(!this.context.physics.raycast({targets:[this.dropArea],screenPoint:i,recursive:!0,testObject:o=>!this._addedObjects.includes(o)}).length)return U()&&console.log(`Dropped outside of drop area for DropListener "${this.name}".`),!1}return!0}}Fc([m()],Yr.prototype,"useNetworking",void 0);Fc([m(F)],Yr.prototype,"dropArea",void 0);Fc([m()],Yr.prototype,"fitIntoVolume",void 0);Fc([m(x)],Yr.prototype,"fitVolumeSize",void 0);Fc([m()],Yr.prototype,"placeAtHitPosition",void 0);Fc([m(Te)],Yr.prototype,"onDropped",void 0);function DA(s){if(!s.startsWith("https://polyhaven.com/"))return s;const t="https://dl.polyhaven.org/file/ph-assets/Models/gltf/4k/",n=new URL(s).pathname.split("/").pop(),o=`${t}${n}/${n}_4k.gltf`;return console.log("Resolved polyhaven asset url",s,"‚Üí",o),o}var Vf;(function(s){async function t(i,n,o){const r=i.name.toLowerCase();return r.endsWith(".gltf")||r.endsWith(".glb")||r.endsWith(".fbx")||r.endsWith(".obj")||r.endsWith(".usdz")||r.endsWith(".vrm")||i.type==="model/gltf+json"||i.type==="model/gltf-binary"?new Promise((l,c)=>{const h=new FileReader;h.readAsArrayBuffer(i),h.onloadend=async d=>{const u=h.result,f=o.guid,p=new ui(f),g=await qs().parseSync(n,u,i.name,p);if(g){const y=Rc.hashMD5(u);l({model:g,contentMD5:y})}}}):(console.warn("Unsupported file type: "+r,i.type),null)}s.loadFile=t;async function e(i,n){return new Promise(async(o,r)=>{const l=new ui(n.guid),c=i.toString();Xn&&G.DrawWireSphere(n.point,.1,16711680,3);const h=ba.addPreview({guid:n.guid,parent:n.parent,position:n==null?void 0:n.point,size:n==null?void 0:n.size}),d=await qs().loadSync(n.context,c,c,l,u=>{h.onProgress(u.loaded/u.total)}).catch(console.warn);if(d){const u=await fetch(c).then(p=>p.arrayBuffer()),f=Rc.hashMD5(u);Xn?setTimeout(()=>ba.removePreview(n.guid),3e3):ba.removePreview(n.guid),o({model:d,contentMD5:f})}else Xn?setTimeout(()=>ba.removePreview(n.guid),3e3):ba.removePreview(n.guid),console.warn("Unsupported file type: "+i.toString())})}s.loadFileFromURL=e})(Vf||(Vf={}));var db=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};class ol extends j{constructor(){super(...arguments);a(this,"parent",null);a(this,"object",null);a(this,"limitCount",60);a(this,"_currentCount",0);a(this,"_startPosition",null);a(this,"_startQuaternion",null);a(this,"_forwardPointerEvents",new Map)}start(){var e,i;if(this._currentCount=0,this._startPosition=null,this._startQuaternion=null,this.object||(this.object=this.gameObject),this.object){if(this.object===this.gameObject){const o=new ui(this.guid);this.object=P.instantiate(this.object,{idProvider:o,keepWorldPosition:!1});const r=P.getComponent(this.object,ol);r==null||r.destroy();let l=this.object.getComponentInChildren(Dt);l||(l=this.object.addComponent(Dt,{dragMode:ri.SnapToSurfaces}),l.guid=o.generateUUID());let c=P.getComponent(l.gameObject,Wo);c||(c=l.gameObject.addComponent(Wo),c.guid=o.generateUUID())}this.object.visible=!1;const n=this.gameObject.getComponent(Dt);n&&(n.enabled=!1),this._startPosition=((e=this.object.position)==null?void 0:e.clone())??new x(0,0,0),this._startQuaternion=((i=this.object.quaternion)==null?void 0:i.clone())??new H(0,0,0,1)}this.gameObject.getComponentInParent(jn)||this.gameObject.addComponent(jn)}onEnable(){this.startCoroutine(this.cloneLimitIntervalFn())}onPointerEnter(e){e.used||this.object&&this.context.connection.allowEditing&&e.button===0&&this.context.input.setCursor("pointer")}onPointerExit(e){e.used||this.object&&this.context.connection.allowEditing&&e.button===0&&this.context.input.unsetCursor("pointer")}onPointerDown(e){if(e.used||!this.object||!this.context.connection.allowEditing||e.button!==0)return;const i=this.handleDuplication();if(i){const n=P.getComponent(i,Dt);n?(n.onPointerDown(e),this._forwardPointerEvents.set(e.event.space,n)):console.warn("Duplicated object does not have DragControls",i)}else this._currentCount>=this.limitCount?console.warn(`[Duplicatable] Limit of ${this.limitCount} objects created within a few seconds reached. Please wait a moment before creating more objects.`):console.warn("[Duplicatable] Could not duplicate object.")}onPointerUp(e){if(e.used)return;const i=this._forwardPointerEvents.get(e.event.space);i&&(i.onPointerUp(e),this._forwardPointerEvents.delete(e.event.space))}*cloneLimitIntervalFn(){for(;this.activeAndEnabled&&!this.destroyed;)this._currentCount>0?this._currentCount-=1:this._currentCount<0&&(this._currentCount=0),yield OC(1)}handleDuplication(){var n;if(!this.object||this.limitCount>0&&this._currentCount>=this.limitCount||this.object===this.gameObject)return null;if(P.isDestroyed(this.object))return this.object=null,null;this.object.visible=!0,this._startPosition&&this.object.position.copy(this._startPosition),this._startQuaternion&&this.object.quaternion.copy(this._startQuaternion);const e=new Js;this.parent||(this.parent=this.gameObject.parent),this.parent&&(e.parent=this.parent.guid??((n=this.parent.userData)==null?void 0:n.guid),e.keepWorldPosition=!0),e.position=this.worldPosition,e.rotation=this.worldQuaternion,e.context=this.context,this._currentCount+=1;const i=P.instantiateSynced(this.object,e);return console.assert(i!==this.object,"Duplicated object is original"),this.object.visible=!1,this._startPosition&&this.object.position.clone().copy(this._startPosition),this._startQuaternion&&this.object.quaternion.clone().copy(this._startQuaternion),i}}db([m(F)],ol.prototype,"parent",void 0);db([m(F)],ol.prototype,"object",void 0);db([m()],ol.prototype,"limitCount",void 0);var ys;(function(s){s[s.PointerEnter=0]="PointerEnter",s[s.PointerExit=1]="PointerExit",s[s.PointerDown=2]="PointerDown",s[s.PointerUp=3]="PointerUp",s[s.PointerClick=4]="PointerClick",s[s.Drag=5]="Drag",s[s.Drop=6]="Drop",s[s.Scroll=7]="Scroll",s[s.UpdateSelected=8]="UpdateSelected",s[s.Select=9]="Select",s[s.Deselect=10]="Deselect",s[s.Move=11]="Move",s[s.InitializePotentialDrag=12]="InitializePotentialDrag",s[s.BeginDrag=13]="BeginDrag",s[s.EndDrag=14]="EndDrag",s[s.Submit=15]="Submit",s[s.Cancel=16]="Cancel"})(ys||(ys={}));var ub=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};class fb{constructor(){a(this,"eventID");a(this,"callback",new Te)}}ub([m()],fb.prototype,"eventID",void 0);ub([m(Te)],fb.prototype,"callback",void 0);class pb extends j{constructor(){super(...arguments);a(this,"triggers",[])}invoke(e){var i;if(this.triggers)for(const n of this.triggers)n.eventID===e&&((i=n.callback)==null||i.invoke())}hasTrigger(e){var i;return((i=this.triggers)==null?void 0:i.some(n=>n.eventID===e))??!1}shouldChangeCursor(){return this.hasTrigger(ys.PointerClick)||this.hasTrigger(ys.PointerDown)||this.hasTrigger(ys.PointerUp)}onPointerClick(e){this.invoke(ys.PointerClick)}onPointerEnter(e){this.shouldChangeCursor()&&this.context.input.setCursor("pointer"),this.invoke(ys.PointerEnter)}onPointerExit(e){this.shouldChangeCursor()&&this.context.input.unsetCursor("pointer"),this.invoke(ys.PointerExit)}onPointerDown(e){this.invoke(ys.PointerDown)}onPointerUp(e){this.invoke(ys.PointerUp)}}ub([m(fb)],pb.prototype,"triggers",void 0);class KC{constructor(t){a(this,"writer");this.writer=t}writeNode(t){}}class LA extends KC{beforeWriteNode(t,e){G.isGizmo(t)&&(e.keep=!1)}}class JC extends KC{beforeWriteTexture(t,e){t.isRenderTargetTexture&&(e.newTexture=Z_(new Ae(1,1,1,0)))}}function Jy(s){const t=Nf.DontExport;return!(s.hideFlags&t)}const Rg=C("debugexr");class jA{constructor(t){a(this,"parser");this.parser=t,Rg&&console.log(t)}get name(){return"EXT_texture_exr"}loadTexture(t){const e=this.name,i=this.parser,o=i.json.textures[t];if(Rg&&console.log("EXT_texture_exr.loadTexture",t,o),!o.extensions||!o.extensions[e])return null;const r=o.extensions[e],l=new _f(i.options.manager);return Rg&&console.log("EXT_texture_exr.loadTexture",r),i.loadTextureImage(t,r.source,l)}}typeof window<"u"&&window.addEventListener("unhandledrejection",s=>{});const ro=At,Eu="$___Export_Components",BA="NEEDLE_components";var TD;class FA{constructor(){a(this,TD)}}TD=kl;class zA{constructor(t,e,i){a(this,"node");a(this,"nodeIndex");a(this,"nodeDef");this.node=t,this.nodeIndex=e,this.nodeDef=i}}class ZC{constructor(){a(this,"parser");a(this,"nodeToObjectMap",{});a(this,"gltf",null);a(this,"exportContext");a(this,"objectToNodeMap",{});a(this,"context");a(this,"writer")}get name(){return BA}registerExport(t){t.register(e=>{if("serializeUserData"in e){const i=e.serializeUserData.bind(e);this.writer=e,e.serializeUserData=(n,o)=>{try{this.serializeUserData(n,o)&&(e.extensionsUsed[this.name]=!0),i(n,o)}finally{this.afterSerializeUserData(n,o)}}}return this})}beforeParse(){this.exportContext={},this.objectToNodeMap={}}serializeUserData(t,e){var n;const i=(n=t.userData)==null?void 0:n.components;return!i||i.length<=0?!1:(delete t.userData.components,t[Eu]=i,!0)}afterSerializeUserData(t,e){if(t.type==="Scene"&&ro&&console.log("DONE",JSON.stringify(e)),t[Eu]===void 0)return;const i=t[Eu];delete t[Eu],i!==null&&(t.userData.components=i)}writeNode(t,e){const i=this.writer.json.nodes.length;ro&&console.log(t.name,i,t.uuid);const n=new zA(t,i,e);this.exportContext[i]=n,this.objectToNodeMap[t.uuid]=i}afterParse(t){var e;ro&&console.log("AFTER",t);for(const i in this.exportContext){const n=this.exportContext[i],o=n.node,r=n.nodeDef,l=n.nodeIndex,c=(e=o.userData)==null?void 0:e.components;if(!c||c.length<=0)continue;const h=new FA;r.extensions=r.extensions||{},r.extensions[this.name]=h,this.context.object=o,this.context.nodeId=l,this.context.objectToNode=this.objectToNodeMap;const d=[];for(const u of c){this.context.target=u;const f=qs().writeBuiltinComponentData(u,this.context);f!==null&&d.push(f)}d.length>0&&(h[kl]=d,ro&&console.log("DID WRITE",o,"nodeIndex",l,d))}}beforeRoot(){return ro&&console.log("BEGIN LOAD"),this.nodeToObjectMap={},null}async afterRoot(t){this.gltf=t;const e=t.parser,i=e==null?void 0:e.extensions;if(!i)return;const n=i[this.name];ro&&console.log("After root",t,this.parser,i);const o=[];if(n===!0){const r=e.json.nodes;if(r){for(let l=0;l<r.length;l++){const c=await e.getDependency("node",l);this.nodeToObjectMap[l]=c}for(let l=0;l<r.length;l++){const c=r[l],h=l,d=c.extensions;if(!d)continue;const u=d[this.name];if(!u)continue;ro&&console.log("NODE",c);const f=this.nodeToObjectMap[h];if(!f){console.error("Could not find object for node index: "+h,c,e);continue}Y_(f),o.push(this.createComponents(f,u))}}}await Promise.all(o);for(const r of e.associations.keys()){const l=e.associations.get(r);if((l==null?void 0:l.materials)!=null){const c="/materials/"+l.materials;vE(r,c)}}}async createComponents(t,e){if(!e)return;const i=e[kl];if(i){const n=new Array;ro&&console.log(t.name,i);for(const o in i){const r=i[o];ro&&console.log("Serialized data",JSON.parse(JSON.stringify(r))),r&&this.parser&&n.push(X_(this.parser,r).catch(l=>console.error(`Error while resolving references (see console for details)
`,l,t,r))),t.userData=t.userData||{},t.userData[kl]=t.userData[kl]||[],t.userData[kl].push(r)}await Promise.all(n).catch(o=>{console.error("Error while loading components",o)})}}}const lx="NEEDLE_gameobject_data";class UA{constructor(t){a(this,"parser");this.parser=t}get name(){return lx}afterRoot(t){var i;const e=[];for(let n=0;n<((i=this.parser.json.nodes)==null?void 0:i.length);n++){const o=this.parser.json.nodes[n];if(o&&o.extensions){const r=o.extensions[lx];if(r){const l=this.findAndApplyExtensionData(n,r);e.push(l)}}}return Promise.all(e).then(()=>null)}async findAndApplyExtensionData(t,e){const i=await this.parser.getDependency("node",t);i&&this.applyExtensionData(i,e)}applyExtensionData(t,e){e.layers===void 0&&(e.layers=0),t.userData.layer=e.layers,t.layers.disableAll(),t.layers.set(e.layers),t.userData.tag=e.tag??"none",t.hideFlags=0,t.userData.static=e.static??!1,t.visible=e.activeSelf??!0,t.guid=e.guid}}const cx="NEEDLE_lighting_settings",Il=C("debugenvlight");class NA{constructor(t,e,i){a(this,"parser");a(this,"sourceId");a(this,"context");this.parser=t,this.sourceId=e,this.context=i}get name(){return cx}afterRoot(t){const e=this.parser.json.extensions;if(e){const i=e[cx];if(i){Il&&console.log('Loaded "'+this.name+'", src: "'+this.sourceId+'"',i);let n;if(t.scene.children.length===1){const o=t.scene.children[0];n=P.addComponent(o,Zy,{},{callAwake:!1})}else{const o=new F;o.name="LightSettings "+this.sourceId,t.scene.add(o),n=P.addComponent(o,Zy,{},{callAwake:!1})}n.sourceId=this.sourceId,n.ambientIntensity=i.ambientIntensity,n.ambientLight=new ue().fromArray(i.ambientLight),Array.isArray(i.ambientTrilight)&&(n.ambientTrilight=i.ambientTrilight.map(o=>new ue().fromArray(o))),n.ambientMode=i.ambientMode,n.environmentReflectionSource=i.environmentReflectionSource}}return null}}be.registerCallback(me.ContextCreated,s=>{const t=s.context,e=P.findObjectOfType(Zy,t);e!=null&&e.sourceId&&(e.enabled=!0)});class Zy extends j{constructor(){super(...arguments);a(this,"ambientMode",Ds.Skybox);a(this,"ambientLight");a(this,"ambientTrilight");a(this,"ambientIntensity",1);a(this,"environmentReflectionSource",Td.Skybox);a(this,"_hasReflection",!1);a(this,"_ambientLightObj");a(this,"_hemisphereLightObj")}awake(){var i;if(this.sourceId){const n=this.environmentReflectionSource===Td.Skybox?Po.Skybox:Po.Reflection,o=this.context.lightmaps.tryGet(this.sourceId,n,0);this._hasReflection=o!=null,o&&this.context.sceneLighting.internalRegisterReflection(this.sourceId,o)}this.enabled=!1,this.context.sceneLighting.internalRegisterSceneLightSettings(this),Il&&window.addEventListener("keydown",n=>{if(!this.destroyed)switch(n.key){case"l":this.enabled=!this.enabled;break}});const e=(i=this.gameObject.userData)==null?void 0:i.components;if(e){const n=e.indexOf(this);e.splice(n,1),e.push(this)}}onDestroy(){this.context.sceneLighting.internalUnregisterSceneLightSettings(this)}calculateIntensityFactor(e){const i=Math.max(e.r,e.g,e.b);return 2.2*W.lerp(0,1.33,i)}onEnable(){if(Il&&console.warn("üí°üü° >>> Enable lighting",this.sourceId,this.enabled,this),this.ambientMode==Ds.Flat){if(this.ambientLight&&!this._ambientLightObj){const e=this.calculateIntensityFactor(this.ambientLight);this._ambientLightObj=new zP(this.ambientLight,this.ambientIntensity*e),Il&&console.log("Created ambient light",this.sourceId,this._ambientLightObj,this.ambientIntensity,e)}this._ambientLightObj&&this.gameObject.add(this._ambientLightObj)}else if(this.ambientMode===Ds.Trilight){if(this.ambientTrilight){const e=this.ambientTrilight[0],i=this.ambientTrilight[this.ambientTrilight.length-1],n=this.calculateIntensityFactor(i);this._hemisphereLightObj=new UP(i,e,this.ambientIntensity*n),this.gameObject.add(this._hemisphereLightObj),Il&&console.log("Created hemisphere ambient light",this.sourceId,this._hemisphereLightObj,this.ambientIntensity,n)}}else this._ambientLightObj&&this._ambientLightObj.removeFromParent(),this._hemisphereLightObj&&this._hemisphereLightObj.removeFromParent();this.sourceId&&this.context.sceneLighting.internalEnableReflection(this.sourceId)}onDisable(){Il&&console.warn("üí°‚ö´ <<< Disable lighting:",this.sourceId,this),this._ambientLightObj&&this._ambientLightObj.removeFromParent(),this._hemisphereLightObj&&this._hemisphereLightObj.removeFromParent(),this.sourceId&&this.context.sceneLighting.internalDisableReflection(this.sourceId)}}const Og=C("debugstencil");function $A(s,t){return(s&1<<t.layer)!=0}const WA=Symbol("stencils"),Sa=class{constructor(t,e){a(this,"parser");a(this,"source");this.parser=t,this.source=e}get name(){return"NEEDLE_render_objects"}static applyStencil(t){if(!t)return;const e=t.sourceId;if(Og&&console.log(e,Sa.stencils),!e)return;const i=Sa.stencils[e];if(i)for(let n=i.length-1;n>=0;n--){const o=i[n];if($A(o.layer,t)){Og&&console.log(o),setTimeout(()=>{qi()&&K_(t.gameObject)&&(Me("Stencil not supported on instanced objects"),console.warn("Stencil not supported on instanced objects",t))},500);for(let r=0;r<t.sharedMaterials.length;r++){let l=t.sharedMaterials[r];l&&(l=l.clone(),l[WA]=!0,l.stencilWrite=!0,l.stencilWriteMask=255,l.stencilFuncMask=255,l.stencilRef=o.value,l.stencilFunc=o.compareFunc,l.stencilZPass=o.passOp,l.stencilFail=o.failOp,l.stencilZFail=o.zFailOp,t.sharedMaterials[r]=l)}t.gameObject.renderOrder=o.event*1e3+o.index*50;break}}}afterRoot(t){const e=this.parser.json.extensions;if(e){const i=e[HA];if(i){Og&&console.log(i);const n=i.stencil;if(n&&Array.isArray(n))for(const o of n){const r={...o};r.compareFunc=VA(r.compareFunc),r.passOp=Tg(r.passOp),r.failOp=Tg(r.failOp),r.zFailOp=Tg(r.zFailOp),Sa.stencils[this.source]||(Sa.stencils[this.source]=[]),Sa.stencils[this.source].push(r)}}}return null}};let Hh=Sa;a(Hh,"stencils",{});var _s;(function(s){s[s.Keep=0]="Keep",s[s.Zero=1]="Zero",s[s.Replace=2]="Replace",s[s.IncrementSaturate=3]="IncrementSaturate",s[s.DecrementSaturate=4]="DecrementSaturate",s[s.Invert=5]="Invert",s[s.IncrementWrap=6]="IncrementWrap",s[s.DecrementWrap=7]="DecrementWrap"})(_s||(_s={}));var bs;(function(s){s[s.Disabled=0]="Disabled",s[s.Never=1]="Never",s[s.Less=2]="Less",s[s.Equal=3]="Equal",s[s.LessEqual=4]="LessEqual",s[s.Greater=5]="Greater",s[s.NotEqual=6]="NotEqual",s[s.GreaterEqual=7]="GreaterEqual",s[s.Always=8]="Always"})(bs||(bs={}));function Tg(s){switch(s){case _s.Keep:return XP;case _s.Zero:return qP;case _s.Replace:return GP;case _s.IncrementSaturate:return HP;case _s.DecrementSaturate:return VP;case _s.IncrementWrap:return WP;case _s.DecrementWrap:return $P;case _s.Invert:return NP}return 0}function VA(s){switch(s){case bs.Never:return o0;case bs.Less:return tR;case bs.Equal:return eR;case bs.LessEqual:return ZP;case bs.Greater:return JP;case bs.NotEqual:return KP;case bs.GreaterEqual:return YP;case bs.Always:return QP}return o0}const HA="NEEDLE_render_objects";var hx;(function(s){s[s.Fragment=35632]="Fragment",s[s.Vertex=35633]="Vertex"})(hx||(hx={}));var e_;(function(s){s[s.INT=5124]="INT",s[s.FLOAT=5126]="FLOAT",s[s.FLOAT_VEC2=35664]="FLOAT_VEC2",s[s.FLOAT_VEC3=35665]="FLOAT_VEC3",s[s.FLOAT_VEC4=35666]="FLOAT_VEC4",s[s.INT_VEC2=35667]="INT_VEC2",s[s.INT_VEC3=35668]="INT_VEC3",s[s.INT_VEC4=35669]="INT_VEC4",s[s.BOOL=35670]="BOOL",s[s.BOOL_VEC2=35671]="BOOL_VEC2",s[s.BOOL_VEC3=35672]="BOOL_VEC3",s[s.BOOL_VEC4=35673]="BOOL_VEC4",s[s.FLOAT_MAT2=35674]="FLOAT_MAT2",s[s.FLOAT_MAT3=35675]="FLOAT_MAT3",s[s.FLOAT_MAT4=35676]="FLOAT_MAT4",s[s.SAMPLER_2D=35678]="SAMPLER_2D",s[s.SAMPLER_3D=35680]="SAMPLER_3D",s[s.SAMPLER_CUBE=35681]="SAMPLER_CUBE",s[s.UNKNOWN=0]="UNKNOWN"})(e_||(e_={}));const vs=C("debugcustomshader"),xl="NEEDLE_techniques_webgl";var dx;(function(s){s[s.INT=5124]="INT",s[s.FLOAT=5126]="FLOAT",s[s.FLOAT_VEC2=35664]="FLOAT_VEC2",s[s.FLOAT_VEC3=35665]="FLOAT_VEC3",s[s.FLOAT_VEC4=35666]="FLOAT_VEC4",s[s.INT_VEC2=35667]="INT_VEC2",s[s.INT_VEC3=35668]="INT_VEC3",s[s.INT_VEC4=35669]="INT_VEC4",s[s.BOOL=35670]="BOOL",s[s.BOOL_VEC2=35671]="BOOL_VEC2",s[s.BOOL_VEC3=35672]="BOOL_VEC3",s[s.BOOL_VEC4=35673]="BOOL_VEC4",s[s.FLOAT_MAT2=35674]="FLOAT_MAT2",s[s.FLOAT_MAT3=35675]="FLOAT_MAT3",s[s.FLOAT_MAT4=35676]="FLOAT_MAT4",s[s.SAMPLER_2D=35678]="SAMPLER_2D",s[s.SAMPLER_3D=35680]="SAMPLER_3D",s[s.SAMPLER_CUBE=35681]="SAMPLER_CUBE",s[s.UNKNOWN=0]="UNKNOWN"})(dx||(dx={}));class GA{constructor(){a(this,"objectToWorldMatrix",new le);a(this,"worldToObjectMatrix",new le);a(this,"objectToWorld",new Array);a(this,"worldToObject",new Array)}updateFrom(t){this.objectToWorldMatrix.copy(t.matrixWorld),Mf(this.objectToWorldMatrix,this.objectToWorld),this.worldToObjectMatrix.copy(t.matrixWorld).invert(),Mf(this.worldToObjectMatrix,this.worldToObject)}}var Gh;(function(s){s[s.Off=0]="Off",s[s.Front=1]="Front",s[s.Back=2]="Back"})(Gh||(Gh={}));var uo;(function(s){s[s.Never=1]="Never",s[s.Less=2]="Less",s[s.Equal=3]="Equal",s[s.LEqual=4]="LEqual",s[s.Greater=5]="Greater",s[s.NotEqual=6]="NotEqual",s[s.GEqual=7]="GEqual",s[s.Always=8]="Always"})(uo||(uo={}));const Qe=class extends pw{constructor(e,...i){super(...i);a(this,"identifier");a(this,"onBeforeRenderSceneCallback",this.onBeforeRenderScene.bind(this));a(this,"_sphericalHarmonicsName","unity_SpecCube0");a(this,"_objToWorldName","hlslcc_mtx4x4unity_ObjectToWorld");a(this,"_worldToObjectName","hlslcc_mtx4x4unity_WorldToObject");a(this,"_viewProjectionName","hlslcc_mtx4x4unity_MatrixVP");a(this,"_viewMatrixName","hlslcc_mtx4x4unity_MatrixV");a(this,"_rendererData",new GA);this.identifier=e,vs&&console.log(this),this.type="NEEDLE_CUSTOM_SHADER",this.uniforms[this._objToWorldName]||(this.uniforms[this._objToWorldName]={value:[]}),this.uniforms[this._worldToObjectName]||(this.uniforms[this._worldToObjectName]={value:[]}),this.uniforms[this._viewProjectionName]||(this.uniforms[this._viewProjectionName]={value:[]}),this.uniforms[this._sphericalHarmonicsName],(this.depthTextureUniform||this.opaqueTextureUniform)&&ne.Current.pre_render_callbacks.push(this.onBeforeRenderSceneCallback)}clone(){const e=super.clone();return e1(e),e}dispose(){super.dispose();const e=ne.Current.pre_render_callbacks.indexOf(this.onBeforeRenderSceneCallback);e>=0&&ne.Current.pre_render_callbacks.splice(e,1)}get depthTextureUniform(){if(this.uniforms)return this.uniforms._CameraDepthTexture}get opaqueTextureUniform(){if(this.uniforms)return this.uniforms._CameraOpaqueTexture}onBeforeRenderScene(){this.opaqueTextureUniform&&ne.Current.setRequireColor(!0),this.depthTextureUniform&&ne.Current.setRequireDepth(!0)}onBeforeRender(e,i,n,o,r,l){o.attributes.tangent||o.computeTangents(),this.onUpdateUniforms(n,r)}onUpdateUniforms(e,i){const n=ne.Current;if(e&&(Qe.viewProjection&&this.uniforms[this._viewProjectionName]&&(Qe.viewProjection.copy(e.projectionMatrix).multiply(e.matrixWorldInverse),Mf(Qe.viewProjection,Qe._viewProjectionValues)),Qe.viewMatrix&&this.uniforms[this._viewMatrixName]&&(Qe.viewMatrix.copy(e.matrixWorldInverse),Mf(Qe.viewMatrix,Qe._viewMatrixValues)),this.uniforms[Qe._worldSpaceCameraPosName]&&Qe._worldSpaceCameraPos.setFromMatrixPosition(e.matrixWorld)),this.uniforms._TimeParameters&&(this.uniforms._TimeParameters.value=n.sceneLighting.timeVec4),this.uniforms._Time){const c=this.uniforms._Time.value;c.x=n.sceneLighting.timeVec4.x/20,c.y=n.sceneLighting.timeVec4.x,c.z=n.sceneLighting.timeVec4.x*2,c.w=n.sceneLighting.timeVec4.x*3}if(this.uniforms._SinTime){const c=this.uniforms._SinTime.value;c.x=Math.sin(n.sceneLighting.timeVec4.x/8),c.y=Math.sin(n.sceneLighting.timeVec4.x/4),c.z=Math.sin(n.sceneLighting.timeVec4.x/2),c.w=Math.sin(n.sceneLighting.timeVec4.x)}if(this.uniforms._CosTime){const c=this.uniforms._CosTime.value;c.x=Math.cos(n.sceneLighting.timeVec4.x/8),c.y=Math.cos(n.sceneLighting.timeVec4.x/4),c.z=Math.cos(n.sceneLighting.timeVec4.x/2),c.w=Math.cos(n.sceneLighting.timeVec4.x)}if(this.uniforms.unity_DeltaTime){const c=this.uniforms.unity_DeltaTime.value;c.x=n.time.deltaTime,c.y=1/n.time.deltaTime,c.z=n.time.smoothedDeltaTime,c.w=1/n.time.smoothedDeltaTime}const o=n.mainLight;if(o){const c=ae(o.gameObject,Qe._mainLightPosition);this.uniforms._MainLightPosition={value:c.normalize()},Qe._mainLightColor.set(o.color.r,o.color.g,o.color.b,0),this.uniforms._MainLightColor={value:Qe._mainLightColor};const h=o.intensity;Qe._lightData.z=h,this.uniforms.unity_LightData={value:Qe._lightData}}if(e&&(Qe.viewProjection&&this.uniforms[this._viewProjectionName]&&(this.uniforms[this._viewProjectionName].value=Qe._viewProjectionValues),Qe.viewMatrix&&this.uniforms[this._viewMatrixName]&&(this.uniforms[this._viewMatrixName].value=Qe._viewMatrixValues),this.uniforms[Qe._worldSpaceCameraPosName]&&(this.uniforms[Qe._worldSpaceCameraPosName]={value:Qe._worldSpaceCameraPos}),n.mainCameraComponent)){if(this.uniforms._ProjectionParams){const c=this.uniforms._ProjectionParams.value;c.x=1,c.y=n.mainCameraComponent.nearClipPlane,c.z=n.mainCameraComponent.farClipPlane,c.w=1/c.z,this.uniforms._ProjectionParams.value=c}if(this.uniforms._ZBufferParams){const c=this.uniforms._ZBufferParams.value,h=n.mainCameraComponent;c.x=1-h.farClipPlane/h.nearClipPlane,c.y=h.farClipPlane/h.nearClipPlane,c.z=c.x/h.farClipPlane,c.w=c.y/h.farClipPlane,this.uniforms._ZBufferParams.value=c}if(this.uniforms._ScreenParams){const c=this.uniforms._ScreenParams.value;c.x=n.domWidth,c.y=n.domHeight,c.z=1+1/c.x,c.w=1+1/c.y,this.uniforms._ScreenParams.value=c}if(this.uniforms._ScaledScreenParams){const c=this.uniforms._ScaledScreenParams.value;c.x=n.domWidth,c.y=n.domHeight,c.z=1+1/c.x,c.w=1+1/c.y,this.uniforms._ScaledScreenParams.value=c}}const r=this.depthTextureUniform;r&&(r.value=n.depthTexture);const l=this.opaqueTextureUniform;if(l&&(l.value=n.opaqueColorTexture),i){const c=this._rendererData;c.updateFrom(i),this.uniforms[this._worldToObjectName].value=c.worldToObject,this.uniforms[this._objToWorldName].value=c.objectToWorld}this.uniformsNeedUpdate=!0}};let xn=Qe;a(xn,"viewProjection",new le),a(xn,"_viewProjectionValues",[]),a(xn,"viewMatrix",new le),a(xn,"_viewMatrixValues",[]),a(xn,"_worldSpaceCameraPosName","_WorldSpaceCameraPos"),a(xn,"_worldSpaceCameraPos",new x),a(xn,"_mainLightColor",new xe),a(xn,"_mainLightPosition",new x),a(xn,"_lightData",new xe);class qA{constructor(t,e){a(this,"parser");a(this,"identifier");this.parser=t,this.identifier=e}get name(){return xl}loadMaterial(t){const e=this.parser.json.materials[t];if(!e)return vs&&console.log(t,this.parser.json.materials),null;if(!e.extensions||!e.extensions[xl])return vs&&console.log(`Material ${t} does not use NEEDLE_techniques_webgl`),null;vs&&console.log(`Material ${t} uses NEEDLE_techniques_webgl`,e);const i=e.extensions[xl].technique;if(i<0)return console.debug(`Material ${t} does not have a valid technique index`),null;const n=this.parser.json.extensions[xl];if(!n)return vs?console.error("Missing shader data",this.parser.json.extensions):console.debug("Missing custom shader data in parser.json.extensions"),null;vs&&console.log(n);const o=n.techniques[i];return o?new Promise(async(r,l)=>{var _,v,S;const c=await fM(n,o.program),h=c==null?void 0:c.fragmentShader,d=c==null?void 0:c.vertexShader;if(!h||!d)return l();vs&&console.log("loadMaterial",e,c);const u={},f=o.uniforms;(d.includes("_Time")||h.includes("_Time"))&&(u._Time={value:new xe(0,0,0,0)}),(d.includes("_SinTime")||h.includes("_SinTime"))&&(u._SinTime={value:new xe(0,0,0,0)}),(d.includes("_CosTime")||h.includes("_CosTime"))&&(u._CosTime={value:new xe(0,0,0,0)}),(d.includes("unity_DeltaTime")||h.includes("unity_DeltaTime"))&&(u.unity_DeltaTime={value:new xe(0,0,0,0)});for(const T in f){const O=T;switch(O){case"_TimeParameters":const M=new xe;u[O]={value:M};break;case"hlslcc_mtx4x4unity_MatrixV":case"hlslcc_mtx4x4unity_MatrixVP":u[O]={value:[]};break;case"_MainLightPosition":case"_MainLightColor":case"_WorldSpaceCameraPos":u[O]={value:[0,0,0,1]};break;case"unity_OrthoParams":break;case"unity_SpecCube0":u[O]={value:null};break;default:case"_ScreenParams":case"_ZBufferParams":case"_ProjectionParams":u[O]={value:[0,0,0,0]};break;case"_CameraOpaqueTexture":case"_CameraDepthTexture":u[O]={value:null};break}}let p=!1;if(e.extensions&&e.extensions[xl]){const T=e.extensions[xl];if(T.technique===i){vs&&console.log(e.name,"Material Properties",T);for(const O in T.values){const M=T.values[O];if(typeof M=="string"){if(M.startsWith("/textures/")){const k=M.substring(10),B=Number.parseInt(k);if(B>=0){const I=await this.parser.getDependency("texture",B);I instanceof Je&&(I.colorSpace=Wa,I.needsUpdate=!0),u[O]={value:I};continue}}switch(O){case"alphaMode":M==="BLEND"&&(p=!0);continue}}if(Array.isArray(M)&&M.length===4){u[O]={value:new xe(M[0],M[1],M[2],M[3])};continue}u[O]={value:M}}}}const g=new xn(this.identifier,{name:e.name??"",uniforms:u,vertexShader:d,fragmentShader:h,lights:!1});switch(g.glslVersion=iR,g.vertexShader=g.vertexShader.replace("#version 300 es",""),g.fragmentShader=g.fragmentShader.replace("#version 300 es",""),(_=u._Cull)==null?void 0:_.value){case Gh.Off:g.side=hn;break;case Gh.Front:g.side=O_;break;case Gh.Back:g.side=Wr;break;default:g.side=Wr;break}switch((v=u._ZTest)==null?void 0:v.value){case uo.Equal:g.depthTest=!0,g.depthFunc=cR;break;case uo.NotEqual:g.depthTest=!0,g.depthFunc=lR;break;case uo.Less:g.depthTest=!0,g.depthFunc=aR;break;case uo.LEqual:g.depthTest=!0,g.depthFunc=rR;break;case uo.Greater:g.depthTest=!0,g.depthFunc=oR;break;case uo.GEqual:g.depthTest=!0,g.depthFunc=sR;break;case uo.Always:g.depthTest=!1,g.depthFunc=nR;break}g.transparent=p,p&&(g.depthWrite=!1),dM(u),g.onUpdateUniforms();for(const T in f){const O=T,M=f[T].type;if(((S=u[O])==null?void 0:S.value)===void 0)switch(M){case e_.SAMPLER_2D:u[O]={value:cM},console.warn("Missing/unassigned texture, fallback to white: "+O);break;default:O==="unity_OrthoParams"||console.warn("TODO: EXPECTED UNIFORM / fallback NOT SET: "+O,f[T]);break}}vs&&console.log(g.uuid,u),e1(g),r(g)}):null}}function e1(s){if(s.uniforms){vs&&console.log("Uniforms:",s.uniforms);for(const e in s.uniforms)switch(t(e,e),e){case"_Color":t("color",e);break}}function t(e,i){Object.getOwnPropertyDescriptor(s,e)||Object.defineProperty(s,e,{get:()=>s.uniforms[i].value,set:n=>{s.uniforms[i].value=n,s.needsUpdate=!0}})}}const XA=C("debugextensions");let Hf;const QA=ts(()=>import("./three-examples.d909655c.js").then(s=>s.u),["./three-examples.d909655c.js","./three@0.169.5.js"],import.meta.url).then(async s=>(Hf=s.GLTFAnimationPointerExtension,Hf)).catch(s=>{console.warn("Failed to import GLTFLoaderAnimationPointer. Please use @needle-tools/three for full KHR_animation support",s)}),Ha=new Array;function zL(s){Ha.includes(s)||Ha.push(s)}function UL(s){const t=Ha.indexOf(s);t>=0&&Ha.splice(t,1)}function mb(s){const t=new ZC;return s.register(e=>(t.parser=e,t)),t}class YA{resolvePath(t){return t.includes("/extensions/builtin_components/")?t.replace("/extensions/builtin_components/","/userData/components/"):t.includes("extensions/builtin_components/")?t.replace("extensions/builtin_components/","/userData/components/"):t}}async function t_(s,t,e){const i=e.indexOf("?");i>=0&&(e=e.substring(0,i)),s.register(n=>new UA(n)),s.register(n=>new wE(n)),s.register(n=>new nM(n,t.lightmaps,e)),s.register(n=>new NA(n,e,t)),s.register(n=>new qA(n,e)),s.register(n=>new Hh(n,e)),s.register(n=>new mt(n,e)),s.register(n=>new jA(n)),Uk()&&s.register(n=>new Fh(n)),await QA.catch(n=>{}),s.register(n=>{if(Hf){const o=new Hf(n);return o.setAnimationPointerResolver.bind(o)(new YA),o}else return(XA||U())&&console.error("Missing KHR_animation_pointer extension..."),{name:"KHR_animation_pointer_NOT_AVAILABLE"}});for(const n of Ha)n.onImport&&n.onImport(s,e,t)}function t1(s,t){for(const e of Ha)e.onExport&&e.onExport(s,t)}function i1(s,t,e){for(const i of Ha)i.onLoaded&&i.onLoaded(s,t,e)}var n1=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const Mu=C("debugreflectionprobe"),ux=C("noreflectionprobe"),KA=Symbol("reflectionProbeKey"),JA=Symbol("original material"),Ps=class extends j{constructor(){var e;super();a(this,"_texture");a(this,"center");a(this,"size");a(this,"_boxHelper");Ps._probes.has(this.context)||Ps._probes.set(this.context,[]),(e=Ps._probes.get(this.context))==null||e.push(this)}static get(e,i,n,o){if(!e||e.isObject3D!==!0||ux)return null;const r=Ps._probes.get(i);if(r){for(const l of r)if(l.__didAwake||l.__internalAwake(),l.enabled&&o&&l.gameObject===o)return l}return Mu&&console.debug("Did not find reflection probe",e.name,n,e),null}set texture(e){if(e&&!(e instanceof Je)){console.error("ReflectionProbe.texture must be a Texture",e);return}this._texture=e,e&&(e.mapping=Mo,e.colorSpace=rs,e.needsUpdate=!0)}get texture(){return this._texture}isInBox(e){var i;return(i=this._boxHelper)==null?void 0:i.isInBox(e)}awake(){this._boxHelper=this.gameObject.addComponent(rn),this._boxHelper.updateBox(!0),Mu&&this._boxHelper.showHelper(5592320,!0),this.texture&&(this.texture.mapping=Mo,this.texture.colorSpace=rs,this.texture.needsUpdate=!0)}onDestroy(){const e=Ps._probes.get(this.context);if(e){const i=e.indexOf(this);i>=0&&e.splice(i,1)}}onSet(e){var n;if(ux||!this.enabled||((n=e.sharedMaterials)==null?void 0:n.length)<=0||!this.texture)return;let i=Ps._rendererMaterialsCache.get(e);i||(i=[],Ps._rendererMaterialsCache.set(e,i));for(let o=0;o<e.sharedMaterials.length;o++){const r=e.sharedMaterials[o];if(!r||r.envMap===void 0||r instanceof Ue)continue;let l=i[o];const c=r===(l==null?void 0:l.copy),h=!l||l.material.uuid!==r.uuid||l.copy.version!==r.version;if(!c&&h){if(Mu){let f="";l?l.material!==r?f="reference changed; cached instance?: "+c:l.copy.version!==r.version&&(f="version changed"):f="not cached",console.warn("Cloning material",r.name,r.version,"Reason:",f,`
`,r.uuid,`
`,l==null?void 0:l.copy.uuid,`
`,e.name)}const u=r.clone();u.version=r.version,l?(l.copy=u,l.material=r):(l={material:r,copy:u},i.push(l)),u[KA]=this,u[JA]=r,Mu&&console.log("Set reflection",e.name,e.guid)}l&&l.copy&&(l.copy.onBeforeCompile=r.onBeforeCompile);const d=l==null?void 0:l.copy;d.envMap=this.texture,e.sharedMaterials[o]=d}}onUnset(e){const i=Ps._rendererMaterialsCache.get(e);if(i)for(let n=0;n<i.length;n++){const o=i[n];e.sharedMaterials[n]=o.material}}};let Oo=Ps;a(Oo,"_probes",new Map),a(Oo,"_rendererMaterialsCache",new Map);n1([m(x)],Oo.prototype,"center",void 0);n1([m(x)],Oo.prototype,"size",void 0);const ji=C("debuginstancing"),up=class{constructor(){a(this,"objs",[])}setup(t,e,i,n,o,r=0){t.applySettings(e);const l=this.tryCreateOrAddInstance(e,i,o);if(l){n===null&&(n=[]),n.push(l),mt.assignTextureLOD(l.renderer.material,0);for(let c=0;c<t.sharedMeshes.length;c++){const h=t.sharedMeshes[c],d=h.geometry;mt.assignMeshLOD(h,0).then(u=>{u&&t.activeAndEnabled&&d!=u&&l.setGeometry(u)})}}else if(r<=0&&e.type!=="Mesh"){const c=r+1;for(const h of e.children)n=this.setup(t,h,i,n,o,c)}return r===0&&o.useMatrixWorldAutoUpdate&&n&&n.length>=0&&this.autoUpdateInstanceMatrix(e),n}tryCreateOrAddInstance(t,e,i){if(t.type==="Mesh"){const n=i.foundMeshes;if(i.foundMeshes+=1,!i.rend.enableInstancing)return null;if(i.rend.enableInstancing!==!0){if(n>=i.rend.enableInstancing.length)return ji&&console.error("Something is wrong with instance setup",t,i.rend.enableInstancing,n),null;if(!i.rend.enableInstancing[n])return null}const o=t,r=o.material;for(const u of this.objs){if(!u.canAdd(o.geometry,r))continue;return u.addInstance(o)}let l=up.getStartInstanceCount(t);(!l||l<0)&&(l=4);let c=t.name;c!=null&&c.length||(c=dO());const h=new s1(c,o.geometry,r,l,e);return this.objs.push(h),h.addInstance(o)}return null}autoUpdateInstanceMatrix(t){const e=t.matrixWorld.multiplyMatrices.bind(t.matrixWorld),i=t.matrixWorld.clone(),n=(o,r)=>{const l=e(o,r);return(t[Rd]||i.equals(l)===!1)&&(i.copy(l),t[Rd]=!0),l};t.matrixWorld.multiplyMatrices=n}};let Or=up;a(Or,"instance",new up),a(Or,"getStartInstanceCount",t=>4);const ud=class{constructor(t,e){a(this,"object");a(this,"renderer");a(this,"__instanceIndex",-1);a(this,"__reservedVertexRange",0);a(this,"__reservedIndexRange",0);a(this,"__geometryIndex",-1);a(this,"meshInformation");this.__instanceIndex=-1,this.object=t,this.renderer=e,t[sC]=e,this.meshInformation=va(t.geometry),ud.all.push(this)}get name(){return this.object.name}get isActive(){return this.__instanceIndex>=0}get vertexCount(){return this.object.geometry.attributes.position.count}get maxVertexCount(){return Math.max(this.meshInformation.vertexCount,this.vertexCount)}get reservedVertexCount(){return this.__reservedVertexRange}get indexCount(){return this.object.geometry.index?this.object.geometry.index.count:0}get maxIndexCount(){return Math.max(this.meshInformation.indexCount,this.indexCount)}get reservedIndexCount(){return this.__reservedIndexRange}updateMeshInformation(){const t=va(this.object.geometry),e=this.meshInformation.vertexCount,i=this.meshInformation.indexCount;return Object.assign(this.meshInformation,t),e!==this.meshInformation.vertexCount||i!==this.meshInformation.indexCount}updateInstanceMatrix(t=!1,e=!0){this.__instanceIndex<0||(e&&this.object.updateWorldMatrix(!0,t),this.renderer.updateInstance(this.object.matrixWorld,this.__instanceIndex))}setMatrix(t){this.__instanceIndex<0||this.renderer.updateInstance(t,this.__instanceIndex)}setGeometry(t){if(this.__geometryIndex<0)return!1;const e=this;if(this.vertexCount>this.__reservedVertexRange)return i(`Instancing: Can not update geometry (${this.name}), reserved vertex range is too small: ${this.__reservedVertexRange.toLocaleString()} < ${this.vertexCount.toLocaleString()} vertices for ${this.name}`);if(this.indexCount>this.__reservedIndexRange)return i(`Instancing: Can not update geometry (${this.name}), reserved index range is too small: ${this.__reservedIndexRange.toLocaleString()} < ${this.indexCount.toLocaleString()} indices for ${this.name}`);return this.renderer.updateGeometry(t,this.__geometryIndex);function i(n){return e.updateMeshInformation()&&(e.renderer.remove(e,!0),e.renderer.add(e))?!0:((U()||ji)&&console.error(n),!1)}}add(){this.__instanceIndex>=0||(this.renderer.add(this),P.markAsInstancedRendered(this.object,!0))}remove(t){if(!(this.__instanceIndex<0)&&(this.renderer.remove(this,t),P.markAsInstancedRendered(this.object,!1),t)){const e=ud.all.indexOf(this);e>=0&&ud.all.splice(e,1)}}};let lc=ud;a(lc,"all",[]);class s1{constructor(t,e,i,n,o){a(this,"allowResize",!0);a(this,"name","");a(this,"geometry");a(this,"material");a(this,"_context");a(this,"_batchedMesh");a(this,"_handles",[]);a(this,"_geometryIds",new Map);a(this,"_maxInstanceCount");a(this,"_currentInstanceCount",0);a(this,"_currentVertexCount",0);a(this,"_currentIndexCount",0);a(this,"_maxVertexCount");a(this,"_maxIndexCount");a(this,"_needUpdateBounds",!1);a(this,"_debugMaterial",null);a(this,"onBeforeRender",()=>{this._batchedMesh.layers.enableAll(),this._needUpdateBounds&&this._batchedMesh[kh]===!0&&(ji==="verbose"&&console.log("Update instancing bounds",this.name,this._batchedMesh.matrixWorldNeedsUpdate),this.updateBounds())});a(this,"onAfterRender",()=>{this._batchedMesh.layers.disableAll()});this.name=t,this.geometry=e,this.material=i,this._context=o,this._maxInstanceCount=Math.max(2,n),ji&&(this._debugMaterial=fx());const r=this.tryEstimateVertexCountSize(this._maxInstanceCount,[e],n);this._maxVertexCount=r.vertexCount,this._maxIndexCount=r.indexCount,this._batchedMesh=new r0(this._maxInstanceCount,this._maxVertexCount,this._maxIndexCount,this._debugMaterial??this.material),this._batchedMesh[kh]=!0,this._batchedMesh.visible=!0,this._context.scene.add(this._batchedMesh),i instanceof pw&&(i.defines.USE_INSTANCING=!0,i.needsUpdate=!0),o.pre_render_callbacks.push(this.onBeforeRender),o.post_render_callbacks.push(this.onAfterRender),ji&&console.log(`Instanced renderer created with ${this._maxInstanceCount} instances, ${this._maxVertexCount} max vertices and ${this._maxIndexCount} max indices for "${t}"`)}get batchedMesh(){return this._batchedMesh}get visible(){return this._batchedMesh.visible}set visible(t){this._batchedMesh.visible=t}get castShadow(){return this._batchedMesh.castShadow}set castShadow(t){this._batchedMesh.castShadow=t}set receiveShadow(t){this._batchedMesh.receiveShadow=t}get count(){return this._currentInstanceCount}updateBounds(t=!0,e=!0){if(this._needUpdateBounds=!1,t&&this._batchedMesh.computeBoundingBox(),e&&this._batchedMesh.computeBoundingSphere(),ji&&this._batchedMesh.boundingSphere){const i=this._batchedMesh.boundingSphere;G.DrawWireSphere(i.center,i.radius,65280)}}canAdd(t,e){return this._maxVertexCount>1e7||e!==this.material||!this.validateGeometry(t)?!1:!!(!this.mustGrow(t)||this.allowResize)}dispose(){ji&&console.warn("Dispose instanced renderer",this.name),this._context.scene.remove(this._batchedMesh),this._batchedMesh.dispose(),this._batchedMesh=null,this._handles=[]}addInstance(t){const e=new lc(t,this);t.castShadow===!0&&this._batchedMesh.castShadow===!1&&(this._batchedMesh.castShadow=!0),t.receiveShadow===!0&&this._batchedMesh.receiveShadow===!1&&(this._batchedMesh.receiveShadow=!0);try{this.add(e)}catch(i){if(console.error(`Failed adding mesh to instancing (object name: "${t.name}", instances: ${this._currentInstanceCount.toLocaleString()}/${this._maxInstanceCount.toLocaleString()}, vertices: ${this._currentVertexCount.toLocaleString()}/${this._maxVertexCount.toLocaleString()}, indices: ${this._currentIndexCount.toLocaleString()}/${this._maxIndexCount.toLocaleString()})
`,i),U()){Dp("Failed instancing mesh. See the browser console for details.");debugger}return null}return e}add(t){const e=t.object.geometry;if(!e||!e.attributes)return console.error("Cannot add object to instancing without geometry",t.name),!1;if(this.mustGrow(e))if(this.allowResize)this.grow(e);else return console.error("Cannot add instance, max count reached",this.name,this.count,this._maxInstanceCount),!1;return t.object.updateWorldMatrix(!0,!0),this.addGeometry(t),this._handles[t.__instanceIndex]=t,this._currentInstanceCount+=1,this.markNeedsUpdate(),this._currentInstanceCount>0&&(this._batchedMesh.visible=!0),!0}remove(t,e){t&&(t.__instanceIndex<0||this._handles[t.__instanceIndex]!=t||this._currentInstanceCount<=0||(this.removeGeometry(t,e),this._handles[t.__instanceIndex]=null,t.__instanceIndex=-1,this._currentInstanceCount>0&&(this._currentInstanceCount-=1),this._currentInstanceCount<=0&&(this._batchedMesh.visible=!1),this.markNeedsUpdate()))}updateInstance(t,e){this._batchedMesh.setMatrixAt(e,t),this.markNeedsUpdate()}updateGeometry(t,e){return this.validateGeometry(t)?(this.mustGrow()&&this.grow(t),ji&&console.debug("[Instancing] UPDATE GEOMETRY at "+e,this._batchedMesh._geometryCount,t.name,va(t),t.attributes.position.count,t.index?t.index.count:0),this._batchedMesh.setGeometryAt(e,t),this._geometryIds.set(t,e),this.markNeedsUpdate(),!0):!1}validateGeometry(t){const e=this.geometry;for(const i in e.attributes)if(i!=="batchId"&&!t.hasAttribute(i))return U()&&console.warn(`BatchedMesh: Added geometry missing "${i}". All geometries must have consistent attributes.`),!1;return!0}markNeedsUpdate(){ji==="verbose"&&console.warn("Marking instanced mesh dirty",this.name),this._needUpdateBounds=!0}mustGrow(t){if(this.count>=this._maxInstanceCount)return!0;if(!t||!t.attributes)return!1;const e=va(t),i=e.vertexCount,n=e.indexCount;return this._currentVertexCount+i>this._maxVertexCount||this._currentIndexCount+n>this._maxIndexCount}grow(t){var h,d;const i=Math.ceil(this._maxInstanceCount*2),n=this.tryEstimateVertexCountSize(i,[t]),o=Math.max(this._maxVertexCount,n.vertexCount),r=Math.max(this._maxIndexCount,n.indexCount,Math.ceil(this._maxVertexCount*2));if(ji){const u=va(t);console.warn(`[Instancing] Growing Buffer
Mesh: "${this.name}${(h=t.name)!=null&&h.length?"/"+t.name:""}"
${u.vertexCount} vertices, ${u.indexCount} indices
Max count ${this._maxInstanceCount} ‚Üí ${i}
Max vertex count ${this._maxVertexCount} -> ${o}
Max index count ${this._maxIndexCount} -> ${r}`),this._debugMaterial=fx()}else U()&&console.debug(`[Instancing] Growing Buffer
Mesh: "${this.name}${(d=t.name)!=null&&d.length?"/"+t.name:""}"
Max count ${this._maxInstanceCount} ‚Üí ${i}
Max vertex count ${this._maxVertexCount} -> ${o}
Max index count ${this._maxIndexCount} -> ${r}`);this._maxVertexCount=o,this._maxIndexCount=r;const l=new r0(i,this._maxVertexCount,this._maxIndexCount,this._debugMaterial??this.material);l.layers=this._batchedMesh.layers,l.castShadow=this._batchedMesh.castShadow,l.receiveShadow=this._batchedMesh.receiveShadow,l.visible=this._batchedMesh.visible,l[kh]=this._batchedMesh[kh],l.matrixAutoUpdate=this._batchedMesh.matrixAutoUpdate,l.matrixWorldNeedsUpdate=this._batchedMesh.matrixWorldNeedsUpdate,l.matrixAutoUpdate=this._batchedMesh.matrixAutoUpdate,l.matrixWorld.copy(this._batchedMesh.matrixWorld),l.matrix.copy(this._batchedMesh.matrix),this._batchedMesh.dispose(),this._batchedMesh.removeFromParent(),this._geometryIds.clear(),this._batchedMesh=l,this._maxInstanceCount=i;const c=[...this._handles];this._handles=[];for(const u of c)u&&u.__instanceIndex>=0&&(this.addGeometry(u),this._handles[u.__instanceIndex]=u);this._context.scene.add(l)}tryEstimateVertexCountSize(t,e,i=1){const n=new Map;for(const u of this._handles)if(u&&u.__instanceIndex>=0&&u.object.geometry)if(n.has(u.object.geometry)){const f=n.get(u.object.geometry);f.count+=1}else{const p={count:1,...va(u.object.geometry)};n.set(u.object.geometry,p)}let o=0,r=0;for(const[u,f]of n)o+=f.vertexCount*f.count,r+=f.indexCount*f.count;let c=Math.ceil(o/Math.max(1,this._currentInstanceCount))*t,d=Math.ceil(r/Math.max(1,this._currentInstanceCount))*t*2;if(e)for(const u of e){const f=va(u);f!=null&&(c+=f.vertexCount*i,d+=f.indexCount*i)}return{vertexCount:c,indexCount:d}}addGeometry(t){const i=t.object.geometry;if(!i)return;let n=this._geometryIds.get(i);n==null?(ji&&console.debug(`[Instancing] > ADD NEW GEOMETRY "${t.name} (${i.name}; ${i.uuid})"
${this._currentInstanceCount} instances, ${t.maxVertexCount} max vertices, ${t.maxIndexCount} max indices`),n=this._batchedMesh.addGeometry(i,t.maxVertexCount,t.maxIndexCount),this._geometryIds.set(i,n)):ji==="verbose"&&console.log(`[Instancing] > ADD INSTANCE "${t.name}"
GEOMETRY_ID=${n}
${this._currentInstanceCount} instances`),this._currentVertexCount+=t.maxVertexCount,this._currentIndexCount+=t.maxIndexCount;const o=this._batchedMesh.addInstance(n);t.__geometryIndex=n,t.__instanceIndex=o,t.__reservedVertexRange=t.maxVertexCount,t.__reservedIndexRange=t.maxIndexCount,this._batchedMesh.setMatrixAt(o,t.object.matrixWorld),ji&&console.debug(`[Instancing] > ADDED INSTANCE "${t.name}"
GEOMETRY_ID=${n}
${this._currentInstanceCount} instances
Index: ${t.__instanceIndex}`)}removeGeometry(t,e){if(t.__instanceIndex<0){console.warn("Cannot remove geometry, instance index is invalid",t.name);return}ji&&console.debug(`[Instancing] < REMOVE INSTANCE "${t.name}" at [${t.__instanceIndex}]
GEOMETRY_ID=${t.__geometryIndex}
${this._currentInstanceCount} instances
Index: ${t.__instanceIndex}`),this._batchedMesh.deleteInstance(t.__instanceIndex)}}a(s1,"nullMatrix",new le);function va(s){var n,o;if(!s)return U()&&console.error("Cannot get mesh information from null geometry"),{vertexCount:0,indexCount:0};let t=((o=(n=s.attributes)==null?void 0:n.position)==null?void 0:o.count)||0,e=s.index?s.index.count:0;const i=mt.getMeshLODInformation(s);if(i){const r=i.lods[0];let l=r.vertexCount,c=r.indexCount;const h=Math.min(200,Math.ceil(l*.05));l+=h,c+=20,t=Math.max(t,l),e=Math.max(e,c)}return t=Math.ceil(t),e=Math.ceil(e),{vertexCount:t,indexCount:e}}function fx(){const s=new Vi({color:new ue(Math.random(),Math.random(),Math.random())});return s.emissive=s.color,s.emissiveIntensity=.3,C("wireframe")&&(s.wireframe=!0),s}const wl=C("debuglightmaps");class Gf{constructor(t,e){a(this,"lightmapIndex",-1);a(this,"lightmapScaleOffset",new xe(1,1,0,0));a(this,"context");a(this,"gameObject");a(this,"lightmapTexture",null);a(this,"lightmapScaleOffsetUniform",{value:new xe(1,1,0,0)});a(this,"lightmapUniform",{value:null});a(this,"onBeforeCompile",(t,e)=>{wl&&console.log(`Lightmaps, before compile
`,t),this.lightmapScaleOffsetUniform.value=this.lightmapScaleOffset,this.lightmapUniform.value=this.lightmapTexture,t.uniforms.lightmapScaleOffset=this.lightmapScaleOffsetUniform});this.gameObject=t,this.context=e}get lightmap(){return this.lightmapTexture}set lightmap(t){t!==this.lightmapTexture&&(this.lightmapTexture=t,this.applyLightmap(),this.lightmapTexture&&mt.assignTextureLOD(this.lightmapTexture,0).then(e=>{e!=null&&e.isTexture&&(this.lightmapTexture=e)}))}init(t,e,i){console.assert(this.gameObject!==void 0&&this.gameObject!==null,"Missing gameobject",this),this.lightmapIndex=t,!(this.lightmapIndex<0)&&(this.lightmapScaleOffset=e,this.lightmapTexture=i,mt.assignTextureLOD(i,0).then(n=>{n!=null&&n.isTexture&&(this.lightmapTexture=n)}),wl=="show"?(console.log("Lightmap:",this.gameObject.name,t,`
ScaleOffset:`,e,`
Texture:`,i),this.setLightmapDebugMaterial()):wl&&console.log("Use debuglightmaps=show to render lightmaps only in the scene."),this.applyLightmap())}updateLightmapUniforms(t){const e=t.uniforms;e&&e.lightmap&&(this.lightmapScaleOffsetUniform.value=this.lightmapScaleOffset,e.lightmapScaleOffset=this.lightmapScaleOffsetUniform)}applyLightmap(){if(this.gameObject.type==="Object3D"){wl&&console.warn("Can not add lightmap. Is this object missing a renderer?",this.gameObject.name);return}if(this.gameObject.type==="Group"){this.gameObject["Needle:Multimaterial-LightmapWarning"]===void 0&&(this.gameObject["Needle:Multimaterial-LightmapWarning"]=!0,console.warn("Lightmap on multimaterial object is not supported yet... please open a feature request on https://github.com/needle-tools/needle-engine-support if your project requires it"));return}console.assert(this.gameObject.type==="Mesh","Lightmap only works on meshes",this);const t=this.gameObject;if(t.geometry.getAttribute("uv1")||t.geometry.setAttribute("uv1",t.geometry.getAttribute("uv")),Array.isArray(this.gameObject.material)){const e=this.gameObject.material;for(let i=0;i<e.length;i++)e[i]=this.ensureLightmapMaterial(e[i])}else this.gameObject.material=this.ensureLightmapMaterial(this.gameObject.material);if(this.lightmapIndex>=0&&this.lightmapTexture){this.lightmapTexture.channel=1;const e=this.gameObject.material;if(Array.isArray(e))for(const i of e)this.assignLightmapTexture(i);else e&&this.assignLightmapTexture(e)}}ensureLightmapMaterial(t){return t.userData||(t.userData={}),t["NEEDLE:lightmap-material-version"]!=t.version&&t["NEEDLE:lightmap-material-version"]==null&&(wl&&console.warn("Cloning material for lightmap "+t.name),t=t.clone(),t.onBeforeCompile=this.onBeforeCompile),t}assignLightmapTexture(t){!t||t instanceof ay&&t.transmission>0||!(t.lightMap!==this.lightmapTexture||t["NEEDLE:lightmap-material-version"]!==t.version)||(wl&&console.log("Assigning lightmap",t.name,t.version),t.lightMap=this.lightmapTexture,t["NEEDLE:lightmap-material-version"]=t.version)}setLightmapDebugMaterial(){this.gameObject.material=new os({vertexShader:`
                varying vec2 vUv1;
                void main()
                {
                    vUv1 = uv1;
                    gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
                }
                `,fragmentShader:`
                uniform sampler2D lightMap;
                uniform float lightMapIntensity;
                uniform vec4 lightmapScaleOffset;
                varying vec2 vUv1;

                // took from threejs 05fc79cd52b79e8c3e8dec1e7dca72c5c39983a4
                vec4 conv_sRGBToLinear( in vec4 value ) {
                    return vec4( mix( pow( value.rgb * 0.9478672986 + vec3( 0.0521327014 ), vec3( 2.4 ) ), value.rgb * 0.0773993808, vec3( lessThanEqual( value.rgb, vec3( 0.04045 ) ) ) ), value.a );
                }

                void main() {
                    vec2 lUv = vUv1.xy * lightmapScaleOffset.xy + vec2(lightmapScaleOffset.z, (1. - (lightmapScaleOffset.y + lightmapScaleOffset.w)));
                    
                    vec4 lightMapTexel = texture2D( lightMap, lUv);
                    gl_FragColor = lightMapTexel;
                    gl_FragColor.a = 1.;
                }
                `,defines:{USE_LIGHTMAP:""}})}}var Yo=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const Eh=C("debugrenderer"),px=C("debugskinnedmesh"),mx=C("noinstancing"),ZA=C("wireframe");var Fl;(function(s){s[s.Off=0]="Off",s[s.BlendProbes=1]="BlendProbes",s[s.BlendProbesAndSkybox=2]="BlendProbesAndSkybox",s[s.Simple=3]="Simple"})(Fl||(Fl={}));class o1{constructor(){a(this,"path",null);a(this,"asset",null);a(this,"default")}}var gx;(function(s){s[s.Both=0]="Both",s[s.Back=1]="Back",s[s.Front=2]="Front"})(gx||(gx={}));class e2{constructor(t,e){a(this,"_renderer");a(this,"_targets",[]);a(this,"_indexMapMaxIndex");a(this,"_indexMap");a(this,"_changed",!1);this._renderer=t;const i=this.setMaterial.bind(this),n=this.getMaterial.bind(this),o=t.gameObject;if(this._targets=[],o)switch(o.type){case"Group":this._targets=[...o.children];break;case"SkinnedMesh":case"Mesh":this._targets.push(o);break}let r=!1,l,c=0;for(let h=0;h<this._targets.length;h++){const d=this._targets[h];if(!d)continue;const u=d.material;if(u){u.shadowSide=u.side;for(let f=0;f<e.length;f++){const p=e[f];if(!p){r=!0;continue}if(u.name===p.name){l===void 0&&(l=new Map),l.set(f,h),c=Math.max(c,f);break}}}}if(r){this._indexMapMaxIndex=c,this._indexMap=l;const h=`Renderer ${t.name} was initialized with missing materials - this may lead to unexpected behaviour when trying to access sharedMaterials by index.`;console.warn(h),qi()&&Me("Found renderer with missing materials: please check the console for details.")}return new Proxy(this,{get(h,d){if(typeof d=="string"){const u=parseInt(d);if(!isNaN(u))return n(u)}return h[d]},set(h,d,u){return typeof d=="string"&&i(u,Number.parseInt(d)),Reflect.set(h,d,u)?(u instanceof De&&(h.changed=!0),!0):!1}})}get changed(){return this._changed}set changed(t){t===!0&&Eh&&console.warn("SharedMaterials have changed: "+this._renderer.name,this),this._changed=t}is(t){return this._renderer===t}get length(){return this._indexMapMaxIndex!==void 0?this._indexMapMaxIndex+1:this._targets.length}*[Symbol.iterator](){for(let t=0;t<this.length;t++)yield this.getMaterial(t)}resolveIndex(t){const e=this._indexMap;return e&&e.has(t)?e.get(t):t}setMaterial(t,e){if(e=this.resolveIndex(e),e<0||e>=this._targets.length)return;const i=this._targets[e];!i||i.material===void 0||(i.material=t,this.changed=!0)}getMaterial(t){if(t=this.resolveIndex(t),t<0)return null;const e=this._targets;if(t>=e.length)return null;const i=e[t];return i?i.material:null}}class Ve extends j{constructor(){super(...arguments);a(this,"receiveShadows",!1);a(this,"shadowCastingMode",qf.Off);a(this,"lightmapIndex",-1);a(this,"lightmapScaleOffset",new xe(1,1,0,0));a(this,"enableInstancing");a(this,"renderOrder");a(this,"allowOcclusionWhenDynamic",!0);a(this,"probeAnchor");a(this,"reflectionProbeUsage",Fl.Off);a(this,"_lightmaps");a(this,"_sharedMeshes",[]);a(this,"_sharedMaterials");a(this,"_originalMaterials");a(this,"_probeAnchorLastFrame");a(this,"_lightmapTextureOverride");a(this,"allowProgressiveLoading",!0);a(this,"_firstFrame",-1);a(this,"_isInstancingEnabled",!1);a(this,"_handles");a(this,"_handlesTempArray",[]);a(this,"onBeforeRenderThree",(e,i,n,o,r,l)=>{var c;if(r.envMapIntensity!==void 0){const h=this.hasLightmap?Math.PI:1,d=((c=this.context.mainCameraComponent)==null?void 0:c.environmentIntensity)??1;r.envMapIntensity=Math.max(0,d*this.context.sceneLighting.environmentIntensity/h),r.envMap||(r.envMap=this.context.scene.environment)}if(this._lightmaps)for(const h of this._lightmaps)h.updateLightmapUniforms(r),h.applyLightmap()});a(this,"_reflectionProbe",null)}static setInstanced(e,i){const n=Up(e,Ve);return n.setInstancingEnabled(i),n}static isInstanced(e){const i=Ac(e,Ve);return i?i.isInstancingActive:is.isUsingInstancing(e)}static setVisible(e,i){vo(e,i)}get sharedMesh(){if(this.gameObject.type==="Mesh")return this.gameObject;if(this.gameObject.type==="SkinnesMesh")return this.gameObject;if(this.gameObject.type==="Group")return this.gameObject.children[0]}get sharedMeshes(){if(this.destroyed||!this.gameObject)return this._sharedMeshes;if(this._sharedMeshes.length=0,this.gameObject.type==="Group")for(const e of this.gameObject.children)(e.type==="Mesh"||e.type==="SkinnedMesh")&&this._sharedMeshes.push(e);else(this.gameObject.type==="Mesh"||this.gameObject.type==="SkinnedMesh")&&this._sharedMeshes.push(this.gameObject);return this._sharedMeshes}get sharedMaterial(){return this.sharedMaterials[0]}set sharedMaterial(e){this.sharedMaterials[0]!==e&&(this.sharedMaterials[0]=e,this.applyLightmapping())}get material(){return this.sharedMaterials[0]}set material(e){this.sharedMaterial=e}set sharedMaterials(e){if(!this._originalMaterials)this._originalMaterials=e;else if(e){let i=!1;for(let n=0;n<this._sharedMaterials.length;n++){const o=n<e.length?e[n]:null;o&&o instanceof De?this.sharedMaterials[n]=o:i||(i=!0,console.warn("Can not assign null as material: "+this.name,o))}}}get sharedMaterials(){return(!this._sharedMaterials||!this._sharedMaterials.is(this))&&(this._originalMaterials||(this._originalMaterials=[]),this._sharedMaterials=new e2(this,this._originalMaterials)),this._sharedMaterials}static get shouldSuppressInstancing(){return mx}get lightmap(){var e;return(e=this._lightmaps)!=null&&e.length?this._lightmaps[0].lightmap:null}set lightmap(e){var i;if(this._lightmapTextureOverride=e,e===void 0&&(e=this.context.lightmaps.tryGetLightmap(this.sourceId,this.lightmapIndex)),(i=this._lightmaps)!=null&&i.length)for(const n of this._lightmaps)n.lightmap=e}get hasLightmap(){const e=this.lightmap;return e!=null}registering(){this.enabled||this.setVisibility(!1)}awake(){if(this._firstFrame=this.context.time.frame,Eh&&console.log("Renderer ",this.name,this),this.clearInstancingState(),this.probeAnchor&&Eh&&this.probeAnchor.add(new ln(.2)),this._reflectionProbe=null,this.isMultiMaterialObject(this.gameObject)){for(const e of this.gameObject.children)this.context.addBeforeRenderListener(e,this.onBeforeRenderThree),e.layers.mask=this.gameObject.layers.mask;if(this.renderOrder!==void 0){let e=0;for(let i=0;i<this.gameObject.children.length;i++){const n=this.gameObject.children[i];if(!(!this.isMeshOrSkinnedMesh(n)||P.getComponent(n,Ve))){if(this.renderOrder.length<=e){console.warn("Incorrect renderOrder element count",this,this.renderOrder.length+" but expected "+this.gameObject.children.length,"Index: "+e,"ChildElement:",n);continue}n.renderOrder=this.renderOrder[e],e+=1}}}}else this.isMeshOrSkinnedMesh(this.gameObject)?(this.context.addBeforeRenderListener(this.gameObject,this.onBeforeRenderThree),this.renderOrder!==void 0&&this.renderOrder.length>0&&(this.gameObject.renderOrder=this.renderOrder[0])):this.context.addBeforeRenderListener(this.gameObject,this.onBeforeRenderThree);if(this.applyLightmapping(),ZA)for(let e=0;e<this.sharedMaterials.length;e++){const i=this.sharedMaterials[e];i&&(i.wireframe=!0)}}applyLightmapping(){var e;if(this.lightmapIndex>=0){const i=this.gameObject.type,n=this._lightmapTextureOverride!==void 0?this._lightmapTextureOverride:this.context.lightmaps.tryGetLightmap(this.sourceId,this.lightmapIndex);if(n){if(this._lightmaps||(this._lightmaps=[]),i==="Mesh"){const o=this.gameObject.material;if(o!=null&&o.isMeshBasicMaterial)o&&console.warn("Lightmapping is not supported on MeshBasicMaterial",o.name);else{if(this._lightmaps.length<=0){const l=new Gf(this.gameObject,this.context);this._lightmaps.push(l)}this._lightmaps[0].init(this.lightmapIndex,this.lightmapScaleOffset,n)}}else if(this.isMultiMaterialObject(this.gameObject)&&this.sharedMaterials.length>0)for(let o=0;o<this.gameObject.children.length;o++){const r=this.gameObject.children[o];if(!((e=r.material)!=null&&e.isMeshBasicMaterial)){let l;o>=this._lightmaps.length?(l=new Gf(r,this.context),this._lightmaps.push(l)):l=this._lightmaps[o],l.init(this.lightmapIndex,this.lightmapScaleOffset,n)}}}else Eh&&console.warn("Lightmap not found",this.sourceId,this.lightmapIndex)}}get isInstancingActive(){return this._handles!=null&&this._handles.length>0&&this._isInstancingEnabled}get instances(){if(!this._handles||this._handles.length<=0)return null;if(this._handlesTempArray.length=0,this._handles)for(const e of this._handles)this._handlesTempArray.push(e);return this._handlesTempArray}setInstancingEnabled(e){if(this._isInstancingEnabled===e)return e&&(this._handles===void 0||this._handles!=null&&this._handles.length>0);if(this._isInstancingEnabled=e,e){if(this.enableInstancing===void 0&&(this.enableInstancing=!0),this._handles===void 0){if(this._handles=Or.instance.setup(this,this.gameObject,this.context,null,{rend:this,foundMeshes:0,useMatrixWorldAutoUpdate:this.useInstanceMatrixWorldAutoUpdate()}),this._handles)return P.markAsInstancedRendered(this.gameObject,!0),!0}else if(this._handles!==null){for(const i of this._handles)i.updateInstanceMatrix(!0),i.add();return P.markAsInstancedRendered(this.gameObject,!0),!0}}else{if(this._handles)for(const i of this._handles)i.remove(this.destroyed);return!0}return!1}clearInstancingState(){this._isInstancingEnabled=!1,this._handles=void 0}useInstanceMatrixWorldAutoUpdate(){return!0}start(){if(this.enableInstancing&&!mx&&(this.setInstancingEnabled(!0),is.markDirty(this.gameObject)),this.gameObject.frustumCulled=this.allowOcclusionWhenDynamic,this.isMultiMaterialObject(this.gameObject))for(let e=0;e<this.gameObject.children.length;e++){const i=this.gameObject.children[e];i.frustumCulled=this.allowOcclusionWhenDynamic}}onEnable(){this.sharedMeshes,this.setVisibility(!0),this._isInstancingEnabled||this.enableInstancing==!0||Array.isArray(this.enableInstancing)&&this.enableInstancing.some(i=>i)?this.__internalDidAwakeAndStart&&this.setInstancingEnabled(!0):this.enabled&&this.applyStencil(),this.updateReflectionProbe()}onDisable(){this.setVisibility(!1),this._handles&&this._handles.length>0&&this.setInstancingEnabled(!1)}onDestroy(){if(this._handles=null,this.isMultiMaterialObject(this.gameObject))for(const e of this.gameObject.children)this.context.removeBeforeRenderListener(e,this.onBeforeRenderThree);else this.context.removeBeforeRenderListener(this.gameObject,this.onBeforeRenderThree)}onBeforeRender(){var e,i,n;if(this.gameObject){if(this._probeAnchorLastFrame!==this.probeAnchor&&((e=this._reflectionProbe)==null||e.onUnset(this),this.updateReflectionProbe()),Eh==this.name&&this.gameObject instanceof Z){this.gameObject.geometry.computeBoundingSphere();const o=Q(this.gameObject.geometry.boundingSphere.center).applyMatrix4(this.gameObject.matrixWorld);G.DrawWireSphere(o,this.gameObject.geometry.boundingSphere.radius,56831)}if(this.isMultiMaterialObject(this.gameObject)&&((i=this.gameObject.children)==null?void 0:i.length)>0)for(const o of this.gameObject.children)this.applySettings(o);else this.applySettings(this.gameObject);if(this.sharedMaterials.changed&&(this.sharedMaterials.changed=!1,this.applyLightmapping()),(n=this._handles)!=null&&n.length&&this.gameObject[Rd]===!0){this.gameObject[Rd]=!1;for(let r=this._handles.length-1;r>=0;r--)this._handles[r].updateInstanceMatrix();this.gameObject.matrixWorldNeedsUpdate=!1}if(this._handles&&this._handles.length<=0&&P.markAsInstancedRendered(this.gameObject,!1),this._isInstancingEnabled&&this._handles)for(let o=0;o<this._handles.length;o++){const r=this._handles[o];vo(r.object,!1)}this.reflectionProbeUsage!==Fl.Off&&this._reflectionProbe&&this._reflectionProbe.onSet(this)}}onAfterRender(){if(this._isInstancingEnabled&&this._handles)for(let e=0;e<this._handles.length;e++){const i=this._handles[e];vo(i.object,!0)}this.reflectionProbeUsage!==Fl.Off&&this._reflectionProbe&&this._reflectionProbe.onUnset(this),this.static&&this.gameObject.matrixAutoUpdate&&(this.gameObject.matrixAutoUpdate=!1)}applyStencil(){Hh.applyStencil(this)}applySettings(e){e.receiveShadow=this.receiveShadows,this.shadowCastingMode==qf.On?e.castShadow=!0:e.castShadow=!1}updateReflectionProbe(){this._reflectionProbe=null,this.reflectionProbeUsage!==Fl.Off&&(this.startCoroutine(this._updateReflectionProbe(),oe.LateUpdate),this._probeAnchorLastFrame=this.probeAnchor)}*_updateReflectionProbe(){const e=this.probeAnchor||this.gameObject,i=!!this.probeAnchor;this._reflectionProbe=Oo.get(e,this.context,i,this.probeAnchor)}setVisibility(e){if(!this.isMultiMaterialObject(this.gameObject))vo(this.gameObject,e);else for(const i of this.gameObject.children)this.isMeshOrSkinnedMesh(i)&&vo(i,e)}isMultiMaterialObject(e){return e.type==="Group"}isMeshOrSkinnedMesh(e){return e.type==="Mesh"||e.type==="SkinnedMesh"}}Yo([m()],Ve.prototype,"receiveShadows",void 0);Yo([m()],Ve.prototype,"shadowCastingMode",void 0);Yo([m()],Ve.prototype,"lightmapIndex",void 0);Yo([m(xe)],Ve.prototype,"lightmapScaleOffset",void 0);Yo([m()],Ve.prototype,"enableInstancing",void 0);Yo([m()],Ve.prototype,"renderOrder",void 0);Yo([m()],Ve.prototype,"allowOcclusionWhenDynamic",void 0);Yo([m(F)],Ve.prototype,"probeAnchor",void 0);Yo([m()],Ve.prototype,"reflectionProbeUsage",void 0);class Jp extends Ve{}class r1 extends Jp{constructor(){super(...arguments);a(this,"_needUpdateBoundingSphere",!1)}awake(){var e;super.awake(),px&&console.log('SkinnedMeshRenderer for "'+this.name+'"',this),this.allowOcclusionWhenDynamic=!1;for(const i of this.sharedMeshes)(e=i.parent)==null||e.updateWorldMatrix(!1,!0),this.markBoundsDirty()}onAfterRender(){if(super.onAfterRender(),this._needUpdateBoundingSphere){for(const e of this.sharedMeshes)if(e instanceof Eo){this._needUpdateBoundingSphere=!1;try{const i=e.geometry,n=Pw(e);n&&(e.geometry=n),e.computeBoundingSphere(),e.geometry=i}catch(i){console.error(`Error updating bounding sphere for ${e.name}`,i)}}}if(px){for(const e of this.sharedMeshes)if(e instanceof Eo&&e.boundingSphere){const i=Q(e.boundingSphere.center).applyMatrix4(e.matrixWorld);G.DrawWireSphere(i,e.boundingSphere.radius,"red")}}}markBoundsDirty(){this._needUpdateBoundingSphere=!0}}var qf;(function(s){s[s.Off=0]="Off",s[s.On=1]="On",s[s.TwoSided=2]="TwoSided",s[s.ShadowsOnly=3]="ShadowsOnly"})(qf||(qf={}));var a1=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const Au=C("debuggltfexport");class l1 extends rn{constructor(){super(...arguments);a(this,"sceneRoot")}}class Ls extends j{constructor(){super(...arguments);a(this,"binary",!0);a(this,"objects",[]);a(this,"ext")}async exportNow(e,i){Au&&console.log("Exporting objects as glTF",this.objects),e||(e="scene"),(!this.objects||this.objects.length<=0)&&(this.objects=[this.context.scene]);const n={binary:this.binary,pivot:Ls.calculateCenter(this.objects),...i},o=await this.export(this.objects,n).catch(r=>(console.error(r),!1));return o===!1?!1:(this.binary?e.endsWith(".glb")||(e+=".glb"):e.endsWith(".gltf")||(e+=".gltf"),this.binary?Ls.saveArrayBuffer(o,e):Ls.saveJson(o,e),!0)}async export(e,i){if(!e||e.length<=0){console.warn("No objects set to export");return}const n=new ww;n.register(d=>new mw(d)),n.register(d=>new JC(d)),t1(n,this.context),Ls.filterTopmostParent(e);const o={trs:!1,onlyVisible:!0,truncateDrawRange:!1,binary:!0,maxTextureSize:1/0,embedImages:!0,includeCustomExtensions:!0,animations:(i==null?void 0:i.animations)||Ls.collectAnimations(e),...i},r=new Array,l=new F;i!=null&&i.pivot&&l.position.sub(i.pivot),Au&&console.log("EXPORT",e),e.forEach(d=>{d&&Jy(d)&&(l.children.push(d),d.matrixAutoUpdate=!1,d.matrix.copy(d.matrixWorld),P.getComponentsInChildren(d,Ve).forEach(u=>{P.isActiveInHierarchy(u.gameObject)&&u.setInstancingEnabled(!1)}),d.traverse(u=>{if(!Jy(u)){const f=u.parent;u.removeFromParent(),r.push(()=>{f&&f.add(u)})}}))});const c=new fC(l);return i!=null&&i.needleComponents&&(this.ext=new ZC),this.ext&&(this.ext.registerExport(n),this.ext.context=c),new Promise((d,u)=>{Au&&console.log("Starting glTF export.");try{n==null||n.parse(l,f=>{h(),d(f)},f=>{h(),u(f)},o)}catch(f){console.error(f),u(f)}finally{r.forEach(f=>f()),Au&&console.log("Finished glTF export.")}});function h(){e.forEach(d=>{d&&(d.matrixAutoUpdate=!0,P.getComponentsInChildren(d,Ve).forEach(u=>{P.isActiveInHierarchy(u.gameObject)&&u.setInstancingEnabled(!1)}))})}}static saveArrayBuffer(e,i){this.save(new Blob([e],{type:"application/octet-stream"}),i)}static saveJson(e,i){this.save("data: text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(e)),i)}static save(e,i){const n=document.createElement("a");n.style.display="none",document.body.appendChild(n),typeof e=="string"?n.href=e:n.href=URL.createObjectURL(e),n.download=i,n.click(),n.remove()}static collectAnimations(e,i){i=i||[];for(const n of e)n&&n.traverseVisible(o=>{o.animations&&o.animations.length>0&&i.push(...o.animations)});return i}static calculateCenter(e,i){const n=i||new x;return n.set(0,0,0),e.forEach(o=>{n.add(ae(o))}),n.divideScalar(e.length),n}static filterTopmostParent(e){if(!(e.length<=0))for(let i=0;i<e.length;i++){let n=e[i];if(!n){e.splice(i,1),i--;continue}for(;n.parent;){if(e.includes(n.parent)){e.splice(i,1),i--;break}n=n.parent}}}}a1([m()],Ls.prototype,"binary",void 0);a1([m(F)],Ls.prototype,"objects",void 0);typeof globalThis!==void 0&&!("OffscreenCanvas"in globalThis)&&(globalThis.OffscreenCanvas=class{constructor(t,e){a(this,"canvas");return this.canvas=document.createElement("canvas"),this.canvas.width=t,this.canvas.height=e,this.canvas.convertToBlob=(i,n)=>new Promise(o=>{this.canvas.toBlob(o,i,n)}),this.canvas}});const t2=C("debugprogress");function i2(s){s=s||new Date;const t=s.getMonth()+1,e=s.getDate(),i=s.getHours(),n=s.getMinutes(),o=s.getSeconds(),r=(t<10?"0":"")+t,l=(e<10?"0":"")+e,c=(i<10?"0":"")+i,h=(n<10?"0":"")+n,d=(o<10?"0":"")+o;return s.getFullYear()+r+l+"-"+c+h+d}class ge{static start(t,e){typeof e=="string"&&(e={parentScope:e});const i=new n2(t,e);Mh.set(t,i)}static report(t,e){const i=Mh.get(t);if(!i){console.warn("Reporting progress for non-existing scope",t);return}typeof e=="string"&&(e={message:e,autoStep:!0}),i.report(e)}static end(t){const e=Mh.get(t);e&&(e.end(),Mh.delete(t))}}const Mh=new Map;class n2{constructor(t,e){a(this,"scopeLabel");a(this,"parentScope");a(this,"childScopes",[]);a(this,"parentDepth",0);a(this,"lastStep",0);a(this,"lastAutoStepWeight",1);a(this,"lastTotalSteps",0);a(this,"onProgress");a(this,"showLogs",!1);a(this,"selfProgress",0);a(this,"totalProgress",0);a(this,"selfReports",0);a(this,"totalReports",0);this.parentScope=e!=null&&e.parentScope?Mh.get(e.parentScope):void 0,this.parentScope&&(this.parentScope.childScopes.push(this),this.parentDepth=this.parentScope.parentDepth+1),this.scopeLabel=" ".repeat(this.parentDepth*2)+t,this.showLogs=(e==null?void 0:e.logTimings)??!!t2,this.showLogs&&console.time(this.scopeLabel),this.onProgress=e==null?void 0:e.onProgress}report(t,e=!1){if(t){if(t.totalSteps!==void 0&&(this.lastTotalSteps=t.totalSteps),t.currentStep!==void 0&&(this.lastStep=t.currentStep),t.autoStep!==void 0){if(t.currentStep===void 0){this.lastStep===void 0&&(this.lastStep=0);const n=typeof t.autoStep=="number"?t.autoStep:1;this.lastStep+=this.lastAutoStepWeight,this.lastAutoStepWeight=n,t.currentStep=this.lastStep}t.totalSteps=this.lastTotalSteps}t.progress!==void 0?this.selfProgress=t.progress:t.currentStep!==void 0&&t.totalSteps!==void 0&&(this.selfProgress=t.currentStep/t.totalSteps)}if(this.childScopes.length>0){let n=0,o=0;for(const l of this.childScopes)n+=l.selfProgress,o+=1;o>0&&(n/=o);const r=this.lastAutoStepWeight/(this.lastTotalSteps??1);this.totalProgress=this.selfProgress+n*r}else this.totalProgress=this.selfProgress;this.selfProgress=Math.min(1,this.selfProgress),this.totalProgress=Math.min(1,this.totalProgress);let i=(this.totalProgress*100).toFixed(3)+"%";this.childScopes.length>0&&(i+=" ("+(this.selfProgress*100).toFixed(3)+"% self)"),t!=null&&t.message&&(i=t.message+" ‚Äì "+i),this.lastStep!==void 0&&this.lastTotalSteps!==void 0&&(i="Step "+(this.lastStep+(this.lastAutoStepWeight!=1?"‚Äì"+(this.lastStep+this.lastAutoStepWeight):"")+"/"+this.lastTotalSteps)+" "+i),e?this.totalReports++:(this.selfReports++,this.totalReports++),this.showLogs&&console.timeLog(this.scopeLabel,i),this.onProgress&&this.onProgress(this.totalProgress),this.parentScope&&this.parentScope.report(void 0,!0)}end(){this.report({progress:1,autoStep:!0},!0),this.showLogs&&(console.timeLog(this.scopeLabel,"Total reports: "+this.totalReports,"Self reports: "+this.selfReports),console.timeEnd(this.scopeLabel));let t=!1;for(const e of this.childScopes)if(!(e.selfProgress>=1)){t=!0;break}t&&console.warn("Progress end with child scopes that are still running",this),this.onProgress=void 0}}function Qs(s){return s=s.replace(/[^a-zA-Z0-9_]/g,""),s.match(/^[a-zA-Z_]/)||(s="_"+s),s}function c1(s){return s=s.replace('"','\\"'),s}function h1(s){if(s.length===0)return null;const t=s.map(i=>{const n=new Array;for(;i.parent;)n.unshift(i.parent),i=i.parent;return n});return t[0].findLast(i=>t.every(n=>n.includes(i)))||null}function d1(s){const t=h1(s),e=new Set;for(const i of s){let n=i.parent;for(;n&&n!==t;)s.includes(n)||e.add(n),n=n.parent}return e}const s2=new x,o2=new H,r2=new x(1,1,1),Ca=class{constructor(t,e,i=null,n=null,o=null,r=null,l=null,c=null){a(this,"uuid");a(this,"name");a(this,"type");a(this,"extraSchemas",[]);a(this,"displayName");a(this,"visibility");a(this,"transform",null);a(this,"_isDynamic");a(this,"geometry");a(this,"material");a(this,"camera");a(this,"parent");a(this,"skinnedMesh");a(this,"children",[]);a(this,"animations");a(this,"_eventListeners");a(this,"needsTranslate",!1);a(this,"needsOrient",!1);a(this,"needsScale",!1);var h,d,u;this.uuid=t,this.name=Qs(e),this.displayName=e,i?this.transform={position:((h=i.position)==null?void 0:h.clone())||null,quaternion:((d=i.quaternion)==null?void 0:d.clone())||null,scale:((u=i.scale)==null?void 0:u.clone())||null}:this.transform=null,this.geometry=n,this.material=o,this.camera=r,this.parent=null,this.children=[],this._eventListeners={},this._isDynamic=!1,this.skinnedMesh=l,this.animations=c}getMatrix(){if(!this.transform)return new le;const{position:t,quaternion:e,scale:i}=this.transform,n=new le;return n.compose(t||s2,e||o2,i||r2),n}setMatrix(t){if(!t||!(t instanceof le)){this.transform=null;return}const e=new x,i=new H,n=new x;t.decompose(e,i,n),this.transform={position:e,quaternion:i,scale:n}}get matrix(){return this.getMatrix()}set matrix(t){this.setMatrix(t)}get isDynamic(){return this._isDynamic}set isDynamic(t){this._isDynamic=t}static createEmptyParent(t){const e=new Ca(To.generateUUID(),t.name+"_empty_"+Ca.USDObject_export_id++,t.transform),i=t.parent;return i&&i.add(e),e.add(t),e.isDynamic=!0,t.transform=null,e}static createEmpty(){const t=new Ca(To.generateUUID(),"Empty_"+Ca.USDObject_export_id++);return t.isDynamic=!0,t}is(t){return t?this.uuid===t.uuid:!1}isEmpty(){return!this.geometry}clone(){const t=new Ca(To.generateUUID(),this.name,this.transform,this.geometry,this.material);return t.isDynamic=this.isDynamic,t}deepClone(){const t=this.clone();for(const e of this.children)e&&t.add(e.deepClone());return t}getPath(){let t=this.parent,e=this.name;for(;t;)e=(t.parent?t.name:t.name+"/Scenes/Scene")+"/"+e,t=t.parent;return"</"+e+">"}add(t){t.parent&&t.parent.remove(t),t.parent=this,this.children.push(t)}remove(t){const e=this.children.indexOf(t);e>=0&&(t.parent===this&&(t.parent=null),this.children.splice(e,1))}addEventListener(t,e){this._eventListeners[t]||(this._eventListeners[t]=[]),this._eventListeners[t].push(e)}removeEventListener(t,e){if(!this._eventListeners[t])return;const i=this._eventListeners[t].indexOf(e);i>=0&&this._eventListeners[t].splice(i,1)}onSerialize(t,e){const i=this._eventListeners.serialize;i&&i.forEach(n=>n(t,e))}};let hi=Ca;a(hi,"USDObject_export_id",0);class u1 extends hi{constructor(){super(void 0,"StageRoot",null,null,null,null);a(this,"stageLength");this.children=[],this.stageLength=200}get isDocumentRoot(){return!0}get isDynamic(){return!1}add(e){e.parent=this,this.children.push(e)}remove(e){const i=this.children.indexOf(e);i>=0&&(e.parent===this&&(e.parent=null),this.children.splice(i,1))}traverse(e,i=null){if(i!==null?e(i):i=this,i.children)for(const n of i.children)this.traverse(e,n)}findById(e){let i=!1;function n(o){if(!i){if(o.uuid===e)return i=!0,o;if(o.children)for(const r of o.children){if(!r)continue;const l=n(r);if(l)return l}}}return n(this)}buildHeader(e){var u,f,p;const i=(u=e.extensions)==null?void 0:u.find(g=>(g==null?void 0:g.extensionName)==="animation"),n=(f=e.extensions)==null?void 0:f.find(g=>(g==null?void 0:g.extensionName)==="Behaviour"),o=(p=e.extensions)==null?void 0:p.find(g=>(g==null?void 0:g.extensionName)==="Physics"),r=(i==null?void 0:i.getStartTimeCode())??0,l=(i==null?void 0:i.getEndTimeCode())??0;let c="";const h=i==null?void 0:i.registeredClips;if(h)for(const g of h)c+=`	# Animation: ${g.name}, start=${i.getStartTimeByClip(g)*60}, length=${g.duration*60}
`;const d=c;return`#usda 1.0
(
	customLayerData = {
		string creator = "Needle Engine ${$s}"
		dictionary Needle = {
			bool animations = ${i?1:0}
			bool interactive = ${n?1:0}
			bool physics = ${o?1:0}
			bool quickLookCompatible = ${e.quickLookCompatible?1:0}
		}
	}
	defaultPrim = "${Qs(this.name)}"
	metersPerUnit = 1
	upAxis = "Y"
	startTimeCode = ${r}
	endTimeCode = ${l}
	timeCodesPerSecond = 60
	framesPerSecond = 60
	doc = """Generated by Needle Engine USDZ Exporter ${$s}"""
${d}
)
`}}const Sl=`
`,xi="</StageRoot/Materials";class a2{constructor(){a(this,"str");a(this,"indent");this.str="",this.indent=0}clear(){this.str="",this.indent=0}beginBlock(t=void 0,e="{",i=!0){t!==void 0?(t=this.applyIndent(t),this.str+=t,i?(this.str+=Sl,this.str+=this.applyIndent(e)):this.str+=" "+e):this.str+=this.applyIndent(e),this.str+=Sl,this.indent+=1}closeBlock(t="}"){this.indent-=1,this.str+=this.applyIndent(t)+Sl}beginArray(t){t=this.applyIndent(t+" = ["),this.str+=t,this.str+=Sl,this.indent+=1}closeArray(){this.indent-=1,this.str+=this.applyIndent("]")+Sl}appendLine(t=""){t=this.applyIndent(t),this.str+=t,this.str+=Sl}toString(){return this.str}applyIndent(t){let e="";for(let i=0;i<this.indent;i++)e+="	";return e+t}}class l2{constructor(t,e,i){a(this,"root");a(this,"exporter");a(this,"extensions",[]);a(this,"quickLookCompatible");a(this,"exportInvisible");a(this,"materials");a(this,"textures");a(this,"files");a(this,"document");a(this,"output");a(this,"animations");this.root=t,this.exporter=e,this.quickLookCompatible=i.quickLookCompatible,this.exportInvisible=i.exportInvisible,i.extensions&&(this.extensions=i.extensions),this.materials=new Map,this.textures={},this.files={},this.document=new u1,this.output="",this.animations=[]}}class kg{constructor(){a(this,"ar",{anchoring:{type:"plane"},planeAnchoring:{alignment:"horizontal"}});a(this,"quickLookCompatible",!1);a(this,"extensions",[]);a(this,"maxTextureSize",4096);a(this,"exportInvisible",!1)}}let c2=class{constructor(){a(this,"debug");a(this,"pruneUnusedNodes");a(this,"sceneAnchoringOptions",new kg);a(this,"extensions",[]);a(this,"keepObject");a(this,"beforeWritingDocument");this.debug=!1,this.pruneUnusedNodes=!0}async parse(t,e=new kg){var v,S;e=Object.assign(new kg,e),this.sceneAnchoringOptions=e;const i=new l2(t,this,e);this.extensions=i.extensions;const n=i.files,o="model.usda";n[o]=null;const r=i.materials,l=i.textures;ge.report("export-usdz","Invoking onBeforeBuildDocument"),await uf(i,"onBeforeBuildDocument"),ge.report("export-usdz","Done onBeforeBuildDocument"),ge.report("export-usdz","Reparent bones to common ancestor");const c=[],h=new Set;t==null||t.traverse(T=>{if(!(!e.exportInvisible&&!T.visible)&&T instanceof Eo){const O=T.skeleton.bones,M=h1(O);if(M){const k={object:T,originalParent:T.parent,newParent:M};c.push(k),h.add(k.object.uuid),k.newParent&&h.add(k.newParent.uuid),k.originalParent&&h.add(k.originalParent.uuid)}}});for(const T of c){const{object:O,originalParent:M,newParent:k}=T;k.add(O)}ge.report("export-usdz","Traversing hierarchy"),t&&f1(t,i.document,i,this.keepObject),ge.report("export-usdz","Invoking onAfterBuildDocument"),await uf(i,"onAfterBuildDocument");const d=i.extensions.find(T=>T.extensionName==="Behaviour"),u=(d==null?void 0:d.getAllTargetUuids())??new Set;if(this.pruneUnusedNodes){const T={allBehaviorTargets:u,debug:!1,boneReparentings:h,quickLookCompatible:i.quickLookCompatible};this.debug&&yx(i.document,"Hierarchy BEFORE pruning",T),p1(i.document,T),this.debug&&yx(i.document,"Hierarchy AFTER pruning")}else this.debug&&console.log("Pruning of empty nodes is disabled. This may result in a larger USDZ file.");ge.report("export-usdz",{message:"Parsing document",autoStep:10}),await h2(i,()=>(ge.report("export-usdz","Building materials"),v2(r,l,e.quickLookCompatible))),ge.report("export-usdz","Invoking onAfterSerialize"),await uf(i,"onAfterSerialize");for(const T of c){const{object:O,originalParent:M,newParent:k}=T;M&&M.add(O)}(S=(v=i.exporter)==null?void 0:v.beforeWritingDocument)==null||S.call(v);const p=i.document.buildHeader(i)+`
`+i.output;this.debug&&console.log(p),n[o]=Sw(p),i.output="",ge.report("export-usdz",{message:"Exporting textures",autoStep:10}),ge.start("export-usdz-textures",{parentScope:"export-usdz",logTimings:!1});const g=new Qa({antialias:!1,alpha:!0,premultipliedAlpha:!1,preserveDrawingBuffer:!0}),y=Object.keys(l).length;ge.report("export-usdz-textures",{totalSteps:y*3,currentStep:0});const b=async T=>{const O=l[T],M=O.texture,k=_1.includes(M.format);let B={imageData:M.image};ge.report("export-usdz-textures",{message:"read back texture",autoStep:!0});const I=O.scale!==void 0&&O.scale.x!==1&&O.scale.y!==1&&O.scale.z!==1&&O.scale.w!==1;(M.isCompressedTexture||M.isRenderTargetTexture||I)&&(B=await d2(M,e.maxTextureSize,g,O.scale)),ge.report("export-usdz-textures",{message:"convert texture to canvas",autoStep:!0});const E=await f2(B.imageBitmap||B.imageData,e.maxTextureSize).catch(L=>{console.error("Error converting texture to canvas",M,L)});if(E){ge.report("export-usdz-textures",{message:"convert canvas to blob",autoStep:!0});const L=await E.convertToBlob({type:k?"image/png":"image/jpeg",quality:.95});n[`textures/${T}.${k?"png":"jpg"}`]=new Uint8Array(await L.arrayBuffer())}else console.warn("Can`t export texture: ",M)};for(const T in l)await b(T);g.dispose(),ge.end("export-usdz-textures");let _=0;for(const T in n){const O=n[T],M=34+T.length;_+=M;const k=_&63;if(k!==4){const B=64-k,I=new Uint8Array(B);n[T]=[O,{extra:{12345:I}}]}_=O.length}return ge.report("export-usdz","zip archive"),NR(n,{level:0})}};function f1(s,t,e,i){var c;if(!e.exportInvisible&&!s.visible)return;let n,o,r;const l={position:s.position,quaternion:s.quaternion,scale:s.scale};if(s.position.x===0&&s.position.y===0&&s.position.z===0&&(l.position=null),s.quaternion.x===0&&s.quaternion.y===0&&s.quaternion.z===0&&s.quaternion.w===1&&(l.quaternion=null),s.scale.x===1&&s.scale.y===1&&s.scale.z===1&&(l.scale=null),(s instanceof Z||s instanceof Eo)&&(o=s.geometry,r=s.material),i&&!i(s)&&(o=void 0,r=void 0),(s instanceof Z||s instanceof Eo)&&r&&(r instanceof Vi||r instanceof Ue||r instanceof De&&r.type==="MeshLineMaterial")){const h=Lu(s),d=s instanceof Eo?s:null;n=new hi(s.uuid,h,l,o,r,void 0,d,s.animations)}else if(s instanceof Re||s instanceof P_){const h=Lu(s);n=new hi(s.uuid,h,l,void 0,void 0,s)}else{const h=Lu(s);n=new hi(s.uuid,h,l,void 0,void 0,void 0,void 0,s.animations)}if(n){if(n.displayName=((c=s.userData)==null?void 0:c.name)||s.name,n.visibility=s.visible?void 0:"invisible",t&&t.add(n),t=n,e.extensions)for(const h of e.extensions)h.onExportObject&&h.onExportObject.call(h,s,n,e)}else{const h=Lu(s),d=new hi(s.uuid,h,{position:s.position,quaternion:s.quaternion,scale:s.scale});t&&t.add(d),t=d}for(const h of s.children)f1(h,t,e,i)}function yx(s,t,...e){const i={};let n=0;function o(r,l){n++;let c=r.displayName||r.name;c+=" ("+r.uuid+")",(r.geometry||r.material||r.camera||r.skinnedMesh)&&(c+=" ("+(r.geometry?"geo, ":"")+(r.material?"mat, ":"")+(r.camera?"cam, ":"")+(r.skinnedMesh?"skin, ":"")+")"),l[c]={};const d={object:r};r.material&&(d.mat=!0),r.geometry&&(d.geo=!0),r.camera&&(d.cam=!0),r.skinnedMesh&&(d.skin=!0),l[c]._self=d;for(const u of r.children)u&&o(u,l[c])}o(s,i),console.log(t+" ("+n+" nodes)",i,...e)}function p1(s,t){var h;let e=!0;const i=new Array,n=new Array;if(s.children.length===0)e=!0;else{const d=[...s.children];for(const u of d)if(u){const f=p1(u,t);t.debug&&(f?i.push(u):n.push(u)),e=e&&f}}const o=t.allBehaviorTargets.has(s.uuid),r=s.geometry||s.material||s.camera&&!t.quickLookCompatible||s.skinnedMesh||!1,l=t.boneReparentings.has(s.uuid),c=e&&!o&&!r&&!l;return c?(t.debug&&console.log("Pruned object:",(s.displayName||s.name)+" ("+s.uuid+")",{isVisible:r,isBehaviorSourceOrTarget:o,allChildsWerePruned:e,isBoneReparenting:l,object:s,prunedChilds:i,keptChilds:n}),(h=s.parent)==null||h.remove(s)):t.debug&&console.log("Kept object:",(s.displayName||s.name)+" ("+s.uuid+")",{isVisible:r,isBehaviorSourceOrTarget:o,allChildsWerePruned:e,isBoneReparenting:l,object:s,prunedChilds:i,keptChilds:n}),c}async function h2(s,t){ge.start("export-usdz-resources","export-usdz");const e=[];for(const c of s.document.children)m1(c,s,e);const i=e.length;for(let c=0;c<i;c++)ge.report("export-usdz-resources",{totalSteps:i,currentStep:c}),await new Promise((h,d)=>{e[c](),h()});ge.end("export-usdz-resources");const n=new a2,o=s.exporter.sceneAnchoringOptions.ar;n.beginBlock(`def Xform "${s.document.name}"`),n.beginBlock(`def Scope "Scenes" (
		kind = "sceneLibrary"
	)`),n.beginBlock('def Xform "Scene"',"(",!1),n.appendLine('apiSchemas = ["Preliminary_AnchoringAPI"]'),n.appendLine("customData = {"),n.appendLine("	bool preliminary_collidesWithEnvironment = 0"),n.appendLine('	string sceneName = "Scene"'),n.appendLine("}"),n.appendLine('sceneName = "Scene"'),n.closeBlock(")"),n.beginBlock(),n.appendLine(`token preliminary:anchoring:type = "${o.anchoring.type}"`),o.anchoring.type==="plane"&&n.appendLine(`token preliminary:planeAnchoring:alignment = "${o.planeAnchoring.alignment}"`),o.anchoring.type==="image"&&n.appendLine(`rel preliminary:imageAnchoring:referenceImage = </${s.document.name}/Scenes/Scene/AnchoringReferenceImage>`),n.appendLine();const r=c=>{if(!c)return 0;let h=1;for(const d of c.children)h+=r(d);return h},l=r(s.document);ge.start("export-usdz-xforms","export-usdz"),ge.report("export-usdz-xforms",{totalSteps:l,currentStep:1});for(const c of s.document.children)g1(c,n,s);ge.end("export-usdz-xforms"),ge.report("export-usdz","invoke onAfterHierarchy"),uf(s,"onAfterHierarchy",n),n.closeBlock(),n.closeBlock(),n.appendLine(t()),n.closeBlock(),ge.report("export-usdz","write to string"),s.output+=n.toString()}function m1(s,t,e){if(!s)return;const i=s.geometry,n=s.material;if(i)if(n&&("isMeshStandardMaterial"in n&&n.isMeshStandardMaterial||"isMeshBasicMaterial"in n&&n.isMeshBasicMaterial||n.type==="MeshLineMaterial")){const o="geometries/"+i_(i,s.name)+".usda";if(!(o in t.files)){const r=()=>{var c,h;const l=y2(i,(h=(c=s.skinnedMesh)==null?void 0:c.skeleton)==null?void 0:h.bones,t.quickLookCompatible);t.files[o]=g2(l)};e.push(r)}}else console.warn("NeedleUSDZExporter: Unsupported material type (USDZ only supports MeshStandardMaterial)",n==null?void 0:n.name);n&&(n.uuid in t.materials||(t.materials[n.uuid]=n));for(const o of s.children)m1(o,t,e)}async function uf(s,t,e=null){if(s.extensions){for(const i of s.extensions)if(i&&typeof i[t]=="function"){const o=i[t].call(i,s,e);o instanceof Promise&&await o}}}let Iu=null,wi=null,Eg,Cl,Du;async function d2(s,t=1/0,e=null,i=void 0){Eg||(Eg=new Ys(2,2,1,1)),Cl||(Cl=new os({uniforms:{blitTexture:new Er(s),flipY:new Er(!1),scale:new Er(new xe(1,1,1,1))},vertexShader:`
            varying vec2 vUv;
			uniform bool flipY;
            void main(){
                vUv = uv;
				if (flipY)
					vUv.y = 1. - vUv.y;
                gl_Position = vec4(position.xy * 1.0,0.,.999999);
            }`,fragmentShader:`
            uniform sampler2D blitTexture;
			uniform vec4 scale; 
            varying vec2 vUv;

            void main(){ 
                gl_FragColor = vec4(vUv.xy, 0, 1);
                
                #ifdef IS_SRGB
                gl_FragColor = sRGBTransferOETF( texture2D( blitTexture, vUv) );
                #else
                gl_FragColor = texture2D( blitTexture, vUv);
                #endif
				
				gl_FragColor.rgba *= scale.rgba;
            }`}));const n=Cl.uniforms;n.blitTexture.value=s,n.flipY.value=!1,n.scale.value=new xe(1,1,1,1),i!==void 0&&n.scale.value.copy(i),Cl.defines.IS_SRGB=s.colorSpace==rs,Cl.needsUpdate=!0,Du||(Du=new Z(Eg,Cl),Du.frustumCulled=!1);const o=new Re,r=new In;r.add(Du),e||(e=Iu=new Qa({antialias:!1,alpha:!0,premultipliedAlpha:!1,preserveDrawingBuffer:!0}));const l=Math.min(s.image.width,t),c=Math.min(s.image.height,t);wi&&(wi.width!==l||wi.height!==c)&&(wi.dispose(),wi=null),wi||(wi=new No(l,c,{format:Pp,type:hR,minFilter:a0,magFilter:a0})),e.setRenderTarget(wi),e.setSize(l,c),e.clear(),e.render(r,o),Iu&&(Iu.dispose(),Iu=null);const h=new Uint8ClampedArray(wi.width*wi.height*4);e.readRenderTargetPixels(wi,0,0,wi.width,wi.height,h);const d=new ImageData(h,wi.width,wi.height,void 0),u=await createImageBitmap(d,{premultiplyAlpha:"none"});return{imageData:d,imageBitmap:u}}function u2(s){return typeof HTMLImageElement<"u"&&s instanceof HTMLImageElement||typeof HTMLCanvasElement<"u"&&s instanceof HTMLCanvasElement||typeof OffscreenCanvas<"u"&&s instanceof OffscreenCanvas||typeof ImageBitmap<"u"&&s instanceof ImageBitmap}async function f2(s,t=4096){const e=t/Math.max(s.width,s.height),i=s.width*Math.min(1,e),n=s.height*Math.min(1,e),o=new OffscreenCanvas(i,n),r={premultiplyAlpha:"none"};s.width!==i&&(r.resizeWidth=i),s.height!==n&&(r.resizeHeight=n);const l=await createImageBitmap(s,r),c=o.getContext("bitmaprenderer");return c&&c.transferFromImageBitmap(l),o}async function p2(s,t=void 0,e=!1,i=4096){if(u2(s)){const n=i/Math.max(s.width,s.height),o=new OffscreenCanvas(s.width*Math.min(1,n),s.height*Math.min(1,n)),r=o.getContext("2d",{alpha:!0,premultipliedAlpha:!1});if(!r)throw new Error("Could not get canvas 2D context");if(e===!0&&(r.translate(0,o.height),r.scale(1,-1)),r.drawImage(s,0,0,o.width,o.height),t!==void 0){const l=t.x,c=t.y,h=t.z,d=t.w,u=r.getImageData(0,0,o.width,o.height),f=u.data;for(let p=0;p<f.length;p+=4)f[p+0]=f[p+0]*l,f[p+1]=f[p+1]*c,f[p+2]=f[p+2]*h,f[p+3]=f[p+3]*d;r.putImageData(u,0,0)}return o}else throw new Error("NeedleUSDZExporter: No valid image data found. Unable to process texture.")}const We=7;function m2(){return`#usda 1.0
(
    customLayerData = {
        string creator = "Needle Engine USDZExporter"
    }
    metersPerUnit = 1
    upAxis = "Y"
)
`}function g2(s,t){let e=m2();return e+=s,Sw(e)}function Lu(s){return s.name.replace(/[-<>\(\)\[\]¬ß$%&\/\\\=\?\,\;]/g,"")+"_"+s.id}function _x(s){return Qs(s.name||"bone_"+s.uuid)}function i_(s,t){return Qs(s.name||"Geometry")+"_"+s.id}function gb(s){return Qs(s.name||"Material")+"_"+s.id}function cc(s,t){let e=_x(s),i=s.parent;for(;i&&i!==t;)e=_x(i)+"/"+e,i=i.parent;return e}function g1(s,t,e){var p;if(s==null)return;ge.report("export-usdz-xforms",{message:"buildXform "+s.displayName||s.name,autoStep:!0});const i=s.transform,n=s.geometry,o=s.material,r=s.camera,l=s.name;if(s.animations)for(const g of s.animations)e.animations.push(g);const c=n&&n.isBufferGeometry&&n.attributes.skinIndex!==void 0&&n.attributes.skinIndex.count>0,h=c?"SkelRoot":"Xform",d=new Array,u=o&&o instanceof Ue&&o.color&&o.color.r===1&&o.color.g===1&&o.color.b===1&&!o.map&&o.opacity===1&&(n==null?void 0:n.attributes.color);if(n!=null&&n.attributes.color&&!u&&console.warn("NeedleUSDZExporter: Geometry has vertex colors. Vertex colors will only be shown in QuickLook for unlit materials with white color and no texture. Otherwise, they will be ignored.",s.displayName),t.appendLine(),n?(t.beginBlock(`def ${h} "${l}"`,"(",!1),e.quickLookCompatible&&o&&o.side===hn&&!c?t.appendLine(`prepend references = @./geometries/${i_(n)}.usda@</Geometry_doubleSided>`):t.appendLine(`prepend references = @./geometries/${i_(n)}.usda@</Geometry>`),u||d.push("MaterialBindingAPI"),c&&d.push("SkelBindingAPI")):r&&!e.quickLookCompatible?t.beginBlock(`def Camera "${l}"`,"(",!1):s.type!==void 0?t.beginBlock(`def ${s.type} "${l}"`):t.beginBlock(`def Xform "${l}"`,"(",!1),s.type===void 0&&((p=s.extraSchemas)!=null&&p.length&&d.push(...s.extraSchemas),d.length&&t.appendLine(`prepend apiSchemas = [${d.map(g=>`"${g}"`).join(", ")}]`)),s.displayName&&t.appendLine(`displayName = "${c1(s.displayName)}"`),(r||s.type===void 0)&&(t.closeBlock(")"),t.beginBlock()),n&&o){if(!u){const g=gb(o);t.appendLine(`rel material:binding = </StageRoot/Materials/${g}>`)}!e.quickLookCompatible&&o.side===hn&&(t.beginBlock('over "Geometry" '),t.appendLine("uniform bool doubleSided = 1"),t.closeBlock())}let f=!1;if(c?(t.appendLine("rel skel:skeleton = <Rig>"),t.appendLine("rel skel:animationSource = <Rig/_anim>"),f=!1):s.type===void 0&&i&&(f=f||i.position!==null||i.quaternion!==null||i.scale!==null,i.position&&(s.needsTranslate=!0,t.appendLine(`double3 xformOp:translate = (${pe(i.position.x)}, ${pe(i.position.y)}, ${pe(i.position.z)})`)),i.quaternion&&(s.needsOrient=!0,t.appendLine(`quatf xformOp:orient = (${pe(i.quaternion.w)}, ${pe(i.quaternion.x)}, ${pe(i.quaternion.y)}, ${pe(i.quaternion.z)})`)),i.scale&&(s.needsScale=!0,t.appendLine(`double3 xformOp:scale = (${pe(i.scale.x)}, ${pe(i.scale.y)}, ${pe(i.scale.z)})`))),s.visibility!==void 0&&t.appendLine(`token visibility = "${s.visibility}"`),r&&!e.quickLookCompatible&&("isOrthographicCamera"in r&&r.isOrthographicCamera?(t.appendLine(`float2 clippingRange = (${r.near}, ${r.far})`),t.appendLine(`float horizontalAperture = ${((Math.abs(r.left)+Math.abs(r.right))*10).toPrecision(We)}`),t.appendLine(`float verticalAperture = ${((Math.abs(r.top)+Math.abs(r.bottom))*10).toPrecision(We)}`),t.appendLine('token projection = "orthographic"')):"isPerspectiveCamera"in r&&r.isPerspectiveCamera&&(t.appendLine(`float2 clippingRange = (${r.near.toPrecision(We)}, ${r.far.toPrecision(We)})`),t.appendLine(`float focalLength = ${r.getFocalLength().toPrecision(We)}`),t.appendLine(`float focusDistance = ${r.focus.toPrecision(We)}`),t.appendLine(`float horizontalAperture = ${r.getFilmWidth().toPrecision(We)}`),t.appendLine('token projection = "perspective"'),t.appendLine(`float verticalAperture = ${r.getFilmHeight().toPrecision(We)}`))),s.onSerialize&&s.onSerialize(t,e),s.type===void 0){const g=new Array;s.needsTranslate&&g.push('"xformOp:translate"'),s.needsOrient&&g.push('"xformOp:orient"'),s.needsScale&&g.push('"xformOp:scale"'),g.length&&t.appendLine(`uniform token[] xformOpOrder = [${g.join(", ")}]`)}if(s.children){t.appendLine();for(const g of s.children)g1(g,t,e)}t.closeBlock()}function pe(s){return Number.isInteger(s)?s.toString():s.toFixed(10)}function bx(s){const t=s.elements;return`( ${ju(t,0)}, ${ju(t,4)}, ${ju(t,8)}, ${ju(t,12)} )`}function ju(s,t){return`(${pe(s[t+0])}, ${pe(s[t+1])}, ${pe(s[t+2])}, ${pe(s[t+3])})`}function y2(s,t=[],e=!0){return`
def "Geometry"
${_2(s,t,e)}
`}function _2(s,t=[],e=!0){const i="Geometry",n=s.attributes,o=n.position.count,r=t&&t.length>0,l=[],c=[];let h=new Array,d=n.skinIndex;if(r){const f=[];for(const b of t)l.push({bone:b,index:t.indexOf(b)}),f.push(b.uuid);let p=1e4;for(;f.length<t.length&&p-- >0;)for(const b of l){const _=b.bone.children;for(const v of _)f.indexOf(v.uuid)===-1&&t.indexOf(v)!==-1&&(l.push({bone:v,index:t.indexOf(v)}),f.push(v.uuid))}p<=0&&console.error("Failed to sort bones in skinned mesh",l,t,f);for(const b of d1(t))l.push({bone:b,index:l.length});const g=l[0].bone.parent;l.sort((b,_)=>cc(b.bone,g)>cc(_.bone,g)?1:-1),l.map(b=>'"'+cc(b.bone,g)+'"').join(", ");for(const b in l)c[l[b].index]=parseInt(b);const y=n.skinIndex;h=new Array;for(let b=0;b<y.count;b++){const _=y.getX(b),v=y.getY(b),S=y.getZ(b),T=y.getW(b);h.push(c[_],c[v],c[S],c[T])}d=new $i(new Uint16Array(h),4)}const u=n.skinWeight&&n.skinIndex;return`
{	
    def Mesh "${i}" ${u?`(
        prepend apiSchemas = ["SkelBindingAPI"]
    )`:""}
    {
        int[] faceVertexCounts = [${Mg(s)}]
        int[] faceVertexIndices = [${Ag(s)}]
		${n.normal||e?`normal3f[] normals = [${ff(n.normal,o)}] (
            interpolation = "vertex"
        )`:""}
        point3f[] points = [${ff(n.position,o)}]
        ${n.uv?`texCoord2f[] primvars:st = [${y1(n.uv,o,!0)}] (
            interpolation = "vertex"
        )`:""}
		${n.uv1?Ig("st1",n.uv1):""}
		${n.uv2?Ig("st2",n.uv2):""}
		${n.uv3?Ig("st3",n.uv3):""}
		${u?`matrix4d primvars:skel:geomBindTransform = ( (1, 0, 0, 0), (0, 1, 0, 0), (0, 0, 1, 0), (0, 0, 0, 1) ) (
				elementSize = 1
				interpolation = "constant"
			)`:""}
		${n.skinIndex?`int[] primvars:skel:jointIndices = [${vx(d,!0)}] (
			elementSize = 4
			interpolation = "vertex"
		)`:""}
		${n.skinWeight?`float[] primvars:skel:jointWeights = [${vx(n.skinWeight)}] (
			elementSize = 4
			interpolation = "vertex"
		)`:""}
		${n.color?`color3f[] primvars:displayColor = [${ff(n.color,o)}] (
			interpolation = "vertex"
		)`:""}
        uniform token subdivisionScheme = "none"
    }
}
${e?`
# This is a workaround for QuickLook/RealityKit not supporting the doubleSided attribute. We're adding a second
# geometry definition here, that uses the same mesh data but appends extra faces with reversed winding order.
def "${i}_doubleSided" (
	prepend references = </Geometry>
)
{
	over "Geometry"
	{
		int[] faceVertexCounts = [${Mg(s)+", "+Mg(s)}]
		int[] faceVertexIndices = [${Ag(s)+", "+Ag(s,!0)}]
	}
}
`:""}
`}function Mg(s){const t=s.index!==null?s.index.count:s.attributes.position.count;return Array(Math.floor(t/3)).fill(3).join(", ")}function Ag(s,t=!1){const e=s.index,i=[];if(e!==null)for(let n=0;n<e.count;n++){let o=n;t&&(o=n%3===0?n+2:n%3===2?n-2:n),i.push(e.getX(o))}else{const n=s.attributes.position.count;for(let o=0;o<n;o++){let r=o;t&&(r=o%3===0?o+2:o%3===2?o-2:o),i.push(r)}}return i.join(", ")}function Ig(s,t){const e=t.itemSize;switch(e){case 2:return`texCoord2f[] primvars:${s} = [${y1(t,e,!0)}] (
				interpolation = "vertex"
			)`;case 3:return`texCoord3f[] primvars:${s} = [${ff(t,e)}] (
				interpolation = "vertex"
			)`;case 4:return`double4[] primvars:${s} = [${b2(t,e)}] (
				interpolation = "vertex"
			)`;default:return console.warn("USDZExporter: Attribute with "+e+" components are currently not supported. Results may be undefined for "+s+"."),""}}function ff(s,t){if(s===void 0)return console.warn("USDZExporter: A mesh attribute is missing and will be set with placeholder data. The result may look incorrect."),Array(t).fill("(0, 0, 1)").join(", ");const e=[];for(let i=0;i<s.count;i++){const n=s.getX(i),o=s.getY(i),r=s.getZ(i);e.push(`(${n.toPrecision(We)}, ${o.toPrecision(We)}, ${r.toPrecision(We)})`)}return e.join(", ")}function b2(s,t){if(s===void 0)return console.warn("USDZExporter: Attribute is missing. Results may be undefined."),Array(t).fill("(0, 0, 0, 0)").join(", ");const e=[];for(let i=0;i<s.count;i++){const n=s.getX(i),o=s.getY(i),r=s.getZ(i)||0,l=s.getW(i)||0;e.push(`(${n.toPrecision(We)}, ${o.toPrecision(We)}, ${r.toPrecision(We)}, ${l.toPrecision(We)})`)}return e.join(", ")}function vx(s,t=!1){const e=[];for(let i=0;i<s.count;i++){const n=s.getX(i),o=s.getY(i),r=s.getZ(i),l=s.getW(i);e.push(`${t?n:n.toPrecision(We)}`),e.push(`${t?o:o.toPrecision(We)}`),e.push(`${t?r:r.toPrecision(We)}`),e.push(`${t?l:l.toPrecision(We)}`)}return e.join(", ")}function y1(s,t,e=!1){if(s===void 0)return console.warn("USDZExporter: UVs missing."),Array(t).fill("(0, 0)").join(", ");const i=[];for(let n=0;n<s.count;n++){const o=s.getX(n);let r=s.getY(n);e&&(r=1-r),i.push(`(${o.toPrecision(We)}, ${r.toPrecision(We)})`)}return i.join(", ")}function v2(s,t,e=!1){const i=[];for(const n in s){const o=s[n];i.push(x2(o,t,e))}return`
	def "Materials"
    {
${i.join("")}
    }`}function x2(s,t,e=!1){var g,y,b;const i=gb(s);if(s.colorWrite===!1||((g=s.userData)==null?void 0:g.isShadowCatcherMaterial)||((y=s.userData)==null?void 0:y.isLightBlendMaterial)){const _=s.userData.isLightBlendMaterial||s.userData.isShadowCatcherMaterial?"ND_realitykit_shadowreceiver_surfaceshader":"ND_realitykit_occlusion_surfaceshader";return`

		def Material "${i}" ${s.name?`(
			displayName = "${s.name}"
		)`:""}
		{
			token outputs:mtlx:surface.connect = ${xi}/${i}/Occlusion.outputs:out>

			def Shader "Occlusion"
			{
				uniform token info:id = "${_}"
				token outputs:out
			}
		}`}const o="                ",r=[],l=[],c=new Set;function h(_){var v;return Qs(_.name)+"_"+(((v=_.source)==null?void 0:v.id)??_.id)}function d(_,v,S=void 0,T=void 0){const O=h(_),M=O+(T!==void 0&&T!==1?"_"+T:""),k=e&&T!==void 0&&T!==1,B=k?new xe(1,1,1,T):void 0;T===void 0&&(T=1),k&&(T=1),B&&B.w<=.05&&(B.w=.05),t[M]={texture:_,scale:B};const I=_.channel>0?"st"+_.channel:"st";c.add(_.channel);const E=_1.includes(_.format),L={1e3:"repeat",1001:"clamp",1002:"mirror"},V=_.repeat.clone(),A=_.offset.clone(),D=_.rotation,N=Math.sin(D),q=Math.cos(D);A.y=1-A.y-V.y,e?(V.x===0&&(V.x=1e-4),V.y===0&&(V.y=1e-4),A.x=A.x/V.x,A.y=A.y/V.y,A.x+=N/V.x,A.y+=q-1):(A.x+=N*V.x,A.y+=(1-q)*V.y);const Y=V.x!=1||V.y!=1||A.x!=0||A.y!=0||D!=0,ie=`${xi}/${i}/${"uvReader_"+I}.outputs:result>`,he=`${xi}/${i}/Transform2d_${v}.outputs:result>`,Pe=v!=="normal"&&S&&(S.r!==1||S.g!==1||S.b!==1||T!==1)||!1,He=v==="normal",gt=s instanceof Vi&&s.normalScale?s.normalScale.x*2:2,lt=gt.toFixed(We),ei=(-1*(gt/2)).toFixed(We),_i=(1-gt).toFixed(We);return`
			${Y?`def Shader "Transform2d_${v}" (
				sdrMetadata = {
					string role = "math"
				}
			)
			{
				uniform token info:id = "UsdTransform2d"
				float2 inputs:in.connect = ${ie}
				float2 inputs:scale = ${wx(V)}
				float2 inputs:translation = ${wx(A)}
				float inputs:rotation = ${(D/Math.PI*180).toFixed(We)}
				float2 outputs:result
			}
			`:""}
			def Shader "${O}_${v}"
			{
				uniform token info:id = "UsdUVTexture"
				asset inputs:file = @textures/${M}.${E?"png":"jpg"}@
				token inputs:sourceColorSpace = "${_.colorSpace==="srgb"?"sRGB":"raw"}"
				float2 inputs:st.connect = ${Y?he:ie}
				${Pe?`
				float4 inputs:scale = (${S?S.r+", "+S.g+", "+S.b:"1, 1, 1"}, ${T})
				`:""}
				${He?`
				float4 inputs:scale = (${lt}, ${lt}, ${lt}, 1)
				float4 inputs:bias = (${ei}, ${ei}, ${_i}, 0)
				`:""}
				token inputs:wrapS = "${L[_.wrapS]}"
				token inputs:wrapT = "${L[_.wrapT]}"
				float outputs:r
				float outputs:g
				float outputs:b
				float3 outputs:rgb
				${s.transparent||s.alphaTest>0?"float outputs:a":""}
			}`}let u=s.transparent||s.alphaTest?s.opacity:1,f=!1,p=!1;if(s instanceof ay&&s.transmission!==void 0&&(u*=1-s.transmission*(1-s.roughness*.5)),s.map?(r.push(`${o}color3f inputs:diffuseColor.connect = ${xi}/${i}/${h(s.map)}_diffuse.outputs:rgb>`),s instanceof Ue&&s.transparent&&s.alphaTest==0&&e?(r.push(`${o}float inputs:opacity.connect = ${xi}/${i}/${h(s.map)}_diffuse.outputs:a>`),f=!0,r.push(`${o}float inputs:opacityThreshold = ${1e-10}`),p=!0):s.transparent?(r.push(`${o}float inputs:opacity.connect = ${xi}/${i}/${h(s.map)}_diffuse.outputs:a>`),f=!0):s.alphaTest>0&&(r.push(`${o}float inputs:opacity.connect = ${xi}/${i}/${h(s.map)}_diffuse.outputs:a>`),f=!0,r.push(`${o}float inputs:opacityThreshold = ${s.alphaTest}`),p=!0),l.push(d(s.map,"diffuse",s.color,u))):r.push(`${o}color3f inputs:diffuseColor = ${xx(s.color)}`),s.alphaHash&&e&&(p?console.warn("Opacity threshold for "+s.name+" was already connected. Skipping alphaHash opacity threshold."):(r.push(`${o}float inputs:opacityThreshold = 0.0000000001`),p=!0)),s.aoMap&&(r.push(`${o}float inputs:occlusion.connect = ${xi}/${i}/${h(s.aoMap)}_occlusion.outputs:r>`),l.push(d(s.aoMap,"occlusion"))),s.alphaMap?(r.push(`${o}float inputs:opacity.connect = ${xi}/${i}/${h(s.alphaMap)}_opacity.outputs:r>`),r.push(`${o}float inputs:opacityThreshold = 0.0000000001`),f=!0,p=!0,l.push(d(s.alphaMap,"opacity",new ue(1,1,1),u))):(f?console.warn("Opacity for "+s.name+" was already connected. Skipping default opacity."):(r.push(`${o}float inputs:opacity = ${u}`),f=!0),s.alphaTest>0&&(p?console.warn("Opacity threshold for "+s.name+" was already connected. Skipping default opacity threshold."):(r.push(`${o}float inputs:opacityThreshold = ${s.alphaTest}`),p=!0))),s instanceof Vi){if(s.emissiveMap){r.push(`${o}color3f inputs:emissiveColor.connect = ${xi}/${i}/${h(s.emissiveMap)}_emissive.outputs:rgb>`);const _=s.emissive.clone();_.multiplyScalar(s.emissiveIntensity),l.push(d(s.emissiveMap,"emissive",_))}else if(((b=s.emissive)==null?void 0:b.getHex())>0){const _=s.emissive.clone();_.multiplyScalar(s.emissiveIntensity),r.push(`${o}color3f inputs:emissiveColor = ${xx(_)}`)}s.normalMap&&(r.push(`${o}normal3f inputs:normal.connect = ${xi}/${i}/${h(s.normalMap)}_normal.outputs:rgb>`),l.push(d(s.normalMap,"normal"))),s.roughnessMap&&s.roughness===1?(r.push(`${o}float inputs:roughness.connect = ${xi}/${i}/${h(s.roughnessMap)}_roughness.outputs:g>`),l.push(d(s.roughnessMap,"roughness"))):r.push(`${o}float inputs:roughness = ${s.roughness!==void 0?s.roughness:1}`),s.metalnessMap&&s.metalness===1?(r.push(`${o}float inputs:metallic.connect = ${xi}/${i}/${h(s.metalnessMap)}_metallic.outputs:b>`),l.push(d(s.metalnessMap,"metallic"))):r.push(`${o}float inputs:metallic = ${s.metalness!==void 0?s.metalness:0}`)}return s instanceof ay&&(r.push(`${o}float inputs:clearcoat = ${s.clearcoat}`),r.push(`${o}float inputs:clearcoatRoughness = ${s.clearcoatRoughness}`),r.push(`${o}float inputs:ior = ${s.ior}`),!s.transparent&&!(s.alphaTest>0)&&s.transmissionMap&&(r.push(`${o}float inputs:opacity.connect = ${xi}/${i}/${h(s.transmissionMap)}_transmission.outputs:r>`),l.push(d(s.transmissionMap,"transmission")))),c.size>2?console.warn("USDZExporter: Material "+s.name+" uses more than 2 UV channels. Currently, only UV0 and UV1 are supported."):c.size===2&&(!c.has(0)||!c.has(1))&&console.warn("USDZExporter: Material "+s.name+" uses UV channels other than 0 and 1. Currently, only UV0 and UV1 are supported."),`

		def Material "${i}" ${s.name?`(
			displayName = "${c1(s.name)}"
		)`:""}
		{
			token outputs:surface.connect = ${xi}/${i}/PreviewSurface.outputs:surface>

			def Shader "PreviewSurface"
			{
				uniform token info:id = "UsdPreviewSurface"
${r.join(`
`)}
				int inputs:useSpecularWorkflow = ${s instanceof Ue?"1":"0"}
				token outputs:surface
			}
${l.length>0?`
${c.has(0)?`
			def Shader "uvReader_st"
			{
				uniform token info:id = "UsdPrimvarReader_float2"
				token inputs:varname = "st"
				float2 inputs:fallback = (0.0, 0.0)
				float2 outputs:result
			}
`:""}
${c.has(1)?`
			def Shader "uvReader_st1"
			{
				uniform token info:id = "UsdPrimvarReader_float2"
				token inputs:varname = "st1"
				float2 inputs:fallback = (0.0, 0.0)
				float2 outputs:result
			}
`:""}
${l.join(`
`)}`:""}
		}`}function xx(s){return`(${s.r}, ${s.g}, ${s.b})`}function wx(s){return`(${s.x}, ${s.y})`}const _1=[1023,33777,33778,33779,35842,35843,37496,37808,37809,37810,37811,37812,37813,37814,37815,37816,37817,37818,37819,37820,37821,36492],Es=C("debugusdzanimation"),n_=C("debugusdzanimationserialization");class Tr{constructor(t,e,i){a(this,"_start");a(this,"ext");a(this,"root");a(this,"_nearestAnimatedRoot");a(this,"clip");a(this,"speed");this.ext=t,this.root=e,this.clip=i,this._nearestAnimatedRoot=this.getNearestAnimatedRoot()}get start(){return this._start===void 0&&(this._start=this.ext.getStartTimeByClip(this.clip)),this._start}get duration(){var t;return((t=this.clip)==null?void 0:t.duration)??Ke.restPoseClipDuration}get nearestAnimatedRoot(){return this._nearestAnimatedRoot}get clipName(){var t;return((t=this.clip)==null?void 0:t.name)??"rest"}static isDescendantOf(t,e){let i=e;if(!i||!t)return!1;for(;i;){if(!i)return!1;if(i===t)return!0;i=i.parent}return!1}getNearestAnimatedRoot(){var e;let t;try{for(const i of((e=this.clip)==null?void 0:e.tracks)??[]){const n=mc.parseTrackName(i.name);let o=mc.findNode(this.root,n.nodeName);if(o)if(!t)t=o;else{if(o===t||Tr.isDescendantOf(t,o))continue;if(!Tr.isDescendantOf(o,t)){for(;!Tr.isDescendantOf(o,t)&&o.parent;)o=o.parent;Tr.isDescendantOf(o,t)||console.error("USDZExporter: Animation clip targets multiple roots that are not parent/child. Please report a bug",this.root,this.clip,t,o)}t=o}}}catch(i){console.error("USDZExporter: Exception when trying to find nearest animated root. Please report a bug",i),t=void 0}return t}}const fd=class{constructor(t,e,i){a(this,"clip");a(this,"pos");a(this,"rot");a(this,"scale");a(this,"root");a(this,"target");a(this,"duration",0);a(this,"useRootMotion",!1);if(this.root=t,this.target=e,this.clip=i,i?this.duration=i.duration:this.duration=fd.restPoseClipDuration,i&&i.tracks){const o=Math.max(...i.tracks.map(r=>r.times[r.times.length-1]));o!==this.duration&&(console.warn("USDZExporter: Animation clip duration does not match the maximum time value in the tracks.",i,o,this.duration),this.duration=o)}const n=P.getComponent(t,pi);n&&(this.useRootMotion=n.applyRootMotion)}addTrack(t){var e,i;if(!this.clip){console.error("This is a rest clip but you're trying to add tracks to it ‚Äì this is likely a bug");return}t.name.endsWith("position")?this.pos=t:t.name.endsWith("quaternion")?this.rot=t:t.name.endsWith("scale")?this.scale=t:(t.name.endsWith("activeSelf")?console.warn("[USDZ] Animation of enabled/disabled state is not supported for USDZ export and will NOT be exported: "+t.name+" on "+(((e=this.root)==null?void 0:e.name)??this.target.name)+". Animate scale 0/1 instead."):console.warn("[USDZ] Animation track type not supported for USDZ export and will NOT be exported: "+t.name+" on "+(((i=this.root)==null?void 0:i.name)??this.target.name)+". Only .position, .rotation, .scale are supported."),U()&&Me("[USDZ] Some animations can't be exported. See console for details."))}getFrames(){var t,e,i,n,o,r;return this.clip?Math.max(((e=(t=this.pos)==null?void 0:t.times)==null?void 0:e.length)??0,((n=(i=this.rot)==null?void 0:i.times)==null?void 0:n.length)??0,((r=(o=this.scale)==null?void 0:o.times)==null?void 0:r.length)??0):2}getDuration(){return this.duration}getSortedTimesArray(t=!0,e=!0,i=!0){var c,h,d;if(!this.clip)return[0,this.duration];const n=(c=this.pos)==null?void 0:c.times,o=(h=this.rot)==null?void 0:h.times,r=(d=this.scale)==null?void 0:d.times,l=[];if(t&&n)for(const u of n)l.push(u);if(e&&o)for(const u of o)l.push(u);if(i&&r)for(const u of r)l.push(u);return l.includes(0)||l.push(0),l.sort((u,f)=>u-f),[...new Set(l)]}*getValues(t,e=!0,i=!0,n=!0){var p,g,y;const o=new x,r=new H,l=new x(1,1,1),c=this.target,h=e?(p=this.pos)==null?void 0:p.createInterpolant():void 0,d=i?(g=this.rot)==null?void 0:g.createInterpolant():void 0,u=n?(y=this.scale)==null?void 0:y.createInterpolant():void 0;h||o.set(c.position.x,c.position.y,c.position.z),d||r.set(c.quaternion.x,c.quaternion.y,c.quaternion.z,c.quaternion.w),u||l.set(c.scale.x,c.scale.y,c.scale.z),h&&h.valueSize!==3&&(h.valueSize=3),d&&d.valueSize!==4&&(d.valueSize=4),u&&u.valueSize!==3&&(u.valueSize=3);const f=0;for(let b=0-f;b<t.length+f;b++){let _=0,v=0;if(b<0?(_=t[0],v=_-fd.animationDurationPadding/2+1/60):b>=t.length?(_=t[t.length-1],v=_+fd.animationDurationPadding/2-1/60):(_=t[b],v=_),h){const S=h.evaluate(_);o.set(S[0],S[1],S[2])}if(d){const S=d.evaluate(_);r.set(S[0],S[1],S[2],S[3])}if(u){const S=u.evaluate(_);l.set(S[0],S[1],S[2])}if(this.useRootMotion&&c===this.root){const S=new le;S.compose(o,r,l),S.multiply(c.matrix),S.decompose(o,r,l)}yield{time:v,translation:o,rotation:r,scale:l,index:b}}}};let Ke=fd;a(Ke,"frameRate",60),a(Ke,"animationDurationPadding",6/60),a(Ke,"restPoseClipDuration",6/60);class Zp{constructor(t){a(this,"dict",new Map);a(this,"rootTargetMap",new Map);a(this,"rootAndClipToRegisteredAnimationMap",new Map);a(this,"rootToRegisteredClip",new Map);a(this,"lastClipEndTime",0);a(this,"clipToStartTime",new Map);a(this,"clipToHoldClip",new Map);a(this,"serializers",[]);a(this,"injectRestPoses",!1);a(this,"injectImplicitBehaviours",!1);this.injectRestPoses=t,this.injectImplicitBehaviours=t}get extensionName(){return"animation"}get animationData(){return this.dict}get registeredClips(){return this.clipToStartTime.keys()}get animatedRoots(){return this.rootTargetMap.keys()}get holdClipMap(){return this.clipToHoldClip}getStartTimeCode(){return!this.injectRestPoses||this.rootAndClipToRegisteredAnimationMap.size===0?0:(Ke.restPoseClipDuration+Ke.animationDurationPadding)*60}getEndTimeCode(){let t=0;for(const[e,i]of this.rootAndClipToRegisteredAnimationMap){const n=i.start+i.duration;n>t&&(t=n)}return t*60}getClipCount(t){var i;return((i=this.rootToRegisteredClip.get(t))==null?void 0:i.length)??0??0}getStartTimeByClip(t){return t?this.clipToStartTime.has(t)?this.clipToStartTime.get(t):(console.error("USDZExporter: Missing start time for clip ‚Äì please report a bug.",t),0):0}registerAnimation(t,e){var h;if(!t)return null;this.rootTargetMap.has(t)||this.rootTargetMap.set(t,[]);const i=t.uuid+((e==null?void 0:e.uuid)??"-rest");if(this.rootAndClipToRegisteredAnimationMap.has(i))return this.rootAndClipToRegisteredAnimationMap.get(i);Es&&console.log("registerAnimation",t,e);const n=this.injectRestPoses?1:0,o=(((h=this.rootToRegisteredClip.get(t))==null?void 0:h.length)??0)+n,r=this.rootTargetMap.get(t),l=new Set(r);if(e&&e.tracks)for(const d of e.tracks){const u=mc.parseTrackName(d.name),f=mc.findNode(t,u.nodeName);if(!f){console.warn("no object found for track",d.name,"using "+t.name+" instead");continue}this.dict.has(f)||this.dict.set(f,[]);const p=this.dict.get(f);if(!p){console.warn("no transform data found for target ",f,"at slot "+o+", this is likely a bug");continue}l.delete(f),this.injectRestPoses&&!p[0]&&(console.log("Injecting rest pose",f,e,"at slot",o),p[0]=new Ke(null,f,null));let g=p[o];g||(g=new Ke(t,f,e),p[o]=g),g.addTrack(d),r!=null&&r.includes(f)||r==null||r.push(f)}Es&&console.log("Unregistered nodes for this clip",l,"clip",e,"at slot",o,"for root",t,"targets",r);for(const d of l){const u=this.dict.get(d);if(!u)continue;if(this.injectRestPoses&&!u[0]){console.warn("Adding rest pose for ",d,e,"at slot",o,"This is likely a bug, should have been added earlier.");const p=new Ke(null,d,null);u[0]=p}let f=u[o];f||(Es&&console.log("Adding padding clip for ",d,e,"at slot",o),f=new Ke(t,d,e),u[o]=f)}const c=new Tr(this,t,e);if(this.rootAndClipToRegisteredAnimationMap.set(i,c),Es&&console.log({root:t,clip:e,info:c}),e){const d=this.rootToRegisteredClip.get(t);if(d?d.push(e):this.rootToRegisteredClip.set(t,[e]),!this.clipToStartTime.get(e)){this.lastClipEndTime==null&&(this.lastClipEndTime=Ke.restPoseClipDuration);let f=this.lastClipEndTime+Ke.animationDurationPadding,p=f+e.duration;const g=Math.round(f*60)/60,y=Math.round(p*60)/60;Math.abs(g-f)<.01&&(f=g),Math.abs(y-p)<.01&&(p=y),f=Math.ceil(f),p=f+e.duration,this.clipToStartTime.set(e,f),this.lastClipEndTime=p}}return c}onAfterHierarchy(t){Es&&console.log("Animation clips per animation target node",this.dict)}onAfterBuildDocument(t){var e,i;Es&&console.log("Animation data",{dict:this.dict,rootTargetMap:this.rootTargetMap,rootToRegisteredClip:this.rootToRegisteredClip});for(const n of this.rootTargetMap.keys()){const o=this.rootTargetMap.get(n);if(!o)continue;let r;const l=[];for(const c of o){const h=this.dict.get(c);if(!h){console.error("No data found for target on USDZ export ‚Äì please report a bug!",c);continue}r===void 0&&(r=h==null?void 0:h.length),r!==(h==null?void 0:h.length)&&console.error("Different array lengths for targets ‚Äì please report a bug!",h);for(let d=0;d<h.length;d++){let u=h[d];if(!u){const p=d-(this.injectRestPoses?1:0);h[d]=new Ke(null,c,this.rootToRegisteredClip.get(n)[p]),u=h[d]}const f=u.getDuration();if(l[d]===void 0)l[d]=f;else if(l[d]!==f){console.error("Error during UDSZ export: Encountered different animation durations for animated targets. Please report a bug!",{datas:h,target:c}),l[d]=f;continue}}}}for(const n of this.serializers){const o=(e=n.model)==null?void 0:e.parent,r=(o==null?void 0:o.isDynamic)===!0;n_&&console.log(r,(i=n.model)==null?void 0:i.parent),r&&n.registerCallback(o)}}onExportObject(t,e,i){P.foreachComponent(t,o=>{const r=o;typeof r.createAnimation=="function"&&r.createAnimation(this,e,i)},!1);const n=new w2(t,this);this.serializers.push(n),n.registerCallback(e)}}class w2{constructor(t,e){a(this,"model");a(this,"object");a(this,"animationData");a(this,"ext");a(this,"callback");this.object=t,this.animationData=e.animationData,this.ext=e}registerCallback(t){this.model&&this.callback&&this.model.removeEventListener("serialize",this.callback),this.callback||(this.callback=this.onSerialize.bind(this)),n_&&console.log("REPARENT",t),this.model=t,this.callback&&this.model.addEventListener("serialize",this.callback)}skinnedMeshExport(t,e,i){var r;const n=this.model,o=this.animationData;if(n&&n.skinnedMesh){let p=function(A){const D=[];for(const[N,q]of A){let Y=`${N} : [`;const ie=[];for(const he of q)ie.push(`(${pe(he.x)}, ${pe(he.y)}, ${pe(he.z)})`);Y=Y.concat(ie.join(", ")),Y=Y.concat("],"),D.push(Y)}return D},g=function(A){const D=[];for(const[N,q]of A){let Y=`${N} : [`;const ie=[];for(const he of q)ie.push(`(${pe(he.w)}, ${pe(he.x)}, ${pe(he.y)}, ${pe(he.z)})`);Y=Y.concat(ie.join(", ")),Y=Y.concat("],"),D.push(Y)}return D},y=function(A){let D,N=!0;const q=new Map;for(const[ie,he]of A){D===void 0&&(D=he.length),D!==he.length&&(N=!1);let Pe=0;for(const He of he)Pe++,He||(q.has(ie)||q.set(ie,[]),q.get(ie).push(Pe))}Es&&console.log("Bone count: ",A.size,"TransformData entries per bone: ",D,"Undefined bone entries: ",q),console.assert(N,"All bones should have the same number of TransformData entries",A),console.assert(q.size===0,"All TransformData entries should be set",q);const Y=[];for(const[ie,he]of A)for(let Pe=0;Pe<he.length;Pe++){const He=he[Pe],gt=i.getStartTimeByClip(He.clip);Y.length<=Pe&&Y.push({pos:[],rot:[],scale:[],timeOffset:gt});const lt=Y[Pe];lt.pos.push(...He.getSortedTimesArray(!0,!1,!1)),lt.rot.push(...He.getSortedTimesArray(!1,!0,!1)),lt.scale.push(...He.getSortedTimesArray(!1,!1,!0))}for(const ie of Y)ie.pos.sort((he,Pe)=>he-Pe),ie.rot.sort((he,Pe)=>he-Pe),ie.scale.sort((he,Pe)=>he-Pe),ie.pos=[...new Set(ie.pos)],ie.rot=[...new Set(ie.rot)],ie.scale=[...new Set(ie.scale)];return Y},b=function(A,D,N){const q=new Map,Y=new Map,ie=new Map,he=D.length;for(const Pe of N){const He=A.get(Pe);let gt;He?console.assert(He.length===he,"We should have the same number of TransformData entries for each bone",He,D):gt=new Ke(null,Pe,null);for(let lt=0;lt<he;lt++){const ei=He?He[lt]:gt,_i=D[lt];for(const{time:bi,translation:fs}of ei.getValues(_i.pos,!0,!1,!1)){const Ee=(bi+_i.timeOffset)*60;q.has(Ee)||q.set(Ee,new Array),q.get(Ee).push(fs.clone())}for(const{time:bi,rotation:fs}of ei.getValues(_i.rot,!1,!0,!1)){const Ee=(bi+_i.timeOffset)*60;Y.has(Ee)||Y.set(Ee,new Array),Y.get(Ee).push(fs.clone())}for(const{time:bi,scale:fs}of ei.getValues(_i.scale,!1,!1,!0)){const Ee=(bi+_i.timeOffset)*60;ie.has(Ee)||ie.set(Ee,new Array),ie.get(Ee).push(fs.clone())}}}return{position:q.size==0?void 0:q,quaternion:Y.size==0?void 0:Y,scale:ie.size==0?void 0:ie}},_=function(A){const D=[];for(const N of A)D.push(`(${pe(N.x)}, ${pe(N.y)}, ${pe(N.z)})`);return D.join(", ")},v=function(A){const D=[];for(const N of A)D.push(`(${pe(N.w)}, ${pe(N.x)}, ${pe(N.y)}, ${pe(N.z)})`);return D.join(", ")},S=function(A){const D=new Map;if(Es){const N=new Array;for(const[q,Y]of o)N.push(q.uuid+": "+Y.length+" "+Y.map(ie=>{var he;return(he=ie.clip)==null?void 0:he.uuid.substring(0,6)}).join(" "));console.log(`getPerBoneTransformData
`+N.join(`
`))}for(const N of A){const q=o.get(N);q&&D.set(N,q)}return D},T=function(A){const D=S(A),N=y(D);return b(D,N,A)};const l=n.skinnedMesh.skeleton,c=new Array,h=[],d=[];for(const A of l.bones){h.push(A),d.push(A.uuid);const D=l.boneInverses[l.bones.indexOf(A)];c.push({bone:A,inverse:D})}let u=1e4;for(;d.length<l.bones.length&&u-- >0;)for(const A of h){const D=A.children;for(const N of D)if(d.indexOf(N.uuid)===-1&&l.bones.indexOf(N)!==-1){h.push(N),d.push(N.uuid);const q=l.boneInverses[l.bones.indexOf(N)];c.push({bone:N,inverse:q})}}u<=0&&console.error("Failed to sort bones in skinned mesh",n.skinnedMesh,l.bones,d);for(const A of d1(l.bones))c.push({bone:A,inverse:A.matrixWorld.clone().invert()});const f=c[0].bone.parent;f||console.error("No bone parent found for skinned mesh during USDZ export",n.skinnedMesh),c.sort((A,D)=>cc(A.bone,f)>cc(D.bone,f)?1:-1);const O=e.quickLookCompatible,M=[],k=[],B=[],I=[];for(const{bone:A}of c){if(O){const D=A.scale;D.x==0&&(D.x=1e-5),D.y==0&&(D.y=1e-5),D.z==0&&(D.z=1e-5),M.push(new le().compose(A.position,A.quaternion,A.scale))}else M.push(A.matrix.clone());k.push(A.position),B.push(A.quaternion),I.push(A.scale)}const E=c.map(A=>'"'+cc(A.bone,f)+'"').join(", "),L=c.map(A=>bx(A.inverse.clone().invert())).join(", ");t.beginBlock('def Skeleton "Rig"'),t.appendLine(`uniform matrix4d[] bindTransforms = [${L}]`),t.appendLine(`uniform token[] joints = [${E}]`),t.appendLine('uniform token purpose = "guide"'),t.appendLine(`uniform matrix4d[] restTransforms = [${M.map(A=>bx(A)).join(", ")}]`);const V=T(c.map(A=>A.bone));if(Es){let A=1e7,D=0;for(const N of((r=V.position)==null?void 0:r.keys())??[])A=Math.min(A,N),D=Math.max(D,N);console.log("Time samples",A,D,V)}if(t.beginBlock('def SkelAnimation "_anim"'),t.appendLine(`uniform token[] joints = [${E}]`),t.appendLine(`quatf[] rotations = [${v(B)}]`),V&&V.quaternion){t.beginBlock("quatf[] rotations.timeSamples = {","");const A=g(V.quaternion);for(const D of A)t.appendLine(D);t.closeBlock()}if(t.appendLine(`half3[] scales = [${_(I)}]`),V&&V.scale){t.beginBlock("half3[] scales.timeSamples = {","");const A=p(V.scale);for(const D of A)t.appendLine(D);t.closeBlock()}if(t.appendLine(`float3[] translations = [${_(k)}]`),V&&V.position){t.beginBlock("float3[] translations.timeSamples = {","");const A=p(V.position);for(const D of A)t.appendLine(D);t.closeBlock()}t.closeBlock(),t.closeBlock()}}onSerialize(t,e){if(!this.model)return;const i=this.animationData.get(this.object);if(i)for(let d=0;d<i.length;d++)i[d]===void 0&&(i[d]=new Ke(null,this.object,null));const n=this.ext;this.skinnedMeshExport(t,e,n);const o=this.object,r=this.model,l=this.animationData.get(o);if(!l||o.isSkinnedMesh)return;n_&&console.log("SERIALIZE",this.model.name,this.object.type,l);const c=Intl.NumberFormat("en-US",{maximumFractionDigits:3,minimumFractionDigits:0,useGrouping:!1});function h(d,u){var p;if(d.some(g=>g&&{position:g.pos,rotation:g.rot,scale:g.scale}[u])){switch(u){case"position":r.needsTranslate=!0,t.beginBlock("double3 xformOp:translate.timeSamples = {","");break;case"rotation":r.needsOrient=!0,t.beginBlock("quatf xformOp:orient.timeSamples = {","");break;case"scale":r.needsScale=!0,t.beginBlock("double3 xformOp:scale.timeSamples = {","");break}for(let g=0;g<d.length;g++){const y=d[g];if(!y)continue;const b=n.getStartTimeByClip(y.clip),_=y.getSortedTimesArray(u==="position",u==="rotation",u==="scale");if(!_||_.length===0){console.error("got an animated object but no time values?",o,y);continue}const v=!y.clip,S=u==="position"&&(y.pos||v),T=u==="rotation"&&(y.rot||v),O=u==="scale"&&(y.scale||v);if(S||T||O){const M=((p=y.clip)==null?void 0:p.name)??"rest",k=y.getDuration();Es&&console.log("Write .timeSamples:",M,b,k,d),t.appendLine("# "+M+": start="+c.format(b*Ke.frameRate)+", length="+c.format(k*Ke.frameRate)+", frames="+y.getFrames())}if(S)for(const{time:M,translation:k}of y.getValues(_,!0,!1,!1)){const I=`${c.format((b+M)*Ke.frameRate)}: (${pe(k.x)}, ${pe(k.y)}, ${pe(k.z)}),`;t.appendLine(I)}if(T)for(const{time:M,rotation:k}of y.getValues(_,!1,!0,!1)){const I=`${c.format((b+M)*Ke.frameRate)}: (${pe(k.w)}, ${pe(k.x)}, ${pe(k.y)}, ${pe(k.z)}),`;t.appendLine(I)}if(O)for(const{time:M,scale:k}of y.getValues(_,!1,!1,!0)){const I=`${c.format((b+M)*Ke.frameRate)}: (${pe(k.x)}, ${pe(k.y)}, ${pe(k.z)}),`;t.appendLine(I)}}t.closeBlock()}}h(l,"position"),h(l,"rotation"),h(l,"scale")}}C("debugusdz");const Jb=class{constructor(t,e,i){a(this,"id");a(this,"trigger");a(this,"action");a(this,"exclusive",!1);this.id="Behavior_"+Qs(t)+"_"+Jb.global_id++,this.trigger=e,this.action=i}makeExclusive(t){return this.exclusive=t,this}writeTo(t,e,i){if(!this.trigger||!this.action)return;i.beginBlock(`def Preliminary_Behavior "${this.id}"`);let n="";if(Array.isArray(this.trigger)){n="[";for(let o=0;o<this.trigger.length;o++){const r=this.trigger[o];n+="<"+r.id+">",o+1<this.trigger.length&&(n+=", ")}n+="]"}else n=`<${this.trigger.id}>`;if(i.appendLine(`rel triggers = ${n}`),i.appendLine(`rel actions = <${this.action.id}>`),i.appendLine(`uniform bool exclusive = ${this.exclusive?1:0}`),i.appendLine(),Array.isArray(this.trigger))for(const o of this.trigger)o.writeTo(e,i),i.appendLine();else this.trigger.writeTo(e,i);i.appendLine(),this.action.writeTo(e,i),i.closeBlock()}};let Bt=Jb;a(Bt,"global_id",0);const Pl=new Set;function s_(s,t){var i,n;let e="";if(Array.isArray(s)){Pl.clear();let o="[ ";for(let r=0;r<s.length;r++){let l=s[r];if(!l){console.warn("Invalid target object in behavior",s+". Is the object exported?");continue}if(typeof l=="string"){if(Pl.has(l))continue;o+=l,Pl.add(l)}else if(typeof l=="object"){if(l.isObject3D&&(l=t.findById(l.uuid),!l)){console.warn("Invalid target object in behavior",s+". Is the object exported?");continue}const c=(i=l.getPath)==null?void 0:i.call(l);if(Pl.has(c))continue;o+=c,Pl.add(c)}r+1<s.length&&(o+=", ")}o+=" ]",e=o,Pl.clear()}else if(typeof s=="object"){const o=s;if(o.isObject3D&&(s=t.findById(o.uuid)),!s)throw console.error("Invalid target object in behavior, the target object is likely missing from USDZ export. Is the object exported?",o),new Error(`Invalid target object in behavior, the target object is likely missing from USDZ export. Please report a bug. uuid: ${o.uuid}.`);e=(n=s.getPath)==null?void 0:n.call(s)}return e}const Zb=class{constructor(t,e){a(this,"id");a(this,"targetId");a(this,"tokenId");a(this,"type");a(this,"distance");t&&(this.targetId=t),e?this.id=e:this.id="Trigger_"+Zb.global_id++}writeTo(t,e){e.beginBlock(`def Preliminary_Trigger "${this.id}"`),this.targetId&&(typeof this.targetId!="string"&&(this.targetId=s_(this.targetId,t)),e.appendLine("rel affectedObjects = "+this.targetId)),this.tokenId&&e.appendLine(`token info:id = "${this.tokenId}"`),this.type&&e.appendLine(`token type = "${this.type}"`),typeof this.distance=="number"&&e.appendLine(`double distance = ${this.distance}`),e.closeBlock()}};let Lo=Zb;a(Lo,"global_id",0);function Sx(s,t={direct:!0,indirect:!0}){const e=hi.createEmpty();e.name="InputTarget_"+e.name,e.displayName=void 0,e.type="RealityKitComponent",e.onSerialize=i=>{i.appendLine("bool allowsDirectInput = "+(t.direct?1:0)),i.appendLine("bool allowsIndirectInput = "+(t.indirect?1:0)),i.appendLine('uniform token info:id = "RealityKit.InputTarget"')},s.add(e)}class Qt{static sceneStartTrigger(){if(this.__sceneStartTrigger!==void 0)return this.__sceneStartTrigger;const t=new Lo(void 0,"SceneStart");return t.tokenId="SceneTransition",t.type="enter",this.__sceneStartTrigger=t,t}static tapTrigger(t,e={direct:!0,indirect:!0}){const i=new Lo(t);if(Array.isArray(t)&&t.length>1)for(const n of t)n instanceof hi&&Sx(n,e);else t instanceof hi&&Sx(t,e);return i.tokenId="TapGesture",i}static isTapTrigger(t){return(t==null?void 0:t.tokenId)==="TapGesture"}static proximityToCameraTrigger(t,e){const i=new Lo(t);return i.tokenId="ProximityToCamera",i.distance=e,i}}a(Qt,"__sceneStartTrigger");class kr{constructor(t,e){a(this,"id");a(this,"actions");a(this,"loops",0);a(this,"performCount",1);a(this,"type","serial");a(this,"multiplePerformOperation");this.id=t,this.actions=e}static getId(){return this.global_id++}addAction(t){return this.actions.push(t),this}makeParallel(){return this.type="parallel",this}makeSequence(){return this.type="serial",this}makeLooping(){return this.loops=1,this.performCount=0,this}makeRepeat(t){return this.performCount=t,this}writeTo(t,e){e.beginBlock(`def Preliminary_Action "${this.id}"`),e.beginArray("rel actions");for(const i of this.actions){if(!i)continue;const n=i===this.actions[this.actions.length-1];e.appendLine("<"+i.id+">"+(n?"":", "))}e.closeArray(),e.appendLine(),e.appendLine('token info:id = "Group"'),e.appendLine(`bool loops = ${this.loops}`),e.appendLine(`int performCount = ${this.loops>0?0:Math.max(0,this.performCount)}`),e.appendLine(`token type = "${this.type}"`),typeof this.multiplePerformOperation=="string"&&e.appendLine(`token multiplePerformOperation = "${this.multiplePerformOperation}"`),e.appendLine();for(const i of this.actions)i&&(i.writeTo(t,e),e.appendLine());e.closeBlock()}}a(kr,"global_id",0);const fp=class{constructor(t,e){a(this,"id");a(this,"tokenId");a(this,"affectedObjects");a(this,"easeType");a(this,"motionType");a(this,"duration");a(this,"moveDistance");a(this,"style");a(this,"type");a(this,"front");a(this,"up");a(this,"start");a(this,"animationSpeed");a(this,"reversed");a(this,"pingPong");a(this,"xFormTarget");a(this,"audio");a(this,"gain");a(this,"auralMode");a(this,"multiplePerformOperation");a(this,"velocity");a(this,"comment");a(this,"animationName");t&&(this.affectedObjects=t),e?this.id=e:this.id="Action",this.id+="_"+fp.global_id++}clone(){const t=new fp,e=t.id;return Object.assign(t,this),t.id=e,t}writeTo(t,e){e.beginBlock(`def Preliminary_Action "${this.id}"`),this.comment&&e.appendLine(`# ${this.comment}`),this.affectedObjects&&(typeof this.affectedObjects!="string"&&(this.affectedObjects=s_(this.affectedObjects,t)),e.appendLine("rel affectedObjects = "+this.affectedObjects)),typeof this.duration=="number"&&(typeof this.animationSpeed=="number"&&this.animationSpeed!==1?e.appendLine(`double duration = ${this.duration/this.animationSpeed} `):e.appendLine(`double duration = ${this.duration} `)),this.easeType&&e.appendLine(`token easeType = "${this.easeType}"`),this.tokenId&&e.appendLine(`token info:id = "${this.tokenId}"`),this.tokenId==="ChangeScene"&&e.appendLine("rel scene = </StageRoot/Scenes/Scene>"),this.motionType!==void 0&&e.appendLine(`token motionType = "${this.motionType}"`),typeof this.moveDistance=="number"&&e.appendLine(`double moveDistance = ${this.moveDistance} `),this.style&&e.appendLine(`token style = "${this.style}"`),this.type&&e.appendLine(`token type = "${this.type}"`),this.front&&e.appendLine(`vector3d front = (${this.front.x}, ${this.front.y}, ${this.front.z})`),this.up&&e.appendLine(`vector3d upVector = (${this.up.x}, ${this.up.y}, ${this.up.z})`),typeof this.start=="number"&&e.appendLine(`double start = ${this.start} `),typeof this.animationSpeed=="number"&&e.appendLine(`double animationSpeed = ${this.animationSpeed.toFixed(2)} `),typeof this.reversed=="boolean"&&e.appendLine(`bool reversed = ${this.reversed}`),typeof this.pingPong=="boolean"&&e.appendLine(`bool reverses = ${this.pingPong}`),this.xFormTarget&&(typeof this.xFormTarget!="string"&&(this.xFormTarget=s_(this.xFormTarget,t)),e.appendLine(`rel xformTarget = ${this.xFormTarget}`)),typeof this.audio=="string"&&e.appendLine(`asset audio = @${this.audio}@`),typeof this.gain=="number"&&e.appendLine(`double gain = ${this.gain}`),typeof this.auralMode=="string"&&e.appendLine(`token auralMode = "${this.auralMode}"`),typeof this.multiplePerformOperation=="string"&&e.appendLine(`token multiplePerformOperation = "${this.multiplePerformOperation}"`),typeof this.velocity=="object"&&e.appendLine(`vector3d velocity = (${this.velocity.x}, ${this.velocity.y}, ${this.velocity.z})`),e.closeBlock()}};let Ni=fp;a(Ni,"global_id",0);class kn{constructor(t,e,i){a(this,"x",0);a(this,"y",0);a(this,"z",0);this.x=t,this.y=e,this.z=i}static get up(){return new kn(0,1,0)}static get right(){return new kn(1,0,0)}static get forward(){return new kn(0,0,1)}static get back(){return new kn(0,0,-1)}static get zero(){return new kn(0,0,0)}}class we{static sequence(...t){return new kr("Group_"+kr.getId(),t).makeSequence()}static parallel(...t){return new kr("Group_"+kr.getId(),t).makeParallel()}static fadeAction(t,e,i){const n=new Ni(t);return n.tokenId="Visibility",n.type=i?"show":"hide",n.duration=e,n.style="basic",n.motionType="none",n.moveDistance=0,n.easeType="none",n}static startAnimationAction(t,e,i=!1,n=!1){const o=new Ni(t);o.tokenId="StartAnimation";const r=e.start,l=e.duration,c=e.speed,h=e.clipName;if(o.comment=`Animation: ${h}, start=${r*60}, length=${l*60}, end=${(r+l)*60}`,o.animationName=h,o.start=r,o.duration=l,o.animationSpeed=c,o.reversed=i,o.pingPong=n,o.multiplePerformOperation="allow",i&&(o.start-=l),n){o.pingPong=!1;const d=o.clone();return d.reversed=!i,d.start=o.start,d.reversed&&(d.start-=l),we.sequence(o,d)}return o}static waitAction(t){const e=new Ni;return e.tokenId="Wait",e.duration=t,e.motionType=void 0,e}static lookAtCameraAction(t,e,i,n){const o=new Ni(t);return o.tokenId="LookAtCamera",o.duration=e===void 0?9999999999999:e,o.front=i??kn.forward,o.up=n??kn.up,o}static emphasize(t,e,i="bounce",n=1,o="basic"){const r=new Ni(t);return r.tokenId="Emphasize",r.duration=e,r.style=o??"basic",r.motionType=i,r.moveDistance=n,r}static transformAction(t,e,i,n,o="inout"){const r=new Ni(t);return r.tokenId="Transform",r.duration=i,r.duration=Math.max(1e-6,i),r.type=n,r.easeType=i>0?o:"none",Array.isArray(e)&&console.error("Transform target must not be an array",e),r.xFormTarget=e,r}static playAudioAction(t,e,i="play",n=1,o="spatial"){const r=new Ni(t);return r.tokenId="Audio",r.type=i,r.audio=e,r.gain=n,r.auralMode=o,r.multiplePerformOperation="allow",r}static impulseAction(t,e){const i=new Ni(t);return i.tokenId="Impulse",i.velocity=e,i}}class S2{constructor(t){a(this,"object");a(this,"model");this.object=t}get id(){return this.object.uuid}apply(t){if(!this.model&&(this.model=t.findById(this.object.uuid),!this.model)){console.error("could not find model with id "+this.object.uuid);return}this.onApply(t)}}class b1 extends S2{constructor(e,i,n,o){super(e);a(this,"matrix");a(this,"material");a(this,"geometry");a(this,"_enableAction");a(this,"_disableAction");this.matrix=i,this.material=n,this.geometry=o}onApply(e){var o,r;const i=this.model;if(!i)return;(o=i.parent)!=null&&o.isDynamic||hi.createEmptyParent(i);const n=i.clone();this.matrix&&n.setMatrix(this.matrix),this.material&&(n.material=this.material),this.geometry&&(n.geometry=this.geometry),(r=i.parent)==null||r.add(n)}enable(){return this._enableAction?this._enableAction:(this._enableAction=we.fadeAction(this.object,0,!0),this._enableAction)}disable(){return this._disableAction?this._disableAction:(this._disableAction=we.fadeAction(this.object,0,!1),this._disableAction)}}class v1{constructor(t){a(this,"actions");a(this,"sortedActions");this.actions=[...t]}organize(){this.sortedActions={};for(const t of this.actions){const e=t.id;this.sortedActions[e]||(this.sortedActions[e]=[]),this.sortedActions[e].push(t)}}getActions(t){return this.sortedActions||this.organize(),this.sortedActions[t.uuid]}}const C2=C("debugusdz");class rl{constructor(){a(this,"files",new Array)}static getName(t){var o;const e=t.split(".").pop();let n=(o=t.split(".").slice(0,-1).join(".").split("/").pop())==null?void 0:o.replace(".","_");return n||(n="Audio_"+Math.random().toString(36).substring(2,15)),Qs(n)+"."+e}get extensionName(){return"Audio"}onExportObject(t,e,i){const n=P.getComponents(t,Oe);if(n.length)for(const o of n){if(!o.clip||typeof o.clip!="string"||!o.playOnAwake)continue;const r=o.clip.split("/").pop()||"Audio",l=rl.getName(o.clip),c=Qs(l);if(!this.files.some(h=>h.path===o.clip)){this.files.push({path:o.clip,name:l});const h=l.toLowerCase();i.quickLookCompatible&&!h.endsWith(".mp3")&&!h.endsWith(".wav")&&!h.endsWith(".m4a")&&console.error("Audio file "+o.clip+" from "+o.name+" is not an MP3 or WAV file. QuickLook may not support playing it.")}i.quickLookCompatible||e.addEventListener("serialize",(h,d)=>{h.appendLine(),h.beginBlock(`def SpatialAudio "${c}"`,"(",!1),h.appendLine(`displayName = "${r}"`),h.closeBlock(")"),h.beginBlock(),h.appendLine(`uniform asset filePath = @audio/${l}@`),h.appendLine(`uniform token auralMode = "${o.spatialBlend>0?"spatial":"nonSpatial"}"`),h.appendLine(`uniform token playbackMode = "${o.loop?"loopFromStage":"onceFromStart"}"`),h.appendLine(`uniform float gain = ${o.volume}`),h.closeBlock()})}}async onAfterSerialize(t){for(const e of this.files){const i="audio/"+e.name;if(t.files[i]){C2&&console.warn("Audio file with name "+i+" already exists in the context. Skipping.");continue}const r=await(await(await fetch(e.path)).blob()).arrayBuffer(),l=new Uint8Array(r);t.files[i]=l}}}const Bu=C("debugusdzbehaviours");class yb{constructor(){a(this,"behaviours",[]);a(this,"behaviourComponents",[]);a(this,"behaviourComponentsCopy",[]);a(this,"audioClips",[]);a(this,"audioClipsCopy",[]);a(this,"targetUuids",new Set)}get extensionName(){return"Behaviour"}addBehavior(t){this.behaviours.push(t)}addAudioClip(t){if(!t||typeof t!="string")return"";const i="audio/"+rl.getName(t);return this.audioClips.push({clipUrl:t,filesKey:i}),i}getAllTargetUuids(){return this.targetUuids}onBeforeBuildDocument(t){if(!t.root)return Promise.resolve();const e=[];return t.root.traverse(i=>{P.foreachComponent(i,n=>{var r;const o=n;if(typeof o.createBehaviours=="function"||typeof o.beforeCreateDocument=="function"||typeof o.afterCreateDocument=="function"||typeof o.afterSerialize=="function"){this.behaviourComponents.push(o);const l=(r=o.beforeCreateDocument)==null?void 0:r.call(o,this,t);l instanceof Promise&&e.push(l)}},!1)}),Bu&&console.log("onBeforeBuildDocument: all components",this.behaviourComponents),Promise.all(e)}onExportObject(t,e,i){var n;for(const o of this.behaviourComponents)(n=o.createBehaviours)==null||n.call(o,this,e,i)}onAfterBuildDocument(t){for(const u of this.behaviourComponents)typeof u.afterCreateDocument=="function"&&u.afterCreateDocument(this,t);this.behaviourComponentsCopy=this.behaviourComponents.slice(),this.behaviourComponents.length=0,this.audioClipsCopy=this.audioClips.slice(),this.audioClips.length=0;const e=new Set,i=new Set,n=new Set,o=new Set,r=Bu;let l=`graph LR
`,c="";function h(u){if(u instanceof kr){r&&(l+=`subgraph Group_${u.id}
`);for(const f of u.actions)r&&(l+=`${u.id}[${u.id}] -- ${u.type},loops:${u.loops} --> ${f.id}[${f.id}]
`),h(f);r&&(l+=`end
`)}else if(u instanceof Ni){u.tokenId==="StartAnimation"&&o.add(u);let f=u.tokenId;u.type!==void 0&&(f+=":"+u.type);const p=u.affectedObjects;if(p)if(Array.isArray(p))for(const y of p)i.add(y),r&&(c+=`${u.id}[${u.id}
${f}] -- ${f} --> ${y.uuid}(("${y.displayName||y.name||y.uuid}"))
`);else typeof p=="object"?(i.add(p),r&&(c+=`${u.id}[${u.id}
${f}] -- ${f} --> ${p.uuid}(("${p.displayName||p.name||p.uuid}"))
`)):typeof p=="string"&&i.add({uuid:p});const g=u.xFormTarget;g&&(typeof g=="object"?(i.add(g),r&&(c+=`${u.id}[${u.id}
${f}] -- ${f} --> ${g.uuid}(("${g.displayName||g.name||g.uuid}"))
`)):typeof g=="string"&&i.add({uuid:g}))}}function d(u,f){if(Array.isArray(u))for(const p of u)d(p,f);else if(u instanceof Lo){let p=u.tokenId;u.type!==void 0&&(p+=":"+u.type),typeof u.targetId=="object"&&(e.add(u.targetId),r&&(c+=`${u.targetId.uuid}(("${u.targetId.displayName}")) --> ${u.id}[${u.id}
${p}]
`)),r&&(l+=`${u.id}((${u.id})) -- ${p} --> ${f.id}[${f.tokenId||f.id}]
`)}}for(const u of this.behaviours)r&&(l+=`subgraph ${u.id}
`),h(u.action),d(u.trigger,u.action),r&&(l+=`end
`);r&&(l+=`
`+c),r&&(console.log("All USDZ behaviours",this.behaviours),this.behaviours.length&&(console.warn("The Mermaid graph can be pasted into https://massive-mermaid.glitch.me/ or https://mermaid.live/edit. It should be in your clipboard already!"),console.log(l),navigator.clipboard.writeText(l)));{let u=`gantt
title Animations
dateFormat X
axisFormat %s
`;const f=Array.from(o),p=new Set;for(const _ of f)if(_.affectedObjects&&typeof _.affectedObjects!="string"){if(Array.isArray(_.affectedObjects))for(const v of _.affectedObjects)p.add(v);else p.add(_.affectedObjects);r&&(u+=`section ${_.animationName} (${_.id})
`,u+=`${_.id} : ${_.start}, ${_.duration}s
`)}r&&o.size&&console.log(u);const g=new Set;for(const _ of p){_.getPath||console.error("USDZExporter: Animation target object has no getPath method. This is likely a bug",_);let v=_.getPath();v.startsWith("<")&&(v=v.substring(1)),v.endsWith(">")&&(v=v.substring(0,v.length-1)),g.add({path:v,obj:_})}const y=Array.from(g).sort((_,v)=>_.path.length-v.path.length),b=new Array;for(let _=0;_<y.length;_++)for(let v=_+1;v<y.length;v++)if(y[v].path.startsWith(y[_].path)){const S=y[v],T=y[_];b.push({child:S.obj.displayName+" ("+S.path+")",parent:T.obj.displayName+" ("+T.path+")"})}b.length&&console.warn("USDZExporter: There are overlapping PlayAnimation actions. This can lead to undefined runtime behaviour when playing multiple animations. Please restructure the hierarchy so that animations don't overlap.",{overlappingTargets:b,playAnimationActions:o})}for(const u of new Set([...e,...i]))if(Array.isArray(u))for(const f of u)n.add(f.uuid);else n.add(u.uuid);Bu&&console.log("All Behavior trigger sources and action targets",e,i,n),this.targetUuids=new Set(n)}onAfterHierarchy(t,e){var i;if((i=this.behaviours)!=null&&i.length){e.beginBlock('def Scope "Behaviors"');for(const n of this.behaviours)n.writeTo(this,t.document,e);e.closeBlock()}}async onAfterSerialize(t){Bu&&console.log("onAfterSerialize behaviours",this.behaviourComponentsCopy);for(const e of this.behaviourComponentsCopy)typeof e.afterSerialize=="function"&&(e.afterSerialize.constructor.name==="AsyncFunction"?await e.afterSerialize(this,t):e.afterSerialize(this,t));for(const{clipUrl:e,filesKey:i}of this.audioClipsCopy){if(t.files[i])return;const r=await(await(await fetch(e)).blob()).arrayBuffer(),l=new Uint8Array(r);t.files[i]=l}this.behaviourComponentsCopy.length=0,this.audioClipsCopy.length=0}}var nt=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const Cx=C("debugusdzbehaviours");function qd(s){s&&(s.getComponentInParent(Oc)||(U()&&console.debug('Raycaster on "'+s.name+'" was automatically added, because no raycaster was found in the parent hierarchy.'),s.addComponent(jn)))}class zc extends j{constructor(){super(...arguments);a(this,"object");a(this,"target");a(this,"duration",1);a(this,"relativeMotion",!1);a(this,"coroutine",null);a(this,"targetPos",new x);a(this,"targetRot",new H);a(this,"targetScale",new x)}start(){qd(this.gameObject)}onPointerClick(e){e.use(),this.coroutine&&this.stopCoroutine(this.coroutine),this.relativeMotion?this.coroutine=this.startCoroutine(this.moveRelative()):this.coroutine=this.startCoroutine(this.moveToTarget())}*moveToTarget(){if(!this.target||!this.object)return;const e=ae(this.object).clone(),i=ae(this.target).clone(),n=Le(this.object).clone(),o=Le(this.target).clone(),r=pt(this.object).clone(),l=pt(this.target).clone(),c=e.distanceTo(i),h=n.angleTo(o),d=r.distanceTo(l);if(c<.01&&h<.01&&d<.01){jt(this.object,i),as(this.object,o),xd(this.object,l),this.coroutine=null;return}let u=0,f=0;for(;u<1;)u+=this.context.time.deltaTime/this.duration,u>1&&(u=1),f=u<.5?4*u*u*u:1-Math.pow(-2*u+2,3)/2,this.targetPos.lerpVectors(e,i,f),this.targetRot.slerpQuaternions(n,o,f),this.targetScale.lerpVectors(r,l,f),jt(this.object,this.targetPos),as(this.object,this.targetRot),xd(this.object,this.targetScale),yield;this.coroutine=null}*moveRelative(){if(!this.target||!this.object)return;const e=this.object.position.clone(),i=this.object.quaternion.clone(),n=this.object.scale.clone(),o=this.target.position.clone(),r=this.target.quaternion.clone(),l=this.target.scale.clone();o.applyQuaternion(this.object.quaternion),this.targetPos.copy(this.object.position).add(o),this.targetRot.copy(this.object.quaternion).multiply(r),this.targetScale.copy(this.object.scale).multiply(l);let c=0,h=0;for(;c<1;)c+=this.context.time.deltaTime/this.duration,c>1&&(c=1),h=c<.5?4*c*c*c:1-Math.pow(-2*c+2,3)/2,this.object.position.lerpVectors(e,this.targetPos,h),this.object.quaternion.slerpQuaternions(i,this.targetRot,h),this.object.scale.lerpVectors(n,this.targetScale,h),yield;this.coroutine=null}beforeCreateDocument(e){var i;if(this.target&&this.object&&this.gameObject){const n=new Bt("Move to "+((i=this.target)==null?void 0:i.name),Qt.tapTrigger(this.gameObject),we.transformAction(this.object,this.target,this.duration,this.relativeMotion?"relative":"absolute"));e.addBehavior(n)}}}nt([m(F)],zc.prototype,"object",void 0);nt([m(F)],zc.prototype,"target",void 0);nt([m()],zc.prototype,"duration",void 0);nt([m()],zc.prototype,"relativeMotion",void 0);const oi=class extends j{constructor(){super(...arguments);a(this,"materialToSwitch");a(this,"variantMaterial");a(this,"fadeDuration",0);a(this,"_objectsWithThisMaterial",null);a(this,"selfModel");a(this,"targetModels")}start(){var e;this._objectsWithThisMaterial=this.objectsWithThisMaterial,qd(this.gameObject),U()&&this._objectsWithThisMaterial.length<=0&&console.warn('ChangeMaterialOnClick: No objects found with material "'+((e=this.materialToSwitch)==null?void 0:e.name)+'"')}onPointerEnter(e){this.context.input.setCursor("pointer")}onPointerExit(e){this.context.input.unsetCursor("pointer")}onPointerClick(e){if(e.use(),!!this.variantMaterial)for(let i=0;i<this.objectsWithThisMaterial.length;i++){const n=this.objectsWithThisMaterial[i];n.material=this.variantMaterial}}get objectsWithThisMaterial(){return this._objectsWithThisMaterial!=null?this._objectsWithThisMaterial:(this._objectsWithThisMaterial=[],this.variantMaterial&&this.materialToSwitch&&this.context.scene.traverse(e=>{if(e instanceof Z)if(Array.isArray(e.material)){for(const i of e.material)if(i===this.materialToSwitch){this.objectsWithThisMaterial.push(e);break}}else e.material===this.materialToSwitch?this.objectsWithThisMaterial.push(e):bE(e.material,this.materialToSwitch)&&this.objectsWithThisMaterial.push(e)}),this._objectsWithThisMaterial)}async beforeCreateDocument(e,i){this.targetModels=[],oi._materialTriggersPerId={},oi.variantSwitchIndex=0,this.materialToSwitch&&await mt.assignTextureLOD(this.materialToSwitch,0),this.variantMaterial&&await mt.assignTextureLOD(this.variantMaterial,0)}createBehaviours(e,i,n){this.objectsWithThisMaterial.find(r=>r.uuid===i.uuid)&&this.targetModels.push(i),this.gameObject.uuid===i.uuid&&(this.selfModel=i,this.materialToSwitch&&(oi._materialTriggersPerId[this.materialToSwitch.uuid]||(oi._materialTriggersPerId[this.materialToSwitch.uuid]=[]),oi._materialTriggersPerId[this.materialToSwitch.uuid].push(this)))}afterCreateDocument(e,i){if(!this.materialToSwitch)return;const n=oi._materialTriggersPerId[this.materialToSwitch.uuid];if(n){const o={};for(const r of n){const l=r.createVariants();l&&l.length>0&&(o[r.selfModel.uuid]=l)}for(const r of n){const l=[];for(const c in o)c!==r.selfModel.uuid&&l.push(...o[c]);r.createAndAttachBehaviors(e,o[r.selfModel.uuid],l)}}delete oi._materialTriggersPerId[this.materialToSwitch.uuid]}createAndAttachBehaviors(e,i,n){const o=[],r=Math.max(0,this.fadeDuration);o.push(we.fadeAction([...this.targetModels,...n],r,!1)),o.push(we.fadeAction(i,r,!0)),e.addBehavior(new Bt("Select_"+this.selfModel.name,Qt.tapTrigger(this.selfModel),we.parallel(...o))),oi._parallelStartHiddenActions.push(...i),oi._startHiddenBehaviour||(oi._startHiddenBehaviour=new Bt("StartHidden_"+this.selfModel.name,Qt.sceneStartTrigger(),we.fadeAction(oi._parallelStartHiddenActions,r,!1)),e.addBehavior(oi._startHiddenBehaviour))}static getMaterialName(e){return Qs(e.name||"Material")+"_"+e.id}createVariants(){if(!this.variantMaterial)return null;const e=[];for(const i of this.targetModels){const n=i.clone();n.name+="_Variant_"+oi.variantSwitchIndex+++"_"+oi.getMaterialName(this.variantMaterial),n.displayName=n.displayName+": Variant with material "+this.variantMaterial.name,n.material=this.variantMaterial,n.geometry=i.geometry,n.transform=i.transform,(!i.parent||!i.parent.isEmpty())&&hi.createEmptyParent(i),i.parent&&i.parent.add(n),e.push(n)}return e}};let Yn=oi;a(Yn,"_materialTriggersPerId",{}),a(Yn,"_startHiddenBehaviour",null),a(Yn,"_parallelStartHiddenActions",[]),a(Yn,"variantSwitchIndex",0);nt([m(De)],Yn.prototype,"materialToSwitch",void 0);nt([m(De)],Yn.prototype,"variantMaterial",void 0);nt([m()],Yn.prototype,"fadeDuration",void 0);const Ye=class extends j{constructor(){super(...arguments);a(this,"target");a(this,"toggleOnClick",!1);a(this,"targetState",!0);a(this,"hideSelf",!0);a(this,"selfModel");a(this,"selfModelClone");a(this,"targetModel");a(this,"toggleModel");a(this,"stateBeforeCreatingDocument",!1);a(this,"targetStateBeforeCreatingDocument",!1)}start(){qd(this.gameObject)}onPointerClick(e){e.use(),!this.toggleOnClick&&this.hideSelf&&(this.gameObject.visible=!1),this.target&&(this.target.visible=this.toggleOnClick?!this.target.visible:this.targetState)}createBehaviours(e,i,n){i.uuid===this.gameObject.uuid&&(this.selfModel=i,this.selfModelClone=i.clone())}beforeCreateDocument(){this.target&&(this.gameObject[Ye.wasVisible]===void 0&&(this.gameObject[Ye.wasVisible]=this.gameObject.activeSelf),this.target[Ye.wasVisible]===void 0&&(this.target[Ye.wasVisible]=this.target.activeSelf),this.stateBeforeCreatingDocument=this.gameObject[Ye.wasVisible],this.targetStateBeforeCreatingDocument=this.target[Ye.wasVisible],this.gameObject.visible=!0,this.target.visible=!0)}afterCreateDocument(e,i){if(!this.target)return;this.targetModel=i.document.findById(this.target.uuid);const n=this.selfModel;if(this.selfModel&&this.targetModel){let o=this.selfModel,r=this.targetState;if(this.toggleOnClick)if(r=!this.targetStateBeforeCreatingDocument,!this.selfModelClone.geometry)(!this.selfModel.parent||this.selfModel.parent.isEmpty())&&u1.createEmptyParent(this.selfModel),this.toggleModel=this.selfModel.deepClone(),this.toggleModel.name+="_toggle",this.selfModel.parent.add(this.toggleModel);else{if(!this.gameObject[Ye.toggleClone]){const h=this.selfModelClone.clone();h.setMatrix(new le),h.name+="_toggle"+Ye.clonedToggleIndex++,n.add(h),this.gameObject[Ye.toggleClone]=h,console.warn("USDZExport: Toggle "+this.gameObject.name+" doesn't have geometry. It will be deep cloned and nested behaviours will likely not work.")}const c=this.gameObject[Ye.toggleClone];if(!this.gameObject[Ye.reverseToggleClone]){const h=this.selfModelClone.clone();h.setMatrix(new le),h.name+="_toggleReverse"+Ye.clonedToggleIndex++,n.add(h),this.gameObject[Ye.reverseToggleClone]=h}this.toggleModel=this.gameObject[Ye.reverseToggleClone],(!this.toggleModel.geometry||!c.geometry)&&console.error("triggers without childs and without geometry won't work!",this,n.geometry),o=c,n.geometry=null,n.material=null}if(this.toggleModel){if(this.toggleOnClick){const c=[];c.push(we.fadeAction(o,0,!1)),c.push(we.fadeAction(this.toggleModel,0,!0)),c.push(we.fadeAction(this.targetModel,0,r)),e.addBehavior(new Bt("Toggle_"+o.name+"_ToggleTo"+(r?"On":"Off"),Qt.tapTrigger(o),we.parallel(...c)));const h=[];h.push(we.fadeAction(this.toggleModel,0,!1)),h.push(we.fadeAction(o,0,!0)),h.push(we.fadeAction(this.targetModel,0,!r)),e.addBehavior(new Bt("Toggle_"+o.name+"_ToggleTo"+(r?"Off":"On"),Qt.tapTrigger(this.toggleModel),we.parallel(...h)))}}else{const c=[];this.hideSelf&&c.push(we.fadeAction(o,0,!1)),c.push(we.fadeAction(this.targetModel,0,r)),e.addBehavior(new Bt("Toggle_"+o.name+"_ToggleTo"+(r?"On":"Off"),Qt.tapTrigger(o),c.length>1?we.parallel(...c):c[0]))}const l=new Array;this.targetStateBeforeCreatingDocument||l.push(this.targetModel),this.stateBeforeCreatingDocument||l.push(n),this.toggleModel&&l.push(this.toggleModel),Ra.add(l,e)}}afterSerialize(e,i){this.gameObject[Ye.wasVisible]!==void 0&&(this.gameObject.visible=this.gameObject[Ye.wasVisible],delete this.gameObject[Ye.wasVisible]),this.target&&this.target[Ye.wasVisible]!==void 0&&(this.target.visible=this.target[Ye.wasVisible],delete this.target[Ye.wasVisible]),delete this.gameObject[Ye.toggleClone],delete this.gameObject[Ye.reverseToggleClone]}};let Pn=Ye;a(Pn,"clonedToggleIndex",0),a(Pn,"wasVisible",Symbol("usdz_SetActiveOnClick_wasVisible")),a(Pn,"toggleClone",Symbol("clone for toggling")),a(Pn,"reverseToggleClone",Symbol("clone for reverse toggling"));nt([m(F)],Pn.prototype,"target",void 0);nt([m()],Pn.prototype,"toggleOnClick",void 0);nt([m()],Pn.prototype,"targetState",void 0);nt([m()],Pn.prototype,"hideSelf",void 0);const go=class extends j{constructor(){super(...arguments);a(this,"wasVisible",!1)}static add(e,i){const n=Array.isArray(e)?e:[e];for(const o of n)go._fadeObjects.includes(o)||(console.log("adding hide on start",o),go._fadeObjects.push(o));go._fadeBehaviour===void 0&&(go._fadeBehaviour=new Bt("HideOnStart",Qt.sceneStartTrigger(),we.fadeAction(go._fadeObjects,0,!1)),i.addBehavior(go._fadeBehaviour))}start(){P.setActive(this.gameObject,!1)}createBehaviours(e,i,n){i.uuid===this.gameObject.uuid&&(this.wasVisible||go.add(i,e))}beforeCreateDocument(){this.wasVisible=P.isActiveSelf(this.gameObject)}};let Ra=go;a(Ra,"_fadeBehaviour"),a(Ra,"_fadeObjects",[]);class Xd extends j{constructor(){super(...arguments);a(this,"target");a(this,"duration",.5);a(this,"motionType","bounce")}beforeCreateDocument(){}createBehaviours(e,i,n){if(this.target&&i.uuid===this.gameObject.uuid){const o=new Bt("emphasize "+this.name,Qt.tapTrigger(this.gameObject),we.emphasize(this.target,this.duration,this.motionType,void 0,"basic"));e.addBehavior(o)}}afterCreateDocument(e,i){}}nt([m()],Xd.prototype,"target",void 0);nt([m()],Xd.prototype,"duration",void 0);nt([m()],Xd.prototype,"motionType",void 0);class Ga extends j{constructor(){super(...arguments);a(this,"target");a(this,"clip","");a(this,"toggleOnClick",!1);a(this,"trigger","tap")}start(){qd(this.gameObject)}ensureAudioSource(){if(!this.target){const e=this.gameObject.addComponent(Oe);e&&(this.target=e,e.spatialBlend=1,e.volume=1,e.loop=!1,e.preload=!0)}}onPointerClick(e){var i;e.use(),!(!((i=this.target)!=null&&i.clip)&&!this.clip)&&(this.ensureAudioSource(),this.target&&(this.target.isPlaying&&this.toggleOnClick?this.target.stop():(!this.toggleOnClick&&this.target.isPlaying&&this.target.stop(),this.clip?this.target.play(this.clip):this.target.play())))}createBehaviours(e,i,n){if(!(!this.target&&!this.clip)&&i.uuid===this.gameObject.uuid){const o=this.clip?this.clip:this.target?this.target.clip:void 0;if(!o||typeof o!="string")return;const r=this.target?this.target.gameObject:this.gameObject;rl.getName(o);const l=this.target?this.target.volume:1,c=this.target&&this.target.spatialBlend==0?"nonSpatial":"spatial";let h=!1;this.gameObject.traverse(p=>{p instanceof Z&&p.visible&&(h=!0)}),h=!0;const d=e.addAudioClip(o);let u=we.playAudioAction(r,d,"play",l,c);this.target&&this.target.loop&&(u=we.sequence(u).makeLooping());const f=this.name?"_"+this.name:"";if(h&&this.trigger==="tap"){this.toggleOnClick&&(u.multiplePerformOperation="stop");const p=new Bt("playAudio"+f,Qt.tapTrigger(i),u);e.addBehavior(p)}if(this.target&&this.target.playOnAwake&&this.target.enabled)if(h&&this.trigger==="tap")console.warn("USDZExport: Audio sources that are played on tap can't also auto-play at scene start due to a QuickLook bug.");else{const p=new Bt("playAudioOnStart"+f,Qt.sceneStartTrigger(),u);e.addBehavior(p)}}}}nt([m(Oe)],Ga.prototype,"target",void 0);nt([m(URL)],Ga.prototype,"clip",void 0);nt([m()],Ga.prototype,"toggleOnClick",void 0);const Gn=class extends j{constructor(){super(...arguments);a(this,"animator");a(this,"stateName");a(this,"trigger","tap");a(this,"animation");a(this,"selfModel");a(this,"stateAnimationModel");a(this,"animationSequence",new Array);a(this,"animationLoopAfterSequence",new Array);a(this,"randomOffsetNormalized",0)}get target(){var e,i;return((e=this.animator)==null?void 0:e.gameObject)||((i=this.animation)==null?void 0:i.gameObject)}start(){qd(this.gameObject)}onPointerClick(e){var i;e.use(),this.target&&this.stateName&&((i=this.animator)==null||i.play(this.stateName,0,0,.1))}createBehaviours(e,i,n){i.uuid===this.gameObject.uuid&&(this.selfModel=i)}afterSerialize(){if(Gn.rootsWithExclusivePlayback.size>1){const e='Multiple root objects targeted by more than one animation. To work around QuickLook bug FB13410767, animations will be set as "exclusive" and activating them will stop other animations being marked as exclusive.';U()&&Me(e),console.warn(e,...Gn.rootsWithExclusivePlayback)}Gn.animationActions=[],Gn.rootsWithExclusivePlayback=new Set}afterCreateDocument(e,i){if(this.animationSequence===void 0&&this.animationLoopAfterSequence===void 0||!this.stateAnimationModel||!this.target)return;const n=i.document,o=i.extensions.find(c=>c instanceof Zp);if(!o)return;const r=o.getClipCount(this.target)>1;r&&(U()&&console.warn("Setting exclusive playback for "+this.target.name+"@"+this.stateName+" because it has "+o.getClipCount(this.target)+" animations. This works around QuickLook bug FB13410767."),Gn.rootsWithExclusivePlayback.add(this.target));const l=this.name?this.name:"";n.traverse(c=>{var h,d;if(c.uuid===((h=this.target)==null?void 0:h.uuid)){const u=Gn.getActionForSequences(n,c,this.animationSequence,this.animationLoopAfterSequence,this.randomOffsetNormalized),f=new Bt(this.trigger+"_"+l+"_toPlayAnimation_"+this.stateName+"_on_"+((d=this.target)==null?void 0:d.name),this.trigger=="tap"?Qt.tapTrigger(this.selfModel):Qt.sceneStartTrigger(),u);r&&f.makeExclusive(!0),e.addBehavior(f)}})}static getActionForSequences(e,i,n,o,r){const l=(h,d)=>{let u=Gn.animationActions.find(f=>f.affectedObjects==h&&f.start==d.start&&f.duration==d.duration&&f.animationSpeed==d.speed);return u||(u=we.startAnimationAction(h,d),Gn.animationActions.push(u)),u},c=we.sequence();if(n&&n.length>0)for(const h of n)c.addAction(l(i,h));if(o&&o.length>0){const h=c.actions.length==0?c:we.sequence();for(const d of o)h.addAction(l(i,d));h.makeLooping(),c!==h&&c.addAction(h)}return r&&r>0&&c.actions.unshift(we.waitAction(r)),c}static getAndRegisterAnimationSequences(e,i,n){var y,b,_,v,S,T,O,M;if(!i)return;const o=i.getComponent(pi),r=i.getComponent(Mi);if(!o&&!r)return;if(o&&!n)throw new Error("PlayAnimationOnClick: No stateName specified for animator "+o.name+" on "+i.name);let l=[],c=[];if(r){const k=e.registerAnimation(i,r.clip);k&&(r.loop?c.push(k):l.push(k));let B=0;if(r.minMaxOffsetNormalized){const I=r.minMaxOffsetNormalized.x,E=r.minMaxOffsetNormalized.y;B=(((y=r.clip)==null?void 0:y.duration)||1)*(I+Math.random()*(E-I))}return{animationSequence:l,animationLoopAfterSequence:c,randomTimeOffset:B}}const h=o==null?void 0:o.runtimeAnimatorController;let d=h==null?void 0:h.findState(n),u=[],f=[];if(h&&d){const k=new Array;k.push(d);let B=!1;for(;k.length<100;){if(!d||d===null||!d.transitions||d.transitions.length===0){(b=d.motion)!=null&&b.isLooping&&(B=!0);break}const I=d.transitions.find(L=>L.conditions.length===0),E=I?h.getState(I.destinationState,0):null;if(E&&k.includes(E)){d=E,B=!0;break}else if(I){if(d=E,!d)break;k.push(d)}else{B=((_=d.motion)==null?void 0:_.isLooping)??!1;break}}if(B&&d){const I=k.indexOf(d);u=k.slice(0,I),f=k.slice(I),Cx&&console.log("found loop from "+n,"states until loop",u,"states looping",f)}else u=k,f=[],Cx&&console.log("found no loop from "+n,"states",u);if(!f.length){const I=u[u.length-1],E=(v=I.motion)==null?void 0:v.clip;if(E){let L;if(e.holdClipMap.has(E))L=e.holdClipMap.get(E);else{const V=I.name+"_hold";L=E.clone(),L.duration=1,L.name=V;const A=E.duration;L.tracks=E.tracks.map(D=>{const N=D.clone();N.times=new Float32Array([0,A]);const q=D.values.length,Y=D.getValueSize(),ie=D.values.slice(q-Y,q);return N.values=new Float32Array(2*Y),N.values.set(ie,0),N.values.set(ie,Y),N}),L.name=V,e.holdClipMap.set(E,L)}if(L){const V={name:L.name,motion:{clip:L,isLooping:!1,name:L.name},speed:1,transitions:[],behaviours:[],hash:I.hash+1};f.push(V)}}}}if(u.length===1&&(!((S=u[0].motion)!=null&&S.clip)||((O=(T=u[0].motion)==null?void 0:T.clip.tracks)==null?void 0:O.length)===0)){l=new Array;const k=e.registerAnimation(i,null);k&&l.push(k);return}if(u=u.filter(k=>{var B,I,E;return((B=k.motion)==null?void 0:B.clip)&&((E=(I=k.motion)==null?void 0:I.clip.tracks)==null?void 0:E.length)>0}),f=f.filter(k=>{var B,I,E;return((B=k.motion)==null?void 0:B.clip)&&((E=(I=k.motion)==null?void 0:I.clip.tracks)==null?void 0:E.length)>0}),u.length===0&&f.length===0){console.warn("No clips found for state "+n+" on "+(o==null?void 0:o.name)+", can't export animation data");return}const p=(k,B)=>{if(!i)return;const I=e.registerAnimation(i,k.motion.clip??null);I?(I.speed=k.speed,B.push(I)):console.warn("Couldn't register animation for state "+k.name+" on "+(o==null?void 0:o.name))};if(u.length>0){l=new Array;for(const k of u)p(k,l)}if(f.length>0){c=new Array;for(const k of f)p(k,c)}let g=0;if(o&&h&&o.minMaxOffsetNormalized){const k=o.minMaxOffsetNormalized.x,B=o.minMaxOffsetNormalized.y,I=u.length?u[0]:f.length?f[0]:null;g=(((M=I==null?void 0:I.motion.clip)==null?void 0:M.duration)||1)*(k+Math.random()*(B-k))}return{animationSequence:l,animationLoopAfterSequence:c,randomTimeOffset:g}}createAnimation(e,i,n){if(!this.target||!this.animator&&!this.animation)return;const o=Gn.getAndRegisterAnimationSequences(e,this.target,this.stateName);o&&(this.animationSequence=o.animationSequence,this.animationLoopAfterSequence=o.animationLoopAfterSequence,this.randomOffsetNormalized=o.randomTimeOffset,this.stateAnimationModel=i)}};let Us=Gn;a(Us,"animationActions",[]),a(Us,"rootsWithExclusivePlayback",new Set);nt([m(pi)],Us.prototype,"animator",void 0);nt([m()],Us.prototype,"stateName",void 0);class Qd extends j{constructor(){super(...arguments);a(this,"target")}getType(){}getDuration(){}}nt([m(F)],Qd.prototype,"target",void 0);class em extends j{constructor(){super(...arguments);a(this,"target")}}nt([m(Qd)],em.prototype,"target",void 0);class tm extends Qd{constructor(){super(...arguments);a(this,"type",qh.Hide);a(this,"duration",1)}getType(){switch(this.type){case qh.Hide:return"hide";case qh.Show:return"show"}}getDuration(){return this.duration}}nt([m()],tm.prototype,"type",void 0);nt([m()],tm.prototype,"duration",void 0);class x1 extends em{}var qh;(function(s){s[s.Show=0]="Show",s[s.Hide=1]="Hide"})(qh||(qh={}));class _b{get extensionName(){return"Physics"}onExportObject(t,e,i){const n=P.getComponents(t,ve).filter(c=>c.enabled),o=P.getComponents(t,fn).filter(c=>c.enabled&&!c.isTrigger);let r=n.length>0?n[0]:null;const l=o.length>0?o[0]:null;l&&!r&&(r=new ve,r.isKinematic=!0),r&&e.addEventListener("serialize",(c,h)=>{var d,u,f;if(r){if(c.appendLine(),c.beginBlock('def RealityKitComponent "RigidBody"',"{",!0),r.useGravity||c.appendLine("bool gravityEnabled = 0"),c.appendLine('uniform token info:id = "RealityKit.RigidBody"'),r.isKinematic&&c.appendLine('token motionType = "Kinematic"'),c.beginBlock('def RealityKitStruct "massFrame"',"{",!0),c.appendLine(`float m_mass = ${r.mass}`),c.beginBlock('def RealityKitStruct "m_pose"',"{",!0),c.appendLine(`float3 position = (${r.centerOfMass.x}, ${r.centerOfMass.y}, ${r.centerOfMass.z})`),c.closeBlock("}"),c.closeBlock("}"),o.length>0){const p=o[0];c.beginBlock('def RealityKitStruct "material"',"{",!0);const g=p.sharedMaterial;g&&g.dynamicFriction!==void 0&&c.appendLine(`double dynamicFriction = ${(d=p.sharedMaterial)==null?void 0:d.dynamicFriction}`),g&&g.bounciness!==void 0&&c.appendLine(`double restitution = ${(u=p.sharedMaterial)==null?void 0:u.bounciness}`),g&&g.staticFriction!==void 0&&c.appendLine(`double staticFriction = ${(f=p.sharedMaterial)==null?void 0:f.staticFriction}`),c.closeBlock("}")}c.closeBlock("}")}}),l&&(e.addEventListener("serialize",(c,h)=>{var f;c.beginBlock('def RealityKitComponent "Collider"',"{",!0),c.appendLine("uint group = 1"),c.appendLine('uniform token info:id = "RealityKit.Collider"'),c.appendLine("uint mask = 4294967295");const u=l.isTrigger?"Trigger":"Default";if(c.appendLine(`token type = "${u}"`),c.beginBlock('def RealityKitStruct "Shape"',"{",!0),l instanceof Gd){const p=l;c.appendLine('token shapeType = "Sphere"'),c.appendLine(`float radius = ${p.radius}`)}else if(l instanceof il){const p=l;c.appendLine('token shapeType = "Box"'),c.appendLine(`float3 extent = (${p.size.x}, ${p.size.y}, ${p.size.z})`)}else if(l instanceof Vr){const p=l;c.appendLine('token shapeType = "Capsule"'),c.appendLine(`float radius = ${p.radius}`),c.appendLine(`float height = ${p.height}`)}else if(l instanceof nl&&((f=l.sharedMesh)!=null&&f.geometry)){const p=l.sharedMesh.geometry;p.boundingBox||p.computeBoundingBox();const g=l.sharedMesh.geometry.boundingBox;g&&(c.appendLine('token shapeType = "Box"'),c.appendLine(`float3 extent = (${g.max.x-g.min.x}, ${g.max.y-g.min.y}, ${g.max.z-g.min.z})`),console.log("[USDZ] Only Box, Sphere, and Capsule colliders are supported in visionOS/iOS. MeshCollider will be exported as Box",l))}else console.warn("[USDZ] Only Box, Sphere, and Capsule colliders are supported in visionOS/iOS. Ignoring collider:",l);c.beginBlock('def RealityKitStruct "pose"',"{",!0),c.closeBlock("}"),c.closeBlock("}"),c.closeBlock("}")}),o.length>1&&console.log("WARNING: Multiple colliders detected. visionOS / iOS can only support objects with a single collider, only exporting the first collider: ",l))}}class w1{get extensionName(){return"DocumentExtension"}onAfterBuildDocument(t){}}var Yd=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const Dg=C("debugui"),Lg=C("debuguilayout");class S1{constructor(){a(this,"width");a(this,"height")}}class C1{constructor(){a(this,"x");a(this,"y");a(this,"width");a(this,"height")}}const Wn=new x,yh=new le,Fu=new H;class Yt extends ls{constructor(){super(...arguments);a(this,"_anchoredPosition");a(this,"sizeDelta",new ce(100,100));a(this,"pivot",new ce(.5,.5));a(this,"anchorMin",new ce(0,0));a(this,"anchorMax",new ce(1,1));a(this,"minWidth");a(this,"minHeight");a(this,"lastMatrix");a(this,"rectBlock");a(this,"_transformNeedsUpdate",!1);a(this,"_initialPosition");a(this,"_parentRectTransform");a(this,"_lastUpdateFrame",-1);a(this,"_lastAnchoring");a(this,"_createdBlocks",[]);a(this,"_createdTextBlocks",[])}get parent(){return this._parentRectTransform}get translation(){return this.gameObject.position}get rotation(){return this.gameObject.quaternion}get scale(){return this.gameObject.scale}get anchoredPosition(){return this._anchoredPosition||(this._anchoredPosition=new ce),this._anchoredPosition}set anchoredPosition(e){this._anchoredPosition=e}get width(){let e=this.sizeDelta.x;if(this.anchorMin.x!==this.anchorMax.x&&this._parentRectTransform){const i=this._parentRectTransform.width,n=this.anchorMax.x-this.anchorMin.x;e=i*n,e+=this.sizeDelta.x}return this.minWidth!==void 0&&e<this.minWidth?this.minWidth:e}get height(){let e=this.sizeDelta.y;if(this.anchorMin.y!==this.anchorMax.y&&this._parentRectTransform){const i=this._parentRectTransform.height,n=this.anchorMax.y-this.anchorMin.y;e=i*n,e+=this.sizeDelta.y}return this.minHeight!==void 0&&e<this.minHeight?this.minHeight:e}awake(){super.awake(),this._anchoredPosition||(this._anchoredPosition=new ce),this.lastMatrix=new le,this.rectBlock=new F,this.rectBlock.name=this.name,this._initialPosition=this.gameObject.position.clone(),this._initialPosition.z=0,Ml(this,"_anchoredPosition",()=>{this.markDirty()}),Ml(this,"sizeDelta",()=>{this.markDirty()}),Ml(this,"pivot",()=>{this.markDirty()}),Ml(this,"anchorMin",()=>{this.markDirty()}),Ml(this,"anchorMax",()=>{this.markDirty()})}onEnable(){var e;super.onEnable(),this.rectBlock||(this.rectBlock=new F),this.lastMatrix||(this.lastMatrix=new le),this._lastAnchoring||(this._lastAnchoring=new ce),this._initialPosition||(this._initialPosition=new x),this._anchoredPosition||(this._anchoredPosition=new ce),this.addShadowComponent(this.rectBlock),this._transformNeedsUpdate=!0,(e=this.canvas)==null||e.registerTransform(this)}onDisable(){var e;super.onDisable(),this.removeShadowComponent(),(e=this.canvas)==null||e.unregisterTransform(this)}onParentRectTransformChanged(e){this._transformNeedsUpdate||this.onApplyTransform(Lg?`${e.name} changed`:void 0)}get isDirty(){return this._transformNeedsUpdate||(this._transformNeedsUpdate=!this.lastMatrix.equals(this.gameObject.matrix)),this._transformNeedsUpdate}markDirty(){this._transformNeedsUpdate||(Lg&&console.warn("RectTransform markDirty()",this.name),this._transformNeedsUpdate=!0,this._lastUpdateFrame=-1)}updateTransform(){(this._transformNeedsUpdate||!this.lastMatrix.equals(this.gameObject.matrix))&&this.canUpdate()&&this.onApplyTransform(this._transformNeedsUpdate?"Marked dirty":"Matrix changed")}canUpdate(){return this._transformNeedsUpdate&&this.activeAndEnabled&&this._lastUpdateFrame!==this.context.time.frame}onApplyTransform(e){var o;if(this.context.time.frameCount===this._lastUpdateFrame)return;this._lastUpdateFrame=this.context.time.frameCount;const i=this.shadowComponent;if(!i)return;this.gameObject.parent?this._parentRectTransform=P.getComponentInParent(this.gameObject.parent,Yt):this._parentRectTransform=void 0,this._transformNeedsUpdate=!1,Lg&&console.warn("RectTransform ‚Üí ApplyTransform",this.name+" because "+e),this.isRoot()?this.Root.screenspace||(i.rotation.y=Math.PI):(i.matrix.identity(),i.matrixAutoUpdate=!1,Wn.set(0,0,0),this.applyPivot(Wn),i.matrix.setPosition(Wn.x,Wn.y,0),(this.gameObject.quaternion.x||this.gameObject.quaternion.y||this.gameObject.quaternion.z)&&(Fu.copy(this.gameObject.quaternion),Fu.x*=-1,Fu.z*=-1,yh.makeRotationFromQuaternion(Fu),i.matrix.premultiply(yh)),Wn.set(0,0,0),this.applyAnchoring(Wn),(o=this.canvas)!=null&&o.screenspace?Wn.z+=.1:Wn.z+=.01,yh.identity(),yh.setPosition(Wn.x,Wn.y,Wn.z),i.matrix.premultiply(yh),i.matrix.scale(this.gameObject.scale)),this.lastMatrix.copy(this.gameObject.matrix);const n=!0;for(const r of J_(this.gameObject,ls,n,1)){if(r===this||!r.activeAndEnabled)continue;const l=r;l.onParentRectTransformChanged&&l.onParentRectTransformChanged(this)}}applyAnchoring(e){this._lastAnchoring||(this._lastAnchoring=new ce);const i=this._lastAnchoring.sub(this._anchoredPosition);this.gameObject.position.x+=i.x,this.gameObject.position.y+=i.y,this._lastAnchoring.copy(this._anchoredPosition),e.x+=this._initialPosition.x-this.gameObject.position.x,e.y+=this._initialPosition.y-this.gameObject.position.y,e.z+=this._initialPosition.z-this.gameObject.position.z;const n=this._parentRectTransform;if(n){let o=0;const r=1-this.anchorMax.y-this.anchorMin.y;o-=n.height*.5*r,e.y+=o;let l=0;const c=1-this.anchorMax.x-this.anchorMin.x;l-=n.width*.5*c,e.x+=l}}applyPivot(e){if(this.pivot&&!this.isRoot()){const i=this.pivot.x-.5;e.x-=i*this.sizeDelta.x*this.gameObject.scale.x;const n=this.pivot.y-.5;e.y-=n*this.sizeDelta.y*this.gameObject.scale.y}}getBasicOptions(){const e={width:this.sizeDelta.x,height:this.sizeDelta.y,offset:0,backgroundOpacity:0,borderWidth:0,borderRadius:0,borderOpacity:0,letterSpacing:-.03};return this.ensureValidSize(e),e}ensureValidSize(e,i=1e-4){return e.width<=0&&(e.width=i),e.height<=0&&(e.height=1e-4),e}createNewBlock(e){e={...this.getBasicOptions(),...e},Dg&&console.log(this.name,e);const i=new bw(e);return this._createdBlocks.push(i),i}createNewText(e){Dg&&console.log(e),e={...this.getBasicOptions(),...e},Dg&&console.log(this.name,e);const i=new _w(e);return this._createdTextBlocks.push(i),i}}Yd([m(ce)],Yt.prototype,"anchoredPosition",null);Yd([m(ce)],Yt.prototype,"sizeDelta",void 0);Yd([m(ce)],Yt.prototype,"pivot",void 0);Yd([m(ce)],Yt.prototype,"anchorMin",void 0);Yd([m(ce)],Yt.prototype,"anchorMax",void 0);var P1=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};class Kd extends j{constructor(){super(...arguments);a(this,"effectColor");a(this,"effectDistance")}}P1([m(Ae)],Kd.prototype,"effectColor",void 0);P1([m(ce)],Kd.prototype,"effectDistance",void 0);var R1=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const zu={backgroundColor:new ue(1,1,1),backgroundOpacity:1,borderColor:new ue(1,1,1),borderOpacity:1},Ql=class extends ls{constructor(){super(...arguments);a(this,"_alphaFactor",1);a(this,"sRGBColor",new ue(1,0,1));a(this,"raycastTarget",!0);a(this,"uiObject",null);a(this,"_color",null);a(this,"_rect",null);a(this,"_stateManager",null);a(this,"_currentlyCreatingPanel",!1)}get isGraphic(){return!0}get color(){return this._color||(this._color=new Ae(1,1,1,1)),this._color}set color(e){(!this._color||this._color.r!==e.r||this._color.g!==e.g||this._color.b!==e.b||this._color.alpha!==e.alpha)&&(this._color||(this._color=new Ae(1,1,1,1)),this._color.copy(e),this.onColorChanged())}setAlphaFactor(e){this._alphaFactor=e,this.onColorChanged()}get alphaFactor(){return this._alphaFactor}onColorChanged(){this.uiObject&&(this.sRGBColor.copy(this._color),this.sRGBColor.convertLinearToSRGB(),zu.backgroundColor=this.sRGBColor,zu.backgroundOpacity=this._color.alpha*this._alphaFactor,this.applyEffects(zu,this._alphaFactor),this.uiObject.set(zu),this.markDirty())}get m_Color(){return this._color}get rectTransform(){if(this._rect||(this._rect=P.getComponent(this.gameObject,Yt)),!this._rect)throw new Error("Not Supported: Make sure to add a RectTransform component before adding a UI Graphic component.");return this._rect}onParentRectTransformChanged(){var e;(e=this.uiObject)==null||e.set({width:this.rectTransform.width,height:this.rectTransform.height}),this.markDirty()}__internalNewInstanceCreated(e){return super.__internalNewInstanceCreated(e),this._rect=null,this.uiObject=null,this._color&&(this._color=this._color.clone()),this}setState(e){this.makePanel(),this.uiObject&&(this.uiObject.setState(e),this==null||this.markDirty())}setupState(e){this.makePanel(),this.uiObject&&(this._stateManager||(this._stateManager=new AR(this.uiObject)),this.uiObject.setupState(e.state,e.attributes))}setOptions(e){this.makePanel(),this.uiObject&&this.uiObject.set(e)}awake(){super.awake(),this.makePanel(),Ml(this,"_color",()=>hA(this,this.onColorChanged))}onEnable(){var e;super.onEnable(),this.uiObject&&((e=this.rectTransform.shadowComponent)==null||e.add(this.uiObject),this.addShadowComponent(this.uiObject,this.rectTransform))}onDisable(){super.onDisable(),this.uiObject&&this.removeShadowComponent()}makePanel(){if(this.uiObject||this._currentlyCreatingPanel)return;this._currentlyCreatingPanel=!0;const e=.015,i={backgroundColor:this.color,backgroundOpacity:this.color.alpha,offset:e};this.onBeforeCreate(i),this.applyEffects(i),this.onCreate(i),this.controlsChildLayout=!1,this._currentlyCreatingPanel=!1,this.onAfterCreated(),this.onColorChanged()}onBeforeCreate(e){}onCreate(e){this.uiObject=this.rectTransform.createNewBlock(e),this.uiObject.name=this.name}onAfterCreated(){}applyEffects(e,i=1){var o;const n=(o=this.gameObject)==null?void 0:o.getComponent(Kd);n&&(n.effectDistance&&(e.borderWidth=Math.max(Math.abs(n.effectDistance.x),Math.abs(n.effectDistance.y))),n.effectColor&&(e.borderColor=n.effectColor,e.borderOpacity=n.effectColor.alpha*i))}async setTexture(e){if(this.setOptions({backgroundOpacity:0}),e){if(Ql.textureCache.has(e))e=Ql.textureCache.get(e);else if(!e.isRenderTargetTexture){const i=e.clone();i.colorSpace=Wa,Ql.textureCache.set(e,i),e=i}this.setOptions({backgroundImage:e,borderRadius:0,backgroundOpacity:this.color.alpha,backgroundSize:"stretch"}),mt.assignTextureLOD(e,0).then(i=>{i instanceof Je&&(e&&Ql.textureCache.set(e,i),this.setOptions({backgroundImage:i}),this.markDirty())})}else this.setOptions({backgroundImage:void 0,borderRadius:0,backgroundOpacity:this.color.alpha});this.markDirty()}onAfterAddedToScene(){super.onAfterAddedToScene(),this.shadowComponent&&(this.shadowComponent.offset=this.shadowComponent.position.z)}};let jo=Ql;a(jo,"textureCache",new Map);R1([m(Ae)],jo.prototype,"color",null);R1([m()],jo.prototype,"raycastTarget",void 0);class im extends jo{constructor(){super(...arguments);a(this,"_flippedObject",!1)}onAfterCreated(){this.uiObject&&!this._flippedObject&&(this._flippedObject=!0,this.uiObject.scale.y*=-1)}}var Ko=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const da=C("debugtext");var fe;(function(s){s[s.UpperLeft=0]="UpperLeft",s[s.UpperCenter=1]="UpperCenter",s[s.UpperRight=2]="UpperRight",s[s.MiddleLeft=3]="MiddleLeft",s[s.MiddleCenter=4]="MiddleCenter",s[s.MiddleRight=5]="MiddleRight",s[s.LowerLeft=6]="LowerLeft",s[s.LowerCenter=7]="LowerCenter",s[s.LowerRight=8]="LowerRight"})(fe||(fe={}));var Xh;(function(s){s[s.Truncate=0]="Truncate",s[s.Overflow=1]="Overflow"})(Xh||(Xh={}));var Qh;(function(s){s[s.Wrap=0]="Wrap",s[s.Overflow=1]="Overflow"})(Qh||(Qh={}));var Bi;(function(s){s[s.Normal=0]="Normal",s[s.Bold=1]="Bold",s[s.Italic=2]="Italic",s[s.BoldAndItalic=3]="BoldAndItalic"})(Bi||(Bi={}));class Di extends jo{constructor(){super(...arguments);a(this,"alignment",fe.UpperLeft);a(this,"verticalOverflow",Xh.Truncate);a(this,"horizontalOverflow",Qh.Wrap);a(this,"lineSpacing",1);a(this,"supportRichText",!1);a(this,"font");a(this,"fontStyle",Bi.Normal);a(this,"sRGBTextColor",new ue(1,0,1));a(this,"_text","");a(this,"_fontSize",12);a(this,"_textMeshUi",null);a(this,"_didHandleTextRenderOnTop",!1)}setAlphaFactor(e){var i;super.setAlphaFactor(e),(i=this.uiObject)==null||i.set({fontOpacity:this.color.alpha*this.alphaFactor}),this.markDirty()}get text(){return this._text}set text(e){e!==this._text&&(this._text=e,this.feedText(this.text,this.supportRichText),this.markDirty())}set_text(e){this.text=e}get fontSize(){return this._fontSize}set fontSize(e){var i;this._fontSize=e,(i=this.uiObject)==null||i.set({fontSize:e})}onColorChanged(){var e;this.sRGBTextColor.copy(this.color),this.sRGBTextColor.convertLinearToSRGB(),(e=this.uiObject)==null||e.set({color:this.sRGBTextColor,fontOpacity:this.color.alpha})}onParentRectTransformChanged(){super.onParentRectTransformChanged(),this.uiObject&&this.updateOverflow()}onBeforeCanvasRender(e){this.updateOverflow()}updateOverflow(){var i;const e=(i=this.uiObject)==null?void 0:i._overflow;e&&(e._needsUpdate=!0)}onCreate(e){da&&console.log(this),this.horizontalOverflow==Qh.Overflow&&(e.whiteSpace="pre"),this.verticalOverflow==Xh.Truncate&&(this.context.renderer.localClippingEnabled=!0,e.overflow="hidden"),this.horizontalOverflow==Qh.Overflow&&this.verticalOverflow==Xh.Truncate,e.lineHeight=this.lineSpacing,delete e.backgroundOpacity,delete e.backgroundColor,da&&(e.backgroundColor=16750848,e.backgroundOpacity=.5);const i=this.rectTransform;e={...e,...this.getTextOpts()},this.getAlignment(e),da&&(e.backgroundColor=Math.random()*16777215,e.backgroundOpacity=.1),this.uiObject=i.createNewText(e),this.feedText(this.text,this.supportRichText)}onAfterAddedToScene(){super.onAfterAddedToScene(),this.handleTextRenderOnTop()}getTextOpts(){const e=this.fontSize,i={color:this.color,fontOpacity:this.color.alpha,fontSize:e,fontKerning:"normal"};return this.setFont(i,this.fontStyle),i}onEnable(){var e;super.onEnable(),this._didHandleTextRenderOnTop=!1,this.uiObject&&this.uiObject.addAfterUpdate(()=>{this.setShadowComponentOwner(this.uiObject),this.markDirty()}),setTimeout(()=>this.markDirty(),10),(e=this.canvas)==null||e.registerEventReceiver(this)}onDisable(){var e;super.onDisable(),(e=this.canvas)==null||e.unregisterEventReceiver(this)}getAlignment(e){switch(e.flexDirection="column",this.alignment){case fe.UpperLeft:case fe.MiddleLeft:case fe.LowerLeft:e.textAlign="left";break;case fe.UpperCenter:case fe.MiddleCenter:case fe.LowerCenter:e.textAlign="center";break;case fe.UpperRight:case fe.MiddleRight:case fe.LowerRight:e.textAlign="right";break}switch(this.alignment){default:case fe.UpperLeft:case fe.UpperCenter:case fe.UpperRight:e.alignItems="start";break;case fe.MiddleLeft:case fe.MiddleCenter:case fe.MiddleRight:e.alignItems="center";break;case fe.LowerLeft:case fe.LowerCenter:case fe.LowerRight:e.alignItems="end";break}return e}feedText(e,i){var n,o,r;if(da&&console.log("feedText",this.uiObject,e,i),!!this.uiObject)if(this._textMeshUi||(this._textMeshUi=[]),this.uiObject.children.length=0,!i||e.length===0)this.uiObject.textContent=e;else{let l=this.getNextTag(e);if(l){if(l.startIndex>0){for(let d=this.uiObject.children.length-1;d>=0;d--){const u=this.uiObject.children[d];u.isUI&&(this.uiObject.remove(u),u.clear())}const h=new $m({textContent:e.substring(0,l.startIndex),color:"inherit"});this.uiObject.add(h)}}else{this.uiObject.textContent="",this.setOptions({textContent:e});return}const c=[];for(;l;){const h=this.getNextTag(e,l.endIndex),d={fontFamily:(n=this.uiObject)==null?void 0:n.get("fontFamily"),color:"inherit",textContent:""};if(h){d.textContent=this.getText(e,l,h),this.handleTag(l,d,c);const u=new $m(d);(o=this.uiObject)==null||o.add(u)}else{d.textContent=e.substring(l.endIndex),this.handleTag(l,d,c);const u=new $m(d);(r=this.uiObject)==null||r.add(u)}l=h}}}handleTextRenderOnTop(){this._didHandleTextRenderOnTop||(this._didHandleTextRenderOnTop=!0,this.startCoroutine(this.renderOnTopCoroutine()))}*renderOnTopCoroutine(){if(!this.canvas)return;const e=[],i=this.canvas,n={renderOnTop:i.renderOnTop,depthWrite:i.depthWrite,doubleSided:i.doubleSided};for(;;){let o=!1;if(this._textMeshUi)for(let r=0;r<this._textMeshUi.length;r++){if(e[r]===!0)continue;o=!0;const l=this._textMeshUi[r];l.textContent&&(Bf(l,n),e[r]=!0)}if(!o)break;yield}}handleTag(e,i,n){if(!e.isEndTag){if(e.type.includes("color")){const o=new jg(e,{color:i.color});if(n.push(o),e.type.length>6){const r=parseInt("0x"+e.type.substring(7));i.color=r}else i.color=new ue(1,1,1)}else if(e.type=="b"){this.setFont(i,Bi.Bold);const o=new jg(e,{fontWeight:700});n.push(o)}else if(e.type=="i"){this.setFont(i,Bi.Italic);const o=new jg(e,{fontStyle:"italic"});n.push(o)}}}getText(e,i,n){return e.substring(i.endIndex,n.startIndex)}getNextTag(e,i=0){const n=e.indexOf("<",i),o=e.indexOf(">",n);if(n>=0&&o>=0){const r=e.substring(n+1,o);return{type:r,startIndex:n,endIndex:o+1,isEndTag:r.startsWith("/")}}return null}setFont(e,i){if(!this.font)return;const n=this.font,o=this.getFamilyNameWithCorrectSuffix(n,i);da&&console.log("Selected font family:"+o);let r=c0.getFontFamily(o);switch(r||(r=c0.addFontFamily(o)),e.fontFamily=r,i){default:case Bi.Normal:e.fontWeight=400,e.fontStyle="normal";break;case Bi.Bold:e.fontWeight=700,e.fontStyle="normal";break;case Bi.Italic:e.fontWeight=400,e.fontStyle="italic";break;case Bi.BoldAndItalic:e.fontStyle="italic",e.fontWeight=400}let l=r.getVariant(e.fontWeight,e.fontStyle);if(!l){let c=o;c!=null&&c.endsWith("-msdf.json")||(c+="-msdf.json");let h=o;h!=null&&h.endsWith(".png")||(h+=".png"),l=r.addVariant(e.fontWeight,e.fontStyle,c,h),l==null||l.addEventListener("ready",()=>{this.markDirty()})}}getFamilyNameWithCorrectSuffix(e,i){var d;const n=e.lastIndexOf("-");if(n<0)return e;const o=(d=e.substring(n+1))==null?void 0:d.toLowerCase();if(P2.includes(o))return da&&console.warn("Unsupported font style: "+o),e;const r=e.lastIndexOf("/");let l=e;r>=0&&(l=l.substring(r+1));const c=l[0]===l[0].toUpperCase(),h=e.substring(0,n);switch(da&&console.log("Select font: ",e,Bi[i],l,c,h),i){case Bi.Normal:return c?h+"-Regular":h+"-regular";case Bi.Bold:return c?h+"-Bold":h+"-bold";case Bi.Italic:return c?h+"-Italic":h+"-italic";case Bi.BoldAndItalic:return c?h+"-BoldItalic":h+"-bolditalic";default:return e}}}Ko([m()],Di.prototype,"alignment",void 0);Ko([m()],Di.prototype,"verticalOverflow",void 0);Ko([m()],Di.prototype,"horizontalOverflow",void 0);Ko([m()],Di.prototype,"lineSpacing",void 0);Ko([m()],Di.prototype,"supportRichText",void 0);Ko([m(URL)],Di.prototype,"font",void 0);Ko([m()],Di.prototype,"fontStyle",void 0);Ko([m()],Di.prototype,"text",null);Ko([m()],Di.prototype,"fontSize",null);class jg{constructor(t,e){a(this,"tag");a(this,"previousValues");this.tag=t,this.previousValues=e}}const P2=["medium","mediumitalic","black","blackitalic","thin","thinitalic","extrabold","light","lightitalic","semibold"];var Yh;(function(s){s.singleLine="singleLine",s.hardBreaks="hardBreaks",s.flowing="flowing"})(Yh||(Yh={}));var zl;(function(s){s.left="left",s.center="center",s.right="right",s.justified="justified"})(zl||(zl={}));var Ul;(function(s){s.top="top",s.middle="middle",s.lowerMiddle="lowerMiddle",s.baseline="baseline",s.bottom="bottom"})(Ul||(Ul={}));class Oa{constructor(t){a(this,"id");a(this,"content","");a(this,"font",[]);a(this,"pointSize",144);a(this,"width");a(this,"height");a(this,"depth");a(this,"wrapMode");a(this,"horizontalAlignment");a(this,"verticalAlignment");a(this,"material");this.id=t}static getId(){return this.global_id++}setDepth(t){return this.depth=t,this}setPointSize(t){return this.pointSize=t,this}setHorizontalAlignment(t){return this.horizontalAlignment=t,this}setVerticalAlignment(t){return this.verticalAlignment=t,this}writeTo(t,e){var n;e.beginBlock(`def Preliminary_Text "${this.id}"`,"(",!1),e.appendLine('prepend apiSchemas = ["MaterialBindingAPI"]'),e.closeBlock(")"),e.beginBlock(),this.content&&e.appendLine(`string content = "${this.content}"`),(!this.font||this.font.length<=0)&&(this.font||(this.font=[]),(n=this.font)==null||n.push("sans-serif"));const i=this.font.map(o=>`"${o}"`).join(", ");e.appendLine(`string[] font = [ ${i} ]`),e.appendLine(`double pointSize = ${this.pointSize}`),typeof this.width=="number"&&e.appendLine(`double width = ${this.width}`),typeof this.height=="number"&&e.appendLine(`double height = ${this.height}`),typeof this.depth=="number"&&e.appendLine(`double depth = ${this.depth}`),this.wrapMode&&e.appendLine(`token wrapMode = "${this.wrapMode}"`),this.horizontalAlignment&&e.appendLine(`token horizontalAlignment = "${this.horizontalAlignment}"`),this.verticalAlignment&&e.appendLine(`token verticalAlignment = "${this.verticalAlignment}"`),this.material!==void 0&&e.appendLine(`rel material:binding = </StageRoot/Materials/${gb(this.material)}>`),e.closeBlock()}}a(Oa,"global_id",0);class bb{static singleLine(t,e,i){const n=new Oa("text_"+Oa.getId());return n.content=t,e&&(n.pointSize=e),i&&(n.depth=i),n}static multiLine(t,e,i,n,o,r){const l=new Oa("text_"+Oa.getId());return l.content=t,l.width=e,l.height=i,l.horizontalAlignment=n,l.verticalAlignment=o,r!==void 0&&(l.wrapMode=r),l}}const R2=new le().makeRotationY(Math.PI),O2=new le().makeScale(-1,1,-1);class nm{get extensionName(){return"text"}exportText(t,e,i){const n=P.getComponent(t,Di);if(!n)return;const o=P.getComponent(t,Yt);let r=100,l=100;o&&(r=o.width,l=o.height);const c=R2.clone();o&&c.premultiply(O2),e.setMatrix(c);const h=n.color.clone();e.material=new Vi({color:h,emissive:h}),e.addEventListener("serialize",(d,u)=>{let f=n.text;f=f.replace(/\r/g,""),f=f.replace(/\n/g,"\\n");const p=bb.multiLine(f,r,l,zl.center,Ul.bottom,Yh.flowing);this.setTextAlignment(p,n.alignment),this.setOverflow(p,n),e.material&&(p.material=e.material),p.pointSize=this.convertToTextSize(n.fontSize),p.depth=.001,p.writeTo(void 0,d)})}convertToTextSize(t){return 1/.0502*144*t}setOverflow(t,e){e.horizontalOverflow?t.wrapMode=Yh.singleLine:t.wrapMode=Yh.flowing}setTextAlignment(t,e){switch(e){case fe.LowerLeft:case fe.MiddleLeft:case fe.UpperLeft:t.horizontalAlignment=zl.left;break;case fe.LowerCenter:case fe.MiddleCenter:case fe.UpperCenter:t.horizontalAlignment=zl.center;break;case fe.LowerRight:case fe.MiddleRight:case fe.UpperRight:t.horizontalAlignment=zl.right;break}switch(e){case fe.LowerLeft:case fe.LowerCenter:case fe.LowerRight:t.verticalAlignment=Ul.bottom;break;case fe.MiddleLeft:case fe.MiddleCenter:case fe.MiddleRight:t.verticalAlignment=Ul.middle;break;case fe.UpperLeft:case fe.UpperCenter:case fe.UpperRight:t.verticalAlignment=Ul.top;break}}}var bt=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const Px=C("debuguilayout");class al{constructor(){a(this,"left",0);a(this,"right",0);a(this,"top",0);a(this,"bottom",0)}get vertical(){return this.top+this.bottom}get horizontal(){return this.left+this.right}}bt([m()],al.prototype,"left",void 0);bt([m()],al.prototype,"right",void 0);bt([m()],al.prototype,"top",void 0);bt([m()],al.prototype,"bottom",void 0);var o_;(function(s){s[s.UpperLeft=0]="UpperLeft",s[s.UpperCenter=1]="UpperCenter",s[s.UpperRight=2]="UpperRight",s[s.MiddleLeft=3]="MiddleLeft",s[s.MiddleCenter=4]="MiddleCenter",s[s.MiddleRight=5]="MiddleRight",s[s.LowerLeft=6]="LowerLeft",s[s.LowerCenter=7]="LowerCenter",s[s.LowerRight=8]="LowerRight",s[s.Custom=9]="Custom"})(o_||(o_={}));var za;(function(s){s.Horizontal="x",s.Vertical="y"})(za||(za={}));class pn extends j{constructor(){super(...arguments);a(this,"_rectTransform",null);a(this,"_needsUpdate",!1);a(this,"childAlignment",o_.UpperLeft);a(this,"reverseArrangement",!1);a(this,"spacing",0);a(this,"padding");a(this,"minWidth",0);a(this,"minHeight",0);a(this,"flexibleHeight",0);a(this,"flexibleWidth",0);a(this,"preferredHeight",0);a(this,"preferredWidth",0)}get rectTransform(){return this._rectTransform}onParentRectTransformChanged(e){this._needsUpdate=!0}get isDirty(){return this._needsUpdate}get isLayoutGroup(){return!0}updateLayout(){this._rectTransform&&(Px&&console.warn("Layout Update",this.context.time.frame,this.name),this._needsUpdate=!1,this.onCalculateLayout(this._rectTransform))}start(){this._needsUpdate=!0}onEnable(){Px&&console.log(this.name,this),this._rectTransform=this.gameObject.getComponent(Yt);const e=this.gameObject.getComponentInParent(Ft);e&&e.registerLayoutGroup(this),this._needsUpdate=!0}onDisable(){const e=this.gameObject.getComponentInParent(Ft);e&&e.unregisterLayoutGroup(this)}set m_Spacing(e){e!==this.spacing&&(this._needsUpdate=!0,this.spacing=e)}get m_Spacing(){return this.spacing}}bt([m()],pn.prototype,"childAlignment",void 0);bt([m()],pn.prototype,"reverseArrangement",void 0);bt([m()],pn.prototype,"spacing",void 0);bt([m(al)],pn.prototype,"padding",void 0);bt([m()],pn.prototype,"minWidth",void 0);bt([m()],pn.prototype,"minHeight",void 0);bt([m()],pn.prototype,"flexibleHeight",void 0);bt([m()],pn.prototype,"flexibleWidth",void 0);bt([m()],pn.prototype,"preferredHeight",void 0);bt([m()],pn.prototype,"preferredWidth",void 0);class Kr extends pn{constructor(){super(...arguments);a(this,"childControlHeight",!0);a(this,"childControlWidth",!0);a(this,"childForceExpandHeight",!1);a(this,"childForceExpandWidth",!1);a(this,"childScaleHeight",!1);a(this,"childScaleWidth",!1)}onCalculateLayout(e){var B;const i=this.primaryAxis,n=e.width;let o=n;const r=e.height;let l=r;o-=this.padding.horizontal,l-=this.padding.vertical,i===za.Horizontal?this.padding.horizontal:this.padding.vertical;const c=i===za.Horizontal,h=c?"y":"x",d=c?this.childControlWidth:this.childControlHeight,u=c?this.childControlHeight:this.childControlWidth,f=c?this.childForceExpandWidth:this.childForceExpandHeight,p=c?this.childForceExpandHeight:this.childForceExpandWidth,g=c?l:o,y=c?n:r,b=.5*(c?this.childAlignment%3:Math.floor(this.childAlignment/3));let _=0;c?_+=this.padding.left:_+=this.padding.top;let v=0,S=0;for(let I=0;I<this.gameObject.children.length;I++){const E=this.gameObject.children[I],L=P.getComponent(E,Yt);L!=null&&L.activeAndEnabled&&(S+=1,c?v+=L.width:v+=L.height)}let T=0;const O=this.spacing*(S-1);if(f||d){let I=0;c?I=o-=O:I=l-=O,S>0&&(T=I/S)}let M=0;M+=this.padding.left,M-=this.padding.right,b!==0&&(_=y-v,_*=b,_-=O*b,c?(_-=this.padding.right*b,_+=this.padding.left*(1-b),_<this.padding.left&&(_=this.padding.left)):(_-=this.padding.bottom*b,_+=this.padding.top*(1-b),_<this.padding.top&&(_=this.padding.top)));let k=1;for(let I=0;I<this.gameObject.children.length;I++){const E=this.gameObject.children[I],L=P.getComponent(E,Yt);if(L!=null&&L.activeAndEnabled){(B=L.pivot)==null||B.set(.5,.5),L.anchorMin.set(0,1),L.anchorMax.set(0,1);const V=n*.5+M*.5;L.anchoredPosition.x!==V&&(L.anchoredPosition.x=V);const A=r*-.5;L.anchoredPosition.y!==A&&(L.anchoredPosition.y=A),p&&u&&L.sizeDelta[h]!==g&&(L.sizeDelta[h]=g),f&&d&&L.sizeDelta[i]!==T&&(L.sizeDelta[i]=T);const D=c?L.width:L.height,N=D*.5;if(_+=N,f){const Y=T*k-T*.5;Y>_&&(_=Y-T*.5+D+this.padding.left,_-=N)}let q=_;i===za.Vertical&&(q=-q),L.anchoredPosition[i]!==q&&(L.anchoredPosition[i]=q),_+=N,_+=this.spacing,k+=1}}}}bt([m()],Kr.prototype,"childControlHeight",void 0);bt([m()],Kr.prototype,"childControlWidth",void 0);bt([m()],Kr.prototype,"childForceExpandHeight",void 0);bt([m()],Kr.prototype,"childForceExpandWidth",void 0);bt([m()],Kr.prototype,"childScaleHeight",void 0);bt([m()],Kr.prototype,"childScaleWidth",void 0);class O1 extends Kr{get primaryAxis(){return za.Vertical}}class T1 extends Kr{get primaryAxis(){return za.Horizontal}}class k1 extends pn{onCalculateLayout(){}}var Zs=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o},Ts;(function(s){s[s.ScreenSpaceOverlay=0]="ScreenSpaceOverlay",s[s.ScreenSpaceCamera=1]="ScreenSpaceCamera",s[s.WorldSpace=2]="WorldSpace",s[s.Undefined=-1]="Undefined"})(Ts||(Ts={}));const Bg=C("debuguilayout");class Ft extends qp{constructor(){super(...arguments);a(this,"_renderOnTop");a(this,"_depthWrite",!1);a(this,"_doubleSided",!0);a(this,"_castShadows",!1);a(this,"_receiveShadows",!1);a(this,"_renderMode",Ts.Undefined);a(this,"_rootCanvas");a(this,"_scaleFactor",1);a(this,"worldCamera");a(this,"planeDistance",-1);a(this,"_boundRenderSettingsChanged",this.onRenderSettingsChanged.bind(this));a(this,"previousParent",null);a(this,"_lastMatrixWorld",null);a(this,"_rectTransforms",[]);a(this,"_layoutGroups",new Map);a(this,"_receivers",[]);a(this,"onBeforeRenderRoutine",()=>{var e,i,n,o;if(this.previousParent=this.gameObject.parent,((e=this.context.xr)!=null&&e.isVR||(i=this.context.xr)!=null&&i.isPassThrough)&&this.screenspace){this.gameObject.visible=!1,this.gameObject.removeFromParent();return}this.renderOnTop||this.screenspace?this.gameObject.removeFromParent():(this.onUpdateRenderMode(),this.handleLayoutUpdates(),(n=this.shadowComponent)==null||n.updateMatrixWorld(!0),(o=this.shadowComponent)==null||o.updateWorldMatrix(!0,!0),this.invokeBeforeRenderEvents(),Gi.ensureUpdateMeshUI(h0,this.context))});a(this,"onAfterRenderRoutine",()=>{var e,i,n,o,r;if(((e=this.context.xr)!=null&&e.isVR||(i=this.context.xr)!=null&&i.isPassThrough)&&this.screenspace){(n=this.previousParent)==null||n.add(this.gameObject);return}if((this.screenspace||this.renderOnTop)&&this.previousParent&&this.context.mainCamera){if(this.screenspace){const h=this.context.mainCamera;h==null||h.add(this.gameObject)}else this.previousParent.add(this.gameObject);const l=this.context.renderer.autoClear,c=this.context.renderer.autoClearColor;this.context.renderer.autoClear=!1,this.context.renderer.autoClearColor=!1,this.context.renderer.clearDepth(),this.onUpdateRenderMode(!0),this.handleLayoutUpdates(),(o=this.shadowComponent)==null||o.updateMatrixWorld(!0),this.invokeBeforeRenderEvents(),Gi.ensureUpdateMeshUI(h0,this.context,!0),this.context.renderer.render(this.gameObject,this.context.mainCamera),this.context.renderer.autoClear=l,this.context.renderer.autoClearColor=c,this.previousParent.add(this.gameObject)}(r=this._lastMatrixWorld)==null||r.copy(this.gameObject.matrixWorld)});a(this,"_updateRenderSettingsRoutine");a(this,"_activeRenderMode",-1);a(this,"_lastWidth",-1);a(this,"_lastHeight",-1)}get isCanvas(){return!0}get screenspace(){return this.renderMode!==Ts.WorldSpace}set renderOnTop(e){e!==this._renderOnTop&&(this._renderOnTop=e,this.onRenderSettingsChanged())}get renderOnTop(){return this._renderOnTop!==void 0?this._renderOnTop:!!(this.screenspace&&this._renderMode===Ts.ScreenSpaceOverlay)}set depthWrite(e){this._depthWrite!==e&&(this._depthWrite=e,this.onRenderSettingsChanged())}get depthWrite(){return this._depthWrite}set doubleSided(e){this._doubleSided!==e&&(this._doubleSided=e,this.onRenderSettingsChanged())}get doubleSided(){return this._doubleSided}set castShadows(e){this._castShadows!==e&&(this._castShadows=e,this.onRenderSettingsChanged())}get castShadows(){return this._castShadows}set receiveShadows(e){this._receiveShadows!==e&&(this._receiveShadows=e,this.onRenderSettingsChanged())}get receiveShadows(){return this._receiveShadows}get renderMode(){return this._renderMode}set renderMode(e){this._renderMode!==e&&(this._renderMode=e,this.onRenderSettingsChanged())}set rootCanvas(e){this._rootCanvas instanceof Ft||(this._rootCanvas=e)}get rootCanvas(){return this._rootCanvas}get scaleFactor(){return this._scaleFactor}set scaleFactor(e){this._scaleFactor=e}awake(){var e;this.shadowComponent=this.gameObject,this.previousParent=this.gameObject.parent,Bg&&console.log("Canvas.Awake()",((e=this.previousParent)==null?void 0:e.name)+"/"+this.gameObject.name),super.awake()}start(){this.applyRenderSettings()}onEnable(){super.onEnable(),this._updateRenderSettingsRoutine=void 0,this._lastMatrixWorld=new le,this.applyRenderSettings(),document.addEventListener("resize",this._boundRenderSettingsChanged),this.context.pre_render_callbacks.push(this.onBeforeRenderRoutine),this.context.post_render_callbacks.push(this.onAfterRenderRoutine)}onDisable(){super.onDisable(),document.removeEventListener("resize",this._boundRenderSettingsChanged);const e=this.context.pre_render_callbacks.indexOf(this.onBeforeRenderRoutine);e!==-1&&this.context.pre_render_callbacks.splice(e,1);const i=this.context.post_render_callbacks.indexOf(this.onAfterRenderRoutine);i!==-1&&this.context.post_render_callbacks.splice(i,1)}registerTransform(e){this._rectTransforms.push(e)}unregisterTransform(e){const i=this._rectTransforms.indexOf(e);i!==-1&&this._rectTransforms.splice(i,1)}registerLayoutGroup(e){const i=e.gameObject;this._layoutGroups.set(i,e)}unregisterLayoutGroup(e){const i=e.gameObject;this._layoutGroups.delete(i)}registerEventReceiver(e){this._receivers.push(e)}unregisterEventReceiver(e){const i=this._receivers.indexOf(e);i!==-1&&this._receivers.splice(i,1)}async onEnterXR(e){this.screenspace?(e.xr.isVR||e.xr.isPassThrough)&&(this.gameObject.visible=!1):(this.gameObject.visible=!1,await Ep(1).then(()=>{this.gameObject.visible=!0}))}onLeaveXR(e){this.screenspace&&(e.xr.isVR||e.xr.isPassThrough)&&(this.gameObject.visible=!0)}invokeBeforeRenderEvents(){var e;for(const i of this._receivers)(e=i.onBeforeCanvasRender)==null||e.call(i,this)}handleLayoutUpdates(){this._lastMatrixWorld===null&&(this._lastMatrixWorld=new le);const e=!this._lastMatrixWorld.equals(this.gameObject.matrixWorld);Bg&&e&&console.log("Canvas Layout changed",this.context.time.frameCount,this.name);const i=!1;for(const n of this._rectTransforms){e&&n.markDirty();let o=this._layoutGroups.get(n.gameObject);n.isDirty&&!o&&(o=n.gameObject.getComponentInParent(pn)),(n.isDirty||o!=null&&o.isDirty)&&(Bg&&!i&&console.log("CANVAS UPDATE ### "+n.name+" ##################################### "+this.context.time.frame),o==null||o.updateLayout(),n.updateTransform())}}applyRenderSettings(){this.onRenderSettingsChanged()}onRenderSettingsChanged(){this._updateRenderSettingsRoutine||(this._updateRenderSettingsRoutine=this.startCoroutine(this._updateRenderSettingsDelayed(),oe.OnBeforeRender))}*_updateRenderSettingsDelayed(){if(yield,this._updateRenderSettingsRoutine=void 0,this.shadowComponent){this.onUpdateRenderMode(),Bf(this.shadowComponent,this);for(const e of P.getComponentsInChildren(this.gameObject,ls))Bf(e.shadowComponent,this)}}onUpdateRenderMode(e=!1){if(!e&&this._renderMode===this._activeRenderMode&&this._lastWidth===this.context.domWidth&&this._lastHeight===this.context.domHeight)return;this._activeRenderMode=this._renderMode;let i=this.context.mainCameraComponent,n=10;switch(i&&i.nearClipPlane>0&&i.farClipPlane>0&&(n=W.lerp(i.nearClipPlane,i.farClipPlane,.01)),this._renderMode===Ts.ScreenSpaceCamera&&(this.worldCamera&&(i=this.worldCamera),this.planeDistance>0&&(n=this.planeDistance)),this._renderMode){case Ts.ScreenSpaceOverlay:case Ts.ScreenSpaceCamera:if(this._lastWidth=this.context.domWidth,this._lastHeight=this.context.domHeight,!i)return;const o=n+.01;this.gameObject.position.x=0,this.gameObject.position.y=0,this.gameObject.position.z=-o,this.gameObject.quaternion.identity();const r=this.gameObject.getComponent(Yt);let l=!1;r.sizeDelta.x!==this.context.domWidth&&(l=!0),r.sizeDelta.y!==this.context.domHeight&&(l=!0);const c=i.fieldOfView*Math.PI/180,h=2*Math.tan(c/2)*Math.abs(o);this.gameObject.scale.x=h/this.context.domHeight,this.gameObject.scale.y=h/this.context.domHeight,this.gameObject.scale.z=.01,l&&(r.sizeDelta.x=this.context.domWidth,r.sizeDelta.y=this.context.domHeight,r==null||r.markDirty());break;case Ts.WorldSpace:this._lastWidth=-1,this._lastHeight=-1;break}}}Zs([m()],Ft.prototype,"renderOnTop",null);Zs([m()],Ft.prototype,"depthWrite",null);Zs([m()],Ft.prototype,"doubleSided",null);Zs([m()],Ft.prototype,"castShadows",null);Zs([m()],Ft.prototype,"receiveShadows",null);Zs([m()],Ft.prototype,"renderMode",null);Zs([m(Ft)],Ft.prototype,"rootCanvas",null);Zs([m()],Ft.prototype,"scaleFactor",null);Zs([m(Se)],Ft.prototype,"worldCamera",void 0);Zs([m()],Ft.prototype,"planeDistance",void 0);var vb=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};class qa extends j{constructor(){super(...arguments);a(this,"_alpha",1);a(this,"interactable",!0);a(this,"blocksRaycasts",!0);a(this,"_isDirty",!1);a(this,"_buffer",[])}get alpha(){return this._alpha}set alpha(e){e!==this._alpha&&(this._alpha=e,this.markDirty())}get isCanvasGroup(){return!0}markDirty(){this._isDirty||(this._isDirty=!0,this.startCoroutine(this.applyChangesDelayed(),oe.OnBeforeRender))}*applyChangesDelayed(){this._isDirty=!1,this.applyChangesNow()}applyChangesNow(){this._buffer.length=0;for(const e of P.getComponentsInChildren(this.gameObject,ls,this._buffer)){const i=e;i.setAlphaFactor&&i.setAlphaFactor(this._alpha)}}}vb([m()],qa.prototype,"alpha",null);vb([m()],qa.prototype,"interactable",void 0);vb([m()],qa.prototype,"blocksRaycasts",void 0);class xb{get extensionName(){return"tmui"}onExportObject(t,e,i){const n=P.getComponent(t,Ft);if(n&&n.enabled&&n.renderMode===Ts.WorldSpace){const o=new nm,r=P.getComponent(t,Yt),l=P.getComponent(t,qa),c=new Array;if(r){if(!P.isActiveSelf(t)){const u=P.isActiveSelf(t);P.setActive(t,!0),r.onEnable(),r.updateTransform(),c.push(()=>{r.onDisable(),P.setActive(t,u)})}t.traverse(u=>{if(!P.isActiveInHierarchy(u)){const f=P.isActiveSelf(u);P.setActive(u,!0);const p=P.getComponent(u,ls);p&&(p.onEnable(),c.push(()=>{p.onDisable()}));const g=P.getComponent(u,Yt);g&&(g.onEnable(),g.updateTransform(),g.onApplyTransform(),c.push(()=>{g.onDisable()}));const y=P.getComponent(u,Di);y&&(y.onEnable(),c.push(()=>{y.onDisable()})),c.push(()=>{P.setActive(u,f)})}}),r.width,r.height;const h=hi.createEmpty(),d=r.shadowComponent;if(e.add(h),d){const u=d.matrix;h.setMatrix(u);const f=new Map,p=new Map;f.set(d,h),p.set(d,l?l.alpha:1),d.traverse(g=>{if(g===d)return;const y=hi.createEmpty();y.setMatrix(g.matrix);const b=g.parent,_=!!b&&typeof b.textContent=="string"&&b.textContent.length>0;let v=p.get(b)||1;const S=P.getComponent(g,qa);if(S&&(v*=S.alpha),g instanceof Z&&_){const O=g[On];O?o.exportText(O.gameObject,y,i):console.error("Error when exporting UI: shadow component owner not found. This is likely a bug.",g)}if(g instanceof Z&&!_){const O=g.geometry.clone();O.scale(1,1,-1),this.flipWindingOrder(O),y.geometry=O;const M=new ue,k=g.material.opacity;M.copy(g.material.color),y.material=new Ue({color:M,opacity:k*v,map:g.material.map,transparent:!0})}f.set(g,y),p.set(g,v);const T=f.get(b);if(!T){console.error("Error when exporting UI: shadow component parent not found!",g,g.parent);return}T.add(y)})}}for(const h of c)h()}}flipWindingOrder(t){const e=t.index.array;for(let i=0,n=e.length/3;i<n;i++){const o=e[i*3];e[i*3]=e[i*3+2],e[i*3+2]=o}t.index.needsUpdate=!0}}const e0=class{constructor(){a(this,"_quicklookButton");a(this,"_arButton");a(this,"_vrButton");a(this,"_sendToQuestButton")}static create(){return new e0}static getOrCreate(){return this._instance||(this._instance=this.create()),this._instance}get isSecureConnection(){return window.location.protocol==="https:"}get quicklookButton(){return this._quicklookButton}get arButton(){return this._arButton}get vrButton(){return this._vrButton}get sendToQuestButton(){return this._sendToQuestButton}get qrButton(){return Fs.getOrCreate().createQRCode()}createQuicklookButton(){if(this._quicklookButton)return this._quicklookButton;const t=document.createElement("button");this._quicklookButton=t,t.dataset.needle="quicklook-button";const e=J.supportsQuickLookAR();t.innerText="View in AR",t.prepend(li("view_in_ar"));let i=!1,n=null;return t.addEventListener("click",()=>{n=Wp(Fe),n||(i=!0,n=new Fe),i&&(n.objectToExport=ne.Current.scene),n?(t.classList.add("this-mode-is-requested"),n.exportAndOpen().then(()=>{t.classList.remove("this-mode-is-requested")}).catch(o=>{t.classList.remove("this-mode-is-requested"),console.error(o)})):console.warn("No USDZExporter component found in the scene")}),this.hideElementDuringXRSession(t),t}createARButton(t){var n;if(this._arButton)return this._arButton;const e="immersive-ar",i=document.createElement("button");return this._arButton=i,i.classList.add("webxr-button"),i.dataset.needle="webxr-ar-button",i.innerText="Enter AR",i.prepend(li("view_in_ar")),i.title="Click to start an AR session",i.addEventListener("click",()=>te.start(e,t)),this.updateSessionSupported(i,e),this.listenToXRSessionState(i,e),this.hideElementDuringXRSession(i),this.isSecureConnection||(i.disabled=!0,i.title="WebXR requires a secure connection (HTTPS)"),J.isMozillaXR()||(n=navigator.xr)==null||n.addEventListener("devicechange",()=>this.updateSessionSupported(i,e)),i}createVRButton(t){var n;if(this._vrButton)return this._vrButton;const e="immersive-vr",i=document.createElement("button");return this._vrButton=i,i.classList.add("webxr-button"),i.dataset.needle="webxr-vr-button",i.innerText="Enter VR",i.prepend(li("panorama_photosphere")),i.title="Click to start a VR session",i.addEventListener("click",()=>te.start(e,t)),this.updateSessionSupported(i,e),this.listenToXRSessionState(i,e),this.hideElementDuringXRSession(i),this.isSecureConnection||(i.disabled=!0,i.title="WebXR requires a secure connection (HTTPS)"),J.isMozillaXR()||(n=navigator.xr)==null||n.addEventListener("devicechange",()=>this.updateSessionSupported(i,e)),i}createSendToQuestButton(){var i;if(this._sendToQuestButton)return this._sendToQuestButton;const t="https://oculus.com/open_url/?url=",e=document.createElement("button");return this._sendToQuestButton=e,e.dataset.needle="webxr-sendtoquest-button",e.innerText="Open on Quest",e.prepend(li("share_windows")),e.title="Click to send this page to the Oculus Browser on your Quest",e.addEventListener("click",()=>{const n=encodeURIComponent(window.location.href),o=t+n;window.open(o)==null&&tt("This page doesn't allow popups. Please paste "+o+" into your browser.")}),this.listenToXRSessionState(e),this.hideElementDuringXRSession(e),J.isMozillaXR()||(i=navigator.xr)==null||i.addEventListener("devicechange",()=>{var n;(n=navigator.xr)!=null&&n.isSessionSupported("immersive-vr")?e.style.display="none":e.style.display=""}),e}createQRCode(){return Fs.getOrCreate().createQRCode()}updateSessionSupported(t,e){if(!("xr"in navigator)){t.style.display="none";return}te.isSessionSupported(e).then(i=>{t.style.display=i?"":"none",U()&&!i&&console.log('[WebXR] "'+e+'" is not supported on this device ‚Äì make sure your server runs using HTTPS and you have a device connected that supports '+e)})}hideElementDuringXRSession(t){B_(e=>{t["previous-display"]=t.style.display,t.style.display="none"}),eS(e=>{t["previous-display"]!=null&&(t.style.display=t["previous-display"])})}listenToXRSessionState(t,e){e&&(te.onSessionRequestStart(i=>{i.mode===e?t.classList.add("this-mode-is-requested"):(t["was-disabled"]=t.disabled,t.disabled=!0,t.classList.add("other-mode-is-requested"))}),te.onSessionRequestEnd(i=>{t.classList.remove("this-mode-is-requested"),t.classList.remove("other-mode-is-requested"),t.disabled=t["was-disabled"]}))}};let Br=e0;a(Br,"_instance");var Ut=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const Xf=C("debugspriterenderer"),T2=C("wireframe"),pp=class{static getOrCreateGeometry(t){if(t.__cached_geometry)return t.__cached_geometry;if(t.guid&&pp.cache[t.guid])return Xf&&console.log("Take cached geometry for sprite",t.guid),pp.cache[t.guid];const e=new ko;t.__cached_geometry=e;const i=new Float32Array(t.triangles.length*3),n=new Float32Array(t.triangles.length*2);for(let o=0;o<t.triangles.length;o+=1){const r=t.triangles[o];i[o*3]=-t.vertices[r].x,i[o*3+1]=t.vertices[r].y,i[o*3+2]=0;const l=t.uv[r];n[o*2]=l.x,n[o*2+1]=1-l.y}return e.setAttribute("position",new $i(i,3)),e.setAttribute("uv",new $i(n,2)),t.guid&&(this.cache[t.guid]=e),Xf&&console.log("Built sprite geometry",t,e),e}};let Ua=pp;a(Ua,"cache",{});var Qf;(function(s){s[s.Simple=0]="Simple",s[s.Sliced=1]="Sliced",s[s.Tiled=2]="Tiled"})(Qf||(Qf={}));class k2{constructor(){a(this,"x");a(this,"y")}}function E1(s){s&&(s.colorSpace!=rs&&(s.colorSpace=rs,s.needsUpdate=!0),s.minFilter==gf&&s.magFilter==gf&&(s.anisotropy=1,s.needsUpdate=!0))}let Jo=class{constructor(t){a(this,"guid");a(this,"texture");a(this,"triangles");a(this,"uv");a(this,"vertices");a(this,"__cached_geometry");a(this,"_mesh");a(this,"_material");t&&(this.texture=t,this.triangles=[0,1,2,0,2,3],this.uv=[{x:0,y:0},{x:1,y:0},{x:1,y:1},{x:0,y:1}],this.vertices=[{x:-.5,y:-.5},{x:.5,y:-.5},{x:.5,y:.5},{x:-.5,y:.5}])}get mesh(){return this._mesh||(this._mesh=new Z(Ua.getOrCreateGeometry(this),this.material)),this._mesh}get material(){return this._material||(this.texture&&E1(this.texture),this._material=new Ue({map:this.texture,color:16777215,side:hn,transparent:!0})),this._material}getGeometry(){return Ua.getOrCreateGeometry(this)}};Ut([m()],Jo.prototype,"guid",void 0);Ut([m(Je)],Jo.prototype,"texture",void 0);Ut([Ic()],Jo.prototype,"triangles",void 0);Ut([Ic()],Jo.prototype,"uv",void 0);Ut([Ic()],Jo.prototype,"vertices",void 0);const Fg=Symbol("spriteOwner");class kc{constructor(){a(this,"sprites");this.sprites=[]}}Ut([m(Jo)],kc.prototype,"sprites",void 0);class ns{constructor(){a(this,"spriteSheet");a(this,"index",0)}static create(){const t=new ns;return t.spriteSheet=new kc,t}clone(){const t=new ns;return t.index=this.index,t.spriteSheet=this.spriteSheet,t}set sprite(t){t&&(this.spriteSheet?((this.index===null||this.index===void 0)&&(this.index=0),this.spriteSheet.sprites[this.index]=t):(this.spriteSheet=new kc,this.spriteSheet.sprites=[t],this.index=0))}get sprite(){if(this.spriteSheet)return this.spriteSheet.sprites[this.index]}update(t){if(!this.spriteSheet)return;const e=this.index;if(e<0||e>=this.spriteSheet.sprites.length)return;const i=this.spriteSheet.sprites[e],n=i==null?void 0:i.texture;if(n&&(E1(n),!i.__hasLoadedProgressive)){i.__hasLoadedProgressive=!0;const o=n;mt.assignTextureLOD(n,0).then(r=>{r instanceof Je&&(i.texture=r,(t==null?void 0:t.map)===o&&(t.map=r,t.needsUpdate=!0))})}}}Ut([m(kc)],ns.prototype,"spriteSheet",void 0);Ut([m()],ns.prototype,"index",void 0);class mn extends j{constructor(){super(...arguments);a(this,"drawMode",Qf.Simple);a(this,"size",{x:1,y:1});a(this,"color");a(this,"sharedMaterial");a(this,"transparent",!0);a(this,"cutoutThreshold",0);a(this,"castShadows",!1);a(this,"renderOrder",0);a(this,"toneMapped",!0);a(this,"_spriteSheet");a(this,"_currentSprite")}set texture(e){var n;if(!this._spriteSheet)return;const i=(n=this._spriteSheet.spriteSheet)==null?void 0:n.sprites[this.spriteIndex];i&&(i.texture=e,this.updateSprite())}addSprite(e,i=!1){var o,r;if(this._spriteSheet||(this._spriteSheet=ns.create()),!this._spriteSheet.spriteSheet)return-1;(o=this._spriteSheet.spriteSheet)==null||o.sprites.push(e);const n=((r=this._spriteSheet.spriteSheet)==null?void 0:r.sprites.length)-1;return i&&(this.spriteIndex=n),n}get sprite(){return this._spriteSheet}set sprite(e){if(e!==this._spriteSheet)if(typeof e=="number"){const i=Math.floor(e);this.spriteIndex=i}else e instanceof Jo?(this._spriteSheet||(this._spriteSheet=ns.create()),this._spriteSheet.sprite!=e&&(this._spriteSheet.sprite=e),this.updateSprite()):e!=this._spriteSheet&&(this._spriteSheet=e,this.updateSprite())}set spriteIndex(e){this._spriteSheet&&(this._spriteSheet.index=e,this.updateSprite())}get spriteIndex(){var e;return((e=this._spriteSheet)==null?void 0:e.index)??0}get spriteFrames(){var e,i;return((i=(e=this._spriteSheet)==null?void 0:e.spriteSheet)==null?void 0:i.sprites.length)??0}awake(){this._currentSprite=void 0,this._spriteSheet?this._spriteSheet=this._spriteSheet.clone():this._spriteSheet=ns.create(),Xf&&console.log("Awake",this.name,this,this.sprite)}start(){this._currentSprite?this.gameObject&&this.gameObject.add(this._currentSprite):this.updateSprite()}updateSprite(e=!1){var o;if(!this.__didAwake&&!e)return!1;const i=this._spriteSheet;if(!((o=i==null?void 0:i.spriteSheet)!=null&&o.sprites))return console.warn("SpriteRenderer has no data or spritesheet assigned..."),!1;const n=i.spriteSheet.sprites[this.spriteIndex];if(!n)return Xf&&console.warn("Sprite not found",this.spriteIndex,i.spriteSheet.sprites),!1;if(this._currentSprite)this._currentSprite.geometry=Ua.getOrCreateGeometry(n),this._currentSprite.material.map=n.texture;else{const r=new Ue({color:16777215,side:hn});if(T2&&(r.wireframe=!0),this.color&&(r.color||(r.color=new ue),r.color.copy(this.color),r.opacity=this.color.alpha),r.transparent=!0,r.toneMapped=this.toneMapped,r.depthWrite=!1,n.texture&&!r.wireframe){let l=n.texture;l[Fg]!==void 0&&l[Fg]!==this&&this.spriteFrames>1&&(l=n.texture=l.clone()),l[Fg]=this,r.map=l}this.sharedMaterial=r,this._currentSprite=new Z(Ua.getOrCreateGeometry(n),r),this._currentSprite.renderOrder=Math.round(this.renderOrder),mt.assignTextureLOD(r,0)}return this._currentSprite.parent!==this.gameObject&&(this.drawMode===Qf.Tiled&&this._currentSprite.scale.set(this.size.x,this.size.y,1),this.gameObject&&this.gameObject.add(this._currentSprite)),this._currentSprite&&this._currentSprite.layers.set(this.layer),this.sharedMaterial&&(this.sharedMaterial.alphaTest=this.cutoutThreshold,this.sharedMaterial.transparent=this.transparent),this._currentSprite.castShadow=this.castShadows,i==null||i.update(this.sharedMaterial),!0}}Ut([m()],mn.prototype,"drawMode",void 0);Ut([m(k2)],mn.prototype,"size",void 0);Ut([m(Ae)],mn.prototype,"color",void 0);Ut([m(De)],mn.prototype,"sharedMaterial",void 0);Ut([m()],mn.prototype,"transparent",void 0);Ut([m()],mn.prototype,"cutoutThreshold",void 0);Ut([m()],mn.prototype,"castShadows",void 0);Ut([m()],mn.prototype,"renderOrder",void 0);Ut([m()],mn.prototype,"toneMapped",void 0);Ut([m(ns)],mn.prototype,"sprite",null);const Rx=C("debugwebxr"),E2=new le().makeRotationY(Math.PI),Yl=class extends j{constructor(){super(...arguments);a(this,"_arScale",1);a(this,"invertForward",!1);a(this,"customReticle");a(this,"arTouchTransform",!0);a(this,"autoPlace",!1);a(this,"autoCenter",!1);a(this,"useXRAnchor",!1);a(this,"_isPlacing",!0);a(this,"_startOffset",new le);a(this,"_createdPlacementObject",null);a(this,"_reparentedComponents",[]);a(this,"_placementScene",new In);a(this,"_reticle",[]);a(this,"_hits",[]);a(this,"_placementStartTime",-1);a(this,"_rigPlacementMatrix");a(this,"_anchor",null);a(this,"userInput");a(this,"onPlaceScene",e=>{var o;if(this._isPlacing==!1||e!=null&&e.used)return;let i=this._reticle[0];if(!i){console.warn("No reticle to place...");return}if(!i.visible&&!this.autoPlace){console.warn("Reticle is not visible (can not place)");return}if((o=te.active)!=null&&o.isTrackingImages){console.warn("Scene Placement is disabled while images are being tracked");return}let n=this._hits[0];if(e&&e.origin instanceof iS){const r=this._reticle[e.origin.index];r&&(i=r,n=this._hits[e.origin.index])}if(e&&(e.stopImmediatePropagation(),e.stopPropagation(),e.use()),this._isPlacing=!1,this.context.input.removeEventListener("pointerup",this.onPlaceScene),this.onRevertSceneChanges(),i.position.copy(i.lastPos),i.quaternion.copy(i.lastQuat),this.onApplyPose(i),Yl._hasPlaced=!0,this.useXRAnchor&&this.onCreateAnchor(te.active,n),this.context.xr)for(const r of this.context.xr.controllers)r.cancelHitTestSource()});a(this,"upVec",new x(0,1,0));a(this,"lookPoint",new x);a(this,"worldUpVec",new x(0,1,0))}static onPlaced(e){const i="placed";return this._eventListeners[i]||(this._eventListeners[i]=[]),this._eventListeners[i].push(e),()=>{const n=this._eventListeners[i].indexOf(e);n>=0&&this._eventListeners[i].splice(n,1)}}static get hasPlaced(){return this._hasPlaced}get arScale(){return this._arScale}set arScale(e){this._arScale=Math.max(1e-6,e),this.onSetScale()}onEnable(){var e;(e=this.customReticle)==null||e.preload()}supportsXR(e){return e==="immersive-ar"}onEnterXR(e){Rx&&console.log("ENTER WEBXR: SessionRoot start..."),this._anchor=null,Yl._hasPlaced=!1,this.gameObject.updateMatrixWorld(),this._startOffset.copy(this.gameObject.matrixWorld);const i=new F;this._createdPlacementObject=i,i.name="AR Session Root",this._placementScene.name="AR Placement Scene",this._placementScene.children.length=0;for(let n=this.context.scene.children.length-1;n>=0;n--){const o=this.context.scene.children[n];this._placementScene.add(o)}if(this.context.scene.add(i),this.autoCenter){const n=dn(this._placementScene.children),o=n.getCenter(new x),r=n.getSize(new x),l=new le;l.makeTranslation(o.x,o.y-r.y*.5,o.z),this._startOffset.multiply(l)}this._reparentedComponents.length=0,this._reparentedComponents.push({comp:this,originalObject:this.gameObject}),P.addComponent(i,this);for(const n of this._reticle)Ln(n);this._reticle.length=0,this._isPlacing=!0,this.context.input.addEventListener("pointerup",this.onPlaceScene,{queue:Wi.Early})}onLeaveXR(){this.context.input.removeEventListener("pointerup",this.onPlaceScene,{queue:Wi.Early}),this.onRevertSceneChanges(),this._anchor=null,Yl._hasPlaced=!1,this._rigPlacementMatrix=void 0}onUpdateXR(e){var i,n,o,r;if(e.xr.isTrackingImages){for(const l of this._reticle)l.visible=!1;return}if(this._isPlacing){const l=(i=e.xr.rig)==null?void 0:i.gameObject;l&&l.parent!==this.context.scene&&this.context.scene.add(l);let c=!1;if(e.xr.isPassThrough&&e.xr.controllers.length>0&&!this.autoPlace)for(const h of e.xr.controllers){const d=h.getHitTest();d&&(c=!0,this.updateReticleAndHits(e.xr,h.index,d,e.xr.rigScale))}if(!c){const h=e.xr.getHitTest();h&&this.updateReticleAndHits(e.xr,0,h,e.xr.rigScale)}}else{if(this._anchor&&e.xr.referenceSpace){const l=e.xr.frame.getPose(this._anchor.anchorSpace,e.xr.referenceSpace);if(l&&this.context.time.frame%20===0){const c=e.xr.convertSpace(l.transform),h=this._reticle[0];h&&(h.position.copy(c.position),h.quaternion.copy(c.quaternion),this.onApplyPose(h))}}if(this.arTouchTransform?(this.userInput||(this.userInput=new Dl(this.context)),(n=this.userInput)==null||n.enable()):(o=this.userInput)==null||o.disable(),this.arTouchTransform&&((r=this.userInput)!=null&&r.hasChanged)){if(e.xr.rig){const l=e.xr.rig.gameObject;this.userInput.applyMatrixTo(l.matrix,!0),l.matrix.decompose(l.position,l.quaternion,l.scale),this.userInput.factor=l.scale.x}this.userInput.reset()}}}updateReticleAndHits(e,i,n,o){this._hits[i]=n.hit;let r=this._reticle[i];if(!r){if(this.customReticle)if(this.customReticle.asset)r=Pc(this.customReticle.asset);else{this.customReticle.loadAssetAsync();return}else r=new Z(new dR(.07,.09,32).rotateX(-Math.PI/2),new Ue({side:hn,depthTest:!1,depthWrite:!1,transparent:!0,opacity:1,color:15658734})),r.name="AR Placement Reticle";if(Rx){const l=new ln(1);l.position.y+=.01,r.add(l)}this._reticle[i]=r,r.matrixAutoUpdate=!1,r.visible=!1}if(r.lastPos=r.lastPos||n.position.clone(),r.lastQuat=r.lastQuat||n.quaternion.clone(),r.position.copy(r.lastPos.lerp(n.position,this.context.time.deltaTime/.1)),r.lastPos.copy(r.position),r.quaternion.copy(r.lastQuat.slerp(n.quaternion,this.context.time.deltaTime/.05)),r.lastQuat.copy(r.quaternion),r.scale.set(o,o,o),this.customReticle&&this.applyViewBasedTransform(r),r.updateMatrix(),r.visible=!0,r.parent!==this.context.scene&&this.context.scene.add(r),this._placementStartTime<0&&(this._placementStartTime=this.context.time.realtimeSinceStartup),this.autoPlace)if(this.upVec.set(0,1,0).applyQuaternion(r.quaternion),this.upVec.dot(Q(0,1,0))>.9){let c=r["autoplace:timer"]||0;c>=1?(r.visible=!1,this.onPlaceScene(null)):(c+=this.context.time.deltaTime,r["autoplace:timer"]=c)}else r["autoplace:timer"]=0}onSetScale(){var i,n,o;if(!Yl._hasPlaced)return;const e=(n=(i=te.active)==null?void 0:i.rig)==null?void 0:n.gameObject;if(e){const r=((o=te.active)==null?void 0:o.rigScale)||1,l=1/this._arScale*r,c=new le().makeScale(l,l,l).invert();e.matrix.premultiply(c),e.matrix.decompose(e.position,e.quaternion,e.scale)}}onRevertSceneChanges(){var e;for(const i of this._reticle)i&&(i.visible=!1,i==null||i.removeFromParent());this._reticle.length=0;for(let i=this._placementScene.children.length-1;i>=0;i--){const n=this._placementScene.children[i];this.context.scene.add(n)}(e=this._createdPlacementObject)==null||e.removeFromParent();for(const i of this._reparentedComponents)P.addComponent(i.originalObject,i.comp)}async onCreateAnchor(e,i){if(i.createAnchor===void 0){console.warn("Hit does not support creating an anchor",i),U()&&Me("Hit does not support creating an anchor");return}else{const n=await i.createAnchor(e.viewerPose.transform);e.running&&n&&(this._anchor=n)}}applyViewBasedTransform(e){const i=this.context.mainCamera,n=e,o=i.worldPosition,r=n.worldPosition;this.upVec.set(0,1,0).applyQuaternion(e.quaternion);const l=i.worldPosition;l&&e.position.clone().sub(l).angleTo(this.upVec)<Math.PI/2&&this.upVec.negate();const c=this.upVec.angleTo(this.worldUpVec)*180/Math.PI,h=30;c>h&&c<180-h||c<-h&&c>-180+h?(this.lookPoint.copy(e.position).add(this.upVec),this.lookPoint.y=e.position.y,e.lookAt(this.lookPoint)):(o.y=r.y,e.lookAt(o))}onApplyPose(e){var o,r,l;const i=(r=(o=te.active)==null?void 0:o.rig)==null?void 0:r.gameObject;if(!i){console.warn("No rig object to place");return}const n=i.parent||this.context.scene;this._rigPlacementMatrix?(l=this._rigPlacementMatrix)==null||l.decompose(i.position,i.quaternion,i.scale):this._rigPlacementMatrix=i.matrix.clone(),this.applyViewBasedTransform(e),e.updateMatrix(),this.context.scene.add(e),e.attach(i),e.removeFromParent(),i.scale.set(this.arScale,this.arScale,this.arScale),i.position.multiplyScalar(this.arScale),i.updateMatrix(),this.invertForward&&i.matrix.premultiply(E2),i.matrix.premultiply(this._startOffset),i.matrix.decompose(i.position,i.quaternion,i.scale),n.add(i)}};let es=Yl;a(es,"_eventListeners",{}),a(es,"_hasPlaced",!1);const mp=class{constructor(t){a(this,"oneFingerDrag",!0);a(this,"twoFingerRotate",!0);a(this,"twoFingerScale",!0);a(this,"factor",1);a(this,"context");a(this,"offset");a(this,"plane");a(this,"_scale",1);a(this,"_hasChanged",!1);a(this,"_enabled",!1);a(this,"currentlyUsedPointerIds",new Set);a(this,"currentlyUnusedPointerIds",new Set);a(this,"onPointerDownEarly",t=>{this.isActive&&t.stopPropagation()});a(this,"onPointerDownLate",t=>{t.used?this.currentlyUsedPointerIds.add(t.pointerId):this.currentlyUsedPointerIds.size<=0&&this.currentlyUnusedPointerIds.add(t.pointerId)});a(this,"onPointerUpEarly",t=>{this.currentlyUsedPointerIds.delete(t.pointerId),this.currentlyUnusedPointerIds.delete(t.pointerId)});a(this,"prev",new Map);a(this,"_didMultitouch",!1);a(this,"touchStart",t=>{if(!t.defaultPrevented)for(let e=0;e<t.changedTouches.length;e++){const i=t.changedTouches[e],n=J.isAndroidDevice()&&i.clientY<window.innerHeight*.1;this.prev.has(i.identifier)||this.prev.set(i.identifier,{ignore:n,x:0,z:0,screenx:0,screeny:0});const o=this.prev.get(i.identifier);if(o){const r=this.getPositionOnPlane(i.clientX,i.clientY);o.x=r.x,o.z=r.z,o.screenx=i.clientX,o.screeny=i.clientY}}});a(this,"touchEnd",t=>{t.touches.length<=0&&(this._didMultitouch=!1);for(let e=0;e<t.changedTouches.length;e++){const i=t.changedTouches[e];this.prev.delete(i.identifier)}});a(this,"touchMove",t=>{if(!t.defaultPrevented&&this.isActive){if(t.touches.length===1){if(this._didMultitouch)return;const e=t.touches[0],i=this.prev.get(e.identifier);if(!i||i.ignore)return;const n=this.getPositionOnPlane(e.clientX,e.clientY),o=n.x-i.x,r=n.z-i.z;if(o===0&&r===0)return;this.oneFingerDrag&&this.addMovement(o,r),i.x=n.x,i.z=n.z,i.screenx=e.clientX,i.screeny=e.clientY;return}else if(t.touches.length===2){this._didMultitouch=!0;const e=t.touches[0],i=t.touches[1],n=this.prev.get(e.identifier),o=this.prev.get(i.identifier);if(!n||!o)return;if(this.twoFingerRotate){const r=Math.atan2(e.clientY-i.clientY,e.clientX-i.clientX),l=Math.atan2(n.screeny-o.screeny,n.screenx-o.screenx),c=r-l;Math.abs(c)>.001&&this.addRotation(c)}if(this.twoFingerScale){const r=e.clientX-i.clientX,l=e.clientY-i.clientY,c=Math.sqrt(r*r+l*l),h=n.screenx-o.screenx,d=n.screeny-o.screeny,u=Math.sqrt(h*h+d*d),f=c-u;Math.abs(f)>2&&this.addScale(f)}n.screenx=e.clientX,n.screeny=e.clientY,o.screenx=i.clientX,o.screeny=i.clientY}}});a(this,"_raycaster",new Sp);a(this,"_intersection",new x);a(this,"_screenPos",new x);a(this,"_tempMatrix",new le);this.context=t,this.offset=new le,this.plane=new $a,this.plane.setFromNormalAndCoplanarPoint(mp.up,mp.zero)}get scale(){return this._scale}reset(){this._scale=1,this.offset.identity(),this._hasChanged=!0}get hasChanged(){return this._hasChanged}applyMatrixTo(t,e){this._hasChanged=!1,e?(this.offset.invert(),t.premultiply(this.offset)):t.multiply(this.offset)}get isActive(){return this.currentlyUsedPointerIds.size<=0&&this.currentlyUnusedPointerIds.size>0}enable(){this._enabled||(this._enabled=!0,this.context.input.addEventListener("pointerdown",this.onPointerDownEarly,{queue:Wi.Early}),this.context.input.addEventListener("pointerdown",this.onPointerDownLate,{queue:Wi.Late}),this.context.input.addEventListener("pointerup",this.onPointerUpEarly,{queue:Wi.Early}),window.addEventListener("touchstart",this.touchStart,{passive:!1}),window.addEventListener("touchmove",this.touchMove,{passive:!1}),window.addEventListener("touchend",this.touchEnd,{passive:!1}))}disable(){this._enabled&&(this._enabled=!1,this.context.input.removeEventListener("pointerdown",this.onPointerDownEarly,{queue:Wi.Early}),this.context.input.removeEventListener("pointerdown",this.onPointerDownLate,{queue:Wi.Late}),this.context.input.removeEventListener("pointerup",this.onPointerUpEarly,{queue:Wi.Early}),window.removeEventListener("touchstart",this.touchStart),window.removeEventListener("touchmove",this.touchMove),window.removeEventListener("touchend",this.touchEnd))}getPositionOnPlane(t,e){const i=this.context.mainCamera;return this._screenPos.x=t/window.innerWidth*2-1,this._screenPos.y=-(e/window.innerHeight)*2+1,this._screenPos.z=1,this._screenPos.unproject(i),this._raycaster.set(i.position,this._screenPos.sub(i.position)),this._raycaster.ray.intersectPlane(this.plane,this._intersection),this._intersection}addMovement(t,e){t/=this._scale,e/=this._scale,t*=this.factor,e*=this.factor,this.offset.elements[12]+=t,this.offset.elements[14]+=e,(t!==0||e!==0)&&(this._hasChanged=!0)}addScale(t){t/=window.innerWidth,t*=-1,this._scale*=1+t,this._tempMatrix.makeScale(1-t,1-t,1-t),this.offset.premultiply(this._tempMatrix),t!==0&&(this._hasChanged=!0)}addRotation(t){t*=-1,this._tempMatrix.makeRotationY(t),this.offset.premultiply(this._tempMatrix),t!==0&&(this._hasChanged=!0)}};let Dl=mp;a(Dl,"up",new x(0,1,0)),a(Dl,"zero",new x(0,0,0)),a(Dl,"one",new x(1,1,1));const vr=C("debugautosync"),zg=Symbol("syncerId");class M2{constructor(){a(this,"_syncers",{})}getOrCreateSyncer(t){if(!t.guid)return null;if(this._syncers[t.guid])return this._syncers[t.guid];const e=new A2(t);return e[zg]=t.guid,this._syncers[e[zg]]=e,e}removeSyncer(t){delete this._syncers[t[zg]]}}const wb=new M2;class A2{constructor(t){a(this,"comp");a(this,"hasChanges",!1);a(this,"changedProperties",{});a(this,"_isReceiving",!1);a(this,"_isInit",!1);a(this,"onHandleSending",()=>{if(!this.hasChanges)return;this.hasChanges=!1;const t=this.comp.context.connection;if(!t||!t.isConnected||!t.isInRoom){for(const e in this.changedProperties)delete this.changedProperties[e];return}for(const e in this.changedProperties){const i=this.changedProperties[e];vr&&console.log("SEND",this.comp.guid,this.networkingKey),t.send(this.networkingKey,{guid:this.comp.guid,property:e,data:i},Qn.Queued),delete this.changedProperties[e]}});a(this,"onHandleReceiving",t=>{if(vr&&console.log("SYNCFIELD RECEIVE",this.comp.name,this.comp.guid,t),!!this._isInit&&this.comp&&t.guid===this.comp.guid)try{this._isReceiving=!0,this.comp[t.property]=t.data}catch(e){console.error(e)}finally{this._isReceiving=!1}});this.comp=t}get networkingKey(){return this.comp.guid}init(t){if(this._isInit)return;this._isInit=!0,this.comp=t,this.comp.context.post_render_callbacks.push(this.onHandleSending),this.comp.context.connection.beginListen(this.networkingKey,this.onHandleReceiving);const e=this.comp.context.connection.tryGetState(this.comp.guid);e&&this.onHandleReceiving(e)}destroy(){this._isInit&&(this.comp.context.post_render_callbacks.splice(this.comp.context.post_render_callbacks.indexOf(this.onHandleSending),1),this.comp.context.connection.stopListen(this.networkingKey,this.onHandleReceiving),this.comp=null,this._isInit=!1)}notifyChanged(t,e){this._isReceiving||(vr&&console.log("Property changed: "+t,e),this.hasChanges=!0,this.changedProperties[t]=e)}}function I2(s,t){let e=t!==s;return!e&&s&&t&&(Array.isArray(s)&&Array.isArray(t)||typeof s=="object"&&typeof t=="object")&&(e=!0),e}const Kh=Symbol("AutoSyncHandler");function D2(s){if(s[Kh])return s[Kh];const t=wb.getOrCreateSyncer(s);return t==null||t.init(s),s[Kh]=t,t}function L2(s){const t=s[Kh];t&&(wb.removeSyncer(t),t.destroy(),delete s[Kh])}const M1=function(s=null){return function(t,e){var d;let i="";typeof e=="string"?i=e:i=e.name;let n=null,o;typeof s=="string"?o=t[s]:typeof s=="function"&&(o=s),o==null&&(U()||vr)&&s!=null&&console.warn('syncField: no callback function found for property "'+i+'"','"'+s+'"');const r=t,l=r.__internalAwake;if(typeof l!="function"){(vr||U())&&console.error('@syncField can currently only used on Needle Engine Components, custom object of type "'+((d=t==null?void 0:t.constructor)==null?void 0:d.name)+'" is not supported',t);return}vr&&console.log(i);const c=Symbol(i);r.__internalAwake=function(){if(this[c]!==void 0)return;this[c]=this[i],n=wb.getOrCreateSyncer(this);const u=Object.getOwnPropertyDescriptor(this,i);if((u==null?void 0:u.set)===void 0){let f=!1;Object.defineProperty(this,i,{set:function(p){var y;const g=this[c];if(this[c]=p,f){(U()||vr)&&console.warn("Recursive call detected",i);return}f=!0;try{const b=I2(p,g);vr&&console.log("SyncField assignment",i,"changed?",b,p,o),b&&(o==null?void 0:o.call(this,p,g))!==!1&&((y=D2(this))==null||y.notifyChanged(i,p))}finally{f=!1}},get:function(){return this[c]},configurable:!0,enumerable:!0})}n==null||n.init(this),l.call(this)};const h=r.__internalDestroy;r.__internalDestroy=function(){L2(this),h.call(this)}}};var sm=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const Ri=C("debugplayersync");class ll extends j{constructor(){super(...arguments);a(this,"autoSync",!0);a(this,"asset");a(this,"onPlayerSpawned");a(this,"_localInstance");a(this,"onJoinedRoom",()=>{Ri&&console.log("PlayerSync.joinedRoom. autoSync is set to "+this.autoSync),this.autoSync&&this.getInstance()});a(this,"destroyInstance",()=>{var e;(e=this._localInstance)==null||e.then(i=>{Ri&&console.log("PlayerSync.destroyInstance",i),zp(i,this.context.connection,!0,{saveInRoom:!1})}),this._localInstance=void 0})}static async setupFrom(e,i){const n=de.getOrCreateFromUrl(e);if(!n.asset){const l=await n.loadAssetAsync();l&&P.getOrAddComponent(l,Xt)}const o=new ll;o._internalInit(i),o.asset=n;const r=new F;return r.guid=e,P.addComponent(r,o),o}awake(){this.watchTabVisible(),this.onPlayerSpawned||(this.onPlayerSpawned=new Te)}onEnable(){this.context.connection.beginListen(se.RoomStateSent,this.onJoinedRoom),this.context.connection.beginListen(se.JoinedRoom,this.onJoinedRoom),this.context.connection.beginListen(se.LeftRoom,this.destroyInstance),this.context.connection.isInRoom&&this.onJoinedRoom()}onDisable(){this.context.connection.stopListen(se.RoomStateSent,this.onJoinedRoom),this.context.connection.stopListen(se.JoinedRoom,this.onJoinedRoom),this.context.connection.stopListen(se.LeftRoom,this.destroyInstance)}async getInstance(){var i,n,o,r,l,c;if(this._localInstance)return this._localInstance;if(Ri&&console.log("PlayerSync.createInstance",(i=this.asset)==null?void 0:i.url),!((n=this.asset)!=null&&n.asset)&&!((o=this.asset)!=null&&o.url))return console.error('PlayerSync: can not create an instance because "asset" is not set and or has no URL!'),null;this.gameObject.guid||console.warn("PlayerSync: gameObject has no guid! This might cause issues with syncing the player state."),this._localInstance=(r=this.asset)==null?void 0:r.instantiateSynced({parent:this.gameObject,deleteOnDisconnect:!0},!0);const e=await this._localInstance;if(e){const h=P.getComponentsInChildren(e,Xt);if(Ri&&console.log(`PlayerSync.createInstance: found ${h==null?void 0:h.length} PlayerState components. Owner: ${this.context.connection.connectionId}`),h!=null&&h.length){for(const d of h)d.owner=this.context.connection.connectionId;(l=this.onPlayerSpawned)==null||l.invoke(e)}else this._localInstance=void 0,console.error("<strong>Failed finding PlayerState on "+((c=this.asset)==null?void 0:c.url)+"</strong>: please make sure the asset has a PlayerState component!"),P.destroySynced(e)}else this._localInstance=void 0,console.warn("PlayerSync: failed instantiating asset!");return this._localInstance}watchTabVisible(){window.addEventListener("visibilitychange",e=>{if(document.visibilityState==="visible")for(let i=Xt.all.length-1;i>=0;i--){const n=Xt.all[i];(!n.owner||!this.context.connection.userIsInRoom(n.owner))&&n.doDestroy()}})}}sm([m()],ll.prototype,"autoSync",void 0);sm([m(de)],ll.prototype,"asset",void 0);sm([m(Te)],ll.prototype,"onPlayerSpawned",void 0);var r_;(function(s){s.OwnerChanged="ownerChanged"})(r_||(r_={}));const kt=class extends j{constructor(){super(...arguments);a(this,"onOwnerChangeEvent",new Te);a(this,"onFirstOwnerChangeEvent",new Te);a(this,"hasOwner",!1);a(this,"owner");a(this,"dontDestroy",!1);a(this,"onUserLeftRoom",e=>{if(e.userId===this.owner){Ri&&console.log("PLAYERSYNC LEFT",this.owner),this.doDestroy();return}})}static get all(){return kt._all}static get local(){return kt._local}static getFor(e){if(e instanceof F)return P.getComponentInParent(e,kt);if(e instanceof j)return P.getComponentInParent(e.gameObject,kt)}static isLocalPlayer(e){const i=kt.getFor(e);return(i==null?void 0:i.isLocalPlayer)??!1}static addEventListener(e,i){return this._callbacks[e]||(this._callbacks[e]=[]),this._callbacks[e].push(i),i}static removeEventListener(e,i){if(!this._callbacks[e])return;const n=this._callbacks[e].indexOf(i);n>=0&&this._callbacks[e].splice(n,1)}static dispatchEvent(e,i){if(this._callbacks[e])for(const n of this._callbacks[e])n(i)}get isLocalPlayer(){return this.owner===this.context.connection.connectionId}onOwnerChange(e,i){var l,c;Ri&&console.log(`PlayerSync.onOwnerChange: ${i} ‚Üí ${e} (me: ${this.context.connection.connectionId})`);const n=kt._local.indexOf(this);n>=0&&kt._local.splice(n,1);const o={playerState:this,oldValue:i,newValue:e};if(this.hasOwner||(this.hasOwner=!0,(l=this.onFirstOwnerChangeEvent)==null||l.invoke(o)),(c=this.onOwnerChangeEvent)==null||c.invoke(o),this.owner===this.context.connection.connectionId){kt._local.push(this);const h=new CustomEvent("local-owner-changed",{detail:o});this.dispatchEvent(h)}const r=new CustomEvent("owner-changed",{detail:o});this.dispatchEvent(r),kt.dispatchEvent(r_.OwnerChanged,r)}awake(){kt.all.push(this),Ri&&console.log("Registered new PlayerState",this.guid,kt.all.length-1,kt.all),this.context.connection.beginListen(se.UserLeftRoom,this.onUserLeftRoom)}async start(){Ri&&console.log("PLAYERSTATE.START, owner: "+this.owner,this.context.connection.usersInRoom([])),this.owner?(this.context.connection.isInRoom||await Xs(300),this.context.connection.userIsInRoom(this.owner)==!1&&(Ri&&console.log(`PlayerSync.start ‚Üí doDestroy "${this.name}" because user "${this.owner}" is not in room anymore...`,"Currently in room:",...this.context.connection.usersInRoom()),this.doDestroy())):this.owner||(Ri&&console.warn("PlayerState.start ‚Üí owner is undefined!",this.name),setTimeout(()=>{!this.destroyed&&!this.owner?this.dontDestroy?Ri&&console.warn("PlayerState.start ‚Üí owner is still undefined but dontDestroy is set to true",this.name):(Ri&&console.warn(`PlayerState.start ‚Üí owner is still undefined: destroying "${this.name}" instance now`),this.doDestroy()):Ri&&console.log("PlayerState.start ‚Üí owner is assigned",this.owner)},2e3))}doDestroy(){Ri&&console.log("PlayerSync.doDestroy ‚Üí syncDestroy",this.name),zp(this.gameObject,this.context.connection,!0,{saveInRoom:!1})}onDestroy(){if(Ri&&console.warn("PlayerState.onDestroy",this.owner),this.context.connection.stopListen(se.UserLeftRoom,this.onUserLeftRoom),kt.all.splice(kt.all.indexOf(this),1),this.isLocalPlayer){const e=kt._local.indexOf(this);e>=0&&kt._local.splice(e,1)}}};let Xt=kt;a(Xt,"_all",[]),a(Xt,"_local",[]),a(Xt,"_callbacks",{});sm([M1(Xt.prototype.onOwnerChange)],Xt.prototype,"owner",void 0);var Uc=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};class Zo extends j{constructor(){super(...arguments);a(this,"position","bottom");a(this,"showNeedleLogo",!0);a(this,"showSpatialMenu");a(this,"createFullscreenButton");a(this,"createMuteButton");a(this,"createQRCodeButton")}onEnable(){this.applyOptions()}applyOptions(){this.context.menu.setPosition(this.position),this.context.menu.showNeedleLogo(this.showNeedleLogo),this.createFullscreenButton===!0&&this.context.menu.showFullscreenOption(!0),this.createMuteButton===!0&&this.context.menu.showAudioPlaybackOption(!0),this.showSpatialMenu===!0&&this.context.menu.showSpatialMenu(this.showSpatialMenu),this.createQRCodeButton===!0&&(J.isMobileDevice()||this.context.menu.showQRCodeButton(!0))}}Uc([m()],Zo.prototype,"position",void 0);Uc([m()],Zo.prototype,"showNeedleLogo",void 0);Uc([m()],Zo.prototype,"showSpatialMenu",void 0);Uc([m()],Zo.prototype,"createFullscreenButton",void 0);Uc([m()],Zo.prototype,"createMuteButton",void 0);Uc([m()],Zo.prototype,"createQRCodeButton",void 0);var Sb=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const _h=C("debugwebxr"),Ox=new H().setFromAxisAngle(new x(0,1,0),Math.PI);class Xa extends j{constructor(){super(...arguments);a(this,"head");a(this,"leftHand");a(this,"rightHand");a(this,"_leftHandMeshes");a(this,"_rightHandMeshes");a(this,"_syncTransforms")}async onEnterXR(e){if(!this.activeAndEnabled)return;_h&&console.warn("AVATAR ENTER XR",this.guid,this.sourceId,this,this.activeAndEnabled),this._syncTransforms&&(this._syncTransforms.length=0),await this.prepareAvatar();const i=Xt.getFor(this);if(i!=null&&i.owner){const n=this.gameObject.addComponent(It);n.avatar=this.gameObject,n.connectionId=i.owner}else this.context.connection.isConnected?console.error("No player state found for avatar",this):i&&!this.context.connection.isConnected&&(i.dontDestroy=!0)}onLeaveXR(e){const i=this.gameObject.getComponent(It);i&&i.destroy()}onUpdateXR(e){var h,d;if(!this.activeAndEnabled)return;const i=Xt.isLocalPlayer(this);if(!i)return;const n=e.xr;if(n.rig&&n.rig.gameObject!==this.gameObject.parent&&(this.gameObject.position.set(0,0,0),this.gameObject.rotation.set(0,0,0),this.gameObject.scale.set(1,1,1),n.rig.gameObject.add(this.gameObject)),this._syncTransforms&&i)for(const u of this._syncTransforms)u.fastMode=!0,u.isOwned()||u.requestOwnership();if(this.head&&this.context.mainCamera){const u=this.head.asset;if(u.position.copy(this.context.mainCamera.position),u.position.x*=-1,u.position.z*=-1,u.quaternion.copy(this.context.mainCamera.quaternion),u.quaternion.x*=-1,this.context.time.frameCount%10===0&&this.head.asset){const f=P.getComponentsInChildren(this.head.asset,qt);for(const p of f)p.enabled=!1,p.gameObject.visible=!1}}const o=e.xr.leftController,r=(h=this.leftHand)==null?void 0:h.asset;o&&r?(r.position.copy(o.gripPosition),r.quaternion.copy(o.gripQuaternion),r.quaternion.multiply(Ox),r.visible=o.isTracking,this.updateHandVisibility(o,r,this._leftHandMeshes)):r&&r.visible&&(r.visible=!1);const l=e.xr.rightController,c=(d=this.rightHand)==null?void 0:d.asset;l&&c?(c.position.copy(l.gripPosition),c.quaternion.copy(l.gripQuaternion),c.quaternion.multiply(Ox),c.visible=l.isTracking,this.updateHandVisibility(l,c,this._rightHandMeshes)):c&&c.visible&&(c.visible=!1)}onBeforeRender(){this.context.xr&&this.context.time.frame%10===0&&this.updateRemoteAvatarVisibility()}updateHandVisibility(e,i,n){if(n){const o=e.model&&e.model.visible&&e.model!==i;n.forEach(r=>{vo(r,!o)})}}updateRemoteAvatarVisibility(){var e,i,n;if(this.context.connection.isConnected){const o=Xt.getFor(this);if(o&&o.isLocalPlayer==!1){const r=te.getXRSync(this.context);if(r&&r.hasState(o.owner)){this.tryFindAvatarObjectsIfMissing();const l=(e=this.leftHand)==null?void 0:e.asset;l&&(l.visible=(r==null?void 0:r.isTracking(o.owner,"left"))??!1);const c=(i=this.rightHand)==null?void 0:i.asset;c&&(c.visible=(r==null?void 0:r.isTracking(o.owner,"right"))??!1)}if((n=this.head)!=null&&n.asset){const l=P.getComponentsInChildren(this.head.asset,qt);for(const c of l)c.enabled=!1,c.gameObject.visible=!0}}}}tryFindAvatarObjectsIfMissing(){if(!this.head||!this.leftHand||!this.rightHand){const e={head:this.head,leftHand:this.leftHand,rightHand:this.rightHand};Ik.tryFindAvatarObjects(this.gameObject,this.sourceId||"",e),e.head&&(this.head=e.head),e.leftHand&&(this.leftHand=e.leftHand),e.rightHand&&(this.rightHand=e.rightHand)}}async prepareAvatar(){var e,i;if(this.tryFindAvatarObjectsIfMissing(),this.head)this.head instanceof F&&(this.head=new de("",this.sourceId,this.head));else{const n=new F;n.name="Head";const o=Ka.createPrimitive(Jn.Cube);n.add(o),this.gameObject.add(n),this.head=new de("",this.sourceId,n),_h&&console.log("Create head",n)}if(this.rightHand)this.rightHand instanceof F&&(this.rightHand=new de("",this.sourceId,this.rightHand));else{const n=new F;n.name="Right Hand",this.gameObject.add(n),this.rightHand=new de("",this.sourceId,n),_h&&console.log("Create right hand",n)}if(this.leftHand)this.leftHand instanceof F&&(this.leftHand=new de("",this.sourceId,this.leftHand));else{const n=new F;n.name="Left Hand",this.gameObject.add(n),this.leftHand=new de("",this.sourceId,n),_h&&console.log("Create left hand",n)}await this.loadAvatarObjects(this.head,this.leftHand,this.rightHand),this._leftHandMeshes=[],(e=this.leftHand.asset)==null||e.traverse(n=>{n!=null&&n.isMesh&&this._leftHandMeshes.push(n)}),this._rightHandMeshes=[],(i=this.rightHand.asset)==null||i.traverse(n=>{n!=null&&n.isMesh&&this._rightHandMeshes.push(n)}),Xt.isLocalPlayer(this.gameObject)&&(this._syncTransforms=P.getComponentsInChildren(this.gameObject,Wo))}async loadAvatarObjects(e,i,n){const o=e.loadAssetAsync(),r=i.loadAssetAsync(),l=n.loadAssetAsync(),c=new Array;o&&c.push(o),r&&c.push(r),l&&c.push(l);const h=await Ew(c);_h&&console.log("Avatar loaded results:",h)}}Sb([m(de)],Xa.prototype,"head",void 0);Sb([m(de)],Xa.prototype,"leftHand",void 0);Sb([m(de)],Xa.prototype,"rightHand",void 0);var om=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const ao=C("debugwebxr"),rr=new Array;class Vo extends j{constructor(){super(...arguments);a(this,"createControllerModel",!0);a(this,"createHandModel",!0);a(this,"customLeftHand");a(this,"customRightHand");a(this,"_models",new Array)}supportsXR(e){return e==="immersive-vr"||e==="immersive-ar"}async onXRControllerAdded(e){var o;if(!(e.xr.isVR||e.xr.isPassThrough))return;const{controller:n}=e;if(ao&&console.warn("Add Controller Model for",n.side,n.index),this.createControllerModel||this.createHandModel){if(n.hand){if(this.createHandModel){const r=await this.loadHandModel(this,n);if(!r||!n.connected||!n.isHand){r!=null&&r.handObject&&hh(r.handObject,!1),(o=r==null?void 0:r.handObject)==null||o.destroy();return}this._models.push({controller:n,model:r.handObject,handmesh:r.handmesh}),this._models.sort((l,c)=>l.controller.index-c.controller.index),this.scene.add(r.handObject),n.model=r.handObject}}else if(this.createControllerModel){const r=await n.getModelUrl();if(r){const l=await this.loadModel(n,r);if(!l||!n.connected||n.isHand)return;this._models.push({controller:n,model:l}),this._models.sort((c,h)=>c.controller.index-h.controller.index),this.scene.add(l),l.traverse(c=>{c.layers.set(2),c.matrixAutoUpdate=!1,c.updateMatrix()}),n.model=l}else n.targetRayMode!=="transient-pointer"&&console.warn("XRControllerModel: no model found for "+n.side)}}}onXRControllerRemoved(e){console.debug("XR Controller Removed",e.controller.side,e.controller.index);const i=this._models.findIndex(o=>o.controller===e.controller),n=this._models[i];n&&(this._models.splice(i,1),n.model&&(hh(n.model,!1),n.model.destroy(),n.model=void 0))}onBeforeXR(e,i){this.createHandModel&&(this.customLeftHand||this.customRightHand)&&(i.optionalFeatures=i.optionalFeatures||[],i.optionalFeatures.includes("hand-tracking")||i.optionalFeatures.push("hand-tracking"))}onLeaveXR(e){for(const i of this._models)i&&(i.model&&(hh(i.model,!1),i.model.destroy(),i.model=void 0),i.controller.model===i.model&&(i.controller.model=null));this._models.length=0}onBeforeRender(){if(te.active&&(ao&&(rr[0]=Date.now()),this.updateRendering(te.active),ao)){const e=Date.now()-rr[0];rr.push(e),rr.length>=30&&(rr[0]=0,rr.reduce((i,n)=>i+n,0)/rr.length,rr.length=0)}}updateRendering(e){var i,n,o,r,l;for(let c=0;c<this._models.length;c++){const h=this._models[c];if(!h)continue;const d=h.controller;if(!d.connected){ao&&console.warn("XRControllerModel.onUpdateXR: controller is not connected anymore",d.side,d.hand);continue}if(h.model&&!h.handmesh)h.model.matrixAutoUpdate=!1,h.model.matrix.copy(d.gripMatrix),h.model.visible=d.isTracking,(i=e.rig)==null||i.gameObject.add(h.model);else if(d.inputSource.hand&&h.handmesh){const u=e.referenceSpace,f=this.context.renderer.xr.getHand(d.index);if(u&&e.frame.getJointPose){for(const p of d.inputSource.hand.values()){const g=f.joints[p.jointName];if(g){const y=d.getHandJointPose(p);if(y){const b=y.transform.position,_=y.transform.orientation;g.position.copy(b),g.quaternion.copy(_),g.matrixAutoUpdate=!1}g.visible=y!=null}}h.model&&(h.model.visible=d.isTracking,h.model.visible&&h.model.parent!==((n=e.rig)==null?void 0:n.gameObject)&&((o=e.rig)==null||o.gameObject.add(h.model))),(r=h.model)!=null&&r.visible&&((l=h.handmesh)==null||l.updateMesh(),h.model.matrixAutoUpdate=!1,h.model.matrix.identity(),h.model.applyMatrix4(ic))}}}}async loadModel(e,i){var r;if(!e.connected)return console.warn("XRControllerModel.onXRControllerAdded: controller is not connected anymore",e.side),null;const o=await de.getOrCreate("",i).instantiate();return hh(o),(r=te.active)!=null&&r.isPassThrough&&o.traverseVisible(l=>{this.makeOccluder(l)}),o}async loadHandModel(e,i){const n=this.context,o=n.renderer.xr.getHand(i.index);o||(ao?G.DrawLabel(i.rayWorldPosition,"No hand found for index "+i.index,.05,5):console.warn("No hand found for index "+i.index));const r=new Va;Vp(r,n),await t_(r,n,this.sourceId??"");const l=mb(r);let c="";const h=i.side==="left"?this.customLeftHand:this.customRightHand;h?(c=h.url.split(".").slice(0,-1).join("."),r.setPath("")):(c=i.inputSource.handedness==="left"?"left":"right",r.setPath("https://cdn.jsdelivr.net/npm/@webxr-input-profiles/assets@1.0/dist/profiles/generic-hand/"));const d=new F;hh(d);const u=new WR(d,o,r.path,c,r,f=>{var g;const p=l.gltf;((g=p==null?void 0:p.scene.children)==null?void 0:g.length)===0&&(p.scene.children[0]=f),qs().createBuiltinComponents(e.context,e.sourceId||c,l.gltf,null,l),f.traverse(y=>{var b;y.layers.set(2),(b=te.active)!=null&&b.isPassThrough&&!h&&this.makeOccluder(y),y instanceof Z&&mt.assignMeshLOD(y,0)}),i.connected||(ao&&G.DrawLabel(i.rayWorldPosition,"Hand is loaded but not connected anymore",.05,5),f.removeFromParent())});if(ao&&d.add(new ln(.5)),i.inputSource.hand){ao&&console.log(i.inputSource.hand);for(const f of i.inputSource.hand.values())if(o.joints[f.jointName]===void 0){const p=new Mr;p.matrixAutoUpdate=!1,p.visible=!0,o.joints[f.jointName]=p,o.add(p)}}else ao&&G.DrawLabel(i.rayWorldPosition,"No inputSource.hand found for index "+i.index,.05,5);return{handObject:d,handmesh:u}}makeOccluder(e){if(e instanceof Z){let i=e.material;i instanceof De&&(i=e.material=i.clone(),i.depthWrite=!0,i.depthTest=!0,i.colorWrite=!1,e.receiveShadow=!1,e.renderOrder=-100)}}}a(Vo,"factory",new $R);om([m()],Vo.prototype,"createControllerModel",void 0);om([m()],Vo.prototype,"createHandModel",void 0);om([m(de)],Vo.prototype,"customLeftHand",void 0);om([m(de)],Vo.prototype,"customRightHand",void 0);class Cb extends j{}var Jr=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const Ug=C("debugwebxr");class Bn extends j{constructor(){super(...arguments);a(this,"movementSpeed",1.5);a(this,"rotationStep",30);a(this,"useTeleport",!0);a(this,"usePinchToTeleport",!0);a(this,"useTeleportTarget",!1);a(this,"useTeleportFade",!1);a(this,"showRays",!0);a(this,"showHits",!0);a(this,"isXRMovementHandler",!0);a(this,"xrSessionMode","immersive-vr");a(this,"_didApplyRotation",!1);a(this,"_didTeleport",!1);a(this,"_teleportBuffer",new Array);a(this,"_plane",null);a(this,"_lines",[]);a(this,"_hitDiscs",[]);a(this,"_hitDistances",[]);a(this,"_lastHitDistances",[]);a(this,"hitPointRaycastFilter",e=>e.type==="SkinnedMesh"?"continue in children":!0)}onUpdateXR(e){const i=e.xr.rig;if(!(i!=null&&i.gameObject)||e.xr.isPassThrough)return;const n=e.xr.leftController,o=e.xr.rightController;n&&this.onHandleMovement(n,i.gameObject),o&&(this.onHandleRotation(o,i.gameObject),this.useTeleport&&this.onHandleTeleport(o,i.gameObject))}onLeaveXR(e){for(const i of this._lines)i.removeFromParent();for(const i of this._hitDiscs)i==null||i.removeFromParent()}onBeforeRender(){var e;(e=this.context.xr)!=null&&e.running&&(this.showRays&&this.renderRays(this.context.xr),this.showHits&&this.renderHits(this.context.xr))}onHandleMovement(e,i){const n=e.getStick("xr-standard-thumbstick");if(n.x!=0||n.y!=0){const o=Q(n.x,0,n.y);o.multiplyScalar(this.context.time.deltaTimeUnscaled*this.movementSpeed);const r=pt(i);o.multiplyScalar(r.x),o.applyQuaternion(e.xr.poseOrientation),o.y=0,o.applyQuaternion(i.worldQuaternion),i.position.add(o),i.updateWorldMatrix(!1,!1);for(const l of i.children)l.updateWorldMatrix(!1,!1)}}onHandleRotation(e,i){if(e._isMxInk)return;const o=e.getStick("xr-standard-thumbstick").x;if(this._didApplyRotation)Math.abs(o)<.3&&(this._didApplyRotation=!1);else if(Math.abs(o)>.5){this._didApplyRotation=!0;const r=o>0?1:-1,l=ae(this.context.mainCamera).clone();i.rotateY(r*W.toRadians(this.rotationStep));const h=ae(this.context.mainCamera).clone().sub(l);h.y=0,i.position.sub(h)}}onHandleTeleport(e,i){var o,r,l,c,h;let n=0;if(e.hand&&this.usePinchToTeleport&&e.isTeleportGesture){const d=e.getPointerId("primary");if(d!=null&&this.context.input.getIsPointerIdInUse(d))return;const u=e.getGesture("pinch");u&&(n=u.value)}else n=(o=e.getStick("xr-standard-thumbstick"))==null?void 0:o.y;if(this._didTeleport)n>=0&&n<.4?this._didTeleport=!1:n<0&&n>-.4&&(this._didTeleport=!1);else if(n>.8){this._didTeleport=!0;const d=this.context.physics.raycastFromRay(e.ray)[0];if(d&&d.object instanceof yc){const f=(r=d.normal)==null?void 0:r.dot(Q(0,1,0));if(f!==void 0&&f<.4)return}let u=d==null?void 0:d.point;if(!u&&!this.useTeleportTarget){this._plane||(this._plane=new $a(new x(0,1,0),0));const f=i.worldPosition;this._plane.setFromNormalAndCoplanarPoint(new x(0,1,0),f);const p=e.ray;u=f.clone(),this._plane.intersectLine(new uR(p.origin,Q(p.direction).multiplyScalar(1e4).add(p.origin)),u),u.distanceTo(f)>i.scale.x*10&&(u=null)}if(u){if(this.useTeleportTarget&&!P.getComponentInParent(d.object,Cb))return;const f=u.clone();if(Ug&&G.DrawSphere(u,.025,16711680,5),(l=this.context.mainCamera)==null?void 0:l.position){const g=(c=this.context.xr)==null?void 0:c.getUserOffsetInRig();g&&(g.y=0,f.sub(g),Ug&&G.DrawWireSphere(g.add(f),.025,65280,5))}this._teleportBuffer.push(i.matrix.clone()),this._teleportBuffer.length>10&&this._teleportBuffer.shift(),this.useTeleportFade?(h=e.xr.fadeTransition())==null||h.then(()=>{i.worldPosition=f}):i.worldPosition=f}}else if(n<-.8&&(this._didTeleport=!0,this._teleportBuffer.length>0)){const d=this._teleportBuffer.pop();d&&d.decompose(i.position,i.quaternion,i.scale)}}renderRays(e){var i;for(let n=0;n<this._lines.length;n++){const o=this._lines[n];o&&(o.visible=!1)}for(let n=0;n<e.controllers.length;n++){const o=e.controllers[n];let r=this._lines[n];if(!o.connected||!o.isTracking||!o.ray||o.targetRayMode==="transient-pointer"||!o.hasSelectEvent){r&&(r.visible=!1);continue}r||(r=this.createRayLineObject(),r.scale.z=.5,this._lines[n]=r),o.updateRayWorldPosition(),o.updateRayWorldQuaternion();const l=o.rayWorldPosition,c=o.rayWorldQuaternion;r.position.copy(l),r.quaternion.copy(c);const h=e.rigScale,d=this.usePinchToTeleport&&o.isTeleportGesture,u=this._lastHitDistances[n],f=this._hitDistances[n]!=null,p=u??h;r.scale.set(h,h,p),r.visible=!0,r.layers.disableAll(),r.layers.enable(2);let g=r.material.opacity;d?g=1:this.showHits&&p<e.rigScale*.5?g=0:(i=o.getButton("primary"))!=null&&i.pressed?g=.5:g=f?.2:.1,r.material.opacity=W.lerp(r.material.opacity,g,this.context.time.deltaTimeUnscaled/.1),r.parent!==this.context.scene&&this.context.scene.add(r)}}renderHits(e){var i;for(const n of this._hitDiscs){if(!n)continue;const o=n.controller;if(!o||!o.connected||!o.isTracking){n.visible=!1;continue}}for(let n=0;n<e.controllers.length;n++){const o=e.controllers[n];if(!o.connected||!o.isTracking||!o.ray||!o.hasSelectEvent)continue;let r=this._hitDiscs[n],l=!0;const c=o.getPointerId("primary");c!=null&&this.context.input.getIsPointerIdInUse(c)&&(r&&(r.visible=!1),this._hitDistances[n]=null,this._lastHitDistances[n]=0,l=!1);const h=this.context.time.smoothedFps>=59?1:10;if((this.context.time.frame+o.index)%h!==0&&(l=!1),!l){const f=this._hitDiscs[n];f&&f.visible&&f.hit&&this.updateHitPointerPosition(o,f,f.hit.distance);continue}const d=this.context.physics.raycastFromRay(o.ray,{testObject:this.hitPointRaycastFilter,precise:!1});let u=d.find(f=>this.usePinchToTeleport&&o.isTeleportGesture?!0:this.isObjectWithInteractiveComponent(f.object));if(u||(u=d[0]),r&&(r.controller=o,r.hit=u),this._hitDistances[n]=(u==null?void 0:u.distance)||null,u){this._lastHitDistances[n]=u.distance;const f=e.rigScale??1;Ug&&(G.DrawWireSphere(u.point,.025*f,16711680),G.DrawLabel(Q(0,.2,0).add(u.point),u.object.name,.02,0)),r||(r=this.createHitPointObject(),this._hitDiscs[n]=r),r.hit=u,r.visible=u.distance>f*.05;let p=.01*(f+u.distance);const g=(i=o.getButton("primary"))==null?void 0:i.pressed;g&&(p*=1.1),r.scale.set(p,p,p),r.layers.set(2);let y=r.material.opacity;if(g?y=1:y=u.distance<.15*f?.2:.6,r.material.opacity=W.lerp(r.material.opacity,y,this.context.time.deltaTimeUnscaled/.1),r.visible){if(u.normal){this.updateHitPointerPosition(o,r,u.distance);const b=u.normal.applyQuaternion(Le(u.object));r.quaternion.setFromUnitVectors(j2,b)}else this.updateHitPointerPosition(o,r,u.distance);r.parent!==this.context.scene&&this.context.scene.add(r)}}else this._hitDiscs[n]&&(this._hitDiscs[n].visible=!1)}}isObjectWithInteractiveComponent(e,i=0){return Yy(e)||e.isUI===!0?!0:e.isScene?!1:e.parent?this.isObjectWithInteractiveComponent(e.parent,i+1):!1}updateHitPointerPosition(e,i,n){const o=Q(e.rayWorldPosition);o.add(Q(0,0,n-.01).applyQuaternion(e.rayWorldQuaternion)),i.position.lerp(o,this.context.time.deltaTimeUnscaled/.05)}createHitPointObject(){const e=new Z(new wp(.3,6,6),new Ue({color:15658734,opacity:.7,transparent:!0,depthTest:!1,depthWrite:!1,side:hn}));return e.layers.disableAll(),e.layers.enable(2),e}createRayLineObject(){const e=new VR;e.layers.disableAll(),e.layers.enable(2);const i=new HR;e.geometry=i;const n=new Float32Array(9);n.set([0,0,.02,0,0,.4,0,0,1]),i.setPositions(n);const o=new Float32Array(9);o.set([1,1,1,.1,.1,.1,0,0,0]),i.setColors(o);const r=new GR({color:16777215,vertexColors:!0,worldUnits:!0,linewidth:.004,transparent:!0,depthWrite:!1,blending:gw,dashed:!1});return e.material=r,e}}Jr([m()],Bn.prototype,"movementSpeed",void 0);Jr([m()],Bn.prototype,"rotationStep",void 0);Jr([m()],Bn.prototype,"useTeleport",void 0);Jr([m()],Bn.prototype,"usePinchToTeleport",void 0);Jr([m()],Bn.prototype,"useTeleportTarget",void 0);Jr([m()],Bn.prototype,"useTeleportFade",void 0);Jr([m()],Bn.prototype,"showRays",void 0);Jr([m()],Bn.prototype,"showHits",void 0);const j2=new x(0,1,0);var Nt=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const bh=C("debugwebxr"),B2=C("debugusdz"),Pa=class extends j{constructor(){super(...arguments);a(this,"createVRButton",!0);a(this,"createARButton",!0);a(this,"createSendToQuestButton",!0);a(this,"createQRCode",!0);a(this,"useDefaultControls",!0);a(this,"showControllerModels",!0);a(this,"showHandModels",!0);a(this,"usePlacementReticle",!0);a(this,"customARPlacementReticle");a(this,"usePlacementAdjustment",!0);a(this,"arScale",1);a(this,"useXRAnchor",!1);a(this,"autoPlace",!1);a(this,"autoCenter",!1);a(this,"useQuicklookExport",!1);a(this,"useDepthSensing",!1);a(this,"useSpatialGrab",!0);a(this,"defaultAvatar");a(this,"_playerSync");a(this,"_createdComponentsInSession",[]);a(this,"_usdzExporter");a(this,"_exitXRMenuButton");a(this,"_previousXRState",0);a(this,"_spatialGrabRaycaster");a(this,"_activeWebARSessionRoot",null);a(this,"onAvatarSpawned",e=>{bh&&console.log("WebXR.onAvatarSpawned",e),P.getComponentInChildren(e,Xa)??(i=P.addComponent(e,Xa))});a(this,"_buttonFactory");a(this,"_buttons",[])}awake(){te.getXRSync(this.context)}onEnable(){var e,i;window.location.protocol!=="https:"&&Me('<a href="https://developer.mozilla.org/en-US/docs/Web/API/WebXR_Device_API" target="_blank">WebXR</a> only works on secure connections (https).'),this.useQuicklookExport&&(P.findObjectOfType(Fe)||(bh&&console.log("WebXR: Adding USDZExporter"),this._usdzExporter=P.addComponent(this.gameObject,Fe),this._usdzExporter.objectToExport=this.context.scene,this._usdzExporter.autoExportAnimations=!0,this._usdzExporter.autoExportAudioSources=!0)),this.handleCreatingHTML(),this.handleOfferSession(),this.defaultAvatar===!0&&(bh&&console.warn("WebXR: No default avatar set, using static default avatar"),this.defaultAvatar=new de("https://cdn.needle.tools/static/avatars/DefaultAvatar.glb")),this.defaultAvatar&&(this._playerSync=this.gameObject.getOrAddComponent(ll),this._playerSync.autoSync=!1),this._playerSync&&typeof this.defaultAvatar!="boolean"&&(this._playerSync.asset=this.defaultAvatar,(e=this._playerSync.onPlayerSpawned)==null||e.removeEventListener(this.onAvatarSpawned),(i=this._playerSync.onPlayerSpawned)==null||i.addEventListener(this.onAvatarSpawned))}onDisable(){var e;(e=this._usdzExporter)==null||e.destroy(),this.removeButtons()}async handleOfferSession(){return this.createVRButton&&await te.isVRSupported()&&this.createVRButton?te.offerSession("immersive-vr","default",this.context):this.createARButton&&await te.isARSupported()&&this.createARButton?te.offerSession("immersive-ar","default",this.context):!1}get session(){return te.active??null}get sessionMode(){return te.activeMode??null}get arSessionRoot(){return this._activeWebARSessionRoot}async enterVR(e){return te.start("immersive-vr",e,this.context)}async enterAR(e){return te.start("immersive-ar",e,this.context)}exitXR(){te.stop()}get isActiveWebXR(){return!Pa.activeWebXRComponent||Pa.activeWebXRComponent===this}onBeforeXR(e,i){var n;if(!this.isActiveWebXR){console.warn(`WebXR: another WebXR component is already active (${(n=Pa.activeWebXRComponent)==null?void 0:n.name}). This is ignored: ${this.name}`);return}Pa.activeWebXRComponent=this,e=="immersive-ar"&&this.useDepthSensing&&(i.optionalFeatures=i.optionalFeatures||[],i.optionalFeatures.push("depth-sensing"))}async onEnterXR(e){if(!this.isActiveWebXR)return;bh&&console.log("WebXR onEnterXR"),this._previousXRState=ci.Global.Mask;const i=e.xr.isVR;if(ci.Global.Set(i?Tn.VR:Tn.AR),e.xr.isAR){let n=P.findObjectOfType(es);if(!n)if(this.usePlacementReticle){const o=new F;for(const r of this.context.scene.children)o.add(r);this.context.scene.add(o),n=P.addComponent(o,es),this._createdComponentsInSession.push(n)}else(bh||U())&&console.warn("WebXR: No WebARSessionRoot found in scene and usePlacementReticle is disabled in WebXR component.");this._activeWebARSessionRoot=n,n&&(n.customReticle=this.customARPlacementReticle,n.arScale=this.arScale,n.arTouchTransform=this.usePlacementAdjustment,n.autoPlace=this.autoPlace,n.autoCenter=this.autoCenter,n.useXRAnchor=this.useXRAnchor)}this.useDefaultControls&&this.setDefaultMovementEnabled(!0),(this.showControllerModels||this.showHandModels)&&this.setDefaultControllerRenderingEnabled(!0),this.useSpatialGrab&&(this._spatialGrabRaycaster=P.findObjectOfType(Fa)??void 0,this._spatialGrabRaycaster||(this._spatialGrabRaycaster=this.gameObject.addComponent(Fa))),this.createLocalAvatar(e.xr),e.xr.isScreenBasedAR||(this._exitXRMenuButton=this.context.menu.appendChild({label:"Quit XR",onClick:()=>this.exitXR(),icon:"exit_to_app",priority:2e4}))}onUpdateXR(e){this.isActiveWebXR&&this._spatialGrabRaycaster&&(this._spatialGrabRaycaster.enabled=this.useSpatialGrab)}onLeaveXR(e){var i,n;if((i=this._exitXRMenuButton)==null||i.remove(),!!this.isActiveWebXR){ci.Global.Set(this._previousXRState),(n=this._playerSync)==null||n.destroyInstance();for(const o of this._createdComponentsInSession)o.destroy();this._createdComponentsInSession.length=0,this._activeWebARSessionRoot=null,this.handleOfferSession(),Ep(1).then(()=>Pa.activeWebXRComponent=null)}}setDefaultMovementEnabled(e){let i=this.gameObject.getComponent(Bn);return!i&&e&&(i=this.gameObject.addComponent(Bn),this._createdComponentsInSession.push(i)),i&&(i.enabled=e),i}setDefaultControllerRenderingEnabled(e){let i=this.gameObject.getComponent(Vo);return!i&&e&&(i=this.gameObject.addComponent(Vo),this._createdComponentsInSession.push(i),i.createControllerModel=this.showControllerModels,i.createHandModel==this.showHandModels),i&&(i.enabled=e),i}async createLocalAvatar(e){this._playerSync&&e.running&&typeof this.defaultAvatar!="boolean"&&(this._playerSync.asset=this.defaultAvatar,await this._playerSync.getInstance())}getButtonsContainer(){return this.getButtonsFactory()}getButtonsFactory(){return this._buttonFactory||(this._buttonFactory=Br.getOrCreate()),this._buttonFactory}handleCreatingHTML(){if(this.createARButton||this.createVRButton||this.useQuicklookExport){if((J.isiOS()&&J.isSafari()||B2)&&this.useQuicklookExport){const i=P.findObjectOfType(Fe);if(!i||i&&i.allowCreateQuicklookButton){const n=this.getButtonsFactory().createQuicklookButton();this.addButton(n,50)}}if(this.createARButton){const i=this.getButtonsFactory().createARButton();this.addButton(i,50)}if(this.createVRButton){const i=this.getButtonsFactory().createVRButton();this.addButton(i,50)}}if(this.createSendToQuestButton&&!J.isQuest()&&te.isVRSupported().then(i=>{if(!i){const n=this.getButtonsFactory().createSendToQuestButton();this.addButton(n,50)}}),this.createQRCode){const i=Wp(Zo);if(i&&i.createQRCodeButton===!1)U()&&console.warn("WebXR: QRCode button is disabled in the Needle Menu component");else if(!J.isMobileDevice()){const n=Fs.getOrCreate().createQRCode();this.addButton(n,50)}}}addButton(e,i){this._buttons.push(e),e.setAttribute("priority",i.toString()),this.context.menu.appendChild(e)}removeButtons(){for(const e of this._buttons)e.remove();this._buttons.length=0}};let Ze=Pa;a(Ze,"activeWebXRComponent",null);Nt([m()],Ze.prototype,"createVRButton",void 0);Nt([m()],Ze.prototype,"createARButton",void 0);Nt([m()],Ze.prototype,"createSendToQuestButton",void 0);Nt([m()],Ze.prototype,"createQRCode",void 0);Nt([m()],Ze.prototype,"useDefaultControls",void 0);Nt([m()],Ze.prototype,"showControllerModels",void 0);Nt([m()],Ze.prototype,"showHandModels",void 0);Nt([m()],Ze.prototype,"usePlacementReticle",void 0);Nt([m(de)],Ze.prototype,"customARPlacementReticle",void 0);Nt([m()],Ze.prototype,"usePlacementAdjustment",void 0);Nt([m()],Ze.prototype,"arScale",void 0);Nt([m()],Ze.prototype,"useXRAnchor",void 0);Nt([m()],Ze.prototype,"autoPlace",void 0);Nt([m()],Ze.prototype,"autoCenter",void 0);Nt([m()],Ze.prototype,"useQuicklookExport",void 0);Nt([m()],Ze.prototype,"useDepthSensing",void 0);Nt([m()],Ze.prototype,"useSpatialGrab",void 0);Nt([m(de)],Ze.prototype,"defaultAvatar",void 0);const Ah=C("debugusdz");function F2(s,t){var l;const e=[],i=P.getComponentsInChildren(s,pi),n=P.getComponentsInChildren(s,Mi),o=new Array,r=new Array;if(t.injectImplicitBehaviours)for(const c of i){if(!c||!c.runtimeAnimatorController||!c.enabled)continue;const h=c.runtimeAnimatorController.activeState;if(!h||!h.motion||!h.motion.clip||((l=h.motion.clip.tracks)==null?void 0:l.length)<1||o.includes(c))continue;const d=new Us;d.animator=c,d.stateName=h.name,d.trigger="start",d.name="PlayAnimationOnClick_implicitAtStart_"+d.stateName;const u=new F;P.addComponent(u,d),r.push(u),o.push(c),s.add(u)}else for(const c of i){if(!c||!c.runtimeAnimatorController||!c.enabled)continue;Ah&&console.log(c);const h=[];for(const d of c.runtimeAnimatorController.enumerateActions()){Ah&&console.log(d);const u=d.getClip();h.includes(u)||h.push(u)}e.push({root:c.gameObject,clips:h})}if(t.injectImplicitBehaviours)for(const c of n){if(!c||!c.clip||!c.enabled||!c.playAutomatically||o.includes(c))continue;const h=new Us;h.animation=c,h.stateName=c.clip.name,h.trigger="start",h.name="PlayAnimationOnClick_implicitAtStart_"+h.stateName;const d=new F;P.addComponent(d,h),r.push(d),o.push(c),s.add(d)}else for(const c of n){Ah&&console.log(c);const h=[];for(const d of c.animations)h.includes(d)||h.push(d);e.push({root:c.gameObject,clips:h})}Ah&&(e==null?void 0:e.length)>0&&console.log("USDZ Animation Clips without behaviours",e);for(const c of e)for(const h of c.clips)t.registerAnimation(c.root,h);return r}function z2(s,t){const e=P.getComponentsInChildren(s,Oe),i=P.getComponentsInChildren(s,Ga),n=new Array,o=new Array;Ah&&console.log({audioSources:e,playAudioOnClicks:i});for(const r of i){if(!r.target)continue;const l=e.indexOf(r.target);l>-1&&e.splice(l,1)}for(const r of e){if(!r||!r.clip||r.volume<=0||n.includes(r))continue;const l=new Ga;l.target=r,l.name="PlayAudioOnClick_implicitAtStart_",l.trigger="start";const c=new F;P.addComponent(c,l),console.log("implicit PlayAudioOnStart",c,l),o.push(c),n.push(r),s.add(c)}return o}function U2(s){return new Bt("DisableAtStart",Qt.sceneStartTrigger(),we.fadeAction(s,0,!1))}function Tx(s,t){const e=s.domElement.shadowRoot.querySelector("link[rel='ar']");if(e)return e;const i=document.createElement("div");i.classList.add("menu"),i.classList.add("quicklook-menu"),i.style.display="none",i.style.visibility="hidden";const n=document.createElement("button");n.id="open-in-ar",t?(n.innerText="View in AR",n.title="View this scene in AR. The scene will be exported to USDZ and opened with Apple's QuickLook."):(n.innerText="View in AR",n.title="Download this scene for AR. Open the downloaded USDZ file to view it in AR using Apple's QuickLook."),i.appendChild(n);const o=document.createElement("a");o.id="needle-usdz-link",o.style.display="none",o.rel="ar",o.href="",o.target="_blank",i.appendChild(o);const r=document.createElement("img");return r.id="button",o.appendChild(r),s.domElement.shadowRoot.appendChild(i),o}var Zt=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const Ki=C("debugusdz"),N2=C("debugusdzpruning");class cl{constructor(){a(this,"callToAction");a(this,"checkoutTitle");a(this,"checkoutSubtitle");a(this,"callToActionURL")}}Zt([m()],cl.prototype,"callToAction",void 0);Zt([m()],cl.prototype,"checkoutTitle",void 0);Zt([m()],cl.prototype,"checkoutSubtitle",void 0);Zt([m()],cl.prototype,"callToActionURL",void 0);const gp=class extends j{constructor(){super(...arguments);a(this,"objectToExport");a(this,"autoExportAnimations",!0);a(this,"autoExportAudioSources",!0);a(this,"exportFileName");a(this,"customUsdzFile");a(this,"customBranding");a(this,"anchoringType","plane");a(this,"maxTextureSize",2048);a(this,"planeAnchoringAlignment","horizontal");a(this,"interactive",!0);a(this,"physics",!0);a(this,"allowCreateQuicklookButton",!0);a(this,"quickLookCompatible",!0);a(this,"extensions",[]);a(this,"link");a(this,"button");a(this,"onClickedOpenInARElement",e=>{e.preventDefault(),this.exportAndOpen()});a(this,"_currentExportTasks",new Map);a(this,"_previousTimeScale",1);a(this,"lastCallback");a(this,"_rootSessionRootWasAppliedTo",null);a(this,"_rootPositionBeforeExport",new x);a(this,"_rootRotationBeforeExport",new H);a(this,"_rootScaleBeforeExport",new x)}start(){var e,i,n;Ki&&(console.log("USDZExporter",this),console.log("Debug USDZ Mode. Press 'T' to export"),window.addEventListener("keydown",o=>{switch(o.key){case"t":this.exportAndOpen();break}})),this.objectToExport||(this.objectToExport=this.gameObject),!((i=(e=this.objectToExport)==null?void 0:e.children)!=null&&i.length)&&!((n=this.objectToExport)!=null&&n.isMesh)&&(this.objectToExport=this.context.scene)}onEnable(){var n;const e=J.supportsQuickLookAR(),i=J.isiOS()||J.isiPad();!this.button&&(Ki||e||i)&&(this.allowCreateQuicklookButton&&(this.button=this.createQuicklookButton()),this.lastCallback=this.quicklookCallback.bind(this),this.link=Tx(this.context,e),this.link.addEventListener("message",this.lastCallback)),Ki&&tt("USDZ Exporter enabled: "+this.name),(n=document.getElementById("open-in-ar"))==null||n.addEventListener("click",this.onClickedOpenInARElement),Cd.registerExporter(this)}onDisable(){var e,i,n;(e=this.button)==null||e.remove(),(i=this.link)==null||i.removeEventListener("message",this.lastCallback),Ki&&tt("USDZ Exporter disabled: "+this.name),(n=document.getElementById("open-in-ar"))==null||n.removeEventListener("click",this.onClickedOpenInARElement),Cd.unregisterExporter(this)}async exportAsync(){return this.exportAndOpen()}async exportAndOpen(){var n;let e=this.exportFileName??((n=this.objectToExport)==null?void 0:n.name)??this.name;if(e+="-"+i2(),La()||(e!==""&&(e+="-"),e+="MadeWithNeedle"),this.link||(this.link=Tx(this.context,J.supportsQuickLookAR())),this.customUsdzFile)return Ki&&console.log("Exporting custom usdz",this.customUsdzFile),this.openInQuickLook(this.customUsdzFile,e),null;if(!this.objectToExport)return console.warn("No object to export",this),null;const i=await this.export(this.objectToExport);return i?(Ki&&console.log("USDZ generation done. Downloading as "+e),this.openInQuickLook(i,e),i):(console.error("USDZ generation failed. Please report a bug",this),null)}async export(e){if(!e)return console.warn("No object to export"),null;const i=this._currentExportTasks.get(e);if(i)return i;const n=this.internalExport(e);return n instanceof Promise?(this._currentExportTasks.set(e,n),n.then(o=>(this._currentExportTasks.delete(e),o)).catch(o=>(this._currentExportTasks.delete(e),console.error("Error during USDZ export ‚Äì please report a bug!",o),null))):n}async internalExport(e){ge.start("export-usdz",{onProgress:M=>{this.dispatchEvent(new CustomEvent("export-progress",{detail:{progress:M}}))}}),ge.report("export-usdz",{message:"Starting export",totalSteps:40,currentStep:0}),ge.report("export-usdz",{message:"Load progressive textures",autoStep:5}),ge.start("export-usdz-textures","export-usdz");const i=P.getComponentsInChildren(e,mn);for(const M of i)M&&M.enabled&&M.updateSprite(!0);const n=P.getComponentsInChildren(e,Ve),o=new Array;let r=0;for(const M of n){for(const k of M.sharedMeshes)if(k){const B=mt.assignMeshLOD(k,0);B instanceof Promise&&o.push(new Promise((I,E)=>{B.then(()=>{r++,ge.report("export-usdz-textures",{message:"Loaded progressive mesh",currentStep:r,totalSteps:o.length}),I()}).catch(L=>E(L))}))}for(const k of M.sharedMaterials)if(k){const B=mt.assignTextureLOD(k,0);B instanceof Promise&&o.push(new Promise((I,E)=>{B.then(()=>{r++,ge.report("export-usdz-textures",{message:"Loaded progressive texture",currentStep:r,totalSteps:o.length}),I()}).catch(L=>E(L))}))}}Ki&&tt("Progressive Loading: "+o.length),await Promise.all(o),Ki&&tt("Progressive Loading: done"),ge.end("export-usdz-textures");const l=ci.Global.Mask;ci.Global.Set(Tn.AR);const c=new c2,h=new Zp(this.quickLookCompatible);let d;const u=[];this.interactive&&(u.push(new yb),u.push(new rl),globalThis.true&&P.getComponentsInChildren(e,ve).length>0&&(this.physics?(d=new _b,u.push(d)):U()&&console.warn("USDZExporter: Physics export is disabled, but there are active Rigidbody components in the scene. They will not be exported.")),u.push(new nm),u.push(new xb));const f=[h,...u,...this.extensions],p={self:this,exporter:c,extensions:f,object:e};ge.report("export-usdz","Invoking before-export"),this.dispatchEvent(new CustomEvent("before-export",{detail:p})),this.applyWebARSessionRoot(),this._previousTimeScale=this.context.time.timeScale,this.context.time.timeScale=0,ge.report("export-usdz","auto export animations and audio sources");const g=new Array;this.autoExportAnimations&&g.push(...F2(e,h)),f.find(M=>M.extensionName==="Audio")&&this.autoExportAudioSources&&g.push(...z2(e)),c.debug=Ki,c.pruneUnusedNodes=!N2;const b=Or.instance.objs.map(M=>M.batchedMesh);c.keepObject=M=>{let k=!0;const B=P.getComponent(M,Ve);return B&&!B.enabled&&(k=!1),k&&b.includes(M)&&(k=!1),k&&P.getComponentInParent(M,cn)&&(k=!1),k&&P.getComponentInParent(M,Xo)&&(k=!1),Ki&&!k&&console.log("USDZExporter: Discarding object",M),k},c.beforeWritingDocument=()=>{if(U()&&h&&d){const M=h.animatedRoots;for(const k of M){const B=P.getComponentsInChildren(k,ve).filter(E=>E.enabled),I=P.getComponents(k,fn).filter(E=>E.enabled&&!E.isTrigger);(B.length>0||I.length>0)&&console.error("An animated object has physics components in its child hierarchy. This can lead to undefined behaviour due to a bug in Apple's QuickLook (FB15925487). Remove the physics components from child objects or verify that you get the expected results.",k)}}};const _=new Array;this.objectToExport&&this.quickLookCompatible&&this.interactive&&this.objectToExport.traverse(M=>{M.visible||_.push(M)});const v=f.find(M=>M.extensionName==="Behaviour");this.interactive&&v&&_.length>0&&v.addBehavior(U2(_));let S=!0;this.quickLookCompatible&&!this.interactive&&(S=!1),this.anchoringType!=="plane"&&this.anchoringType!=="none"&&this.anchoringType!=="image"&&this.anchoringType!=="face"&&(this.anchoringType="plane"),this.planeAnchoringAlignment!=="horizontal"&&this.planeAnchoringAlignment!=="vertical"&&this.planeAnchoringAlignment!=="any"&&(this.planeAnchoringAlignment="horizontal"),ge.report("export-usdz","Invoking exporter.parse");const T=await c.parse(this.objectToExport,{ar:{anchoring:{type:this.anchoringType},planeAnchoring:{alignment:this.planeAnchoringAlignment}},extensions:f,quickLookCompatible:this.quickLookCompatible,maxTextureSize:this.maxTextureSize,exportInvisible:S}),O=new Blob([T],{type:"model/vnd.usdz+zip"});this.revertWebARSessionRoot(),this.context.time.timeScale=this._previousTimeScale,ge.report("export-usdz","Invoking after-export"),this.dispatchEvent(new CustomEvent("after-export",{detail:p}));for(const M of g)P.destroy(M);return ci.Global.Set(l),ge.end("export-usdz"),O}openInQuickLook(e,i){const n=e instanceof Blob?URL.createObjectURL(e):e,o=this.buildQuicklookOverlay();Ki&&console.log("QuickLook Overlay",o);const r=o.callToAction?encodeURIComponent(o.callToAction):"",l=o.checkoutTitle?encodeURIComponent(o.checkoutTitle):"",c=o.checkoutSubtitle?encodeURIComponent(o.checkoutSubtitle):"";this.link.href=n+`#callToAction=${r}&checkoutTitle=${l}&checkoutSubtitle=${c}&callToActionURL=${o.callToActionURL}`,this.lastCallback||(this.lastCallback=this.quicklookCallback.bind(this),this.link.addEventListener("message",this.lastCallback)),this.link.download=i+".usdz",this.link.click()}download(e,i){gp.save(e,i)}static save(e,i){const n=document.createElement("a");n.style.display="none",document.body.appendChild(n),typeof e=="string"?n.href=e:n.href=URL.createObjectURL(e),n.download=i,n.click(),n.remove()}quicklookCallback(e){if((e==null?void 0:e.data)=="_apple_ar_quicklook_button_tapped"){Ki&&Me("Quicklook closed via call to action button");var i=new CustomEvent("quicklook-button-tapped",{detail:this});if(this.dispatchEvent(i),!i.defaultPrevented){const n=new URLSearchParams(this.link.href);if(n){const o=n.get("callToActionURL");Ki&&tt("Quicklook url: "+o),o&&(La()?globalThis.open(o,"_blank"):console.warn("Quicklook closed: custom redirects require a Needle Engine Pro license: https://needle.tools/pricing",o))}}}}buildQuicklookOverlay(){var n,o,r,l,c,h;const e={};return this.customBranding&&Object.assign(e,this.customBranding),La()||(console.log("Custom Quicklook banner text requires pro license: https://needle.tools/pricing"),e.callToAction="Close",e.checkoutTitle="üåµ Made with Needle",e.checkoutSubtitle="_"),(((n=e.callToAction)==null?void 0:n.length)||((o=e.checkoutTitle)==null?void 0:o.length)||((r=e.checkoutSubtitle)==null?void 0:r.length))&&((l=e.callToAction)!=null&&l.length||(e.callToAction="\0"),(c=e.checkoutTitle)!=null&&c.length||(e.checkoutTitle="\0"),(h=e.checkoutSubtitle)!=null&&h.length||(e.checkoutSubtitle="\0")),this.dispatchEvent(new CustomEvent("quicklook-overlay",{detail:e})),e}getARScaleAndTarget(){if(!this.objectToExport)return{scale:1,_invertForward:!1,target:this.gameObject,sessionRoot:null};const e=P.findObjectOfType(Ze);let i=P.getComponentInParent(this.objectToExport,es);i||(i=P.getComponentInChildren(this.objectToExport,es));let n=1,o=!1;const r=this.objectToExport;return e?n=e.arScale:i&&(n=i.arScale,o=i.invertForward),{scale:1/n,_invertForward:o,target:r,sessionRoot:(i==null?void 0:i.gameObject)??null}}applyWebARSessionRoot(){if(!this.objectToExport)return;const{scale:e,_invertForward:i,target:n,sessionRoot:o}=this.getARScaleAndTarget(),r=o==null?void 0:o.matrixWorld.clone().invert();this._rootSessionRootWasAppliedTo=n,this._rootPositionBeforeExport.copy(n.position),this._rootRotationBeforeExport.copy(n.quaternion),this._rootScaleBeforeExport.copy(n.scale),n.scale.multiplyScalar(e),i&&n.quaternion.multiply(gp.invertForwardQuaternion),n.updateMatrix(),n.updateMatrixWorld(!0),o&&r&&n.matrix.premultiply(r)}revertWebARSessionRoot(){if(!this.objectToExport||!this._rootSessionRootWasAppliedTo)return;const e=this._rootSessionRootWasAppliedTo;e.position.copy(this._rootPositionBeforeExport),e.quaternion.copy(this._rootRotationBeforeExport),e.scale.copy(this._rootScaleBeforeExport),e.updateMatrix(),e.updateMatrixWorld(!0),this._rootSessionRootWasAppliedTo=null}createQuicklookButton(){const i=Br.getOrCreate().createQuicklookButton();return i.parentNode||this.context.menu.appendChild(i),i}};let Fe=gp;a(Fe,"invertForwardMatrix",new le().makeRotationY(Math.PI)),a(Fe,"invertForwardQuaternion",new H().setFromEuler(new di(0,Math.PI,0)));Zt([m(F)],Fe.prototype,"objectToExport",void 0);Zt([m()],Fe.prototype,"autoExportAnimations",void 0);Zt([m()],Fe.prototype,"autoExportAudioSources",void 0);Zt([m()],Fe.prototype,"exportFileName",void 0);Zt([m(URL)],Fe.prototype,"customUsdzFile",void 0);Zt([m(cl)],Fe.prototype,"customBranding",void 0);Zt([m()],Fe.prototype,"anchoringType",void 0);Zt([m()],Fe.prototype,"maxTextureSize",void 0);Zt([m()],Fe.prototype,"planeAnchoringAlignment",void 0);Zt([m()],Fe.prototype,"interactive",void 0);Zt([m()],Fe.prototype,"physics",void 0);Zt([m()],Fe.prototype,"allowCreateQuicklookButton",void 0);Zt([m()],Fe.prototype,"quickLookCompatible",void 0);var Pb=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o},a_;(function(s){s[s.Linear=1]="Linear",s[s.Exponential=2]="Exponential",s[s.ExponentialSquared=3]="ExponentialSquared"})(a_||(a_={}));class Jd extends j{constructor(){super(...arguments);a(this,"_fog")}get fog(){return this._fog||(this._fog=new lw(0,0,50)),this._fog}get mode(){return a_.Linear}set near(e){this.fog.near=e}get near(){return this.fog.near}set far(e){this.fog.far=e}get far(){return this.fog.far}set color(e){this.fog.color.copy(e)}get color(){return this.fog.color}onEnable(){this.scene.fog=this.fog}onDisable(){this.scene.fog===this._fog&&(this.scene.fog=null)}}Pb([m()],Jd.prototype,"near",null);Pb([m()],Jd.prototype,"far",null);Pb([m(ue)],Jd.prototype,"color",null);var Rb=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};class Nc extends j{constructor(){super(...arguments);a(this,"objectBounds",!1);a(this,"color");a(this,"isGizmo",!0);a(this,"_gizmoObject",null);a(this,"_boxHelper",null)}onEnable(){this.isGizmo&&!Fd||(this._gizmoObject||(this.objectBounds?this._gizmoObject=new fR(this.gameObject,this.color??16776960):(this.objectBounds=!1,this._gizmoObject=H_(this.color??16776960))),this.objectBounds?(this.scene.add(this._gizmoObject),this._boxHelper=this._gizmoObject,this.startCoroutine(this.syncObjectBounds(),oe.OnBeforeRender)):this.gameObject.add(this._gizmoObject))}onDisable(){this._gizmoObject&&this.gameObject.remove(this._gizmoObject)}*syncObjectBounds(){var e;for(;this._boxHelper;)(e=this._boxHelper)==null||e.update(),yield}}Rb([m()],Nc.prototype,"objectBounds",void 0);Rb([m(ue)],Nc.prototype,"color",void 0);Rb([m()],Nc.prototype,"isGizmo",void 0);var Ob=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};class Zd extends j{constructor(){super(...arguments);a(this,"isGizmo",!1);a(this,"color0");a(this,"color1");a(this,"gridHelper");a(this,"size");a(this,"divisions");a(this,"offset")}onEnable(){if(this.isGizmo&&!Fd)return;const e=this.size,i=this.divisions;this.gridHelper||(this.gridHelper=new w_(e,i,this.color0??new ue(.4,.4,.4),this.color1??new ue(.6,.6,.6)),this.offset!==void 0&&(this.gridHelper.position.y+=this.offset)),this.gridHelper&&this.gameObject.add(this.gridHelper)}onDisable(){this.gridHelper&&(this.gameObject.remove(this.gridHelper),this.gridHelper=null)}}Ob([m()],Zd.prototype,"isGizmo",void 0);Ob([m(ue)],Zd.prototype,"color0",void 0);Ob([m(ue)],Zd.prototype,"color1",void 0);var Tb=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};class kb extends j{constructor(){super(...arguments);a(this,"connectedBody");a(this,"_rigidBody",null)}get rigidBody(){return this._rigidBody}onEnable(){this._rigidBody||(this._rigidBody=this.gameObject.getComponent(ve)),this.rigidBody&&this.connectedBody&&this.startCoroutine(this.create())}*create(){yield,this.rigidBody&&this.connectedBody&&this.activeAndEnabled&&this.createJoint(this.rigidBody,this.connectedBody)}}Tb([m(ve)],kb.prototype,"connectedBody",void 0);class A1 extends kb{createJoint(t,e){var i;(i=this.context.physics.engine)==null||i.addFixedJoint(t,e)}}class rm extends kb{constructor(){super(...arguments);a(this,"anchor");a(this,"axis")}createJoint(e,i){var n;this.axis&&this.anchor&&((n=this.context.physics.engine)==null||n.addHingeJoint(e,i,this.anchor,this.axis))}}Tb([m(x)],rm.prototype,"anchor",void 0);Tb([m(x)],rm.prototype,"axis",void 0);var eo=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};function Ng(s){return s*Math.PI/180}const kx=300,ar=C("debuglights");var fo;(function(s){s[s.Spot=0]="Spot",s[s.Directional=1]="Directional",s[s.Point=2]="Point",s[s.Area=3]="Area",s[s.Rectangle=3]="Rectangle",s[s.Disc=4]="Disc"})(fo||(fo={}));var Yf;(function(s){s[s.Realtime=4]="Realtime",s[s.Baked=2]="Baked",s[s.Mixed=1]="Mixed"})(Yf||(Yf={}));var Jh;(function(s){s[s.None=0]="None",s[s.Hard=1]="Hard",s[s.Soft=2]="Soft"})(Jh||(Jh={}));class gn extends j{constructor(){super(...arguments);a(this,"type",0);a(this,"range",1);a(this,"spotAngle",1);a(this,"innerSpotAngle",1);a(this,"_color",new ue(16777215));a(this,"_shadowNearPlane",.1);a(this,"_shadowBias",0);a(this,"_shadowNormalBias",0);a(this,"_overrideShadowBiasSettings",!1);a(this,"_shadows",1);a(this,"lightmapBakeType",Yf.Realtime);a(this,"_intensity",-1);a(this,"_shadowDistance");a(this,"shadowWidth");a(this,"shadowHeight");a(this,"_shadowResolution");a(this,"light");a(this,"_webXRStartedListener");a(this,"_webXREndedListener");a(this,"_webARRoot")}set color(e){this._color=e,this.light!==void 0&&(this.light.color=e)}get color(){return this.light?this.light.color:this._color}set shadowNearPlane(e){var i,n;if(e!==this._shadowNearPlane&&(this._shadowNearPlane=e,((n=(i=this.light)==null?void 0:i.shadow)==null?void 0:n.camera)!==void 0)){const o=this.light.shadow.camera;o.near=e}}get shadowNearPlane(){return this._shadowNearPlane}set shadowBias(e){var i,n;e!==this._shadowBias&&(this._shadowBias=e,((n=(i=this.light)==null?void 0:i.shadow)==null?void 0:n.bias)!==void 0&&(this.light.shadow.bias=e,this.light.shadow.needsUpdate=!0))}get shadowBias(){return this._shadowBias}set shadowNormalBias(e){var i,n;e!==this._shadowNormalBias&&(this._shadowNormalBias=e,((n=(i=this.light)==null?void 0:i.shadow)==null?void 0:n.normalBias)!==void 0&&(this.light.shadow.normalBias=e,this.light.shadow.needsUpdate=!0))}get shadowNormalBias(){return this._shadowNormalBias}set shadows(e){this._shadows=e,this.light&&(this.light.castShadow=e!==Jh.None,this.updateShadowSoftHard())}get shadows(){return this._shadows}set intensity(e){var i;if(this._intensity=e,this.light){let n=1;if(this.context.isInXR&&this._webARRoot){const o=(i=this._webARRoot)==null?void 0:i.arScale;typeof o=="number"&&o>0&&(n/=o)}this.light.intensity=e*n}ar&&console.log("Set light intensity to "+this._intensity,e,this)}get intensity(){return this._intensity}get shadowDistance(){const e=this.light;return e!=null&&e.shadow?e.shadow.camera.far:-1}set shadowDistance(e){this._shadowDistance=e;const i=this.light;if(i!=null&&i.shadow){const n=i.shadow.camera;n.far=e,n.updateProjectionMatrix()}}get shadowResolution(){const e=this.light;return e!=null&&e.shadow?e.shadow.mapSize.x:-1}set shadowResolution(e){if(e===this._shadowResolution)return;this._shadowResolution=e;const i=this.light;i!=null&&i.shadow&&(i.shadow.mapSize.set(e,e),i.shadow.needsUpdate=!0)}get isBaked(){return this.lightmapBakeType===Yf.Baked}get selfIsLight(){if(this.gameObject.isLight===!0)return!0;switch(this.gameObject.type){case"SpotLight":case"PointLight":case"DirectionalLight":return!0}return!1}getWorldPosition(e){return this.light?this.type===fo.Directional?this.light.getWorldPosition(e).multiplyScalar(1):this.light.getWorldPosition(e):e}awake(){this.color=new ue(this.color??16777215),ar&&console.log(this.name,this)}onEnable(){ar&&console.log("ENABLE LIGHT",this.name),this.createLight(),!this.isBaked&&(this.light&&(this.light.visible=!0,this.light.intensity=this._intensity,ar&&console.log("Set light intensity to "+this.light.intensity,this.name),this.selfIsLight||this.light.parent!==this.gameObject&&this.gameObject.add(this.light)),this.type===fo.Directional&&this.startCoroutine(this.updateMainLightRoutine(),oe.LateUpdate))}onDisable(){ar&&console.log("DISABLE LIGHT",this.name),this.light&&(this.selfIsLight?this.light.intensity=0:this.light.visible=!1)}onEnterXR(e){this._webARRoot=P.getComponentInParent(this.gameObject,es)??void 0}onLeaveXR(e){}createLight(){const e=this.selfIsLight;if(e&&!this.light)switch(this.light=this.gameObject,this.light.name=this.name,this._intensity=this.light.intensity,this.type){case fo.Directional:this.setDirectionalLight(this.light);break}else if(!this.light)switch(this.type){case fo.Directional:const i=new sy(this.color,this.intensity*Math.PI);if(i.position.set(0,0,-kx*.5).applyQuaternion(this.gameObject.quaternion),this.gameObject.add(i.target),_c(i.target,0,0,0),this.light=i,this.gameObject.position.set(0,0,0),this.gameObject.rotation.set(0,0,0),ar){const l=new mR(this.light,.2,this.color);this.context.scene.add(l)}break;case fo.Spot:const n=new pR(this.color,this.intensity*Math.PI,this.range,Ng(this.spotAngle/2),1-Ng(this.innerSpotAngle/2)/Ng(this.spotAngle/2),2);n.position.set(0,0,0),n.rotation.set(0,0,0),this.light=n;const o=n.target;n.add(o),o.position.set(0,0,this.range),o.rotation.set(0,0,0);break;case fo.Point:const r=new cw(this.color,this.intensity*Math.PI,this.range);this.light=r;break}if(this.light){if(this._intensity>=0?this.light.intensity=this._intensity:this._intensity=this.light.intensity,this.shadows!==Jh.None?this.light.castShadow=!0:this.light.castShadow=!1,this.light.shadow){this._shadowResolution!==void 0&&this._shadowResolution>4?(this.light.shadow.mapSize.width=this._shadowResolution,this.light.shadow.mapSize.height=this._shadowResolution):(this.light.shadow.mapSize.width=2048,this.light.shadow.mapSize.height=2048),ar&&console.log("Override shadow bias?",this._overrideShadowBiasSettings,this.shadowBias,this.shadowNormalBias),this.light.shadow.bias=this.shadowBias,this.light.shadow.normalBias=this.shadowNormalBias,this.updateShadowSoftHard();const i=this.light.shadow.camera;if(i.near=this.shadowNearPlane,this._shadowDistance!==void 0&&typeof this._shadowDistance=="number"?i.far=this._shadowDistance:i.far=kx*Math.abs(this.gameObject.scale.z),this.gameObject.scale.set(1,1,1),this.shadowWidth!==void 0)i.left=-this.shadowWidth/2,i.right=this.shadowWidth/2;else{const n=this.gameObject.scale.x;i.left*=n,i.right*=n}if(this.shadowHeight!==void 0)i.top=this.shadowHeight/2,i.bottom=-this.shadowHeight/2;else{const n=this.gameObject.scale.y;i.top*=n,i.bottom*=n}this.light.shadow.needsUpdate=!0,ar&&this.context.scene.add(new gR(i))}this.isBaked?this.light.removeFromParent():e||this.gameObject.add(this.light)}}*updateMainLightRoutine(){for(;;){this.type===fo.Directional&&((!this.context.mainLight||this.intensity>this.context.mainLight.intensity)&&(this.context.mainLight=this),yield);break}}updateShadowSoftHard(){this.light&&this.light.shadow&&(this.shadows===Jh.Soft||(this.light.shadow.radius=1,this.light.shadow.blurSamples=1))}setDirectionalLight(e){e.add(e.target),e.target.position.set(0,0,-1)}}a(gn,"allowChangingRendererShadowMapType",!0);eo([m()],gn.prototype,"type",void 0);eo([m(ue)],gn.prototype,"color",null);eo([m()],gn.prototype,"shadowNearPlane",null);eo([m()],gn.prototype,"shadowBias",null);eo([m()],gn.prototype,"shadowNormalBias",null);eo([m()],gn.prototype,"shadows",null);eo([m()],gn.prototype,"lightmapBakeType",void 0);eo([m()],gn.prototype,"intensity",null);eo([m()],gn.prototype,"shadowDistance",null);eo([m()],gn.prototype,"shadowResolution",null);new x(0,0,0);var eu=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const $g=C("debuglods"),$2=C("nolods");var l_;(function(s){s[s.None=0]="None",s[s.CrossFade=1]="CrossFade",s[s.SpeedTree=2]="SpeedTree"})(l_||(l_={}));class $c{constructor(){a(this,"screenRelativeTransitionHeight");a(this,"distance");a(this,"renderers")}}eu([m()],$c.prototype,"screenRelativeTransitionHeight",void 0);eu([m()],$c.prototype,"distance",void 0);eu([m(Ve)],$c.prototype,"renderers",void 0);class W2{constructor(t){a(this,"model");this.model=t}get renderers(){return this.model.renderers}}class am extends j{constructor(){super(...arguments);a(this,"fadeMode",l_.None);a(this,"localReferencePoint");a(this,"lodCount",0);a(this,"size",0);a(this,"animateCrossFading",!1);a(this,"lodModels");a(this,"_lods",[]);a(this,"_settings",[]);a(this,"_lodsHandler");a(this,"_distanceFactor",1)}start(){if($g&&console.log("LODGROUP",this.name,this.lodModels,this),!$2&&!this._lodsHandler&&this.gameObject&&this.lodModels&&Array.isArray(this.lodModels)){const e=[];for(const n of this.lodModels){const o=new W2(n);this._lods.push(o);for(const r of o.renderers)e.includes(r)||e.push(r)}this._lodsHandler=new Array;for(let n=0;n<e.length;n++){const o=new yR;this._lodsHandler.push(o),this.gameObject.add(o)}const i=new F;i.name="Cull "+this.name;for(let n=0;n<e.length;n++){const o=e[n],r=this._lodsHandler[n],l=o.gameObject;$g&&console.log(n,l.name);for(const c of this._lods){const h=c.model.distance;let d=null;if(c.renderers.includes(o)?d=l:d=i,d.type==="Group"){console.warn(`LODGroup ${this.name}: Group or MultiMaterial object's are not supported as LOD object: ${d.name}`);continue}$g&&console.log("LEVEL",d.name,h),r.autoUpdate=!1,this.onAddLodLevel(r,d,c.model.distance)}}}}onAfterRender(){if(!this.gameObject||!this._lodsHandler)return;const e=this.context.mainCamera;if(e)for(const i of this._lodsHandler){i.update(e);const n=i.getCurrentLevel(),o=i.levels[n];i.layers.mask=o.object.layers.mask}}onAddLodLevel(e,i,n){if(i===this.gameObject){console.warn("LODGroup component must be on parent object and not mesh directly at the moment",i.name,i);return}e.addLevel(i,n*this._distanceFactor,.01);const o={lod:e,levelIndex:e.levels.length-1,distance:n};this._settings.push(o)}distanceFactor(e){if(e!==this._distanceFactor){this._distanceFactor=e;for(const i of this._settings){const n=i.lod.levels[i.levelIndex];n.distance=i.distance*e}}}}eu([m(x)],am.prototype,"localReferencePoint",void 0);eu([m($c)],am.prototype,"lodModels",void 0);var V2=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const Uu=C("debugnestedgltf");class Eb extends j{constructor(){super(...arguments);a(this,"filePath");a(this,"loadAssetInParent",!0);a(this,"_isLoadingOrDoneLoading",!1)}listenToProgress(e){var i;(i=this.filePath)==null||i.beginListenDownload(e)}preload(){var e;(e=this.filePath)==null||e.preload()}async start(){var i,n,o,r,l;if(this._isLoadingOrDoneLoading)return;Uu&&console.log(this,this.guid);const e=this.gameObject.parent;if(e){this._isLoadingOrDoneLoading=!0;const c=new Js;c.idProvider=new ui(this.hash(this.guid)),c.parent=this.loadAssetInParent!==!1?e:this.gameObject,this.gameObject.updateMatrix();const h=this.gameObject.matrix;Uu&&console.log("Load nested:",((i=this.filePath)==null?void 0:i.url)??this.filePath,this.gameObject.position);const d=await((o=(n=this.filePath)==null?void 0:n.instantiate)==null?void 0:o.call(this.filePath,c));Uu&&console.log("Nested loaded:",((r=this.filePath)==null?void 0:r.url)??this.filePath,d),d&&this.loadAssetInParent!==!1&&(d.matrixAutoUpdate=!1,d.matrix.identity(),d.applyMatrix4(h),d.matrixAutoUpdate=!0,d.layers.disableAll(),d.layers.set(this.layer),this.dispatchEvent(new CustomEvent("loaded",{detail:{instance:d,assetReference:this.filePath}}))),Uu&&console.log("Nested loading done:",((l=this.filePath)==null?void 0:l.url)??this.filePath,d)}}onDestroy(){var e;(e=this.filePath)==null||e.unload()}hash(e){let i=0;for(let n=0;n<e.length;n++)i=e.charCodeAt(n)+((i<<5)-i);return i}}V2([m(de)],Eb.prototype,"filePath",void 0);var Mb=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const H2=C("debugnet");class Hr extends j{constructor(){super(...arguments);a(this,"url",null);a(this,"urlParameterName",null);a(this,"localhost",null)}awake(){H2&&console.log(this),this.context.connection.registerProvider(this)}getWebsocketUrl(){let e=this.url?Hr.GetUrl(this.url,this.localhost):null;if(this.urlParameterName){const r=C(this.urlParameterName);r&&typeof r=="string"&&(e=r)}if(!e)return null;const n=new RegExp("(((https?)|(?<socket_prefix>wss?))://)?(www.)?(?<url>.+)","gm").exec(e);return n!=null&&n.groups?(n==null?void 0:n.groups.socket_prefix)?e:"wss://"+(n==null?void 0:n.groups.url):null}static GetUrl(e,i){let n=e;const o=Hr.IsLocalNetwork()&&i;if(o&&(n=i),e!=null&&e.startsWith("/")){const r=o?n:window.location.origin;r!=null&&r.endsWith("/")&&e.startsWith("/")&&(e=e.substring(1)),n=r+e}return n}static IsLocalNetwork(e=window.location.hostname){return qi(e)}}Mb([m()],Hr.prototype,"url",void 0);Mb([m()],Hr.prototype,"urlParameterName",void 0);Mb([m()],Hr.prototype,"localhost",void 0);var lm=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};class Wc extends j{constructor(){super(...arguments);a(this,"referenceSpace");a(this,"from");a(this,"affectPosition",!1);a(this,"affectRotation",!1);a(this,"alignLookDirection",!1);a(this,"levelLookDirection",!1);a(this,"levelPosition",!1);a(this,"positionOffset",new x(0,0,0));a(this,"rotationOffset",new x(0,0,0));a(this,"offset",new x(0,0,0))}update(){if(!this.from)return;var e=ae(this.from),i=Le(this.from);this.offset.copy(this.positionOffset);const n=this.offset.length();if(this.referenceSpace&&this.offset.transformDirection(this.referenceSpace.matrixWorld).multiplyScalar(n),e.add(this.offset),this.levelPosition&&this.referenceSpace){const c=new $a(this.gameObject.up,0),h=ae(this.referenceSpace);c.setFromNormalAndCoplanarPoint(this.gameObject.up,h);const d=new x(0,0,0);c.projectPoint(e,d),e.copy(d)}this.affectPosition&&jt(this.gameObject,e);const o=new di(this.rotationOffset.x,this.rotationOffset.y,this.rotationOffset.z),r=new H().setFromEuler(o);this.affectRotation&&as(this.gameObject,i.multiply(r));const l=new x;this.from.getWorldDirection(l).multiplyScalar(50),this.levelLookDirection&&(l.y=0),this.alignLookDirection&&this.gameObject.lookAt(l)}}lm([m(P)],Wc.prototype,"referenceSpace",void 0);lm([m(P)],Wc.prototype,"from",void 0);lm([m(x)],Wc.prototype,"positionOffset",void 0);lm([m(x)],Wc.prototype,"rotationOffset",void 0);const I1=Math.sqrt(5),G2=(I1-1)/4,Wt=(5-I1)/20,Nu=s=>Math.floor(s)|0,$u=new Float64Array([0,1,1,1,0,1,1,-1,0,1,-1,1,0,1,-1,-1,0,-1,1,1,0,-1,1,-1,0,-1,-1,1,0,-1,-1,-1,1,0,1,1,1,0,1,-1,1,0,-1,1,1,0,-1,-1,-1,0,1,1,-1,0,1,-1,-1,0,-1,1,-1,0,-1,-1,1,1,0,1,1,1,0,-1,1,-1,0,1,1,-1,0,-1,-1,1,0,1,-1,1,0,-1,-1,-1,0,1,-1,-1,0,-1,1,1,1,0,1,1,-1,0,1,-1,1,0,1,-1,-1,0,-1,1,1,0,-1,1,-1,0,-1,-1,1,0,-1,-1,-1,0]);function q2(s=Math.random){const t=X2(s),e=new Float64Array(t).map(r=>$u[r%32*4]),i=new Float64Array(t).map(r=>$u[r%32*4+1]),n=new Float64Array(t).map(r=>$u[r%32*4+2]),o=new Float64Array(t).map(r=>$u[r%32*4+3]);return function(l,c,h,d){let u,f,p,g,y;const b=(l+c+h+d)*G2,_=Nu(l+b),v=Nu(c+b),S=Nu(h+b),T=Nu(d+b),O=(_+v+S+T)*Wt,M=_-O,k=v-O,B=S-O,I=T-O,E=l-M,L=c-k,V=h-B,A=d-I;let D=0,N=0,q=0,Y=0;E>L?D++:N++,E>V?D++:q++,E>A?D++:Y++,L>V?N++:q++,L>A?N++:Y++,V>A?q++:Y++;const ie=D>=3?1:0,he=N>=3?1:0,Pe=q>=3?1:0,He=Y>=3?1:0,gt=D>=2?1:0,lt=N>=2?1:0,ei=q>=2?1:0,_i=Y>=2?1:0,bi=D>=1?1:0,fs=N>=1?1:0,ra=q>=1?1:0,Ee=Y>=1?1:0,yl=E-ie+Wt,Yc=L-he+Wt,Om=V-Pe+Wt,Tm=A-He+Wt,km=E-gt+2*Wt,Em=L-lt+2*Wt,Mm=V-ei+2*Wt,Am=A-_i+2*Wt,Im=E-bi+3*Wt,Dm=L-fs+3*Wt,Lm=V-ra+3*Wt,jm=A-Ee+3*Wt,Bm=E-1+4*Wt,Fm=L-1+4*Wt,zm=V-1+4*Wt,Um=A-1+4*Wt,Kc=_&255,Jc=v&255,Zc=S&255,eh=T&255;let th=.6-E*E-L*L-V*V-A*A;if(th<0)u=0;else{const Ge=Kc+t[Jc+t[Zc+t[eh]]];th*=th,u=th*th*(e[Ge]*E+i[Ge]*L+n[Ge]*V+o[Ge]*A)}let ih=.6-yl*yl-Yc*Yc-Om*Om-Tm*Tm;if(ih<0)f=0;else{const Ge=Kc+ie+t[Jc+he+t[Zc+Pe+t[eh+He]]];ih*=ih,f=ih*ih*(e[Ge]*yl+i[Ge]*Yc+n[Ge]*Om+o[Ge]*Tm)}let nh=.6-km*km-Em*Em-Mm*Mm-Am*Am;if(nh<0)p=0;else{const Ge=Kc+gt+t[Jc+lt+t[Zc+ei+t[eh+_i]]];nh*=nh,p=nh*nh*(e[Ge]*km+i[Ge]*Em+n[Ge]*Mm+o[Ge]*Am)}let sh=.6-Im*Im-Dm*Dm-Lm*Lm-jm*jm;if(sh<0)g=0;else{const Ge=Kc+bi+t[Jc+fs+t[Zc+ra+t[eh+Ee]]];sh*=sh,g=sh*sh*(e[Ge]*Im+i[Ge]*Dm+n[Ge]*Lm+o[Ge]*jm)}let oh=.6-Bm*Bm-Fm*Fm-zm*zm-Um*Um;if(oh<0)y=0;else{const Ge=Kc+1+t[Jc+1+t[Zc+1+t[eh+1]]];oh*=oh,y=oh*oh*(e[Ge]*Bm+i[Ge]*Fm+n[Ge]*zm+o[Ge]*Um)}return 27*(u+f+p+g+y)}}function X2(s){const e=new Uint8Array(512);for(let i=0;i<512/2;i++)e[i]=i;for(let i=0;i<512/2-1;i++){const n=i+~~(s()*(256-i)),o=e[i];e[i]=e[n],e[n]=o}for(let i=256;i<512;i++)e[i]=e[i-256];return e}var R=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const Wu=C("debugparticles");var Ms;(function(s){s[s.Billboard=0]="Billboard",s[s.Stretch=1]="Stretch",s[s.HorizontalBillboard=2]="HorizontalBillboard",s[s.VerticalBillboard=3]="VerticalBillboard",s[s.Mesh=4]="Mesh"})(Ms||(Ms={}));class hl{constructor(){a(this,"alphaKeys",[]);a(this,"colorKeys",[])}get duration(){return 1}evaluate(t,e){let i,n=0,o=null,r=0;for(let l=0;l<this.alphaKeys.length;l++){const c=this.alphaKeys[l];(c.time<t||!i)&&(i=c,n=l)}for(let l=0;l<this.colorKeys.length;l++){const c=this.colorKeys[l];(c.time<t||!o)&&(o=c,r=l)}if(o)if(r+1<this.colorKeys.length){const c=this.colorKeys[r+1],h=W.remap(t,o.time,c.time,0,1);e.r=W.lerp(o.color.r,c.color.r,h),e.g=W.lerp(o.color.g,c.color.g,h),e.b=W.lerp(o.color.b,c.color.b,h)}else e.r=o.color.r,e.g=o.color.g,e.b=o.color.b;if(i)if(n+1<this.alphaKeys.length){const c=this.alphaKeys[n+1],h=W.remap(t,i.time,c.time,0,1);e.alpha=W.lerp(i.alpha,c.alpha,h)}else e.alpha=i.alpha;return e}}R([m()],hl.prototype,"alphaKeys",void 0);R([m()],hl.prototype,"colorKeys",void 0);var ft;(function(s){s[s.Constant=0]="Constant",s[s.Curve=1]="Curve",s[s.TwoCurves=2]="TwoCurves",s[s.TwoConstants=3]="TwoConstants"})(ft||(ft={}));var xs;(function(s){s[s.Color=0]="Color",s[s.Gradient=1]="Gradient",s[s.TwoColors=2]="TwoColors",s[s.TwoGradients=3]="TwoGradients",s[s.RandomColor=4]="RandomColor"})(xs||(xs={}));var ss;(function(s){s[s.Local=0]="Local",s[s.World=1]="World",s[s.Custom=2]="Custom"})(ss||(ss={}));var Ci;(function(s){s[s.Sphere=0]="Sphere",s[s.SphereShell=1]="SphereShell",s[s.Hemisphere=2]="Hemisphere",s[s.HemisphereShell=3]="HemisphereShell",s[s.Cone=4]="Cone",s[s.Box=5]="Box",s[s.Mesh=6]="Mesh",s[s.ConeShell=7]="ConeShell",s[s.ConeVolume=8]="ConeVolume",s[s.ConeVolumeShell=9]="ConeVolumeShell",s[s.Circle=10]="Circle",s[s.CircleEdge=11]="CircleEdge",s[s.SingleSidedEdge=12]="SingleSidedEdge",s[s.MeshRenderer=13]="MeshRenderer",s[s.SkinnedMeshRenderer=14]="SkinnedMeshRenderer",s[s.BoxShell=15]="BoxShell",s[s.BoxEdge=16]="BoxEdge",s[s.Donut=17]="Donut",s[s.Rectangle=18]="Rectangle",s[s.Sprite=19]="Sprite",s[s.SpriteRenderer=20]="SpriteRenderer"})(Ci||(Ci={}));var xa;(function(s){s[s.Random=0]="Random",s[s.Loop=1]="Loop",s[s.PingPong=2]="PingPong",s[s.BurstSpread=3]="BurstSpread"})(xa||(xa={}));class X{constructor(){a(this,"mode","Constant");a(this,"constant");a(this,"constantMin");a(this,"constantMax");a(this,"curve");a(this,"curveMin");a(this,"curveMax");a(this,"curveMultiplier")}static constant(t){const e=new X;return e.setConstant(t),e}static betweenTwoConstants(t,e){const i=new X;return i.setMinMaxConstant(t,e),i}static curve(t,e=1){const i=new X;return i.setCurve(t,e),i}setConstant(t){this.mode=ft.Constant,this.constant=t}setMinMaxConstant(t,e){this.mode=ft.TwoConstants,this.constantMin=t,this.constantMax=e}setCurve(t,e=1){this.mode=ft.Curve,this.curve=t,this.curveMultiplier=e}clone(){var e,i,n;const t=new X;return t.mode=this.mode,t.constant=this.constant,t.constantMin=this.constantMin,t.constantMax=this.constantMax,t.curve=(e=this.curve)==null?void 0:e.clone(),t.curveMin=(i=this.curveMin)==null?void 0:i.clone(),t.curveMax=(n=this.curveMax)==null?void 0:n.clone(),t.curveMultiplier=this.curveMultiplier,t}evaluate(t,e){const i=e===void 0?Math.random():e;switch(this.mode){case ft.Constant:case"Constant":return this.constant;case ft.Curve:case"Curve":return t=W.clamp01(t),this.curve.evaluate(t)*this.curveMultiplier;case ft.TwoCurves:case"TwoCurves":const n=t*this.curveMin.duration,o=t*this.curveMax.duration;return W.lerp(this.curveMin.evaluate(n),this.curveMax.evaluate(o),i%1)*this.curveMultiplier;case ft.TwoConstants:case"TwoConstants":return W.lerp(this.constantMin,this.constantMax,i%1);default:this.curveMax.evaluate(t)*this.curveMultiplier;break}return 0}getMax(){switch(this.mode){case ft.Constant:case"Constant":return this.constant;case ft.Curve:case"Curve":return this.getMaxFromCurve(this.curve)*this.curveMultiplier;case ft.TwoCurves:case"TwoCurves":return Math.max(this.getMaxFromCurve(this.curveMin),this.getMaxFromCurve(this.curveMax))*this.curveMultiplier;case ft.TwoConstants:case"TwoConstants":return Math.max(this.constantMin,this.constantMax);default:return 0}}getMaxFromCurve(t){if(!t)return 0;let e=Number.MIN_VALUE;for(let i=0;i<t.keys.length;i++){const n=t.keys[i];n.value>e&&(e=n.value)}return e}}R([m()],X.prototype,"mode",void 0);R([m()],X.prototype,"constant",void 0);R([m()],X.prototype,"constantMin",void 0);R([m()],X.prototype,"constantMax",void 0);R([m(Zn)],X.prototype,"curve",void 0);R([m(Zn)],X.prototype,"curveMin",void 0);R([m(Zn)],X.prototype,"curveMax",void 0);R([m()],X.prototype,"curveMultiplier",void 0);const Et=class{constructor(){a(this,"mode",xs.Color);a(this,"color");a(this,"colorMin");a(this,"colorMax");a(this,"gradient");a(this,"gradientMin");a(this,"gradientMax")}static constant(t){const e=new Et;return e.constant(t),e}static betweenTwoColors(t,e){const i=new Et;return i.betweenTwoColors(t,e),i}constant(t){return this.mode=xs.Color,this.color=t,this}betweenTwoColors(t,e){return this.mode=xs.TwoColors,this.colorMin=t,this.colorMax=e,this}evaluate(t,e){const i=e===void 0?Math.random():e;switch(this.mode){case xs.Color:case"Color":return this.color;case xs.Gradient:case"Gradient":return this.gradient.evaluate(t,Et._temp),Et._temp;case xs.TwoColors:case"TwoColors":return Et._temp.lerpColors(this.colorMin,this.colorMax,i);case xs.TwoGradients:case"TwoGradients":return this.gradientMin.evaluate(t,Et._temp),this.gradientMax.evaluate(t,Et._temp2),Et._temp.lerp(Et._temp2,i);case xs.RandomColor:case"RandomColor":const o=Math.random();return this.gradientMin.evaluate(t,Et._temp),this.gradientMax.evaluate(t,Et._temp2),Et._temp.lerp(Et._temp2,o)}return Et._temp.set(16777215),Et._temp.alpha=1,Et._temp}};let Lt=Et;a(Lt,"_temp",new Ae(0,0,0,1)),a(Lt,"_temp2",new Ae(0,0,0,1));R([m()],Lt.prototype,"mode",void 0);R([m(Ae)],Lt.prototype,"color",void 0);R([m(Ae)],Lt.prototype,"colorMin",void 0);R([m(Ae)],Lt.prototype,"colorMax",void 0);R([m(hl)],Lt.prototype,"gradient",void 0);R([m(hl)],Lt.prototype,"gradientMin",void 0);R([m(hl)],Lt.prototype,"gradientMax",void 0);var Kf;(function(s){s[s.Hierarchy=0]="Hierarchy",s[s.Local=1]="Local",s[s.Shape=2]="Shape"})(Kf||(Kf={}));class gi{constructor(){a(this,"cullingMode");a(this,"duration");a(this,"emitterVelocityMode");a(this,"flipRotation");a(this,"gravityModifier");a(this,"gravityModifierMultiplier");a(this,"loop");a(this,"maxParticles");a(this,"playOnAwake");a(this,"prewarm");a(this,"ringBufferLoopRange");a(this,"ringBufferMode");a(this,"scalingMode");a(this,"simulationSpace");a(this,"simulationSpeed");a(this,"startColor");a(this,"startDelay");a(this,"startDelayMultiplier");a(this,"startLifetime");a(this,"startLifetimeMultiplier");a(this,"startRotation");a(this,"startRotationMultiplier");a(this,"startRotation3D");a(this,"startRotationX");a(this,"startRotationXMultiplier");a(this,"startRotationY");a(this,"startRotationYMultiplier");a(this,"startRotationZ");a(this,"startRotationZMultiplier");a(this,"startSize");a(this,"startSize3D");a(this,"startSizeMultiplier");a(this,"startSizeX");a(this,"startSizeXMultiplier");a(this,"startSizeY");a(this,"startSizeYMultiplier");a(this,"startSizeZ");a(this,"startSizeZMultiplier");a(this,"startSpeed");a(this,"startSpeedMultiplier");a(this,"stopAction");a(this,"useUnscaledTime")}}R([m(X)],gi.prototype,"gravityModifier",void 0);R([m(Lt)],gi.prototype,"startColor",void 0);R([m(X)],gi.prototype,"startDelay",void 0);R([m(X)],gi.prototype,"startLifetime",void 0);R([m(X)],gi.prototype,"startRotation",void 0);R([m(X)],gi.prototype,"startRotationX",void 0);R([m(X)],gi.prototype,"startRotationY",void 0);R([m(X)],gi.prototype,"startRotationZ",void 0);R([m(X)],gi.prototype,"startSize",void 0);R([m(X)],gi.prototype,"startSizeX",void 0);R([m(X)],gi.prototype,"startSizeY",void 0);R([m(X)],gi.prototype,"startSizeZ",void 0);R([m(X)],gi.prototype,"startSpeed",void 0);class Jf{constructor(){a(this,"cycleCount");a(this,"maxCount");a(this,"minCount");a(this,"probability");a(this,"repeatInterval");a(this,"time");a(this,"count");a(this,"_performed",0)}reset(){this._performed=0}run(t){if(t<=this.time)return 0;let e=0;if(this.cycleCount===0||this._performed<this.cycleCount){const i=this.time+this.repeatInterval*this._performed;if(t>=i&&(this._performed+=1,Math.random()<this.probability))switch(this.count.mode){case ft.Constant:e=this.count.constant;break;case ft.TwoConstants:e=W.lerp(this.count.constantMin,this.count.constantMax,Math.random());break;case ft.Curve:e=this.count.curve.evaluate(Math.random());break;case ft.TwoCurves:const n=Math.random();e=W.lerp(this.count.curveMin.evaluate(n),this.count.curveMax.evaluate(n),Math.random());break}}return e}}class er{constructor(){a(this,"enabled");a(this,"bursts");a(this,"rateOverTime");a(this,"rateOverTimeMultiplier");a(this,"rateOverDistance");a(this,"rateOverDistanceMultiplier");a(this,"system")}get burstCount(){var t;return((t=this.bursts)==null?void 0:t.length)??0}reset(){var t;(t=this.bursts)==null||t.forEach(e=>e.reset())}getBurst(){let t=0;if(this.burstCount>0)for(let e=0;e<this.burstCount;e++){const i=this.bursts[e];this.system.main.loop&&i.time>=this.system.time&&i.reset(),t+=Math.round(i.run(this.system.time))}return t}}R([m()],er.prototype,"enabled",void 0);R([m()],er.prototype,"bursts",void 0);R([m(X)],er.prototype,"rateOverTime",void 0);R([m()],er.prototype,"rateOverTimeMultiplier",void 0);R([m(X)],er.prototype,"rateOverDistance",void 0);R([m()],er.prototype,"rateOverDistanceMultiplier",void 0);class cm{constructor(){a(this,"enabled");a(this,"color")}}R([m(Lt)],cm.prototype,"color",void 0);class dl{constructor(){a(this,"enabled");a(this,"separateAxes");a(this,"size");a(this,"sizeMultiplier");a(this,"x");a(this,"xMultiplier");a(this,"y");a(this,"yMultiplier");a(this,"z");a(this,"zMultiplier");a(this,"_time",0);a(this,"_temp",new x)}evaluate(t,e,i){if(e||(e=this._temp),!this.enabled)return e.x=e.y=e.z=1,e;if(this.separateAxes)e.x=this.x.evaluate(t,i)*this.xMultiplier,e.y=this.y.evaluate(t,i)*this.yMultiplier,e.z=this.z.evaluate(t,i)*this.zMultiplier;else{const n=this.size.evaluate(t,i)*this.sizeMultiplier;e.x=n}return e}}R([m(X)],dl.prototype,"size",void 0);R([m(X)],dl.prototype,"x",void 0);R([m(X)],dl.prototype,"y",void 0);R([m(X)],dl.prototype,"z",void 0);var yr;(function(s){s[s.Vertex=0]="Vertex",s[s.Edge=1]="Edge",s[s.Triangle=2]="Triangle"})(yr||(yr={}));const Kl=class{constructor(){a(this,"shapeType",Ci.Box);a(this,"enabled",!0);a(this,"alignToDirection",!1);a(this,"angle",0);a(this,"arc",360);a(this,"arcSpread");a(this,"arcSpeedMultiplier");a(this,"arcMode");a(this,"boxThickness");a(this,"position");a(this,"rotation");a(this,"_rotation",new di);a(this,"scale");a(this,"radius");a(this,"radiusThickness");a(this,"sphericalDirectionAmount");a(this,"randomDirectionAmount");a(this,"randomPositionAmount");a(this,"meshShapeType");a(this,"meshRenderer");a(this,"_meshObj");a(this,"_meshGeometry");a(this,"system");a(this,"_space");a(this,"_worldSpaceMatrix",new le);a(this,"_worldSpaceMatrixInverse",new le);a(this,"_vector",new x(0,0,0));a(this,"_temp",new x(0,0,0));a(this,"_triangle",new _R);a(this,"_dir",new x);a(this,"_loopTime",0);a(this,"_loopDirection",1);Wu&&console.log(this)}get type(){return Ci[this.shapeType]}initialize(t){this.onInitialize(t),t.position.x=this._vector.x,t.position.y=this._vector.y,t.position.z=this._vector.z}toJSON(){return this}clone(){return new Kl}setMesh(t){this.meshRenderer=t,t?(this._meshObj=t.sharedMeshes[Math.floor(Math.random()*t.sharedMeshes.length)],this._meshGeometry=this._meshObj.geometry):(this._meshObj=void 0,this._meshGeometry=void 0)}update(t,e){}onUpdate(t,e,i,n){this.system=t,this._space=i,i===ss.World&&(this._worldSpaceMatrix.copy(n.matrixWorld),this._worldSpaceMatrix.elements[0]=1,this._worldSpaceMatrix.elements[5]=1,this._worldSpaceMatrix.elements[10]=1,this._worldSpaceMatrixInverse.copy(this._worldSpaceMatrix).invert())}applyRotation(t){const e=this.rotation.x!==0||this.rotation.y!==0||this.rotation.z!==0;return e&&(this._rotation.x=W.toRadians(this.rotation.x),this._rotation.y=W.toRadians(this.rotation.y),this._rotation.z=W.toRadians(this.rotation.z),this._rotation.order="ZYX",t.applyEuler(this._rotation)),e}onInitialize(t){this._vector.set(0,0,0),t.mesh=void 0,t.mesh_geometry=void 0;const e=this._temp.copy(this.position),i=this._space===ss.World;i&&e.applyQuaternion(this.system.worldQuaternion);let n=this.radius;if(i&&(n*=this.system.worldScale.x),this.enabled){switch(this.shapeType){case Ci.Box:Wu&&G.DrawWireBox(this.position,this.scale,14540253,1),this._vector.x=Math.random()*this.scale.x-this.scale.x/2,this._vector.y=Math.random()*this.scale.y-this.scale.y/2,this._vector.z=Math.random()*this.scale.z-this.scale.z/2,this._vector.add(e);break;case Ci.Cone:this.randomConePoint(this.position,this.angle,n,this.radiusThickness,this.arc,this.arcMode,this._vector);break;case Ci.Sphere:this.randomSpherePoint(this.position,n,this.radiusThickness,this.arc,this._vector);break;case Ci.Circle:this.randomCirclePoint(this.position,n,this.radiusThickness,this.arc,this._vector);break;case Ci.MeshRenderer:const o=this.meshRenderer;(o==null?void 0:o.destroyed)==!1&&this.setMesh(o);const r=t.mesh=this._meshObj,l=t.mesh_geometry=this._meshGeometry;if(r&&l)switch(this.meshShapeType){case yr.Vertex:{const c=l.getAttribute("position"),h=Math.floor(Math.random()*c.count);this._vector.fromBufferAttribute(c,h),this._vector.applyMatrix4(r.matrixWorld),t.mesh_normal=h}break;case yr.Edge:break;case yr.Triangle:{const c=l.index;if(c){let h=Math.random(),d=Math.random();h+d>1&&(h=1-h,d=1-d);const u=Math.floor(Math.random()*(c.count/3));let f=u*3,p=u*3+1,g=u*3+2;f=c.getX(f),p=c.getX(p),g=c.getX(g);const y=l.getAttribute("position");this._triangle.a.fromBufferAttribute(y,f),this._triangle.b.fromBufferAttribute(y,p),this._triangle.c.fromBufferAttribute(y,g),this._vector.set(0,0,0).addScaledVector(this._triangle.a,h).addScaledVector(this._triangle.b,d).addScaledVector(this._triangle.c,1-(h+d)),this._vector.applyMatrix4(r.matrixWorld),t.mesh_normal=u}}break}break;default:this._vector.set(0,0,0),U()&&!globalThis.__particlesystem_shapetype_unsupported&&(console.warn("ParticleSystem ShapeType is not supported:",Ci[this.shapeType]),globalThis.__particlesystem_shapetype_unsupported=!0);break}this.randomizePosition(this._vector,this.randomPositionAmount)}this.applyRotation(this._vector),i&&(this._vector.applyQuaternion(this.system.worldQuaternion),this._vector.add(this.system.worldPos)),Wu&&G.DrawSphere(this._vector,.03,16711680,.5,!0)}getDirection(t,e){var i;if(!this.enabled)return this._dir.set(0,0,1),this._dir;switch(this.shapeType){case Ci.Box:this._dir.set(0,0,1);break;case Ci.Cone:this._dir.set(0,0,1);break;case Ci.Circle:case Ci.Sphere:const n=e.x,o=e.y,r=e.z;this._dir.set(n,o,r),(i=this.system)!=null&&i.worldspace?this._dir.sub(this.system.worldPos):this._dir.sub(this.position);break;case Ci.MeshRenderer:const l=t.mesh,c=t.mesh_geometry;if(l&&c)switch(this.meshShapeType){case yr.Vertex:{const h=c.getAttribute("normal"),d=t.mesh_normal;this._dir.fromBufferAttribute(h,d)}break;case yr.Edge:break;case yr.Triangle:{const h=c.index;if(h){const d=t.mesh_normal,u=h.getX(d*3),f=h.getX(d*3+1),p=h.getX(d*3+2),g=c.getAttribute("position"),y=Q(),b=Q(),_=Q();y.fromBufferAttribute(g,u),b.fromBufferAttribute(g,f),_.fromBufferAttribute(g,p),y.sub(b),_.sub(b),y.cross(_),this._dir.copy(y).multiplyScalar(-1);const v=Le(l);this._dir.applyQuaternion(v)}}break}break;default:this._dir.set(0,0,1);break}return this._space===ss.World&&this._dir.applyQuaternion(this.system.worldQuaternion),this.applyRotation(this._dir),this._dir.normalize(),this.spherizeDirection(this._dir,this.sphericalDirectionAmount),this.randomizeDirection(this._dir,this.randomDirectionAmount),Wu&&(G.DrawSphere(e,.01,8925952,.5,!0),G.DrawDirection(e,this._dir,8925952,.5,!0)),this._dir}randomizePosition(t,e){if(e<=0)return;const i=Kl._tempVec;i.set(Math.random()*2-1,Math.random()*2-1,Math.random()*2-1),i.x*=e*this.scale.x,i.y*=e*this.scale.y,i.z*=e*this.scale.z,t.add(i)}randomizeDirection(t,e){if(e===0)return;const i=Kl._randomQuat,n=Kl._tempVec;n.set(Math.random()-.5,Math.random()-.5,Math.random()-.5).normalize(),i.setFromAxisAngle(n,e*Math.random()*Math.PI),t.applyQuaternion(i)}spherizeDirection(t,e){if(e===0)return;const i=Math.random()*Math.PI*2,n=Math.acos(1-Math.random()*2),o=Math.sin(n)*Math.cos(i),r=Math.sin(n)*Math.sin(i),l=Math.cos(n),c=new x(o,r,l);t.lerp(c,e)}randomSpherePoint(t,e,i,n,o){const r=Math.random(),l=Math.random(),c=2*Math.PI*r*(n/360),h=Math.acos(2*l-1),d=W.lerp(1,1-Math.pow(1-Math.random(),Math.PI),i)*e,u=t.x+this.scale.x*(-d*Math.sin(h)*Math.cos(c)),f=t.y+this.scale.y*(d*Math.sin(h)*Math.sin(c)),p=t.z+this.scale.z*(d*Math.cos(h));o.x=u,o.y=f,o.z=p}randomCirclePoint(t,e,i,n,o){const r=Math.random(),l=2*Math.PI*r*(n/360),c=W.lerp(1,1-Math.pow(1-Math.random(),Math.PI),i)*e,h=t.x+this.scale.x*c*Math.cos(l),d=t.y+this.scale.y*c*Math.sin(l),u=t.z;o.x=h,o.y=d,o.z=u}randomConePoint(t,e,i,n,o,r,l){let c=0,h=0;switch(r){case xa.Random:c=Math.random(),h=Math.random();break;case xa.PingPong:this._loopTime>1&&(this._loopDirection=-1),this._loopTime<0&&(this._loopDirection=1);case xa.Loop:c=.5,h=Math.random(),this._loopTime+=this.system.deltaTime*this._loopDirection;break}let d=2*Math.PI*c*(o/360);switch(r){case xa.PingPong:case xa.Loop:d+=Math.PI+.5,d+=this._loopTime*Math.PI*2,d%=W.toRadians(o);break}const u=Math.acos(2*h-1),f=W.lerp(1,1-Math.pow(1-Math.random(),Math.PI),n)*i,p=t.x+-f*Math.sin(u)*Math.cos(d),g=t.y+f*Math.sin(u)*Math.sin(d),y=t.z;l.x=p*this.scale.x,l.y=g*this.scale.y,l.z=y*this.scale.z}};let ze=Kl;a(ze,"_randomQuat",new H),a(ze,"_tempVec",new x);R([m()],ze.prototype,"shapeType",void 0);R([m()],ze.prototype,"enabled",void 0);R([m()],ze.prototype,"alignToDirection",void 0);R([m()],ze.prototype,"angle",void 0);R([m()],ze.prototype,"arc",void 0);R([m()],ze.prototype,"arcSpread",void 0);R([m()],ze.prototype,"arcSpeedMultiplier",void 0);R([m()],ze.prototype,"arcMode",void 0);R([m(x)],ze.prototype,"boxThickness",void 0);R([m(x)],ze.prototype,"position",void 0);R([m(x)],ze.prototype,"rotation",void 0);R([m(x)],ze.prototype,"scale",void 0);R([m()],ze.prototype,"radius",void 0);R([m()],ze.prototype,"radiusThickness",void 0);R([m()],ze.prototype,"sphericalDirectionAmount",void 0);R([m()],ze.prototype,"randomDirectionAmount",void 0);R([m()],ze.prototype,"randomPositionAmount",void 0);R([m()],ze.prototype,"meshShapeType",void 0);R([m(Jp)],ze.prototype,"meshRenderer",void 0);class Ie{constructor(){a(this,"damping");a(this,"enabled");a(this,"frequency");a(this,"octaveCount");a(this,"octaveMultiplier");a(this,"octaveScale");a(this,"positionAmount");a(this,"quality");a(this,"remap");a(this,"remapEnabled");a(this,"remapMultiplier");a(this,"remapX");a(this,"remapXMultiplier");a(this,"remapY");a(this,"remapYMultiplier");a(this,"remapZ");a(this,"remapZMultiplier");a(this,"scrollSpeedMultiplier");a(this,"separateAxes");a(this,"strengthMultiplier");a(this,"strengthX");a(this,"strengthXMultiplier");a(this,"strengthY");a(this,"strengthYMultiplier");a(this,"strengthZ");a(this,"strengthZMultiplier");a(this,"_noise");a(this,"_time",0);a(this,"_temp",new x)}update(t){this._time+=t.time.deltaTime*this.scrollSpeedMultiplier}apply(t,e,i,n,o,r){if(!this.enabled)return;this._noise||(this._noise=q2(()=>0));const l=this._temp.set(e.x,e.y,e.z).multiplyScalar(this.frequency),c=this._noise(l.x,l.y,l.z,this._time),h=this._noise(l.x,l.y,l.z,this._time+1e3*this.frequency),d=this._noise(l.x,l.y,l.z,this._time+2e3*this.frequency);this._temp.set(c,h,d).normalize();const u=o/r;let f=this.positionAmount.evaluate(u);this.separateAxes?(this._temp.x*=f*this.strengthXMultiplier,this._temp.y*=f*this.strengthYMultiplier,this._temp.z*=f*this.strengthZMultiplier):(this.strengthX&&(f*=this.strengthX.evaluate(u)*1.5),this._temp.multiplyScalar(f)),i.x+=this._temp.x,i.y+=this._temp.y,i.z+=this._temp.z}}R([m()],Ie.prototype,"damping",void 0);R([m()],Ie.prototype,"enabled",void 0);R([m()],Ie.prototype,"frequency",void 0);R([m()],Ie.prototype,"octaveCount",void 0);R([m()],Ie.prototype,"octaveMultiplier",void 0);R([m()],Ie.prototype,"octaveScale",void 0);R([m(X)],Ie.prototype,"positionAmount",void 0);R([m()],Ie.prototype,"quality",void 0);R([m(X)],Ie.prototype,"remap",void 0);R([m()],Ie.prototype,"remapEnabled",void 0);R([m()],Ie.prototype,"remapMultiplier",void 0);R([m(X)],Ie.prototype,"remapX",void 0);R([m()],Ie.prototype,"remapXMultiplier",void 0);R([m(X)],Ie.prototype,"remapY",void 0);R([m()],Ie.prototype,"remapYMultiplier",void 0);R([m(X)],Ie.prototype,"remapZ",void 0);R([m()],Ie.prototype,"remapZMultiplier",void 0);R([m()],Ie.prototype,"scrollSpeedMultiplier",void 0);R([m()],Ie.prototype,"separateAxes",void 0);R([m()],Ie.prototype,"strengthMultiplier",void 0);R([m(X)],Ie.prototype,"strengthX",void 0);R([m()],Ie.prototype,"strengthXMultiplier",void 0);R([m(X)],Ie.prototype,"strengthY",void 0);R([m()],Ie.prototype,"strengthYMultiplier",void 0);R([m(X)],Ie.prototype,"strengthZ",void 0);R([m()],Ie.prototype,"strengthZMultiplier",void 0);var c_;(function(s){s[s.PerParticle=0]="PerParticle",s[s.Ribbon=1]="Ribbon"})(c_||(c_={}));var h_;(function(s){s[s.Stretch=0]="Stretch",s[s.Tile=1]="Tile",s[s.DistributePerSegment=2]="DistributePerSegment",s[s.RepeatPerSegment=3]="RepeatPerSegment"})(h_||(h_={}));class st{constructor(){a(this,"enabled");a(this,"attachRibbonToTransform",!1);a(this,"colorOverLifetime");a(this,"colorOverTrail");a(this,"dieWithParticles",!0);a(this,"inheritParticleColor",!0);a(this,"lifetime");a(this,"lifetimeMultiplier");a(this,"minVertexDistance",.2);a(this,"mode",c_.PerParticle);a(this,"ratio",1);a(this,"ribbonCount",1);a(this,"shadowBias",0);a(this,"sizeAffectsLifetime",!1);a(this,"sizeAffectsWidth",!1);a(this,"splitSubEmitterRibbons",!1);a(this,"textureMode",h_.Stretch);a(this,"widthOverTrail");a(this,"widthOverTrailMultiplier");a(this,"worldSpace",!1)}getWidth(t,e,i,n){const o=this.widthOverTrail.evaluate(i,n);return t*=o,t}getColor(t,e,i){const n=this.colorOverTrail.evaluate(i),o=this.colorOverLifetime.evaluate(e);t.x*=n.r*o.r,t.y*=n.g*o.g,t.z*=n.b*o.b,"alpha"in n&&"alpha"in o&&(t.w*=n.alpha*o.alpha)}}R([m()],st.prototype,"enabled",void 0);R([m()],st.prototype,"attachRibbonToTransform",void 0);R([m(Lt)],st.prototype,"colorOverLifetime",void 0);R([m(Lt)],st.prototype,"colorOverTrail",void 0);R([m()],st.prototype,"dieWithParticles",void 0);R([m()],st.prototype,"inheritParticleColor",void 0);R([m(X)],st.prototype,"lifetime",void 0);R([m()],st.prototype,"lifetimeMultiplier",void 0);R([m()],st.prototype,"minVertexDistance",void 0);R([m()],st.prototype,"mode",void 0);R([m()],st.prototype,"ratio",void 0);R([m()],st.prototype,"ribbonCount",void 0);R([m()],st.prototype,"shadowBias",void 0);R([m()],st.prototype,"sizeAffectsLifetime",void 0);R([m()],st.prototype,"sizeAffectsWidth",void 0);R([m()],st.prototype,"splitSubEmitterRibbons",void 0);R([m()],st.prototype,"textureMode",void 0);R([m(X)],st.prototype,"widthOverTrail",void 0);R([m()],st.prototype,"widthOverTrailMultiplier",void 0);R([m()],st.prototype,"worldSpace",void 0);class at{constructor(){a(this,"enabled");a(this,"space",ss.Local);a(this,"orbitalX");a(this,"orbitalY");a(this,"orbitalZ");a(this,"orbitalXMultiplier");a(this,"orbitalYMultiplier");a(this,"orbitalZMultiplier");a(this,"orbitalOffsetX");a(this,"orbitalOffsetY");a(this,"orbitalOffsetZ");a(this,"speedModifier");a(this,"speedModifierMultiplier");a(this,"x");a(this,"xMultiplier");a(this,"y");a(this,"yMultiplier");a(this,"z");a(this,"zMultiplier");a(this,"_system");a(this,"_temp",new x);a(this,"_temp2",new x);a(this,"_temp3",new x);a(this,"_hasOrbital",!1);a(this,"_index",0);a(this,"_orbitalMatrix",new le)}update(t){this._system=t}init(t){this._index==0&&(t.debug=!0),this._index+=1,t.orbitx=this.orbitalX.evaluate(Math.random()),t.orbity=this.orbitalY.evaluate(Math.random()),t.orbitz=this.orbitalZ.evaluate(Math.random()),this._hasOrbital=t.orbitx!=0||t.orbity!=0||t.orbitz!=0}apply(t,e,i,n,o,r,l){var p;if(!this.enabled)return;const c=r/l,h=this.speedModifier.evaluate(c)*this.speedModifierMultiplier,d=this.x.evaluate(c),u=this.y.evaluate(c),f=this.z.evaluate(c);if(this._temp.set(-d,u,f),this._system&&this._system.main.simulationSpace===ss.World&&this._temp.applyQuaternion(this._system.worldQuaternion),this._hasOrbital&&((p=this._system)==null?void 0:p.worldPos)){const y=this._temp2.set(i.x,i.y,i.z),b=this.orbitalXMultiplier,_=this.orbitalYMultiplier,v=this.orbitalZMultiplier,S=h*Math.PI*2*10,T=Math.cos(S*b),O=Math.sin(S*b),M=Math.cos(S*_),k=Math.sin(S*_),B=Math.cos(S*v),I=Math.sin(S*v),E=y.x*(M*B)+y.y*(M*I)+y.z*-k,L=y.x*(O*k*B-T*I)+y.y*(O*k*I+T*B)+y.z*(O*M),V=y.x*(T*k*B+O*I)+y.y*(T*k*I-O*B)+y.z*(T*M),A=this._temp3.set(y.x-E,y.y-L,y.z-V);A.normalize(),A.multiplyScalar(.2/o*Math.max(this.orbitalXMultiplier,this.orbitalYMultiplier,this.orbitalZMultiplier)),n.x+=A.x,n.y+=A.y,n.z+=A.z}n.x+=this._temp.x,n.y+=this._temp.y,n.z+=this._temp.z,n.x*=h,n.y*=h,n.z*=h}}R([m()],at.prototype,"enabled",void 0);R([m()],at.prototype,"space",void 0);R([m(X)],at.prototype,"orbitalX",void 0);R([m(X)],at.prototype,"orbitalY",void 0);R([m(X)],at.prototype,"orbitalZ",void 0);R([m()],at.prototype,"orbitalXMultiplier",void 0);R([m()],at.prototype,"orbitalYMultiplier",void 0);R([m()],at.prototype,"orbitalZMultiplier",void 0);R([m()],at.prototype,"orbitalOffsetX",void 0);R([m()],at.prototype,"orbitalOffsetY",void 0);R([m()],at.prototype,"orbitalOffsetZ",void 0);R([m(X)],at.prototype,"speedModifier",void 0);R([m()],at.prototype,"speedModifierMultiplier",void 0);R([m(X)],at.prototype,"x",void 0);R([m()],at.prototype,"xMultiplier",void 0);R([m(X)],at.prototype,"y",void 0);R([m()],at.prototype,"yMultiplier",void 0);R([m(X)],at.prototype,"z",void 0);R([m()],at.prototype,"zMultiplier",void 0);var d_;(function(s){s[s.Lifetime=0]="Lifetime",s[s.Speed=1]="Speed",s[s.FPS=2]="FPS"})(d_||(d_={}));var Ex;(function(s){s[s.Grid=0]="Grid",s[s.Sprites=1]="Sprites"})(Ex||(Ex={}));var Mx;(function(s){s[s.Custom=0]="Custom",s[s.Random=1]="Random",s[s.MeshIndex=2]="MeshIndex"})(Mx||(Mx={}));var Ax;(function(s){s[s.WholeSheet=0]="WholeSheet",s[s.SingleRow=1]="SingleRow"})(Ax||(Ax={}));class yi{constructor(){a(this,"animation");a(this,"enabled");a(this,"cycleCount");a(this,"frameOverTime");a(this,"frameOverTimeMultiplier");a(this,"numTilesX");a(this,"numTilesY");a(this,"startFrame");a(this,"startFrameMultiplier");a(this,"rowMode");a(this,"rowIndex");a(this,"spriteCount");a(this,"timeMode")}sampleOnceAtStart(){if(this.timeMode===d_.Lifetime)switch(this.frameOverTime.mode){case ft.Constant:case ft.TwoConstants:case ft.TwoCurves:case ft.Curve:return!0}return!1}getStartIndex(){return this.sampleOnceAtStart()?Math.random()*(this.numTilesX*this.numTilesY):0}evaluate(t){if(!this.sampleOnceAtStart())return this.getIndex(t)}getIndex(t){const e=this.numTilesX*this.numTilesY;t=t*this.cycleCount;let i=this.frameOverTime.evaluate(t%1);return i*=this.frameOverTimeMultiplier,i*=e,i=i%e,i=Math.floor(i),i}}R([m()],yi.prototype,"animation",void 0);R([m()],yi.prototype,"enabled",void 0);R([m()],yi.prototype,"cycleCount",void 0);R([m(X)],yi.prototype,"frameOverTime",void 0);R([m()],yi.prototype,"frameOverTimeMultiplier",void 0);R([m()],yi.prototype,"numTilesX",void 0);R([m()],yi.prototype,"numTilesY",void 0);R([m(X)],yi.prototype,"startFrame",void 0);R([m()],yi.prototype,"startFrameMultiplier",void 0);R([m()],yi.prototype,"rowMode",void 0);R([m()],yi.prototype,"rowIndex",void 0);R([m()],yi.prototype,"spriteCount",void 0);R([m()],yi.prototype,"timeMode",void 0);class hs{constructor(){a(this,"enabled");a(this,"separateAxes");a(this,"x");a(this,"xMultiplier");a(this,"y");a(this,"yMultiplier");a(this,"z");a(this,"zMultiplier")}evaluate(t,e){return this.enabled?this.separateAxes?0:this.z.evaluate(t,e)*-1:0}}R([m()],hs.prototype,"enabled",void 0);R([m()],hs.prototype,"separateAxes",void 0);R([m(X)],hs.prototype,"x",void 0);R([m()],hs.prototype,"xMultiplier",void 0);R([m(X)],hs.prototype,"y",void 0);R([m()],hs.prototype,"yMultiplier",void 0);R([m(X)],hs.prototype,"z",void 0);R([m()],hs.prototype,"zMultiplier",void 0);class zn{constructor(){a(this,"enabled");a(this,"range");a(this,"separateAxes");a(this,"x");a(this,"xMultiplier");a(this,"y");a(this,"yMultiplier");a(this,"z");a(this,"zMultiplier")}evaluate(t,e){if(!this.enabled)return 0;if(!this.separateAxes){const i=W.lerp(this.range.x,this.range.y,e);return this.z.evaluate(i)*-1}return 0}}R([m()],zn.prototype,"enabled",void 0);R([m()],zn.prototype,"range",void 0);R([m()],zn.prototype,"separateAxes",void 0);R([m(X)],zn.prototype,"x",void 0);R([m()],zn.prototype,"xMultiplier",void 0);R([m(X)],zn.prototype,"y",void 0);R([m()],zn.prototype,"yMultiplier",void 0);R([m(X)],zn.prototype,"z",void 0);R([m()],zn.prototype,"zMultiplier",void 0);class Pt{constructor(){a(this,"enabled");a(this,"dampen");a(this,"drag");a(this,"dragMultiplier");a(this,"limit");a(this,"limitMultiplier");a(this,"separateAxes");a(this,"limitX");a(this,"limitXMultiplier");a(this,"limitY");a(this,"limitYMultiplier");a(this,"limitZ");a(this,"limitZMultiplier");a(this,"multiplyDragByParticleSize",!1);a(this,"multiplyDragByParticleVelocity",!1);a(this,"space");a(this,"_temp",new x);a(this,"_temp2",new x)}apply(t,e,i,n,o,r,l){if(this.enabled){const c=this.limit.evaluate(o)*this.limitMultiplier;if(e.length()>c){this._temp.copy(e).normalize().multiplyScalar(c);const d=this.dampen*.5;e.x=W.lerp(e.x,this._temp.x,d),e.y=W.lerp(e.y,this._temp.y,d),e.z=W.lerp(e.z,this._temp.z,d),i.x=W.lerp(i.x,this._temp.x,d),i.y=W.lerp(i.y,this._temp.y,d),i.z=W.lerp(i.z,this._temp.z,d)}}}}R([m()],Pt.prototype,"enabled",void 0);R([m()],Pt.prototype,"dampen",void 0);R([m(X)],Pt.prototype,"drag",void 0);R([m()],Pt.prototype,"dragMultiplier",void 0);R([m(X)],Pt.prototype,"limit",void 0);R([m()],Pt.prototype,"limitMultiplier",void 0);R([m()],Pt.prototype,"separateAxes",void 0);R([m(X)],Pt.prototype,"limitX",void 0);R([m()],Pt.prototype,"limitXMultiplier",void 0);R([m(X)],Pt.prototype,"limitY",void 0);R([m()],Pt.prototype,"limitYMultiplier",void 0);R([m(X)],Pt.prototype,"limitZ",void 0);R([m()],Pt.prototype,"limitZMultiplier",void 0);R([m()],Pt.prototype,"multiplyDragByParticleSize",void 0);R([m()],Pt.prototype,"multiplyDragByParticleVelocity",void 0);R([m()],Pt.prototype,"space",void 0);var Zf;(function(s){s[s.Initial=0]="Initial",s[s.Current=1]="Current"})(Zf||(Zf={}));class tr{constructor(){a(this,"enabled");a(this,"curve");a(this,"curveMultiplier");a(this,"mode");a(this,"system");a(this,"_temp",new x);a(this,"_firstUpdate",!0);a(this,"_frames",0)}clone(){var e;const t=new tr;return t.enabled=this.enabled,t.curve=(e=this.curve)==null?void 0:e.clone(),t.curveMultiplier=this.curveMultiplier,t.mode=this.mode,t}get _lastWorldPosition(){return this.system._iv_lastWorldPosition||(this.system._iv_lastWorldPosition=new x),this.system._iv_lastWorldPosition}get _velocity(){return this.system._iv_velocity||(this.system._iv_velocity=new x),this.system._iv_velocity}awake(t){this.system=t,this.reset()}reset(){this._firstUpdate=!0}update(t){this.enabled&&this.system.worldspace!==!1&&(this._firstUpdate?(this._firstUpdate=!1,this._velocity.set(0,0,0),this._lastWorldPosition.copy(this.system.worldPos)):this._lastWorldPosition&&(this._velocity.copy(this.system.worldPos).sub(this._lastWorldPosition).multiplyScalar(1/this.system.deltaTime),this._lastWorldPosition.copy(this.system.worldPos)))}applyInitial(t){if(this.enabled&&this.system.worldspace!==!1&&this.mode===Zf.Initial){const e=this.curve.evaluate(Math.random(),Math.random());this._temp.copy(this._velocity).multiplyScalar(e),t.x+=this._temp.x,t.y+=this._temp.y,t.z+=this._temp.z}}applyCurrent(t,e,i){if(this.enabled&&this.system&&this.system.worldspace!==!1&&this.mode===Zf.Current){const n=this.curve.evaluate(e,i);this._temp.copy(this._velocity).multiplyScalar(n),t.x+=this._temp.x,t.y+=this._temp.y,t.z+=this._temp.z}}}R([m()],tr.prototype,"enabled",void 0);R([m(X)],tr.prototype,"curve",void 0);R([m()],tr.prototype,"curveMultiplier",void 0);R([m()],tr.prototype,"mode",void 0);class Qi{constructor(){a(this,"enabled");a(this,"range");a(this,"separateAxes");a(this,"size");a(this,"sizeMultiplier");a(this,"x");a(this,"xMultiplier");a(this,"y");a(this,"yMultiplier");a(this,"z");a(this,"zMultiplier")}evaluate(t,e,i,n){const o=t.length(),r=W.remap(o,this.range.x,this.range.y,0,1),l=this.size.evaluate(r,i);return n.x*=l,n.y*=l,n.z*=l,n}}R([m()],Qi.prototype,"enabled",void 0);R([m(ce)],Qi.prototype,"range",void 0);R([m()],Qi.prototype,"separateAxes",void 0);R([m(X)],Qi.prototype,"size",void 0);R([m()],Qi.prototype,"sizeMultiplier",void 0);R([m(X)],Qi.prototype,"x",void 0);R([m()],Qi.prototype,"xMultiplier",void 0);R([m(X)],Qi.prototype,"y",void 0);R([m()],Qi.prototype,"yMultiplier",void 0);R([m(X)],Qi.prototype,"z",void 0);R([m()],Qi.prototype,"zMultiplier",void 0);class Vc{constructor(){a(this,"enabled");a(this,"range");a(this,"color")}evaluate(t,e,i){const n=t.length(),o=W.remap(n,this.range.x,this.range.y,0,1),r=this.color.evaluate(o,e);i.x*=r.r,i.y*=r.g,i.z*=r.b,"alpha"in r&&(i.w*=r.alpha)}}R([m()],Vc.prototype,"enabled",void 0);R([m(ce)],Vc.prototype,"range",void 0);R([m(Lt)],Vc.prototype,"color",void 0);new x(1,1,1);new x(0,0,1);class Ab{constructor(t,e,i,n){a(this,"system");a(this,"particleSystem");a(this,"subSystem");a(this,"subParticleSystem");a(this,"type","NeedleParticleSubEmitter");a(this,"emitterType");a(this,"emitterProbability");a(this,"q_",new H);a(this,"v_",new x);a(this,"v2_",new x);a(this,"_emitterMatrix",new Wm);a(this,"_circularBuffer");this.system=t,this.particleSystem=e,this.subSystem=i,this.subParticleSystem=n,this.subParticleSystem&&this.subParticleSystem&&(this.subParticleSystem.onlyUsedByOther=!0);const o=1e3;this._circularBuffer=new Dn(()=>new Wm,o)}clone(){throw new Error("Method not implemented.")}initialize(t){t.emissionState={burstIndex:0,burstWaveIndex:0,time:0,waitEmiting:0},this._emitterMatrix.copy(this.subSystem.matrixWorld).invert().premultiply(this.system.matrixWorld),this._emitterMatrix.setPosition(0,0,0),this.emitterType===ep.Birth&&this.run(t)}update(t,e){this.run(t)}frameUpdate(t){}toJSON(){}reset(){}run(t){if(this.subSystem.currentParticles>=this.subSystem.main.maxParticles||!this.subParticleSystem||!t.emissionState||this.emitterProbability&&Math.random()>this.emitterProbability)return;const e=this.system.deltaTime;if(this.emitterType===ep.Death){let n=t.life;if(t[Nl]!==void 0&&(n=t[Nl]),!(t.age+e*1.2>=n))return;const r=this.subSystem.main.maxParticles-this.subSystem.currentParticles;t.emissionState.waitEmiting=r}const i=new Wm;i.set(1,0,0,t.position.x,0,1,0,t.position.y,0,0,1,t.position.z,0,0,0,1),this.particleSystem.worldSpace||i.multiplyMatrices(this._emitterMatrix,i),this.subParticleSystem.emit(e,t.emissionState,i)}}var ot=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const _r=C("debugparticles"),Q2=C("noprogressive"),Y2=C("debugprogressive");var ep;(function(s){s[s.Birth=0]="Birth",s[s.Collision=1]="Collision",s[s.Death=2]="Death",s[s.Trigger=3]="Trigger",s[s.Manual=4]="Manual"})(ep||(ep={}));class ds extends j{constructor(){super(...arguments);a(this,"renderMode");a(this,"particleMaterial");a(this,"trailMaterial");a(this,"particleMesh");a(this,"maxParticleSize");a(this,"minParticleSize");a(this,"velocityScale");a(this,"cameraVelocityScale");a(this,"lengthScale")}start(){if(this.maxParticleSize!==.5&&this.minParticleSize!==0&&U()){const e=`ParticleSystem "${this.name}" has non-default min/max particle size. This may not render correctly. Please set min size to 0 and the max size to 0.5 and use the "StartSize" setting instead`;console.warn(e)}}get transparent(){var i;return((i=this.particleMaterial)==null?void 0:i.transparent)??!1}getMaterial(e=!1){let i=e===!0&&this.trailMaterial?this.trailMaterial:this.particleMaterial;if(i){if(i.type==="MeshStandardMaterial"){_r&&console.debug("ParticleSystemRenderer.getMaterial: MeshStandardMaterial detected, converting to MeshBasicMaterial. See https://github.com/Alchemist0823/three.quarks/issues/101"),"map"in i&&i.map&&(i.map.colorSpace=Wa,i.map.premultiplyAlpha=!1);const n=new Ue;n.copy(i),e?this.trailMaterial=n:this.particleMaterial=n}i.map&&(i.map.colorSpace=Wa,i.map.premultiplyAlpha=!1),e&&i.side===Wr&&(i=i.clone(),i.side=O_,e?this.trailMaterial=i:this.particleMaterial=i)}return i&&!Q2&&i._didRequestTextureLOD===void 0&&(i._didRequestTextureLOD=0,Y2&&console.log("Load material LOD",i.name),mt.assignTextureLOD(i,0)),i}getMesh(e){let i=null;if(!i&&(this.particleMesh instanceof Z&&(i=this.particleMesh.geometry),i===null)){i=new Ys(1,1);const o=i.attributes.uv;for(let r=0;r<o.count;r++)o.setX(r,1-o.getX(r))}return new Z(i,this.getMaterial())}}ot([m()],ds.prototype,"renderMode",void 0);ot([m(De)],ds.prototype,"particleMaterial",void 0);ot([m(De)],ds.prototype,"trailMaterial",void 0);ot([m()],ds.prototype,"maxParticleSize",void 0);ot([m()],ds.prototype,"minParticleSize",void 0);ot([m()],ds.prototype,"velocityScale",void 0);ot([m()],ds.prototype,"cameraVelocityScale",void 0);ot([m()],ds.prototype,"lengthScale",void 0);class Vu{constructor(t,e=1){a(this,"_curve");a(this,"_factor");a(this,"type","function");this._curve=t,this._factor=e}startGen(t){}genValue(t,e){return this._curve.evaluate(e,Math.random())*this._factor}toJSON(){throw new Error("Method not implemented.")}clone(){throw new Error("Method not implemented.")}}class Ib{constructor(t){a(this,"type","value");a(this,"system");this.system=t}toJSON(){throw new Error("Method not implemented.")}clone(){throw new Error("Method not implemented.")}startGen(t){}}class K2 extends Ib{genValue(){return this.system.textureSheetAnimation.getStartIndex()}}class J2 extends Ib{constructor(){super(...arguments);a(this,"_lastPosition",new x);a(this,"_lastDistance",0)}update(){const e=ae(this.system.gameObject);this._lastDistance=this._lastPosition.distanceTo(e),this._lastPosition.copy(e)}genValue(){if(!this.system.isPlaying||!this.system.emission.enabled||this.system.currentParticles>=this.system.maxParticles)return 0;let e=this.system.emission.rateOverTime.evaluate(this.system.time/this.system.duration,Math.random());if(this.system.deltaTime>0){const o=this.system.emission.rateOverDistance.evaluate(this.system.time/this.system.duration,Math.random());let l=this._lastDistance/this.system.deltaTime*o;Number.isFinite(l)||(l=0),e+=l}const i=this.system.emission.getBurst();i>0&&(e+=i/this.system.deltaTime);const n=this.system.maxParticles-this.system.currentParticles;return W.clamp(e,0,n/this.system.deltaTime)}}class Z2 extends Ib{genValue(){return this.system.isPlaying,0}}class ul{constructor(t){a(this,"system");a(this,"type");this.type=Object.getPrototypeOf(this).constructor.name||"ParticleSystemBaseBehaviour",t&&(this.system=t)}get context(){return this.system.context}initialize(t){}update(t,e){}frameUpdate(t){}toJSON(){throw new Error("Method not implemented.")}clone(){throw new Error("Method not implemented.")}reset(){}}class eI extends ul{constructor(){super(...arguments);a(this,"type","NeedleTextureSheet")}update(e,i){const n=this.system.textureSheetAnimation;if(n.enabled){const o=e.age/e.life,r=n.evaluate(o);r!==void 0&&(e.uvTile=r)}}}const Ix=Symbol("particleRotation");class tI extends ul{constructor(){super(...arguments);a(this,"type","NeedleRotation")}initialize(e){e[Ix]=Math.random()}update(e,i){if(e.rotation===void 0)return;const n=e.age/e.life;if(typeof e.rotation=="number"&&(this.system.rotationOverLifetime.enabled?e.rotation+=this.system.rotationOverLifetime.evaluate(n,e[Ix])*i:this.system.renderer.renderMode===Ms.Billboard&&(e.rotation=Math.PI),this.system.rotationBySpeed.enabled)){const o=e.velocity.length();e.rotation+=this.system.rotationBySpeed.evaluate(n,o)*i}}}const Dx=Symbol("sizeLerpFactor"),iI=new x;class nI extends ul{constructor(){super(...arguments);a(this,"type","NeedleSize");a(this,"_minSize",0);a(this,"_maxSize",1)}initialize(e){e[Dx]=Math.random(),this._minSize=this.system.renderer.minParticleSize,this._maxSize=this.system.renderer.maxParticleSize}update(e,i){const n=e.age/e.life;let o=1;this.system.sizeOverLifetime.enabled&&(o*=this.system.sizeOverLifetime.evaluate(n,void 0,e[Dx]).x);let r=1;this.system.renderer.renderMode!==Ms.Mesh&&(r=this.system.worldScale.x/this.system.cameraScale);const l=Q(e.startSize).multiplyScalar(o*r);if(e.size.set(l.x,l.y,l.z),this.system.localspace){const c=D1(this.system,iI);e.size.x*=c.x,e.size.y*=c.y,e.size.z*=c.z}}}const Nl=Symbol("particleLife"),Wg=Symbol("trailLifetime"),Lx=Symbol("trailStartLength"),Vg=Symbol("trailWidthRandom");class sI extends ul{constructor(){super(...arguments);a(this,"type","NeedleTrail")}initialize(e){e instanceof d0&&(e[Nl]=e.life,this.system.trails.enabled&&this.system.trails.dieWithParticles===!1&&(e[Wg]=this.system.trails.lifetime.evaluate(Math.random(),Math.random()),e.life+=e[Wg]),e[Lx]=e.length,e[Vg]=Math.random())}update(e){var i;if((i=this.system.trails)!=null&&i.enabled&&e instanceof d0){const n=e,o=e.age/e[Nl],r=e.previous.values(),l=e.previous.length;for(let c=0;c<l;c++){const d=r.next().value,u=1-c/(l-1),f=e.size;if(f.x<=0&&!this.system.trails.sizeAffectsWidth){const p=20*this.system.trails.widthOverTrail.evaluate(.5,n[Vg]);f.x=p,f.y=p,f.z=p}d.size=this.system.trails.getWidth(f.x,o,u,n[Vg]),d.color.copy(e.color),this.system.trails.getColor(d.color,o,u)}if(e.age>e[Nl]){e.velocity.set(0,0,0);const c=(e.age-e[Nl])/e[Wg];n.length=W.lerp(e[Lx],0,c)}}}}const Hu=Symbol("startVelocity"),jx=Symbol("gravityModifier"),Hg=Symbol("gravitySpeed"),Gu=Symbol("velocity lerp factor"),u_=new x;class oI extends ul{constructor(){super(...arguments);a(this,"type","NeedleVelocity");a(this,"_gravityDirection",new x)}initialize(e){var r,l;const i=this.system.main.simulationSpeed;e.startSpeed=this.system.main.startSpeed.evaluate(Math.random(),Math.random());const n=this.system.shape.getDirection(e,e.position);e.velocity.x=n.x*e.startSpeed,e.velocity.y=n.y*e.startSpeed,e.velocity.z=n.z*e.startSpeed,(r=this.system.inheritVelocity)!=null&&r.enabled&&this.system.inheritVelocity.applyInitial(e.velocity),e[Hu]?e[Hu].copy(e.velocity):e[Hu]=e.velocity.clone();const o=this.system.main.gravityModifier.evaluate(Math.random(),Math.random());e[jx]=o*i,e[Hg]=o*i*.5,e[Gu]=Math.random(),(l=this.system.velocityOverLifetime)==null||l.init(e),this._gravityDirection.set(0,-1,0),this.system.main.simulationSpace===ss.Local&&this._gravityDirection.applyQuaternion(this.system.worldQuaternionInverted).normalize()}update(e,i){var f;const n=e[Hu],o=e[jx];if(o!==0){const p=o*e[Hg];u_.copy(this._gravityDirection).multiplyScalar(p),e[Hg]+=i*.05,n.add(u_)}e.velocity.copy(n);const r=e.age/e.life;(f=this.system.inheritVelocity)!=null&&f.enabled&&this.system.inheritVelocity.applyCurrent(e.velocity,r,e[Gu]);const l=this.system.noise;l.enabled&&l.apply(0,e.position,e.velocity,i,e.age,e.life);const c=this.system.sizeBySpeed;c!=null&&c.enabled&&(e.size=c.evaluate(e.velocity,r,e[Gu],e.size));const h=this.system.colorBySpeed;h!=null&&h.enabled&&h.evaluate(e.velocity,e[Gu],e.color);const d=this.system.velocityOverLifetime;d.enabled&&d.apply(e,0,e.position,e.velocity,i,e.age,e.life);const u=this.system.limitVelocityOverLifetime;if(u.enabled&&u.apply(e.position,n,e.velocity,e.size,r,i,1),this.system.worldspace){const p=this.system.worldScale;e.velocity.x*=p.x,e.velocity.y*=p.y,e.velocity.z*=p.z}}}const Bx=Symbol("colorLerpFactor"),Fx=new Ae(1,1,1,1),ua=new Ae(1,1,1,1);class rI extends ul{constructor(){super(...arguments);a(this,"type","NeedleColor")}initialize(e){}_init(e){const i=this.system.renderer.particleMaterial;ua.copy(this.system.main.startColor.evaluate(Math.random())),i!=null&&i.color&&(Fx.copy(i.color),ua.multiply(Fx)),ua.convertLinearToSRGB(),e.startColor.set(ua.r,ua.g,ua.b,ua.alpha),e.color.copy(e.startColor),e[Bx]=Math.random()}update(e,i){if(e.age===0&&this._init(e),this.system.colorOverLifetime.enabled){const n=e.age/e.life,o=this.system.colorOverLifetime.color.evaluate(n,e[Bx]);e.color.set(o.r,o.g,o.b,"alpha"in o?o.alpha:1).multiply(e.startColor)}else e.color.copy(e.startColor)}}class aI{constructor(t){a(this,"system");a(this,"emission");a(this,"autoDestroy");a(this,"startLength");a(this,"emissionBursts");a(this,"onlyUsedByOther");a(this,"behaviors",[]);a(this,"rendererEmitterSettings",{startLength:new aO(220),followLocalOrigin:!1});a(this,"flatWhiteTexture");a(this,"clonedTexture",{original:void 0,clone:void 0});this.system=t,this.emission=new J2(this.system)}get anim(){return this.system.textureSheetAnimation}get prewarm(){return!1}get material(){return this.system.renderer.getMaterial(this.system.trails.enabled)}get layers(){return this.system.gameObject.layers}update(){this.emission.update()}get looping(){return this.system.main.loop}get duration(){return this.system.duration}get shape(){return this.system.shape}get startLife(){return new Vu(this.system.main.startLifetime)}get startSpeed(){return new Vu(this.system.main.startSpeed)}get startRotation(){return new Vu(this.system.main.startRotation)}get startSize(){return new Vu(this.system.main.startSize)}get startColor(){return new oO(new rO(1,1,1,1))}get emissionOverTime(){return this.emission}get emissionOverDistance(){return new Z2(this.system)}get instancingGeometry(){return this.system.renderer.getMesh(this.system.renderer.renderMode).geometry}get renderMode(){if(this.system.trails.enabled===!0)return co.Trail;switch(this.system.renderer.renderMode){case Ms.Billboard:return co.BillBoard;case Ms.Stretch:return co.StretchedBillBoard;case Ms.HorizontalBillboard:return co.HorizontalBillBoard;case Ms.VerticalBillboard:return co.VerticalBillBoard;case Ms.Mesh:return co.Mesh}return co.BillBoard}get speedFactor(){var e;let t=this.system.main.simulationSpeed;return((e=this.system.renderer)==null?void 0:e.renderMode)===Ms.Stretch&&(t*=this.system.renderer.velocityScale??1),t}get texture(){const t=this.material;if(t&&t.map){const e=t.map;if(this.clonedTexture.original!==e||!this.clonedTexture.clone){const i=e.clone();i.premultiplyAlpha=!1,i.colorSpace=Wa,this.clonedTexture.original=e,this.clonedTexture.clone=i}return this.clonedTexture.clone}return this.flatWhiteTexture||(this.flatWhiteTexture=Z_(new Ae(1,1,1,1),1)),this.flatWhiteTexture}get startTileIndex(){return new K2(this.system)}get uTileCount(){var t;return this.anim.enabled?(t=this.anim)==null?void 0:t.numTilesX:void 0}get vTileCount(){var t;return this.anim.enabled?(t=this.anim)==null?void 0:t.numTilesY:void 0}get renderOrder(){return 1}get blending(){var t;return((t=this.system.renderer.particleMaterial)==null?void 0:t.blending)??bR}get transparent(){return this.system.renderer.transparent}get worldSpace(){return this.system.main.simulationSpace===ss.World}}class lI{constructor(){a(this,"burstParticleIndex",0);a(this,"burstParticleCount",0);a(this,"isBursting",!1);a(this,"travelDistance",0);a(this,"previousWorldPos");a(this,"burstIndex",0);a(this,"burstWaveIndex",0);a(this,"time",0);a(this,"waitEmiting",0)}}class it extends j{constructor(){super(...arguments);a(this,"_state");a(this,"colorOverLifetime");a(this,"main");a(this,"emission");a(this,"sizeOverLifetime");a(this,"shape");a(this,"noise");a(this,"trails");a(this,"velocityOverLifetime");a(this,"limitVelocityOverLifetime");a(this,"inheritVelocity");a(this,"colorBySpeed");a(this,"textureSheetAnimation");a(this,"rotationOverLifetime");a(this,"rotationBySpeed");a(this,"sizeBySpeed");a(this,"_cameraScale",1);a(this,"__worldQuaternion",new H);a(this,"_worldQuaternionInverted",new H);a(this,"_worldScale",new x);a(this,"_worldPositionFrame",-1);a(this,"_worldPos",new x);a(this,"_renderer");a(this,"_batchSystem");a(this,"_particleSystem");a(this,"_interface");a(this,"_container");a(this,"_time",0);a(this,"_isPlaying",!0);a(this,"_isUsedAsSubsystem",!1);a(this,"_didPreWarm",!1);a(this,"_bursts");a(this,"_subEmitterSystems");a(this,"_lastBatchesCount",-1)}play(e=!1){var i;e&&P.foreachComponent(this.gameObject,n=>{n instanceof it&&n!==this&&n.play(!1)},!0),this._isPlaying=!0,this._particleSystem&&(this._particleSystem.emissionState.time=0,this._particleSystem.emitEnded=!1),(i=this.emission)==null||i.reset()}pause(e=!0){e&&P.foreachComponent(this.gameObject,i=>{i instanceof it&&i!==this&&i.pause(!1)},!0),this._isPlaying=!1}stop(e=!0,i=!1){e&&P.foreachComponent(this.gameObject,n=>{n instanceof it&&n!==this&&n.stop(!1,i)},!0),this._isPlaying=!1,this._time=0,i&&this.reset()}reset(){var e;this._time=0,this._particleSystem&&(this._particleSystem.particleNum=0,this._particleSystem.emissionState.time=0,this._particleSystem.emitEnded=!1,(e=this.emission)==null||e.reset())}emit(e){if(this._particleSystem){this.onUpdate(),e=Math.min(e,this.maxParticles-this.currentParticles),this._state||(this._state=new lI),this._state.waitEmiting=e,this._state.time=0;const i=this._particleSystem.emitEnded;this._particleSystem.emitEnded=!1,this._particleSystem.emit(this.deltaTime,this._state,this._particleSystem.emitter.matrixWorld),this._particleSystem.emitEnded=i}}get playOnAwake(){return this.main.playOnAwake}set playOnAwake(e){this.main.playOnAwake=e}get renderer(){return this._renderer}get isPlaying(){return this._isPlaying}get currentParticles(){var e;return((e=this._particleSystem)==null?void 0:e.particleNum)??0}get maxParticles(){return this.main.maxParticles}get time(){return this._time}get duration(){return this.main.duration}get deltaTime(){return this.context.time.deltaTime*this.main.simulationSpeed}get scale(){return this.gameObject.scale.x}get cameraScale(){return this._cameraScale}get container(){return this._container}get worldspace(){return this.main.simulationSpace===ss.World}get localspace(){return this.main.simulationSpace===ss.Local}get worldQuaternion(){return this.__worldQuaternion}get worldQuaternionInverted(){return this._worldQuaternionInverted}get worldScale(){return this._worldScale}get worldPos(){return this._worldPositionFrame!==this.context.time.frame&&(this._worldPositionFrame=this.context.time.frame,ae(this.gameObject,this._worldPos)),this._worldPos}get matrixWorld(){return this._container.matrixWorld}get isSubsystem(){return this._isUsedAsSubsystem}addBehaviour(e){return this._particleSystem?(e instanceof ul&&(e.system=this),_r&&console.debug("Add custom ParticleSystem Behaviour",e),this._particleSystem.addBehavior(e),!0):!1}removeBehaviour(e){if(!this._particleSystem)return!1;const i=this._particleSystem.behaviors,n=i.indexOf(e);return n!==-1&&((U()||_r)&&console.debug("Remove custom ParticleSystem Behaviour",n,e),i.splice(n,1)),!0}removeAllBehaviours(){return this._particleSystem?(this._particleSystem.behaviors.length=0,!0):!1}get behaviours(){return this._particleSystem?this._particleSystem.behaviors:null}get particleSystem(){return this._particleSystem??null}set bursts(e){for(let i=0;i<e.length;i++){const n=e[i];if(!(n instanceof Jf)){const o=new Jf;wc(o,n),e[i]=o}}this._bursts=e}set subEmitterSystems(e){for(let i=0;i<e.length;i++){const n=e[i];if(!(n instanceof tp)){const o=new tp;wc(o,n),e[i]=o}}_r&&e.length>0&&console.log("SubEmitters: ",e,this),this._subEmitterSystems=e}onAfterDeserialize(e){if(this._subEmitterSystems&&Array.isArray(this._subEmitterSystems))for(const i of this._subEmitterSystems)i._deserialize(this.context,this.gameObject)}awake(){if(this._worldPositionFrame=-1,this._renderer=this.gameObject.getComponent(ds),!this.main)throw new Error("Not Supported: ParticleSystem needs a serialized MainModule. Creating new particle systems at runtime is currently not supported.");this._container=new F,this._container.matrixAutoUpdate=!1,this.context.scene.add(this._container),this._batchSystem=new nO,this._batchSystem.name=this.gameObject.name,this._container.add(this._batchSystem),this._interface=new aI(this),this._particleSystem=new sO(this._interface),this._particleSystem.addBehavior(new nI(this)),this._particleSystem.addBehavior(new rI(this)),this._particleSystem.addBehavior(new eI(this)),this._particleSystem.addBehavior(new tI(this)),this._particleSystem.addBehavior(new oI(this)),this._particleSystem.addBehavior(new sI(this)),this._batchSystem.addSystem(this._particleSystem);const e=this._particleSystem.emitter;this.context.scene.add(e),this.inheritVelocity.system&&this.inheritVelocity.system!==this&&(this.inheritVelocity=this.inheritVelocity.clone()),this.inheritVelocity.awake(this),_r&&(console.log(this),this.gameObject.add(new ln(1)))}start(){this.addSubParticleSystems(),this.updateLayers(),this.renderer.particleMesh instanceof Z&&this._interface.renderMode==co.Mesh&&mt.assignMeshLOD(this.renderer.particleMesh,0).then(e=>{e&&this.particleSystem&&this._interface.renderMode==co.Mesh&&(this.particleSystem.instancingGeometry=e)})}onDestroy(){var e,i,n,o;(e=this._container)==null||e.removeFromParent(),(i=this._batchSystem)==null||i.removeFromParent(),(n=this._particleSystem)==null||n.emitter.removeFromParent(),(o=this._particleSystem)==null||o.dispose()}onEnable(){this.main&&(this.inheritVelocity&&(this.inheritVelocity.system=this),this._batchSystem&&(this._batchSystem.visible=!0),this.playOnAwake&&this.play(),this._isPlaying=this.playOnAwake)}onDisable(){this._batchSystem&&(this._batchSystem.visible=!1)}onBeforeRender(){var e;this.main&&(this._didPreWarm===!1&&((e=this.main)==null?void 0:e.prewarm)===!0&&(this._didPreWarm=!0,this.preWarm()),this.onUpdate(),this.onSimulate(this.deltaTime))}preWarm(){var d;if(!((d=this.emission)!=null&&d.enabled)||this.emission.rateOverTime.getMax()<=0)return;const i=1/60,n=this.main.duration,o=this.main.startLifetime.getMax(),r=1e3,l=Math.min(Math.max(n,o)/Math.max(.01,this.main.simulationSpeed),r),c=Math.ceil(l/i),h=Date.now();_r&&console.log(`Particles ${this.name} - Prewarm for ${c} frames (${l} sec). Duration: ${n}, Lifetime: ${o}`);for(let u=0;u<c&&!(this.currentParticles>=this.maxParticles);u++){const f=Date.now()-h;if(f>2e3){console.warn(`Particles ${this.name} - Prewarm took too long. Aborting: ${f}`);break}this.onUpdate(),this.onSimulate(i)}}onSimulate(e){if(this._batchSystem){let i=this.context.time.frameCount%60===0;this._lastBatchesCount!==this._batchSystem.batches.length&&(this._lastBatchesCount=this._batchSystem.batches.length,i=!0),i&&this.updateLayers(),this._batchSystem.update(e)}this._time+=e,this._time>this.duration&&(this._time=0)}updateLayers(){if(this._batchSystem)for(let e=0;e<this._batchSystem.batches.length;e++){const i=this._batchSystem.batches[e];i.layers.disableAll();const n=this.layer;i.layers.mask=1<<n}}onUpdate(){var o,r;if(this._bursts&&(this.emission.bursts=this._bursts,delete this._bursts),!this._isPlaying)return;const e=this.context.mainCamera;if(e){const l=pt(e);this._cameraScale=l.x}const i=!this.worldspace,n=this.gameObject;if(Le(n,this.__worldQuaternion),this._worldQuaternionInverted.copy(this.__worldQuaternion).invert(),pt(this.gameObject,this._worldScale),i&&this._container&&((o=this.gameObject)!=null&&o.parent)){const l=D1(this,u_);this._container.matrix.makeScale(l.x,l.y,l.z),this._container.matrix.makeRotationFromQuaternion(this.__worldQuaternion),this._container.matrix.setPosition(this.worldPos),this._container.matrix.scale(this.gameObject.scale)}this.emission.system=this,this._interface.update(),this.shape.onUpdate(this,this.context,this.main.simulationSpace,this.gameObject),this.noise.update(this.context),(r=this.inheritVelocity)==null||r.update(this.context),this.velocityOverLifetime.update(this)}addSubParticleSystems(){var e;if(this._subEmitterSystems&&this._particleSystem)for(const i of this._subEmitterSystems){i.particleSystem&&(i.particleSystem.__internalAwake?i.particleSystem.__internalAwake():U()&&console.warn("SubParticleSystem serialization issue(?)",i.particleSystem,i));const n=(e=i.particleSystem)==null?void 0:e._particleSystem;if(n){i.particleSystem._isUsedAsSubsystem=!0;const o=new Ab(this,this._particleSystem,i.particleSystem,n);o.emitterType=i.type,o.emitterProbability=i.emitProbability,this._particleSystem.addBehavior(o)}else _r&&console.warn("Could not add SubParticleSystem",i,this)}}}ot([m(cm)],it.prototype,"colorOverLifetime",void 0);ot([m(gi)],it.prototype,"main",void 0);ot([m(er)],it.prototype,"emission",void 0);ot([m(dl)],it.prototype,"sizeOverLifetime",void 0);ot([m(ze)],it.prototype,"shape",void 0);ot([m(Ie)],it.prototype,"noise",void 0);ot([m(st)],it.prototype,"trails",void 0);ot([m(at)],it.prototype,"velocityOverLifetime",void 0);ot([m(Pt)],it.prototype,"limitVelocityOverLifetime",void 0);ot([m(tr)],it.prototype,"inheritVelocity",void 0);ot([m(Vc)],it.prototype,"colorBySpeed",void 0);ot([m(yi)],it.prototype,"textureSheetAnimation",void 0);ot([m(hs)],it.prototype,"rotationOverLifetime",void 0);ot([m(zn)],it.prototype,"rotationBySpeed",void 0);ot([m(Qi)],it.prototype,"sizeBySpeed",void 0);class tp{constructor(){a(this,"particleSystem");a(this,"emitProbability",1);a(this,"properties");a(this,"type")}_deserialize(t,e){const i=this.particleSystem;if(i instanceof it)return;let n="";i&&typeof i.guid=="string"&&(n=i.guid,this.particleSystem=P.findByGuid(n,e)),_r&&!(this.particleSystem instanceof it)&&console.warn("Could not find particle system for sub emitter",n,e,this)}}function D1(s,t){if(t.set(1,1,1),s.gameObject.parent&&s.localspace)switch(s.main.scalingMode){case Kf.Local:t=pt(s.gameObject.parent,t),t.x=1/t.x,t.y=1/t.y,t.z=1/t.z;break;default:if(!s.unsupported_scaling_mode){s.unsupported_scaling_mode=!0;const e="ParticleSystem scale mode "+Kf[s.main.scalingMode]+" is not supported";U()&&Me(e),console.warn(e,s.name,s)}t=pt(s.gameObject,t);break}return t}class Ed extends j{constructor(){super(...arguments);a(this,"_didAssignPlayerColor",!1);a(this,"tryAssignColor",()=>{const e=P.getComponentInParent(this.gameObject,Xt);if(e&&e.owner)return this._didAssignPlayerColor=!0,this.assignUserColor(e.owner),!0;const i=P.getComponentInParent(this.gameObject,It);return i!=null&&i.connectionId?(this._didAssignPlayerColor=!0,this.assignUserColor(i.connectionId),!0):!1})}onEnable(){this.context.connection.beginListen(se.JoinedRoom,this.tryAssignColor),this._didAssignPlayerColor||this.startCoroutine(this.waitForConnection())}onDisable(){this.context.connection.stopListen(se.JoinedRoom,this.tryAssignColor)}*waitForConnection(){for(;!this.destroyed&&this.activeAndEnabled&&(yield OC(.2),!this.tryAssignColor()););}assignUserColor(e){const i=Ed.hashCode(e),n=Ed.colorFromHashCode(i);if(this.gameObject.type==="Mesh"){const o=this.gameObject;this.assignColor(n,e,o)}else if(this.gameObject.children)for(const o of this.gameObject.children){const r=o;r.material&&r.material.color&&this.assignColor(n,e,r)}}assignColor(e,i,n){let o=n.material;o&&(o._playerMaterial!==i&&(o=o.clone(),o._playerMaterial=i,n.material=o),o.color=e)}static hashCode(e){var i=0,n,o;if(e.length===0)return i;for(n=0;n<e.length;n++)o=e.charCodeAt(n),i=(i<<5)-i+o,i|=0;return i}static colorFromHashCode(e){const i=(e&16711680)>>16,n=(e&65280)>>8,o=e&255;return new ue(i/255,n/255,o/255)}}const cI=C("debugpost");let f_=null;function hI(s){f_=s}function L1(s){let t=s.gameObject;for(;t;){for(const e of J_(t))if(e.isPostProcessingManager===!0)return e;t=t.parent}return null}function dI(s){let t=L1(s);if(!t)if(f_){cI&&console.warn("Adding postprocessing manager to the scene.");const e=s.scene;t=Mn(e,f_)}else U()&&console.warn("No post processing manager found");return t}var j1=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const uI=C("debugpost");class ${constructor(t){a(this,"isVolumeParameter",!0);a(this,"_isInitialized",!1);a(this,"_active",!0);a(this,"_value");a(this,"_valueRaw");a(this,"_defaultValue");a(this,"valueProcessor");a(this,"onValueChanged");t!==void 0&&this.initialize(t)}get isInitialized(){return this._isInitialized}initialize(t){t!==void 0&&(this._value=t,this._defaultValue=t,this._valueRaw=t,this._isInitialized=!0)}get overrideState(){return this._active}set overrideState(t){if(this._active===t)return;this._active=t;const e=t?this._valueRaw:this._defaultValue;this.processValue(e,!0)}get value(){return this._valueRaw}set value(t){this.isInitialized||this.initialize(t),this.processValue(t,!1)}set defaultValue(t){this._defaultValue=t}__init(){this.processValue(this._valueRaw,!0)}processValue(t,e){if(t==null||!e&&this.testIfValueChanged(t)===!1)return;const i=this._value;uI&&typeof i=="number"&&typeof t=="number"&&(i==null||i.toFixed(4),t==null||t.toFixed(4)),!this._active&&this._defaultValue!==void 0?(this._value=this._defaultValue,t=this._defaultValue,this._valueRaw=t):(this._valueRaw=t,this._active&&this.valueProcessor&&(t=this.valueProcessor(t)),this._value=t),this.onValueChanged&&this.onValueChanged(t,i,this)}testIfValueChanged(t){return this._valueRaw!==t}}j1([m()],$.prototype,"overrideState",null);j1([m()],$.prototype,"value",null);class fI extends Fn{constructor(){super([$])}onSerialize(t,e){}onDeserialize(t,e){const i=e.target,n=e.path;let o;if(i&&n&&(o=i[n]),(typeof o!="object"||typeof o=="object"&&o.isVolumeParameter!==!0)&&(o=new $),typeof t=="object"&&"value"in t){const r=t.value;o.initialize(r),o.overrideState=t.overrideState}else o.value=t;return o}}new fI;var pI=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const Gg=C("debugpost");class Ct extends j{constructor(e=void 0){super();a(this,"active",!0);a(this,"_manager",null);a(this,"_result");a(this,"_postprocessingContext",null);if(e)for(const i of Object.keys(e)){const n=e[i],o=this[i];o instanceof $?o.initialize(n):o!==void 0&&(this[i]=n)}}get isPostProcessingEffect(){return!0}onEnable(){super.onEnable(),Gg&&console.warn("onEnable effect",this,this.__internalDidAwakeAndStart),this.__internalDidAwakeAndStart&&(this.active=!0),this.onEffectEnabled()}onDisable(){var e;super.onDisable(),Gg&&console.warn("onDisable effect",this),(e=this._manager)==null||e.removeEffect(this),this.active=!1}onEffectEnabled(e){var i;e&&e.isPostProcessingManager===!0?this._manager=e:this._manager||(this._manager=dI(this)),(i=this._manager)==null||i.addEffect(this)}init(){}get postprocessingContext(){return this._postprocessingContext}apply(e){var i;return this._postprocessingContext=e,this._result||(this.initParameters(),this._result=(i=this.onCreateEffect)==null?void 0:i.call(this)),this._result&&this.initParameters(),this._result}unapply(){}dispose(){Gg&&console.warn("DISPOSE",this),this._result&&(Array.isArray(this._result)?this._result.forEach(e=>e.dispose()):this._result.dispose()),this._result=void 0}initParameters(){const e=Object.keys(this);for(const i of e){const n=this[i];n instanceof $&&n.__init()}}onEditorModification(e){const i=e.propertyName;if(this[i]instanceof $){const n=e.value;return this[i].value=n,!0}}}pI([m()],Ct.prototype,"active",void 0);var mI=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const gI=C("debugpost"),p_={};function us(s,t){p_[s]=t}function yI(s){return s.__type in p_?p_[s.__type]:(gI&&s.__type&&console.warn("Unknown postprocessing type",s.__type,s),Ct)}class hm{constructor(){a(this,"components",[])}__init(t){var e;(e=this.components)==null||e.forEach(i=>{i.gameObject===void 0&&t.gameObject.addComponent(i),i.init()})}addEffect(t){this.components.push(t)}removeEffect(t){const e=this.components.indexOf(t);e>=0&&this.components.splice(e,1)}}mI([Ic([s=>yI(s),Ct])],hm.prototype,"components",void 0);var _I=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o},zx;(function(s){s[s.LOW=0]="LOW",s[s.MEDIUM=1]="MEDIUM",s[s.HIGH=2]="HIGH",s[s.ULTRA=3]="ULTRA"})(zx||(zx={}));class dm extends Ct{constructor(){super(...arguments);a(this,"preset",new $(2))}get typeName(){return"Antialiasing"}onCreateEffect(){const e=new z.POSTPROCESSING.MODULE.SMAAEffect({preset:z.POSTPROCESSING.MODULE.SMAAPreset.HIGH,edgeDetectionMode:z.POSTPROCESSING.MODULE.EdgeDetectionMode.DEPTH});return this.preset.onValueChanged=i=>{e.applyPreset(i)},e}}_I([m($)],dm.prototype,"preset",void 0);us("Antialiasing",dm);var Db=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const t0=class extends Ct{constructor(){super(...arguments);a(this,"threshold",new $(.9));a(this,"intensity",new $(1));a(this,"scatter",new $(.3));a(this,"selectiveBloom")}get typeName(){return"Bloom"}init(){this.threshold.valueProcessor=e=>e,this.intensity.valueProcessor=e=>e,this.scatter.valueProcessor=e=>e}onCreateEffect(){let e;if(this.selectiveBloom==null&&(this.selectiveBloom=t0.useSelectiveBloom),this.selectiveBloom){const i=e=new z.POSTPROCESSING.MODULE.SelectiveBloomEffect(this.context.scene,this.context.mainCamera,{blendFunction:z.POSTPROCESSING.MODULE.BlendFunction.ADD,mipmapBlur:!0,luminanceThreshold:this.threshold.value,luminanceSmoothing:this.scatter.value,radius:.85,intensity:this.intensity.value});i.inverted=!0}else e=new z.POSTPROCESSING.MODULE.BloomEffect({blendFunction:z.POSTPROCESSING.MODULE.BlendFunction.ADD,mipmapBlur:!0,luminanceThreshold:this.threshold.value,luminanceSmoothing:this.scatter.value,radius:.85,intensity:this.intensity.value});return this.intensity.onValueChanged=i=>{e.intensity=i},this.threshold.onValueChanged=i=>{e.luminanceMaterial.threshold=Math.pow(i,2.2)},this.scatter.onValueChanged=i=>{e.luminancePass.enabled=!0,e.luminanceMaterial.smoothing=i,e.mipmapBlurPass&&(e.mipmapBlurPass.radius=To.lerp(.1,.9,i))},e}};let Bo=t0;a(Bo,"useSelectiveBloom",!1);Db([m($)],Bo.prototype,"threshold",void 0);Db([m($)],Bo.prototype,"intensity",void 0);Db([m($)],Bo.prototype,"scatter",void 0);us("Bloom",Bo);var bI=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};class um extends Ct{constructor(){super(...arguments);a(this,"intensity",new $(0))}get typeName(){return"ChromaticAberration"}onCreateEffect(){const e=new z.POSTPROCESSING.MODULE.ChromaticAberrationEffect;return e.offset=new ce(0,0),e.radialModulation=!0,e.modulationOffset=.15,this.intensity.valueProcessor=i=>i*.02,this.intensity.onValueChanged=i=>{e.offset.x=-i,e.offset.y=i},e}}bI([m($)],um.prototype,"intensity",void 0);us("ChromaticAberration",um);var B1=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const Ux=C("debugpost");var ai;(function(s){s[s.None=0]="None",s[s.Neutral=1]="Neutral",s[s.ACES=2]="ACES",s[s.AgX=3]="AgX",s[s.KhronosNeutral=4]="KhronosNeutral"})(ai||(ai={}));function qg(s){switch(s){case ai.None:return Op;case ai.Neutral:return k_;case ai.ACES:return T_;case ai.AgX:return Rp;case ai.KhronosNeutral:return _d;default:return _d}}function vI(s){switch(s){case Op:return ai.None;case T_:return ai.ACES;case Rp:return ai.AgX;case _d:return ai.Neutral;case k_:return ai.Neutral;default:return ai.None}}function Nx(s){switch(s){case Op:return z.POSTPROCESSING.MODULE.ToneMappingMode.LINEAR;case T_:return z.POSTPROCESSING.MODULE.ToneMappingMode.ACES_FILMIC;case Rp:return z.POSTPROCESSING.MODULE.ToneMappingMode.AGX;case _d:return z.POSTPROCESSING.MODULE.ToneMappingMode.NEUTRAL;case k_:return z.POSTPROCESSING.MODULE.ToneMappingMode.REINHARD;default:return z.POSTPROCESSING.MODULE.ToneMappingMode.LINEAR}}class Ho extends Ct{constructor(){super(...arguments);a(this,"mode",new $(void 0));a(this,"exposure",new $(1))}get typeName(){return"ToneMapping"}setMode(e){const i=ai[e];return i===void 0?(console.error("Invalid ToneMapping mode",e),this):(this.mode.value=i,this)}get isToneMapping(){return!0}onEffectEnabled(){const e=L1(this);e&&super.onEffectEnabled(e)}onCreateEffect(){if(this.postprocessingContext)for(const n of this.postprocessingContext.components){if(n===this)break;if(n!=this&&n instanceof Ho){console.warn("Multiple tonemapping effects found in the same postprocessing stack: Please check your scene setup.",{activeEffect:n,ignoredEffect:this});return}}if(this.mode.isInitialized==!1){const n=vI(this.context.renderer.toneMapping);this.mode.initialize(n)}const e=qg(this.mode.value),i=new z.POSTPROCESSING.MODULE.ToneMappingEffect({mode:Nx(e)});return this.mode.onValueChanged=n=>{const o=qg(n);i.mode=Nx(o),Ux&&console.log("ToneMapping mode changed to",ai[n],o,i.mode)},Ux&&console.log("Use ToneMapping",ai[this.mode.value],e,i.mode,"renderer.tonemapping: "+this.context.renderer.toneMapping),this.exposure.onValueChanged=n=>{this.context.renderer.toneMappingExposure=n},i}onBeforeRender(){this.mode.overrideState&&(this.context.renderer.toneMapping=qg(this.mode.value)),this.exposure.overrideState&&(this.context.renderer.toneMappingExposure=this.exposure.value)}}B1([m($)],Ho.prototype,"mode",void 0);B1([m($)],Ho.prototype,"exposure",void 0);us("Tonemapping",Ho);var fm=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};class fl extends Ct{constructor(){super(...arguments);a(this,"postExposure",new $(0));a(this,"contrast",new $(0));a(this,"hueShift",new $(0));a(this,"saturation",new $(0))}get typeName(){return"ColorAdjustments"}init(){this.postExposure.valueProcessor=e=>(e=Math.pow(2,e),e),this.contrast.valueProcessor=e=>{let i=1;return e>0?i=200:e<0&&(i=100),e/i},this.contrast.defaultValue=0,this.hueShift.valueProcessor=e=>Math.PI*e/180,this.hueShift.defaultValue=0,this.saturation.valueProcessor=e=>e<0?e/100:e/(100*Math.PI),this.saturation.defaultValue=0}onCreateEffect(){var r,l;const e=[];this.context.renderer.toneMapping!==gc&&this.postExposure.overrideState&&(this.context.renderer.toneMapping=gc);let i=(r=this.postprocessingContext)==null?void 0:r.components.find(c=>c instanceof Ho);i||(i=new Ho,(l=this.postprocessingContext)==null||l.components.push(i)),this.postExposure.onValueChanged=c=>{this.postExposure.overrideState&&(i.exposure.value=c)};const n=new z.POSTPROCESSING.MODULE.BrightnessContrastEffect;this.contrast.onValueChanged=c=>n.contrast=c;const o=new z.POSTPROCESSING.MODULE.HueSaturationEffect;return e.push(n),e.push(o),this.hueShift.onValueChanged=c=>o.hue=c,this.saturation.onValueChanged=c=>o.saturation=c,e}}fm([m($)],fl.prototype,"postExposure",void 0);fm([m($)],fl.prototype,"contrast",void 0);fm([m($)],fl.prototype,"hueShift",void 0);fm([m($)],fl.prototype,"saturation",void 0);us("ColorAdjustments",fl);var pl=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o},m_;(function(s){s[s.Off=0]="Off",s[s.Gaussian=1]="Gaussian",s[s.Bokeh=2]="Bokeh"})(m_||(m_={}));const xI=C("debugpost");class to extends Ct{constructor(){super(...arguments);a(this,"mode");a(this,"focusDistance",new $(1));a(this,"focalLength",new $(.2));a(this,"aperture",new $(20));a(this,"gaussianMaxRadius",new $);a(this,"resolutionScale",new $(1*1/window.devicePixelRatio));a(this,"bokehScale",new $)}get typeName(){return"DepthOfField"}init(){this.focalLength.valueProcessor=i=>{const n=i/300,o=2;return W.lerp(o,.01,n)};const e=20;this.aperture.valueProcessor=i=>{const n=1-i/32;return W.lerp(1,e,n)}}onCreateEffect(){if(this.mode===m_.Off){xI&&console.warn("DepthOfField: Mode is set to Off");return}const e=new z.POSTPROCESSING.MODULE.DepthOfFieldEffect(this.context.mainCamera,{worldFocusRange:.2,focalLength:1,bokehScale:20,resolutionScale:this.resolutionScale.value});return this.focusDistance.onValueChanged=i=>{e.cocMaterial.worldFocusDistance=i},this.focalLength.onValueChanged=i=>e.cocMaterial.worldFocusRange=i,this.aperture.onValueChanged=i=>e.bokehScale=i,this.resolutionScale&&(this.resolutionScale.onValueChanged=i=>e.resolution.scale=i),[e]}unapply(){}}pl([m()],to.prototype,"mode",void 0);pl([m($)],to.prototype,"focusDistance",void 0);pl([m($)],to.prototype,"focalLength",void 0);pl([m($)],to.prototype,"aperture",void 0);pl([m($)],to.prototype,"gaussianMaxRadius",void 0);pl([m($)],to.prototype,"resolutionScale",void 0);pl([m($)],to.prototype,"bokehScale",void 0);us("DepthOfField",to);class ip extends Ct{constructor(e){super();a(this,"effect");this.effect=e}get typeName(){return this.effect.constructor.name}onCreateEffect(){return this.effect}}var wI=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};class pm extends Ct{constructor(){super(...arguments);a(this,"granularity",new $(10))}get typeName(){return"PixelationEffect"}onCreateEffect(){const e=new z.POSTPROCESSING.MODULE.PixelationEffect;return this.granularity.onValueChanged=i=>{e.granularity=i},e}}wI([m($)],pm.prototype,"granularity",void 0);us("PixelationEffect",pm);var tu=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};class Zr extends Ct{constructor(){super(...arguments);a(this,"intensity",new $(2));a(this,"falloff",new $(1));a(this,"samples",new $(9));a(this,"color",new $(new ue(0,0,0)));a(this,"luminanceInfluence",new $(.7));a(this,"_ssao")}get typeName(){return"ScreenSpaceAmbientOcclusion"}onBeforeRender(){if(this._ssao&&this.context.mainCamera instanceof Re){const e=this.context.mainCamera.far-this.context.mainCamera.near;this._ssao.ssaoMaterial.worldDistanceFalloff=e*.01,this._ssao.ssaoMaterial.worldDistanceThreshold=this.context.mainCamera.far}}onCreateEffect(){const e=this.context.mainCamera,i=new z.POSTPROCESSING.MODULE.NormalPass(this.context.scene,e),n=new z.POSTPROCESSING.MODULE.DepthDownsamplingPass({normalBuffer:i.texture,resolutionScale:.5}),o=this._ssao=new z.POSTPROCESSING.MODULE.SSAOEffect(e,i.texture,{normalDepthBuffer:n.texture,worldDistanceThreshold:1,worldDistanceFalloff:1,worldProximityThreshold:.1,worldProximityFalloff:2,intensity:1,blendFunction:z.POSTPROCESSING.MODULE.BlendFunction.MULTIPLY,luminanceInfluence:.5});this.intensity.onValueChanged=l=>{o.intensity=l},this.falloff.onValueChanged=l=>{o.ssaoMaterial.radius=l*.1},this.samples.onValueChanged=l=>{o.ssaoMaterial.samples=l},this.color.onValueChanged=l=>{o.color||(o.color=new ue),o.color.copy(l)},this.luminanceInfluence.onValueChanged=l=>{o.luminanceInfluence=l};const r=new Array;return r.push(i),r.push(n),r.push(o),r}}tu([m($)],Zr.prototype,"intensity",void 0);tu([m($)],Zr.prototype,"falloff",void 0);tu([m($)],Zr.prototype,"samples",void 0);tu([m($)],Zr.prototype,"color",void 0);tu([m($)],Zr.prototype,"luminanceInfluence",void 0);us("ScreenSpaceAmbientOcclusion",Zr);var ml=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const SI=C("debugN8AO");var Zh;(function(s){s[s.Performance=0]="Performance",s[s.Low=1]="Low",s[s.Medium=2]="Medium",s[s.High=3]="High",s[s.Ultra=4]="Ultra"})(Zh||(Zh={}));class io extends Ct{constructor(){super(...arguments);a(this,"gammaCorrection",!0);a(this,"aoRadius",new $(1));a(this,"falloff",new $(1));a(this,"intensity",new $(1));a(this,"color",new $(new ue(0,0,0)));a(this,"screenspaceRadius",!1);a(this,"quality",Zh.Medium);a(this,"_ssao")}get typeName(){return"ScreenSpaceAmbientOcclusionN8"}get pass(){return this._ssao}onValidate(){this._ssao&&(this._ssao.setQualityMode(Zh[this.quality]),this._ssao.configuration.gammaCorrection=this.gammaCorrection,this._ssao.configuration.screenSpaceRadius=this.screenspaceRadius)}onCreateEffect(){const e=this.context.mainCamera,i=this.context.domWidth,n=this.context.domHeight,o=this._ssao=new z.POSTPROCESSING_AO.MODULE.N8AOPostPass(this.context.scene,e,i,n),r=Zh[this.quality];o.setQualityMode(r),o.configuration.transparencyAware=!1;const l=new No(i,n);return o.configuration.beautyRenderTarget=l,o.configuration.autoRenderBeauty=!1,o.configuration.gammaCorrection=this.gammaCorrection,o.configuration.screenSpaceRadius=this.screenspaceRadius,SI&&(o.enableDebugMode(),console.log(o),setInterval(()=>{console.log("SSAO",o.lastTime)},1e3),setInterval(()=>{console.log("SSAO",o.enabled,{ssao:o,autoRenderBeauty:o.configuration.autoRenderBeauty})},4e3)),this.intensity.onValueChanged=c=>{o.configuration.intensity=c},this.falloff.onValueChanged=c=>{o.configuration.distanceFalloff=c},this.aoRadius.onValueChanged=c=>{o.configuration.aoRadius=c},this.color.onValueChanged=c=>{o.color||(o.color=new ue),o.configuration.color.copy(c)},o}}ml([mi(),m()],io.prototype,"gammaCorrection",void 0);ml([m($)],io.prototype,"aoRadius",void 0);ml([m($)],io.prototype,"falloff",void 0);ml([m($)],io.prototype,"intensity",void 0);ml([m($)],io.prototype,"color",void 0);ml([mi(),m()],io.prototype,"screenspaceRadius",void 0);ml([mi(),m()],io.prototype,"quality",void 0);us("ScreenSpaceAmbientOcclusionN8",io);var F1=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};class mm extends Ct{constructor(){super(...arguments);a(this,"_effect");a(this,"_amount",1);a(this,"_radius",1)}get typeName(){return"Sharpening"}onCreateEffect(){return this._effect??(this._effect=new(CI())),this.effect}get effect(){return this._effect}set amount(e){this._amount=e,this._effect&&(this._effect.uniforms.get("amount").value=e)}get amount(){return this._effect?this._effect.uniforms.get("amount").value:this._amount}set radius(e){this._radius=e,this._effect&&(this._effect.uniforms.get("radius").value=e)}get radius(){return this._effect?this._effect.uniforms.get("radius").value:this._radius}}F1([m()],mm.prototype,"amount",null);F1([m()],mm.prototype,"radius",null);function CI(){const s=`
      void mainSupport() {
        vUv = uv;
        gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
      }
    `,t=`
    uniform sampler2D tDiffuse;
    uniform float amount;
    uniform float radius;
    
    void mainImage(const in vec4 inputColor, const in vec2 uv, out vec4 outputColor) {
        float tx = 1.0 / resolution.x;
        float ty = 1.0 / resolution.y;
        vec2 texelSize = vec2(tx, ty);
    
        vec4 blurred = vec4(0.0);
        float total = 0.0;
    
        for (float x = -radius; x <= radius; x++) {
            for (float y = -radius; y <= radius; y++) {
                vec2 offset = vec2(x, y) * texelSize;
                vec4 diffuse = texture2D(tDiffuse, uv + offset);
                float weight = exp(-length(offset) * amount);
                blurred += diffuse * weight;
                total += weight;
            }
        }
    
        if (total > 0.0) {
            blurred /= total;
        }
    
        // Calculate the sharpened color using inputColor
        vec4 sharp = inputColor + clamp(inputColor - blurred, 0.0, 1.0) * amount;
        // Keep original alpha
        sharp.a = inputColor.a;
    
        // Ensure the sharp color does not go below 0 or above 1
        // This means: sharpening must happen AFTER tonemapping.
        sharp = clamp(sharp, 0.0, 1.0);
    
        outputColor = sharp;
    }
    
    `;class e extends z.POSTPROCESSING.MODULE.Effect{constructor(){super("Sharpening",t,{vertexShader:s,blendFunction:z.POSTPROCESSING.MODULE.BlendFunction.NORMAL,uniforms:new Map([["amount",new Er(1)],["radius",new Er(1)]])})}}return e}var Hc=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};class ir extends Ct{constructor(){super(...arguments);a(this,"offset",new $(0));a(this,"rotation",new $(0));a(this,"focusArea",new $(.4));a(this,"feather",new $(.3));a(this,"kernelSize",new $(2));a(this,"resolutionScale",new $(1/window.devicePixelRatio))}get typeName(){return"TiltShiftEffect"}init(){this.offset.defaultValue=0,this.rotation.defaultValue=0,this.focusArea.defaultValue=.4,this.feather.defaultValue=.3,this.kernelSize.defaultValue=z.POSTPROCESSING.MODULE.KernelSize.MEDIUM,this.resolutionScale.defaultValue=1/window.devicePixelRatio}onCreateEffect(){const e=new z.POSTPROCESSING.MODULE.TiltShiftEffect({kernelSize:z.POSTPROCESSING.MODULE.KernelSize.VERY_LARGE,offset:this.offset.value,rotation:this.rotation.value,focusArea:this.focusArea.value,feather:this.feather.value});return this.offset.onValueChanged=i=>e.offset=i,this.rotation.onValueChanged=i=>e.rotation=i,this.focusArea.onValueChanged=i=>e.focusArea=i,this.feather.onValueChanged=i=>e.feather=i,this.kernelSize.onValueChanged=i=>e.blurPass.kernelSize=i,this.resolutionScale.onValueChanged=i=>e.resolution.scale=i/window.devicePixelRatio,e}}Hc([m($)],ir.prototype,"offset",void 0);Hc([m($)],ir.prototype,"rotation",void 0);Hc([m($)],ir.prototype,"focusArea",void 0);Hc([m($)],ir.prototype,"feather",void 0);Hc([m($)],ir.prototype,"kernelSize",void 0);Hc([m($)],ir.prototype,"resolutionScale",void 0);us("TiltShiftEffect",ir);var Lb=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};class Gc extends Ct{constructor(){super(...arguments);a(this,"color",new $({r:0,g:0,b:0,a:1}));a(this,"intensity",new $(0));a(this,"center",new $({x:.5,y:.5}))}get typeName(){return"Vignette"}init(){this.color.defaultValue={r:0,g:0,b:0,a:1},this.intensity.defaultValue=0,this.center.defaultValue={x:.5,y:.5}}onCreateEffect(){const e=new z.POSTPROCESSING.MODULE.VignetteEffect;return this.intensity.onValueChanged=i=>{e.offset=i,this.updateDarkness(e)},this.color.onValueChanged=i=>{this.updateDarkness(e)},e}updateDarkness(e){const i=this.intensity.value;e.darkness=i}}Lb([m($)],Gc.prototype,"color",void 0);Lb([m($)],Gc.prototype,"intensity",void 0);Lb([m($)],Gc.prototype,"center",void 0);us("Vignette",Gc);globalThis.true=globalThis.true!==void 0?globalThis.true:!0;const lr=C("debugpost"),Xg=Symbol("needle:postprocessing-handler"),Qg=Symbol("needle:previous-autoclear-state");class jb{constructor(t){a(this,"_composer",null);a(this,"_lastVolumeComponents");a(this,"_effects",[]);a(this,"_isActive",!1);a(this,"context");this.context=t}get isActive(){return this._isActive}get composer(){return this._composer}apply(t){return"env"in import.meta&&{}.VITE_NEEDLE_USE_POSTPROCESSING==="false"?(lr?console.warn("Postprocessing is disabled via vite env setting"):console.debug("Postprocessing is disabled via vite env setting"),Promise.resolve()):(this._isActive=!0,this.onApply(this.context,t))}unapply(){var i;if(lr&&console.log("Unapplying postprocessing effects"),this._isActive=!1,this._lastVolumeComponents){for(const n of this._lastVolumeComponents)n.unapply();this._lastVolumeComponents.length=0}const t=this.context;t[Xg]===this&&delete t[Xg],t.composer===this._composer&&((i=t.composer)==null||i.dispose(),t.composer=null),typeof t.renderer[Qg]=="boolean"&&(t.renderer.autoClear=t.renderer[Qg])}dispose(){this.unapply();for(const t of this._effects)t.dispose();this._effects.length=0,this._composer=null}async onApply(t,e){if(!e)return;await Promise.all([z.POSTPROCESSING.load(),z.POSTPROCESSING_AO.load()]),t[Xg]=this,lr&&console.log("Apply Postprocessing Effects",e),this._lastVolumeComponents=[...e],this._effects.length=0;const i={handler:this,components:this._lastVolumeComponents};for(let n=0;n<this._lastVolumeComponents.length;n++){const o=this._lastVolumeComponents[n];if(o.context=t,o.apply){if(o.active){if(!t.mainCameraComponent){console.error("No camera in scene found or available yet - can not create postprocessing effects");return}const r=o.apply(i);if(!r)continue;Array.isArray(r)?this._effects.push(...r):this._effects.push(r)}}else o.active&&Me("Volume component is not a VolumeComponent: "+o.__type)}if(this.context.renderer.toneMapping!=gc&&!this._effects.find(n=>n instanceof z.POSTPROCESSING.MODULE.ToneMappingEffect)){const n=new z.POSTPROCESSING.MODULE.ToneMappingEffect;this._effects.push(n)}this.applyEffects(t)}applyEffects(t){const e=this._effects;if(e.length<=0)return;const i=t.mainCameraComponent,n=t.renderer,o=t.scene,r=i.threeCamera;n[Qg]=n.autoClear,this._composer||(this._composer=new z.POSTPROCESSING.MODULE.EffectComposer(n,{frameBufferType:vR,stencilBuffer:!0})),t.composer&&t.composer!==this._composer&&console.warn("There's already an active EffectComposer in your scene: replacing it with a new one. This might cause unexpected behaviour. Make sure to only use one PostprocessingManager/Volume in your scene."),t.composer=this._composer;const l=t.composer;l.setMainCamera(r),l.setRenderer(n),l.setMainScene(o);for(const h of l.passes)h.dispose();l.removeAllPasses();const c=new z.POSTPROCESSING.MODULE.RenderPass(o,r);c.name="Render To Screen",c.mainScene=o,l.addPass(c);try{this.orderEffects();const h=[];for(const d of e)d instanceof z.POSTPROCESSING.MODULE.Effect?h.push(d):(d instanceof z.POSTPROCESSING.MODULE.Pass,l.addPass(d));if(h.length>0){const d=new z.POSTPROCESSING.MODULE.EffectPass(r,...h);d.name=h.map(u=>u.name).join(" "),d.mainScene=o,d.enabled=!0,l.addPass(d)}}catch(h){console.error("Error while applying postprocessing effects",h),l.removeAllPasses()}lr&&console.log("[PostProcessing] Passes ‚Üí",l.passes)}orderEffects(){var e;lr&&console.log("Before ordering effects",[...this._effects]),Yg??(Yg=[z.POSTPROCESSING.MODULE.NormalPass,z.POSTPROCESSING.MODULE.DepthDownsamplingPass,z.POSTPROCESSING.MODULE.SMAAEffect,z.POSTPROCESSING.MODULE.SSAOEffect,z.POSTPROCESSING_AO.MODULE.N8AOPostPass,z.POSTPROCESSING.MODULE.TiltShiftEffect,z.POSTPROCESSING.MODULE.DepthOfFieldEffect,z.POSTPROCESSING.MODULE.ChromaticAberrationEffect,z.POSTPROCESSING.MODULE.BloomEffect,z.POSTPROCESSING.MODULE.SelectiveBloomEffect,z.POSTPROCESSING.MODULE.VignetteEffect,z.POSTPROCESSING.MODULE.PixelationEffect,z.POSTPROCESSING.MODULE.ToneMappingEffect,z.POSTPROCESSING.MODULE.HueSaturationEffect,z.POSTPROCESSING.MODULE.BrightnessContrastEffect]);const t=this._effects;t.sort((i,n)=>{const o=Yg.findIndex(l=>i.constructor.name.endsWith(l.name)),r=Yg.findIndex(l=>n.constructor.name.endsWith(l.name));return o<0?(lr&&console.warn("Unknown effect found: ",i.constructor.name),-1):r<0?(lr&&console.warn("Unknown effect found: ",n.constructor.name),1):o<0?1:r<0?-1:o-r}),lr&&console.log("After ordering effects",[...this._effects]);for(let i=0;i<t.length;i++){const n=t[i];if(((e=n==null?void 0:n.configuration)==null?void 0:e.gammaCorrection)!==void 0){const o=i===t.length-1;n.configuration.gammaCorrection=o}}}}let Yg=null;var z1=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const Rl=C("debugpost");class iu extends j{constructor(){super(...arguments);a(this,"sharedProfile");a(this,"multisampling","auto");a(this,"_postprocessing");a(this,"_activeEffects",[]);a(this,"_effects",[]);a(this,"_componentEnabledTime",-1);a(this,"_multisampleAutoChangeTime",0);a(this,"_multisampleAutoDecreaseTime",0);a(this,"_lastApplyTime");a(this,"_rapidApplyCount",0);a(this,"_isDirty",!1);a(this,"_modificationQueue");a(this,"_recreateId",-1)}get isPostProcessingManager(){return!0}get effects(){return this._activeEffects}addEffect(e){let i=e;return i instanceof Ct||(i=new ip(i)),i.gameObject===void 0&&this.gameObject.addComponent(i),this._effects.includes(i)||(this._effects.push(i),this._isDirty=!0),e}removeEffect(e){var n,o,r,l;let i=-1;if(e instanceof Ct?i=this._effects.indexOf(e):i=this._effects.findIndex(c=>c instanceof ip&&c.effect===e),i!==-1)return this._effects.splice(i,1),this._isDirty=!0,e;if(e instanceof Ct){const c=(o=(n=this.sharedProfile)==null?void 0:n.components)==null?void 0:o.indexOf(e);c!==void 0&&c!==-1&&(this._isDirty=!0,(l=(r=this.sharedProfile)==null?void 0:r.components)==null||l.splice(c,1))}return e}markDirty(){this._isDirty=!0}awake(){var e;Rl&&(console.log("PostprocessingManager Awake",this),console.log("Press P to toggle post processing"),window.addEventListener("keydown",i=>{i.key==="p"&&(this.enabled=!this.enabled,tt("Toggle PostProcessing "+this.name+": Enabled="+this.enabled),this.markDirty())})),(e=this.sharedProfile)==null||e.__init(this)}onEnable(){this._componentEnabledTime=this.context.time.realtimeSinceStartup,this._isDirty=!0}onDisable(){var e;(e=this._postprocessing)==null||e.unapply(),this._isDirty=!1}onBeforeRender(){if(!this.context.isInXR&&(this.context.mainCamera&&this._isDirty&&this.apply(),this.context.composer&&this._postprocessing&&this._postprocessing.composer===this.context.composer)){this.context.renderer.getContext().isContextLost()&&this.context.renderer.forceContextRestore(),this.context.composer.getRenderer()!==this.context.renderer&&this.context.composer.setRenderer(this.context.renderer),this.context.composer.setMainScene(this.context.scene);const e=this.context.composer;if(this.multisampling==="auto"){const i=this.context.time.realtimeSinceStartup-this._multisampleAutoChangeTime;if(this.context.time.realtimeSinceStartup-this._componentEnabledTime>2&&i>.5){const n=e.multisampling;e.multisampling>0&&this.context.time.smoothedFps<=50?(this._multisampleAutoChangeTime=this.context.time.realtimeSinceStartup,this._multisampleAutoDecreaseTime=this.context.time.realtimeSinceStartup,e.multisampling*=.5,e.multisampling=Math.floor(e.multisampling),Rl&&console.debug(`[PostProcessing] Reduced multisampling from ${n} to ${e.multisampling}`)):i>1&&this.context.time.smoothedFps>=59&&e.multisampling<this.context.renderer.capabilities.maxSamples&&this.context.time.realtimeSinceStartup-this._multisampleAutoDecreaseTime>10&&(this._multisampleAutoChangeTime=this.context.time.realtimeSinceStartup,e.multisampling=e.multisampling<=0?1:e.multisampling*2,e.multisampling=Math.floor(e.multisampling),Rl&&console.debug(`[PostProcessing] Increased multisampling from ${n} to ${e.multisampling}`))}}else e.multisampling=Math.max(0,Math.min(this.multisampling,this.context.renderer.capabilities.maxSamples));if(this.context.mainCamera){const i=this.context.composer.passes;for(const n of i)if(n.mainCamera&&n.mainCamera!==this.context.mainCamera){this.context.composer.setMainCamera(this.context.mainCamera);break}}}}onDestroy(){var e;(e=this._postprocessing)==null||e.dispose()}apply(){var e,i;if(Rl&&console.log(`Apply PostProcessing "${this.name}"`),U()&&(this._lastApplyTime!==void 0&&Date.now()-this._lastApplyTime<100&&(this._rapidApplyCount++,this._rapidApplyCount===5&&console.warn("Detected rapid post processing modifications - this might be a bug",this)),this._lastApplyTime=Date.now()),this._isDirty=!1,this.unapply(),this._activeEffects.length=0,(e=this.sharedProfile)!=null&&e.components){const n=this.sharedProfile.components;for(const o of n)o.active&&o.enabled&&!this._activeEffects.includes(o)&&this._activeEffects.push(o)}for(const n of this._effects)n.active&&n.enabled&&!this._activeEffects.includes(n)&&this._activeEffects.push(n);this._activeEffects.length>0&&(this._postprocessing||(this._postprocessing=new jb(this.context)),(i=this._postprocessing.apply(this._activeEffects))==null||i.then(()=>{var o;if(!this.activeAndEnabled)return;this._applyPostQueue();const n=(o=this._postprocessing)==null?void 0:o.composer;n?(this.multisampling==="auto"?n.multisampling=J.isMobileDevice()?2:4:n.multisampling=Math.max(0,Math.min(this.multisampling,this.context.renderer.capabilities.maxSamples)),Rl&&console.debug(`[PostProcessing] Set multisampling to ${n.multisampling} (Is Mobile: ${J.isMobileDevice()})`)):Rl&&console.warn("[PostProcessing] No composer found")}))}unapply(){var e;(e=this._postprocessing)==null||e.unapply()}_applyPostQueue(){if(this._modificationQueue){for(const e of this._modificationQueue.values())this.onEditorModification(e);this._modificationQueue.clear()}}onEditorModification(e){var i,n;if(e.propertyName.startsWith("postprocessing.")){if(!this._postprocessing)return this._modificationQueue||(this._modificationQueue=new Map),this._modificationQueue.set(e.propertyName,e),!0;if(!((i=this._activeEffects)!=null&&i.length))return;const o=e.propertyName.split(".");if(o.length===3||o.length===4){const r=o[1],l=o[2];for(const c of this._activeEffects)if(((n=c.typeName)==null?void 0:n.toLowerCase())===r.toLowerCase()){if(l==="active"){c.active=e.value,this.scheduleRecreate();return}if(!qu.has(r)){const h=new Array;qu.set(r,h);const d=Object.keys(c);for(const u of d)c[u]instanceof $&&h.push(u)}if(qu.has(r)){const h=l.toLowerCase(),d=qu.get(r);for(const u of d)if(u.toLowerCase()===h){const f=c[u];f instanceof $&&(o.length===4&&o[3]==="active"?(f.overrideState=e.value,this.scheduleRecreate()):f&&f.value!==void 0&&(f.value=e.value));return}}console.warn("Unknown modification",l);return}}return!0}return!1}scheduleRecreate(){const e=++this._recreateId;setTimeout(()=>{e===this._recreateId&&(this.onDisable(),this.onEnable())},200)}}z1([Ic(hm)],iu.prototype,"sharedProfile",void 0);z1([Ic()],iu.prototype,"multisampling",void 0);const qu=new Map;hI(iu);async function Bb(s){const{NeedleEngineHTMLElement:t}=await ts(()=>Promise.resolve().then(()=>vD),void 0,import.meta.url);t.observedAttributes.includes(s)||t.observedAttributes.push(s)}var $t=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const Oi=C("debugsceneswitcher"),PI=C("sceneswitcher:clearscene"),pf="scene";Bb(pf);const cr=Promise.resolve(!1);class vt extends j{constructor(){super(...arguments);a(this,"autoLoadFirstScene",!0);a(this,"scenes",[]);a(this,"loadingScene");a(this,"queryParameterName","scene");a(this,"useSceneName",!0);a(this,"clamp",!0);a(this,"useHistory",!0);a(this,"useKeyboard",!0);a(this,"useSwipe",!0);a(this,"useSceneLighting",!0);a(this,"useSceneBackground",!0);a(this,"preloadNext",1);a(this,"preloadPrevious",1);a(this,"preloadConcurrent",2);a(this,"createMenuButtons",!1);a(this,"sceneLoadingStart",new Te);a(this,"sceneLoadingProgress",new Te);a(this,"sceneLoaded",new Te);a(this,"_currentIndex",-1);a(this,"_currentScene");a(this,"_engineElementOverserver");a(this,"_preloadScheduler");a(this,"_menuButtons");a(this,"onPopState",async e=>{if(!this.useHistory)return;const i=this.useHistory;try{this.useHistory=!1;let n=!1;if(this.queryParameterName&&(n=await this.tryLoadFromQueryParam()),!n){const o=e==null?void 0:e.state;if(o&&o.startsWith(this.guid)){const r=o.substr(this.guid.length+2);Oi&&console.log("PopState",r),await this.trySelectSceneFromValue(r)}}}finally{this.useHistory=i}});a(this,"normalizedSwipeThresholdX",.1);a(this,"_didSwipe",!1);a(this,"onInputPointerMove",e=>{if(this.useSwipe&&!this._didSwipe&&e.button===0&&e.pointerType==="touch"&&this.context.input.getPointerPressedCount()===1){const i=this.context.input.getPointerPositionDelta(e.button);if(i){const n=i.x/this.context.domWidth;n>=this.normalizedSwipeThresholdX?(this._didSwipe=!0,this.selectPrev()):n<=-this.normalizedSwipeThresholdX&&(this._didSwipe=!0,this.selectNext())}}});a(this,"onInputPointerUp",e=>{e.button===0&&(this._didSwipe=!1)});a(this,"onInputKeyDown",e=>{if(!this.useKeyboard||!this.scenes)return;const i=e.key.toLowerCase();if(!i)return;const n=parseInt(i)-1;if(n>=0){this.trySelectSceneFromValue(n);return}switch(i){case"arrowright":case"d":this.selectNext();break;case"arrowleft":case"a":this.selectPrev();break}});a(this,"__lastSwitchScene");a(this,"__lastSwitchScenePromise");a(this,"_currentlyLoadingScene");a(this,"_lastLoadingScene");a(this,"_loadingScenePromise");a(this,"_isCurrentlyLoading",!1);a(this,"_currentLoadingProgress")}get currentIndex(){return this._currentIndex}get currentLoadingProgress(){return this._currentLoadingProgress}get currentlyLoadingScene(){return this._currentlyLoadingScene}get currentlyLoadedScene(){return this._currentScene}awake(){this.scenes===void 0&&(this.scenes=[]);for(const e of this.scenes)e&&!e.hasUrl&&e.asset instanceof F&&e.asset.removeFromParent();Oi&&console.log("SceneSwitcher",this)}async onEnable(){if(globalThis.addEventListener("popstate",this.onPopState),this.context.input.addEventListener(ye.KeyDown,this.onInputKeyDown),this.context.input.addEventListener(ye.PointerMove,this.onInputPointerMove),this.context.input.addEventListener(ye.PointerUp,this.onInputPointerUp),this._engineElementOverserver||(this._engineElementOverserver=new MutationObserver(e=>{for(const i of e)if(i.type==="attributes"&&i.attributeName===pf){const n=this.context.domElement.getAttribute(pf);n!==null&&this.trySelectSceneFromValue(n)}})),this._engineElementOverserver.observe(this.context.domElement,{attributes:!0}),this._preloadScheduler||(this._preloadScheduler=new RI(this)),this._preloadScheduler.maxLoadAhead=this.preloadNext,this._preloadScheduler.maxLoadBehind=this.preloadPrevious,this._preloadScheduler.maxConcurrent=this.preloadConcurrent,this._preloadScheduler.begin(2e3),this.autoLoadFirstScene&&this._currentIndex===-1&&!await this.tryLoadFromQueryParam()){const e=this.context.domElement.getAttribute(pf);try{(e===null||!await this.trySelectSceneFromValue(e))&&this._currentIndex===-1&&this.select(0)}finally{}}this.createMenuButtons&&(this._menuButtons??(this._menuButtons=[]),this._menuButtons.push(this.context.menu.appendChild({label:"Previous",icon:"arrow_back_ios",onClick:()=>this.selectPrev(),priority:-1005,class:"row2"})),this._menuButtons.push(this.context.menu.appendChild({label:"Next",icon:"arrow_forward_ios",iconSide:"right",onClick:()=>this.selectNext(),priority:-1e3,class:"row2"})))}onDisable(){var e;if(globalThis.removeEventListener("popstate",this.onPopState),this.context.input.removeEventListener(ye.KeyDown,this.onInputKeyDown),this.context.input.removeEventListener(ye.PointerMove,this.onInputPointerMove),this.context.input.removeEventListener(ye.PointerUp,this.onInputPointerUp),(e=this._preloadScheduler)==null||e.stop(),this._menuButtons){for(const i of this._menuButtons)i.remove();this._menuButtons=void 0}}addScene(e){if(typeof e=="string"){let i=this.context.addressables.findAssetReference(e);return i||(i=new de(e),this.context.addressables.registerAssetReference(i)),this.scenes.push(i),i}return this.scenes.push(e),e}selectNext(){return this.select(this._currentIndex+1)}selectPrev(){return this.select(this._currentIndex-1)}select(e){var n,o,r;if(Oi&&console.log("select",e),typeof e=="object"&&console.warn('Switching to "'+e+'" might not work. Please either use an index or a AssetReference (not a scene reference)'),typeof e=="string"){const l=(n=this.scenes)==null?void 0:n.find(c=>c.url===e);if(!l){const c=de.getOrCreate(this.sourceId??"",e,this.context);return this.switchScene(c)}if(l)e=(o=this.scenes)==null?void 0:o.indexOf(l);else return cr}if(!((r=this.scenes)!=null&&r.length))return cr;if(e<0){if(this.clamp)return cr;e=this.scenes.length-1}else if(e>=this.scenes.length){if(this.clamp)return cr;e=0}const i=this.scenes[e];return this.switchScene(i)}unload(){return this.__lastSwitchScene=void 0,this.__lastSwitchScenePromise=void 0,this.__unloadCurrentScene()}async reload(){if(this.__lastSwitchScene){const e=this.__lastSwitchScene;return this.__lastSwitchScene=void 0,this.switchScene(e)}return!1}async switchScene(e){if(!(e instanceof de)){const n=typeof e;return n==="string"?this.select(e):n==="number"?this.select(e):(console.warn("SceneSwitcher: Can't switch to scene",e,"of type",n),!1)}return e.url===this.sourceId?(console.warn("SceneSwitcher: can't load own scene - prevent recursive loading",this.sourceId),!1):this.__lastSwitchScene===e&&this.__lastSwitchScenePromise?this.__lastSwitchScenePromise:(this.__lastSwitchScene=e,this.__lastSwitchScenePromise=this.__internalSwitchScene(e),await this.__lastSwitchScenePromise)}async __unloadCurrentScene(){const e=this._currentScene;if(this._currentScene=void 0,e){Oi&&console.log("UNLOAD",e.url,"HasURL?: "+e.hasUrl);const i=this.tryGetSceneEventListener(e.asset);if(i!=null&&i.sceneClosing){const n=i.sceneClosing();n instanceof Promise&&await n}e.hasUrl?e.unload():e.asset instanceof F&&e.asset.removeFromParent()}}async __internalSwitchScene(e){var n,o,r,l,c;await this.__unloadCurrentScene();const i=this._currentIndex=((n=this.scenes)==null?void 0:n.indexOf(e))??-1;try{this._currentlyLoadingScene=e,this._currentLoadingProgress=new ProgressEvent("progress",{loaded:0,total:1});const h=new CustomEvent("loadscene-start",{detail:{scene:e,switcher:this,index:i}});this.dispatchEvent(h),(o=this.sceneLoadingStart)==null||o.invoke(h.detail),await this.onStartLoading(),await e.loadAssetAsync((u,f)=>{var p;this._currentLoadingProgress=f,this.dispatchEvent(f),(p=this.sceneLoadingProgress)==null||p.invoke(f)}).catch(console.error),await this.onEndLoading();const d=new CustomEvent("loadscene-finished",{detail:{scene:e,switcher:this,index:i}});if(this.dispatchEvent(d),this._currentLoadingProgress=void 0,this._currentlyLoadingScene=void 0,d.defaultPrevented)return Oi&&console.warn("Adding loaded scene prevented:",e,d),!1;if(!e.asset)return Oi&&console.warn("Failed loading scene:",e),!1;if(this._currentIndex===i){if(Oi&&console.log("ADD",e.url),this._currentScene=e,PI){const p=((r=this.context.mainCameraComponent)==null?void 0:r.gameObject)||this.context.mainCamera;p==null||p.removeFromParent();const g=this.gameObject.removeFromParent();Ln(this.context.scene,!0,!0),this.context.scene=new In,this.context.scene.add(g),p&&this.context.scene.add(p)}if(P.add(e.asset,this.gameObject),this.useSceneLighting&&this.context.sceneLighting.enable(e),this.useSceneBackground){const p=this.context.lightmaps.tryGetSkybox(e.url);p?(p.mapping=Mo,this.context.scene.background=p):Oi&&console.warn("SceneSwitcher: Can't find skybox for scene "+e.url)}if(this.useHistory&&i>=0){let p=i.toString();if(this.useSceneName&&(p=$x(e.url)),(l=this.queryParameterName)!=null&&l.length)bf(this.queryParameterName,p,this.useHistory);else{const g=history.state,y=this.guid+"::"+i;g!==y&&history.pushState(y,"unused",location.href)}}const u=this.tryGetSceneEventListener(e.asset);if(u!=null&&u.sceneOpened){const p=u.sceneOpened(this);p instanceof Promise&&await p}const f=new CustomEvent("scene-opened",{detail:{scene:e,switcher:this,index:i}});return this.dispatchEvent(f),(c=this.sceneLoaded)==null||c.invoke(this),!0}}catch(h){console.error(h)}return!1}preload(e){if(e>=0&&e<this.scenes.length){const i=this.scenes[e];if(i instanceof de)return i.preload()}return cr}tryLoadFromQueryParam(){var i;if(!((i=this.queryParameterName)!=null&&i.length))return cr;const e=C(this.queryParameterName);return typeof e=="boolean"?cr:this.trySelectSceneFromValue(e)}trySelectSceneFromValue(e){if(typeof e=="string"){const i=parseInt(e);if(i>=0&&i<this.scenes.length)return this.select(i);{const n=e.toLowerCase();for(let o=0;o<this.scenes.length;o++){const r=this.scenes[o];if(r&&$x(r.url).toLowerCase().includes(n))return this.select(o)}}}else if(typeof e=="number"&&e>=0&&e<this.scenes.length)return this.select(e);return qi()&&console.warn('Can not find scene: "'+e+'"',this),cr}async onStartLoading(){var e,i;if(this._isCurrentlyLoading=!0,this.loadingScene&&(this._lastLoadingScene!==this.loadingScene&&(this._loadingScenePromise=void 0),this._lastLoadingScene=this.loadingScene,this._loadingScenePromise||(this._loadingScenePromise=(e=this.loadingScene)==null?void 0:e.loadAssetAsync().then(n=>n!=null)),await this._loadingScenePromise,this._isCurrentlyLoading&&((i=this.loadingScene)!=null&&i.asset))){Oi&&console.log("Add loading scene",this.loadingScene.url,this.loadingScene.asset);const n=this.loadingScene.asset;P.add(n,this.gameObject);const o=this.tryGetSceneEventListener(n);if(o!=null&&o.sceneOpened){const r=o.sceneOpened(this);r instanceof Promise&&await r}}if(this._isCurrentlyLoading){const n=this.tryGetSceneEventListener(this.gameObject);if(n&&n.sceneOpened){const o=n.sceneOpened(this);o instanceof Promise&&await o}}}async onEndLoading(){var e;if(this._isCurrentlyLoading=!1,(e=this.loadingScene)!=null&&e.asset){Oi&&console.log("Remove loading scene",this.loadingScene.url);const i=this.loadingScene.asset,n=this.tryGetSceneEventListener(i);if(typeof(n==null?void 0:n.sceneClosing)=="function"){const o=n.sceneClosing();o instanceof Promise&&await o}P.remove(i)}if(!this._isCurrentlyLoading){const i=this.tryGetSceneEventListener(this.gameObject);if(i&&i.sceneClosing){const n=i.sceneClosing();n instanceof Promise&&await n}}}tryGetSceneEventListener(e,i=0){if(!e)return null;const n=P.foreachComponent(e,o=>{const r=o;if(r.sceneClosing||r.sceneOpened)return r});if(i===0&&!n&&e.children.length)for(const o of e.children){const r=this.tryGetSceneEventListener(o,i+1);if(r)return r}return n||null}}$t([m()],vt.prototype,"autoLoadFirstScene",void 0);$t([m(de)],vt.prototype,"scenes",void 0);$t([m(de)],vt.prototype,"loadingScene",void 0);$t([m()],vt.prototype,"queryParameterName",void 0);$t([m()],vt.prototype,"useSceneName",void 0);$t([m()],vt.prototype,"clamp",void 0);$t([m()],vt.prototype,"useHistory",void 0);$t([m()],vt.prototype,"useKeyboard",void 0);$t([m()],vt.prototype,"useSwipe",void 0);$t([m()],vt.prototype,"useSceneLighting",void 0);$t([m()],vt.prototype,"useSceneBackground",void 0);$t([m()],vt.prototype,"preloadNext",void 0);$t([m()],vt.prototype,"preloadPrevious",void 0);$t([m()],vt.prototype,"preloadConcurrent",void 0);$t([m()],vt.prototype,"createMenuButtons",void 0);$t([m(Te)],vt.prototype,"sceneLoadingStart",void 0);$t([m(Te)],vt.prototype,"sceneLoadingProgress",void 0);$t([m(Te)],vt.prototype,"sceneLoaded",void 0);function $x(s){const t=s.split("/").pop(),e=t==null?void 0:t.split(".").shift();return e!=null&&e.length?e:s}class RI{constructor(t,e=1,i=1,n=2){a(this,"maxLoadAhead");a(this,"maxLoadBehind");a(this,"maxConcurrent");a(this,"_isRunning",!1);a(this,"_switcher");a(this,"_loadTasks",[]);a(this,"_maxConcurrentLoads",1);this._switcher=t,this.maxLoadAhead=e,this.maxLoadBehind=i,this.maxConcurrent=n}begin(t){if(this._isRunning)return;Oi&&console.log("Preload begin",{delay:t}),this._isRunning=!0;let e=-10,i,n;const o=this._switcher.scenes,r=Date.now()+t,l=setInterval(()=>{if(this.allLoaded()&&(Oi&&console.log("All scenes (pre-)loaded"),this.stop()),!this._isRunning){clearInterval(l);return}if(Date.now()<r||this.canLoadNewScene()===!1)return;(e===-10||e!==this._switcher.currentIndex)&&(e=this._switcher.currentIndex,n=0,i=0);const c=n%2===0;c&&(i+=1),n+=1;const h=c?this.maxLoadAhead:this.maxLoadBehind;if(i>h)return;const d=c?e+i:e-i;if(!(d<0)&&!(d<0||d>=o.length)&&!this._loadTasks.some(u=>u.index===d)){const u=o[d];Oi&&console.log("Preload scene",{roomIndex:d,searchForward:c,lastRoom:e,currentIndex:this._switcher.currentIndex,tasks:this._loadTasks.length},u==null?void 0:u.url),new OI(d,u,this._loadTasks)}},200)}stop(){this._isRunning=!1}canLoadNewScene(){return this._loadTasks.length<this._maxConcurrentLoads}allLoaded(){if(this._switcher.scenes){for(const t of this._switcher.scenes)if((t==null?void 0:t.isLoaded())===!1)return!1}return!0}}class OI{constructor(t,e,i){a(this,"index");a(this,"asset");a(this,"tasks");this.index=t,this.asset=e,this.tasks=i,i.push(this),this.awaitLoading()}async awaitLoading(){this.asset&&!this.asset.isLoaded()&&(Oi&&console.log("Preload start: "+this.asset.url,this.index),await this.asset.preload(),Oi&&console.log("Preload finished: "+this.asset.url,this.index));const t=this.tasks.indexOf(this);t>=0&&this.tasks.splice(t,1)}}function TI(){return new Promise((s,t)=>{const i=()=>{i!=null&&(document.removeEventListener("pointerdown",i),document.removeEventListener("click",i),document.removeEventListener("dragstart",i),document.removeEventListener("touchstart",i),s())};document.addEventListener("pointerdown",i),document.addEventListener("click",i),document.addEventListener("dragstart",i),document.addEventListener("touchstart",i)})}async function kI(s){await TI(),s()}var yn=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const Ot=C("debugvideo");var xr;(function(s){s[s.None=0]="None",s[s.AdjustHeight=1]="AdjustHeight",s[s.AdjustWidth=2]="AdjustWidth"})(xr||(xr={}));var po;(function(s){s[s.VideoClip=0]="VideoClip",s[s.Url=1]="Url"})(po||(po={}));var ed;(function(s){s[s.None=0]="None",s[s.AudioSource=1]="AudioSource",s[s.Direct=2]="Direct",s[s.APIOnly=3]="APIOnly"})(ed||(ed={}));var td;(function(s){s[s.CameraFarPlane=0]="CameraFarPlane",s[s.CameraNearPlane=1]="CameraNearPlane",s[s.RenderTexture=2]="RenderTexture",s[s.MaterialOverride=3]="MaterialOverride"})(td||(td={}));class zt extends j{constructor(){super();a(this,"playOnAwake",!0);a(this,"aspectMode",xr.None);a(this,"clip",null);a(this,"source",po.Url);a(this,"_url",null);a(this,"renderMode");a(this,"targetMaterialProperty");a(this,"targetMaterialRenderer");a(this,"targetTexture");a(this,"time",0);a(this,"_playbackSpeed",1);a(this,"_isLooping",!1);a(this,"_muted",!1);a(this,"_audioOutputMode",ed.Direct);a(this,"playInBackground",!0);a(this,"_crossOrigin","anonymous");a(this,"_videoElement",null);a(this,"_videoTexture",null);a(this,"_videoMaterial",null);a(this,"_isPlaying",!1);a(this,"wasPlaying",!1);a(this,"visibilityChanged",e=>{switch(document.visibilityState){case"hidden":this.playInBackground||(this.wasPlaying=this._isPlaying,this.pause());break;case"visible":this.wasPlaying&&!this._isPlaying&&this.play();break}});a(this,"_receivedInput",!1);a(this,"_overlay",null);a(this,"_targetObjects");a(this,"_updateAspectRoutineId",-1);a(this,"_hls");a(this,"onHlsAvailable",()=>{var e;Ot&&console.log("HLS: available",this.clip),!(!this.shouldUseM3U||!this.url)&&(this._hls||(this._hls=new Hls),this.videoElement.autoplay=!0,this._hls.loadSource(this.url),this._hls.attachMedia(this.videoElement),(e=this._videoElement)==null||e.play(),Ot&&console.log("HLS: loaded",this.clip))});kI(()=>{this._receivedInput=!0,this.updateVideoElementSettings()}),this._targetObjects=[],C("videoscreenspace")&&window.addEventListener("keydown",e=>{e.key==="f"&&(this.screenspace=!this.screenspace)})}get url(){return this._url}set url(e){const n=this._url!==e;this.__didAwake?n&&this.setClipURL(e??""):this._url=e}get playbackSpeed(){var e;return((e=this._videoElement)==null?void 0:e.playbackRate)??this._playbackSpeed}set playbackSpeed(e){this._playbackSpeed=e,this._videoElement&&(this._videoElement.playbackRate=e)}get isLooping(){var e;return((e=this._videoElement)==null?void 0:e.loop)??this._isLooping}set isLooping(e){this._isLooping=e,this._videoElement&&(this._videoElement.loop=e)}get currentTime(){var e;return((e=this._videoElement)==null?void 0:e.currentTime)??this.time}set currentTime(e){this._videoElement?this._videoElement.currentTime=e:this.time=e}get isPlaying(){const e=this._videoElement;if(e){if(e.currentTime>0&&!e.paused&&!e.ended&&e.readyState>e.HAVE_CURRENT_DATA)return!0;if(e.srcObject&&e.srcObject.active)return!0}return!1}get crossOrigin(){var e;return((e=this._videoElement)==null?void 0:e.crossOrigin)??this._crossOrigin}set crossOrigin(e){this._crossOrigin=e,this._videoElement&&(e!==null?this._videoElement.setAttribute("crossorigin",e):this._videoElement.removeAttribute("crossorigin"))}get videoMaterial(){return!this._videoMaterial&&!this.create(!1)?null:this._videoMaterial}get videoTexture(){return!this._videoTexture&&!this.create(!1)?null:this._videoTexture}get videoElement(){return!this._videoElement&&!this.create(!1)?null:this._videoElement}requestPictureInPicture(){return this._videoElement?this._videoElement.requestPictureInPicture():null}get muted(){var e;return((e=this._videoElement)==null?void 0:e.muted)??this._muted}set muted(e){this._muted=e,this._videoElement&&(this._videoElement.muted=e)}get currentVideo(){return this.clip}set audioOutputMode(e){e!==this._audioOutputMode&&(e===ed.AudioSource&&U()&&console.warn("VideoAudioOutputMode.AudioSource is not yet implemented"),this._audioOutputMode=e,this.updateVideoElementSettings())}get audioOutputMode(){return this._audioOutputMode}preloadVideo(){Ot&&console.log("Video Preload: "+this.name,this.clip),this.create(!1)}preload(){this.preloadVideo()}setVideo(e){this.clip=e,this.source=po.VideoClip,this._videoElement?(this._videoElement.srcObject=e,this._isPlaying&&this.play(),this.updateAspect()):this.create(this.playOnAwake)}setClipURL(e){this._url!==e&&(this._url=e,this.source=po.Url,Ot&&console.log("set url",e),this._videoElement?e.endsWith(".m3u8")||e.includes(".m3u")?this.ensureM3UCanBePlayed():(this._videoElement.src=e,this._isPlaying&&(this.stop(),this.play())):this.create(this.playOnAwake))}onEnable(){var e,i;Ot&&console.log("VideoPlayer.onEnable",po[this.source],this.clip,this.url,this),window.addEventListener("visibilitychange",this.visibilityChanged),this.playOnAwake===!0?this.create(!0):this.preloadVideo(),this.screenspace?(e=this._overlay)==null||e.start():(i=this._overlay)==null||i.stop()}onDisable(){var e;window.removeEventListener("visibilitychange",this.visibilityChanged),(e=this._overlay)==null||e.stop(),this.pause()}onDestroy(){var e;this._videoElement&&((e=this.videoElement)==null||e.remove(),this._videoElement=null),this._videoTexture&&(this._videoTexture.dispose(),this._videoTexture=null)}play(){var e,i;if(this._videoElement||this.create(!1),!this._videoElement){Ot&&console.warn("Can not play: no video element found",this);return}if(!(this._isPlaying&&!((e=this._videoElement)!=null&&e.ended)&&!((i=this._videoElement)!=null&&i.paused))){if(this._isPlaying=!0,this._receivedInput||(this._videoElement.muted=!0),this.handleBeginPlaying(!1),this.shouldUseM3U){this.ensureM3UCanBePlayed();return}Ot&&console.log("Video Play()",this.clip,this._videoElement,this.time),this._videoElement.currentTime=this.time,this._videoElement.play().catch(n=>{var o;console.log(n),Ot&&console.error("Error playing video",n,"CODE="+n.code,(o=this.videoElement)==null?void 0:o.src,this),setTimeout(()=>{this._isPlaying&&!this.destroyed&&this.activeAndEnabled&&this.play()},1e3)}),Ot&&console.log("play",this._videoElement,this.time)}}stop(){this._isPlaying=!1,this.time=0,this._videoElement&&(this._videoElement.currentTime=0,this._videoElement.pause(),Ot&&console.log("STOP",this))}pause(){var e,i;this.time=((e=this._videoElement)==null?void 0:e.currentTime)??0,this._isPlaying=!1,(i=this._videoElement)==null||i.pause(),Ot&&console.log("PAUSE",this,this.currentTime)}create(e){let i;switch(this.source){case po.VideoClip:i=this.clip;break;case po.Url:i=this.url,!(i!=null&&i.length)&&typeof this.clip=="string"&&(i=this.clip);break}return i?(this._videoElement||(Ot&&console.warn("Create VideoElement",this),this._videoElement=this.createVideoElement(),this.context.domElement.shadowRoot.prepend(this._videoElement),this.updateVideoElementStyles()),typeof i=="string"?(Ot&&console.log("Set Video src",i),this._videoElement.src=i):(Ot&&console.log("Set Video srcObject",i),this._videoElement.srcObject=i),this._videoTexture||(this._videoTexture=new xR(this._videoElement)),this._videoTexture.flipY=!1,this._videoTexture.colorSpace=rs,e&&this.handleBeginPlaying(e),Ot&&console.log("Video: handle playing done...",i,e),!0):(Ot&&console.warn("No video source set",this),!1)}updateAspect(){this.aspectMode!==xr.None&&this.startCoroutine(this.updateAspectImpl())}get screenspace(){var e;return((e=this._overlay)==null?void 0:e.enabled)??!1}set screenspace(e){var i;if(e){if(!this._videoTexture)return;this._overlay||(this._overlay=new EI(this.context)),this._overlay.add(this._videoTexture)}else(i=this._overlay)==null||i.remove(this._videoTexture);this._overlay&&(this._overlay.enabled=e)}createVideoElement(){const e=document.createElement("video");return this._crossOrigin&&e.setAttribute("crossorigin",this._crossOrigin),Ot&&console.log("created video element",e),e}handleBeginPlaying(e){var o,r;if(!this.activeAndEnabled||!this._videoElement)return;this._targetObjects.length=0;let i=this.gameObject;switch(this.renderMode){case td.MaterialOverride:i=(o=this.targetMaterialRenderer)==null?void 0:o.gameObject,i||(i=(r=P.getComponent(this.gameObject,Ve))==null?void 0:r.gameObject);break;case td.RenderTexture:console.error("VideoPlayer renderTexture not implemented yet. Please use material override instead");return}if(!i){console.error("Missing target for video material renderer",this.name,td[this.renderMode],this);return}const n=i.material;if(n){this._targetObjects.push(i),n!==this._videoMaterial&&(this._videoMaterial=n.clone(),i.material=this._videoMaterial);const l="map",c=this._videoMaterial;if(!this.targetMaterialProperty)c[l]=this._videoTexture;else switch(this.targetMaterialProperty){default:c[l]=this._videoTexture;break}}else{console.warn("Can not play video, no material found, this might be a multimaterial case which is not supported yet");return}this.updateVideoElementSettings(),this.updateVideoElementStyles(),e&&(this.shouldUseM3U&&this.ensureM3UCanBePlayed(),this.play())}updateVideoElementSettings(){if(!this._videoElement)return;this._videoElement.loop=this._isLooping,this._videoElement.currentTime=this.currentTime,this._videoElement.playbackRate=this._playbackSpeed,this._videoElement.playsInline=!0;let e=!this._receivedInput||this.audioOutputMode===ed.None;!e&&this._muted&&(e=!0),this._videoElement.muted=e,this.playOnAwake&&(this._videoElement.autoplay=!0)}updateVideoElementStyles(){this._videoElement&&(this._videoElement.style.userSelect="none",this._videoElement.style.visibility="hidden",this._videoElement.style.display="none",this.updateAspect())}*updateAspectImpl(){const e=++this._updateAspectRoutineId,i=void 0,n=this.clip;for(;e===this._updateAspectRoutineId&&this.aspectMode!==xr.None&&this.clip&&n===this.clip&&this._isPlaying;){if(!n||typeof n=="string")return;let o;for(const r of n.getVideoTracks()){const l=r.getSettings();if(l&&l.width&&l.height){o=l.width/l.height;break}else o=this.context.renderer.domElement.clientWidth/this.context.renderer.domElement.clientHeight}if(o===void 0){for(let r=0;r<10;r++)yield;if(!this.isPlaying)break;continue}if(i===o){yield;continue}for(const r of this._targetObjects){let l=1;if(r.parent){const c=pt(r.parent);l=c.x/c.y}switch(this.aspectMode){case xr.AdjustHeight:r.scale.y=1/o*r.scale.x*l;break;case xr.AdjustWidth:r.scale.x=o*r.scale.y*l;break}}for(let r=0;r<3;r++)yield}}get shouldUseM3U(){return this.url!=null&&(this.url.endsWith(".m3u8")||this.url.endsWith(".m3u"))&&this.source===po.Url}ensureM3UCanBePlayed(){if(!this.shouldUseM3U)return;let e=document.head.querySelector("script[data-hls_library]");e?globalThis.Hls?this.onHlsAvailable():e.addEventListener("load",this.onHlsAvailable):(Ot&&console.log("HLS: load script"),e=document.createElement("script"),e.dataset.hls_library="hls.js",e.src="https://cdn.jsdelivr.net/npm/hls.js@1",e.addEventListener("load",this.onHlsAvailable),document.head.append(e))}}yn([m()],zt.prototype,"playOnAwake",void 0);yn([m()],zt.prototype,"aspectMode",void 0);yn([m(URL)],zt.prototype,"clip",void 0);yn([m()],zt.prototype,"source",void 0);yn([m(URL)],zt.prototype,"url",null);yn([m()],zt.prototype,"renderMode",void 0);yn([m()],zt.prototype,"targetMaterialProperty",void 0);yn([m(Ve)],zt.prototype,"targetMaterialRenderer",void 0);yn([m(Je)],zt.prototype,"targetTexture",void 0);yn([m()],zt.prototype,"time",void 0);yn([m()],zt.prototype,"playbackSpeed",null);yn([m()],zt.prototype,"isLooping",null);yn([m()],zt.prototype,"audioOutputMode",null);class EI{constructor(t){a(this,"context");a(this,"_videos",[]);a(this,"_screenspaceModeQuad");a(this,"_isInScreenspaceMode",!1);a(this,"_input");this.context=t,this._input=new MI(this)}get enabled(){return this._isInScreenspaceMode}set enabled(t){t?this.start():this.stop()}add(t){this._videos.indexOf(t)===-1&&this._videos.push(t)}remove(t){if(!t)return;const e=this._videos.indexOf(t);e>=0&&this._videos.splice(e,1)}start(){var n;if(this._isInScreenspaceMode||this._videos.length<0)return;const t=this._videos[this._videos.length-1];if(!t)return;if(this._isInScreenspaceMode=!0,!this._screenspaceModeQuad){if(this._screenspaceModeQuad=Ka.createPrimitive(Jn.Quad,{material:new AI(t)}),!this._screenspaceModeQuad)return;this._screenspaceModeQuad.geometry.scale(2,2,2)}const e=this._screenspaceModeQuad;this.context.scene.add(e),this.updateScreenspaceMaterialUniforms();const i=e.material;i==null||i.reset(),(n=this._input)==null||n.enable(i)}stop(){var t;this._isInScreenspaceMode=!1,this._screenspaceModeQuad&&((t=this._input)==null||t.disable(),this._screenspaceModeQuad.removeFromParent())}updateScreenspaceMaterialUniforms(){var e;const t=(e=this._screenspaceModeQuad)==null?void 0:e.material;t&&(t.screenAspect=this.context.domElement.clientWidth/this.context.domElement.clientHeight)}}class MI{constructor(t){a(this,"_onResizeScreenFn");a(this,"_onKeyUpFn");a(this,"_onMouseWheelFn");a(this,"context");a(this,"overlay");a(this,"_material");a(this,"_isPinching",!1);a(this,"_lastPinch",0);this.overlay=t,this.context=t.context}enable(t){this._material=t,window.addEventListener("resize",this._onResizeScreenFn=()=>{this.overlay.updateScreenspaceMaterialUniforms()}),window.addEventListener("keyup",this._onKeyUpFn=n=>{n.key==="Escape"&&this.overlay.stop()}),window.addEventListener("wheel",this._onMouseWheelFn=n=>{this.overlay.enabled&&(t.zoom+=n.deltaY*5e-4,n.preventDefault())},{passive:!1});const e=new ce;window.addEventListener("mousemove",n=>{if(this.overlay.enabled&&this.context.input.getPointerPressed(0)){const o=new ce(n.movementX,n.movementY);o.x/=this.context.domElement.clientWidth,o.y/=this.context.domElement.clientHeight,e.set(o.x,o.y),e.multiplyScalar(t.zoom/-this.context.time.deltaTime*.01),t.offset=t.offset.add(e)}}),window.addEventListener("pointermove",n=>{this.overlay.enabled&&this.context.input.getPointerPressed(0)&&this.context.input.getTouchesPressedCount()===1&&(e.set(n.movementX,n.movementY),e.multiplyScalar(t.zoom*-this.context.time.deltaTime*.05),t.offset=t.offset.add(e))});let i=0;window.addEventListener("touchstart",n=>{if(n.touches.length<2){this.context.time.time-i<.3&&this.overlay.stop(),i=this.context.time.time;return}this._isPinching=!0,this._lastPinch=0}),window.addEventListener("touchmove",n=>{if(!this._isPinching||!this._material)return;const o=n.touches[0],r=n.touches[1],l=o.clientX-r.clientX,c=o.clientY-r.clientY,h=Math.sqrt(l*l+c*c);if(this._lastPinch!==0){const d=h-this._lastPinch;this._material.zoom-=d*.004}this._lastPinch=h}),window.addEventListener("touchend",()=>{this._isPinching=!1})}disable(){this._onResizeScreenFn&&(window.removeEventListener("resize",this._onResizeScreenFn),this._onResizeScreenFn=void 0),this._onKeyUpFn&&(window.removeEventListener("keyup",this._onKeyUpFn),this._onKeyUpFn=void 0),this._onMouseWheelFn&&(window.removeEventListener("wheel",this._onMouseWheelFn),this._onMouseWheelFn=void 0)}}class AI extends os{constructor(e){super();a(this,"_offset",new ce);this.uniforms={map:{value:e},screenAspect:{value:1},offsetScale:{value:new xe(0,0,1,1)}},this.vertexShader=`
        uniform sampler2D map;
        uniform float screenAspect;
        uniform vec4 offsetScale;
        varying vec2 vUv;

        void main() {

            gl_Position = vec4( position , 1.0 );
            vUv = uv;
            vUv.y = 1. - vUv.y;

            // fit into screen
            ivec2 res = textureSize(map, 0);
            float videoAspect = float(res.x) / float(res.y);
            float aspect = videoAspect / screenAspect;
            if(aspect >= 1.0) 
            {
                vUv.y = vUv.y * aspect;
                float offset = (1. - aspect) * .5;
                vUv.y = vUv.y + offset;
            }
            else
            {
                vUv.x = vUv.x / aspect;
                float offset = (1. - 1. / aspect) * .5;
                vUv.x = vUv.x + offset;
            }

            vUv.x -= .5;
            vUv.y -= .5;

            vUv.x *= offsetScale.z;
            vUv.y *= offsetScale.z;
            vUv.x += offsetScale.x;
            vUv.y += offsetScale.y;

            vUv.x += .5;
            vUv.y += .5;
        }

        `,this.fragmentShader=`
        uniform sampler2D map;
        varying vec2 vUv;
        void main() {
            if(vUv.x < 0. || vUv.x > 1. || vUv.y < 0. || vUv.y > 1.)
                gl_FragColor = vec4(0., 0., 0., 1.);
            else
            {
                vec4 texcolor = texture2D(map, vUv);
                gl_FragColor = texcolor;
            }
        }
        `}set screenAspect(e){this.uniforms.screenAspect.value=e,this.needsUpdate=!0}set offset(e){const i=this.uniforms.offsetScale.value;i.x=e.x,i.y=e.y,this.uniforms.offsetScale.value=i,this.needsUpdate=!0}get offset(){const e=this.uniforms.offsetScale.value;return this._offset.set(e.x,e.y),this._offset}set zoom(e){const i=this.uniforms.offsetScale.value;e<.001&&(e=.001),i.z=e,this.needsUpdate=!0}get zoom(){return this.uniforms.offsetScale.value.z}reset(){this.offset=this.offset.set(0,0),this.zoom=1,this.needsUpdate=!0}}var nu=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const Vt=C("debugscreensharing");var g_;(function(s){s[s.Screen=0]="Screen",s[s.Camera=1]="Camera",s[s.Canvas=2]="Canvas",s[s.Microphone=3]="Microphone"})(g_||(g_={}));var en;(function(s){s[s.Idle=0]="Idle",s[s.Sending=1]="Sending",s[s.Receiving=2]="Receiving"})(en||(en={}));class gl extends j{constructor(){super(...arguments);a(this,"allowStartOnClick",!0);a(this,"autoConnect",!1);a(this,"_videoPlayer");a(this,"_audioSource");a(this,"device","Screen");a(this,"deviceName");a(this,"deviceFilter");a(this,"_net");a(this,"_requestOpen",!1);a(this,"_currentStream",null);a(this,"_currentMode",en.Idle);a(this,"onJoinedRoom",async()=>{await Xs(1e3),this.autoConnect&&!this.isSending&&!this.isReceiving&&this.context.connection.isInRoom&&this.share()});a(this,"_activeShareRequest",null);a(this,"onReceiveStream",e=>{var i;((i=e.stream)==null?void 0:i.active)===!0&&this.setStream(e.stream,en.Receiving)});a(this,"onCallEnded",e=>{Vt&&console.log("CALL ENDED",this.isReceiving,this==null?void 0:this.screenspace),this.isReceiving&&(this.screenspace=!1)})}onPointerEnter(){this.context.connection.allowEditing!=!1&&this.allowStartOnClick&&this.context.input.setCursor("pointer")}onPointerExit(){this.context.connection.allowEditing!=!1&&this.allowStartOnClick&&this.context.input.unsetCursor("pointer")}onPointerClick(e){var i;if(this.context.connection.allowEditing!=!1&&this.allowStartOnClick&&!(e&&e.pointerId!==0)){if(this.isReceiving&&((i=this.videoPlayer)!=null&&i.isPlaying)){this.videoPlayer&&(this.videoPlayer.screenspace=!this.videoPlayer.screenspace);return}if(this.isSending){this.close();return}this.share()}}set videoPlayer(e){this._videoPlayer&&(this.isSending||this.isReceiving)&&this._videoPlayer.stop(),this._videoPlayer=e,this._videoPlayer&&this._currentStream&&(this.isSending||this.isReceiving)&&this._videoPlayer.setVideo(this._currentStream)}get videoPlayer(){return this._videoPlayer}get screenspace(){var e;return((e=this.videoPlayer)==null?void 0:e.screenspace)??!1}set screenspace(e){this.videoPlayer&&(this.videoPlayer.screenspace=e)}get currentScream(){return this._currentStream}get currentMode(){return this._currentMode}get isSending(){var e;return((e=this._currentStream)==null?void 0:e.active)&&this._currentMode===en.Sending}get isReceiving(){if(this._currentMode===en.Receiving){if(!this._currentStream||this._currentStream.active===!1)return!1;const e=this._currentStream.getTracks();for(const i of e)if(i.readyState==="live")return!0}return!1}get requiresVideoPlayer(){return this.device!=="Microphone"}awake(){typeof this.device=="number"&&(this.device=g_[this.device]),Vt&&console.log("Screensharing",this.name,this),Oe.registerWaitForAllowAudio(()=>{this._videoPlayer&&this._currentStream&&this._currentMode===en.Receiving&&(this._videoPlayer.playInBackground=!0,this._videoPlayer.setVideo(this._currentStream))}),this._net=new Xp(this)}onEnable(){var e,i,n;(e=this._net)==null||e.enable(),(i=this._net)==null||i.addEventListener(rt.StreamReceived,this.onReceiveStream),(n=this._net)==null||n.addEventListener(rt.StreamEnded,this.onCallEnded),this.context.connection.beginListen(se.JoinedRoom,this.onJoinedRoom),this.autoConnect&&Xs(1e3).then(()=>(this.enabled&&this.autoConnect&&!this.isReceiving&&!this.isSending&&this.context.connection.isInRoom&&this.share(),0))}onDisable(){var e,i,n;(e=this._net)==null||e.removeEventListener(rt.StreamReceived,this.onReceiveStream),(i=this._net)==null||i.removeEventListener(rt.StreamEnded,this.onCallEnded),this.context.connection.stopListen(se.JoinedRoom,this.onJoinedRoom),(n=this._net)==null||n.disable(),this.close()}_ensureVideoPlayer(){const e=new zt;e.aspectMode=xr.AdjustWidth,P.addComponent(this.gameObject,e),this._videoPlayer=e}async share(e){return this._activeShareRequest?this._activeShareRequest:(this._activeShareRequest=this.internalShare(e),this._activeShareRequest.then(()=>this._activeShareRequest=null))}async internalShare(e){if(this.context.connection.isInRoom===!1){console.warn("Can not start screensharing: requires network connection"),U()&&Me("Can not start screensharing: requires network connection. Add a SyncedRoom component or join a room first.");return}if(e!=null&&e.device&&(this.device=e.device),!this.videoPlayer&&this.requiresVideoPlayer&&(this._videoPlayer||(this._videoPlayer=P.getComponent(this.gameObject,zt)??void 0),this.videoPlayer||this._ensureVideoPlayer(),!this.videoPlayer)){console.warn("Can not share video without a videoPlayer assigned");return}this._requestOpen=!0;try{const i=(e==null?void 0:e.constraints)??{echoCancellation:!0,autoGainControl:!1},n={video:i,audio:i},o=n.video;switch(o!==void 0&&typeof o!="boolean"&&(o.width||(o.width={max:1920}),o.height||(o.height={max:1920}),o.aspectRatio||(o.aspectRatio={ideal:1.7777777778}),o.frameRate||(o.frameRate={ideal:24}),o.facingMode||(o.facingMode={ideal:"user"})),this.device){case"Camera":this.tryShareUserCamera(n,e);break;case"Screen":{if(!navigator.mediaDevices.getDisplayMedia){console.error("No getDisplayMedia support");return}const c=await navigator.mediaDevices.getDisplayMedia(n);this._requestOpen?this.setStream(c,en.Sending):Ro(c)}break;case"Canvas":const r=0,l=this.context.renderer.domElement.captureStream(r);this.setStream(l,en.Sending);break;case"Microphone":{if(!navigator.mediaDevices.getUserMedia){console.error("No getDisplayMedia support");return}n.video=!1;const c=await navigator.mediaDevices.getUserMedia(n);this._requestOpen?this.setStream(c,en.Sending):Ro(c)}break;default:console.error("Can not start screen sharing: Unknown device type",this.device)}}catch(i){if(i.name==="NotAllowedError"){console.log("Selection cancelled"),this._requestOpen=!1;return}console.error("Error opening video",i)}}close(){var e;this._requestOpen=!1,this._currentStream&&(Vt&&console.warn("Close current stream / disposing resources, stream was active?",this._currentStream.active),(e=this._net)==null||e.stopSendingStream(this._currentStream),Ro(this._currentStream),this._currentMode=en.Idle,this._currentStream=null)}setStream(e,i){var r,l,c;if(e===this._currentStream||(this.close(),!e))return;this._currentStream=e,this._requestOpen=!0,this._currentMode=i;const n=this.device!=="Microphone",o=i===en.Sending;n?(this._videoPlayer||this._ensureVideoPlayer(),this._videoPlayer?this._videoPlayer.setVideo(e):console.error("No video player assigned for video stream")):(this._audioSource||(this._audioSource=new Oe,this._audioSource.spatialBlend=0,this._audioSource.volume=1,this.gameObject.addComponent(this._audioSource)),o||(Vt&&console.log("PLAY",e.getAudioTracks()),this._audioSource.volume=1,(r=this._audioSource)==null||r.play(e))),o&&((l=this._net)==null||l.startSendingStream(e)),o&&(this._videoPlayer&&(this._videoPlayer.muted=!0),(c=this._audioSource)==null||c.stop());for(const h of e.getTracks())h.addEventListener("ended",()=>{Vt&&console.log("Track ended",h),this.close()}),Vt&&h.kind==="video"&&console.log(o?"Video ‚Üí":"Video ‚Üê",h.getSettings())}async tryShareUserCamera(e,i){const n=(await navigator.mediaDevices.enumerateDevices()).filter(r=>r.kind==="videoinput");Vt&&console.log(`Request camera. These are your kind:videoinput devices:
`,n);let o=!1;for(const r of n)try{if(!this._requestOpen){Vt&&console.log("Camera selection cancelled");break}if(r.kind!=="videoinput"){Vt&&console.log("Skipping non-video device",r);continue}const l=r.deviceId;if((i==null?void 0:i.deviceId)!=null||(i==null?void 0:i.deviceFilter)!=null){if((i==null?void 0:i.deviceId)!==void 0&&l!==i.deviceId){Vt&&console.log("Skipping device due to options.deviceId: "+r.label+"; "+r.deviceId);continue}if(i!=null&&i.deviceFilter&&i.deviceFilter(r)===!1){Vt&&console.log("Skipping device due to options.deviceFilter: "+r.label+"; "+r.deviceId);continue}}else if(this.deviceFilter)if(this.deviceFilter(r)===!1){Vt&&console.log("Skipping device due to ScreenShare.deviceFilter: "+r.label+"; "+r.deviceId);continue}else Vt&&console.log("Selected device by filter",r);else if(this.deviceName){const d=r.label.toLowerCase(),u=this.deviceName.toLowerCase(),f=d.includes(u),p=r.deviceId===this.deviceName;if(!f&&!p){Vt&&console.log("Skipping device due to ScreenShare.deviceName: "+r.label+"; "+r.deviceId);continue}else Vt&&console.log("Selected device by name",r)}e.video!==!1&&((typeof e.video>"u"||typeof e.video=="boolean")&&(e.video={}),e.video.deviceId=l),o=!0;const h=await navigator.mediaDevices.getUserMedia(e).catch(d=>(console.error("Failed to get user media",d),null));if(h===null)continue;this._requestOpen?(this.setStream(h,en.Sending),Vt&&console.log("Selected camera",r)):(Ro(h),Vt&&console.log("Camera selection cancelled"));break}catch(l){if(l.message==="Failed to allocate videosource"||l.message==="Could not start video source"){Me("Failed to start video: Try another camera (Code "+l.code+")"),console.warn(l);continue}else console.error("Failed to get user media",l.message,l.code,l)}!o&&U()&&(Me("No camera found for sharing. Please connect a camera (see console for more information)"),console.warn("No camera found for sharing. Please connect a camera",n,this.deviceName,"Using deviceFilter? "+this.deviceFilter!=null,"Using options? "+i!=null,"Using deviceName? "+this.deviceName!=null,"Using options.deviceId? "+(i==null?void 0:i.deviceId)!=null,"Using options.deviceFilter? "+(i==null?void 0:i.deviceFilter)!=null))}}nu([m()],gl.prototype,"allowStartOnClick",void 0);nu([m()],gl.prototype,"autoConnect",void 0);nu([m(zt)],gl.prototype,"videoPlayer",null);nu([m()],gl.prototype,"device",void 0);nu([m()],gl.prototype,"deviceName",void 0);var U1=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o},$l;(function(s){s[s.ShadowMask=0]="ShadowMask",s[s.Additive=1]="Additive",s[s.Occluder=2]="Occluder"})($l||($l={}));class gm extends j{constructor(){super(...arguments);a(this,"mode",$l.ShadowMask);a(this,"shadowColor",new Ae(0,0,0,1));a(this,"targetMesh")}start(){if(this.gameObject instanceof Z)this.gameObject instanceof Z&&this.gameObject.material&&(this.gameObject.material=this.gameObject.material.clone(),this.targetMesh=this.gameObject,this.targetMesh.receiveShadow=!0);else{const e=Ka.createPrimitive(Jn.Quad,{name:"ShadowCatcher",material:new Vi({color:10066329,roughness:1,metalness:0,transparent:!0})});e.receiveShadow=!0,e.geometry.rotateX(-Math.PI/2),this.gameObject.add(e),this.targetMesh=e}if(!this.targetMesh){console.warn("ShadowCatcher: no mesh to apply shadow catching to. Groups are currently not supported.");return}switch(this.targetMesh.layers.set(2),this.mode){case $l.ShadowMask:this.applyShadowMaterial();break;case $l.Additive:this.applyLightBlendMaterial();break;case $l.Occluder:this.applyOccluderMaterial();break}}applyLightBlendMaterial(){if(!this.targetMesh)return;const e=this.targetMesh.material;e.blending=gw,this.applyMaterialOptions(e),e.onBeforeCompile=i=>{i.fragmentShader=i.fragmentShader.replace("vec3 outgoingLight = totalDiffuse + totalSpecular + totalEmissiveRadiance;",`vec3 outgoingLight = totalDiffuse + totalSpecular + totalEmissiveRadiance;
            // diffuse-only lighting with overdrive to somewhat compensate
            // for the loss of indirect lighting and to make it more visible.
            vec3 direct = (reflectedLight.directDiffuse + reflectedLight.directSpecular) * 6.6;
            float max = max(direct.r, max(direct.g, direct.b));
            
            // early out - we're simply returning direct lighting and some alpha based on it so it can 
            // be blended onto the scene.
            gl_FragColor = vec4(direct, max);
            return;
            `)},e.userData.isLightBlendMaterial=!0}applyShadowMaterial(){if(this.targetMesh)if(this.targetMesh.material.type!=="ShadowMaterial"){const e=new ow;e.color=this.shadowColor,e.opacity=this.shadowColor.alpha,this.applyMaterialOptions(e),this.targetMesh.material=e,e.userData.isShadowCatcherMaterial=!0}else{const e=this.targetMesh.material;e.color=this.shadowColor,e.opacity=this.shadowColor.alpha,this.applyMaterialOptions(e),e.userData.isShadowCatcherMaterial=!0}}applyOccluderMaterial(){if(this.targetMesh){let e=this.targetMesh.material;if(!e){const i=new Ue;this.targetMesh.material=i,e=i}e.depthWrite=!0,e.stencilWrite=!0,e.colorWrite=!1,this.gameObject.renderOrder=-100}}applyMaterialOptions(e){e&&(e.depthWrite=!1,e.stencilWrite=!1)}}U1([m()],gm.prototype,"mode",void 0);U1([m(Ae)],gm.prototype,"shadowColor",void 0);var su=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const Cn=C("debugskybox");Bb("skybox-image");Bb("environment-image");function Wx(s,t,e,i,n){const o=new Go;o.allowDrop=!1,o.allowNetworking=!1,o.background=e,o.environment=i,P.addComponent(s.scene,o);const r=l=>{typeof l=="string"&&(Cn&&console.log(n,"CHANGED TO",l),o.setSkybox(l))};return gO(s.domElement,n,r),o.addEventListener("destroy",()=>{Cn&&console.log("Destroyed attribute remote skybox",n),yO(s.domElement,n,r)}),o.setSkybox(t)}const np=new Array;be.registerCallback(me.ContextCreationStart,s=>{var n;const t=s.context,e=t.domElement.getAttribute("skybox-image")||t.domElement.getAttribute("background-image"),i=t.domElement.getAttribute("environment-image");if(e){Cn&&console.log("Creating remote skybox to load "+e),((n=t.mainCameraComponent)==null?void 0:n.clearFlags)!==Ui.Skybox&&console.warn('"skybox-image"/"background-image" attribute has no effect: camera clearflags are not set to "Skybox"');const o=Wx(t,e,!0,!1,"skybox-image");np.push(o)}if(i){Cn&&console.log("Creating remote environment to load "+i);const o=Wx(t,i,!1,!0,"environment-image");np.push(o)}});be.registerCallback(me.ContextCreationStart,()=>Promise.all(np).finally(()=>{np.length=0}));function N1(){return globalThis.NEEDLE_ENGINE_SKYBOX_TEXTURES||(globalThis.NEEDLE_ENGINE_SKYBOX_TEXTURES=new Array),globalThis.NEEDLE_ENGINE_SKYBOX_TEXTURES}function Vx(s){const e=N1().find(i=>i.src===s);return e?(Cn&&console.log("Skybox: Found previously loaded texture for "+s),e.texture):null}async function II(s){const t=await s;eC(t,!0),Ne(t)}function DI(s,t){const e=N1();for(;e.length>5;){const i=e.shift();i&&II(i.texture)}t.then(i=>eC(i,!1)),e.push({src:s,texture:t})}class Go extends j{constructor(){super(...arguments);a(this,"url");a(this,"allowDrop",!0);a(this,"background",!0);a(this,"environment",!0);a(this,"allowNetworking",!0);a(this,"_loader");a(this,"_prevUrl");a(this,"_prevLoadedEnvironment");a(this,"_prevEnvironment",null);a(this,"_prevBackground",null);a(this,"validTextureTypes",[".ktx2",".hdr",".exr",".jpg",".jpeg",".png"]);a(this,"onDragOverEvent",e=>{if(this.allowDrop&&e.dataTransfer)for(const i of e.dataTransfer.types)(i==="text/uri-list"||i==="Files")&&e.preventDefault()});a(this,"onDrop",e=>{var i,n,o,r;if(this.allowDrop&&e.dataTransfer){for(const l of e.dataTransfer.types)if(Cn&&console.log(l),l==="text/uri-list"){const c=e.dataTransfer.getData(l);Cn&&console.log(l,c);let h=(n=(i=new RegExp(/polyhaven.com\/asset_img\/.+?\/(?<name>.+)\.png/).exec(c))==null?void 0:i.groups)==null?void 0:n.name;if(h||(h=(r=(o=new RegExp(/polyhaven\.com\/a\/(?<name>.+)/).exec(c))==null?void 0:o.groups)==null?void 0:r.name),Cn&&console.log(h),h){const d="https://dl.polyhaven.org/file/ph-assets/HDRIs/exr/1k/"+h+"_1k.exr";console.log(`[Remote Skybox] Setting skybox from url: ${d}`),e.preventDefault(),this.setSkybox(d);break}else if(this.isValidTextureType(c)){console.log("[Remote Skybox] Setting skybox from url: "+c),e.preventDefault(),this.setSkybox(c);break}else{console.warn(`[RemoteSkybox] Unknown url ${c}. If you want to load a skybox from a url, make sure it is a valid image url. Url must end with${this.validTextureTypes.join(", ")}.`);const d=new CustomEvent("dropped-unknown-url",{detail:{sender:this,event:e,url:c,apply:u=>{e.preventDefault(),this.setSkybox(u)}}});this.dispatchEvent(d)}}else if(l=="Files"){const c=e.dataTransfer.files.item(0);if(Cn&&console.log(l,c),!c)continue;if(!this.isValidTextureType(c.name)){console.warn(`[RemoteSkybox]: File "${c.name}" is not supported. Supported files are ${this.validTextureTypes.join(", ")}`);return}if(Vx(c.name)===null){const h=new Blob([c]),d=URL.createObjectURL(h);e.preventDefault(),this.setSkybox(d,c.name)}else e.preventDefault(),this.setSkybox(c.name);break}}})}onEnable(){this.setSkybox(this.url),this.registerDropEvents()}onDisable(){var e;this.context.scene.environment===this._prevLoadedEnvironment&&(this.context.scene.environment=this._prevEnvironment,Se.backgroundShouldBeTransparent(this.context)||(this.context.scene.background=this._prevBackground),this._prevLoadedEnvironment=void 0),this.unregisterDropEvents(),(e=this.context.mainCameraComponent)==null||e.applyClearFlags()}urlChangedSyncField(){this.allowNetworking&&this.url&&this.isRemoteTexture(this.url)&&this.setSkybox(this.url)}async setSkybox(e,i){var r;if(!this.activeAndEnabled||(e=LI(e,this.environment,this.background),!e))return!1;if(i??(i=e),this.isValidTextureType(i)||console.warn("Potentially invalid skybox url",i,"on",this.name),Cn&&console.log("Set remote skybox url: "+e),this._prevUrl===e&&this._prevLoadedEnvironment)return this.applySkybox(),!0;(r=this._prevLoadedEnvironment)==null||r.dispose(),this._prevLoadedEnvironment=void 0,this._prevUrl=e;const n=await this.loadTexture(e,i);if(!n||!this.enabled)return!1;this.url=e;const o=e.lastIndexOf("/");return n.name=e.substring(o>=0?o+1:0),this._loader instanceof ec&&(n.colorSpace=rs),this._prevLoadedEnvironment=n,this.applySkybox(),!0}async loadTexture(e,i){var d,u,f,p,g;if(!e)return Promise.resolve(null);i??(i=e);const n=Vx(i);if(n){const y=await n;if(((u=(d=y.source)==null?void 0:d.data)==null?void 0:u.length)>0||(g=(p=(f=y.source)==null?void 0:f.data)==null?void 0:p.data)!=null&&g.length)return y}const o=i.endsWith(".exr"),r=i.endsWith(".hdr"),l=i.endsWith(".ktx2");if(o)this._loader instanceof _f||(this._loader=new _f);else if(r)this._loader instanceof ly||(this._loader=new ly);else if(l){if(!(this._loader instanceof qR)){const{ktx2Loader:y}=M_(this.context.renderer);this._loader=y}}else this._loader instanceof ec||(this._loader=new ec);Cn&&console.log("Loading skybox: "+e);const c=this._loader.loadAsync(e);return DI(i,c),await c}applySkybox(){var i;const e=this._prevLoadedEnvironment;e&&(e instanceof wR||e instanceof SR||(e.mapping=CR,e.needsUpdate=!0),this.context.scene.background!==e&&(this._prevBackground=this.context.scene.background),this.context.scene.environment!==e&&(this._prevEnvironment=this.context.scene.environment),Cn&&console.log("Set remote skybox",this.url,!Se.backgroundShouldBeTransparent(this.context)),this.environment&&(this.context.scene.environment=e),this.background&&!Se.backgroundShouldBeTransparent(this.context)&&(this.context.scene.background=e),((i=this.context.mainCameraComponent)==null?void 0:i.backgroundBlurriness)!==void 0&&(this.context.scene.backgroundBlurriness=this.context.mainCameraComponent.backgroundBlurriness))}isRemoteTexture(e){return e.startsWith("http://")||e.startsWith("https://")}isValidTextureType(e){for(const i of this.validTextureTypes)if(e.endsWith(i))return!0;return!1}registerDropEvents(){this.unregisterDropEvents(),this.context.domElement.addEventListener("dragover",this.onDragOverEvent),this.context.domElement.addEventListener("drop",this.onDrop)}unregisterDropEvents(){this.context.domElement.removeEventListener("dragover",this.onDragOverEvent),this.context.domElement.removeEventListener("drop",this.onDrop)}}su([M1(Go.prototype.urlChangedSyncField),m(URL)],Go.prototype,"url",void 0);su([m()],Go.prototype,"allowDrop",void 0);su([m()],Go.prototype,"background",void 0);su([m()],Go.prototype,"environment",void 0);su([m()],Go.prototype,"allowNetworking",void 0);function LI(s,t,e){const i=t&&!e;switch(s==null?void 0:s.toLowerCase()){case"studio":return i?"https://cdn.needle.tools/static/skybox/modelviewer-Neutral-small.hdr":"https://cdn.needle.tools/static/skybox/modelviewer-Neutral.hdr";case"blurred-skybox":return i?"https://cdn.needle.tools/static/skybox/blurred-skybox-small.exr":"https://cdn.needle.tools/static/skybox/blurred-skybox.exr";case"quicklook-ar":return i?"https://cdn.needle.tools/static/skybox/QuickLook-ARMode-small.exr":"https://cdn.needle.tools/static/skybox/QuickLook-ARMode.exr";case"quicklook":return i?"https://cdn.needle.tools/static/skybox/QuickLook-ObjectMode-small.exr":"https://cdn.needle.tools/static/skybox/QuickLook-ObjectMode.exr"}return s===void 0?null:s}var ym=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const i0=class extends j{constructor(){super(...arguments);a(this,"target",null);a(this,"followFactor",.1);a(this,"rotateFactor",.1);a(this,"positionAxes",Bl.All);a(this,"flipForward",!1);a(this,"_firstUpdate",!0)}onBeforeRender(){this.updateNow(!1)}updateNow(e){if(!(!this.target||this.target===this.gameObject)){if(this.followFactor>0){const i=ae(this.target),n=this._firstUpdate||e?1:W.clamp01(this.context.time.deltaTime*this.followFactor),o=this.worldPosition;this.positionAxes&Bl.X&&(o.x=W.lerp(o.x,i.x,n)),this.positionAxes&Bl.Y&&(o.y=W.lerp(o.y,i.y,n)),this.positionAxes&Bl.Z&&(o.z=W.lerp(o.z,i.z,n)),this.worldPosition=o}if(this.rotateFactor>0){const i=Le(this.target);this.flipForward&&i.premultiply(i0._invertForward);const n=this._firstUpdate||e?1:W.clamp01(this.context.time.deltaTime*this.rotateFactor);this.worldQuaternion=this.worldQuaternion.slerp(i,n)}this._firstUpdate=!1}}};let Hs=i0;a(Hs,"_invertForward",new H().setFromAxisAngle(new x(0,1,0),Math.PI));ym([m(F)],Hs.prototype,"target",void 0);ym([m()],Hs.prototype,"followFactor",void 0);ym([m()],Hs.prototype,"rotateFactor",void 0);ym([m()],Hs.prototype,"positionAxes",void 0);var ou=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const id=C("debugspatialtrigger"),Hx=new Nr,Gx=new Nr;function jI(s,t){return Hx.mask=s,Gx.mask=t,Hx.test(Gx)}class Fo extends j{constructor(){super(...arguments);a(this,"triggerMask",0);a(this,"onEnter");a(this,"onStay");a(this,"onExit");a(this,"currentIntersected",[]);a(this,"lastIntersected",[])}start(){id&&console.log(this.name,this.triggerMask,this)}update(){this.currentIntersected.length=0;for(const e of Na.triggers)jI(e.triggerMask,this.triggerMask)&&e.test(this.gameObject)&&this.currentIntersected.push(e);for(let e=this.lastIntersected.length-1;e>=0;e--){const i=this.lastIntersected[e];this.currentIntersected.indexOf(i)<0&&(this.onExitTrigger(i),this.lastIntersected.splice(e,1))}for(const e of this.currentIntersected)this.lastIntersected.indexOf(e)<0&&this.onEnterTrigger(e),this.onStayTrigger(e);this.lastIntersected.length=0,this.lastIntersected.push(...this.currentIntersected)}onEnterTrigger(e){var i;id&&console.log("ENTER TRIGGER",this.name,e.name,this,e),e.raiseOnEnterEvent(this),(i=this.onEnter)==null||i.invoke()}onExitTrigger(e){var i;id&&console.log("EXIT TRIGGER",this.name,e.name),e.raiseOnExitEvent(this),(i=this.onExit)==null||i.invoke()}onStayTrigger(e){var i;e.raiseOnStayEvent(this),(i=this.onStay)==null||i.invoke()}}ou([m()],Fo.prototype,"triggerMask",void 0);ou([m(Te)],Fo.prototype,"onEnter",void 0);ou([m(Te)],Fo.prototype,"onStay",void 0);ou([m(Te)],Fo.prototype,"onExit",void 0);const pd=class extends j{constructor(){super(...arguments);a(this,"triggerMask");a(this,"boxHelper")}start(){id&&console.log(this.name,this.triggerMask,this)}onEnable(){var e;pd.triggers.push(this),this.boxHelper||(this.boxHelper=P.addComponent(this.gameObject,rn),(e=this.boxHelper)==null||e.showHelper(null,id))}onDisable(){pd.triggers.splice(pd.triggers.indexOf(this),1)}test(e){return this.boxHelper?this.boxHelper.isInBox(e)??!1:!1}raiseOnEnterEvent(e){P.foreachComponent(this.gameObject,i=>{i!==e&&i instanceof Fo&&i.onEnterTrigger(this)},!1)}raiseOnStayEvent(e){P.foreachComponent(this.gameObject,i=>{i!==e&&i instanceof Fo&&i.onStayTrigger(this)},!1)}raiseOnExitEvent(e){P.foreachComponent(this.gameObject,i=>{i!==e&&i instanceof Fo&&i.onExitTrigger(this)},!1)}};let Na=pd;a(Na,"triggers",[]);ou([m()],Na.prototype,"triggerMask",void 0);var BI=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o},Ec;(function(s){s[s.FirstPerson=0]="FirstPerson",s[s.ThirdPerson=1]="ThirdPerson"})(Ec||(Ec={}));const an=C("debugspectator");class Fb extends j{constructor(){super(...arguments);a(this,"cam",null);a(this,"useKeys",!0);a(this,"_mode",Ec.FirstPerson);a(this,"orbit",null);a(this,"_handler");a(this,"eventSub_WebXRRequestStartEvent",null);a(this,"eventSub_WebXRStartEvent",null);a(this,"eventSub_WebXREndEvent",null);a(this,"_debug");a(this,"_networking")}get mode(){return this._mode}set mode(e){this._mode=e}get isSpectating(){var e;return((e=this._handler)==null?void 0:e.currentTarget)!==void 0}isSpectatingUser(e){var i;return((i=this.target)==null?void 0:i.userId)===e}isFollowedBy(e){var i;return(i=this.followers)==null?void 0:i.includes(e)}get followers(){return this._networking.followers}stopSpectating(){if(this.context.isInXR){this.followSelf();return}this.target=void 0}get localId(){return this.context.connection.connectionId??"local"}set target(e){var i;if(this._handler){const n=(i=this._handler.currentTarget)==null?void 0:i.userId,o=this.context.players.getPlayerView(this.localId);e===void 0||this.context.isInXR===!1&&(o==null?void 0:o.currentObject)===e.currentObject?this._handler.currentTarget!==void 0&&(this._handler.disable(),P.setActive(this.gameObject,!1),this.orbit&&(this.orbit.enabled=!0),this._networking.onSpectatedObjectChanged(e,n)):this._handler.currentTarget!==e&&(this._handler.set(e),P.setActive(this.gameObject,!0),this.orbit&&(this.orbit.enabled=!1),this._networking.onSpectatedObjectChanged(e,n))}}get target(){var e;return(e=this._handler)==null?void 0:e.currentTarget}requestAllFollowMe(){this._networking.onRequestFollowMe()}get isSpectatingSelf(){var e,i;return this.isSpectating&&((e=this.target)==null?void 0:e.currentObject)===((i=this.context.players.getPlayerView(this.localId))==null?void 0:i.currentObject)}awake(){if(this._debug=new UI(this.context,this),this._networking=new WI(this.context,this),this._networking.awake(),P.setActive(this.gameObject,!1),this.cam=P.getComponent(this.gameObject,Se),!this.cam){console.warn("SpectatorCamera: Spectator camera needs camera component on the same object.",this);return}!this._handler&&this.cam&&(this._handler=new FI(this.context,this.cam,this)),this.orbit=P.getComponent(this.context.mainCamera,ke)}onDestroy(){var e,i;this.stopSpectating(),(e=this._handler)==null||e.destroy(),(i=this._networking)==null||i.destroy()}isSupportedPlatform(){const e=window.navigator.userAgent,i=/Windows|MacOS/.test(e),n=/Windows NT/.test(e)&&/Edg/.test(e)&&!/Win64/.test(e);return i&&!n}onBeforeXR(e){this.isSupportedPlatform()&&P.setActive(this.gameObject,!0)}onEnterXR(e){this.isSupportedPlatform()&&(an&&console.log(this.context.mainCamera),this.context.mainCamera&&this.followSelf())}onLeaveXR(e){var i,n;this.context.removeCamera(this.cam),P.setActive(this.gameObject,!1),this.orbit&&(this.orbit.enabled=!0),(i=this._handler)==null||i.set(void 0),(n=this._handler)==null||n.disable(),this.isSpectatingSelf&&this.stopSpectating()}followSelf(){this.target=this.context.players.getPlayerView(this.context.connection.connectionId),this.target||(this.context.players.setPlayerView(this.localId,this.context.mainCamera,Io.Headset),this.target=this.context.players.getPlayerView(this.localId)),an&&console.log("Follow self",this.target)}onAfterRender(){var d,u,f;if(!this.cam)return;const e=this.context.renderer,i=e.xr.enabled;if(!e.xr.isPresenting&&!((d=this._handler)!=null&&d.currentTarget))return;(u=this._handler)==null||u.update(this._mode);const n=e.getRenderTarget();let o=null;const r=e.state;if(!n){if(!e.state.bindFramebuffer||!r.bindXRFramebuffer)return;o=e._framebuffer,r.bindXRFramebuffer(null)}this.setAvatarFlagsBeforeRender();const l=this.context.mainCameraComponent;if(l){const p=l.backgroundColor;p&&e.setClearColor(p,p.alpha),this.cam.backgroundColor=p,this.cam.clearFlags=l.clearFlags,this.cam.nearClipPlane=l.nearClipPlane,this.cam.farClipPlane=l.farClipPlane}else e.setClearColor(new ue(1,1,1));e.setRenderTarget(null),e.xr.enabled=!1;const c=(f=this.cam)==null?void 0:f.threeCamera;this.context.updateAspect(c);const h=e.xr.isPresenting;e.xr.isPresenting=!1,e.setSize(this.context.domWidth,this.context.domHeight),e.render(this.context.scene,c),e.xr.isPresenting=h,e.xr.enabled=i,n?e.setRenderTarget(n):r.bindXRFramebuffer&&r.bindXRFramebuffer(o),this.resetAvatarFlags()}setAvatarFlagsBeforeRender(){const e=this._mode===Ec.FirstPerson;for(const i of It.instances)if(i.avatar&&"isLocalAvatar"in i.avatar&&"flags"in i.avatar){let n=Tn.All;this.isSpectatingSelf&&(n=e&&i.avatar.isLocalAvatar?Tn.FirstPerson:Tn.ThirdPerson);const o=i.avatar.flags;if(!o)continue;for(const r of o)r.UpdateVisible(n)}}resetAvatarFlags(){var e;for(const i of It.instances)if(i.avatar&&"flags"in i.avatar){const n=i.avatar.flags;if(!n)continue;for(const o of n)"isLocalAvatar"in i.avatar&&((e=i.avatar)!=null&&e.isLocalAvatar)?o.UpdateVisible(Tn.FirstPerson):o.UpdateVisible(Tn.ThirdPerson)}}}BI([m()],Fb.prototype,"useKeys",void 0);class FI{constructor(t,e,i){a(this,"context");a(this,"cam");a(this,"spectator");a(this,"follow");a(this,"target");a(this,"view");a(this,"currentObject");this.context=t,this.cam=e,this.spectator=i}get currentTarget(){return this.view}set(t){const e=t==null?void 0:t.currentObject;if(!e){this.spectator.stopSpectating();return}e!==this.currentObject&&(this.currentObject=e,this.view=t,this.follow||(this.follow=P.addComponent(this.cam.gameObject,Hs)),this.target||(this.target=new F),e.add(this.target),this.follow.enabled=!0,this.follow.target=this.target,an&&console.log("FOLLOW",e),this.context.isInXR?this.context.removeCamera(this.cam):this.context.setCurrentCamera(this.cam))}disable(){an&&console.log("STOP FOLLOW",this.currentObject),this.view=void 0,this.currentObject=void 0,this.context.removeCamera(this.cam),this.follow&&(this.follow.enabled=!1)}destroy(){var t;(t=this.target)==null||t.removeFromParent(),this.follow&&P.destroy(this.follow)}update(t){var n,o,r,l,c,h;if(((n=this.currentTarget)==null?void 0:n.isConnected)===!1||((o=this.currentTarget)==null?void 0:o.removed)===!0){an&&console.log("Target disconnected or timeout",this.currentTarget),this.spectator.stopSpectating();return}this.currentTarget&&((r=this.currentTarget)==null?void 0:r.currentObject)!==this.currentObject&&(an&&console.log("Target changed",this.currentObject,"to",this.currentTarget.currentObject),this.set(this.currentTarget));const e=this.context.mainCamera;if(e){const d=this.cam.threeCamera;(d.near!==e.near||d.far!==e.far)&&(d.near=e.near,d.far=e.far,d.updateProjectionMatrix())}const i=(l=this.follow)==null?void 0:l.target;if(!(!i||!this.follow)){switch(t){case Ec.FirstPerson:((c=this.view)==null?void 0:c.viewDevice)!==Io.Browser?(this.follow.followFactor=5,this.follow.rotateFactor=5):(this.follow.followFactor=50,this.follow.rotateFactor=50),i.position.set(0,0,0);break;case Ec.ThirdPerson:this.follow.followFactor=3,this.follow.rotateFactor=2,i.position.set(0,.5,1.5);break}this.follow.flipForward=!1,((h=this.view)==null?void 0:h.viewDevice)!==Io.Browser?i.quaternion.copy(zI):i.quaternion.identity()}}}const zI=new H().setFromAxisAngle(new x(0,1,0),Math.PI);class UI{constructor(t,e){a(this,"context");a(this,"spectator");this.context=t,this.spectator=e,console.log("[Spectator Camera] Click other avatars or cameras to follow them. Press ESC to exit spectator mode."),this.context.domElement.addEventListener("keydown",n=>{if(!this.spectator.useKeys)return;n.key==="Escape"&&this.spectator.stopSpectating()});let i=0;this.context.input.addEventListener(ye.PointerDown,n=>{i=this.context.time.time}),this.context.input.addEventListener(ye.PointerUp,n=>{const o=this.context.time.time-i;o>1?this.spectator.stopSpectating():this.context.input.getPointerClicked(0)&&o<.3&&this.trySelectObject()})}trySelectObject(){const t=new $o;t.setMask(16777215);const e=this.context.physics.raycast(t);if(an&&console.log(...e),e!=null&&e.length)for(const i of e){if(i.distance<.2)continue;const n=i.object,o=P.getComponentInParent(n,It),r=o==null?void 0:o.connectionId;if(r){const l=this.context.players.getPlayerView(r);this.spectator.target=l,an&&console.log("spectate",r,o);break}}}}class NI{constructor(t,e,i){a(this,"guid");a(this,"dontSave",!0);a(this,"targetUserId");a(this,"stoppedFollowing");this.guid=t,this.targetUserId=e,this.stoppedFollowing=i}}class $I{constructor(t,e){a(this,"guid");a(this,"userId");this.guid=t.guid,this.userId=e}}class WI{constructor(t,e){a(this,"followers",[]);a(this,"context");a(this,"spectator");a(this,"_followerEventMethod");a(this,"_requestFollowMethod");a(this,"_joinedRoomMethod");a(this,"_lastRequestFollowUser");a(this,"_enforceFollowInterval");this.context=t,this.spectator=e,this._followerEventMethod=this.onFollowerEvent.bind(this),this._requestFollowMethod=this.onRequestFollowEvent.bind(this),this._joinedRoomMethod=this.onUserJoinedRoom.bind(this)}awake(){this.context.connection.beginListen("spectator-follower-changed",this._followerEventMethod),this.context.connection.beginListen("spectator-request-follow",this._requestFollowMethod),this.context.connection.beginListen(se.JoinedRoom,this._joinedRoomMethod),this.context.domElement.addEventListener("keydown",t=>{this.spectator.useKeys&&(t.key==="f"?this.onRequestFollowMe():t.key==="Escape"&&this.onRequestFollowMe(!0))})}destroy(){this.context.connection.stopListen("spectator-follower-changed",this._followerEventMethod),this.context.connection.stopListen("spectator-request-follow",this._requestFollowMethod),this.context.connection.stopListen(se.JoinedRoom,this._joinedRoomMethod)}onSpectatedObjectChanged(t,e){if(an&&console.log(this.context.connection.connectionId,"onSpectatedObjectChanged",t,e),this.context.connection.connectionId){const i=(t==null?void 0:t.userId)===void 0,n=i?e:t==null?void 0:t.userId,o=new NI(this.context.connection.connectionId,n,i);this.context.connection.send("spectator-follower-changed",o)}}onRequestFollowMe(t=!1){if(an&&console.log("Request follow",this.context.connection.connectionId),this.context.connection.connectionId){this.spectator.stopSpectating();const e=t?void 0:this.context.connection.connectionId,i=new $I(this.spectator,e);this.context.connection.send("spectator-request-follow",i)}}onUserJoinedRoom(){C("followme")&&this.onRequestFollowMe()}onFollowerEvent(t){const e=t.targetUserId,i=t.guid;if(an&&console.log(t),e===this.context.connection.connectionId)if(t.stoppedFollowing){const n=this.followers.indexOf(i);n!==-1&&(this.followers.splice(n,1),this.removeDisconnectedFollowers(),console.log(i,"unfollows you",this.followers.length))}else this.followers.includes(i)||(this.followers.push(i),this.removeDisconnectedFollowers(),console.log(i,"follows you",this.followers.length))}removeDisconnectedFollowers(){for(let t=this.followers.length-1;t>=0;t--){const e=this.followers[t];this.context.connection.userIsInRoom(e)===!1&&this.followers.splice(t,1)}}onRequestFollowEvent(t){if(this._lastRequestFollowUser=t,t.userId===this.context.connection.connectionId)this.spectator.stopSpectating();else if(t.userId===void 0)this.spectator.stopSpectating();else{const e=this.context.players.getPlayerView(t.userId);if(e)this.spectator.target=e;else return an&&console.warn("Could not find view",t.userId),this.enforceFollow(),!1}return!0}enforceFollow(){this._enforceFollowInterval||(this._enforceFollowInterval=setInterval(()=>{this._lastRequestFollowUser===void 0||this._lastRequestFollowUser.userId&&this.spectator.isFollowedBy(this._lastRequestFollowUser.userId)?(clearInterval(this._enforceFollowInterval),this._enforceFollowInterval=void 0):(an&&console.log("REQUEST FOLLOW AGAIN",this._lastRequestFollowUser.userId),this.onRequestFollowEvent(this._lastRequestFollowUser))},1e3))}}class As{constructor(){a(this,"bb",null);a(this,"bb_pos",0)}__init(t,e){return this.bb_pos=t,this.bb=e,this}static getRootAsSyncedCameraModel(t,e){return(e||new As).__init(t.readInt32(t.position())+t.position(),t)}static getSizePrefixedRootAsSyncedCameraModel(t,e){return t.setPosition(t.position()+F_),(e||new As).__init(t.readInt32(t.position())+t.position(),t)}userId(t){const e=this.bb.__offset(this.bb_pos,4);return e?this.bb.__string(this.bb_pos+e,t):null}guid(t){const e=this.bb.__offset(this.bb_pos,6);return e?this.bb.__string(this.bb_pos+e,t):null}dontSave(){const t=this.bb.__offset(this.bb_pos,8);return t?!!this.bb.readInt8(this.bb_pos+t):!1}pos(t){const e=this.bb.__offset(this.bb_pos,10);return e?(t||new Ba).__init(this.bb_pos+e,this.bb):null}rot(t){const e=this.bb.__offset(this.bb_pos,12);return e?(t||new Ba).__init(this.bb_pos+e,this.bb):null}static startSyncedCameraModel(t){t.startObject(5)}static addUserId(t,e){t.addFieldOffset(0,e,0)}static addGuid(t,e){t.addFieldOffset(1,e,0)}static addDontSave(t,e){t.addFieldInt8(2,+e,0)}static addPos(t,e){t.addFieldStruct(3,e,0)}static addRot(t,e){t.addFieldStruct(4,e,0)}static endSyncedCameraModel(t){return t.endObject()}static finishSyncedCameraModelBuffer(t,e){t.finish(e)}static finishSizePrefixedSyncedCameraModelBuffer(t,e){t.finish(e,void 0,!0)}}var VI=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const sp="SCAM";oS(sp,As.getRootAsSyncedCameraModel);const Ji=new jd;class HI{constructor(t,e){a(this,"userId");a(this,"guid");this.guid=e,this.userId=t}send(t,e){if(t){Ji.clear();const i=Ji.createString(this.guid),n=Ji.createString(this.userId);As.startSyncedCameraModel(Ji),As.addGuid(Ji,i),As.addUserId(Ji,n);const o=ae(t),r=Ap(t);As.addPos(Ji,Ba.createVec3(Ji,o.x,o.y,o.z)),As.addRot(Ji,Ba.createVec3(Ji,r.x,r.y,r.z));const l=As.endSyncedCameraModel(Ji);Ji.finish(l,sp),e.sendBinary(Ji.asUint8Array())}}}const yp=class extends j{constructor(){super(...arguments);a(this,"cameraPrefab",null);a(this,"_lastWorldPosition");a(this,"_lastWorldQuaternion");a(this,"_model",null);a(this,"_needsUpdate",!0);a(this,"_lastUpdateTime",0);a(this,"remoteCams",{});a(this,"userToCamMap",{});a(this,"_camTimeoutInSeconds",10);a(this,"_receiveCallback",null)}getCameraObject(e){const i=this.userToCamMap[e];return i?this.remoteCams[i].obj:null}async awake(){this._lastWorldPosition=this.worldPosition.clone(),this._lastWorldQuaternion=this.worldQuaternion.clone(),this.cameraPrefab&&("uri"in this.cameraPrefab&&(this.cameraPrefab=await this.cameraPrefab.instantiate(this.gameObject)),this.cameraPrefab&&"isObject3D"in this.cameraPrefab&&(this.cameraPrefab.visible=!1))}onEnable(){this._receiveCallback=this.context.connection.beginListenBinary(sp,this.onReceivedRemoteCameraInfoBin.bind(this))}onDisable(){this.context.connection.stopListenBinary(sp,this._receiveCallback)}update(){for(const o in this.remoteCams){const r=this.remoteCams[o],l=this.context.time.realtimeSinceStartup-r.lastUpdate;if(!r||l>this._camTimeoutInSeconds){U()&&console.log("Remote cam timeout",o),r!=null&&r.obj&&P.destroy(r.obj),delete this.remoteCams[o],r&&delete this.userToCamMap[r.userId],yp.instances.push(r),this.context.players.removePlayerView(r.userId,Io.Browser);continue}}if(this.context.isInXR)return;const e=this.context.mainCamera;if(e===null){this.enabled=!1;return}if(!this.context.connection.isConnected||this.context.connection.connectionId===null)return;this._model===null&&(this._model=new HI(this.context.connection.connectionId,this.context.connection.connectionId+"_camera"));const i=ae(e),n=Le(e);(i.distanceTo(this._lastWorldPosition)>.001||n.angleTo(this._lastWorldQuaternion)>.01)&&(this._needsUpdate=!0),this._lastWorldPosition.copy(i),this._lastWorldQuaternion.copy(n),!((!this._needsUpdate||this.context.time.frameCount%2!==0)&&!(this.context.time.realtimeSinceStartup-this._lastUpdateTime>this._camTimeoutInSeconds*.5))&&(this._lastUpdateTime=this.context.time.realtimeSinceStartup,this._needsUpdate=!1,this._model.send(e,this.context.connection),this.context.isInXR||this.context.players.setPlayerView(this.context.connection.connectionId,e,Io.Browser))}onReceivedRemoteCameraInfoBin(e){const i=e.guid();if(!i)return;const n=e.userId();if(!n||!this.context.connection.userIsInRoom(n)||!this.cameraPrefab)return;let o=this.remoteCams[i];if(!o)if("isObject3D"in this.cameraPrefab){const h=new Js;h.context=this.context;const d=P.instantiate(this.cameraPrefab,h);o=this.remoteCams[i]={obj:d,lastUpdate:this.context.time.realtimeSinceStartup,userId:n},o.obj.visible=!0,this.gameObject.add(d),this.userToCamMap[n]=i,yp.instances.push(o);const u=P.getOrAddComponent(d,It);u.connectionId=n,u.avatar=d}else return;const r=o.obj;this.context.players.setPlayerView(n,r,Io.Browser),o.lastUpdate=this.context.time.realtimeSinceStartup,is.markDirty(r);const l=e.pos();l&&_c(r,l.x(),l.y(),l.z());const c=e.rot();c&&Ip(r,c.x(),c.y(),c.z())}};let hc=yp;a(hc,"instances",[]);VI([m([F,de])],hc.prototype,"cameraPrefab",void 0);var ea=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const Kg="view",Jg=C("debugsyncedroom");class no extends j{constructor(){super(...arguments);a(this,"roomName","");a(this,"urlParameterName","room");a(this,"joinRandomRoom");a(this,"requireRoomParameter",!1);a(this,"autoRejoin",!0);a(this,"createJoinButton",!0);a(this,"createViewOnlyButton",!1);a(this,"_lastJoinedRoom");a(this,"_roomPrefix","");a(this,"_lastPingTime",0);a(this,"_lastRoomTime",-1);a(this,"_userWantsToBeInARoom",!1);a(this,"_roomButton");a(this,"_roomButtonIconJoin");a(this,"_roomButtonIconLeave");a(this,"updateRoomButtonState",()=>{var e,i;this._roomButton&&(this.context.connection.isInRoom?(this._roomButton.title="Leave the networked room",this._roomButton.textContent="Leave Room",(e=this._roomButtonIconJoin)==null||e.remove(),this._roomButton.prepend(this._roomButtonIconLeave)):(this._roomButton.title="Create or join a networked room",this._roomButton.textContent="Join Room",(i=this._roomButtonIconLeave)==null||i.remove(),this._roomButton.prepend(this._roomButtonIconJoin)))});a(this,"_viewOnlyButton");a(this,"onCreateViewOnlyButton",()=>{if(!this._viewOnlyButton){const e=document.createElement("button");this._viewOnlyButton=e,e.classList.add("view-only-button"),e.setAttribute("priority","90"),e.onclick=()=>{var n;const i=this.getViewOnlyUrl();i!=null&&i.length?navigator.canShare({url:i})?(n=navigator.share({url:i}))==null||n.catch(o=>{console.warn(o)}):(navigator.clipboard.writeText(i),tt("View only URL copied to clipboard")):Me("Could not create view only URL")},e.title="Copy the view only URL: A page accessed by the view only URL can not be modified by visiting users.",e.textContent="Share View URL",e.prepend(li("visibility"))}this.context.menu.appendChild(this._viewOnlyButton)})}get currentRoomName(){const e=C(Kg);return e||C(this.urlParameterName)}set roomPrefix(e){this._roomPrefix=e}get roomPrefix(){return this._roomPrefix}awake(){var e;this.joinRandomRoom===void 0&&((e=this.roomName)==null?void 0:e.length)<=0&&(this.joinRandomRoom=!0),Jg&&console.log(`SyncedRoom roomName:${this.roomName}, urlParamName:${this.urlParameterName}, joinRandomRoom:${this.joinRandomRoom}`)}onEnable(){const e=C(Kg);if(e&&typeof e=="string"&&e.length>0){console.log("Join as viewer"),this.context.connection.joinRoom(e,!0);return}if(this.tryJoinRoom(),this.createJoinButton){const i=this.createRoomButton();this.context.menu.appendChild(i)}this.createViewOnlyButton&&this.onEnableViewOnlyButton()}onDisable(){var e;(e=this._roomButton)==null||e.remove(),this.onDisableViewOnlyButton(),this.roomName&&this.roomName.length>0&&this.context.connection.leaveRoom(this.roomName)}onDestroy(){this.destroyRoomButton()}tryJoinRandomRoom(){this.setRandomRoomUrlParameter(),this.tryJoinRoom()}tryJoinRoom(e=0){var n;e===void 0&&(e=0);let i=!1;if(((n=this.urlParameterName)==null?void 0:n.length)>0){const o=C(this.urlParameterName);if(o&&(typeof o=="string"||typeof o=="number")){i=!0;const r=uO(o.toString());this.roomName=r}else if(this.joinRandomRoom&&(console.log("No room name found in url, generating random one"),this.setRandomRoomUrlParameter(),e<1))return this.tryJoinRoom(e+1)}else this.joinRandomRoom&&(this.roomName===null||this.roomName===void 0||this.roomName.length<=0)&&(this.roomName=this.generateRoomName());return this.requireRoomParameter&&!i?((Jg||U())&&console.warn('[SyncedRoom] Missing required room parameter "'+this.urlParameterName+`" in url - will not connect.
To allow joining a room without a query parameter you can set "requireRoomParameter" to false.`),!1):(this.context.connection.isConnected||this.context.connection.connect(),this._lastJoinedRoom=this.roomName,this._roomPrefix&&(this.roomName=this._roomPrefix+this.roomName),this.roomName.length<=0?(console.warn(`[SyncedRoom] Room name is not set so we can not join a networked room.
Please choose one of the following options to fix this:
A) Set a room name in the SyncedRoom component
B) Set a room name in the URL parameter "?`+this.urlParameterName+`=my_room"
C) Set "joinRandomRoom" to true`),!1):(Jg&&console.log("Join "+this.roomName),this._userWantsToBeInARoom=!0,this.context.connection.joinRoom(this.roomName),!0))}update(){this.context.connection.isConnected&&(this.context.time.time-this._lastPingTime>3&&(this._lastPingTime=this.context.time.time,this.context.connection.sendPing()),this.context.connection.isInRoom&&(this._lastRoomTime=this.context.time.time)),this._lastRoomTime>0&&this.context.time.time-this._lastRoomTime>.3&&(this._lastRoomTime=-1,this.autoRejoin?this._userWantsToBeInARoom&&(console.log("Disconnected from networking backend - attempt reconnecting now"),this.tryJoinRoom()):U()&&console.warn("You are not connected to a room anymore (possibly because the tab was inactive for too long and the server kicked you?)"))}getViewOnlyUrl(){if(this.context.connection.isConnected&&this.context.connection.currentRoomViewId){const e=window.location.search,i=new URLSearchParams(e);return i.has(this.urlParameterName)&&i.delete(this.urlParameterName),i.set(Kg,this.context.connection.currentRoomViewId),window.location.origin+window.location.pathname+"?"+i.toString()}return null}setRandomRoomUrlParameter(){const e=Tp(),i=this.generateRoomName();C(this.urlParameterName)?e.set(this.urlParameterName,i):e.append(this.urlParameterName,i),Tw(i,e)}generateRoomName(){let e="";for(let i=0;i<6;i++)e+=Math.floor(Math.random()*10).toFixed(0);return e}createRoomButton(){if(this._roomButton)return this._roomButton;const e=document.createElement("button");return this._roomButton=e,e.classList.add("create-room-button"),e.setAttribute("priority","90"),e.onclick=()=>{if(this.context.connection.isInRoom)this.urlParameterName&&bf(this.urlParameterName,null),this.context.connection.leaveRoom(),this._userWantsToBeInARoom=!1;else{if(this.urlParameterName){const i=C(this.urlParameterName);(!i||i===!0)&&(this._lastJoinedRoom?bf(this.urlParameterName,this._lastJoinedRoom):this.setRandomRoomUrlParameter())}this.tryJoinRoom()}},this._roomButtonIconJoin=li("group"),this._roomButtonIconLeave=li("group_off"),this.updateRoomButtonState(),this.context.connection.beginListen(se.JoinedRoom,this.updateRoomButtonState),this.context.connection.beginListen(se.LeftRoom,this.updateRoomButtonState),e}destroyRoomButton(){this.context.connection.stopListen(se.JoinedRoom,this.updateRoomButtonState),this.context.connection.stopListen(se.LeftRoom,this.updateRoomButtonState)}onEnableViewOnlyButton(){this.context.connection.isConnected?this.onCreateViewOnlyButton():(this.context.connection.stopListen(se.JoinedRoom,this.onCreateViewOnlyButton),this.context.connection.beginListen(se.JoinedRoom,this.onCreateViewOnlyButton))}onDisableViewOnlyButton(){var e;this.context.connection.stopListen(se.JoinedRoom,this.onCreateViewOnlyButton),(e=this._viewOnlyButton)==null||e.remove()}}ea([m()],no.prototype,"roomName",void 0);ea([m()],no.prototype,"urlParameterName",void 0);ea([m()],no.prototype,"joinRandomRoom",void 0);ea([m()],no.prototype,"requireRoomParameter",void 0);ea([m()],no.prototype,"autoRejoin",void 0);ea([m()],no.prototype,"createJoinButton",void 0);ea([m()],no.prototype,"createViewOnlyButton",void 0);ea([m()],no.prototype,"roomPrefix",null);function GI(){const s=C("testwindowcount")||0;s&&s>0&&qI(s)}function qI(s){if(C("testwindow"))return null;const t=new URL(window.location.href);p0(t.searchParams,SA,1),p0(t.searchParams,"testwindow",1);const e=t.toString(),i=[];window.onbeforeunload=()=>{for(const c of i)c.close()};const n=.05,o=128;let r=0,l=0;for(let c=0;c<s;c++){r*o+o*.01>=window.innerWidth&&(l+=1,r=0);const h=r*(o*(1+n))+window.screenLeft,d=l*(o*(1+n))+window.screenTop+90+60*l;r+=1;const u=window.open(e,"test window "+c,`popup=yes width=${o} height=${o} top=${d} left=${h}`);if(!u){console.warn("Failed to open window");continue}i.push(u),u.onload=()=>{u.onbeforeunload=()=>{for(let f=0;f<i.length;f++){const p=i[f];p!==u&&p.close()}i.length=0}}}return i}class $1 extends j{awake(){GI()}}class W1 extends j{constructor(){super(...arguments);a(this,"transformsPerFrame",10);a(this,"interval",0);a(this,"useFlatbuffers",!0);a(this,"builder",null);a(this,"models",null)}awake(){if(this.useFlatbuffers)this.context.connection.beginListenBinary(kd,e=>{});else{this.models=[];for(let e=0;e<this.transformsPerFrame;e++)this.models.push(new V1(this.context.connection.connectionId+"_simulatedTransform_"+e,this))}}update(){if(this.context.connection.isConnected){if(this.useFlatbuffers){if(!this.context.connection.connectionId||this.context.time.frameCount%this.interval!==0)return;this.builder===null&&(this.builder=new jd(1024));const e=this.builder;for(let i=0;i<this.transformsPerFrame;i++){e.clear();const n=NC(this.context.connection.connectionId,this);this.context.connection.sendBinary(n)}}else if(this.models)for(let e=0;e<this.models.length;e++){const i=this.models[e];i.dontSave=!0,i.update(this,null),this.context.connection.send("TestSimulateUserData-"+e,i)}}}}class V1{constructor(t,e){a(this,"guid");a(this,"fast",!1);a(this,"position");a(this,"rotation");a(this,"velocity");a(this,"dontSave");this.guid=t,this.position={x:0,y:0,z:0},this.rotation={x:0,y:0,z:0,w:0},this.update(e,null)}isValid(){return this.fast!==void 0||this.position!==void 0||this.rotation!==void 0||this.velocity!==void 0}update(t,e){const i=t.worldPosition;this.position.x=i.x,this.position.y=i.y,this.position.z=i.z;const n=t.worldQuaternion;if(this.rotation.x=n.x,this.rotation.y=n.y,this.rotation.z=n.z,this.rotation.w=n.w,this.fast=!1,e){const o=e.getVelocity();this.velocity===void 0&&(this.velocity={x:0,y:0,z:0}),this.velocity.x=o.x,this.velocity.y=o.y,this.velocity.z=o.z}}}a(V1,"temp",new x);var _m=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const XI=C("debugsignals");class bm{constructor(){a(this,"guid")}}_m([m()],bm.prototype,"guid",void 0);class ru{constructor(){a(this,"signal");a(this,"reaction")}}_m([m(bm)],ru.prototype,"signal",void 0);_m([m(Te)],ru.prototype,"reaction",void 0);const Rs=class extends j{constructor(){super(...arguments);a(this,"events")}static invoke(e){if(Rs.receivers[e]){const i=Rs.receivers[e];if(!i)return;for(const n of i)n.invoke(e)}}awake(){XI&&console.log("SignalReceiver awake",this)}onEnable(){if(this.events)for(const e of this.events)Rs.receivers[e.signal.guid]||(Rs.receivers[e.signal.guid]=[]),Rs.receivers[e.signal.guid].push(this)}onDisable(){if(this.events){for(const e of this.events)if(Rs.receivers[e.signal.guid]){const i=Rs.receivers[e.signal.guid].indexOf(this);i>=0&&Rs.receivers[e.signal.guid].splice(i,1)}}}invoke(e){if(!this.events||!Array.isArray(this.events))return;const i=typeof e=="object"?e.guid:e;for(const n of this.events)if(n.signal.guid===i)try{if(n.reaction){if(!n.reaction.invoke){console.warn("Missing invoke - possibly a serialization error",n,this);continue}}else{console.warn("Missing reaction for signal",n,this);continue}n.reaction.invoke()}catch(o){console.error(o)}}};let Fr=Rs;a(Fr,"receivers",{});_m([m(ru)],Fr.prototype,"events",void 0);var tn;(function(s){s.Activation="ActivationTrack",s.Animation="AnimationTrack",s.Audio="AudioTrack",s.Control="ControlTrack",s.Marker="MarkerTrack",s.Signal="SignalTrack"})(tn||(tn={}));var ws;(function(s){s[s.None=0]="None",s[s.Hold=1]="Hold",s[s.Loop=2]="Loop",s[s.PingPong=3]="PingPong",s[s.Continue=4]="Continue"})(ws||(ws={}));var y_;(function(s){s.Signal="SignalEmitter"})(y_||(y_={}));const Ns=C("debugtimeline");class vm{constructor(){a(this,"director");a(this,"track")}get muted(){return this.track.muted}set muted(t){var e;t!==this.track.muted&&(this.track.muted=t,(e=this.onMuteChanged)==null||e.call(this))}*forEachClip(t=!1){var e;if((e=this.track)!=null&&e.clips)if(t)for(let i=this.track.clips.length-1;i>=0;i--)yield this.track.clips[i];else for(const i of this.track.clips)yield i}getClipTime(t,e){return e.clipIn+(t-e.start)*e.timeScale}getClipTimeNormalized(t,e){return(t-e.start)/e.duration}evaluateWeight(t,e,i,n=!0){if(e<0||e>=i.length)return 0;const o=i[e];if(n||t>=o.start&&t<=o.end){let r=1;const l=!1;if(o.easeInDuration>0){const c=Math.min((t-o.start)/o.easeInDuration,1);r*=c}if(o.easeOutDuration>0&&!l){const c=Math.min((o.end-t)/o.easeOutDuration,1);r*=c}return r}return 0}}class QI{constructor(t){a(this,"clip");a(this,"rootPositionOffset");a(this,"rootQuaternionOffset");a(this,"rootStartPosition");a(this,"rootEndPosition");a(this,"rootStartQuaternion");a(this,"rootEndQuaternion");const e=t.getClip();this.clip=e;const i=t.getRoot(),n=i.name+".position",o=i.name+".quaternion";Ns&&console.log(e.name,e.tracks,n);for(const r of e.tracks)if(!(r.times.length<=0)){if(r.name.endsWith(n))this.rootStartPosition=new x().fromArray(r.values,0),this.rootEndPosition=new x().fromArray(r.values,r.values.length-3),this.rootPositionOffset=this.rootEndPosition.clone().sub(this.rootStartPosition),Ns&&console.log(this.rootPositionOffset);else if(r.name.endsWith(o)&&(this.rootStartQuaternion=new H().fromArray(r.values,0),this.rootEndQuaternion=new H().fromArray(r.values,r.values.length-4),this.rootQuaternionOffset=this.rootEndQuaternion.clone().multiply(this.rootStartQuaternion),Ns)){const l=new di().setFromQuaternion(this.rootQuaternionOffset);console.log("ROT",l)}}}get hasOffsets(){return this.rootPositionOffset!==void 0||this.rootQuaternionOffset!==void 0}}class zb extends vm{constructor(){super(...arguments);a(this,"models",[]);a(this,"trackOffset");a(this,"target");a(this,"mixer");a(this,"clips",[]);a(this,"actions",[]);a(this,"weight",1);a(this,"_actionOffsets",[]);a(this,"_didBind",!1);a(this,"_animator",null);a(this,"_useclipOffsets",!0);a(this,"_totalOffsetPosition",new x);a(this,"_totalOffsetRotation",new H);a(this,"_totalOffsetPosition2",new x);a(this,"_totalOffsetRotation2",new H);a(this,"_summedPos",new x);a(this,"_tempPos",new x);a(this,"_summedRot",new H);a(this,"_tempRot",new H);a(this,"_clipRotQuat",new H)}onDisable(){var e;(e=this.mixer)==null||e.stopAllAction()}onDestroy(){this.director.context.animations.unregisterAnimationMixer(this.mixer)}onStateChanged(){this._animator&&Jv(this._animator.gameObject,this,this.director.isPlaying)}createHooks(e,i){var d,u;if(((d=i.tracks)==null?void 0:d.length)<=0){console.warn("No tracks in AnimationClip",i);return}const n=i.tracks[0].name.split("."),o=n[n.length-2],r=o+".position",l=o+".quaternion";let c=!1,h=!1;for(const f of i.tracks)f.name.endsWith(r)?(c=!0,this.createPositionInterpolant(i,e,f)):f.name.endsWith(l)&&(h=!0,this.createRotationInterpolant(i,e,f));if(!c||!h){const f=(u=this.mixer)==null?void 0:u.getRoot(),p=i.tracks[0],g=p.name.lastIndexOf("."),y=p.name.substring(0,g),b=y.substring(y.lastIndexOf(".")+1),_=f.getObjectByName(b);if(_)if(c){if(!h){const v=i.tracks[0].name.substring(0,g)+".quaternion";Ns&&console.warn("Create quaternion track",b,_);const S=_.quaternion,T=new RR(v,[0,i.duration],[S.x,S.y,S.z,S.w,S.x,S.y,S.z,S.w]);i.tracks.push(T),this.createRotationInterpolant(i,e,T)}}else{const v=y+".position";Ns&&console.warn("Create position track",b,_);const S=_.position,T=new PR(v,[0,i.duration],[S.x,S.y,S.z,S.x,S.y,S.z]);i.tracks.push(T),this.createPositionInterpolant(i,e,T)}}}bind(){if(!this._didBind){this._didBind=!0,Ns&&console.log(this.models),this.mixer?this.target=this.mixer.getRoot():console.warn("No mixer was assigned to animation track");for(const e of this.actions){const i=new QI(e);this._actionOffsets.push(i)}this.target&&(this._animator=P.getComponent(this.target,pi)??null,this._animator&&Jv(this._animator.gameObject,this,!0));for(const e of this.models){const i=e.asset,n=i.position,o=i.rotation;n&&n.x!==void 0&&(n.isVector3||(i.position=new x(n.x,n.y,n.z)),o.isQuaternion||(i.rotation=new H(o.x,o.y,o.z,o.w)))}this.ensureTrackOffsets()}}ensureTrackOffsets(){if(this.trackOffset){const e=this.trackOffset.position;e&&(e.isVector3||(this.trackOffset.position=new x(e.x,e.y,e.z)));const i=this.trackOffset.rotation;i&&(i.isQuaternion||(this.trackOffset.rotation=new H(i.x,i.y,i.z,i.w)))}}evaluate(e){var c,h,d,u,f,p,g;if(this.track.muted||!this.mixer)return;this.bind(),this._totalOffsetPosition.set(0,0,0),this._totalOffsetRotation.set(0,0,0,1),this._totalOffsetPosition2.set(0,0,0),this._totalOffsetRotation2.set(0,0,0,1);let i=0,n=0,o=!1,r=!1,l=0;for(let y=0;y<this.clips.length;y++){const b=this.models[y],_=this.actions[y],v=b.asset;_.weight=0;const S=e>=b.start&&e<=b.end,T=b.preExtrapolationMode,O=b.postExtrapolationMode,M=y<this.clips.length-1?this.models[y+1]:null;let k=S,B=!1;if(!k&&!o&&b.end<e&&O!==ws.None?(!M||M.start>e)&&(k=!0,o=!0):y==0&&!k&&!r&&b.start>e&&T!==ws.None&&(!M||M.start<e)&&(k=!0,B=!0,r=!0),k){let I=this.weight;I*=this.evaluateWeight(e,y,this.models,k),I*=this.director.weight;let E=S;if(B)switch(T){case ws.Hold:break;case ws.Loop:e+=b.start,E=!0;break;default:e+=b.start,E=!0;break}let L=this.getClipTime(e,b),V=0;const A=v.duration;if(B&&T===ws.Hold&&(L=0),E){if(v.loop)for(V+=Math.floor(L/(A+1e-6));L>A;)L-=A}else if(!S&&o)switch(O){case ws.Hold:L=this.getClipTime(b.end,b);break;case ws.Loop:L%=A;break;case ws.PingPong:const q=Math.floor(L/A)%2!==0;L%=A,q&&(L=A-L);break}b.reversed===!0?_.time=_.getClip().duration-L:_.time=L,_.timeScale=0;const D=Math.max(0,I);if(_.weight=D,l+=D,_.clampWhenFinished=!1,_.isRunning()||_.play(),this._useclipOffsets){const N=i==0?this._totalOffsetPosition:this._totalOffsetPosition2,q=i==0?this._totalOffsetRotation:this._totalOffsetRotation2;i<1&&(n=1-I),i+=1;const Y=this._summedPos.set(0,0,0),ie=this._tempPos.set(0,0,0),he=this._summedRot.identity(),Pe=this._tempRot.identity(),He=v.rotation;He&&(this._clipRotQuat.identity(),this._clipRotQuat.slerp(He,I));const gt=this._actionOffsets[y];if(gt.hasOffsets)for(let lt=0;lt<V;lt++)gt.rootPositionOffset?ie.copy(gt.rootPositionOffset):ie.set(0,0,0),ie.applyQuaternion(he),this._clipRotQuat&&ie.applyQuaternion(this._clipRotQuat),gt.rootQuaternionOffset&&(Pe.copy(gt.rootQuaternionOffset),he.multiply(Pe)),Y.add(ie);this._clipRotQuat&&q.multiply(this._clipRotQuat),q.multiply(he),v.position&&Y.add(v.position),N.add(Y)}}}if(this._useclipOffsets&&(this._totalOffsetPosition.lerp(this._totalOffsetPosition2,n),this._totalOffsetRotation.slerp(this._totalOffsetRotation2,n)),this.__mixerError===void 0&&(Ns||U())&&((h=(c=this._animator)==null?void 0:c.runtimeAnimatorController)!=null&&h.mixer)&&this.mixer!==((u=(d=this._animator)==null?void 0:d.runtimeAnimatorController)==null?void 0:u.mixer)&&(this.__mixerError=!0,console.error("AnimationTrack mixer is not shared with the animator controller - this might result in the timeline to not animate properly. Please report a bug to the Needle Engine team!",this)),(f=this._animator)!=null&&f.runtimeAnimatorController){const y=Math.max(0,1-l);(g=(p=this._animator)==null?void 0:p.runtimeAnimatorController)==null||g.update(y)}else this.mixer.update(e)}createRotationInterpolant(e,i,n){var c;const o=n.createInterpolant.bind(n),r=new H;this.ensureTrackOffsets();const l=(c=this.trackOffset)==null?void 0:c.rotation;n.createInterpolant=()=>{const h=o(),d=h.evaluate.bind(h);return h.evaluate=u=>{var p;const f=d(u);if(r.set(f[0],f[1],f[2],f[3]),r.premultiply(this._totalOffsetRotation),l&&r.premultiply(l),this.director.animationCallbackReceivers)for(const g of this.director.animationCallbackReceivers)(p=g==null?void 0:g.onTimelineRotation)==null||p.call(g,this.director,this.target,u,r);return f[0]=r.x,f[1]=r.y,f[2]=r.z,f[3]=r.w,f},h}}createPositionInterpolant(e,i,n){var d,u;const o=n.createInterpolant.bind(n),r=new x;this.ensureTrackOffsets();const l=(d=this.trackOffset)==null?void 0:d.rotation,c=(u=this.trackOffset)==null?void 0:u.position;let h;n.createInterpolant=()=>{const f=o(),p=f.evaluate.bind(f);return f.evaluate=g=>{var b,_,v;const y=p(g);if(r.set(y[0],y[1],y[2]),i.removeStartOffset&&(h===void 0?(h=null,h=(_=(b=this._actionOffsets.find(S=>S.clip===e))==null?void 0:b.rootStartPosition)==null?void 0:_.clone()):h!=null&&h.isVector3&&r.sub(h)),r.applyQuaternion(this._totalOffsetRotation),r.add(this._totalOffsetPosition),l&&r.applyQuaternion(l),c&&(r.x-=c.x,r.y+=c.y,r.z+=c.z),this.director.animationCallbackReceivers)for(const S of this.director.animationCallbackReceivers)(v=S==null?void 0:S.onTimelinePosition)==null||v.call(S,this.director,this.target,g,r);return y[0]=r.x,y[1]=r.y,y[2]=r.z,y},f}}}const YI=C("mutetimeline"),Jl=class extends vm{constructor(){super(...arguments);a(this,"models",[]);a(this,"listener");a(this,"audio",[]);a(this,"audioContextTimeOffset",[]);a(this,"lastTime",0);a(this,"audioSource");a(this,"_audioLoader",null);a(this,"_playableDirectorResumed",!1)}getAudioFilePath(e){const i=this.director.sourceId;return Ya(i,e)}onAllowAudioChanged(e){for(let i=0;i<this.models.length;i++){const n=this.models[i];this.audio[i].setVolume(e?n.asset.volume:0)}}addModel(e){const i=new OR(this.listener);this.audio.push(i);const n=e;n._didTriggerPlay=!1,this.models.push(n)}onDisable(){for(const e of this.audio)e.isPlaying&&e.stop();for(const e of this.models)e._didTriggerPlay=!1}onDestroy(){for(const e of this.audio)e.source&&(e==null||e.disconnect());this.audio.length=0}onMuteChanged(){if(this.muted)for(let e=0;e<this.audio.length;e++){const i=this.audio[e];i!=null&&i.isPlaying&&i.stop()}}stop(){for(let e=0;e<this.audio.length;e++){const i=this.audio[e];i!=null&&i.isPlaying&&i.stop()}for(const e of this.models)e._didTriggerPlay=!1}onPauseChanged(){for(let e=0;e<this.audio.length;e++){const i=this.audio[e];i!=null&&i.isPlaying&&i.stop()}this._playableDirectorResumed=this.director.isPlaying}evaluate(e){if(YI||this.track.muted||this.director.speed<0)return;const i=this.director.context.application.muted,n=this._playableDirectorResumed;this._playableDirectorResumed=!1;const o=i?.1:0;for(let r=0;r<this.models.length;r++){const l=this.models[r],c=this.audio[r],h=l.asset;if((!c||!c.buffer)&&this.isInTimeRange(l,e-1,e+1)&&this.handleAudioLoading(l,c),Oe.userInteractionRegistered!==!1&&!(c===null||!c.buffer))if(c.playbackRate=this.director.context.time.timeScale*this.director.speed,c.loop=h.loop,e>=l.start&&e<=l.end&&e<this.director.duration){if(!c.isPlaying||!this.director.isPlaying)(n||!l._didTriggerPlay&&this.lastTime<e)&&(l.duration*l.timeScale>.3?c.offset=l.clipIn+(e-l.start)*l.timeScale:c.offset=0,Ns&&console.log("Timeline Audio ("+this.track.name+") play with offset "+c.offset+" - "+l.asset.clip),c.play(o),l._didTriggerPlay=!0);else{const u=l.clipIn+(e-l.start)*l.timeScale,f=c.context.currentTime-c._startedAt+c.offset;Math.abs(u-f)>.3&&(c.offset=u,c.stop(),c.play(o))}let d=h.volume;if(this.track.volume!==void 0&&(d*=this.track.volume),i&&(d=0),l.easeInDuration>0){const u=Math.min((e-l.start)/l.easeInDuration,1);d*=u}if(l.easeOutDuration>0){const u=Math.min((l.end-e)/l.easeOutDuration,1);d*=u}c.setVolume(d*this.director.weight)}else l._didTriggerPlay=!1,this.director.isPlaying&&c.isPlaying&&c.stop()}this.lastTime=e}loadAudio(e,i=0,n=0){let o=null;const r=e-n,l=e+i;for(const c of this.models)if(this.isInTimeRange(c,r,l)){const h=this.audio[this.models.indexOf(c)],d=this.handleAudioLoading(c,h);d!==null&&(o===null&&(o=[]),o.push(d))}return o!==null?Promise.all(o):null}isInTimeRange(e,i,n){return i<=e.start&&n>=e.end||i>=e.start&&i<=e.end||n>=e.start&&n<=e.end}static dispose(){Jl._audioBuffers.clear()}handleAudioLoading(e,i){this._audioLoader||(this._audioLoader=new ry);const n=this.getAudioFilePath(e.asset.clip);if(Jl._audioBuffers.get(n)){const r=Jl._audioBuffers.get(n);return r.then(l=>{l&&i.setBuffer(l)}),r}Ns&&console.warn("LOAD audio track",n,this.director.sourceId);const o=new Promise((r,l)=>{this._audioLoader.load(n,c=>{i.setBuffer(c),r(c)},void 0,c=>{console.error("Error loading audio",c),r(null)})});return Jl._audioBuffers.set(n,o),o}};let dc=Jl;a(dc,"_audioBuffers",new Map);class op extends vm{constructor(){super(...arguments);a(this,"models",[]);a(this,"didTrigger",[]);a(this,"receivers",[])}evaluate(e){var n;if(this.track.muted)return;const i=this.director.context.time.deltaTime*1.5;for(let o=0;o<this.models.length;o++){const r=this.models[o],l=this.didTrigger[o],c=r.time-e;let h=!1;if(r.retroActive)h=c<=1e-6;else{const d=Math.abs(c);(d===0||d>=1e-5&&d<i)&&(h=!0)}if(h){if(!l)if(Ns&&console.log("Trigger signal",e,r.time,r),this.didTrigger[o]=!0,((n=this.receivers)==null?void 0:n.length)<=0)Fr.invoke(r.asset);else for(const d of this.receivers)d&&d.invoke(r.asset)}else r.emitOnce||(this.didTrigger[o]=!1)}}}class Ub extends vm{constructor(){super(...arguments);a(this,"models",[]);a(this,"timelines",[]);a(this,"_previousActiveModel",null)}resolveSourceObjects(e){for(let i=this.models.length-1;i>=0;i--){const o=this.models[i].asset;if(!o.sourceObject||typeof o.sourceObject!="object"){console.log("no source object, removing model",i,o),this.models.splice(i,1);continue}else{const r=P.getComponent(o.sourceObject,Gs);this.timelines.push(r),r&&o.updateDirector&&(r.playOnAwake=!1)}}}evaluate(e){var i;this._previousActiveModel=null;for(let n=0;n<this.models.length;n++){const o=this.models[n],r=o.asset;if(e>=o.start&&e<=o.end){this._previousActiveModel=o;const l=this.getClipTime(e,o);if(r.controlActivation){const c=r.sourceObject;c.visible=!0}if(r.updateDirector){const c=this.timelines[n];c&&(c.isPlaying&&c.pause(),c.time=l,c.evaluate())}}else{const l=(i=this._previousActiveModel)==null?void 0:i.asset;if(r.controlActivation){const c=r.sourceObject;(l==null?void 0:l.sourceObject)!==c&&(c.visible=!1)}}}}}var H1=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const lo=C("debugtimeline");var Wl;(function(s){s[s.Hold=0]="Hold",s[s.Loop=1]="Loop",s[s.None=2]="None"})(Wl||(Wl={}));var qx;(function(s){s[s.None=0]="None",s[s.Hold=1]="Hold",s[s.Loop=2]="Loop",s[s.PingPong=3]="PingPong",s[s.Continue=4]="Continue"})(qx||(qx={}));const _p=class extends j{constructor(){super(...arguments);a(this,"playableAsset");a(this,"playOnAwake");a(this,"extrapolationMode",Wl.Loop);a(this,"waitForAudio",!0);a(this,"_visibilityChangeEvt");a(this,"_clonedPlayableAsset",!1);a(this,"_speed",1);a(this,"_guidsMap");a(this,"_isPlaying",!1);a(this,"_internalUpdateRoutine");a(this,"_isPaused",!1);a(this,"_isStopping",!1);a(this,"_time",0);a(this,"_duration",0);a(this,"_weight",1);a(this,"_animationTracks",[]);a(this,"_audioTracks",[]);a(this,"_signalTracks",[]);a(this,"_controlTracks",[]);a(this,"_customTracks",[]);a(this,"_allTracks",[this._animationTracks,this._audioTracks,this._signalTracks,this._controlTracks,this._customTracks]);a(this,"animationCallbackReceivers",[])}static registerCreateTrack(e,i){this.createTrackFunctions[e]=i}get isPlaying(){return this._isPlaying}get isPaused(){return this._isPaused}get time(){return this._time}set time(e){typeof e=="number"&&!Number.isNaN(e)?this._time=e:(lo||qi())&&console.error("INVALID TIMELINE.TIME VALUE",e,this.name)}get duration(){return this._duration}set duration(e){this._duration=e}get weight(){return this._weight}set weight(e){this._weight=e}get speed(){return this._speed}set speed(e){this._speed=e}awake(){var e,i,n,o,r;lo&&console.log(this,(e=this.playableAsset)==null?void 0:e.tracks),this.rebuildGraph(),!this.isValid()&&(lo||U())&&(lo?console.warn("PlayableDirector is not valid","Asset?",this.playableAsset,"Tracks:",(i=this.playableAsset)==null?void 0:i.tracks,"IsArray?",Array.isArray((n=this.playableAsset)==null?void 0:n.tracks),this):(r=(o=this.playableAsset)==null?void 0:o.tracks)!=null&&r.length?console.warn("PlayableDirector is not valid"):console.warn("PlayableDirector has no tracks"))}onEnable(){var e,i,n;for(const o of this._audioTracks)(e=o.onEnable)==null||e.call(o);for(const o of this._customTracks)(i=o.onEnable)==null||i.call(o);for(const o of this._animationTracks)(n=o.onEnable)==null||n.call(o);this.playOnAwake&&this.play(),this._visibilityChangeEvt||(this._visibilityChangeEvt=()=>{switch(document.visibilityState){case"hidden":this.setAudioTracksAllowPlaying(!1);break;case"visible":this.setAudioTracksAllowPlaying(!0);break}}),window.addEventListener("visibilitychange",this._visibilityChangeEvt)}onDisable(){var e,i,n;this.stop();for(const o of this._audioTracks)(e=o.onDisable)==null||e.call(o);for(const o of this._customTracks)(i=o.onDisable)==null||i.call(o);for(const o of this._animationTracks)(n=o.onDisable)==null||n.call(o);this._visibilityChangeEvt&&window.removeEventListener("visibilitychange",this._visibilityChangeEvt)}onDestroy(){var e;for(const i of this._allTracks)for(const n of i)(e=n.onDestroy)==null||e.call(n)}rebuildGraph(){this.isValid()&&(this.resolveBindings(),this.updateTimelineDuration(),this.setupAndCreateTrackHandlers())}async play(){if(!this.isValid())return;const e=this._isPaused==!0;if(this._isPaused=!1,!this._isPlaying){if(this._isPlaying=!0,e&&this.invokePauseChangedMethodsOnTracks(),this.waitForAudio){const i=[];for(const n of this._audioTracks){const o=n.loadAudio(this._time,1,0);o&&i.push(o)}if(i.length>0&&(await Promise.all(i),!this._isPlaying))return;for(;this._audioTracks.length>0&&this._isPlaying&&!Oe.userInteractionRegistered&&this.waitForAudio;)await Xs(200)}this.invokeStateChangedMethodsOnTracks(),this._internalUpdateRoutine=this.startCoroutine(this.internalUpdate(),oe.LateUpdate)}}pause(){this.isValid()&&(this._isPlaying=!1,!this._isPaused&&(this._isPaused=!0,this.internalEvaluate(),this.invokePauseChangedMethodsOnTracks(),this.invokeStateChangedMethodsOnTracks()))}stop(){this._isStopping=!0;for(const n of this._audioTracks)n.stop();const e=this._isPaused==!0,i=this._isPlaying;this._isPlaying&&(this._time=0,this._isPlaying=!1,this._isPaused=!1,this.internalEvaluate(),e&&this.invokePauseChangedMethodsOnTracks()),this._isPlaying=!1,this._isPaused=!1,e&&!i&&this.invokePauseChangedMethodsOnTracks(),i&&this.invokeStateChangedMethodsOnTracks(),this._internalUpdateRoutine&&this.stopCoroutine(this._internalUpdateRoutine),this._internalUpdateRoutine=null,this._isStopping=!1}evaluate(){this.internalEvaluate(!0)}isValid(){return this.playableAsset&&this.playableAsset.tracks&&Array.isArray(this.playableAsset.tracks)}*forEachTrack(){for(const e of this._allTracks)for(const i of e)yield i}get animationTracks(){return this._animationTracks}get audioTracks(){return this._audioTracks}resolveGuids(e){this._guidsMap=e}invokePauseChangedMethodsOnTracks(){var e;for(const i of this.forEachTrack())(e=i.onPauseChanged)==null||e.call(i)}invokeStateChangedMethodsOnTracks(){var e;for(const i of this.forEachTrack())(e=i.onStateChanged)==null||e.call(i,this._isPlaying)}*internalUpdate(){for(;this._isPlaying&&this.activeAndEnabled;)!this._isPaused&&this._isPlaying&&(this._time+=this.context.time.deltaTime*this.speed,this.internalEvaluate()),yield}internalEvaluate(e=!1){if(!this.isValid())return;let i=this._time;switch(this.extrapolationMode){case Wl.Hold:this._speed>0?i=Math.min(i,this._duration):this._speed<0&&(i=Math.max(i,0)),this._time=i;break;case Wl.Loop:i%=this._duration,this._time=i;break;case Wl.None:if(i>this._duration){this.stop();return}break}const n=this._time;for(const o of this.playableAsset.tracks)if(!o.muted)switch(o.type){case tn.Activation:if(!e&&!this._isPlaying)continue;for(let r=0;r<o.outputs.length;r++){const l=o.outputs[r];if(typeof l=="object"){let c=!1;if(o.clips)for(const d of o.clips)d.start<=n&&n<=d.end&&(c=!0);const h=l;h.visible!==void 0&&h.visible!==c&&(h.visible=c,lo&&console.warn(this.name,"set ActivationTrack-"+r,h.name,c,n))}}break}if(!this._isStopping)for(const o of this._animationTracks)o.evaluate(n);for(const o of this._audioTracks)o.evaluate(n);for(const o of this._signalTracks)o.evaluate(n);for(const o of this._controlTracks)o.evaluate(n);for(const o of this._customTracks)o.evaluate(n)}resolveBindings(){if(this._clonedPlayableAsset||(this._clonedPlayableAsset=!0,this.playableAsset=kp(this.playableAsset)),!this.playableAsset||!this.playableAsset.tracks)return;const e=this.findRoot(this.gameObject);for(const i of this.playableAsset.tracks){for(let n=i.outputs.length-1;n>=0;n--){let o=i.outputs[n];if(typeof o=="string"){this._guidsMap&&this._guidsMap[o]&&(o=this._guidsMap[o]);const r=P.findByGuid(o,e);r===null||typeof r!="object"?(i.outputs.splice(n,1),console.warn("Failed to resolve binding",o,i.name,i.type)):(lo&&console.log("Resolved binding",o,"to",r),i.outputs[n]=r)}else if(o===null){if(i.outputs.splice(n,1),_p.createTrackFunctions[i.type])continue;i.type!==tn.Audio&&i.type!==tn.Control&&i.type!==tn.Marker&&i.type!==tn.Signal&&console.warn("Missing binding",o,i.name,i.type,this.name,this.playableAsset.name)}}if(i.type===tn.Control&&i.clips)for(let n=0;n<i.clips.length;n++){const o=i.clips[n];let r=o.asset.sourceObject;if(typeof r=="string"){this._guidsMap&&this._guidsMap[r]&&(r=this._guidsMap[r]);const l=P.findByGuid(r,e);l===null||typeof l!="object"?console.warn("Failed to resolve sourceObject binding",r,i.name,o):(lo&&console.log("Resolved binding",r,"to",l),o.asset.sourceObject=l)}}}}findRoot(e){return e.parent?this.findRoot(e.parent):e}updateTimelineDuration(){if(this._duration=0,!(!this.playableAsset||!this.playableAsset.tracks)){for(const e of this.playableAsset.tracks)if(e.muted!==!0){if(e.clips)for(const i of e.clips)i.end>this._duration&&(this._duration=i.end);if(e.markers)for(const i of e.markers)i.time>this._duration&&(this._duration=i.time+.001)}}}setupAndCreateTrackHandlers(){var i,n,o;if(this._animationTracks.length=0,this._audioTracks.length=0,this._signalTracks.length=0,!this.playableAsset)return;let e=P.findObjectOfType(Rr,this.context);for(const r of this.playableAsset.tracks){const l=r.type,c=_p.createTrackFunctions[l];if(c!=null){const h=c(this,r);if(typeof h.evaluate=="function"){h.director=this,h.track=r,this._customTracks.push(h);continue}}if(r.type===tn.Animation){if(!r.clips||r.clips.length<=0){lo&&console.warn("Animation track has no clips",r);continue}for(let h=r.outputs.length-1;h>=0;h--){let d=r.outputs[h];if(d instanceof F){const f=P.getOrAddComponent(d,pi);f&&(d=f)}const u=(i=d==null?void 0:d.gameObject)==null?void 0:i.animations;if(u){const f=new zb;f.trackOffset=r.trackOffset,f.director=this,f.track=r;for(let p=0;p<r.clips.length;p++){const g=r.clips[p],y=g.asset;if(!y){console.error(`Timeline ${this.name}: clip #${p} on track "${r.name}" has no animation data`);continue}const b=y.clip;let _=b;if((typeof _=="string"||typeof _=="number")&&(_=u.find(S=>S.name===b)),lo&&console.log(y,b,"‚Üí",_),!_){console.warn("Could not find animationClip for model",g,r.name,this.name,(n=this.playableAsset)==null?void 0:n.name,u,d);continue}d instanceof pi&&d.runtimeAnimatorController&&(d.__internalDidAwakeAndStart||d.initializeRuntimeAnimatorController(),d.runtimeAnimatorController.mixer||d.runtimeAnimatorController.bind(d),f.mixer=d.runtimeAnimatorController.mixer),f.mixer||(f.mixer=new C_(d.gameObject),this.context.animations.registerAnimationMixer(f.mixer)),f.clips.push(_),f.mixer.uncacheAction(_),f.createHooks(g.asset,_);const v=f.mixer.clipAction(_);f.actions.push(v),f.models.push(g)}this._animationTracks.push(f)}}}else if(r.type===tn.Audio){if(!r.clips||r.clips.length<=0)continue;const h=new dc;h.director=this,h.track=r,h.audioSource=r.outputs.find(d=>d instanceof Oe),this._audioTracks.push(h),e||(e=(o=this.context.mainCameraComponent)==null?void 0:o.gameObject.addComponent(Rr)),h.listener=e.listener;for(let d=0;d<r.clips.length;d++){const u=r.clips[d];h.addModel(u)}}else if(r.type===tn.Marker){const h=new op;if(h.director=this,h.track=r,r.markers)for(const d of r.markers)switch(d.type){case y_.Signal:h.models.push(d),h.didTrigger.push(!1);break}if(h!==null&&h.models.length>0){const d=P.getComponent(this.gameObject,Fr);d&&(h.receivers.push(d),this._signalTracks.push(h))}}else if(r.type===tn.Signal){const h=new op;if(h.director=this,h.track=r,r.markers)for(const d of r.markers)h.models.push(d),h.didTrigger.push(!1);for(const d of r.outputs)h.receivers.push(d);this._signalTracks.push(h)}else if(r.type===tn.Control){const h=new Ub;if(h.director=this,h.track=r,r.clips)for(const d of r.clips)h.models.push(d);h.resolveSourceObjects(this.context),this._controlTracks.push(h)}}}setAudioTracksAllowPlaying(e){for(const i of this._audioTracks)i.onAllowAudioChanged(e)}registerAnimationCallback(e){this.animationCallbackReceivers.push(e)}unregisterAnimationCallback(e){const i=this.animationCallbackReceivers.indexOf(e);i!==-1&&this.animationCallbackReceivers.splice(i,1)}};let Gs=_p;a(Gs,"createTrackFunctions",{});H1([m()],Gs.prototype,"playOnAwake",void 0);H1([m()],Gs.prototype,"extrapolationMode",void 0);var xm=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};class qc extends j{constructor(){super(...arguments);a(this,"isGizmo",!1);a(this,"translationSnap",1);a(this,"rotationSnapAngle",15);a(this,"scaleSnap",.25);a(this,"_control");a(this,"orbit");a(this,"onControlChangedEvent",e=>{const i=this.orbit;if(i&&(i.enabled=!e.value),e.value){const n=P.getComponentInParent(this.gameObject,Wo);n&&n.requestOwnership()}});a(this,"windowKeyDownListener",e=>{if(this.enabled&&this._control)switch(e.keyCode){case 81:this._control.setSpace(this._control.space==="local"?"world":"local");break;case 16:this.enableSnapping();break;case 87:this._control.setMode("translate");break;case 69:this._control.setMode("rotate");break;case 82:this._control.setMode("scale");break;case 187:case 107:this._control.setSize(this._control.size+.1);break;case 189:case 109:this._control.setSize(Math.max(this._control.size-.1,.1));break;case 88:this._control.showX=!this._control.showX;break;case 89:this._control.showY=!this._control.showY;break;case 90:this._control.showZ=!this._control.showZ;break;case 32:this._control.enabled=!this._control.enabled;break}});a(this,"windowKeyUpListener",e=>{if(this.enabled)switch(e.keyCode){case 16:this.disableSnapping();break}})}get control(){return this._control}onEnable(){var e;if(!(this.isGizmo&&!Fd)&&this.context.mainCamera&&(this._control||(this._control=new XR(this.context.mainCamera,this.context.renderer.domElement),this._control.enabled=!0,this._control.getRaycaster().layers.set(2),this._control.size=1,("_root"in this._control?this._control._root:this._control).traverse(n=>{const o=n;if(o.layers.set(2),o){const r=o.material;r&&(r.opacity=.3)}}),this.orbit=P.getComponentInParent(this.context.mainCamera,ke)??void 0),this._control)){const i=this._control.getHelper();this.context.scene.add(i),this._control.attach(this.gameObject),(e=this._control)==null||e.addEventListener("dragging-changed",this.onControlChangedEvent),window.addEventListener("keydown",this.windowKeyDownListener),window.addEventListener("keyup",this.windowKeyUpListener)}}onDisable(){var e,i,n;(i=(e=this._control)==null?void 0:e.getHelper())==null||i.removeFromParent(),(n=this._control)==null||n.removeEventListener("dragging-changed",this.onControlChangedEvent),window.removeEventListener("keydown",this.windowKeyDownListener),window.removeEventListener("keyup",this.windowKeyUpListener)}enableSnapping(){this._control&&(this._control.setTranslationSnap(this.translationSnap),this._control.setRotationSnap(To.degToRad(this.rotationSnapAngle)),this._control.setScaleSnap(this.scaleSnap))}disableSnapping(){this._control&&(this._control.setTranslationSnap(null),this._control.setRotationSnap(null),this._control.setScaleSnap(null))}}xm([m()],qc.prototype,"isGizmo",void 0);xm([m()],qc.prototype,"translationSnap",void 0);xm([m()],qc.prototype,"rotationSnapAngle",void 0);xm([m()],qc.prototype,"scaleSnap",void 0);var wm=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};class Nb{constructor(){a(this,"texture",null);a(this,"rect")}}wm([m(Je)],Nb.prototype,"texture",void 0);let au=class extends im{constructor(){super(...arguments);a(this,"_sprite");a(this,"pixelsPerUnitMultiplier",1)}set image(e){this.sprite||(this.sprite=new Nb),this.sprite.texture=e,this.onAfterCreated()}get image(){return this.sprite?this.sprite.texture:null}get sprite(){return this._sprite}set sprite(e){this._sprite!==e&&(this._sprite=e,this.onAfterCreated())}isBuiltinSprite(){var i,n,o,r,l,c,h;const e=this.sprite;switch((i=e==null?void 0:e.texture)==null?void 0:i.name){case"InputFieldBackground":case"UISprite":case"Background":case"Knob":return!0}return!((o=(n=e==null?void 0:e.texture)==null?void 0:n.name)!=null&&o.length)&&((l=(r=e==null?void 0:e.texture)==null?void 0:r.image)==null?void 0:l.width)===32&&((h=(c=e==null?void 0:e.texture)==null?void 0:c.image)==null?void 0:h.height)===32}onBeforeCreate(e){var i,n;super.onBeforeCreate(e),this.isBuiltinSprite()&&(e.borderRadius=5/this.pixelsPerUnitMultiplier,((n=(i=this.sprite)==null?void 0:i.texture)==null?void 0:n.name)==="Knob"&&(e.borderRadius=999))}onAfterCreated(){var e;this.__didAwake&&(super.onAfterCreated(),!this.isBuiltinSprite()&&this.setTexture((e=this.sprite)==null?void 0:e.texture))}};wm([m(Nb)],au.prototype,"sprite",null);wm([m()],au.prototype,"pixelsPerUnitMultiplier",void 0);class $b extends im{constructor(){super(...arguments);a(this,"_mainTexture")}get mainTexture(){return this._mainTexture}set mainTexture(e){this._mainTexture!==e&&(this._mainTexture=e,this.onAfterCreated())}onAfterCreated(){this.__didAwake&&(super.onAfterCreated(),this.setTexture(this.mainTexture))}}wm([m(Je)],$b.prototype,"mainTexture",null);var _n=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const fa=C("debugbutton");var Ss;(function(s){s[s.None=0]="None",s[s.ColorTint=1]="ColorTint",s[s.SpriteSwap=2]="SpriteSwap",s[s.Animation=3]="Animation"})(Ss||(Ss={}));class ta{constructor(){a(this,"colorMultiplier");a(this,"disabledColor");a(this,"fadeDuration");a(this,"highlightedColor");a(this,"normalColor");a(this,"pressedColor");a(this,"selectedColor")}}_n([m()],ta.prototype,"colorMultiplier",void 0);_n([m(Ae)],ta.prototype,"disabledColor",void 0);_n([m()],ta.prototype,"fadeDuration",void 0);_n([m(Ae)],ta.prototype,"highlightedColor",void 0);_n([m(Ae)],ta.prototype,"normalColor",void 0);_n([m(Ae)],ta.prototype,"pressedColor",void 0);_n([m(Ae)],ta.prototype,"selectedColor",void 0);class KI{constructor(){a(this,"disabledTrigger");a(this,"highlightedTrigger");a(this,"normalTrigger");a(this,"pressedTrigger");a(this,"selectedTrigger")}}class ia extends j{constructor(){super(...arguments);a(this,"onClick",new Te);a(this,"_isHovered",0);a(this,"colors");a(this,"transition");a(this,"animationTriggers");a(this,"animator");a(this,"_interactable",!0);a(this,"_requestedAnimatorTrigger");a(this,"_isInit",!1);a(this,"_image")}click(){var e;(e=this.onClick)==null||e.invoke()}onPointerEnter(e){var n,o;const i=e.event.pointerType==="mouse"&&e.button===0;i&&(this._isHovered+=1),fa&&console.warn("Button Enter",i,this._isHovered,(n=this.animationTriggers)==null?void 0:n.highlightedTrigger,this.animator),this.interactable&&(this.transition==Ss.Animation&&this.animationTriggers&&this.animator?this.animator.setTrigger(this.animationTriggers.highlightedTrigger):this.transition===Ss.ColorTint&&this.colors&&((o=this._image)==null||o.setState("hovered")),i&&this.context.input.setCursor("pointer"))}onPointerExit(){var e,i;this._isHovered-=1,this._isHovered<0&&(this._isHovered=0),fa&&console.log("Button Exit",this._isHovered,(e=this.animationTriggers)==null?void 0:e.highlightedTrigger,this.animator),this.interactable&&(this._isHovered>0||(this._isHovered=0,this.transition==Ss.Animation&&this.animationTriggers&&this.animator?this.animator.setTrigger(this.animationTriggers.normalTrigger):this.transition===Ss.ColorTint&&this.colors&&((i=this._image)==null||i.setState("normal")),this.context.input.unsetCursor("pointer")))}onPointerDown(e){var i,n;fa&&console.log("Button Down",(i=this.animationTriggers)==null?void 0:i.highlightedTrigger,this.animator),this.interactable&&(this.transition==Ss.Animation&&this.animationTriggers&&this.animator?this.animator.setTrigger(this.animationTriggers.pressedTrigger):this.transition===Ss.ColorTint&&this.colors&&((n=this._image)==null||n.setState("pressed")))}onPointerUp(e){var i,n;fa&&console.warn("Button Up",(i=this.animationTriggers)==null?void 0:i.highlightedTrigger,this.animator,this._isHovered),this.interactable&&(this.transition==Ss.Animation&&this.animationTriggers&&this.animator?this.animator.setTrigger(this._isHovered?this.animationTriggers.highlightedTrigger:this.animationTriggers.normalTrigger):this.transition===Ss.ColorTint&&this.colors&&((n=this._image)==null||n.setState(this._isHovered?"hovered":"normal")))}onPointerClick(e){if(this.interactable&&!(e.button!==0&&e.event.pointerType===Sr.Mouse)&&(fa&&(console.warn("Button Click",this.onClick),tt("CLICKED button "+this.name+" at "+this.context.time.frameCount)),this.onClick&&this.onClick.listenerCount>0&&(this.onClick.invoke(),e.use(),fa))){const i=this.gameObject.worldPosition;i.add(this.gameObject.worldUp.multiplyScalar(1+Math.random()*.5)),G.DrawLabel(i,"CLICK:"+Date.now(),.1,1+Math.random()*.5)}}set interactable(e){this._interactable=e,this._image&&(this._image.setInteractable(e),e?this._image.setState("normal"):this._image.setState("disabled"))}get interactable(){return this._interactable}set_interactable(e){this.interactable=e}awake(){super.awake(),fa&&console.log(this),this._isInit=!1,this.init()}start(){var e;(e=this._image)==null||e.setInteractable(this.interactable),this.gameObject.getComponentInParent(Oc)||this.gameObject.addComponent(nb)}onEnable(){super.onEnable()}onDestroy(){this._isHovered&&this.context.input.unsetCursor("pointer")}*setAnimatorTriggerAtEndOfFrame(e){var i;this._requestedAnimatorTrigger=e,yield,yield,this._requestedAnimatorTrigger==e&&((i=this.animator)==null||i.setTrigger(e))}init(){this._isInit||(this._isInit=!0,this._image=P.getComponent(this.gameObject,au),this._image&&(this.stateSetup(this._image),this.interactable?this._image.setState("normal"):this._image.setState("disabled")))}stateSetup(e){var p,g,y,b,_;e.setInteractable(this.interactable);const i=this.getFinalColor(e.color,(p=this.colors)==null?void 0:p.normalColor),n={state:"normal",attributes:{backgroundColor:i,backgroundOpacity:i.alpha}};e.setupState(n);const o=this.getFinalColor(e.color,(g=this.colors)==null?void 0:g.highlightedColor),r={state:"hovered",attributes:{backgroundColor:o,backgroundOpacity:o.alpha}};e.setupState(r);const l=this.getFinalColor(e.color,(y=this.colors)==null?void 0:y.pressedColor),c={state:"pressed",attributes:{backgroundColor:l,backgroundOpacity:l.alpha}};e.setupState(c);const h=this.getFinalColor(e.color,(b=this.colors)==null?void 0:b.selectedColor),d={state:"selected",attributes:{backgroundColor:h,backgroundOpacity:h.alpha}};e.setupState(d);const u=this.getFinalColor(e.color,(_=this.colors)==null?void 0:_.disabledColor),f={state:"disabled",attributes:{backgroundColor:u,backgroundOpacity:u.alpha}};e.setupState(f)}getFinalColor(e,i){return i?e.clone().multiply(i).convertLinearToSRGB():e.clone().convertLinearToSRGB()}}_n([m(Te)],ia.prototype,"onClick",void 0);_n([m(ta)],ia.prototype,"colors",void 0);_n([m()],ia.prototype,"transition",void 0);_n([m(KI)],ia.prototype,"animationTriggers",void 0);_n([m(pi)],ia.prototype,"animator",void 0);_n([m()],ia.prototype,"interactable",null);var Sm=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const hr=C("debuginputfield"),ee=class extends j{constructor(){super(...arguments);a(this,"textComponent");a(this,"placeholder");a(this,"onValueChanged");a(this,"onEndEdit");a(this,"inputEventFn");a(this,"_iosEventFn")}get text(){var e;return((e=this.textComponent)==null?void 0:e.text)??""}set text(e){this.textComponent&&(this.textComponent.text=e,this.placeholder&&(e.length>0?this.placeholder.gameObject.visible=!1:this.placeholder.gameObject.visible=!0))}get isFocused(){return ee.active===this}start(){hr&&console.log(this.name,this)}onEnable(){var e;ee.htmlField||(ee.htmlField=document.createElement("input"),ee.htmlField.style.width="0px",ee.htmlField.style.height="0px",ee.htmlField.style.padding="0px",ee.htmlField.style.border="none",ee.htmlField.style.overflow="hidden",ee.htmlField.style.caretColor="transparent",ee.htmlField.style.outline="none",ee.htmlField.classList.add("ar"),ee.htmlField.onfocus=()=>ee.htmlFieldFocused=!0,ee.htmlField.onblur=()=>ee.htmlFieldFocused=!1,document.body.append(ee.htmlField)),this.inputEventFn||(this.inputEventFn=this.onInput.bind(this)),ee.htmlField.addEventListener("keyup",this.inputEventFn),this.placeholder&&((e=this.textComponent)!=null&&e.text.length)&&P.setActive(this.placeholder.gameObject,!1),J.isiOS()&&(this._iosEventFn=this.processInputOniOS.bind(this),window.addEventListener("click",this._iosEventFn))}onDisable(){var e;(e=ee.htmlField)==null||e.removeEventListener("keyup",this.inputEventFn),this.onDeselected(),this._iosEventFn&&window.removeEventListener("click",this._iosEventFn)}clear(){ee.active===this&&ee.htmlField?(ee.htmlField.value="",this.setTextFromInputField()):(this.textComponent&&(this.textComponent.text=""),this.placeholder&&P.setActive(this.placeholder.gameObject,!0))}select(){this.onSelected()}deselect(){this.onDeselected()}onPointerEnter(e){e.event.pointerType==="mouse"&&e.button===0&&this.context.input.setCursor("text")}onPointerExit(e){this.context.input.unsetCursor("text")}onPointerClick(e){hr&&console.log("CLICK",e,ee.active),ee.activeTime=this.context.time.time,ee.active!==this&&this.startCoroutine(this.activeLoop(),oe.LateUpdate),this.selectInputField()}*activeLoop(){for(this.onSelected();ee.active===this&&!(this.context.input.getPointerClicked(0)&&this.context.time.time-ee.activeTime>.2);)this.setTextFromInputField(),yield;this.onDeselected()}onSelected(){var e,i,n,o;if(ee.active!==this&&(hr&&console.log("Select",this.name,this,ee.htmlField,this.context.isInXR,this.context.arOverlayElement,(e=this.textComponent)==null?void 0:e.text,(i=ee.htmlField)==null?void 0:i.value),(n=ee.active)==null||n.onDeselected(),ee.active=this,this.placeholder&&P.setActive(this.placeholder.gameObject,!1),ee.htmlField)){if(ee.htmlField.value=((o=this.textComponent)==null?void 0:o.text)||"",hr&&console.log("set input field value",ee.htmlField.value),this.context.isInXR){const r=this.context.arOverlayElement;r&&r.append(ee.htmlField)}this.selectInputField()}}onDeselected(){var e;ee.active===this&&(ee.active=null,hr&&console.log("Deselect",this.name,this),ee.htmlField&&(ee.htmlField.blur(),document.body.append(ee.htmlField)),this.placeholder&&(!this.textComponent||this.textComponent.text.length<=0)&&P.setActive(this.placeholder.gameObject,!0),ee.htmlField&&((e=this.onEndEdit)==null||e.invoke(ee.htmlField.value)))}update(){var e;ee.active===this&&((e=this.textComponent)==null||e.markDirty())}onInput(e){var i,n;if(ee.active===this){if(hr&&console.log(e.code,e,(i=ee.htmlField)==null?void 0:i.value,(n=this.textComponent)==null?void 0:n.text),e.code==="Escape"||e.code==="Enter"){this.onDeselected();return}ee.htmlField&&(this.textComponent&&(this.setTextFromInputField(),this.placeholder&&P.setActive(this.placeholder.gameObject,this.textComponent.text.length<=0)),this.selectInputField())}}setTextFromInputField(){var e;if(this.textComponent&&ee.htmlField){const i=this.textComponent.text,n=ee.htmlField.value,o=this.textComponent.text!==ee.htmlField.value;this.textComponent.text=ee.htmlField.value,o&&(hr&&console.log("[InputField] value changed:",n,i),(e=this.onValueChanged)==null||e.invoke(n,i))}}selectInputField(){ee.htmlField&&(hr&&console.log("Focus Inputfield",ee.htmlFieldFocused),ee.htmlField.setSelectionRange(ee.htmlField.value.length,ee.htmlField.value.length),J.isiOS()?ee.htmlField.focus({preventScroll:!0}):setTimeout(()=>{var e;return(e=ee.htmlField)==null?void 0:e.focus()},1))}processInputOniOS(){const e=this.context.physics.raycast();if(!e.length)return;const n=e[0].object,o=ob(n);((o==null?void 0:o.gameObject)===this.gameObject||(o==null?void 0:o.gameObject.parent)===this.gameObject)&&this.selectInputField()}};let Rn=ee;a(Rn,"active",null),a(Rn,"activeTime",-1),a(Rn,"htmlField",null),a(Rn,"htmlFieldFocused",!1);Sm([m(Di)],Rn.prototype,"textComponent",void 0);Sm([m(Di)],Rn.prototype,"placeholder",void 0);Sm([m(Te)],Rn.prototype,"onValueChanged",void 0);Sm([m(Te)],Rn.prototype,"onEndEdit",void 0);var G1=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};class Cm extends j{constructor(){super(...arguments);a(this,"id",null);a(this,"keepAspect",!1);a(this,"_object",null)}onEnable(){if(this._object){this.gameObject.add(this._object);return}if(!this.id||!this.context.mainCamera)return;const e=document.getElementById(this.id);if(!e){console.warn('Could not find element with id "'+this.id+'"');return}e.style.display="block",e.style.visibility="hidden";const i=new QR;i.listenToPointerEvents(this.context.renderer,this.context.mainCamera),this.gameObject.add(i);const n=new YR(e);i.add(n),n.visible=!1;const o=n.material;o.transparent=!0,setTimeout(()=>{n.visible=!0;const r=Ap(this.gameObject).clone();Ip(this.gameObject,0,0,0),this.gameObject.updateMatrixWorld();const l=new En;l.setFromObject(i),this.setWorldRotation(r.x,r.y,r.z);const c=l.max.x-l.min.x,h=l.max.y-l.min.y;if(this.keepAspect){const u=c/h;c>h?n.scale.set(1/c,1/h/u,1):n.scale.set(1/c*u,1/h,1)}else n.scale.set(1/c,1/h,1);const d=this.gameObject.scale;n.scale.multiply(d)},1)}onDisable(){var e;(e=this._object)==null||e.removeFromParent()}}G1([m()],Cm.prototype,"id",void 0);G1([m()],Cm.prototype,"keepAspect",void 0);var Pm=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const n0=class extends j{constructor(){super(...arguments);a(this,"target");a(this,"invertForward",!1);a(this,"keepUpDirection",!0);a(this,"copyTargetRotation",!1)}onBeforeRender(){let e=this.target;if(e||(e=this.context.mainCamera),!e)return;let i=this.copyTargetRotation;(this.context.isInVR||this.context.isInPassThrough)&&(i=!1),Mp(this.gameObject,e,this.keepUpDirection,i),this.invertForward&&this.gameObject.quaternion.multiply(n0.flipYQuat)}createBehaviours(e,i,n){if(i.uuid===this.gameObject.uuid){let o=i;if(this.keepUpDirection){const l=hi.createEmptyParent(i);o=l;const c=this.invertForward?-1:1;l.setMatrix(l.getMatrix().multiply(new le().makeRotationZ(Math.PI/2*c))),i.setMatrix(i.getMatrix().multiply(new le().makeRotationZ(-Math.PI/2*c)))}const r=new Bt("lookat "+this.name,Qt.sceneStartTrigger(),we.lookAtCameraAction(o,void 0,this.invertForward?kn.back:kn.forward,this.keepUpDirection?kn.up:kn.zero));e.addBehavior(r)}}};let zo=n0;a(zo,"flipYQuat",new H().setFromAxisAngle(new x(0,1,0),Math.PI));Pm([m(F)],zo.prototype,"target",void 0);Pm([m()],zo.prototype,"invertForward",void 0);Pm([m()],zo.prototype,"keepUpDirection",void 0);Pm([m()],zo.prototype,"copyTargetRotation",void 0);var Wb=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o},Vl;(function(s){s[s.NewTab=0]="NewTab",s[s.SameTab=1]="SameTab",s[s.NewWindow=2]="NewWindow"})(Vl||(Vl={}));class lu extends j{constructor(){super(...arguments);a(this,"url");a(this,"mode",Vl.NewTab);a(this,"clickable",!0)}async open(){if(!this.url){console.warn("OpenURL: URL is not set, can't open.",this);return}this._validateUrl();let e=this.url;switch(!e.startsWith("mailto:")&&e.includes("@")&&(e="mailto:"+e),U()&&tt("Open URL: "+e),this.mode){case Vl.NewTab:J.isSafari(),globalThis.open(e,"_blank");break;case Vl.SameTab:J.isSafari()&&J.isiOS()?globalThis.open(e,"_top"):globalThis.open(e,"_self");break;case Vl.NewWindow:J.isSafari()?globalThis.open(e,"_top"):globalThis.open(e,"_new");break}}start(){this.gameObject.getComponentInParent(jn)||this.gameObject.addComponent(jn)}onPointerEnter(e){!e.used&&this.clickable&&this.context.input.setCursor("pointer")}onPointerExit(){this.clickable&&this.context.input.unsetCursor("pointer")}onPointerClick(e){var i;this.clickable&&!e.used&&((i=this.url)!=null&&i.length)&&this.open()}_validateUrl(){this.url&&this.url.startsWith("www.")&&(U()&&console.warn("URL is not valid, adding https:// to the start of the URL",this.url),this.url="https://"+this.url)}}Wb([m()],lu.prototype,"url",void 0);Wb([m()],lu.prototype,"mode",void 0);Wb([m()],lu.prototype,"clickable",void 0);var Xc=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};class na extends j{constructor(){super(...arguments);a(this,"side","none");a(this,"controller",!0);a(this,"hands",!1);a(this,"controlVisibility",!0);a(this,"useGripSpace",!1);a(this,"resetTransformAfterXRSession",!0);a(this,"_startPosition",new x);a(this,"_startRotation",new H);a(this,"_startScale",new x)}get activeAndEnabled(){return!0}onEnterXR(e){this._startPosition.copy(this.gameObject.position),this._startRotation.copy(this.gameObject.quaternion),this._startScale.copy(this.gameObject.scale)}onUpdateXR(e){if(!this.enabled)return;const i=e.xr.getController(this.side);if(i){if(i.hand&&!this.hands){this.controlVisibility&&(this.gameObject.visible=!1);return}else if(!this.controller){this.controlVisibility&&(this.gameObject.visible=!1);return}this.controlVisibility&&(this.gameObject.visible=!0),this.useGripSpace||i.targetRayMode==="transient-pointer"?(this.gameObject.worldPosition=i.gripWorldPosition,this.gameObject.worldQuaternion=i.gripWorldQuaternion,this.gameObject.worldScale=Q(i.xr.rigScale,i.xr.rigScale,i.xr.rigScale).multiply(this._startScale)):(this.gameObject.worldPosition=i.rayWorldPosition,this.gameObject.worldQuaternion=i.rayWorldQuaternion,this.gameObject.worldScale=Q(i.xr.rigScale,i.xr.rigScale,i.xr.rigScale).multiply(this._startScale))}}onLeaveXR(e){this.resetTransformAfterXRSession&&(this.gameObject.position.copy(this._startPosition),this.gameObject.quaternion.copy(this._startRotation),this.gameObject.scale.copy(this._startScale))}}Xc([m()],na.prototype,"side",void 0);Xc([m()],na.prototype,"controller",void 0);Xc([m()],na.prototype,"hands",void 0);Xc([m()],na.prototype,"controlVisibility",void 0);Xc([m()],na.prototype,"useGripSpace",void 0);Xc([m()],na.prototype,"resetTransformAfterXRSession",void 0);function q1(s,t){const e=s.xr.getFrame();if(!e)return console.warn("No XRFrame available"),!1;const i=e.session.enabledFeatures;if(i&&!i.some(o=>o==="camera-access"))return console.error(`No camera feed available - please request the 'camera-access' feature before starting WebXR or add the ARCameraBackground component to your scene.

Example to request camera-access in global scope:
NeedleXRSession.onSessionRequestStart(evt => {
    evt.init.optionalFeatures = evt.init.optionalFeatures || [];
    evt.init.optionalFeatures.push('camera-access');
});
`),U()&&Dp("No camera feed available - please request the 'camera-access' feature before starting WebXR or add the ARCameraBackground component to your scene"),!1;const n=e.getViewerPose(s.xr.getReferenceSpace());if(n)for(const o of n.views)if("camera"in o&&o.camera){let r=s.xr.getBinding();if(r||(r=new XRWebGLBinding(e.session,s.getContext())),r){let l=null;if("getCameraImage"in r){JI(s,t);const c=s.properties.get(t);if(c)return l=r.getCameraImage(o.camera),c.__webglTexture=l,!0;console.warn("No texture properties found for target texture")}}else console.error(o.camera,s.xr)}else console.error("NO CAMERA IN VIEW");else console.error(s.xr.getReferenceSpace(),e);return!1}const Xx=new WeakMap;function JI(s,t){const e=Xx.get(t)||new WeakSet;if(e.has(s))return;e.add(s),Xx.set(t,e),console.debug("Initialize texture for camera feed");const i=new Ue,n=new Ys,o=new In;o.add(new Z(n,i));const r=new Re;i.map=t,s.render(o,r)}function HL(s,t,e,i="image/webp",n){return X1({context:s,width:t,height:e,mimeType:i,camera:n})}function X1(s){var O,M;s||(s={});const{transparent:t=!1}=s;let{mimeType:e,context:i,width:n,height:o,camera:r}=s;if(!i&&(i=be.Current,!i))return console.error("Can not save screenshot: No needle-engine context found or provided."),null;if(!r&&(r=i.mainCamera,!r))return console.error("No camera found"),null;const l=i.renderer,c=l.xr.enabled;if(c&&i.currentFrameEvent!=oe.EarlyUpdate)return console.warn("Screenshot: defer to access XR frame"),new Promise(B=>{qo(I=>{const E=X1(s);B(E)},oe.EarlyUpdate,{once:!0})});const h=l.domElement,d=h.width,u=h.height;n||(n=d),o||(o=u);const f=n,p=o,g=window.devicePixelRatio||1;n/=g,o/=g,l.xr.isPresenting&&l.xr.getFrame();const y=l.xr.enabled;l.xr.enabled=!1,l.xr.isPresenting=!1,h.style.width=`${n}px`,h.style.height=`${o}px`;const b=l.getRenderTarget(),_=l.getClearColor(new ue),v=l.getClearAlpha(),S=i.scene.background,T="aspect"in r?r.aspect:null;try{const k=s.render_events!==!1,B=new Array;k&&(zd(i.scene,Ve,B),B.forEach(A=>{var D;if(A==null||A.onBeforeRender(),A.isInstancingActive&&A.instances)for(let N=0;N<((D=A.instances)==null?void 0:D.length);N++){const q=A.instances[N];vo(q.object,!0)}})),t&&(i.scene.background=null,l.setClearColor(0,0)),s.background&&(i.scene.background=null,l.setClearColor(s.background),s.background instanceof Ae&&l.setClearAlpha(s.background.a)),t&&l.setClearAlpha(0),l.setSize(n,o,!1),"cam"in r&&(r=r.threeCamera),r instanceof Re&&(r.aspect=n/o,r.updateProjectionMatrix());const I="type"in s&&s.type==="texture";let E=null;I&&(E=new No(n,o,{wrapS:l0,wrapT:l0,format:1023}),l.setRenderTarget(E));let L=h;if(c?(E&&console.error('Taking XR screenshots with { type: "texture" } is currently not supported.'),L=rp.compositeWithCameraImage({width:f,height:p,scene:i.scene,camera:r,renderer:l})):i.renderNow(r||null),r instanceof Re&&T!=null&&(r.aspect=T,r.updateProjectionMatrix()),k&&B.forEach(A=>A.onAfterRender()),!e&&"download_filename"in s&&s.download_filename)switch((O=s.download_filename.split(".").pop())==null?void 0:O.toLowerCase()){case"png":e="image/png";break;case"jpg":case"jpeg":e="image/jpeg";break;case"webp":e="image/webp";break}if(t&&s.trim===!0){const A=ZI(L);A&&(L=A)}if("type"in s){if(s.type==="texture")return E?(s.target&&(s.target.image=E==null?void 0:E.texture.image,s.target.needsUpdate=!0),E.texture.offset.set(0,-1),E.texture.needsUpdate=!0,E.texture):(console.error("No target texture found"),null);if(s.type==="blob")return new Promise((D,N)=>{L.toBlob(q=>{D(q)},e)});if(s.type==="share")return new Promise((D,N)=>{L.toBlob(q=>{if(q&&"share"in navigator){let Y="file_type"in s&&s.file_type||e;e||(Y="image/png");const ie=(Y==null?void 0:Y.split("/")[1])||"png",he=new File([q],"filename"in s?s.filename||`screenshot.${ie}`:`screenshot.${ie}`,{type:Y});return navigator.share({title:"title"in s?s.title:void 0,text:"text"in s?s.text:void 0,url:"url"in s?s.url:void 0,files:[he]}).catch(Pe=>{console.warn("User cancelled share",Pe.message)}).finally(()=>{D({blob:q,shared:!0})})}return{blob:q,shared:!1}},e)})}const V=L.toDataURL(e);if("download_filename"in s&&s.download_filename){let A=s.download_filename;if(J.isMobileDevice()&&typeof window<"u"){const D=A+"_screenshots",N=A.split("."),q=(M=N.pop())==null?void 0:M.toLowerCase();let Y=0;localStorage.getItem(D)&&(Y=parseInt(sessionStorage.getItem(D)||"0")),Y>0&&(A=`${N.join()}-${Y}.${q}`),Y+=1,sessionStorage.setItem(D,Y.toString())}eD(V,A)}return V}finally{l.setRenderTarget(b),i.scene.background=S,l.setSize(d,u,!1),l.setClearColor(_,v),T!=null&&r instanceof Re&&(r.aspect=T,r.updateProjectionMatrix()),l.xr.enabled=y,l.xr.isPresenting=c,c||i.updateSize(!0)}return null}function ZI(s){if(!("document"in globalThis))return null;const t=document.createElement("canvas");t.width=s.width,t.height=s.height;const e=t.getContext("2d");if(!e)return null;e.drawImage(s,0,0);const i=t.width,n=t.height,r=e.getImageData(0,0,i,n).data;let l=n,c=i,h=0,d=0;for(let y=0;y<n;y++)for(let b=0;b<i;b++){const _=(y*i+b)*4;r[_+3]!==0&&(b<c&&(c=b),b>d&&(d=b),y<l&&(l=y),y>h&&(h=y))}const u=d-c+1,f=h-l+1,p=document.createElement("canvas"),g=p.getContext("2d");return g?(p.width=u,p.height=f,g.drawImage(t,c,l,u,f,0,0,u,f),p):null}let vh=null;function eD(s,t){if(s){if(!s.startsWith("data:image")){console.error("Can not save image: Data url is not an image",s);return}vh||(vh=document.createElement("a")),vh.href=s,vh.download=t,vh.click()}}var rp;(function(s){let t=null,e=null,i=null,n=null,o=null;function r(h){const{renderer:d,width:u,height:f}=h,p=d.xr.enabled,g=d.getRenderTarget(),y=d.autoClear,b=u,_=f,v=u/f;(!i||i.width!==b||i.height!==_)&&(i??(i=new No(b,_,{colorSpace:rs})),i.width=b,i.height=_,i.samples=4,i.texture.repeat.y=-1,i.texture.offset.y=1),(!o||o.width!==b||o.height!==_)&&(o=document.createElement("canvas"),o.width=b,o.height=_,o.style.position="fixed",o.style.top="0px",o.style.right="0px",o.style.width="300px",o.style.height=`${300/v}px`,o.style.zIndex="1000",o.style.pointerEvents="none",o.style.opacity="1.0",o.style.willChange="contents"),t||(t=c({defines:{DECODE_VIDEO_TEXTURE:!0}})),e||(e=c()),n||(n=new Je),d.xr.updateCamera(h.camera),d.xr.enabled=!1,d.autoClear=!1,d.clear(),d.setSize(b,_),d.setRenderTarget(i),q1(h.renderer,n)||console.error("Could not update texture from XR frame");const T=P.findObjectOfType(Rm);return T?T.setTexture(n):(t.setTexture(n),d.render(t,h.camera)),d.clearDepth(),d.setSize(b,_),d.render(h.scene,h.camera),d.setRenderTarget(null),e.setTexture(i.texture),d.render(e,h.camera),o.getContext("2d",{alpha:!1}).drawImage(d.domElement,0,0,o.width,o.height),d.setRenderTarget(g),d.xr.enabled=p,d.autoClear=y,o}s.compositeWithCameraImage=r;const l=`
uniform sampler2D t2D;
varying vec2 vUv;

void main() {

    vec4 texColor = texture2D( t2D, vUv );

    #ifdef DECODE_VIDEO_TEXTURE

        // inline sRGB decode (TODO: Remove this code when https://crbug.com/1256340 is solved)
        texColor = vec4( mix( pow( texColor.rgb * 0.9478672986 + vec3( 0.0521327014 ), vec3( 2.4 ) ), texColor.rgb * 0.0773993808, vec3( lessThanEqual( texColor.rgb, vec3( 0.04045 ) ) ) ), texColor.w );

    #endif

    gl_FragColor = texColor;
    #include <tonemapping_fragment>
    #include <colorspace_fragment>
}
`;function c(h){const d=(h==null?void 0:h.material)||new os({name:"BackgroundMaterial",uniforms:yw.clone(yf.background.uniforms),vertexShader:yf.background.vertexShader,fragmentShader:l,defines:h==null?void 0:h.defines,side:Wr,depthTest:!1,depthWrite:!1,fog:!1});Object.defineProperty(d,"map",{get:function(){return this.threeTexture}});const u=new Z(new Ys(2,2),d);return fy(u,!1),u.geometry.deleteAttribute("normal"),u.renderOrder=-1e6,u.setTexture=function(f){d.uniforms.t2D.value=f},u}s.makeFullscreenPlane=c})(rp||(rp={}));var tD=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const Qx=C("debugarcamera");class Rm extends j{constructor(){super(...arguments);a(this,"backgroundTint",new Ae(1,1,1,1));a(this,"backgroundPlane");a(this,"threeTexture");a(this,"forceTextureInitialization",function(){const e=new Ue,i=new Ys,n=new In;n.add(new Z(i,e));const o=new Re;return function(l,c){e.map=c,l.render(n,o),Qx&&console.warn("Force texture initialization")}}());a(this,"preRender",()=>{if(!this||!this.gameObject)return;if(this.context.renderer.xr.getFrame()){if(!this.threeTexture&&this.context.renderer&&(this.threeTexture=new Je,this.forceTextureInitialization(this.context.renderer,this.threeTexture)),this.backgroundPlane===void 0){const n=this.backgroundTint;this.backgroundPlane=rp.makeFullscreenPlane({material:new os({name:"BackgroundMaterial",uniforms:{...yw.clone(yf.background.uniforms),tint:{value:new xe(n.r,n.g,n.b,n.a)}},vertexShader:yf.background.vertexShader,fragmentShader:iD,side:hn,depthTest:!1,depthWrite:!1,fog:!1})})}this.backgroundPlane.parent!==this.scene&&this.scene.add(this.backgroundPlane),this.backgroundPlane.material instanceof os&&this.backgroundPlane.material.uniforms.tint.value.set(this.backgroundTint.r,this.backgroundTint.g,this.backgroundTint.b,this.backgroundTint.a),this.updateFromFrame()}})}onBeforeXR(e,i){e==="immersive-ar"&&(i.optionalFeatures=i.optionalFeatures||[],i.optionalFeatures.push("camera-access"),Qx&&console.warn("Requesting camera-access"))}onEnterXR(e){e.xr.mode==="immersive-ar"&&(this.backgroundPlane&&(this.context.scene.add(this.backgroundPlane),this.backgroundPlane.visible=!1),this.backgroundPlane&&this.context.scene.add(this.backgroundPlane),this.context.pre_render_callbacks.push(this.preRender))}onLeaveXR(e){this.backgroundPlane&&this.backgroundPlane.removeFromParent();const i=this.context.pre_render_callbacks.indexOf(this.preRender);i>=0&&this.context.pre_render_callbacks.splice(i,1)}get background(){return this.backgroundPlane}onBeforeRender(e){this.updateFromFrame()}updateFromFrame(){var e;this.threeTexture&&((e=this.context.xr)==null?void 0:e.mode)==="immersive-ar"&&(q1(this.context.renderer,this.threeTexture),this.setTexture(this.threeTexture))}setTexture(e){this.backgroundPlane&&(this.threeTexture=e,this.backgroundPlane.setTexture(this.threeTexture),this.backgroundPlane.visible=!0)}}tD([m(Ae)],Rm.prototype,"backgroundTint",void 0);const iD=`
uniform sampler2D t2D;
uniform vec4 tint;

varying vec2 vUv;

void main() {

    vec4 texColor = texture2D( t2D, vUv );
    texColor.w = 1.0;

    // inline sRGB decode
    texColor = vec4( mix( pow( texColor.rgb * 0.9478672986 + vec3( 0.0521327014 ), vec3( 2.4 ) ), texColor.rgb * 0.0773993808, vec3( lessThanEqual( texColor.rgb, vec3( 0.04045 ) ) ) ), texColor.w );

    gl_FragColor = texColor * tint;

    #include <tonemapping_fragment>
    #include <colorspace_fragment>
}
`;var sa=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const Yx=C("debugimagetracking"),bp=class{constructor(t,e,i,n,o,r){a(this,"measuredSize");a(this,"state");a(this,"_position");a(this,"_rotation");a(this,"_trackingComponent");a(this,"_trackedImage");a(this,"_bitmap");a(this,"_pose");this._trackingComponent=t,this._trackedImage=e,this._bitmap=i,this.measuredSize=n,this.state=o,this._pose=r}get url(){return this._trackedImage.image??""}get widthInMeters(){return this._trackedImage.widthInMeters??void 0}get bitmap(){return this._bitmap}get model(){return this._trackedImage}getPosition(t){return this.ensureTransformData(),t.copy(this._position),t}getQuaternion(t){return this.ensureTransformData(),t.copy(this._rotation),t}applyToObject(t,e=void 0){this.ensureTransformData();const i=t.position.distanceToSquared(this._position)/.05+t.quaternion.angleTo(this._rotation)/.05;e&&(e*=Math.max(1,i)),e===void 0||e>=1?(t.position.copy(this._position),t.quaternion.copy(this._rotation)):(e=Math.max(0,Math.min(1,e)),t.position.lerp(this._position,e),t.quaternion.slerp(this._rotation,e))}ensureTransformData(){if(!this._position){this._position=bp._positionBuffer.get(),this._rotation=bp._rotationBuffer.get();const t=this._pose.transform,e=te.active.convertSpace(t);this._position.copy(e==null?void 0:e.position),this._rotation.copy(e==null?void 0:e.quaternion)}}};let Ta=bp;a(Ta,"_positionBuffer",new Dn(()=>new x,20)),a(Ta,"_rotationBuffer",new Dn(()=>new H,20));class nr{constructor(){a(this,"image");a(this,"widthInMeters",.25);a(this,"object");a(this,"createObjectInstance",!1);a(this,"imageDoesNotMove",!1);a(this,"hideWhenTrackingIsLost",!0)}}sa([m(URL)],nr.prototype,"image",void 0);sa([m()],nr.prototype,"widthInMeters",void 0);sa([m(de)],nr.prototype,"object",void 0);sa([m()],nr.prototype,"createObjectInstance",void 0);sa([m()],nr.prototype,"imageDoesNotMove",void 0);sa([m()],nr.prototype,"hideWhenTrackingIsLost",void 0);class nD{constructor(t,e,i){a(this,"filename");a(this,"widthInMeters");a(this,"imageData");this.filename=t,this.imageData=e,this.widthInMeters=i}get extensionName(){return"image-tracking"}onAfterHierarchy(t,e){const i=J.getiOSVersion(),r=(i?parseInt(i.split(".")[0]):18)>=18?1:100;e.beginBlock('def Preliminary_ReferenceImage "AnchoringReferenceImage"'),e.appendLine("uniform asset image = @image_tracking/"+this.filename+"@"),e.appendLine("uniform double physicalWidth = "+(this.widthInMeters*r).toFixed(8)),e.closeBlock()}onBeforeBuildDocument(t){const e=P.findObjectOfType(Uo);!e||!e.trackedImages||e.trackedImages.length>1&&(U()&&Me("USDZ: Only one tracked image is supported."),console.warn("USDZ: Only one tracked image is supported."))}onAfterSerialize(t){t.files["image_tracking/"+this.filename]=this.imageData}onExportObject(t,e,i){var o;const n=P.findObjectOfType(Uo);if(!(!n||!n.trackedImages)){for(const r of n.trackedImages)if(((o=r.object)==null?void 0:o.asset)===t){const l=P.findObjectOfType(Fe);if(!l)continue;const{scale:c,target:h}=l.getARScaleAndTarget();let d=t;const u=new le;if(t!==h)for(;d.parent&&d.parent!==h;)d=d.parent,u.premultiply(d.matrix);const f=u.clone().invert();e.setMatrix(f.scale(new x(c,c,c)));break}}}}const Zl=class extends j{constructor(){super(...arguments);a(this,"trackedImages");a(this,"smooth",!0);a(this,"trackedImageIndexMap",new Map);a(this,"_supported",!0);a(this,"imageToObjectMap",new Map);a(this,"currentImages",[]);a(this,"webXRIncubationsWarning",`Image tracking is currently not supported on this device. On Chrome for Android, you can enable the <a target="_blank" href="#" onclick="() => console.log('I')">chrome://flags/#webxr-incubations</a> flag.`);a(this,"onImageTrackingUpdate",e=>{const i=te.active;if(i)for(const n of e){const o=n.model,r=n.state==="tracked";if(!o.object)continue;let l=this.imageToObjectMap.get(o);if(l===void 0)l={object:null,frames:0,lastTrackingTime:Date.now()},this.imageToObjectMap.set(o,l),o.object.loadAssetAsync().then(c=>{if(o.createObjectInstance&&c&&(c=P.instantiate(c)),c){l.object=c;for(const h of c.getComponentsInChildren(Ve))h.setInstancingEnabled(!1);i.rig?(i.rig.gameObject.add(c),n.applyToObject(c),c.activeSelf||P.setActive(c,!0)):console.warn("XRImageTracking: missing XRRig")}});else{if(l.frames++,r&&(l.lastTrackingTime=Date.now()),o.imageDoesNotMove&&l.frames>10||!l.object)continue;i.rig&&(i.rig.gameObject.add(l.object),n.applyToObject(l.object,this.smooth?this.context.time.deltaTimeUnscaled*3:void 0),l.object.activeSelf||P.setActive(l.object,!0))}}})}get supported(){return this._supported}awake(){if(Yx&&console.log(this),!!this.trackedImages){for(const e of this.trackedImages)if(e.image&&!Zl._imageElements.has(e.image)){const i=e.image;Zl._imageElements.set(i,null);const n=document.createElement("img");n.src=i,n.addEventListener("load",async()=>{const o=await createImageBitmap(n);Zl._imageElements.set(i,o);const r=await p2(o);if(r){const c=await(await r.convertToBlob({type:"image/png"})).arrayBuffer(),h=P.findObjectOfType(Fe);h&&this.trackedImages&&(h.extensions.push(new nD("marker.png",new Uint8Array(c),this.trackedImages[0].widthInMeters)),h.anchoringType="image")}})}}}onBeforeXR(e,i){var n;if(this.trackedImages){i.optionalFeatures=i.optionalFeatures||[],i.optionalFeatures.includes("image-tracking")||i.optionalFeatures.push("image-tracking"),i.trackedImages=[];for(const o of this.trackedImages)if((n=o.image)!=null&&n.length&&o.widthInMeters>0){const r=Zl._imageElements.get(o.image);r&&(this.trackedImageIndexMap.set(i.trackedImages.length,o),i.trackedImages.push({image:r,widthInMeters:o.widthInMeters}))}}}onEnterXR(e){var i;if(this.trackedImages){for(const n of this.trackedImages)if((i=n.object)!=null&&i.asset){const o=n.object.asset;o.userData||(o.userData={});const r={visible:o.visible,parent:o.parent,matrix:o.matrix.clone()};o.userData["image-tracking"]=r}}for(const n of this.imageToObjectMap.values())n.frames=0}onLeaveXR(e){var i,n;if(!this.supported&&J.isAndroidDevice()&&Me(this.webXRIncubationsWarning),this.trackedImages){for(const o of this.trackedImages)if((i=o.object)!=null&&i.asset){const r=o.object.asset;if(r.userData){const l=r.userData["image-tracking"];l&&(r.visible=l.visible,(n=l.parent)==null||n.add(r),r.matrix.copy(l.matrix),r.matrix.decompose(r.position,r.quaternion,r.scale)),delete r.userData["image-tracking"]}}}}onUpdateXR(e){var o;this.currentImages.length=0;const i=e.xr.frame;if(!i)return;if("getImageTrackingResults"in i){if(((o=e.xr.session.enabledFeatures)==null?void 0:o.includes("image-tracking"))===!1)return;if(i.session&&typeof i.getImageTrackingResults=="function"){const r=i.getImageTrackingResults();if(r.length>0){const l=this.context.renderer.xr.getReferenceSpace();if(l){for(const c of r){const h=c.trackingState,d=c.index,u=this.trackedImageIndexMap.get(d);if(u){const f=i.getPose(c.imageSpace,l),p=new Ta(this,u,c.image,c.measuredSize,h,f);this.currentImages.push(p)}else Yx&&console.warn("No tracked image for index",d)}if(this.currentImages.length>0)try{this.dispatchEvent(new CustomEvent("image-tracking",{detail:this.currentImages})),this.onImageTrackingUpdate(this.currentImages)}catch(c){console.error(c)}}}}}else{this.didPrintWarning||(this.didPrintWarning=!0,console.log(this.webXRIncubationsWarning)),this._supported=!1,Me(this.webXRIncubationsWarning);return}const n=1e3;for(const[r,l]of this.imageToObjectMap){if(!l.object||!r||r.hideWhenTrackingIsLost===!1)continue;let c=!1;for(const h of this.currentImages)if(h.model===r){const d=Date.now()-l.lastTrackingTime;if(r.imageDoesNotMove||h.state==="tracked"||d<=n){c=!0;break}}c||P.setActive(l.object,!1)}}};let Uo=Zl;a(Uo,"_imageElements",new Map);sa([m(nr)],Uo.prototype,"trackedImages",void 0);sa([m()],Uo.prototype,"smooth",void 0);var Qc=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const pa=C("debugplanetracking");class oa extends j{constructor(){super(...arguments);a(this,"dataTemplate");a(this,"occluder",!0);a(this,"initiateRoomCaptureIfNoData",!0);a(this,"usePlaneData",!0);a(this,"useMeshData",!0);a(this,"runInVR",!0);a(this,"bounds",new En);a(this,"center",new x);a(this,"labelOffset",new x);a(this,"_dataId",1);a(this,"_allPlanes",new Map);a(this,"_allMeshes",new Map);a(this,"firstTimeNoPlanesDetected",-100);a(this,"makeOccluder",(e,i,n=!1)=>{if(i){if(i instanceof Array){for(const o of i)this.makeOccluder(e,o,n);return}!n&&!i.name.toLowerCase().includes("occlu")||(i.colorWrite=!1,i.depthTest=!0,i.depthWrite=!0,i.transparent=!1,i.polygonOffset=!0,i.polygonOffsetFactor=1,i.polygonOffsetUnits=.1,e.renderOrder=-1e3)}});a(this,"_flipForwardMatrix",new le().makeRotationY(Math.PI));a(this,"_verticesCache",new Map)}get trackedPlanes(){return this._allPlanes.values()}get trackedMeshes(){return this._allMeshes.values()}onBeforeXR(e,i){e==="immersive-vr"&&!this.runInVR||(i.optionalFeatures=i.optionalFeatures||[],this.usePlaneData&&!i.optionalFeatures.includes("plane-detection")&&i.optionalFeatures.push("plane-detection"),this.useMeshData&&!i.optionalFeatures.includes("mesh-detection")&&i.optionalFeatures.push("mesh-detection"))}onEnterXR(e){for(const i of this._allPlanes.keys())this.removeData(i,this._allPlanes);for(const i of this._allMeshes.keys())this.removeData(i,this._allMeshes)}onLeaveXR(e){for(const i of this._allPlanes.keys())this.removeData(i,this._allPlanes);for(const i of this._allMeshes.keys())this.removeData(i,this._allMeshes)}onUpdateXR(e){if(!this.runInVR&&e.xr.isVR)return;const i=e.xr.rig;if(!i){console.warn("No XR rig found, cannot parent tracked planes to it");return}const n=e.xr.frame;if(!this.context.renderer.xr.getReferenceSpace())return;const l=n.detectedPlanes,c=n.detectedMeshes,h=l!==void 0&&l.size>0,d=c!==void 0&&c.size>0;if(this.initiateRoomCaptureIfNoData&&(!h&&!d&&this.firstTimeNoPlanesDetected<-10&&(this.firstTimeNoPlanesDetected=Date.now()),(h||d)&&(this.firstTimeNoPlanesDetected=-1),this.firstTimeNoPlanesDetected>0&&Date.now()-this.firstTimeNoPlanesDetected>2500&&"initiateRoomCapture"in n.session&&(n.session.initiateRoomCapture(),this.firstTimeNoPlanesDetected=-1)),l!==void 0&&this.processFrameData(e.xr,i.gameObject,n,l,this._allPlanes),c!==void 0&&this.processFrameData(e.xr,i.gameObject,n,c,this._allMeshes),pa){const u=this.context.mainCameraComponent.gameObject.worldPosition;for(const f of this._allPlanes.values())!f.mesh||!f.mesh.visible||(this.bounds.makeEmpty(),f.mesh.traverse(p=>{p instanceof Z&&this.bounds.expandByObject(p)}),this.bounds.getCenter(this.center),this.labelOffset.copy(u).sub(this.center).normalize().multiplyScalar(.1),G.DrawLabel(this.center.add(this.labelOffset),(f.xrData.semanticLabel||"plane").toUpperCase()+`
`+f.xrData.lastChangedTime.toFixed(2),.02))}}removeData(e,i){const n=i.get(e);if(!n)return;i.delete(e),pa&&console.log("Plane no longer tracked, id="+n.id),n.mesh&&(n.mesh.removeFromParent(),n.mesh.traverse(r=>{const l=r.userData.normalsHelper;l?(l.dispose(),l.removeFromParent()):pa&&console.warn("No normals helper found for mesh",n.mesh)}),Ln(n.mesh,!0,!0));const o=new CustomEvent("plane-tracking",{detail:{type:"plane-removed",context:n}});this.dispatchEvent(o)}processFrameData(e,i,n,o,r){const c=this.context.renderer.xr.getReferenceSpace();if(c){for(const h of r.keys())o.has(h)||this.removeData(h,r);for(const h of o){const d="planeSpace"in h?h.planeSpace:"meshSpace"in h?h.meshSpace:void 0;if(!d)continue;const u=n.getPose(d,c);let f;if(r.has(h)){const p=r.get(h);if(f=p.mesh,p.timestamp<h.lastChangedTime){if(p.timestamp=h.lastChangedTime,p.mesh){const y=this.createGeometry(h);if(p.mesh instanceof Z)p.mesh.geometry.dispose(),p.mesh.geometry=y,this.makeOccluder(p.mesh,p.mesh.material);else if(p.mesh instanceof Mr)for(const b of p.mesh.children)b instanceof Z&&(b.geometry.dispose(),b.geometry=y,this.makeOccluder(b,b.material));if(p.collider){const b=p.mesh;p.collider.sharedMesh=b,p.collider.convex=this.checkIfContextShouldBeConvex(b,p.xrData),p.collider.onDisable(),p.collider.onEnable()}pa&&(console.log("Plane updated, id="+p.id,p),p.mesh.traverse(b=>{if(!(b instanceof Z))return;const _=b.userData.normalsHelper;_&&_.update()}))}const g=new CustomEvent("plane-tracking",{detail:{type:"plane-updated",context:p}});this.dispatchEvent(g)}}else{if(!this.dataTemplate){const p=new Z;pa?p.material=new TR:this.occluder?(p.material=new Ue,this.makeOccluder(p,p.material,!0)):p.material=new Ue({wireframe:!0,opacity:.5,transparent:!0,color:3355443}),this.dataTemplate=new de("","",p)}if(!this.dataTemplate.asset)this.dataTemplate.loadAssetAsync();else{const p=P.instantiate(this.dataTemplate.asset);if(p.name="xr-tracked-plane",f=p,$w(p,!1),p instanceof Z)Ne(p.geometry),p.geometry=this.createGeometry(h),this.makeOccluder(p,p.material,this.occluder&&!this.dataTemplate);else if(p instanceof Mr)for(const b of p.children)b instanceof Z&&(Ne(b.geometry),b.geometry=this.createGeometry(h),this.makeOccluder(b,b.material,this.occluder&&!this.dataTemplate));const g=p.getComponent(nl);if(g){const b=p;g.sharedMesh=b,g.convex=this.checkIfContextShouldBeConvex(b,h),g.onDisable(),g.onEnable()}p.matrixAutoUpdate=!1,p.matrixWorldNeedsUpdate=!0,i.add(p);const y={id:this._dataId++,xrData:h,timestamp:h.lastChangedTime,mesh:p,collider:g};r.set(h,y),pa&&console.log("New plane detected, id="+y.id,y,{hasCollider:!!g,isGroup:p instanceof Mr});try{const b=new CustomEvent("plane-tracking",{detail:{type:"plane-added",context:y}});this.dispatchEvent(b)}catch(b){console.error(b)}}}f&&(u?(f.visible=!0,f.matrix.fromArray(u.transform.matrix),f.matrix.premultiply(this._flipForwardMatrix)):f.visible=!1,pa&&f.traverse(p=>{if(p instanceof Z)if(p.userData.normalsHelper)p.userData.normalsHelper.update();else{const g=new KR(p,.05,255);g.layers.disableAll(),g.layers.set(2),this.context.scene.add(g),p.userData.normalsHelper=g}}))}}}checkIfContextShouldBeConvex(e,i){if(!e)return!0;if(e){const n=new En;n.expandByObject(e);const o=new x;n.getSize(o);let r=!0;return o.x>2&&o.y>2&&o.z>1.5&&(r=!1),r&&"semanticLabel"in i&&i.semanticLabel==="wall"&&(r=!0),r}return!0}createGeometry(e){return"polygon"in e?this.createPlaneGeometry(e.polygon):"vertices"in e&&"indices"in e?this.createMeshGeometry(e.vertices,e.indices):new ko}createMeshGeometry(e,i){const n=e.toString()+"_"+i.toString();if(this._verticesCache.has(n))return this._verticesCache.get(n);const o=new ko;o.setIndex(new $i(i,1)),o.setAttribute("position",new $i(e,3));const r=Array();for(let l=0;l<e.length;l+=3)r.push(e[l],e[l+2]);return o.setAttribute("uv",new $i(e,3)),o.computeVertexNormals(),this._verticesCache.set(n,o),o}createPlaneGeometry(e){const i=new ko,n=[],o=[];e.forEach(p=>{n.push(p.x,p.y,p.z),o.push(p.x,p.z)});const r=new x(n[0],n[1],n[2]),l=new x(n[3],n[4],n[5]),c=new x(n[6],n[7],n[8]),h=new x,d=new x;h.subVectors(l,r),d.subVectors(c,r),h.cross(d),h.normalize();const u=[];for(let p=0;p<n.length/3;p++)u.push(h.x,h.y,h.z);const f=[];for(let p=2;p<e.length;++p)f.push(0,p-1,p);return i.setAttribute("position",new $i(new Float32Array(n),3)),i.setAttribute("uv",new $i(new Float32Array(o),2)),i.setAttribute("normal",new $i(new Float32Array(u),3)),i.setIndex(f),i.computeBoundingBox(),i.computeBoundingSphere(),i}}Qc([m(de)],oa.prototype,"dataTemplate",void 0);Qc([m()],oa.prototype,"occluder",void 0);Qc([m()],oa.prototype,"initiateRoomCaptureIfNoData",void 0);Qc([m()],oa.prototype,"usePlaneData",void 0);Qc([m()],oa.prototype,"useMeshData",void 0);Qc([m()],oa.prototype,"runInVR",void 0);var sD=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const Kx=C("debugwebxr");class Vb extends j{constructor(){super(...arguments);a(this,"priority",0);a(this,"_startScale")}get isActive(){return this.activeAndEnabled&&this.gameObject.visible}setAsActiveXRRig(){var e;(e=te.active)==null||e.setRigActive(this)}setPriority(e){this.priority=e}awake(){if(Kx){const e=new F;e.position.y+=.5,this.gameObject.add(e);const i=e.addNewComponent(Nc);i&&(i.isGizmo=!1);const n=new ln(.5);this.gameObject.add(n)}}isXRRig(){return!0}supportsXR(e){return!0}onEnterXR(e){this._startScale=this.gameObject.scale.clone(),e.xr.addRig(this),Kx&&console.log("WebXR: add Rig",this.name,this.priority)}onLeaveXR(e){e.xr.removeRig(this),this._startScale&&this.gameObject&&this.gameObject.scale.copy(this._startScale)}}sD([m()],Vb.prototype,"priority",void 0);class Q1{}const oD=Object.freeze(Object.defineProperty({__proto__:null,ActionBuilder:we,ActionCollection:v1,ActionModel:Ni,AlignmentConstraint:Hp,Animation:Mi,AnimationCurve:Zn,AnimationExtension:Zp,AnimationTrackHandler:zb,Animator:pi,AnimatorController:An,Antialiasing:dm,AudioExtension:rl,AudioListener:Rr,AudioSource:Oe,AudioTrackHandler:dc,Avatar:Xa,AvatarBlink_Simple:Lc,AvatarEyeLook_Rotation:jr,AvatarLoader:GC,AvatarMarker:It,AvatarModel:lb,Avatar_Brain_LookAt:Uf,Avatar_MouthShapes:Qp,Avatar_MustacheShake:VC,Avatar_POI:Do,AxesHelper:Hd,BaseUIComponent:ls,BasicIKConstraint:qC,BehaviorExtension:yb,BehaviorModel:Bt,BloomEffect:Bo,BoxCollider:il,BoxGizmo:Nc,BoxHelperComponent:rn,Button:ia,CallInfo:wo,Camera:Se,CameraTargetReachedEvent:Ff,Canvas:Ft,CanvasGroup:qa,CapsuleCollider:Vr,ChangeMaterialOnClick:Yn,ChangeTransformOnClick:zc,CharacterController:jc,CharacterControllerInput:Qr,ChromaticAberration:um,Collider:fn,ColorAdjustments:fl,ColorBySpeedModule:Vc,ColorOverLifetimeModule:cm,ContactShadows:cn,ControlTrackHandler:Ub,CustomBranding:cl,Deletable:YC,DeleteBox:ac,DepthOfField:to,DeviceFlag:hb,DocumentExtension:w1,DragControls:Dt,DropListener:Yr,Duplicatable:ol,EffectWrapper:ip,EmissionModule:er,EmphasizeOnClick:Xd,EventList:Te,EventListEvent:ib,EventSystem:Gi,EventTrigger:pb,FieldWithDefault:o1,FixedJoint:A1,Fog:Jd,GltfExport:Ls,GltfExportBox:l1,Gradient:hl,Graphic:jo,GraphicRaycaster:nb,GridHelper:Zd,GridLayoutGroup:k1,GroundProjectedEnv:Xo,GroupActionModel:kr,HideOnStart:Ra,HingeJoint:rm,HorizontalLayoutGroup:T1,Image:au,InheritVelocityModule:tr,InputField:Rn,InstanceHandle:lc,InstancingHandler:Or,Interactable:QC,Keyframe:Hi,LODGroup:am,LODModel:$c,Light:gn,LimitVelocityOverLifetimeModule:Pt,LogStats:XC,LookAt:zo,LookAtConstraint:Dc,MainModule:gi,MaskableGraphic:im,MeshCollider:nl,MeshRenderer:Jp,MinMaxCurve:X,MinMaxGradient:Lt,NeedleMenu:Zo,NestedGltf:Eb,Networking:Hr,NoiseModule:Ie,ObjectRaycaster:jn,OffsetConstraint:Wc,OpenURL:lu,OrbitControls:ke,Outline:Kd,Padding:al,ParticleBurst:Jf,ParticleSubEmitter:Ab,ParticleSystem:it,ParticleSystemRenderer:ds,PhysicsExtension:_b,PixelationEffect:pm,PlayAnimationOnClick:Us,PlayAudioOnClick:Ga,PlayableDirector:Gs,PlayerColor:Ed,PointerEventData:Vd,PostProcessingHandler:jb,PreliminaryAction:Qd,PreliminaryTrigger:em,RawImage:$b,Rect:C1,RectTransform:Yt,ReflectionProbe:Oo,RegisteredAnimationInfo:Tr,RemoteSkybox:Go,Renderer:Ve,RendererLightmap:Gf,Rigidbody:ve,RotationBySpeedModule:zn,RotationOverLifetimeModule:hs,SceneSwitcher:vt,ScreenCapture:gl,ScreenSpaceAmbientOcclusion:Zr,ScreenSpaceAmbientOcclusionN8:io,SetActiveOnClick:Pn,ShadowCatcher:gm,ShapeModule:ze,SharpeningEffect:mm,SignalAsset:bm,SignalReceiver:Fr,SignalReceiverEvent:ru,SignalTrackHandler:op,Size:S1,SizeBySpeedModule:Qi,SizeOverLifetimeModule:dl,SkinnedMeshRenderer:r1,SmoothFollow:Hs,SpatialGrabRaycaster:Fa,SpatialHtml:Cm,SpatialTrigger:Na,SpatialTriggerReceiver:Fo,SpectatorCamera:Fb,SphereCollider:Gd,Sprite:Jo,SpriteData:ns,SpriteRenderer:mn,SpriteSheet:kc,SubEmitterSystem:tp,SyncedCamera:hc,SyncedRoom:no,SyncedTransform:Wo,TapGestureTrigger:x1,TeleportTarget:Cb,TestRunner:$1,TestSimulateUserData:W1,Text:Di,TextBuilder:bb,TextExtension:nm,TextureSheetAnimationModule:yi,TiltShiftEffect:ir,ToneMappingEffect:Ho,TrailModule:st,TransformData:Ke,TransformGizmo:qc,TriggerBuilder:Qt,TriggerModel:Lo,UIRaycastUtils:sb,UIRootComponent:qp,USDZExporter:Fe,USDZText:Oa,USDZUIExtension:xb,UsageMarker:Kp,VariantAction:b1,VelocityOverLifetimeModule:at,VerticalLayoutGroup:O1,VideoPlayer:zt,Vignette:Gc,VisibilityAction:tm,Voip:tl,Volume:iu,VolumeParameter:$,VolumeProfile:hm,WebARCameraBackground:Rm,WebARSessionRoot:es,WebXR:Ze,WebXRImageTracking:Uo,WebXRImageTrackingModel:nr,WebXRPlaneTracking:oa,WebXRTrackedImage:Ta,XRControllerFollow:na,XRControllerModel:Vo,XRControllerMovement:Bn,XRFlag:qt,XRRig:Vb,XRState:ci,__Ignore:Q1},Symbol.toStringTag,{value:"Module"}));class rD extends j{constructor(){super(...arguments);a(this,"toggleKey","KeyP")}update(){this.context.input.isKeyDown(this.toggleKey)&&this.context.domElement.classList.toggle("presentation-mode")}}w.add("AlignmentConstraint",Hp);w.add("Animation",Mi);w.add("Keyframe",Hi);w.add("AnimationCurve",Zn);w.add("Animator",pi);w.add("AnimatorController",An);w.add("AudioListener",Rr);w.add("AudioSource",Oe);w.add("Avatar_POI",Do);w.add("Avatar_Brain_LookAt",Uf);w.add("Avatar_MouthShapes",Qp);w.add("Avatar_MustacheShake",VC);w.add("AvatarBlink_Simple",Lc);w.add("AvatarEyeLook_Rotation",jr);w.add("AvatarModel",lb);w.add("AvatarLoader",GC);w.add("AxesHelper",Hd);w.add("BasicIKConstraint",qC);w.add("BoxHelperComponent",rn);w.add("Camera",Se);w.add("CharacterController",jc);w.add("CharacterControllerInput",Qr);w.add("__Ignore",Q1);w.add("Collider",fn);w.add("SphereCollider",Gd);w.add("BoxCollider",il);w.add("MeshCollider",nl);w.add("CapsuleCollider",Vr);w.add("ContactShadows",cn);w.add("LogStats",XC);w.add("DeleteBox",ac);w.add("Deletable",YC);w.add("DeviceFlag",hb);w.add("DragControls",Dt);w.add("DropListener",Yr);w.add("Duplicatable",ol);w.add("CallInfo",wo);w.add("EventListEvent",ib);w.add("EventList",Te);w.add("EventTrigger",pb);w.add("GltfExportBox",l1);w.add("GltfExport",Ls);w.add("RegisteredAnimationInfo",Tr);w.add("TransformData",Ke);w.add("AnimationExtension",Zp);w.add("VariantAction",b1);w.add("ActionCollection",v1);w.add("AudioExtension",rl);w.add("BehaviorExtension",yb);w.add("ChangeTransformOnClick",zc);w.add("ChangeMaterialOnClick",Yn);w.add("SetActiveOnClick",Pn);w.add("HideOnStart",Ra);w.add("EmphasizeOnClick",Xd);w.add("PlayAudioOnClick",Ga);w.add("PlayAnimationOnClick",Us);w.add("PreliminaryAction",Qd);w.add("PreliminaryTrigger",em);w.add("VisibilityAction",tm);w.add("TapGestureTrigger",x1);w.add("BehaviorModel",Bt);w.add("TriggerModel",Lo);w.add("TriggerBuilder",Qt);w.add("GroupActionModel",kr);w.add("ActionModel",Ni);w.add("ActionBuilder",we);w.add("PhysicsExtension",_b);w.add("DocumentExtension",w1);w.add("USDZText",Oa);w.add("TextBuilder",bb);w.add("TextExtension",nm);w.add("USDZUIExtension",xb);w.add("CustomBranding",cl);w.add("USDZExporter",Fe);w.add("Fog",Jd);w.add("BoxGizmo",Nc);w.add("GridHelper",Zd);w.add("GroundProjectedEnv",Xo);w.add("UsageMarker",Kp);w.add("Interactable",QC);w.add("FixedJoint",A1);w.add("HingeJoint",rm);w.add("Light",gn);w.add("LODModel",$c);w.add("LODGroup",am);w.add("LookAtConstraint",Dc);w.add("NeedleMenu",Zo);w.add("NestedGltf",Eb);w.add("Networking",Hr);w.add("OffsetConstraint",Wc);w.add("CameraTargetReachedEvent",Ff);w.add("OrbitControls",ke);w.add("ParticleSystemRenderer",ds);w.add("ParticleSystem",it);w.add("SubEmitterSystem",tp);w.add("Gradient",hl);w.add("MinMaxCurve",X);w.add("MinMaxGradient",Lt);w.add("MainModule",gi);w.add("ParticleBurst",Jf);w.add("EmissionModule",er);w.add("ColorOverLifetimeModule",cm);w.add("SizeOverLifetimeModule",dl);w.add("ShapeModule",ze);w.add("NoiseModule",Ie);w.add("TrailModule",st);w.add("VelocityOverLifetimeModule",at);w.add("TextureSheetAnimationModule",yi);w.add("RotationOverLifetimeModule",hs);w.add("RotationBySpeedModule",zn);w.add("LimitVelocityOverLifetimeModule",Pt);w.add("InheritVelocityModule",tr);w.add("SizeBySpeedModule",Qi);w.add("ColorBySpeedModule",Vc);w.add("ParticleSubEmitter",Ab);w.add("PlayerColor",Ed);w.add("Antialiasing",dm);w.add("BloomEffect",Bo);w.add("ChromaticAberration",um);w.add("ColorAdjustments",fl);w.add("DepthOfField",to);w.add("EffectWrapper",ip);w.add("PixelationEffect",pm);w.add("ScreenSpaceAmbientOcclusion",Zr);w.add("ScreenSpaceAmbientOcclusionN8",io);w.add("SharpeningEffect",mm);w.add("TiltShiftEffect",ir);w.add("ToneMappingEffect",Ho);w.add("Vignette",Gc);w.add("PostProcessingHandler",jb);w.add("Volume",iu);w.add("VolumeParameter",$);w.add("VolumeProfile",hm);w.add("ReflectionProbe",Oo);w.add("FieldWithDefault",o1);w.add("Renderer",Ve);w.add("MeshRenderer",Jp);w.add("SkinnedMeshRenderer",r1);w.add("InstancingHandler",Or);w.add("InstanceHandle",lc);w.add("RendererLightmap",Gf);w.add("Rigidbody",ve);w.add("SceneSwitcher",vt);w.add("ScreenCapture",gl);w.add("ShadowCatcher",gm);w.add("RemoteSkybox",Go);w.add("SmoothFollow",Hs);w.add("SpatialTriggerReceiver",Fo);w.add("SpatialTrigger",Na);w.add("SpectatorCamera",Fb);w.add("Sprite",Jo);w.add("SpriteSheet",kc);w.add("SpriteData",ns);w.add("SpriteRenderer",mn);w.add("SyncedCamera",hc);w.add("SyncedRoom",no);w.add("SyncedTransform",Wo);w.add("TestRunner",$1);w.add("TestSimulateUserData",W1);w.add("PlayableDirector",Gs);w.add("SignalAsset",bm);w.add("SignalReceiverEvent",ru);w.add("SignalReceiver",Fr);w.add("AnimationTrackHandler",zb);w.add("AudioTrackHandler",dc);w.add("SignalTrackHandler",op);w.add("ControlTrackHandler",Ub);w.add("TransformGizmo",qc);w.add("BaseUIComponent",ls);w.add("UIRootComponent",qp);w.add("Button",ia);w.add("Canvas",Ft);w.add("CanvasGroup",qa);w.add("EventSystem",Gi);w.add("Graphic",jo);w.add("MaskableGraphic",im);w.add("Image",au);w.add("RawImage",$b);w.add("InputField",Rn);w.add("Padding",al);w.add("VerticalLayoutGroup",O1);w.add("HorizontalLayoutGroup",T1);w.add("GridLayoutGroup",k1);w.add("Outline",Kd);w.add("PointerEventData",Vd);w.add("ObjectRaycaster",jn);w.add("GraphicRaycaster",nb);w.add("SpatialGrabRaycaster",Fa);w.add("UIRaycastUtils",sb);w.add("Size",S1);w.add("Rect",C1);w.add("RectTransform",Yt);w.add("SpatialHtml",Cm);w.add("Text",Di);w.add("LookAt",zo);w.add("OpenURL",lu);w.add("VideoPlayer",zt);w.add("Voip",tl);w.add("Avatar",Xa);w.add("XRControllerFollow",na);w.add("XRControllerModel",Vo);w.add("XRControllerMovement",Bn);w.add("TeleportTarget",Cb);w.add("WebARCameraBackground",Rm);w.add("WebARSessionRoot",es);w.add("WebXR",Ze);w.add("AvatarMarker",It);w.add("WebXRTrackedImage",Ta);w.add("WebXRImageTrackingModel",nr);w.add("WebXRImageTracking",Uo);w.add("WebXRPlaneTracking",oa);w.add("XRRig",Vb);w.add("XRState",ci);w.add("XRFlag",qt);w.add("PlayerSync",ll);w.add("PlayerState",Xt);w.add("PresentationMode",rD);const nd=At,aD=C("debugtypestore");aD&&console.log(w);function lD(s,t){const i=PE(s,t);return i!==void 0?i:null}const cD=new CE,Zg=Symbol("deserialize-queue");async function hD(s,t,e,i=null,n){if(!e){console.debug("Can not create component instances: gltf is null");return}let o=i;typeof o=="number"&&(o=new ui(i));const r=t.indexOf("?");t=r===-1?t:t.substring(0,r);const l=new fC(e.scene);l.gltfId=t,l.context=s,l.gltf=e,l.nodeToObject=n==null?void 0:n.nodeToObjectMap,l.implementationInformation=cD;let c=s[Zg];if(c||(c=s[Zg]=[]),e.scenes)for(const h of e.scenes)await v_(l,h,c);if(e.children)for(const h of e.children)await v_(l,h,c);s.new_scripts_pre_setup_callbacks.push(()=>{const h=s[Zg];if(h){for(const d of h)dD(d,l);h.length=0}if(o){const d={},u=[];b_(e,o,d,u);for(const f of e.scenes)b_(f,o,d,u);for(const f of u)f.resolveGuids(d)}})}const __=Symbol("original-component-name"),Ol=new Map;function b_(s,t,e,i){if(t===null||!s)return;const n=s.guid,o=s.guid;o!=null&&o.length&&(Ol.has(o)||(nd&&console.log('Creating InstanceIdProvider with key "'+o+'" for object '+s.name),Ol.set(o,new ui(o))));const r=o&&Ol.get(o)||t;if(s.guid=r.generateUUID(),n&&n!=="invalid"&&(e[n]=s.guid),s&&s.userData&&s.userData.components)for(const l of s.userData.components){if(l===null)continue;const c=l.guid;c?Ol.has(c)||(nd&&console.log('Creating InstanceIdProvider with key "'+c+'" for component '+l[__]),Ol.set(c,new ui(c))):nd&&console.warn("Can not create IdProvider: component "+l[__]+" has no guid",l.guid);const h=Ol.get(c)||t,d=l.guid;l.guid=h.generateUUID(),d&&d!=="invalid"&&(e[d]=l.guid),l.resolveGuids&&i.push(l)}if(s.children)for(const l of s.children)b_(l,t,e,i)}const xh=[];async function v_(s,t,e,i){var o,r,l,c,h;if(!t)return;const n=t.userData;if(n){const d=n.builtin_components;if(d&&d.length>0)for(const u of d)try{if(u===null)continue;const f=w.get(u.name);if(f!=null){const p=new f;p.sourceId=s.gltfId,wc(p,u,s.implementationInformation),p.context=s.context,"guid"in u&&(p[Yu]=u.guid),p[__]=u.name,oc(t,p,!1),e.push({instance:p,compData:u,obj:t}),p.isCamera&&s.context&&s.context.mainCamera===null&&p.tag==="MainCamera"&&s.context.setCurrentCamera(p),((l=(r=(o=s.context)==null?void 0:o.physics)==null?void 0:r.engine)==null?void 0:l.isInitialized)===!1&&(p.isCollider||p.isRigidbody)&&((h=(c=s.context)==null?void 0:c.physics.engine)==null||h.initialize())}else nd&&console.debug("unknown component: "+u.name),xh.includes(u.name)||xh.push(u.name)}catch(f){console.error(u.name+" - "+f.message,f)}if(xh.length>0){const u=xh.join(", ");console.warn("unknown components: "+u),xh.length=0,qi()&&tt(`<strong>Unknown components in scene</strong>:

${u}

This could mean you forgot to add a npmdef to your ExportInfo
<a href="https://engine.needle.tools/docs/project_structure.html#creating-and-installing-a-npmdef" target="_blank">documentation</a>`,_t.Warn)}}if(t.children)for(const d of t.children)await v_(s,d,e)}function dD(s,t){const{instance:e,compData:i,obj:n}=s;t.object=n,t.target=e,zy(e,i,t),nd&&console.debug("add "+i.name,i,e)}const ap=C("debugfileformat");async function uD(s,t=!0){var n;if(t){const o=s,r=new URL(o,globalThis.location.origin);let l=null;const c=r.searchParams.get("filetype");switch(c&&(l=c.toUpperCase()),l!=null&&l.length||(l=(n=r.pathname.split(".").pop())==null?void 0:n.toUpperCase()),ap&&console.debug("Use file extension to determine type: "+l),l){case"GLTF":return"gltf";case"VRM":return"vrm";case"GLB":return"glb";case"FBX":return"fbx";case"USD":return"usd";case"USDA":return"usda";case"USDZ":return"usdz";case"OBJ":return"obj"}}const e=new URL(s);e.searchParams.append("range","true");const i=await fetch(e,{method:"GET",headers:{range:"bytes=0-32"}}).catch(o=>null);if(i!=null&&i.ok){const o=await i.arrayBuffer(),r=fD(o,i);return ap&&console.log("Determined file type from header: "+r),r}return"unknown"}function fD(s,t){if(s.byteLength<4)return"unknown";const e=new Uint8Array(s);if(ap&&console.warn(`Trying to determine file type from binary data
`,'"'+new TextDecoder().decode(s)+`"
`,e),e[0]==103&&e[1]==108&&e[2]==84&&e[3]==70)return console.debug("GLTF detected"),"glb";if(e[0]==80&&e[1]==75&&e[2]==3&&e[3]==4)return console.debug("USDZ detected"),"usdz";if(e[0]==80&&e[1]==88&&e[2]==82&&e[3]==45&&e[4]==85&&e[5]==83&&e[6]==68&&e[7]==67)return console.debug("Binary USD detected"),"usd";if(e[0]==35&&e[1]==117&&e[2]==115&&e[3]==100&&e[4]==97)return console.debug("ASCII USD detected"),"usda";if(e[0]==75&&e[1]==97&&e[2]==121&&e[3]==100&&e[4]==97&&e[5]==114&&e[6]==97&&e[7]==32)return console.debug("Binary FBX detected"),"fbx";if(e[0]==59&&e[1]==32&&e[2]==70&&e[3]==66&&e[4]==88&&e[5]==32)return console.debug("ASCII FBX detected"),"fbx";if(e[0]==35&&e[1]==32&&e[2]==66&&e[3]==108&&e[4]==101&&e[5]==110&&e[6]==100&&e[7]==101&&e[8]==114&&e[9]==32)return console.debug("OBJ detected"),"obj";if(e[0]==35&&e[1]==32&&e[2]==65&&e[3]==108&&e[4]==105&&e[5]==97&&e[6]==115&&e[7]==32&&e[8]==79&&e[9]==66&&e[10]==74)return console.debug("OBJ detected"),"obj";if(t.headers.has("content-type")){const i=t.headers.get("content-type");switch(console.debug("Content-Type: "+i),i){case"model/gltf+json":return"gltf";case"model/gltf-binary":return"glb";case"model/vrm":return"vrm";case"model/vnd.usdz+zip":return"usdz";case"model/vnd.usd+zip":return"usd";case"model/vnd.usda+zip":return"usda";case"model/fbx":return"fbx";case"model/obj":return"obj"}}if(e[0]==118&&e[1]==32||e[0]==102&&e[1]==32)return console.debug("OBJ detected (the file has no header and starts with vertex or face)"),"obj";if(e[0]==35&&e[1]==32&&e[2]==70&&e[3]==105&&e[4]==108&&e[5]==101&&e[6]==32&&e[7]==101&&e[8]==120&&e[9]==112&&e[10]==111&&e[11]==114&&e[12]==116&&e[13]==101&&e[14]==100&&e[15]==32&&e[16]==98&&e[17]==121&&e[18]==32&&e[19]==90&&e[20]==66&&e[21]==114&&e[22]==117&&e[23]==115&&e[24]==104)return console.debug("OBJ detected (exported by ZBrush)"),"obj";if(e[0]==109&&e[1]==116&&e[2]==108&&e[3]==108&&e[4]==105&&e[5]==98)return console.debug("OBJ detected (mtllib)"),"obj";if(U()||ap){const i=new TextDecoder().decode(s.slice(0,16));console.debug('Could not determine file type from binary data: "'+i+'..."',e)}else console.debug("Could not determine file type from binary data",e);return"unknown"}class Y1{createBuiltinComponents(t,e,i,n,o){return hD(t,e,i,n,o)}writeBuiltinComponentData(t,e){return lD(t,e)}parseSync(t,e,i,n){return mD(t,e,i,n)}loadSync(t,e,i,n,o){return tP(t,e,i,n,o)}}Ow(Y1);const K1=C("printGltf")||C("printgltf"),J1=C("downloadgltf"),pD=C("debugfileformat");var zr;(function(s){s[s.BeforeLoad=0]="BeforeLoad",s[s.AfterLoaded=1]="AfterLoaded",s[s.FinishedSetup=10]="FinishedSetup"})(zr||(zr={}));class uc{constructor(t,e,i,n){a(this,"context");a(this,"loader");a(this,"path");a(this,"gltf");this.context=t,this.path=e,this.loader=i,this.gltf=n}}const Ur={};function GL(s,t){Ur[s]=Ur[s]||[],Ur[s].push(t)}function qL(s,t){if(Ur[s]){const e=Ur[s].indexOf(t);e>=0&&Ur[s].splice(e,1)}}function fc(s,t){if(Ur[s])for(const e of Ur[s])e(t)}async function Z1(s,t,e,i,n){K1&&console.warn("glTF",t,e),t.includes("?")&&(t=t.split("?")[0]),await qs().createBuiltinComponents(s,t,e,i,n)}async function eP(s,t){const e=await uD(s)||"unknown";switch(pD&&console.debug("Determined file type: "+e+" for url",s),e){case"unknown":{console.warn("Unknown file type. Assuming glTF:",s);const i=new Va;return await t_(i,t,s),i}case"fbx":return new Cw;case"obj":return new E_;case"usd":case"usda":case"usdz":return console.warn(e.toUpperCase()+" files are not supported."),null;default:console.warn("Unknown file type:",e);case"gltf":case"glb":case"vrm":{const i=new Va;return await t_(i,t,s),i}}}async function mD(s,t,e,i){typeof e!="string"&&(console.warn("Parse gltf binary without path, this might lead to errors in resolving extensions. Please provide the source path of the gltf/glb file",e,typeof e),e=""),K1&&console.log("Parse glTF",e);const n=await eP(e,s);if(!n)return;if(n instanceof E_){typeof t!="string"&&(t=new TextDecoder().decode(t));const l=n.parse(t);return{animations:l.animations,scene:l,scenes:[l]}}if(!(n instanceof Va)){const l=n.parse(t,e);return sP(n,l),{animations:l.animations,scene:l,scenes:[l]}}const r=mb(n);return new Promise((l,c)=>{try{let h=e.split("?")[0].trimEnd();{const u=h.split("/");u.length>0&&u[u.length-1]!==""&&u.pop(),h=u.join("/"),h.endsWith("/")||(h+="/")}n.resourcePath=h,Vp(n,s),fc(zr.BeforeLoad,new uc(s,e,n));const d=s.mainCamera;n.parse(t,"",async u=>{i1(e,u,s),fc(zr.AfterLoaded,new uc(s,e,n,u)),await Z1(s,e,u,i,r),await iP(u.scene,s,d),fc(zr.FinishedSetup,new uc(s,e,n,u)),l(u),J1&&nP(t)},u=>{console.error('Loading asset at "'+e+`" failed
`,u),l(void 0)})}catch(h){console.error(h),c(h)}})}async function tP(s,t,e,i,n){gD(t);const o=await eP(t,s);if(!o)return;if(!(o instanceof Va)){const l=await o.loadAsync(t,n);return sP(o,l),{animations:l.animations,scene:l,scenes:[l]}}const r=mb(o);return new Promise((l,c)=>{try{Vp(o,s),fc(zr.BeforeLoad,new uc(s,t,o));const h=s.mainCamera;o.load(t,async d=>{i1(t,d,s),fc(zr.AfterLoaded,new uc(s,t,o,d)),await Z1(s,e,d,i,r),await iP(d.scene,s,h),fc(zr.FinishedSetup,new uc(s,t,o,d)),l(d),J1&&nP(t)},d=>{n==null||n.call(o,d)},d=>{console.error('Loading asset at "'+t+`" failed
`,d),l(void 0)})}catch(h){console.error(h),c(h)}})}async function iP(s,t,e){e||(e=t.mainCamera);try{e?await t.renderer.compileAsync(s,e,t.scene).catch(i=>{console.warn(i.message)}):Xk(s,t)}catch(i){console.warn((i==null?void 0:i.message)||i)}}function gD(s){if(new URL(s,window.location.href).href.startsWith("file://")){const e=`Hi - it looks like you are trying to load a local file which will not work. You need to use a webserver to serve your files.
Please refer to the documentation on <a href="https://fwd.needle.tools/needle-engine/docs/local-server">https://docs.needle.tools</a> or ask for help in our <a href="https://discord.needle.tools">discord community</a>`;tt(e),console.warn(e)}}function nP(s){if(typeof s=="string"){const t=document.createElement("a");t.href=s,t.download=s.split("/").pop(),t.click()}else{const t=new Blob([s],{type:"application/octet-stream"}),e=window.URL.createObjectURL(t),i=document.createElement("a");i.href=e,i.download="download.glb",i.click()}}function sP(s,t){if(t!=null&&t.isObject3D){const e=t;(s instanceof Cw||s instanceof E_)&&e.traverse(i=>{const n=i;n!=null&&n.isMesh&&Ww(n,n.material)})}}Ow(Y1);const qe=C("debugwebcomponent"),Jx="needle-engine",oP="vr",rP="desktop",yD=[IC,oP,rP],wh="ar-session-active",Sh="desktop-session-active",_D=["public-key","version","hash","src","camera-controls","loadstart","progress","loadfinished","dracoDecoderPath","dracoDecoderType","ktx2DecoderPath","tone-mapping","tone-mapping-exposure","background-blurriness","background-color"];class aP extends HTMLElement{constructor(){super();a(this,"_context");a(this,"_overlay_ar");a(this,"_loadingProgress01",0);a(this,"_loadingView");a(this,"_previousSrc",null);a(this,"_didFullyLoad",!1);a(this,"_loadId",0);a(this,"_abortController",null);a(this,"_lastSourceFiles",null);a(this,"_createContextPromise",null);a(this,"onXRSessionStarted",()=>{var i;const e=this.context.xrSessionMode;e==="immersive-ar"?this.onEnterAR(this.context.xrSession):e==="immersive-vr"&&this.onEnterVR(this.context.xrSession),(i=this.context.xrSession)==null||i.addEventListener("end",()=>{this.dispatchEvent(new CustomEvent("xr-session-ended",{detail:{session:this.context.xrSession,context:this._context,sessionMode:e}})),e==="immersive-ar"?this.onExitAR(this.context.xrSession):e==="immersive-vr"&&this.onExitVR(this.context.xrSession)})});a(this,"onReady",()=>{var e;return(e=this._loadingView)==null?void 0:e.onLoadingFinished()});a(this,"onError",()=>{var e;return(e=this._loadingView)==null?void 0:e.setMessage("Loading failed!")});a(this,"_previouslyRegisteredMap",new Map);this._overlay_ar=new LM,this.addEventListener("ready",this.onReady),kC(),this.attachShadow({mode:"open"});const e=document.createElement("template");e.innerHTML=`<style>
    @import url('https://fonts.googleapis.com/css2?family=Roboto+Flex:opsz,wght@8..144,100..1000&display=swap');

    :host {
        position: absolute;
        display: block;
        width: max(600px, 100%);
        height: max(300px, 100%);
        touch-action: none;

        -webkit-tap-highlight-color: transparent;
    }

    @media (max-width: 600px) {
        :host {
            width: 100%;
        }
    }
    @media (max-height: 300px) {
        :host {
            height: 100%;
        }
    }

    :host > div.canvas-wrapper {
        width: 100%;
        height: 100%;
    }

    :host canvas {   
        position: absolute;
        user-select: none;
        -webkit-user-select: none;

        /** allow touch panning but no pinch zoom **/
        /** but this doesnt work yet: 
         * touch-action: pan-x, pan-y;
         **/
        
        -webkit-touch-callout: none;
        -webkit-user-drag: none;
        -webkit-user-modify: none;
    }
    :host .content {
        position: absolute;
        top: 0;
        width: 100%;
        height: 100%;
        visibility: visible;
        z-index: 500; /* < must be less than the webxr buttons element */
        pointer-events: none;
    }
    :host .overlay-content {
        position: absolute;
        user-select: auto;
        pointer-events: all;
    }
    :host slot[name="quit-ar"]:hover {
        cursor: pointer;
    }
    :host .quit-ar-button {
        position: absolute;
        // top: env(titlebar-area-y); /** this doesnt work **/
        top: 60px; /** camera access needs a bit more space **/
        right: 20px;
        z-index: 9999;
    }
</style>
<div class="canvas-wrapper"> <!-- this wrapper is necessary for WebXR https://github.com/meta-quest/immersive-web-emulator/issues/55 -->
    <canvas></canvas>
</div>
<div class="content">
    <slot class="overlay-content"></slot>
</div>
`,this.shadowRoot&&this.shadowRoot.appendChild(e.content.cloneNode(!0)),this._context=new ne({domElement:this}),this.addEventListener("error",this.onError)}static get observedAttributes(){return _D}get loadingProgress01(){return this._loadingProgress01}get loadingFinished(){return this.loadingProgress01>.999}get cameraControls(){const e=this.getAttribute("camera-controls");return e==null?null:!(e===null||e==="False"||e==="false"||e==="0"||e==="none")}getContext(){return new Promise((e,i)=>{if(this._context&&this.loadingFinished)e(this._context);else{const n=()=>{this.removeEventListener("loadfinished",n),this._context&&this.loadingFinished&&e(this._context)};this.addEventListener("loadfinished",n)}})}get context(){return this._context}async connectedCallback(){if(qe&&console.log("<needle-engine> connected"),this.setPublicKey(),this.setVersion(),this.addEventListener("xr-session-started",this.onXRSessionStarted),this.onSetupDesktop(),!this.getAttribute("src")){const i=globalThis["needle:codegen_files"];qe&&console.log('src is null, trying to load from globalThis["needle:codegen_files"]',i),i&&(qe&&console.log('globalThis["needle:codegen_files"]',i),this.setAttribute("src",i))}qe&&console.log("src",this.getAttribute("src"));const e=this._loadId;setTimeout(()=>{this.isConnected!==!1&&e===this._loadId&&this.onLoad()},1)}disconnectedCallback(){var n;this.removeEventListener("xr-session-started",this.onXRSessionStarted),this._didFullyLoad=!1;const e=this.getAttribute("keep-alive"),i=e==null||(e==null?void 0:e.length)>0&&e!=="true"&&e!=="1";qe&&console.warn('<needle-engine> disconnected, keep-alive: "'+e+'"',typeof e,"Dispose=",i),i?(qe&&console.warn("<needle-engine> dispose"),(n=this._context)==null||n.dispose(),this._context=null,this._lastSourceFiles=null,this._loadId+=1):qe&&console.warn("<needle-engine> is not disposed because keep-alive is set")}attributeChangedCallback(e,i,n){switch(qe&&console.log("attributeChangedCallback",e,i,n),e){case"src":qe&&console.warn(`<needle-engine src>
changed from "`,i,'" to "',n,'"'),this.onLoad();break;case"hash":this._context&&(this._context.hash=n);break;case"loadstart":case"progress":case"loadfinished":typeof n=="string"&&n.length>0&&(qe&&console.log(e+" attribute changed",n),this.registerEventFromAttribute(e,n));break;case"dracoDecoderPath":qe&&console.log("dracoDecoderPath",n),Xv(n);break;case"dracoDecoderType":n==="wasm"||n==="js"?(qe&&console.log("dracoDecoderType",n),Qv(n)):console.error("Invalid dracoDecoderType",n,"expected js or wasm");break;case"ktx2DecoderPath":qe&&console.log("ktx2DecoderPath",n),Yv(n);break;case"tone-mapping":{this.applyAttributes();break}case"tone-mapping-exposure":{this.applyAttributes();break}case"background-blurriness":{const o=parseFloat(n);o!=null&&this._context&&(this._context.scene.backgroundBlurriness=o);break}case"background-color":{this.applyAttributes();break}case"public-key":{n!=Qu&&this.setPublicKey();break}case"version":{n!=$s&&this.setVersion();break}}}async onLoad(){var y,b;if(!this.isConnected)return;if(this._context||(qe&&console.warn("Create new context"),this._context=new ne({domElement:this})),!this._context){console.error("Needle Engine: Context not initialized");return}const e=this.getSourceFiles();if(!this.checkIfSourceHasChanged(e,this._lastSourceFiles))return;this._abortController&&(qe&&console.warn("Abort previous loading process"),this._abortController.abort(),this._abortController=null),this._lastSourceFiles=e;const i=++this._loadId;if((e==null||e.length<=0)&&(qe&&console.warn("Clear scene",e),this._context.clear(),i!==this._loadId))return;const n=this.getAttribute("alias");this.classList.add("loading");const o=Vs();this.ensureLoadStartIsRegistered();let r=this.dispatchEvent(new CustomEvent("loadstart",{detail:{context:this._context,alias:n},cancelable:!0}));if(o){const _=this.getAttribute("hide-loading-overlay");_!=null&&_!=="0"&&(r=!1)}r===!1&&!o&&(U()||(r=!0),console.warn("Needle Engine: You need a commercial license to override the default loading view. Visit https://needle.tools/pricing"),U()&&Me('You need a <a target="_blank" href="https://needle.tools/pricing">commercial license</a> to override the default loading view. This will not work in production.')),!this._loadingView&&r&&(this._loadingView=new hf(this)),r&&(this._didFullyLoad!==!0?(y=this._loadingView)==null||y.onLoadingBegin("begin load"):setTimeout(()=>{this._loadingView&&this._loadingProgress01<.3&&this._loadId===i&&this._loadingView.onLoadingBegin("begin load")},300)),qe&&console.warn(`--------------
Needle Engine: Begin loading `+i+`
`,e),this.onBeforeBeginLoading();const l=[],c={context:this._context,name:"",progress:{},index:0,count:e.length,totalProgress01:this._loadingProgress01},h=new CustomEvent("progress",{detail:c}),d=new Array,u=new AbortController;this._abortController=u;const f={files:e,abortSignal:u.signal,onLoadingProgress:_=>{var S;if(qe&&console.debug("Loading progress: ",_),u.signal.aborted)return;const v=_.index;!d[v]&&_.name&&(d[v]=bD(_.name)),_.name=d[v],r&&((S=this._loadingView)==null||S.onLoadingUpdate(_)),c.name=_.name,c.progress=_.progress,this._loadingProgress01=AC(_),c.totalProgress01=this._loadingProgress01,this.dispatchEvent(h)},onLoadingFinished:(_,v,S)=>{qe&&console.debug(`Finished loading "${v}" (aborted? ${u.signal.aborted})`),!u.signal.aborted&&S&&l.push({src:v,file:S})}},p=this.getAttribute("hash");p!=null&&(this._context.hash=p),this._context.alias=n,this._createContextPromise=this._context.create(f);const g=await this._createContextPromise;if(this.applyAttributes(),qe&&console.warn(`--------------
Needle Engine: finished loading `+i+`
`,e,`Aborted? ${u.signal.aborted}`),u.signal.aborted){console.log("Loading finished but aborted...");return}if(this._loadId!==i){console.log("Load id changed during loading process");return}this._loadingProgress01=1,r&&g&&((b=this._loadingView)==null||b.onLoadingUpdate(1,"creating scene")),this._didFullyLoad=!0,this.classList.remove("loading"),this.classList.add("loading-finished"),this.dispatchEvent(new CustomEvent("loadfinished",{detail:{context:this._context,src:n,loadedFiles:l}}))}applyAttributes(){if(this._context.renderer){const n=this.getAttribute("tonemapping")||this.getAttribute("tone-mapping");switch(n==null?void 0:n.toLowerCase()){case"none":this._context.renderer.toneMapping=gc;break;case"linear":this._context.renderer.toneMapping=Op;break;case"neutral":this._context.renderer.toneMapping=_d;break;case"agx":this._context.renderer.toneMapping=Rp;break;default:n!=null&&console.warn("Invalid tone-mapping attribute: "+n)}const o=this.getAttribute("tone-mapping-exposure");if(o!=null){const r=parseFloat(o);isNaN(r)||(this._context.renderer.toneMappingExposure=r)}}const e=this.getAttribute("background-blurriness");if(e!=null){const n=parseFloat(e);n!==void 0&&this._context&&(this._context.scene.backgroundBlurriness=n)}const i=this.getAttribute("background-color");if(this._context&&typeof i=="string"&&i.length>0){const n=this._context.scene.background;n instanceof ue?n.set(i):this._context.scene.background=new ue(i)}}internalSetLoadingMessage(e){var i;(i=this._loadingView)==null||i.setMessage(e)}getSourceFiles(){const e=this.getAttribute("src");if(!e)return[];let i;Array.isArray(e)?i=e:e.startsWith("[")&&e.endsWith("]")?i=JSON.parse(e):e.includes(",")?i=e.split(","):i=[e];for(let n=i.length-1;n>=0;n--){const o=i[n];(o==="null"||o==="undefined"||(o==null?void 0:o.length)<=0)&&i.splice(n,1)}return i}checkIfSourceHasChanged(e,i){if((e==null?void 0:e.length)!==(i==null?void 0:i.length)||e==null&&i!==null||e!==null&&i==null)return!0;if(e!==null&&i!==null){for(let n=0;n<(e==null?void 0:e.length);n++)if(e[n]!==i[n])return!0}return!1}ensureLoadStartIsRegistered(){const e=this.getAttribute("loadstart");e&&this.registerEventFromAttribute("loadstart",e)}registerEventFromAttribute(e,i){const n=this._previouslyRegisteredMap.get(e);if(n&&(this._previouslyRegisteredMap.delete(e),this.removeEventListener(e,n)),typeof i=="string"&&i.length>0)try{const o=(0,eval)(i);typeof o=="function"&&(this._previouslyRegisteredMap.set(e,o),this.addEventListener(e,r=>o==null?void 0:o.call(globalThis,this._context,r)))}catch(o){console.error("Error registering event "+e+'="'+i+`" failed with the following error:
`,o)}}setPublicKey(){Qu.length>0&&this.setAttribute("public-key",Qu)}setVersion(){$s.length>0&&this.setAttribute("version",$s)}getAROverlayContainer(){return this._overlay_ar.createOverlayContainer(this)}getVROverlayContainer(){for(let e=0;e<this.children.length;e++){const i=this.children[e];if(i.classList.contains("vr"))return i}return null}onEnterAR(e){var n;this.onSetupAR();const i=this.getAROverlayContainer();this._overlay_ar.onBegin(this._context,i,e),this.dispatchEvent(new CustomEvent("enter-ar",{detail:{session:e,context:this._context,htmlContainer:(n=this._overlay_ar)==null?void 0:n.ARContainer}}))}onExitAR(e){var i;this._overlay_ar.onEnd(this._context),this.onSetupDesktop(),this.dispatchEvent(new CustomEvent("exit-ar",{detail:{session:e,context:this._context,htmlContainer:(i=this._overlay_ar)==null?void 0:i.ARContainer}}))}onEnterVR(e){this.onSetupVR(),this.dispatchEvent(new CustomEvent("enter-vr",{detail:{session:e,context:this._context}}))}onExitVR(e){this.onSetupDesktop(),this.dispatchEvent(new CustomEvent("exit-vr",{detail:{session:e,context:this._context}}))}onSetupAR(){this.classList.add(wh),this.classList.remove(Sh);const e=this.getAROverlayContainer();qe&&console.warn("onSetupAR:",e),e&&(e.classList.add(wh),e.classList.remove(Sh)),this.foreachHtmlElement(i=>this.setupElementsForMode(i,IC))}onSetupVR(){this.classList.remove(wh),this.classList.remove(Sh),this.foreachHtmlElement(e=>this.setupElementsForMode(e,oP))}onSetupDesktop(){this.classList.remove(wh),this.classList.add(Sh);const e=this.getAROverlayContainer();e&&(e.classList.remove(wh),e.classList.add(Sh)),this.foreachHtmlElement(i=>this.setupElementsForMode(i,rP))}setupElementsForMode(e,i,n=null){var r,l;if(e===((l=(r=this._context)==null?void 0:r.renderer)==null?void 0:l.domElement)||e.id==="VRButton"||e.id==="ARButton")return;if(e.classList.contains(i))e.style.visibility="visible",e.style.display==="none"&&(e.style.display="block");else for(const c of yD)e.classList.contains(c)&&(e.style.visibility="hidden",e.style.display="none")}foreachHtmlElement(e){for(let i=0;i<this.children.length;i++){const n=this.children[i];n.style&&e(n)}}onBeforeBeginLoading(){const e=this.getAttribute("dracoDecoderPath");e&&(qe&&console.log("using custom draco decoder path",e),Xv(e));const i=this.getAttribute("dracoDecoderType");i&&(qe&&console.log("using custom draco decoder type",i),Qv(i));const n=this.getAttribute("ktx2DecoderPath");n&&(qe&&console.log("using custom ktx2 decoder path",n),Yv(n))}}typeof window<"u"&&!window.customElements.get(Jx)&&window.customElements.define(Jx,aP);function bD(s){if(s.startsWith("blob:"))return"blob";const t=s.split("/");let e=t[t.length-1];const i=e.indexOf("?");i>0&&(e=e.substring(0,i));const n=e.indexOf("=");n>0&&(e=e.substring(n));const o=e.split(".").pop(),l=o?["glb","gltf","usdz","usd","fbx","obj","mtl"].indexOf(o.toLowerCase()):-1;if(o&&l>=0&&(e=e.substring(0,e.length-o.length-1)),e=decodeURIComponent(e),e.length>3){let c="",h=!1;const d=["(",")","[","]","{","}",":",";",",",".","!","?"];for(let u=0;u<e.length;u++){let f=e[u];(f==="_"||f==="-")&&(f=" "),!(f===" "&&c.length<=0||d.includes(f)||(c.length===0&&(f=f.toUpperCase()),h&&f===" "))&&(h&&(f=f.toUpperCase()),h=!1,c+=f,f===" "&&(h=!0))}return U()&&e!==c&&console.debug('Generated display name: "'+e+'" ‚Üí "'+c+'"'),c.trim()}return U()&&console.debug("Loading: use default name",e),e}const vD=Object.freeze(Object.defineProperty({__proto__:null,NeedleEngineHTMLElement:aP},Symbol.toStringTag,{value:"Module"}));function xD(){Ws.registerWaitForInteraction(()=>{const s=kR.getContext();s.addEventListener("statechange",()=>{setTimeout(()=>{const t=s.state;(t==="suspended"||t==="interrupted")&&s.resume().then(()=>{console.log("AudioContext resumed successfully")}).catch(e=>{console.log("Failed to resume AudioContext: "+e)})},500)})})}setTimeout(xD,1e3);const mf=C("debughotreload");let Md=!1;const sd=new Map;function XL(){return Md}function QL(s){var i;if(Md)return;const e=s.constructor.name;sd.has(e)?(i=sd.get(e))==null||i.push(s):sd.set(e,[s])}function YL(s){if(Md)return;const e=s.constructor.name,i=sd.get(e);if(!i)return;const n=i.indexOf(s);n!==-1&&i.splice(n,1)}let Zx=!1;function wD(){if(mf||Zx)return;Zx=!0;const s=console.error;console.error=(...t)=>{if(t.length){const e=t[0];if(typeof e=="string"&&e.includes("[hmr] Failed to reload ")){console.log("[Needle Engine] Hot reloading failed"),window.location.reload();return}}s.apply(console,t)}}function KL(s){mf&&console.log("[HMR] Apply changes",s,Object.keys(s)),wD();for(const t of Object.keys(s))try{Md=!0;const e=w.get(t);if(!e){mf&&console.log("[HMR] Type not found: "+t);continue}const i=s[t],n=sd.get(i.name);let o="[Needle Engine] Updating type: "+t;const r=(n==null?void 0:n.length)??-1;r>0?o+=" x"+r:o+=" - no instances",console.log(o);const l=Object.getOwnPropertyNames(e.prototype),c=Object.getOwnPropertyDescriptors(i.prototype);for(const h in c)c[h].writable&&(e.prototype[h]=s[t].prototype[h]);for(const h of l)c[h]||delete e.prototype[h];if(n){const h=new i,d=Object.getOwnPropertyDescriptors(h);for(const u of n){const f=u,p=f.isComponent===!0,g=p?f.activeAndEnabled:!0,y=p?f.context:void 0;try{if(p&&y&&bo(f,y),p&&g&&(f.enabled=!1),u.onBeforeHotReloadFields&&u.onBeforeHotReloadFields()===!1)continue;for(const b in d)if(d[b].writable){if(u[b]===void 0)u[b]=h[b];else if(typeof u[b]=="function"&&!u[b].prototype){const v=u[b],S=v.name,T="bound ";if(S===T)continue;const O=v.name.substring(T.length),M=i.prototype[O];M&&(u[b]=M.bind(u))}}u.onAfterHotReloadFields&&u.onAfterHotReloadFields()}finally{p&&y&&G_(f,y),p&&g&&(f.enabled=!0)}}}}catch(e){if(mf)console.error(e);else return!1}finally{Md=!1,js(_t.Log,"Script changes applied (HMR)")}return!0}const ht=C("debugphysics"),ey=C("debugcolliderplacement"),ty=C("debugcollisions"),SD=C("showcolliders"),iy=C("debugraycasts"),Fi=Symbol("needle component"),Si=Symbol("physics body"),ew=Symbol("rigidbody");globalThis.true=globalThis.true!==void 0?globalThis.true:!0;ht&&console.log("Use Rapier",!0,globalThis.true);be.registerCallback(me.ContextCreationStart,s=>{ht&&console.log("Register rapier physics backend"),s.context.physics.engine=new ma(s.context)});const md=class{constructor(t){a(this,"debugRenderColliders",!1);a(this,"debugRenderRaycasts",!1);a(this,"context");a(this,"_initializePromise");a(this,"_isInitialized",!1);a(this,"rapierRay");a(this,"raycastVectorsBuffer",new Dn(()=>new x,10));a(this,"rapierSphere",null);a(this,"rapierColliderArray",[]);a(this,"rapierIdentityRotation",{x:0,y:0,z:0,w:1});a(this,"rapierForwardVector",{x:0,y:0,z:1});a(this,"enabled",!1);a(this,"_tempPosition",new x);a(this,"_tempQuaternion",new H);a(this,"_tempScale",new x);a(this,"_tempMatrix",new le);a(this,"_isUpdatingPhysicsWorld",!1);a(this,"_world");a(this,"_hasCreatedWorld",!1);a(this,"eventQueue");a(this,"collisionHandler");a(this,"objects",[]);a(this,"bodies",[]);a(this,"_meshCache",new Map);a(this,"_gravity",{x:0,y:-9.81,z:0});a(this,"lines");a(this,"_tempCenterPos",new x);a(this,"_tempCenterVec",new x);a(this,"_tempCenterQuaternion",new H);this.context=t}removeBody(t){var i,n,o;if(!t)return;this.validate();const e=t[Si];if(t[Si]=null,e&&this.world){const r=this.objects.findIndex(l=>l===t);if(r>=0){const l=this.bodies[r];if(this.bodies.splice(r,1),this.objects.splice(r,1),l instanceof z.RAPIER_PHYSICS.MODULE.Collider){const c=l;(i=this.world)==null||i.removeCollider(c,!0);const h=c.parent();h&&h.numColliders()<=0&&(h[Fi]||(n=this.world)==null||n.removeRigidBody(h))}else l instanceof z.RAPIER_PHYSICS.MODULE.RigidBody&&(l.numColliders()<=0?(o=this.world)==null||o.removeRigidBody(l):U()&&(l.did_log_removing||setTimeout(()=>{l.numColliders()>0&&(l.did_log_removing=!0,console.warn("RapierPhysics: removing rigidbody with colliders from the physics world is not possible right now, please remove the colliders first"))},1)))}}}updateBody(t,e,i){if(this.validate(),!!this.enabled&&!(t.destroyed||!t.gameObject)&&!(!e&&!i))if(t.isCollider===!0)console.warn("TODO: implement updating collider position");else{const n=t,o=n[Si];o&&this.syncPhysicsBody(n.gameObject,o,e,i)}}updateProperties(t){if(this.validate(),t.isCollider){const e=t,i=e[Si];i&&(this.internalUpdateColliderProperties(e,i),e.sharedMaterial&&this.updatePhysicsMaterial(e))}else{const e=t,i=this.internal_getRigidbody(e);i&&this.internalUpdateRigidbodyProperties(e,i)}}addForce(t,e,i){this.validate();const n=this.internal_getRigidbody(t);n?n.addForce(e,i):console.warn("Rigidbody doesn't exist: can not apply force (does your object with the Rigidbody have a collider?)")}addImpulse(t,e,i){this.validate();const n=this.internal_getRigidbody(t);n?n.applyImpulse(e,i):console.warn("Rigidbody doesn't exist: can not apply impulse (does your object with the Rigidbody have a collider?)")}getLinearVelocity(t){this.validate();const e=this.internal_getRigidbody(t);return e?e.linvel():null}getAngularVelocity(t){this.validate();const e=this.internal_getRigidbody(t);return e?e.angvel():null}resetForces(t,e){this.validate();const i=this.internal_getRigidbody(t);i==null||i.resetForces(e)}resetTorques(t,e){this.validate();const i=this.internal_getRigidbody(t);i==null||i.resetTorques(e)}applyImpulse(t,e,i){this.validate();const n=this.internal_getRigidbody(t);n?n.applyImpulse(e,i):console.warn("Rigidbody doesn't exist: can not apply impulse (does your object with the Rigidbody have a collider?)")}wakeup(t){this.validate();const e=this.internal_getRigidbody(t);e?e.wakeUp():console.warn("Rigidbody doesn't exist: can not wake up (does your object with the Rigidbody have a collider?)")}isSleeping(t){this.validate();const e=this.internal_getRigidbody(t);return e==null?void 0:e.isSleeping()}setAngularVelocity(t,e,i){this.validate();const n=this.internal_getRigidbody(t);n?n.setAngvel(e,i):console.warn("Rigidbody doesn't exist: can not set angular velocity (does your object with the Rigidbody have a collider?)")}setLinearVelocity(t,e,i){this.validate();const n=this.internal_getRigidbody(t);n?n.setLinvel(e,i):console.warn("Rigidbody doesn't exist: can not set linear velocity (does your object with the Rigidbody have a collider?)")}get isInitialized(){return this._isInitialized}async initialize(){return this._initializePromise||(this._initializePromise=this.internalInitialization()),this._initializePromise}async internalInitialization(){return C("__nophysics")?(console.warn("Physics are disabled"),!1):(ht&&console.log("Initialize rapier physics engine"),"env"in import.meta&&{}.VITE_NEEDLE_USE_RAPIER==="false"?(ht&&console.log("Rapier disabled"),!1):this._hasCreatedWorld?(console.error("Invalid call to create physics world: world is already created"),!0):(this._hasCreatedWorld=!0,z.RAPIER_PHYSICS.MAYBEMODULE==null&&(ht&&console.trace("Loading rapier physics engine"),await(await z.RAPIER_PHYSICS.load()).init()),ht&&console.log("Physics engine initialized, creating world..."),this._world=new z.RAPIER_PHYSICS.MODULE.World(this._gravity),this.rapierRay=new z.RAPIER_PHYSICS.MODULE.Ray({x:0,y:0,z:0},{x:0,y:0,z:1}),this.enabled=!0,this._isInitialized=!0,ht&&console.log("Physics world created"),!0))}validate(){this._isInitialized||ht&&(this._lastWarnTime=this._lastWarnTime??0,Date.now()-this._lastWarnTime>1e3&&(this._lastWarnTime=Date.now(),console.warn("Physics engine is not initialized")))}raycast(t,e,i){var c;if(!this._isInitialized)return console.log("Physics engine is not initialized"),null;let n=i==null?void 0:i.maxDistance,o=i==null?void 0:i.solid;n===void 0&&(n=1/0),o===void 0&&(o=!0);const r=this.getPhysicsRay(this.rapierRay,t,e);if(!r)return null;(this.debugRenderRaycasts||iy)&&G.DrawRay(r.origin,r.dir,255,1);const l=(c=this.world)==null?void 0:c.castRay(r,n,o,i==null?void 0:i.queryFilterFlags,i==null?void 0:i.filterGroups,void 0,void 0,h=>{const d=h[Fi];return i!=null&&i.filterPredicate?i.filterPredicate(d):(i==null?void 0:i.useIgnoreRaycastLayer)!==!1?!(d!=null&&d.gameObject.layers.isEnabled(2)):!0});if(l){const h=r.pointAt(l.timeOfImpact),d=this.raycastVectorsBuffer.get();return d.set(h.x,h.y,h.z),{point:d,collider:l.collider[Fi]}}return null}raycastAndGetNormal(t,e,i){var c;if(!this._isInitialized)return null;let n=i==null?void 0:i.maxDistance,o=i==null?void 0:i.solid;n===void 0&&(n=1/0),o===void 0&&(o=!0);const r=this.getPhysicsRay(this.rapierRay,t,e);if(!r)return null;(this.debugRenderRaycasts||iy)&&G.DrawRay(r.origin,r.dir,255,1);const l=(c=this.world)==null?void 0:c.castRayAndGetNormal(r,n,o,i==null?void 0:i.queryFilterFlags,i==null?void 0:i.filterGroups,void 0,void 0,h=>{const d=h[Fi];return i!=null&&i.filterPredicate?i.filterPredicate(d):(i==null?void 0:i.useIgnoreRaycastLayer)!==!1?!(d!=null&&d.gameObject.layers.isEnabled(2)):!0});if(l){const h=r.pointAt(l.timeOfImpact),d=l.normal,u=this.raycastVectorsBuffer.get(),f=this.raycastVectorsBuffer.get();return u.set(h.x,h.y,h.z),f.set(d.x,d.y,d.z),{point:u,normal:f,collider:l.collider[Fi]}}return null}getPhysicsRay(t,e,i){var l,c,h;const n=(l=this.context)==null?void 0:l.mainCamera;if(e===void 0){const d=(c=this.context)==null?void 0:c.input.getPointerPosition(0);if(d)e=d;else return null}if(e.z===void 0){if(!n)return console.error("Can not perform raycast from 2d point - no main camera found"),null;const d=this.raycastVectorsBuffer.get();d.x=e.x,d.y=e.y,d.z=0,(d.x>1||d.y>1||d.y<-1||d.x<-1)&&(ht&&console.warn("Converting screenspace to raycast space",d),(h=this.context)==null||h.input.convertScreenspaceToRaycastSpace(d)),d.unproject(n),e=d}const o=e;t.origin.x=o.x,t.origin.y=o.y,t.origin.z=o.z;const r=this.raycastVectorsBuffer.get();if(i)r.set(i.x,i.y,i.z);else{if(!n)return console.error("Can not perform raycast - no camera found"),null;r.set(t.origin.x,t.origin.y,t.origin.z);const d=ae(n);r.sub(d)}return r.normalize(),t.dir.x=r.x,t.dir.y=r.y,t.dir.z=r.z,t}sphereOverlap(t,e){return this.rapierColliderArray.length=0,this._isInitialized?this.world?(this.rapierSphere??(this.rapierSphere=new z.RAPIER_PHYSICS.MODULE.Ball(e)),this.rapierSphere.radius=e,(this.debugRenderRaycasts||iy)&&G.DrawWireSphere(t,e,3359999,1),this.world.intersectionsWithShape(t,this.rapierIdentityRotation,this.rapierSphere,i=>{const n=i[Fi],o=new bA(n.gameObject,n);return this.rapierColliderArray.push(o),!0},void 0,void 0,void 0,void 0,i=>i.isSensor()?!1:i[Fi].gameObject.layers.isEnabled(2)==!1),this.rapierColliderArray):this.rapierColliderArray:this.rapierColliderArray}get world(){return this._world}get isUpdating(){return this._isUpdatingPhysicsWorld}get gravity(){var t;return((t=this.world)==null?void 0:t.gravity)??this._gravity}set gravity(t){this.world?this.world.gravity=t:this._gravity=t}clearCaches(){var t,e,i,n;this._meshCache.clear(),(t=this.eventQueue)!=null&&t.raw&&((e=this.eventQueue)==null||e.free()),(i=this.world)!=null&&i.bodies&&((n=this.world)==null||n.free())}async addBoxCollider(t,e){if(this._isInitialized||await this.initialize(),!t.activeAndEnabled)return;if(!this.enabled){ht&&console.warn("Physics are disabled");return}const i=t.gameObject,n=pt(i,this._tempPosition).multiply(e);n.multiplyScalar(.5),n.x<0&&(n.x=Math.abs(n.x)),n.y<0&&(n.y=Math.abs(n.y)),n.z<0&&(n.z=Math.abs(n.z)),n.x==0&&(n.x=1e-7),n.y==0&&(n.y=1e-7),n.z==0&&(n.z=1e-7);const o=z.RAPIER_PHYSICS.MODULE.ColliderDesc.cuboid(n.x,n.y,n.z);this.createCollider(t,o)}async addSphereCollider(t){if(this._isInitialized||await this.initialize(),!t.activeAndEnabled)return;if(!this.enabled){ht&&console.warn("Physics are disabled");return}const e=z.RAPIER_PHYSICS.MODULE.ColliderDesc.ball(.5);this.createCollider(t,e),this.updateProperties(t)}async addCapsuleCollider(t,e,i){if(this._isInitialized||await this.initialize(),!t.activeAndEnabled)return;if(!this.enabled){ht&&console.warn("Physics are disabled");return}const n=t.gameObject,o=pt(n,this._tempPosition);o.x=Math.abs(o.x),o.y=Math.abs(o.y);const r=i*o.x;e=Math.max(e,r*2);const l=W.clamp(e*.5*o.y-i*o.x,0,Number.MAX_SAFE_INTEGER),c=z.RAPIER_PHYSICS.MODULE.ColliderDesc.capsule(l,r);this.createCollider(t,c)}async addMeshCollider(t,e,i,n){var u,f,p;let o=e.geometry;if(!o){ht&&console.warn("Missing mesh geometry",e.name);return}(f=(u=o.index)==null?void 0:u.array)!=null&&f.length||(console.warn(`Your MeshCollider is missing vertices or indices in the assined mesh "${e.name}". Consider providing an indexed geometry.`),o=JR(o));let r=null;const l=o.getAttribute("position");if(l instanceof uw){const g=l.count;r=new Float32Array(g*3);for(let y=0;y<g;y++){const b=l.getX(y),_=l.getY(y),v=l.getZ(y);r[y*3]=b,r[y*3+1]=_,r[y*3+2]=v}}else r=l.array;if(await this.initialize(),!this.enabled){ht&&console.warn("Physics are disabled");return}if(!t.activeAndEnabled)return;const c=(p=o.index)==null?void 0:p.array,h=t.gameObject.worldScale.clone();if(n&&h.multiply(n),Math.abs(h.x-1)>1e-4||Math.abs(h.y-1)>1e-4||Math.abs(h.z-1)>1e-4){const g=`${o.uuid}_${h.x}_${h.y}_${h.z}_${i}`;if(this._meshCache.has(g))ht&&console.warn("Use cached mesh collider"),r=this._meshCache.get(g);else{(ht||U())&&console.debug(`[Performance] Your MeshCollider "${t.name}" is scaled: consider applying the scale to the collider mesh instead (${h.x}, ${h.y}, ${h.z})`);const y=new Float32Array(r.length);for(let b=0;b<r.length;b+=3)y[b]=r[b]*h.x,y[b+1]=r[b+1]*h.y,y[b+2]=r[b+2]*h.z;r=y,this._meshCache.set(g,y)}}const d=i?z.RAPIER_PHYSICS.MODULE.ColliderDesc.convexHull(r):z.RAPIER_PHYSICS.MODULE.ColliderDesc.trimesh(r,c);d&&this.createCollider(t,d)}updatePhysicsMaterial(t){if(!t)return;const e=t.sharedMaterial,i=t[Si];if(i&&e){if(e.bounciness!==void 0&&i.setRestitution(e.bounciness),e.bounceCombine!==void 0)switch(e.bounceCombine){case Tt.Average:i.setRestitutionCombineRule(z.RAPIER_PHYSICS.MODULE.CoefficientCombineRule.Average);break;case Tt.Maximum:i.setRestitutionCombineRule(z.RAPIER_PHYSICS.MODULE.CoefficientCombineRule.Max);break;case Tt.Minimum:i.setRestitutionCombineRule(z.RAPIER_PHYSICS.MODULE.CoefficientCombineRule.Min);break;case Tt.Multiply:i.setRestitutionCombineRule(z.RAPIER_PHYSICS.MODULE.CoefficientCombineRule.Multiply);break}if(e.dynamicFriction!==void 0&&i.setFriction(e.dynamicFriction),e.frictionCombine!==void 0)switch(e.frictionCombine){case Tt.Average:i.setFrictionCombineRule(z.RAPIER_PHYSICS.MODULE.CoefficientCombineRule.Average);break;case Tt.Maximum:i.setFrictionCombineRule(z.RAPIER_PHYSICS.MODULE.CoefficientCombineRule.Max);break;case Tt.Minimum:i.setFrictionCombineRule(z.RAPIER_PHYSICS.MODULE.CoefficientCombineRule.Min);break;case Tt.Multiply:i.setFrictionCombineRule(z.RAPIER_PHYSICS.MODULE.CoefficientCombineRule.Multiply);break}}}getBody(t){return t?t[Si]:null}getComponent(t){return t?t[Fi]:null}createCollider(t,e){var r;if(!this.world)throw new Error("Physics world not initialized");const i=this._tempMatrix;let n;t.attachedRigidbody?n=this.getRigidbody(t,this._tempMatrix):(ht&&console.log("Create collider without rigidbody",t.name),i.makeRotationFromQuaternion(Le(t.gameObject)),i.setPosition(ae(t.gameObject))),i.decompose(this._tempPosition,this._tempQuaternion,this._tempScale),this.tryApplyCenter(t,this._tempPosition),e.setTranslation(this._tempPosition.x,this._tempPosition.y,this._tempPosition.z),e.setRotation(this._tempQuaternion),e.setSensor(t.isTrigger);const o=t.sharedMaterial;if(o){if(o.bounciness!==void 0&&e.setRestitution(o.bounciness),o.bounceCombine!==void 0)switch(o.bounceCombine){case Tt.Average:e.setRestitutionCombineRule(z.RAPIER_PHYSICS.MODULE.CoefficientCombineRule.Average);break;case Tt.Maximum:e.setRestitutionCombineRule(z.RAPIER_PHYSICS.MODULE.CoefficientCombineRule.Max);break;case Tt.Minimum:e.setRestitutionCombineRule(z.RAPIER_PHYSICS.MODULE.CoefficientCombineRule.Min);break;case Tt.Multiply:e.setRestitutionCombineRule(z.RAPIER_PHYSICS.MODULE.CoefficientCombineRule.Multiply);break}if(o.dynamicFriction!==void 0&&e.setFriction(o.dynamicFriction),o.frictionCombine!==void 0)switch(o.frictionCombine){case Tt.Average:e.setFrictionCombineRule(z.RAPIER_PHYSICS.MODULE.CoefficientCombineRule.Average);break;case Tt.Maximum:e.setFrictionCombineRule(z.RAPIER_PHYSICS.MODULE.CoefficientCombineRule.Max);break;case Tt.Minimum:e.setFrictionCombineRule(z.RAPIER_PHYSICS.MODULE.CoefficientCombineRule.Min);break;case Tt.Multiply:e.setFrictionCombineRule(z.RAPIER_PHYSICS.MODULE.CoefficientCombineRule.Multiply);break}}((r=t.attachedRigidbody)==null?void 0:r.autoMass)===!1&&(e.setDensity(1e-6),e.setMass(1e-6));try{const l=this.world.createCollider(e,n);return l[Fi]=t,t[Si]=l,l.setActiveEvents(z.RAPIER_PHYSICS.MODULE.ActiveEvents.COLLISION_EVENTS),l.setActiveCollisionTypes(z.RAPIER_PHYSICS.MODULE.ActiveCollisionTypes.ALL),this.objects.push(t),this.bodies.push(l),this.updateColliderCollisionGroups(t),l}catch(l){return console.error('Error creating collider "'+t.name+`"
Error:`,l),null}}updateColliderCollisionGroups(t){const e=t[Si],i=t.membership;let n=0;if(i==null)n=65535;else for(let l=0;l<i.length;l++){const c=i[l];c>31?console.error(`Rapier only supports 32 layers, layer ${c} is not supported`):n|=1<<Math.floor(c)}const o=t.filter;let r=0;if(o==null)r=65535;else for(let l=0;l<o.length;l++){const c=o[l];c>31?console.error(`Rapier only supports 32 layers, layer ${c} is not supported`):r|=1<<Math.floor(c)}e.setCollisionGroups(n<<16|r)}getRigidbody(t,e){if(!this.world)throw new Error("Physics world not initialized");let i=null;if(t.attachedRigidbody){const n=t.attachedRigidbody;if(i=n[Si],!i){const o=n.isKinematic&&!ey;ht&&console.log("Create rigidbody",o);const r=o?z.RAPIER_PHYSICS.MODULE.RigidBodyDesc.kinematicPositionBased():z.RAPIER_PHYSICS.MODULE.RigidBodyDesc.dynamic(),l=ae(t.attachedRigidbody.gameObject);r.setTranslation(l.x,l.y,l.z),r.setRotation(Le(t.attachedRigidbody.gameObject)),r.centerOfMass=new z.RAPIER_PHYSICS.MODULE.Vector3(n.centerOfMass.x,n.centerOfMass.y,n.centerOfMass.z),i=this.world.createRigidBody(r),this.bodies.push(i),this.objects.push(n)}i[Fi]=n,n[Si]=i,this.internalUpdateRigidbodyProperties(n,i),this.getRigidbodyRelativeMatrix(t.gameObject,n.gameObject,e),t[ew]=i}else{const n=z.RAPIER_PHYSICS.MODULE.RigidBodyDesc.kinematicPositionBased(),o=ae(t.gameObject);n.setTranslation(o.x,o.y,o.z),n.setRotation(Le(t.gameObject)),i=this.world.createRigidBody(n),e.identity(),i[Fi]=null}return i}internal_getRigidbody(t){return t.isCollider===!0?t[ew]:t[Si]}internalUpdateColliderProperties(t,e){const i=e.shape;let n=!1;switch(i.type){case z.RAPIER_PHYSICS.MODULE.ShapeType.Ball:{const f=i,p=t,g=t.gameObject,y=pt(g,this._tempPosition),b=Math.abs(p.radius*y.x);n=f.radius!==b,f.radius=b,n&&e.setShape(f);break}case z.RAPIER_PHYSICS.MODULE.ShapeType.Cuboid:const o=i,r=t,l=t.gameObject,c=pt(l,this._tempPosition),h=r.size.x*.5*c.x,d=r.size.y*.5*c.y,u=r.size.z*.5*c.z;n=o.halfExtents.x!==h||o.halfExtents.y!==d||o.halfExtents.z!==u,o.halfExtents.x=h,o.halfExtents.y=d,o.halfExtents.z=u,n&&e.setShape(o);break}if(n){const o=t.attachedRigidbody;if(o!=null&&o.autoMass){const r=this.getBody(o);r==null||r.recomputeMassPropertiesFromColliders()}}this.updateColliderCollisionGroups(t),t.isTrigger!==e.isSensor()&&e.setSensor(t.isTrigger)}internalUpdateRigidbodyProperties(t,e){if(e.enableCcd(t.collisionDetectionMode!==Lf.Discrete),e.setLinearDamping(t.drag),e.setAngularDamping(t.angularDrag),e.setGravityScale(t.useGravity?t.gravityScale:0,!0),t.dominanceGroup<=127&&t.dominanceGroup>=-127?e.setDominanceGroup(Math.floor(t.dominanceGroup)):e.setDominanceGroup(0),t.autoMass){e.setAdditionalMass(0,!1);for(let i=0;i<e.numColliders();i++)e.collider(i).setDensity(1);e.recomputeMassPropertiesFromColliders()}else{e.setAdditionalMass(t.mass,!1);for(let i=0;i<e.numColliders();i++)e.collider(i).setDensity(1e-7);e.recomputeMassPropertiesFromColliders()}e.setEnabledRotations(!t.lockRotationX,!t.lockRotationY,!t.lockRotationZ,!1),e.setEnabledTranslations(!t.lockPositionX,!t.lockPositionY,!t.lockPositionZ,!1),t.isKinematic?e.setBodyType(z.RAPIER_PHYSICS.MODULE.RigidBodyType.KinematicPositionBased,!1):e.setBodyType(z.RAPIER_PHYSICS.MODULE.RigidBodyType.Dynamic,!1)}step(t){if(this.world&&this.enabled){if(this._isUpdatingPhysicsWorld=!0,this.eventQueue||(this.eventQueue=new z.RAPIER_PHYSICS.MODULE.EventQueue(!1)),t===void 0||t<=0){this._isUpdatingPhysicsWorld=!1;return}else t!==void 0&&(this.world.timestep=W.lerp(this.world.timestep,t,.8));try{this.world.step(this.eventQueue)}catch(e){console.warn("Error running physics step",e)}this._isUpdatingPhysicsWorld=!1}}postStep(){this.world&&this.enabled&&(this._isUpdatingPhysicsWorld=!0,this.syncObjects(),this._isUpdatingPhysicsWorld=!1,this.eventQueue&&!this.collisionHandler&&(this.collisionHandler=new CD(this.world,this.eventQueue)),this.collisionHandler&&(this.collisionHandler.handleCollisionEvents(),this.collisionHandler.update()),this.updateDebugRendering(this.world))}updateDebugRendering(t){var e,i,n,o;if(ht||ey||SD||this.debugRenderColliders===!0){if(!this.lines){const l=new dw({color:7855479,fog:!1}),c=new ko;this.lines=new hw(c,l),this.lines.layers.disableAll(),this.lines.layers.enable(2)}this.lines.parent!==((e=this.context)==null?void 0:e.scene)&&((i=this.context)==null||i.scene.add(this.lines));const r=t.debugRender();this.lines.geometry.setAttribute("position",new $i(r.vertices,3)),this.lines.geometry.setAttribute("color",new $i(r.colors,4)),(this.context.time.frame%30===0||((n=this.lines.geometry.boundingSphere)==null?void 0:n.radius)===0)&&this.lines.geometry.computeBoundingSphere()}else this.lines&&((o=this.context)==null||o.scene.remove(this.lines))}syncObjects(){if(!ey)for(let t=0;t<this.bodies.length;t++){const e=this.objects[t],i=this.bodies[t],n=e;if((n==null?void 0:n.isCollider)===!0&&!n.attachedRigidbody){const c=i.parent();c?this.syncPhysicsBody(e.gameObject,c,!0,!0):this.syncPhysicsBody(e.gameObject,i,!0,!0);continue}const o=i.translation(),r=i.rotation();if(Number.isNaN(o.x)||Number.isNaN(r.x)){!n.__COLLIDER_NAN&&U()&&(console.warn("Collider has NaN values",n.name,n.gameObject,i),n.__COLLIDER_NAN=!0);continue}const l=e.center;if(l&&l.isVector3){this._tempQuaternion.set(r.x,r.y,r.z,r.w);const c=this._tempPosition.copy(l).applyQuaternion(this._tempQuaternion),h=pt(e.gameObject);c.multiply(h),o.x-=c.x,o.y-=c.y,o.z-=c.z}_c(e.gameObject,o.x,o.y,o.z),Fw(e.gameObject,r.x,r.y,r.z,r.w)}}syncPhysicsBody(t,e,i,n){if(e instanceof z.RAPIER_PHYSICS.MODULE.RigidBody){const o=ae(t,this._tempPosition),r=Le(t,this._tempQuaternion);switch(e.bodyType()){case z.RAPIER_PHYSICS.MODULE.RigidBodyType.Fixed:case z.RAPIER_PHYSICS.MODULE.RigidBodyType.KinematicPositionBased:case z.RAPIER_PHYSICS.MODULE.RigidBodyType.KinematicVelocityBased:i&&e.setNextKinematicTranslation(o),n&&e.setNextKinematicRotation(r);break;default:i&&e.setTranslation(o,!1),n&&e.setRotation(r,!1);break}}else if(e instanceof z.RAPIER_PHYSICS.MODULE.Collider){t.matrixWorldNeedsUpdate&&t.updateWorldMatrix(!0,!1),t.matrixWorld.decompose(this._tempPosition,this._tempQuaternion,this._tempScale);const o=this._tempPosition,r=this._tempQuaternion,l=e[Fi];if(this.tryApplyCenter(l,o),i){const c=e.translation();(c.x!==o.x||c.y!==o.y||c.z!==o.z)&&e.setTranslation(o)}if(n){const c=e.rotation();(c.x!==r.x||c.y!==r.y||c.z!==r.z||c.w!==r.w)&&e.setRotation(r)}}}tryApplyCenter(t,e){const i=t.center;i&&t.gameObject&&(i.x!==0||i.y!==0||i.z!==0)&&(this._tempCenterPos.x=i.x,this._tempCenterPos.y=i.y,this._tempCenterPos.z=i.z,pt(t.gameObject,this._tempCenterVec),this._tempCenterPos.multiply(this._tempCenterVec),t.attachedRigidbody?this._tempCenterPos.applyQuaternion(t.gameObject.quaternion):(Le(t.gameObject,this._tempCenterQuaternion),this._tempCenterPos.applyQuaternion(this._tempCenterQuaternion)),e.x+=this._tempCenterPos.x,e.y+=this._tempCenterPos.y,e.z+=this._tempCenterPos.z)}getRigidbodyRelativeMatrix(t,e,i,n){if(n===void 0&&(n=md._matricesBuffer,n.length=0),t===e){const o=pt(t,this._tempPosition);i.makeScale(o.x,o.y,o.z);for(let r=n.length-1;r>=0;r--)i.multiply(n[r]);return i}return n.push(t.matrix),t.parent&&this.getRigidbodyRelativeMatrix(t.parent,e,i,n),i}addFixedJoint(t,e){if(!this.world){console.error("Physics world not initialized");return}const i=t[Si],n=e[Si];this.calculateJointRelativeMatrices(t.gameObject,e.gameObject,this._tempMatrix),this._tempMatrix.decompose(this._tempPosition,this._tempQuaternion,this._tempScale);const o=z.RAPIER_PHYSICS.MODULE.JointData.fixed(md.centerConnectionPos,md.centerConnectionRot,this._tempPosition,this._tempQuaternion),r=this.world.createImpulseJoint(o,i,n,!0);ht&&console.log("ADD FIXED JOINT",r)}addHingeJoint(t,e,i,n){if(!this.world){console.error("Physics world not initialized");return}const o=t[Si],r=e[Si];this.calculateJointRelativeMatrices(t.gameObject,e.gameObject,this._tempMatrix),this._tempMatrix.decompose(this._tempPosition,this._tempQuaternion,this._tempScale);const l=z.RAPIER_PHYSICS.MODULE.JointData.revolute(i,this._tempPosition,n),c=this.world.createImpulseJoint(l,o,r,!0);ht&&console.log("ADD HINGE JOINT",c)}calculateJointRelativeMatrices(t,e,i){t.updateWorldMatrix(!0,!1),e.updateWorldMatrix(!0,!1);const n=t.matrixWorld,o=e.matrixWorld;n.elements[0]=1,n.elements[5]=1,n.elements[10]=1,o.elements[0]=1,o.elements[5]=1,o.elements[10]=1,i.copy(o).premultiply(n.invert()).invert()}};let ma=md;a(ma,"_didLoadPhysicsEngine",!1),a(ma,"_matricesBuffer",[]),a(ma,"centerConnectionPos",{x:0,y:0,z:0}),a(ma,"centerConnectionRot",{x:0,y:0,z:0,w:1});class CD{constructor(t,e){a(this,"world");a(this,"eventQueue");a(this,"activeCollisions",[]);a(this,"activeCollisionsStay",[]);a(this,"activeTriggers",[]);this.world=t,this.eventQueue=e}handleCollisionEvents(){this.eventQueue&&this.world&&this.eventQueue.drainCollisionEvents((t,e,i)=>{const n=this.world.getCollider(t),o=this.world.getCollider(e);if(!n||!o)return;const r=n[Fi],l=o[Fi];ty&&console.log("EVT",r.name,l.name,i,n,o),r&&l&&(i?(this.onCollisionStarted(r,n,l,o),this.onCollisionStarted(l,o,r,n)):(this.onCollisionEnded(r,l),this.onCollisionEnded(l,r)))})}update(){this.onHandleCollisionStay()}onCollisionStarted(t,e,i,n){let o=null;if(t.isTrigger||i.isTrigger)Cc(t.gameObject,r=>{r.onTriggerEnter&&!r.destroyed&&r.onTriggerEnter(i),this.activeTriggers.push({collider:t,component:r,otherCollider:i})});else{const r=t.gameObject;this.world.contactPair(e,n,(l,c)=>{Cc(r,h=>{var u;if(h.destroyed)return;const d=h.onCollisionEnter||h.onCollisionStay||h.onCollisionExit;if(d||ty){if(!o){const f=[],p=l.normal();i instanceof nl&&i.convex&&(p.x=-p.x,p.y=-p.y,p.z=-p.z);for(let g=0;g<l.numSolverContacts();g++){const y=l.solverContactPoint(g),b=l.contactImpulse(g);if(y){const _=l.contactDist(g),v=l.solverContactFriction(g),S=l.solverContactTangentVelocity(g),T=new yA(y,_,p,b,v,S);f.push(T),ty&&G.DrawDirection(y,p,16711680,3,!0)}}o=new _A(r,i,f)}if(d){const f={collider:t,component:h,collision:o};this.activeCollisions.push(f),h.onCollisionStay&&this.activeCollisionsStay.push(f),(u=h.onCollisionEnter)==null||u.call(h,o)}}})})}}onHandleCollisionStay(){for(const t of this.activeCollisionsStay){const e=t.component;if(!e.destroyed&&e.activeAndEnabled&&e.onCollisionStay){if(t.collision.collider.destroyed)continue;const i=t.collision;e.onCollisionStay(i)}}for(const t of this.activeTriggers){const e=t.component;if(!e.destroyed&&e.activeAndEnabled&&e.onTriggerStay){const i=t.otherCollider;if(i.destroyed)continue;e.onTriggerStay(i)}}}onCollisionEnded(t,e){if(!(t.destroyed||e.destroyed)){for(let i=0;i<this.activeCollisions.length;i++){const n=this.activeCollisions[i],o=n.collider;if(o.destroyed||n.collision.collider.destroyed){this.activeCollisions.splice(i,1),i--;continue}if(o===t&&n.collision.collider===e){const r=n.component;if(this.activeCollisions.splice(i,1),i--,r.activeAndEnabled&&r.onCollisionExit){const l=n.collision;r.onCollisionExit(l)}}}for(let i=0;i<this.activeCollisionsStay.length;i++){const n=this.activeCollisionsStay[i],o=n.collider;if(o.destroyed||n.collision.collider.destroyed){this.activeCollisionsStay.splice(i,1),i--;continue}if(o===t&&n.collision.collider===e){const r=n.component;if(this.activeCollisionsStay.splice(i,1),i--,r.activeAndEnabled&&r.onCollisionExit){const l=n.collision;r.onCollisionExit(l)}}}for(let i=0;i<this.activeTriggers.length;i++){const n=this.activeTriggers[i],o=n.collider;if(o.destroyed||n.otherCollider.destroyed){this.activeTriggers.splice(i,1),i--;continue}if(o===t&&n.otherCollider===e){const r=n.component;if(this.activeTriggers.splice(i,1),i--,r.activeAndEnabled&&r.onTriggerExit){const l=n.otherCollider;r.onTriggerExit(l)}}}}}}class JL{static async createComparisonScene(t){const{files:e}=t,n=await Promise.all(e.map(b=>new de(b).loadAssetAsync())),o=new In;let r=0;for(const b of n)if(b instanceof F){b.position.y=r,o.add(b);const _=dn([b]);r+=_.getSize(new x).y,r+=.1}const l=new Re(20);o.add(l);const c=t.environment||"https://dl.polyhaven.org/file/ph-assets/HDRIs/exr/1k/studio_small_09_1k.exr";if(c){let b=null;if(c.endsWith(".hdr")){const _=(await ts(()=>import("./three-examples.d909655c.js").then(v=>v.t),["./three-examples.d909655c.js","./three@0.169.5.js"],import.meta.url)).RGBELoader;b=new _}else if(c.endsWith(".exr")){const _=(await ts(()=>import("./three-examples.d909655c.js").then(v=>v.r),["./three-examples.d909655c.js","./three@0.169.5.js"],import.meta.url)).EXRLoader;b=new _}if(b){const _=await b.loadAsync(c).catch(v=>(console.error(v),null));_&&(_.mapping=Mo,_.needsUpdate=!0,o.background=_,o.environment=_,o.backgroundBlurriness=.75)}else console.warn("Unsupported environment map format",c)}const h=dn(o.children),d=h.getCenter(new x),u=h.getSize(new x),p=Math.max(u.x,u.y,u.z)/(2*Math.tan(Math.PI*l.fov/360));l.position.set(d.x,d.y,p),l.lookAt(d);const g=new xw(l,t.domElement||document.body);g.target=d,g.update();const y=(t.domElement||document.body).getBoundingClientRect();return l.aspect=y.width/y.height,l.updateProjectionMatrix(),{scene:o,camera:l}}}let x_=0;function tw(s){s?x_++:x_--}function ZL(){return x_>0}const PD={binary:!0,animations:!0};async function e3(s){if(!s.context)throw new Error("No context provided to exportAsGLTF");s.scene||(s.scene=s.context.scene);const t={...PD,...s},{context:e}=t,i=new ww;i.register(l=>new mw(l)),i.register(l=>new LA(l)),i.register(l=>new JC(l)),t1(i,t.context);const n={binary:t.binary,animations:OD(e,t.scene,[])},o=new RD;console.debug("Exporting GLTF",n),o.onBeforeExport(t),tw(!0);const r=await i.parseAsync(t.scene,n).catch(l=>(console.error(l),null));if(tw(!1),o.onAfterExport(t),!r)throw new Error("Failed to export GLTF");if(t.downloadAs!=null){let l=null;if(r instanceof ArrayBuffer?l=new Blob([r],{type:"application/octet-stream"}):console.error("Can not download GLTF as a blob",r),l){const c=URL.createObjectURL(l),h=document.createElement("a");h.href=c;let d=t.downloadAs;!d.endsWith(".glb")&&!d.endsWith(".gltf")&&(d+=t.binary?".glb":".gltf"),h.download=d,h.click()}}return r}const iw=Symbol("needle:weight");class RD{constructor(){a(this,"_undo",[])}onBeforeExport(t){t.context.animations.mixers.forEach(e=>{const i=Od.tryGetActionsFromMixer(e);if(i)for(let n=0;n<i.length;n++){const o=i[n];o[iw]=o.weight,o.weight=0,this._undo.push(()=>{o.weight=o[iw]})}e.update(0)}),t.context.scene.traverse(e=>{if(!Jy(e)){const i=e.parent;i&&(e.removeFromParent(),this._undo.push(()=>i.add(e)))}})}onAfterExport(t){this._undo.forEach(e=>e()),this._undo.length=0}}function OD(s,t,e){s.animations.mixers.forEach(n=>{const o=Od.tryGetActionsFromMixer(n);if(o)for(let r=0;r<o.length;r++){const c=o[r].getClip();e.push(c)}}),Array.isArray(t)||(t=[t]);for(const n of t)Od.tryGetAnimationClipsFromObjectHierarchy(n,e);const i=new Set(e);return Array.from(i)}const nw="needle-button",ny=U();var ka,Ea,Ma,Pi,yo,pc,vp,cP,xp,hP,Ld;class lP extends HTMLElement{constructor(){super();Yi(this,vp);Yi(this,xp);Yi(this,ka,void 0);Yi(this,Ea,void 0);Yi(this,Ma,void 0);Yi(this,Pi,void 0);Yi(this,yo,void 0);Yi(this,pc,void 0);Yi(this,Ld,e=>{ny&&console.log("Needle Button clicked"),!e.defaultPrevented&&_e(this,Pi)&&_e(this,Pi).click()});this.removeEventListener("click",_e(this,Ld)),this.addEventListener("click",_e(this,Ld))}attributeChangedCallback(e,i,n){aa(this,vp,cP).call(this)}}ka=new WeakMap,Ea=new WeakMap,Ma=new WeakMap,Pi=new WeakMap,yo=new WeakMap,pc=new WeakMap,vp=new WeakSet,cP=function(){var i,n;if((i=_e(this,Pi))==null||i.remove(),this.getAttribute("ar")!=null)_e(this,yo)??Un(this,yo,new Br),Un(this,Pi,_e(this,yo).createARButton());else if(this.getAttribute("vr")!=null)_e(this,yo)??Un(this,yo,new Br),Un(this,Pi,_e(this,yo).createVRButton());else if(this.getAttribute("quicklook")!=null)_e(this,yo)??Un(this,yo,new Br),Un(this,Pi,_e(this,yo).createQuicklookButton());else{ny?console.warn("No button type specified for <needle-button>. Use either ar, vr or quicklook attribute."):console.debug("No button type specified for <needle-button>. Use either ar, vr or quicklook attribute.");return}_e(this,ka)??Un(this,ka,this.attachShadow({mode:"open"})),_e(this,Ea)??Un(this,Ea,document.createElement("slot")),_e(this,Ma)??Un(this,Ma,document.createElement("style")),_e(this,Ma).innerHTML=`
            button {
                all: initial;
                cursor: inherit;
                color: inherit;
                font-family: inherit;
                gap: inherit;
                white-space: nowrap;
            }
        `,this.getAttribute("unstyled")!=null||(_e(this,Ma).innerHTML+=`
            :host {
                display: inline-block;
                background: rgba(255, 255, 255, .8);
                backdrop-filter: blur(10px);
                width: fit-content;
                transition: background .2s;

                cursor: pointer;
                padding: 0.4rem .5rem;
                border-radius: 0.8rem;
                color: black;
                background: rgba(245, 245, 245, .8);
                outline: rgba(0,0,0,.05) 1px solid;
            }
            :host(:hover) {
                background: rgba(255, 255, 255, 1);
                transition: background .2s;
            }
            slot {
                display: flex;
                align-items: center;
                justify-content: center;
                gap: .5rem;
            }
`),_e(this,Ea).innerHTML=_e(this,Pi).innerHTML,_e(this,Ea).style.cssText="display: flex; align-items: center; justify-content: center;",_e(this,Pi).innerHTML=_e(this,Ea).outerHTML,_e(this,ka).innerHTML=_e(this,Pi).outerHTML,_e(this,ka).prepend(_e(this,Ma)),Af(Gy,{element:_e(this,ka)}),(n=_e(this,pc))==null||n.disconnect(),_e(this,pc)??Un(this,pc,new MutationObserver(()=>aa(this,xp,hP).call(this))),_e(this,pc).observe(_e(this,Pi),{attributes:!0}),ny&&console.log("Needle Button updated")},xp=new WeakSet,hP=function(){_e(this,Pi)&&(_e(this,Pi).style.display==="none"?this.style.display="none":this.style.display==="none"&&(this.style.display=""))},Ld=new WeakMap,a(lP,"observedAttributes",["ar","vr","quicklook"]);typeof window<"u"&&!window.customElements.get(nw)&&window.customElements.define(nw,lP);const lp=C("debugmissingcamera");be.registerCallback(me.MissingCamera,s=>{var l,c,h;lp&&console.warn("Creating missing camera");const t=s.context.scene,e=new Re;e.name="Default Fallback Camera",t.add(e);const i=new Se;i.sourceId=((c=(l=s.files)==null?void 0:l[0])==null?void 0:c.src)??"unknown",(h=s.context.domElement.getAttribute("skybox-image"))!=null&&h.length||0>0||s.context.lightmaps.tryGetSkybox(i.sourceId)?i.clearFlags=Ui.Skybox:i.clearFlags=Ui.SolidColor,i.backgroundColor=new Ae(.5,.5,.5,1),i.fieldOfView=35,s.context.domElement.getAttribute("transparent")!=null&&(i.clearFlags=Ui.Uninitialized),i.backgroundBlurriness=.2;const o=oc(e,i,!0);e.position.x=0,e.position.y=1,e.position.z=2;const r=s.context.domElement;return(r==null?void 0:r.cameraControls)!=!1&&dP(s.context,o),o});be.registerCallback(me.ContextCreated,s=>{if(!s.context.mainCamera){lp&&console.log("Will not auto-fit because a default camera exists");return}const t=s.context.domElement;if((t==null?void 0:t.cameraControls)==!0){const e=MO(s.context.mainCamera);if((e==null?void 0:e.isCameraController)==!0){lp&&console.log("Will not auto-fit because a camera controller exists");return}dP(s.context)}});function dP(s,t){t=t??s.mainCameraComponent;const e=t==null?void 0:t.gameObject;if(lp&&console.log("Creating default camera controls",t==null?void 0:t.name),e){const i=Up(e,ke);i.sourceId=(t==null?void 0:t.sourceId)??"unknown";const n=s.domElement.getAttribute("auto-rotate");if(i.autoRotate=n!=null&&n!="0"&&(n==null?void 0:n.toLowerCase())!="false",i.autoRotateSpeed=.5,i.autoFit=!0,i.autoRotate&&n){const o=parseFloat(n);isNaN(o)||(i.autoRotateSpeed=o)}}else console.warn("Missing camera object, can not add orbit controls")}be.registerCallback(me.ContextCreated,s=>{const t=s.context.domElement.getAttribute("autoplay");if(t!==void 0&&(t===""||t==="true"||t==="1")&&s.files)for(const e of s.files)P.foreachComponent(e.file.scene,n=>{if(n.enabled!==!1){if(n instanceof Mi&&n.playAutomatically||n instanceof pi||n instanceof Gs&&n.playOnAwake===!0)return!0;if(n instanceof Mi)return n.playAutomatically=!0,!0;if(n instanceof Gs)return n.playOnAwake=!0,!0}},!0)!==!0&&Od.assignAnimationsFromFile(e.file,{createAnimationComponent:(n,o)=>Mn(n,Mi)})});const od={VERSION:$s,Context:ne,NeedleXRSession:te,gltf:{loadFromURL:tP},onStart:FC,onUpdate:zC,onBeforeRender:qM,onAfterRender:XM,onInitializedContext:BC,onDestroyContext:GM,onClearContext:HM};var sw;((sw=globalThis.Needle)==null?void 0:sw.VERSION)!==void 0&&console.warn(`Needle Engine is already imported: ${globalThis.Needle.VERSION}`);function uP(s){for(const t in s)od[t]=s[t]}uP(BM);uP(oD);for(const s of Object.getOwnPropertyNames(P))switch(s){case"prototype":case"constructor":case"length":case"name":continue;default:od[s]=P[s];break}if(!globalThis.Needle)globalThis.Needle=od;else for(const s in od)globalThis.Needle[s]=od[s];globalThis.THREE?console.warn("Three.js is already imported"):globalThis.THREE=ER;export{BL as $physicsKey,we as ActionBuilder,v1 as ActionCollection,Ni as ActionModel,YE as Addressables,Hp as AlignmentConstraint,Ds as AmbientMode,Mi as Animation,Zn as AnimationCurve,Zp as AnimationExtension,zb as AnimationTrackHandler,Od as AnimationUtils,pi as Animator,gr as AnimatorConditionMode,An as AnimatorController,Xy as AnimatorControllerParameterType,Pu as AnimatorStateInfo,dm as Antialiasing,Ws as Application,Da as ApplicationEvents,zk as AssetDatabase,de as AssetReference,rl as AudioExtension,Rr as AudioListener,Oe as AudioSource,dc as AudioTrackHandler,Xa as Avatar,Lc as AvatarBlink_Simple,jr as AvatarEyeLook_Rotation,GC as AvatarLoader,It as AvatarMarker,lb as AvatarModel,Uf as Avatar_Brain_LookAt,Qp as Avatar_MouthShapes,VC as Avatar_MustacheShake,Do as Avatar_POI,Bl as Axes,Hd as AxesHelper,Kw as BUILD_TIME,ls as BaseUIComponent,qC as BasicIKConstraint,yb as BehaviorExtension,Bt as BehaviorModel,j as Behaviour,Rc as BlobStorage,Bo as BloomEffect,il as BoxCollider,Nc as BoxGizmo,rn as BoxHelperComponent,ia as Button,Fs as ButtonsFactory,So as CallDirection,wo as CallInfo,Se as Camera,Ff as CameraTargetReachedEvent,Ft as Canvas,qa as CanvasGroup,Vr as CapsuleCollider,Yn as ChangeMaterialOnClick,zc as ChangeTransformOnClick,jc as CharacterController,Qr as CharacterControllerInput,um as ChromaticAberration,Dn as CircularBuffer,Ui as ClearFlags,ws as ClipExtrapolation,fn as Collider,_A as Collision,Lf as CollisionDetectionMode,fl as ColorAdjustments,Vc as ColorBySpeedModule,cm as ColorOverLifetimeModule,j as Component,Fp as ComponentLifecycleEvents,My as ConnectionEvents,yA as ContactPoint,cn as ContactShadows,ne as Context,TL as ContextArgs,me as ContextEvent,be as ContextRegistry,Ub as ControlTrackHandler,cl as CustomBranding,xn as CustomShader,Td as DefaultReflectionMode,YC as Deletable,ac as DeleteBox,to as DepthOfField,hb as DeviceFlag,J as DeviceUtilities,w1 as DocumentExtension,Dt as DragControls,ri as DragMode,Yr as DropListener,ol as Duplicatable,ip as EffectWrapper,er as EmissionModule,Xd as EmphasizeOnClick,hf as EngineLoadingView,Te as EventList,ib as EventListEvent,Gi as EventSystem,pb as EventTrigger,o1 as FieldWithDefault,Nh as FileReference,eM as FileReferenceSerializer,FL as FileSpawnModel,ax as File_Event,A1 as FixedJoint,Jd as Fog,oe as FrameEvent,Yw as GENERATOR,P as GameObject,G as Gizmos,Ls as GltfExport,l1 as GltfExportBox,uc as GltfLoadEvent,zr as GltfLoadEventType,hl as Gradient,jo as Graphic,nb as GraphicRaycaster,qn as Graphics,Zd as GridHelper,k1 as GridLayoutGroup,Xo as GroundProjectedEnv,kr as GroupActionModel,Nf as HideFlags,Ra as HideOnStart,rm as HingeJoint,T1 as HorizontalLayoutGroup,SL as HostData,au as Image,Uh as ImageReference,ZE as ImageReferenceSerializer,tr as InheritVelocityModule,kT as Input,Wi as InputEventQueue,ye as InputEvents,Rn as InputField,lc as InstanceHandle,Or as InstancingHandler,is as InstancingUtil,xc as InstantiateEvent,ui as InstantiateIdProvider,Js as InstantiateOptions,QC as Interactable,rp as InternalScreenshotUtils,yL as JoinedRoomResponse,pL as KeyEventArgs,Hi as Keyframe,am as LODGroup,$c as LODModel,_L as LeftRoomResponse,gn as Light,gM as LightData,Pt as LimitVelocityOverLifetimeModule,kL as LoadingElementOptions,XC as LogStats,_t as LogType,zo as LookAt,Dc as LookAtConstraint,gi as MainModule,y_ as MarkerType,im as MaskableGraphic,W as Mathf,nl as MeshCollider,Jp as MeshRenderer,X as MinMaxCurve,Lt as MinMaxGradient,z as NEEDLE_ENGINE_MODULES,mt as NEEDLE_progressive,du as NEKeyboardEvent,dr as NEPointerEvent,lP as NeedleButtonElement,be as NeedleEngine,aP as NeedleEngineHTMLElement,Y1 as NeedleLoader,Zo as NeedleMenu,Km as NeedlePatchesKey,c2 as NeedleUSDZExporter,iS as NeedleXRController,te as NeedleXRSession,Ck as NeedleXRSync,Ik as NeedleXRUtils,Eb as NestedGltf,Sk as NetworkConnection,rt as NetworkedStreamEvents,Xp as NetworkedStreams,Hr as Networking,cE as NewInstanceModel,Ie as NoiseModule,jn as ObjectRaycaster,Ka as ObjectUtils,Wc as OffsetConstraint,qm as OneEuroFilter,jw as OneEuroFilterXYZ,lu as OpenURL,ke as OrbitControls,Kd as Outline,si as OwnershipEvent,QS as OwnershipModel,Qu as PUBLIC_KEY,al as Padding,Jf as ParticleBurst,Ab as ParticleSubEmitter,it as ParticleSystem,ul as ParticleSystemBaseBehaviour,ds as ParticleSystemRenderer,Ci as ParticleSystemShapeType,rc as PeerHandle,vk as PeerNetworking,Bh as Physics,_b as PhysicsExtension,Tt as PhysicsMaterialCombine,pm as PixelationEffect,Us as PlayAnimationOnClick,Ga as PlayAudioOnClick,Gs as PlayableDirector,Ed as PlayerColor,Xt as PlayerState,r_ as PlayerStateEvent,ll as PlayerSync,aM as PlayerView,lM as PlayerViewManager,Vd as PointerEventData,Sr as PointerType,Ct as PostProcessingEffect,jb as PostProcessingHandler,iu as PostProcessingManager,Qd as PreliminaryAction,em as PreliminaryTrigger,ba as PreviewHelper,Jn as PrimitiveType,ge as Progress,Ew as PromiseAllWithErrors,y0 as PromiseErrorResult,Ae as RGBAColor,ma as RapierPhysics,$b as RawImage,$o as RaycastOptions,C1 as Rect,Yt as RectTransform,Oo as ReflectionProbe,Tr as RegisteredAnimationInfo,Go as RemoteSkybox,ja as RenderTexture,rA as RenderTextureSerializer,Ve as Renderer,mM as RendererData,Gf as RendererLightmap,ve as Rigidbody,ct as RigidbodyConstraints,se as RoomEvents,zn as RotationBySpeedModule,hs as RotationOverLifetimeModule,Zy as SceneLightSettings,vt as SceneSwitcher,gl as ScreenCapture,Zr as ScreenSpaceAmbientOcclusion,io as ScreenSpaceAmbientOcclusionN8,Qn as SendQueue,fC as SerializationContext,Pn as SetActiveOnClick,gm as ShadowCatcher,ze as ShapeModule,mm as SharpeningEffect,bm as SignalAsset,Fr as SignalReceiver,ru as SignalReceiverEvent,op as SignalTrackHandler,S1 as Size,Qi as SizeBySpeedModule,dl as SizeOverLifetimeModule,r1 as SkinnedMeshRenderer,Hs as SmoothFollow,Fa as SpatialGrabRaycaster,Cm as SpatialHtml,Na as SpatialTrigger,Fo as SpatialTriggerReceiver,Fb as SpectatorCamera,Gd as SphereCollider,KS as SphereIntersection,bA as SphereOverlapResult,Jo as Sprite,ns as SpriteData,mn as SpriteRenderer,kc as SpriteSheet,ML as StateMachineBehaviour,$C as StreamEndedEvent,vA as StreamReceivedEvent,tp as SubEmitterSystem,hc as SyncedCamera,no as SyncedRoom,Wo as SyncedTransform,x1 as TapGestureTrigger,Cb as TeleportTarget,$1 as TestRunner,JL as TestSceneUtils,W1 as TestSimulateUserData,Di as Text,bb as TextBuilder,nm as TextExtension,yi as TextureSheetAnimationModule,ir as TiltShiftEffect,yM as Time,Ho as ToneMappingEffect,vm as TrackHandler,tn as TrackType,st as TrailModule,Ke as TransformData,qc as TransformGizmo,Qt as TriggerBuilder,Lo as TriggerModel,w as TypeStore,sb as UIRaycastUtils,qp as UIRootComponent,u1 as USDDocument,hi as USDObject,a2 as USDWriter,Fe as USDZExporter,Oa as USDZText,xb as USDZUIExtension,aA as UriSerializer,Kp as UsageMarker,bL as UserJoinedOrLeftRoomModel,$s as VERSION,b1 as VariantAction,at as VelocityOverLifetimeModule,O1 as VerticalLayoutGroup,zt as VideoPlayer,Io as ViewDevice,Gc as Vignette,tm as VisibilityAction,tl as Voip,iu as Volume,$ as VolumeParameter,hm as VolumeProfile,PL as WaitForFrames,iM as WaitForPromise,OC as WaitForSeconds,Ir as Watch,Rm as WebARCameraBackground,es as WebARSessionRoot,Ze as WebXR,Br as WebXRButtonFactory,Uo as WebXRImageTracking,nr as WebXRImageTrackingModel,oa as WebXRPlaneTracking,Ta as WebXRTrackedImage,na as XRControllerFollow,Vo as XRControllerModel,Bn as XRControllerMovement,qt as XRFlag,Vb as XRRig,ci as XRState,Tn as XRStateFlag,Q1 as __Ignore,Nk as __internalNotifyObjectDestroyed,Dr as activeInHierarchyFieldName,gO as addAttributeChangeCallback,Mn as addComponent,zL as addCustomExtensionPlugin,GL as addGltfLoadEventListener,oc as addNewComponent,L_ as addPatch,Y_ as apply,KL as applyHMRChanges,IE as applyPrototypeExtensions,lE as beginListenDestroy,dE as beginListenInstantiate,sS as binaryIdentifierCasts,OL as build_scene_functions,kl as builtinComponentKeyName,AC as calculateProgress01,nL as clearBalloonMessages,nL as clearOverlayMessages,DL as colorSerializer,bE as compareAssociation,_g as componentSerializer,VO as copyTexture,eP as createLoader,UM as createMotion,Zi as debugNet,_u as debugOwner,d2 as decompressGpuTexture,kp as deepClone,Xs as delay,Ep as delayForFrames,zy as deserializeObject,Ln as destroy,zE as destroyComponentInstance,Ne as disposeObjectResources,Ro as disposeStream,Yu as editorGuidKeyName,tc as enableSpatialConsole,LL as euler,jL as eventListSerializer,e3 as exportAsGLTF,vC as findByGuid,Wp as findObjectOfType,UE as findObjectsOfType,iC as findResourceUsers,XO as fitObjectIntoVolume,Cc as foreachComponent,J_ as foreachComponentEnumerator,rL as forward,bO as generateQRCode,hE as generateSeed,dn as getBoundingBox,MO as getCameraController,Ac as getComponent,$p as getComponentInChildren,kf as getComponentInParent,Np as getComponents,zd as getComponentsInChildren,Q_ as getComponentsInParent,i2 as getFormattedDate,li as getIconElement,$v as getIconTexture,eL as getIp,tL as getIpAndLocation,ZD as getIpCloudflare,qs as getLoader,Up as getOrAddComponent,C as getParam,aL as getParentHierarchyPath,ND as getPath,mL as getPeerOptions,bk as getPeerjsInstance,wL as getResourceUserCount,LO as getTempColor,Os as getTempQuaternion,Q as getTempVector,Tp as getUrlParams,qO as getVisibleInCustomShadowRendering,NO as getWorldDirection,zw as getWorldEuler,ae as getWorldPosition,Le as getWorldQuaternion,Ap as getWorldRotation,pt as getWorldScale,Vs as hasCommercialLicense,MC as hasIndieLicense,Yy as hasPointerEventComponent,La as hasProLicense,tT as hideDebugConsole,p2 as imageToCanvas,Pc as instantiate,i1 as invokeAfterImportPluginHooks,xT as invokeXRSessionEnd,vT as invokeXRSessionStart,NE as isActiveInHierarchy,Ud as isActiveSelf,GD as isAndroidDevice,WO as isAnimationAction,gA as isComponent,BD as isDebugMode,$D as isDesktop,Sc as isDestroyed,U as isDevEnvironment,xL as isDisposed,ZL as isExporting,lO as isHostedOnGlitch,XL as isHotReloading,VD as isIPad,vM as isIconElement,qi as isLocalNetwork,XD as isMacOS,WD as isMobileDevice,qD as isMozillaXR,KD as isQuest,Uk as isResourceTrackingEnabled,YD as isSafari,K_ as isUsingInstancing,QD as isiOS,HD as isiPad,tP as loadSync,py as logHierarchy,oL as lookAtInverse,Mp as lookAtObject,zD as makeId,dO as makeIdFromRandomWords,Qs as makeNameSafeForUSD,$E as markAsInstancedRendered,JD as microphonePermissionsGranted,jD as nameof,cO as nameofFactory,iA as objectSerializer,uL as offXRSessionEnd,dL as offXRSessionStart,XM as onAfterRender,qM as onBeforeRender,HM as onClear,GM as onDestroy,BC as onInitialized,FC as onStart,zC as onUpdate,eS as onXRSessionEnd,B_ as onXRSessionStart,mD as parseSync,QO as placeOnSurface,Ww as postprocessFBXMaterials,IL as prefix,hO as pushState,UD as randomNumber,oS as registerBinaryType,eb as registerComponent,mb as registerComponentExtension,us as registerCustomEffectType,t1 as registerExportExtensions,t_ as registerExtensions,QL as registerHotReloadType,Ow as registerLoader,fE as registerPrefabProvider,DE as registerPrototypeExtensions,CL as registerType,fO as relativePathPrefix,yO as removeAttributeChangeCallback,yC as removeComponent,UL as removeCustomImportExtensionType,qL as removeGltfLoadEventListener,hL as removePatch,Ya as resolveUrl,uO as sanitizeString,eD as saveImage,HL as screenshot,X1 as screenshot2,lC as sendDestroyed,m as serializable,PE as serializeObject,Ic as serializeable,af as setActive,wO as setAllowBalloonMessages,iL as setAllowOverlayMessages,fy as setAutoFitEnabled,v0 as setCameraController,WE as setDestroyed,cL as setDevEnvironment,eC as setDisposable,hh as setDontDestroy,p0 as setOrAddParamsToUrl,FD as setParam,bf as setParamWithoutReload,gL as setPeerOptions,vL as setResourceTrackingEnabled,Tw as setState,$w as setVisibleInCustomShadowRendering,Uw as setWorldEuler,jt as setWorldPosition,_c as setWorldPositionXYZ,as as setWorldQuaternion,Fw as setWorldQuaternionXYZW,Nw as setWorldRotation,Ip as setWorldRotationXYZ,xd as setWorldScale,Dp as showBalloonError,tt as showBalloonMessage,Me as showBalloonWarning,Gw as showDebugConsole,sL as slerp,zp as syncDestroy,M1 as syncField,cC as syncInstantiate,lL as textureToCanvas,jT as tryCastBinary,fD as tryDetermineFileTypeFromBinary,uD as tryDetermineFileTypeFromURL,bd as tryFindObject,BT as tryGetGuid,YL as unregisterHotReloadType,kw as unwatchWrite,AO as useForAutoFit,mi as validate,A_ as watchWrite};
